<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/blog/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/blog/uploads/favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/blog/uploads/favicon.ico">
  <link rel="mask-icon" href="/blog/images/logo.svg" color="#222">

<link rel="stylesheet" href="/blog/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@7.0.0/css/all.min.css" integrity="sha256-VHqXKFhhMxcpubYf9xiWdCiojEbY9NexQ4jh8AxbvcM=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/themes/blue/pace-theme-minimal.css">
  <script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous" defer></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"dunwu.github.io","root":"/blog/","images":"/blog/images","scheme":"Pisces","darkmode":true,"version":"8.25.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"codeblock":{"theme":{"light":"atom-one-light","dark":"atom-one-dark"},"prism":{"light":"atom-one-light","dark":"atom-one-dark"},"copy_button":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"language":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"gitalk","storage":true,"lazyload":true,"nav":null,"activeClass":"gitalk"},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"æœç´¢...","empty":"æ²¡æœ‰æ‰¾åˆ°ä»»ä½•æœç´¢ç»“æœï¼š${query}","hits_time":"æ‰¾åˆ° ${hits} ä¸ªæœç´¢ç»“æœï¼ˆç”¨æ—¶ ${time} æ¯«ç§’ï¼‰","hits":"æ‰¾åˆ° ${hits} ä¸ªæœç´¢ç»“æœ"},"path":"/blog/search.xml","localsearch":{"enable":true,"top_n_per_article":1,"unescape":false,"preload":false,"trigger":"auto"}}</script><script src="/blog/js/config.js" defer></script>

    <meta name="description" content="é’æ‚Ÿçš„ä¸ªäººåšå®¢">
<meta property="og:type" content="website">
<meta property="og:title" content="Dunwu Blog">
<meta property="og:url" content="https://dunwu.github.io/blog/page/20/index.html">
<meta property="og:site_name" content="Dunwu Blog">
<meta property="og:description" content="é’æ‚Ÿçš„ä¸ªäººåšå®¢">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="é’æ‚Ÿ â—¾ Dunwu">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://dunwu.github.io/blog/page/20/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"page/20/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Dunwu Blog</title>
  








  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
<script src="/blog/js/utils.js" defer></script><script src="/blog/js/motion.js" defer></script><script src="/blog/js/sidebar.js" defer></script><script src="/blog/js/next-boot.js" defer></script>

  <script src="https://cdn.jsdelivr.net/npm/hexo-generator-searchdb@1.5.0/dist/search.js" integrity="sha256-xFC6PJ82SL9b3WkGjFavNiA9gm5z6UBxWPiu4CYjptg=" crossorigin="anonymous" defer></script>
<script src="/blog/js/third-party/search/local-search.js" defer></script>





  <script src="/blog/js/third-party/pace.js" defer></script>


  





  <noscript>
    <link rel="stylesheet" href="/blog/css/noscript.css">
  </noscript>
<style>.darkmode--activated{--body-bg-color:#282828;--content-bg-color:#333;--card-bg-color:#555;--text-color:#ccc;--blockquote-color:#bbb;--link-color:#ccc;--link-hover-color:#eee;--brand-color:#ddd;--brand-hover-color:#ddd;--table-row-odd-bg-color:#282828;--table-row-hover-bg-color:#363636;--menu-item-bg-color:#555;--btn-default-bg:#222;--btn-default-color:#ccc;--btn-default-border-color:#555;--btn-default-hover-bg:#666;--btn-default-hover-color:#ccc;--btn-default-hover-border-color:#666;--highlight-background:#282b2e;--highlight-foreground:#a9b7c6;--highlight-gutter-background:#34393d;--highlight-gutter-foreground:#9ca9b6}.darkmode--activated img{opacity:.75}.darkmode--activated img:hover{opacity:.9}.darkmode--activated code{color:#69dbdc;background:0 0}button.darkmode-toggle{z-index:9999}.darkmode-ignore,img{display:flex!important}.beian img{display:inline-block!important}</style></head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ " role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/blog/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Dunwu Blog</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">å¤§é“è‡³ç®€ï¼ŒçŸ¥æ˜“è¡Œéš¾</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="æœç´¢" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/blog/" rel="section"><i class="fa fa-home fa-fw"></i>é¦–é¡µ</a></li><li class="menu-item menu-item-about"><a href="/blog/about/" rel="section"><i class="fa fa-user fa-fw"></i>å…³äº</a></li><li class="menu-item menu-item-tags"><a href="/blog/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>æ ‡ç­¾<span class="badge">428</span></a></li><li class="menu-item menu-item-categories"><a href="/blog/categories/" rel="section"><i class="fa fa-th fa-fw"></i>åˆ†ç±»<span class="badge">124</span></a></li><li class="menu-item menu-item-archives"><a href="/blog/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>å½’æ¡£<span class="badge">508</span></a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>æœç´¢
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
      <div class="search-header">
        <span class="search-icon">
          <i class="fa fa-search"></i>
        </span>
        <div class="search-input-container">
          <input autocomplete="off" autocapitalize="off" maxlength="80"
                placeholder="æœç´¢..." spellcheck="false"
                type="search" class="search-input">
        </div>
        <span class="popup-btn-close" role="button">
          <i class="fa fa-times-circle"></i>
        </span>
      </div>
      <div class="search-result-container">
        <div class="search-result-icon">
          <i class="fa fa-spinner fa-pulse fa-5x"></i>
        </div>
      </div>
    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="é’æ‚Ÿ â—¾ Dunwu"
      src="/blog/uploads/avatar.gif">
  <p class="site-author-name" itemprop="name">é’æ‚Ÿ â—¾ Dunwu</p>
  <div class="site-description" itemprop="description">é’æ‚Ÿçš„ä¸ªäººåšå®¢</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/blog/archives/">
          <span class="site-state-item-count">508</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/blog/categories/">
        <span class="site-state-item-count">124</span>
        <span class="site-state-item-name">åˆ†ç±»</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/blog/tags/">
        <span class="site-state-item-count">428</span>
        <span class="site-state-item-name">æ ‡ç­¾</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/dunwu" title="GitHub â†’ https:&#x2F;&#x2F;github.com&#x2F;dunwu" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:forbreak@163.com" title="E-Mail â†’ mailto:forbreak@163.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>
  <div class="cc-license animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" class="cc-opacity" rel="noopener" target="_blank"><img src="https://cdn.jsdelivr.net/npm/@creativecommons/vocabulary@2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a>
  </div>

        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="è¿”å›é¡¶éƒ¨">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://dunwu.github.io/blog/pages/20889acf/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/uploads/avatar.gif">
      <meta itemprop="name" content="é’æ‚Ÿ â—¾ Dunwu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dunwu Blog">
      <meta itemprop="description" content="é’æ‚Ÿçš„ä¸ªäººåšå®¢">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Dunwu Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/pages/20889acf/" class="post-title-link" itemprop="url">Tomcat å¿«é€Ÿå…¥é—¨</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2022-02-17 22:34:30" itemprop="dateCreated datePublished" datetime="2022-02-17T22:34:30+08:00">2022-02-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">æ›´æ–°äº</span>
      <time title="ä¿®æ”¹æ—¶é—´ï¼š2025-09-13 17:56:53" itemprop="dateModified" datetime="2025-09-13T17:56:53+08:00">2025-09-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
        </span>
          ï¼Œ
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/JavaEE/" itemprop="url" rel="index"><span itemprop="name">JavaEE</span></a>
        </span>
          ï¼Œ
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/JavaEE/%E6%9C%8D%E5%8A%A1%E5%99%A8/" itemprop="url" rel="index"><span itemprop="name">æœåŠ¡å™¨</span></a>
        </span>
          ï¼Œ
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/JavaEE/%E6%9C%8D%E5%8A%A1%E5%99%A8/Tomcat/" itemprop="url" rel="index"><span itemprop="name">Tomcat</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
      <span>21k</span>
    </span>
    <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
      <span>19 åˆ†é’Ÿ</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Tomcat-å¿«é€Ÿå…¥é—¨"><a href="#Tomcat-å¿«é€Ÿå…¥é—¨" class="headerlink" title="Tomcat å¿«é€Ÿå…¥é—¨"></a>Tomcat å¿«é€Ÿå…¥é—¨</h1><blockquote>
<p>ğŸ ç‰ˆæœ¬è¯´æ˜</p>
<p>å½“å‰æœ€æ–°ç‰ˆæœ¬ï¼šTomcat 8.5.24</p>
<p>ç¯å¢ƒè¦æ±‚ï¼šJDK7+</p>
</blockquote>
<h2 id="1-Tomcat-ç®€ä»‹"><a href="#1-Tomcat-ç®€ä»‹" class="headerlink" title="1. Tomcat ç®€ä»‹"></a>1. Tomcat ç®€ä»‹</h2><h3 id="1-1-Tomcat-æ˜¯ä»€ä¹ˆ"><a href="#1-1-Tomcat-æ˜¯ä»€ä¹ˆ" class="headerlink" title="1.1. Tomcat æ˜¯ä»€ä¹ˆ"></a>1.1. Tomcat æ˜¯ä»€ä¹ˆ</h3><p>Tomcat æ˜¯ç”± Apache å¼€å‘çš„ä¸€ä¸ª Servlet å®¹å™¨ï¼Œå®ç°äº†å¯¹ Servlet å’Œ JSP çš„æ”¯æŒï¼Œå¹¶æä¾›äº†ä½œä¸º Web æœåŠ¡å™¨çš„ä¸€äº›ç‰¹æœ‰åŠŸèƒ½ï¼Œå¦‚ Tomcat ç®¡ç†å’Œæ§åˆ¶å¹³å°ã€å®‰å…¨åŸŸç®¡ç†å’Œ Tomcat é˜€ç­‰ã€‚</p>
<p>ç”±äº Tomcat æœ¬èº«ä¹Ÿå†…å«äº†ä¸€ä¸ª HTTP æœåŠ¡å™¨ï¼Œå®ƒä¹Ÿå¯ä»¥è¢«è§†ä½œä¸€ä¸ªå•ç‹¬çš„ Web æœåŠ¡å™¨ã€‚ä½†æ˜¯ï¼Œä¸èƒ½å°† Tomcat å’Œ Apache HTTP æœåŠ¡å™¨æ··æ·†ï¼ŒApache HTTP æœåŠ¡å™¨æ˜¯ä¸€ä¸ªç”¨ C è¯­è¨€å®ç°çš„ HTTP Web æœåŠ¡å™¨ï¼›è¿™ä¸¤ä¸ª HTTP web server ä¸æ˜¯æ†ç»‘åœ¨ä¸€èµ·çš„ã€‚Tomcat åŒ…å«äº†ä¸€ä¸ªé…ç½®ç®¡ç†å·¥å…·ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ç¼–è¾‘ XML æ ¼å¼çš„é…ç½®æ–‡ä»¶æ¥è¿›è¡Œé…ç½®ã€‚</p>
<h3 id="1-2-Tomcat-é‡è¦ç›®å½•"><a href="#1-2-Tomcat-é‡è¦ç›®å½•" class="headerlink" title="1.2. Tomcat é‡è¦ç›®å½•"></a>1.2. Tomcat é‡è¦ç›®å½•</h3><ul>
<li><strong>&#x2F;bin</strong> - Tomcat è„šæœ¬å­˜æ”¾ç›®å½•ï¼ˆå¦‚å¯åŠ¨ã€å…³é—­è„šæœ¬ï¼‰ã€‚ <code>*.sh</code> æ–‡ä»¶ç”¨äº Unix ç³»ç»Ÿï¼› <code>*.bat</code> æ–‡ä»¶ç”¨äº Windows ç³»ç»Ÿã€‚</li>
<li><strong>&#x2F;conf</strong> - Tomcat é…ç½®æ–‡ä»¶ç›®å½•ã€‚</li>
<li><strong>&#x2F;logs</strong> - Tomcat é»˜è®¤æ—¥å¿—ç›®å½•ã€‚</li>
<li><strong>&#x2F;webapps</strong> - webapp è¿è¡Œçš„ç›®å½•ã€‚</li>
</ul>
<h3 id="1-3-web-å·¥ç¨‹å‘å¸ƒç›®å½•ç»“æ„"><a href="#1-3-web-å·¥ç¨‹å‘å¸ƒç›®å½•ç»“æ„" class="headerlink" title="1.3. web å·¥ç¨‹å‘å¸ƒç›®å½•ç»“æ„"></a>1.3. web å·¥ç¨‹å‘å¸ƒç›®å½•ç»“æ„</h3><p>ä¸€èˆ¬ web é¡¹ç›®è·¯å¾„ç»“æ„</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">|<span class="string">-- webapp                         # ç«™ç‚¹æ ¹ç›®å½•</span></span><br><span class="line"><span class="string">    </span>|<span class="string">-- META-INF                   # META-INF ç›®å½•</span></span><br><span class="line"><span class="string">    </span>|<span class="string">   `-- MANIFEST.MF            # é…ç½®æ¸…å•æ–‡ä»¶</span></span><br><span class="line"><span class="string">    </span>|<span class="string">-- WEB-INF                    # WEB-INF ç›®å½•</span></span><br><span class="line"><span class="string">    </span>|<span class="string">   </span>|<span class="string">-- classes                # classæ–‡ä»¶ç›®å½•</span></span><br><span class="line"><span class="string">    </span>|<span class="string">   </span>|<span class="string">   </span>|<span class="string">-- *.class            # ç¨‹åºéœ€è¦çš„ class æ–‡ä»¶</span></span><br><span class="line"><span class="string">    </span>|<span class="string">   </span>|<span class="string">   `-- *.xml              # ç¨‹åºéœ€è¦çš„ xml æ–‡ä»¶</span></span><br><span class="line"><span class="string">    </span>|<span class="string">   </span>|<span class="string">-- lib                    # åº“æ–‡ä»¶å¤¹</span></span><br><span class="line"><span class="string">    </span>|<span class="string">   </span>|<span class="string">   `-- *.jar              # ç¨‹åºéœ€è¦çš„ jar åŒ…</span></span><br><span class="line"><span class="string">    </span>|<span class="string">   `-- web.xml                # Webåº”ç”¨ç¨‹åºçš„éƒ¨ç½²æè¿°æ–‡ä»¶</span></span><br><span class="line"><span class="string">    </span>|<span class="string">-- &lt;userdir&gt;                  # è‡ªå®šä¹‰çš„ç›®å½•</span></span><br><span class="line"><span class="string">    </span>|<span class="string">-- &lt;userfiles&gt;                # è‡ªå®šä¹‰çš„èµ„æºæ–‡ä»¶</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p><code>webapp</code>ï¼šå·¥ç¨‹å‘å¸ƒæ–‡ä»¶å¤¹ã€‚å…¶å®æ¯ä¸ª war åŒ…éƒ½å¯ä»¥è§†ä¸º webapp çš„å‹ç¼©åŒ…ã€‚</p>
</li>
<li><p><code>META-INF</code>ï¼šMETA-INF ç›®å½•ç”¨äºå­˜æ”¾å·¥ç¨‹è‡ªèº«ç›¸å…³çš„ä¸€äº›ä¿¡æ¯ï¼Œå…ƒæ–‡ä»¶ä¿¡æ¯ï¼Œé€šå¸¸ç”±å¼€å‘å·¥å…·ï¼Œç¯å¢ƒè‡ªåŠ¨ç”Ÿæˆã€‚</p>
</li>
<li><p><code>WEB-INF</code>ï¼šJava web åº”ç”¨çš„å®‰å…¨ç›®å½•ã€‚æ‰€è°“å®‰å…¨å°±æ˜¯å®¢æˆ·ç«¯æ— æ³•è®¿é—®ï¼Œåªæœ‰æœåŠ¡ç«¯å¯ä»¥è®¿é—®çš„ç›®å½•ã€‚</p>
</li>
<li><p><code>/WEB-INF/classes</code>ï¼šå­˜æ”¾ç¨‹åºæ‰€éœ€è¦çš„æ‰€æœ‰ Java class æ–‡ä»¶ã€‚</p>
</li>
<li><p><code>/WEB-INF/lib</code>ï¼šå­˜æ”¾ç¨‹åºæ‰€éœ€è¦çš„æ‰€æœ‰ jar æ–‡ä»¶ã€‚</p>
</li>
<li><p><code>/WEB-INF/web.xml</code>ï¼šweb åº”ç”¨çš„éƒ¨ç½²é…ç½®æ–‡ä»¶ã€‚å®ƒæ˜¯å·¥ç¨‹ä¸­æœ€é‡è¦çš„é…ç½®æ–‡ä»¶ï¼Œå®ƒæè¿°äº† servlet å’Œç»„æˆåº”ç”¨çš„å…¶å®ƒç»„ä»¶ï¼Œä»¥åŠåº”ç”¨åˆå§‹åŒ–å‚æ•°ã€å®‰å…¨ç®¡ç†çº¦æŸç­‰ã€‚</p>
</li>
</ul>
<h3 id="1-4-Tomcat-åŠŸèƒ½"><a href="#1-4-Tomcat-åŠŸèƒ½" class="headerlink" title="1.4. Tomcat åŠŸèƒ½"></a>1.4. Tomcat åŠŸèƒ½</h3><p>Tomcat æ”¯æŒçš„ I&#x2F;O æ¨¡å‹æœ‰ï¼š</p>
<ul>
<li>NIOï¼šéé˜»å¡ I&#x2F;Oï¼Œé‡‡ç”¨ Java NIO ç±»åº“å®ç°ã€‚</li>
<li>NIO2ï¼šå¼‚æ­¥ I&#x2F;Oï¼Œé‡‡ç”¨ JDK 7 æœ€æ–°çš„ NIO2 ç±»åº“å®ç°ã€‚</li>
<li>APRï¼šé‡‡ç”¨ Apache å¯ç§»æ¤è¿è¡Œåº“å®ç°ï¼Œæ˜¯ C&#x2F;C++ ç¼–å†™çš„æœ¬åœ°åº“ã€‚</li>
</ul>
<p>Tomcat æ”¯æŒçš„åº”ç”¨å±‚åè®®æœ‰ï¼š</p>
<ul>
<li>HTTP&#x2F;1.1ï¼šè¿™æ˜¯å¤§éƒ¨åˆ† Web åº”ç”¨é‡‡ç”¨çš„è®¿é—®åè®®ã€‚</li>
<li>AJPï¼šç”¨äºå’Œ Web æœåŠ¡å™¨é›†æˆï¼ˆå¦‚ Apacheï¼‰ã€‚</li>
<li>HTTP&#x2F;2ï¼šHTTP 2.0 å¤§å¹…åº¦çš„æå‡äº† Web æ€§èƒ½ã€‚</li>
</ul>
<h2 id="2-Tomcat-å…¥é—¨"><a href="#2-Tomcat-å…¥é—¨" class="headerlink" title="2. Tomcat å…¥é—¨"></a>2. Tomcat å…¥é—¨</h2><h3 id="2-1-å®‰è£…"><a href="#2-1-å®‰è£…" class="headerlink" title="2.1. å®‰è£…"></a>2.1. å®‰è£…</h3><p><strong>å‰ææ¡ä»¶</strong></p>
<p>Tomcat 8.5 è¦æ±‚ JDK ç‰ˆæœ¬ä¸º 1.7 ä»¥ä¸Šã€‚</p>
<p>è¿›å…¥ <a target="_blank" rel="noopener" href="https://tomcat.apache.org/download-80.cgi">Tomcat å®˜æ–¹ä¸‹è½½åœ°å€</a> é€‰æ‹©åˆé€‚ç‰ˆæœ¬ä¸‹è½½ï¼Œå¹¶è§£å‹åˆ°æœ¬åœ°ã€‚</p>
<p><strong>Windows</strong></p>
<p>æ·»åŠ ç¯å¢ƒå˜é‡ <code>CATALINA_HOME</code> ï¼Œå€¼ä¸º Tomcat çš„å®‰è£…è·¯å¾„ã€‚</p>
<p>è¿›å…¥å®‰è£…ç›®å½•ä¸‹çš„ bin ç›®å½•ï¼Œè¿è¡Œ startup.bat æ–‡ä»¶ï¼Œå¯åŠ¨ Tomcat</p>
<p><strong>Linux &#x2F; Unix</strong></p>
<p>ä¸‹é¢çš„ç¤ºä¾‹ä»¥ 8.5.24 ç‰ˆæœ¬ä¸ºä¾‹ï¼ŒåŒ…å«äº†ä¸‹è½½ã€è§£å‹ã€å¯åŠ¨æ“ä½œã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä¸‹è½½è§£å‹åˆ°æœ¬åœ°</span></span><br><span class="line">wget http://mirrors.hust.edu.cn/apache/tomcat/tomcat-8/v8.5.24/bin/apache-tomcat-8.5.24.tar.gz</span><br><span class="line">tar -zxf apache-tomcat-8.5.24.tar.gz</span><br><span class="line"><span class="comment"># å¯åŠ¨ Tomcat</span></span><br><span class="line">./apache-tomcat-8.5.24/bin/startup.sh</span><br></pre></td></tr></table></figure>

<p>å¯åŠ¨åï¼Œè®¿é—® <code>http://localhost:8080</code> ï¼Œå¯ä»¥çœ‹åˆ° Tomcat å®‰è£…æˆåŠŸçš„æµ‹è¯•é¡µé¢ã€‚</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/cs/java/javaweb/tools/tomcat/tomcat.png" alt="img"></p>
<h3 id="2-2-é…ç½®"><a href="#2-2-é…ç½®" class="headerlink" title="2.2. é…ç½®"></a>2.2. é…ç½®</h3><p>æœ¬èŠ‚å°†åˆ—ä¸¾ä¸€äº›é‡è¦ã€å¸¸è§çš„é…ç½®é¡¹ã€‚è¯¦ç»†çš„ Tomcat8 é…ç½®å¯ä»¥å‚è€ƒ <a target="_blank" rel="noopener" href="http://tomcat.apache.org/tomcat-8.5-doc/config/index.html">Tomcat 8 é…ç½®å®˜æ–¹å‚è€ƒæ–‡æ¡£</a> ã€‚</p>
<h4 id="2-2-1-Server"><a href="#2-2-1-Server" class="headerlink" title="2.2.1. Server"></a>2.2.1. Server</h4><blockquote>
<p>Server å…ƒç´ è¡¨ç¤ºæ•´ä¸ª Catalina servlet å®¹å™¨ã€‚</p>
<p>å› æ­¤ï¼Œå®ƒå¿…é¡»æ˜¯ <code>conf/server.xml</code> é…ç½®æ–‡ä»¶ä¸­çš„æ ¹å…ƒç´ ã€‚å®ƒçš„å±æ€§ä»£è¡¨äº†æ•´ä¸ª servlet å®¹å™¨çš„ç‰¹æ€§ã€‚</p>
</blockquote>
<p><strong>å±æ€§è¡¨</strong></p>
<table>
<thead>
<tr>
<th>å±æ€§</th>
<th>æè¿°</th>
<th>å¤‡æ³¨</th>
</tr>
</thead>
<tbody><tr>
<td>className</td>
<td>è¿™ä¸ªç±»å¿…é¡»å®ç° org.apache.catalina.Server æ¥å£ã€‚</td>
<td>é»˜è®¤ org.apache.catalina.core.StandardServer</td>
</tr>
<tr>
<td>address</td>
<td>æœåŠ¡å™¨ç­‰å¾…å…³æœºå‘½ä»¤çš„ TCP &#x2F; IP åœ°å€ã€‚å¦‚æœæ²¡æœ‰æŒ‡å®šåœ°å€ï¼Œåˆ™ä½¿ç”¨ localhostã€‚</td>
<td></td>
</tr>
<tr>
<td>port</td>
<td>æœåŠ¡å™¨ç­‰å¾…å…³æœºå‘½ä»¤çš„ TCP &#x2F; IP ç«¯å£å·ã€‚è®¾ç½®ä¸º-1 ä»¥ç¦ç”¨å…³é—­ç«¯å£ã€‚</td>
<td></td>
</tr>
<tr>
<td>shutdown</td>
<td>å¿…é¡»é€šè¿‡ TCP &#x2F; IP è¿æ¥æ¥æ”¶åˆ°æŒ‡å®šç«¯å£å·çš„å‘½ä»¤å­—ç¬¦ä¸²ï¼Œä»¥å…³é—­ Tomcatã€‚</td>
<td></td>
</tr>
</tbody></table>
<h4 id="2-2-2-Service"><a href="#2-2-2-Service" class="headerlink" title="2.2.2. Service"></a>2.2.2. Service</h4><blockquote>
<p>Service å…ƒç´ è¡¨ç¤ºä¸€ä¸ªæˆ–å¤šä¸ªè¿æ¥å™¨ç»„ä»¶çš„ç»„åˆï¼Œè¿™äº›ç»„ä»¶å…±äº«ä¸€ä¸ªç”¨äºå¤„ç†ä¼ å…¥è¯·æ±‚çš„å¼•æ“ç»„ä»¶ã€‚Server ä¸­å¯ä»¥æœ‰å¤šä¸ª Serviceã€‚</p>
</blockquote>
<p><strong>å±æ€§è¡¨</strong></p>
<table>
<thead>
<tr>
<th>å±æ€§</th>
<th>æè¿°</th>
<th>å¤‡æ³¨</th>
</tr>
</thead>
<tbody><tr>
<td>className</td>
<td>è¿™ä¸ªç±»å¿…é¡»å®ç°<code>org.apache.catalina.Service</code>æ¥å£ã€‚</td>
<td>é»˜è®¤ <code>org.apache.catalina.core.StandardService</code></td>
</tr>
<tr>
<td>name</td>
<td>æ­¤æœåŠ¡çš„æ˜¾ç¤ºåç§°ï¼Œå¦‚æœæ‚¨ä½¿ç”¨æ ‡å‡† Catalina ç»„ä»¶ï¼Œå°†åŒ…å«åœ¨æ—¥å¿—æ¶ˆæ¯ä¸­ã€‚ä¸ç‰¹å®šæœåŠ¡å™¨å…³è”çš„æ¯ä¸ªæœåŠ¡çš„åç§°å¿…é¡»æ˜¯å”¯ä¸€çš„ã€‚</td>
<td></td>
</tr>
</tbody></table>
<p><strong>å®ä¾‹ - <code>conf/server.xml</code> é…ç½®æ–‡ä»¶ç¤ºä¾‹</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Server</span> <span class="attr">port</span>=<span class="string">&quot;8080&quot;</span> <span class="attr">shutdown</span>=<span class="string">&quot;SHUTDOWN&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">Service</span> <span class="attr">name</span>=<span class="string">&quot;xxx&quot;</span>&gt;</span></span><br><span class="line">  ...</span><br><span class="line">  <span class="tag">&lt;/<span class="name">Service</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Server</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="2-2-3-Executor"><a href="#2-2-3-Executor" class="headerlink" title="2.2.3. Executor"></a>2.2.3. Executor</h4><blockquote>
<p>Executor è¡¨ç¤ºå¯ä»¥åœ¨ Tomcat ä¸­çš„ç»„ä»¶ä¹‹é—´å…±äº«çš„çº¿ç¨‹æ± ã€‚</p>
</blockquote>
<p><strong>å±æ€§è¡¨</strong></p>
<table>
<thead>
<tr>
<th>å±æ€§</th>
<th>æè¿°</th>
<th>å¤‡æ³¨</th>
</tr>
</thead>
<tbody><tr>
<td>className</td>
<td>è¿™ä¸ªç±»å¿…é¡»å®ç°<code>org.apache.catalina.Executor</code>æ¥å£ã€‚</td>
<td>é»˜è®¤ <code>org.apache.catalina.core.StandardThreadExecutor</code></td>
</tr>
<tr>
<td>name</td>
<td>çº¿ç¨‹æ± åç§°ã€‚</td>
<td>è¦æ±‚å”¯ä¸€, ä¾› Connector å…ƒç´ çš„ executor å±æ€§ä½¿ç”¨</td>
</tr>
<tr>
<td>namePrefix</td>
<td>çº¿ç¨‹åç§°å‰ç¼€ã€‚</td>
<td></td>
</tr>
<tr>
<td>maxThreads</td>
<td>æœ€å¤§æ´»è·ƒçº¿ç¨‹æ•°ã€‚</td>
<td>é»˜è®¤ 200</td>
</tr>
<tr>
<td>minSpareThreads</td>
<td>æœ€å°æ´»è·ƒçº¿ç¨‹æ•°ã€‚</td>
<td>é»˜è®¤ 25</td>
</tr>
<tr>
<td>maxIdleTime</td>
<td>å½“å‰æ´»è·ƒçº¿ç¨‹å¤§äº minSpareThreads æ—¶,ç©ºé—²çº¿ç¨‹å…³é—­çš„ç­‰å¾…æœ€å¤§æ—¶é—´ã€‚</td>
<td>é»˜è®¤ 60000ms</td>
</tr>
<tr>
<td>maxQueueSize</td>
<td>çº¿ç¨‹æ± æ»¡æƒ…å†µä¸‹çš„è¯·æ±‚æ’é˜Ÿå¤§å°ã€‚</td>
<td>é»˜è®¤ Integer.MAX_VALUE</td>
</tr>
</tbody></table>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Service</span> <span class="attr">name</span>=<span class="string">&quot;xxx&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">Executor</span> <span class="attr">name</span>=<span class="string">&quot;tomcatThreadPool&quot;</span> <span class="attr">namePrefix</span>=<span class="string">&quot;catalina-exec-&quot;</span> <span class="attr">maxThreads</span>=<span class="string">&quot;300&quot;</span> <span class="attr">minSpareThreads</span>=<span class="string">&quot;25&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Service</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="2-2-4-Connector"><a href="#2-2-4-Connector" class="headerlink" title="2.2.4. Connector"></a>2.2.4. Connector</h4><blockquote>
<p>Connector ä»£è¡¨è¿æ¥ç»„ä»¶ã€‚Tomcat æ”¯æŒä¸‰ç§åè®®ï¼šHTTP&#x2F;1.1ã€HTTP&#x2F;2.0ã€AJPã€‚</p>
</blockquote>
<p><strong>å±æ€§è¡¨</strong></p>
<table>
<thead>
<tr>
<th>å±æ€§</th>
<th>è¯´æ˜</th>
<th>å¤‡æ³¨</th>
</tr>
</thead>
<tbody><tr>
<td>asyncTimeout</td>
<td>Servlet3.0 è§„èŒƒä¸­çš„å¼‚æ­¥è¯·æ±‚è¶…æ—¶</td>
<td>é»˜è®¤ 30s</td>
</tr>
<tr>
<td>port</td>
<td>è¯·æ±‚è¿æ¥çš„ TCP Port</td>
<td>è®¾ç½®ä¸º 0,åˆ™ä¼šéšæœºé€‰å–ä¸€ä¸ªæœªå ç”¨çš„ç«¯å£å·</td>
</tr>
<tr>
<td>protocol</td>
<td>åè®®. ä¸€èˆ¬æƒ…å†µä¸‹è®¾ç½®ä¸º HTTP&#x2F;1.1,è¿™ç§æƒ…å†µä¸‹è¿æ¥æ¨¡å‹ä¼šåœ¨ NIO å’Œ APR&#x2F;native ä¸­è‡ªåŠ¨æ ¹æ®é…ç½®é€‰æ‹©</td>
<td></td>
</tr>
<tr>
<td>URIEncoding</td>
<td>å¯¹ URI çš„ç¼–ç æ–¹å¼.</td>
<td>å¦‚æœè®¾ç½®ç³»ç»Ÿå˜é‡ org.apache.catalina.STRICT_SERVLET_COMPLIANCE ä¸º true,ä½¿ç”¨ ISO-8859-1 ç¼–ç ;å¦‚æœæœªè®¾ç½®æ­¤ç³»ç»Ÿå˜é‡ä¸”æœªè®¾ç½®æ­¤å±æ€§, ä½¿ç”¨ UTF-8 ç¼–ç </td>
</tr>
<tr>
<td>useBodyEncodingForURI</td>
<td>æ˜¯å¦é‡‡ç”¨æŒ‡å®šçš„ contentType è€Œä¸æ˜¯ URIEncoding æ¥ç¼–ç  URI ä¸­çš„è¯·æ±‚å‚æ•°</td>
<td></td>
</tr>
</tbody></table>
<p>ä»¥ä¸‹å±æ€§åœ¨æ ‡å‡†çš„ Connector(NIO, NIO2 å’Œ APR&#x2F;native)ä¸­æœ‰æ•ˆ:</p>
<table>
<thead>
<tr>
<th>å±æ€§</th>
<th>è¯´æ˜</th>
<th>å¤‡æ³¨</th>
</tr>
</thead>
<tbody><tr>
<td>acceptCount</td>
<td>å½“æœ€å¤§è¯·æ±‚è¿æ¥ maxConnections æ»¡æ—¶çš„æœ€å¤§æ’é˜Ÿå¤§å°</td>
<td>é»˜è®¤ 100,æ³¨æ„æ­¤å±æ€§å’Œ Executor ä¸­å±æ€§ maxQueueSize çš„åŒºåˆ«.è¿™ä¸ªæŒ‡çš„æ˜¯è¯·æ±‚è¿æ¥æ»¡æ—¶çš„å †æ ˆå¤§å°,Executor çš„ maxQueueSize æŒ‡çš„æ˜¯å¤„ç†çº¿ç¨‹æ»¡æ—¶çš„å †æ ˆå¤§å°</td>
</tr>
<tr>
<td>connectionTimeout</td>
<td>è¯·æ±‚è¿æ¥è¶…æ—¶</td>
<td>é»˜è®¤ 60000ms</td>
</tr>
<tr>
<td>executor</td>
<td>æŒ‡å®šé…ç½®çš„çº¿ç¨‹æ± åç§°</td>
<td></td>
</tr>
<tr>
<td>keepAliveTimeout</td>
<td>keeAlive è¶…æ—¶æ—¶é—´</td>
<td>é»˜è®¤å€¼ä¸º connectionTimeout é…ç½®å€¼.-1 è¡¨ç¤ºä¸è¶…æ—¶</td>
</tr>
<tr>
<td>maxConnections</td>
<td>æœ€å¤§è¿æ¥æ•°</td>
<td>è¿æ¥æ»¡æ—¶åç»­è¿æ¥æ”¾å…¥æœ€å¤§ä¸º acceptCount çš„é˜Ÿåˆ—ä¸­. å¯¹ NIO å’Œ NIO2 è¿æ¥,é»˜è®¤å€¼ä¸º 10000;å¯¹ APR&#x2F;native,é»˜è®¤å€¼ä¸º 8192</td>
</tr>
<tr>
<td>maxThreads</td>
<td>å¦‚æœæŒ‡å®šäº† Executor, æ­¤å±æ€§å¿½ç•¥;å¦åˆ™ä¸º Connector åˆ›å»ºçš„å†…éƒ¨çº¿ç¨‹æ± æœ€å¤§å€¼</td>
<td>é»˜è®¤ 200</td>
</tr>
<tr>
<td>minSpareThreads</td>
<td>å¦‚æœæŒ‡å®šäº† Executor, æ­¤å±æ€§å¿½ç•¥;å¦åˆ™ä¸º Connector åˆ›å»ºçº¿ç¨‹æ± çš„æœ€å°æ´»è·ƒçº¿ç¨‹æ•°</td>
<td>é»˜è®¤ 10</td>
</tr>
<tr>
<td>processorCache</td>
<td>åè®®å¤„ç†å™¨ç¼“å­˜ Processor å¯¹è±¡çš„å¤§å°</td>
<td>-1 è¡¨ç¤ºä¸é™åˆ¶.å½“ä¸ä½¿ç”¨ servlet3.0 çš„å¼‚æ­¥å¤„ç†æƒ…å†µä¸‹: å¦‚æœé…ç½® Executor,é…ç½®ä¸º Executor çš„ maxThreads;å¦åˆ™é…ç½®ä¸º Connnector çš„ maxThreads. å¦‚æœä½¿ç”¨ Serlvet3.0 å¼‚æ­¥å¤„ç†, å– maxThreads å’Œ maxConnections çš„æœ€å¤§å€¼</td>
</tr>
</tbody></table>
<h4 id="2-2-5-Context"><a href="#2-2-5-Context" class="headerlink" title="2.2.5. Context"></a>2.2.5. Context</h4><blockquote>
<p>Context å…ƒç´ è¡¨ç¤ºä¸€ä¸ª Web åº”ç”¨ç¨‹åºï¼Œå®ƒåœ¨ç‰¹å®šçš„è™šæ‹Ÿä¸»æœºä¸­è¿è¡Œã€‚æ¯ä¸ª Web åº”ç”¨ç¨‹åºéƒ½åŸºäº Web åº”ç”¨ç¨‹åºå­˜æ¡£ï¼ˆWARï¼‰æ–‡ä»¶ï¼Œæˆ–è€…åŒ…å«ç›¸åº”çš„è§£åŒ…å†…å®¹çš„ç›¸åº”ç›®å½•ï¼Œå¦‚ Servlet è§„èŒƒä¸­æ‰€è¿°ã€‚</p>
</blockquote>
<p><strong>å±æ€§è¡¨</strong></p>
<table>
<thead>
<tr>
<th>å±æ€§</th>
<th>è¯´æ˜</th>
<th>å¤‡æ³¨</th>
</tr>
</thead>
<tbody><tr>
<td>altDDName</td>
<td>web.xml éƒ¨ç½²æè¿°ç¬¦è·¯å¾„</td>
<td>é»˜è®¤ &#x2F;WEB-INF&#x2F;web.xml</td>
</tr>
<tr>
<td>docBase</td>
<td>Context çš„ Root è·¯å¾„</td>
<td>å’Œ Host çš„ appBase ç›¸ç»“åˆ, å¯ç¡®å®š web åº”ç”¨çš„å®é™…ç›®å½•</td>
</tr>
<tr>
<td>failCtxIfServletStartFails</td>
<td>åŒ Host ä¸­çš„ failCtxIfServletStartFails, åªå¯¹å½“å‰ Context æœ‰æ•ˆ</td>
<td>é»˜è®¤ä¸º false</td>
</tr>
<tr>
<td>logEffectiveWebXml</td>
<td>æ˜¯å¦æ—¥å¿—æ‰“å° web.xml å†…å®¹(web.xml ç”±é»˜è®¤çš„ web.xml å’Œåº”ç”¨ä¸­çš„ web.xml ç»„æˆ)</td>
<td>é»˜è®¤ä¸º false</td>
</tr>
<tr>
<td>path</td>
<td>web åº”ç”¨çš„ context path</td>
<td>å¦‚æœä¸ºæ ¹è·¯å¾„,åˆ™é…ç½®ä¸ºç©ºå­—ç¬¦ä¸²(â€œâ€), ä¸èƒ½ä¸é…ç½®</td>
</tr>
<tr>
<td>privileged</td>
<td>æ˜¯å¦ä½¿ç”¨ Tomcat æä¾›çš„ manager servlet</td>
<td></td>
</tr>
<tr>
<td>reloadable</td>
<td>&#x2F;WEB-INF&#x2F;classes&#x2F; å’Œ&#x2F;WEB-INF&#x2F;lib&#x2F; ç›®å½•ä¸­ class æ–‡ä»¶å‘ç”Ÿå˜åŒ–æ˜¯å¦è‡ªåŠ¨é‡æ–°åŠ è½½</td>
<td>é»˜è®¤ä¸º false</td>
</tr>
<tr>
<td>swallowOutput</td>
<td>true æƒ…å†µä¸‹, System.out å’Œ System.err è¾“å‡ºå°†è¢«å®šå‘åˆ° web åº”ç”¨æ—¥å¿—ä¸­</td>
<td>é»˜è®¤ä¸º false</td>
</tr>
</tbody></table>
<h4 id="2-2-6-Engine"><a href="#2-2-6-Engine" class="headerlink" title="2.2.6. Engine"></a>2.2.6. Engine</h4><blockquote>
<p>Engine å…ƒç´ è¡¨ç¤ºä¸ç‰¹å®šçš„ Catalina æœåŠ¡ç›¸å…³è”çš„æ•´ä¸ªè¯·æ±‚å¤„ç†æœºå™¨ã€‚å®ƒæ¥æ”¶å¹¶å¤„ç†æ¥è‡ªä¸€ä¸ªæˆ–å¤šä¸ªè¿æ¥å™¨çš„æ‰€æœ‰è¯·æ±‚ï¼Œå¹¶å°†å®Œæˆçš„å“åº”è¿”å›ç»™è¿æ¥å™¨ï¼Œä»¥ä¾¿æœ€ç»ˆä¼ è¾“å›å®¢æˆ·ç«¯ã€‚</p>
</blockquote>
<p><strong>å±æ€§è¡¨</strong></p>
<table>
<thead>
<tr>
<th>å±æ€§</th>
<th>æè¿°</th>
<th>å¤‡æ³¨</th>
</tr>
</thead>
<tbody><tr>
<td>defaultHost</td>
<td>é»˜è®¤ä¸»æœºåï¼Œç”¨äºæ ‡è¯†å°†å¤„ç†æŒ‡å‘æ­¤æœåŠ¡å™¨ä¸Šä¸»æœºåç§°ä½†æœªåœ¨æ­¤é…ç½®æ–‡ä»¶ä¸­é…ç½®çš„è¯·æ±‚çš„ä¸»æœºã€‚</td>
<td>è¿™ä¸ªåå­—å¿…é¡»åŒ¹é…å…¶ä¸­ä¸€ä¸ªåµŒå¥—çš„ä¸»æœºå…ƒç´ çš„åå­—å±æ€§ã€‚</td>
</tr>
<tr>
<td>name</td>
<td>æ­¤å¼•æ“çš„é€»è¾‘åç§°ï¼Œç”¨äºæ—¥å¿—å’Œé”™è¯¯æ¶ˆæ¯ã€‚</td>
<td>åœ¨åŒä¸€æœåŠ¡å™¨ä¸­ä½¿ç”¨å¤šä¸ªæœåŠ¡å…ƒç´ æ—¶ï¼Œæ¯ä¸ªå¼•æ“å¿…é¡»åˆ†é…ä¸€ä¸ªå”¯ä¸€çš„åç§°ã€‚</td>
</tr>
</tbody></table>
<h4 id="2-2-7-Host"><a href="#2-2-7-Host" class="headerlink" title="2.2.7. Host"></a>2.2.7. Host</h4><blockquote>
<p>Host å…ƒç´ è¡¨ç¤ºä¸€ä¸ªè™šæ‹Ÿä¸»æœºï¼Œå®ƒæ˜¯ä¸€ä¸ªæœåŠ¡å™¨çš„ç½‘ç»œåç§°ï¼ˆå¦‚â€œ<a target="_blank" rel="noopener" href="http://www.mycompany.comâ€)ä¸è¿è¡Œ/">www.mycompany.comâ€ï¼‰ä¸è¿è¡Œ</a> Tomcat çš„ç‰¹å®šæœåŠ¡å™¨çš„å…³è”ã€‚</p>
</blockquote>
<p><strong>å±æ€§è¡¨</strong></p>
<table>
<thead>
<tr>
<th>å±æ€§</th>
<th>è¯´æ˜</th>
<th>å¤‡æ³¨</th>
</tr>
</thead>
<tbody><tr>
<td>name</td>
<td>åç§°</td>
<td>ç”¨äºæ—¥å¿—è¾“å‡º</td>
</tr>
<tr>
<td>appBase</td>
<td>è™šæ‹Ÿä¸»æœºå¯¹åº”çš„åº”ç”¨åŸºç¡€è·¯å¾„</td>
<td>å¯ä»¥æ˜¯ä¸ªç»å¯¹è·¯å¾„, æˆ–${CATALINA_BASE}ç›¸å¯¹è·¯å¾„</td>
</tr>
<tr>
<td>xmlBase</td>
<td>è™šæ‹Ÿä¸»æœº XML åŸºç¡€è·¯å¾„,é‡Œé¢åº”è¯¥æœ‰ Context xml é…ç½®æ–‡ä»¶</td>
<td>å¯ä»¥æ˜¯ä¸ªç»å¯¹è·¯å¾„, æˆ–${CATALINA_BASE}ç›¸å¯¹è·¯å¾„</td>
</tr>
<tr>
<td>createDirs</td>
<td>å½“ appBase å’Œ xmlBase ä¸å­˜åœ¨æ—¶,æ˜¯å¦åˆ›å»ºç›®å½•</td>
<td>é»˜è®¤ä¸º true</td>
</tr>
<tr>
<td>autoDeploy</td>
<td>æ˜¯å¦å‘¨æœŸæ€§çš„æ£€æŸ¥ appBase å’Œ xmlBase å¹¶ deploy web åº”ç”¨å’Œ context æè¿°ç¬¦</td>
<td>é»˜è®¤ä¸º true</td>
</tr>
<tr>
<td>deployIgnore</td>
<td>å¿½ç•¥ deploy çš„æ­£åˆ™</td>
<td></td>
</tr>
<tr>
<td>deployOnStartup</td>
<td>Tomcat å¯åŠ¨æ—¶æ˜¯å¦è‡ªåŠ¨ deploy</td>
<td>é»˜è®¤ä¸º true</td>
</tr>
<tr>
<td>failCtxIfServletStartFails</td>
<td>é…ç½®ä¸º true æƒ…å†µä¸‹,ä»»ä½• load-on-startup &gt;&#x3D;0 çš„ servlet å¯åŠ¨å¤±è´¥,åˆ™å…¶å¯¹åº”çš„ Contxt ä¹Ÿå¯åŠ¨å¤±è´¥</td>
<td>é»˜è®¤ä¸º false</td>
</tr>
</tbody></table>
<h4 id="2-2-8-Cluster"><a href="#2-2-8-Cluster" class="headerlink" title="2.2.8. Cluster"></a>2.2.8. Cluster</h4><p>ç”±äºåœ¨å®é™…å¼€å‘ä¸­ï¼Œæˆ‘ä»æœªç”¨è¿‡ Tomcat é›†ç¾¤é…ç½®ï¼Œæ‰€ä»¥æ²¡ç ”ç©¶ã€‚</p>
<h3 id="2-3-å¯åŠ¨"><a href="#2-3-å¯åŠ¨" class="headerlink" title="2.3. å¯åŠ¨"></a>2.3. å¯åŠ¨</h3><h4 id="2-3-1-éƒ¨ç½²æ–¹å¼"><a href="#2-3-1-éƒ¨ç½²æ–¹å¼" class="headerlink" title="2.3.1. éƒ¨ç½²æ–¹å¼"></a>2.3.1. éƒ¨ç½²æ–¹å¼</h4><p>è¿™ç§æ–¹å¼è¦æ±‚æœ¬åœ°å¿…é¡»å®‰è£… Tomcat ã€‚</p>
<p>å°†æ‰“åŒ…å¥½çš„ war åŒ…æ”¾åœ¨ Tomcat å®‰è£…ç›®å½•ä¸‹çš„ <code>webapps</code> ç›®å½•ä¸‹ï¼Œç„¶ååœ¨ bin ç›®å½•ä¸‹æ‰§è¡Œ <code>startup.bat</code> æˆ– <code>startup.sh</code> ï¼ŒTomcat ä¼šè‡ªåŠ¨è§£å‹ <code>webapps</code> ç›®å½•ä¸‹çš„ war åŒ…ã€‚</p>
<p>æˆåŠŸåï¼Œå¯ä»¥è®¿é—® <code>http://localhost:8080/xxx</code> ï¼ˆxxx æ˜¯ war åŒ…æ–‡ä»¶åï¼‰ã€‚</p>
<blockquote>
<p><strong>æ³¨æ„</strong></p>
<p>ä»¥ä¸Šæ­¥éª¤æ˜¯æœ€ç®€å•çš„ç¤ºä¾‹ã€‚æ­¥éª¤ä¸­çš„ war åŒ…è§£å‹è·¯å¾„ã€å¯åŠ¨ç«¯å£ä»¥åŠä¸€äº›æ›´å¤šçš„åŠŸèƒ½éƒ½å¯ä»¥ä¿®æ”¹é…ç½®æ–‡ä»¶æ¥å®šåˆ¶ ï¼ˆä¸»è¦æ˜¯ <code>server.xml</code> æˆ– <code>context.xml</code> æ–‡ä»¶ï¼‰ã€‚</p>
</blockquote>
<h4 id="2-3-2-åµŒå…¥å¼"><a href="#2-3-2-åµŒå…¥å¼" class="headerlink" title="2.3.2. åµŒå…¥å¼"></a>2.3.2. åµŒå…¥å¼</h4><h5 id="2-3-2-1-API-æ–¹å¼"><a href="#2-3-2-1-API-æ–¹å¼" class="headerlink" title="2.3.2.1. API æ–¹å¼"></a>2.3.2.1. API æ–¹å¼</h5><p>åœ¨ pom.xml ä¸­æ·»åŠ ä¾èµ–</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.tomcat.embed<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>tomcat-embed-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>8.5.24<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>æ·»åŠ  SimpleEmbedTomcatServer.java æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.Optional;</span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.startup.Tomcat;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SimpleTomcatServer</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">PORT</span> <span class="operator">=</span> <span class="number">8080</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">CONTEXT_PATH</span> <span class="operator">=</span> <span class="string">&quot;/javatool-server&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// è®¾å®š profile</span></span><br><span class="line">        Optional&lt;String&gt; profile = Optional.ofNullable(System.getProperty(<span class="string">&quot;spring.profiles.active&quot;</span>));</span><br><span class="line">        System.setProperty(<span class="string">&quot;spring.profiles.active&quot;</span>, profile.orElse(<span class="string">&quot;develop&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="type">Tomcat</span> <span class="variable">tomcat</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Tomcat</span>();</span><br><span class="line">        tomcat.setPort(PORT);</span><br><span class="line">        tomcat.getHost().setAppBase(<span class="string">&quot;.&quot;</span>);</span><br><span class="line">        tomcat.addWebapp(CONTEXT_PATH, getAbsolutePath() + <span class="string">&quot;src/main/webapp&quot;</span>);</span><br><span class="line">        tomcat.start();</span><br><span class="line">        tomcat.getServer().await();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String <span class="title function_">getAbsolutePath</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">folderPath</span> <span class="operator">=</span> SimpleEmbedTomcatServer.class.getProtectionDomain().getCodeSource().getLocation().getPath()</span><br><span class="line">                .substring(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (folderPath.indexOf(<span class="string">&quot;target&quot;</span>) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            path = folderPath.substring(<span class="number">0</span>, folderPath.indexOf(<span class="string">&quot;target&quot;</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> path;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æˆåŠŸåï¼Œå¯ä»¥è®¿é—® <code>http://localhost:8080/javatool-server</code> ã€‚</p>
<blockquote>
<p><strong>è¯´æ˜</strong></p>
<p>æœ¬ç¤ºä¾‹æ˜¯ä½¿ç”¨ <code>org.apache.tomcat.embed</code> å¯åŠ¨åµŒå…¥å¼ Tomcat çš„æœ€ç®€ç¤ºä¾‹ã€‚</p>
<p>è¿™ä¸ªç¤ºä¾‹ä¸­ä½¿ç”¨çš„æ˜¯ Tomcat é»˜è®¤çš„é…ç½®ï¼Œä½†é€šå¸¸ï¼Œæˆ‘ä»¬éœ€è¦å¯¹ Tomcat é…ç½®è¿›è¡Œä¸€äº›å®šåˆ¶å’Œè°ƒä¼˜ã€‚ä¸ºäº†åŠ è½½é…ç½®æ–‡ä»¶ï¼Œå¯åŠ¨ç±»å°±è¦ç¨å¾®å†å¤æ‚ä¸€äº›ã€‚è¿™é‡Œä¸æƒ³å†è´´ä»£ç ï¼Œæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥å‚è€ƒï¼š</p>
<p><a target="_blank" rel="noopener" href="https://github.com/dunwu/JavaStack/tree/master/codes/javatool/server"><strong>ç¤ºä¾‹é¡¹ç›®</strong></a></p>
</blockquote>
<h5 id="2-3-2-2-ä½¿ç”¨-maven-æ’ä»¶å¯åŠ¨ï¼ˆä¸æ¨èï¼‰"><a href="#2-3-2-2-ä½¿ç”¨-maven-æ’ä»¶å¯åŠ¨ï¼ˆä¸æ¨èï¼‰" class="headerlink" title="2.3.2.2. ä½¿ç”¨ maven æ’ä»¶å¯åŠ¨ï¼ˆä¸æ¨èï¼‰"></a>2.3.2.2. ä½¿ç”¨ maven æ’ä»¶å¯åŠ¨ï¼ˆä¸æ¨èï¼‰</h5><p>ä¸æ¨èç†ç”±ï¼šè¿™ç§æ–¹å¼å¯åŠ¨ maven è™½ç„¶æœ€ç®€å•ï¼Œä½†æ˜¯æœ‰ä¸€ä¸ªå¾ˆå¤§çš„é—®é¢˜æ˜¯ï¼ŒçœŸçš„å¾ˆä¹…å¾ˆä¹…æ²¡å‘å¸ƒæ–°ç‰ˆæœ¬äº†ï¼ˆæœ€æ–°ç‰ˆæœ¬å‘å¸ƒæ—¶é—´ï¼š2013-11-11ï¼‰ã€‚ä¸”è²Œä¼¼åªèƒ½æ‰¾åˆ° Tomcat6 ã€Tomcat7 æ’ä»¶ã€‚</p>
<p><strong>ä½¿ç”¨æ–¹æ³•</strong></p>
<p>åœ¨ pom.xml ä¸­å¼•å…¥æ’ä»¶</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.tomcat.maven<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>tomcat7-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">port</span>&gt;</span>8080<span class="tag">&lt;/<span class="name">port</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">path</span>&gt;</span>/$&#123;project.artifactId&#125;<span class="tag">&lt;/<span class="name">path</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">uriEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">uriEncoding</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>è¿è¡Œ <code>mvn tomcat7:run</code> å‘½ä»¤ï¼Œå¯åŠ¨ Tomcatã€‚</p>
<p>æˆåŠŸåï¼Œå¯ä»¥è®¿é—® <code>http://localhost:8080/xxx</code> ï¼ˆxxx æ˜¯ ${project.artifactId} æŒ‡å®šçš„é¡¹ç›®åï¼‰ã€‚</p>
<h4 id="2-3-3-IDE-æ’ä»¶"><a href="#2-3-3-IDE-æ’ä»¶" class="headerlink" title="2.3.3. IDE æ’ä»¶"></a>2.3.3. IDE æ’ä»¶</h4><p>å¸¸è§ Java IDE ä¸€èˆ¬éƒ½æœ‰å¯¹ Tomcat çš„æ”¯æŒã€‚</p>
<p>ä»¥ Intellij IDEA ä¸ºä¾‹ï¼Œæä¾›äº† <strong>Tomcat and TomEE Integration</strong> æ’ä»¶ï¼ˆä¸€èˆ¬é»˜è®¤ä¼šå®‰è£…ï¼‰ã€‚</p>
<p><strong>ä½¿ç”¨æ­¥éª¤</strong></p>
<ul>
<li>ç‚¹å‡» Run&#x2F;Debug Configurations &gt; New Tomcat Server &gt; local ï¼Œæ‰“å¼€ Tomcat é…ç½®é¡µé¢ã€‚</li>
<li>ç‚¹å‡» Confiureâ€¦ æŒ‰é’®ï¼Œè®¾ç½® Tomcat å®‰è£…è·¯å¾„ã€‚</li>
<li>ç‚¹å‡» Deployment æ ‡ç­¾é¡µï¼Œè®¾ç½®è¦å¯åŠ¨çš„åº”ç”¨ã€‚</li>
<li>è®¾ç½®å¯åŠ¨åº”ç”¨çš„ç«¯å£ã€JVM å‚æ•°ã€å¯åŠ¨æµè§ˆå™¨ç­‰ã€‚</li>
<li>æˆåŠŸåï¼Œå¯ä»¥è®¿é—® <code>http://localhost:8080/</code>ï¼ˆå½“ç„¶ï¼Œä½ ä¹Ÿå¯ä»¥åœ¨ url ä¸­è®¾ç½®ä¸Šä¸‹æ–‡åç§°ï¼‰ã€‚</li>
</ul>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/cs/java/javaweb/tools/tomcat/tomcat-intellij-run-config.png" alt="img"></p>
<blockquote>
<p><strong>è¯´æ˜</strong></p>
<p>ä¸ªäººè®¤ä¸ºè¿™ä¸ªæ’ä»¶ä¸å¦‚ Eclipse çš„ Tomcat æ’ä»¶å¥½ç”¨ï¼ŒEclipse çš„ Tomcat æ’ä»¶æ”¯æŒå¯¹ Tomcat xml é…ç½®æ–‡ä»¶è¿›è¡Œé…ç½®ã€‚è€Œè¿™é‡Œï¼Œä½ åªèƒ½è‡ªå·±å» Tomcat å®‰è£…è·¯å¾„ä¸‹ä¿®æ”¹é…ç½®æ–‡ä»¶ã€‚</p>
</blockquote>
<p>æ–‡ä¸­çš„åµŒå…¥å¼å¯åŠ¨ç¤ºä¾‹å¯ä»¥å‚è€ƒ<a target="_blank" rel="noopener" href="https://github.com/dunwu/JavaStack/tree/master/codes/javatool/server"><strong>æˆ‘çš„ç¤ºä¾‹é¡¹ç›®</strong></a></p>
<h2 id="3-Tomcat-æ¶æ„"><a href="#3-Tomcat-æ¶æ„" class="headerlink" title="3. Tomcat æ¶æ„"></a>3. Tomcat æ¶æ„</h2><p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/20201113193431.png" alt="img"></p>
<p>Tomcat è¦å®ç° 2 ä¸ªæ ¸å¿ƒåŠŸèƒ½ï¼š</p>
<ul>
<li><strong>å¤„ç† Socket è¿æ¥</strong>ï¼Œè´Ÿè´£ç½‘ç»œå­—èŠ‚æµä¸ Request å’Œ Response å¯¹è±¡çš„è½¬åŒ–ã€‚</li>
<li><strong>åŠ è½½å’Œç®¡ç† Servlet</strong>ï¼Œä»¥åŠ<strong>å¤„ç†å…·ä½“çš„ Request è¯·æ±‚</strong>ã€‚</li>
</ul>
<p>ä¸ºæ­¤ï¼ŒTomcat è®¾è®¡äº†ä¸¤ä¸ªæ ¸å¿ƒç»„ä»¶ï¼š</p>
<ul>
<li><strong>è¿æ¥å™¨ï¼ˆConnectorï¼‰</strong>ï¼šè´Ÿè´£å’Œå¤–éƒ¨é€šä¿¡</li>
<li><strong>å®¹å™¨ï¼ˆContainerï¼‰</strong>ï¼šè´Ÿè´£å†…éƒ¨å¤„ç†</li>
</ul>
<h3 id="3-1-Service"><a href="#3-1-Service" class="headerlink" title="3.1. Service"></a>3.1. Service</h3><p>Tomcat æ”¯æŒçš„ I&#x2F;O æ¨¡å‹æœ‰ï¼š</p>
<ul>
<li>NIOï¼šéé˜»å¡ I&#x2F;Oï¼Œé‡‡ç”¨ Java NIO ç±»åº“å®ç°ã€‚</li>
<li>NIO2ï¼šå¼‚æ­¥ I&#x2F;Oï¼Œé‡‡ç”¨ JDK 7 æœ€æ–°çš„ NIO2 ç±»åº“å®ç°ã€‚</li>
<li>APRï¼šé‡‡ç”¨ Apache å¯ç§»æ¤è¿è¡Œåº“å®ç°ï¼Œæ˜¯ C&#x2F;C++ ç¼–å†™çš„æœ¬åœ°åº“ã€‚</li>
</ul>
<p>Tomcat æ”¯æŒçš„åº”ç”¨å±‚åè®®æœ‰ï¼š</p>
<ul>
<li>HTTP&#x2F;1.1ï¼šè¿™æ˜¯å¤§éƒ¨åˆ† Web åº”ç”¨é‡‡ç”¨çš„è®¿é—®åè®®ã€‚</li>
<li>AJPï¼šç”¨äºå’Œ Web æœåŠ¡å™¨é›†æˆï¼ˆå¦‚ Apacheï¼‰ã€‚</li>
<li>HTTP&#x2F;2ï¼šHTTP 2.0 å¤§å¹…åº¦çš„æå‡äº† Web æ€§èƒ½ã€‚</li>
</ul>
<p>Tomcat æ”¯æŒå¤šç§ I&#x2F;O æ¨¡å‹å’Œåº”ç”¨å±‚åè®®ã€‚ä¸ºäº†å®ç°è¿™ç‚¹ï¼Œä¸€ä¸ªå®¹å™¨å¯èƒ½å¯¹æ¥å¤šä¸ªè¿æ¥å™¨ã€‚ä½†æ˜¯ï¼Œå•ç‹¬çš„è¿æ¥å™¨æˆ–å®¹å™¨éƒ½ä¸èƒ½å¯¹å¤–æä¾›æœåŠ¡ï¼Œéœ€è¦æŠŠå®ƒä»¬ç»„è£…èµ·æ¥æ‰èƒ½å·¥ä½œï¼Œç»„è£…åè¿™ä¸ªæ•´ä½“å«ä½œ Service ç»„ä»¶ã€‚Tomcat å†…å¯èƒ½æœ‰å¤šä¸ª Serviceï¼Œé€šè¿‡åœ¨ Tomcat ä¸­é…ç½®å¤šä¸ª Serviceï¼Œå¯ä»¥å®ç°é€šè¿‡ä¸åŒçš„ç«¯å£å·æ¥è®¿é—®åŒä¸€å°æœºå™¨ä¸Šéƒ¨ç½²çš„ä¸åŒåº”ç”¨ã€‚</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/20201111093124.png" alt="img"></p>
<p><strong>ä¸€ä¸ª Tomcat å®ä¾‹æœ‰ä¸€ä¸ªæˆ–å¤šä¸ª Serviceï¼›ä¸€ä¸ª Service æœ‰å¤šä¸ª Connector å’Œ Container</strong>ã€‚Connector å’Œ Container ä¹‹é—´é€šè¿‡æ ‡å‡†çš„ ServletRequest å’Œ ServletResponse é€šä¿¡ã€‚</p>
<h3 id="3-2-è¿æ¥å™¨"><a href="#3-2-è¿æ¥å™¨" class="headerlink" title="3.2. è¿æ¥å™¨"></a>3.2. è¿æ¥å™¨</h3><p>è¿æ¥å™¨å¯¹ Servlet å®¹å™¨å±è”½äº†åè®®åŠ I&#x2F;O æ¨¡å‹ç­‰çš„åŒºåˆ«ï¼Œæ— è®ºæ˜¯ HTTP è¿˜æ˜¯ AJPï¼Œåœ¨å®¹å™¨ä¸­è·å–åˆ°çš„éƒ½æ˜¯ä¸€ä¸ªæ ‡å‡†çš„ ServletRequest å¯¹è±¡ã€‚</p>
<p>è¿æ¥å™¨çš„ä¸»è¦åŠŸèƒ½æ˜¯ï¼š</p>
<ul>
<li>ç½‘ç»œé€šä¿¡</li>
<li>åº”ç”¨å±‚åè®®è§£æ</li>
<li>Tomcat Request&#x2F;Response ä¸ ServletRequest&#x2F;ServletResponse çš„è½¬åŒ–</li>
</ul>
<p>Tomcat è®¾è®¡äº† 3 ä¸ªç»„ä»¶æ¥å®ç°è¿™ 3 ä¸ªåŠŸèƒ½ï¼Œåˆ†åˆ«æ˜¯ <strong><code>EndPoint</code><strong>ã€</strong><code>Processor</code></strong> å’Œ **<code>Adapter</code>**ã€‚</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/20201111101440.png" alt="img"></p>
<p>ç»„ä»¶é—´é€šè¿‡æŠ½è±¡æ¥å£äº¤äº’ã€‚è¿™æ ·åšè¿˜æœ‰ä¸€ä¸ªå¥½å¤„æ˜¯<strong>å°è£…å˜åŒ–ã€‚</strong>è¿™æ˜¯é¢å‘å¯¹è±¡è®¾è®¡çš„ç²¾é«“ï¼Œå°†ç³»ç»Ÿä¸­ç»å¸¸å˜åŒ–çš„éƒ¨åˆ†å’Œç¨³å®šçš„éƒ¨åˆ†éš”ç¦»ï¼Œæœ‰åŠ©äºå¢åŠ å¤ç”¨æ€§ï¼Œå¹¶é™ä½ç³»ç»Ÿè€¦åˆåº¦ã€‚ç½‘ç»œé€šä¿¡çš„ I&#x2F;O æ¨¡å‹æ˜¯å˜åŒ–çš„ï¼Œå¯èƒ½æ˜¯éé˜»å¡ I&#x2F;Oã€å¼‚æ­¥ I&#x2F;O æˆ–è€… APRã€‚åº”ç”¨å±‚åè®®ä¹Ÿæ˜¯å˜åŒ–çš„ï¼Œå¯èƒ½æ˜¯ HTTPã€HTTPSã€AJPã€‚æµè§ˆå™¨ç«¯å‘é€çš„è¯·æ±‚ä¿¡æ¯ä¹Ÿæ˜¯å˜åŒ–çš„ã€‚ä½†æ˜¯æ•´ä½“çš„å¤„ç†é€»è¾‘æ˜¯ä¸å˜çš„ï¼ŒEndPoint è´Ÿè´£æä¾›å­—èŠ‚æµç»™ Processorï¼ŒProcessor è´Ÿè´£æä¾› Tomcat Request å¯¹è±¡ç»™ Adapterï¼ŒAdapter è´Ÿè´£æä¾› ServletRequest å¯¹è±¡ç»™å®¹å™¨ã€‚</p>
<p>å¦‚æœè¦æ”¯æŒæ–°çš„ I&#x2F;O æ–¹æ¡ˆã€æ–°çš„åº”ç”¨å±‚åè®®ï¼Œåªéœ€è¦å®ç°ç›¸å…³çš„å…·ä½“å­ç±»ï¼Œä¸Šå±‚é€šç”¨çš„å¤„ç†é€»è¾‘æ˜¯ä¸å˜çš„ã€‚ç”±äº I&#x2F;O æ¨¡å‹å’Œåº”ç”¨å±‚åè®®å¯ä»¥è‡ªç”±ç»„åˆï¼Œæ¯”å¦‚ NIO + HTTP æˆ–è€… NIO2 + AJPã€‚Tomcat çš„è®¾è®¡è€…å°†ç½‘ç»œé€šä¿¡å’Œåº”ç”¨å±‚åè®®è§£ææ”¾åœ¨ä¸€èµ·è€ƒè™‘ï¼Œè®¾è®¡äº†ä¸€ä¸ªå« ProtocolHandler çš„æ¥å£æ¥å°è£…è¿™ä¸¤ç§å˜åŒ–ç‚¹ã€‚å„ç§åè®®å’Œé€šä¿¡æ¨¡å‹çš„ç»„åˆæœ‰ç›¸åº”çš„å…·ä½“å®ç°ç±»ã€‚æ¯”å¦‚ï¼šHttp11NioProtocol å’Œ AjpNioProtocolã€‚</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/20201027091819.png" alt="img"></p>
<h4 id="3-2-1-ProtocolHandler-ç»„ä»¶"><a href="#3-2-1-ProtocolHandler-ç»„ä»¶" class="headerlink" title="3.2.1. ProtocolHandler ç»„ä»¶"></a>3.2.1. ProtocolHandler ç»„ä»¶</h4><p><strong>è¿æ¥å™¨ç”¨ ProtocolHandler æ¥å£æ¥å°è£…é€šä¿¡åè®®å’Œ I&#x2F;O æ¨¡å‹çš„å·®å¼‚</strong>ã€‚ProtocolHandler å†…éƒ¨åˆåˆ†ä¸º EndPoint å’Œ Processor æ¨¡å—ï¼ŒEndPoint è´Ÿè´£åº•å±‚ Socket é€šä¿¡ï¼ŒProccesor è´Ÿè´£åº”ç”¨å±‚åè®®è§£æã€‚</p>
<h5 id="3-2-1-1-EndPoint"><a href="#3-2-1-1-EndPoint" class="headerlink" title="3.2.1.1. EndPoint"></a>3.2.1.1. EndPoint</h5><p>EndPoint æ˜¯é€šä¿¡ç«¯ç‚¹ï¼Œå³é€šä¿¡ç›‘å¬çš„æ¥å£ï¼Œæ˜¯å…·ä½“çš„ Socket æ¥æ”¶å’Œå‘é€å¤„ç†å™¨ï¼Œæ˜¯å¯¹ä¼ è¾“å±‚çš„æŠ½è±¡ï¼Œå› æ­¤ EndPoint æ˜¯ç”¨æ¥å®ç° TCP&#x2F;IP åè®®çš„ã€‚</p>
<p>EndPoint æ˜¯ä¸€ä¸ªæ¥å£ï¼Œå¯¹åº”çš„æŠ½è±¡å®ç°ç±»æ˜¯ AbstractEndpointï¼Œè€Œ AbstractEndpoint çš„å…·ä½“å­ç±»ï¼Œæ¯”å¦‚åœ¨ NioEndpoint å’Œ Nio2Endpoint ä¸­ï¼Œæœ‰ä¸¤ä¸ªé‡è¦çš„å­ç»„ä»¶ï¼šAcceptor å’Œ SocketProcessorã€‚</p>
<p>å…¶ä¸­ Acceptor ç”¨äºç›‘å¬ Socket è¿æ¥è¯·æ±‚ã€‚SocketProcessor ç”¨äºå¤„ç†æ¥æ”¶åˆ°çš„ Socket è¯·æ±‚ï¼Œå®ƒå®ç° Runnable æ¥å£ï¼Œåœ¨ Run æ–¹æ³•é‡Œè°ƒç”¨åè®®å¤„ç†ç»„ä»¶ Processor è¿›è¡Œå¤„ç†ã€‚ä¸ºäº†æé«˜å¤„ç†èƒ½åŠ›ï¼ŒSocketProcessor è¢«æäº¤åˆ°çº¿ç¨‹æ± æ¥æ‰§è¡Œã€‚è€Œè¿™ä¸ªçº¿ç¨‹æ± å«ä½œæ‰§è¡Œå™¨ï¼ˆExecutor)ã€‚</p>
<h5 id="3-2-1-2-Processor"><a href="#3-2-1-2-Processor" class="headerlink" title="3.2.1.2. Processor"></a>3.2.1.2. Processor</h5><p>å¦‚æœè¯´ EndPoint æ˜¯ç”¨æ¥å®ç° TCP&#x2F;IP åè®®çš„ï¼Œé‚£ä¹ˆ Processor ç”¨æ¥å®ç° HTTP åè®®ï¼ŒProcessor æ¥æ”¶æ¥è‡ª EndPoint çš„ Socketï¼Œè¯»å–å­—èŠ‚æµè§£ææˆ Tomcat Request å’Œ Response å¯¹è±¡ï¼Œå¹¶é€šè¿‡ Adapter å°†å…¶æäº¤åˆ°å®¹å™¨å¤„ç†ï¼ŒProcessor æ˜¯å¯¹åº”ç”¨å±‚åè®®çš„æŠ½è±¡ã€‚</p>
<p>Processor æ˜¯ä¸€ä¸ªæ¥å£ï¼Œå®šä¹‰äº†è¯·æ±‚çš„å¤„ç†ç­‰æ–¹æ³•ã€‚å®ƒçš„æŠ½è±¡å®ç°ç±» AbstractProcessor å¯¹ä¸€äº›åè®®å…±æœ‰çš„å±æ€§è¿›è¡Œå°è£…ï¼Œæ²¡æœ‰å¯¹æ–¹æ³•è¿›è¡Œå®ç°ã€‚å…·ä½“çš„å®ç°æœ‰ AJPProcessorã€HTTP11Processor ç­‰ï¼Œè¿™äº›å…·ä½“å®ç°ç±»å®ç°äº†ç‰¹å®šåè®®çš„è§£ææ–¹æ³•å’Œè¯·æ±‚å¤„ç†æ–¹å¼ã€‚</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/20201113185929.png" alt="img"></p>
<p>ä»å›¾ä¸­æˆ‘ä»¬çœ‹åˆ°ï¼ŒEndPoint æ¥æ”¶åˆ° Socket è¿æ¥åï¼Œç”Ÿæˆä¸€ä¸ª SocketProcessor ä»»åŠ¡æäº¤åˆ°çº¿ç¨‹æ± å»å¤„ç†ï¼ŒSocketProcessor çš„ Run æ–¹æ³•ä¼šè°ƒç”¨ Processor ç»„ä»¶å»è§£æåº”ç”¨å±‚åè®®ï¼ŒProcessor é€šè¿‡è§£æç”Ÿæˆ Request å¯¹è±¡åï¼Œä¼šè°ƒç”¨ Adapter çš„ Service æ–¹æ³•ã€‚</p>
<h4 id="3-2-2-Adapter"><a href="#3-2-2-Adapter" class="headerlink" title="3.2.2. Adapter"></a>3.2.2. Adapter</h4><p><strong>è¿æ¥å™¨é€šè¿‡é€‚é…å™¨ Adapter è°ƒç”¨å®¹å™¨</strong>ã€‚</p>
<p>ç”±äºåè®®ä¸åŒï¼Œå®¢æˆ·ç«¯å‘è¿‡æ¥çš„è¯·æ±‚ä¿¡æ¯ä¹Ÿä¸å°½ç›¸åŒï¼ŒTomcat å®šä¹‰äº†è‡ªå·±çš„ Request ç±»æ¥é€‚é…è¿™äº›è¯·æ±‚ä¿¡æ¯ã€‚</p>
<p>ProtocolHandler æ¥å£è´Ÿè´£è§£æè¯·æ±‚å¹¶ç”Ÿæˆ Tomcat Request ç±»ã€‚ä½†æ˜¯è¿™ä¸ª Request å¯¹è±¡ä¸æ˜¯æ ‡å‡†çš„ ServletRequestï¼Œä¹Ÿå°±æ„å‘³ç€ï¼Œä¸èƒ½ç”¨ Tomcat Request ä½œä¸ºå‚æ•°æ¥è°ƒç”¨å®¹å™¨ã€‚Tomcat çš„è§£å†³æ–¹æ¡ˆæ˜¯å¼•å…¥ CoyoteAdapterï¼Œè¿™æ˜¯é€‚é…å™¨æ¨¡å¼çš„ç»å…¸è¿ç”¨ï¼Œè¿æ¥å™¨è°ƒç”¨ CoyoteAdapter çš„ Sevice æ–¹æ³•ï¼Œä¼ å…¥çš„æ˜¯ Tomcat Request å¯¹è±¡ï¼ŒCoyoteAdapter è´Ÿè´£å°† Tomcat Request è½¬æˆ ServletRequestï¼Œå†è°ƒç”¨å®¹å™¨çš„ Service æ–¹æ³•ã€‚</p>
<h3 id="3-3-å®¹å™¨"><a href="#3-3-å®¹å™¨" class="headerlink" title="3.3. å®¹å™¨"></a>3.3. å®¹å™¨</h3><p>Tomcat è®¾è®¡äº† 4 ç§å®¹å™¨ï¼Œåˆ†åˆ«æ˜¯ Engineã€Hostã€Context å’Œ Wrapperã€‚</p>
<ul>
<li><strong>Engine</strong> - Servlet çš„é¡¶å±‚å®¹å™¨ï¼ŒåŒ…å«ä¸€ ä¸ªæˆ–å¤šä¸ª Host å­å®¹å™¨ï¼›</li>
<li><strong>Host</strong> - è™šæ‹Ÿä¸»æœºï¼Œè´Ÿè´£ web åº”ç”¨çš„éƒ¨ç½²å’Œ Context çš„åˆ›å»ºï¼›</li>
<li><strong>Context</strong> - Web åº”ç”¨ä¸Šä¸‹æ–‡ï¼ŒåŒ…å«å¤šä¸ª Wrapperï¼Œè´Ÿè´£ web é…ç½®çš„è§£æã€ç®¡ç†æ‰€æœ‰çš„ Web èµ„æºï¼›</li>
<li><strong>Wrapper</strong> - æœ€åº•å±‚çš„å®¹å™¨ï¼Œæ˜¯å¯¹ Servlet çš„å°è£…ï¼Œè´Ÿè´£ Servlet å®ä¾‹çš„åˆ› å»ºã€æ‰§è¡Œå’Œé”€æ¯ã€‚</li>
</ul>
<h4 id="3-3-1-è¯·æ±‚åˆ†å‘-Servlet-è¿‡ç¨‹"><a href="#3-3-1-è¯·æ±‚åˆ†å‘-Servlet-è¿‡ç¨‹" class="headerlink" title="3.3.1. è¯·æ±‚åˆ†å‘ Servlet è¿‡ç¨‹"></a>3.3.1. è¯·æ±‚åˆ†å‘ Servlet è¿‡ç¨‹</h4><p>Tomcat æ˜¯æ€ä¹ˆç¡®å®šè¯·æ±‚æ˜¯ç”±å“ªä¸ª Wrapper å®¹å™¨é‡Œçš„ Servlet æ¥å¤„ç†çš„å‘¢ï¼Ÿç­”æ¡ˆæ˜¯ï¼ŒTomcat æ˜¯ç”¨ Mapper ç»„ä»¶æ¥å®Œæˆè¿™ä¸ªä»»åŠ¡çš„ã€‚</p>
<p>ä¸¾ä¾‹æ¥è¯´ï¼Œå‡å¦‚æœ‰ä¸€ä¸ªç½‘è´­ç³»ç»Ÿï¼Œæœ‰é¢å‘ç½‘ç«™ç®¡ç†äººå‘˜çš„åå°ç®¡ç†ç³»ç»Ÿï¼Œè¿˜æœ‰é¢å‘ç»ˆç«¯å®¢æˆ·çš„åœ¨çº¿è´­ç‰©ç³»ç»Ÿã€‚è¿™ä¸¤ä¸ªç³»ç»Ÿè·‘åœ¨åŒä¸€ä¸ª Tomcat ä¸Šï¼Œä¸ºäº†éš”ç¦»å®ƒä»¬çš„è®¿é—®åŸŸåï¼Œé…ç½®äº†ä¸¤ä¸ªè™šæ‹ŸåŸŸåï¼š<code>manage.shopping.com</code>å’Œ<code>user.shopping.com</code>ï¼Œç½‘ç«™ç®¡ç†äººå‘˜é€šè¿‡<code>manage.shopping.com</code>åŸŸåè®¿é—® Tomcat å»ç®¡ç†ç”¨æˆ·å’Œå•†å“ï¼Œè€Œç”¨æˆ·ç®¡ç†å’Œå•†å“ç®¡ç†æ˜¯ä¸¤ä¸ªå•ç‹¬çš„ Web åº”ç”¨ã€‚ç»ˆç«¯å®¢æˆ·é€šè¿‡<code>user.shopping.com</code>åŸŸåå»æœç´¢å•†å“å’Œä¸‹è®¢å•ï¼Œæœç´¢åŠŸèƒ½å’Œè®¢å•ç®¡ç†ä¹Ÿæ˜¯ä¸¤ä¸ªç‹¬ç«‹çš„ Web åº”ç”¨ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼Œæ¼”ç¤ºäº† url åº”å£° Servlet çš„å¤„ç†æµç¨‹ã€‚</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/20201113192022.jpg" alt="img"></p>
<p>å‡å¦‚æœ‰ç”¨æˆ·è®¿é—®ä¸€ä¸ª URLï¼Œæ¯”å¦‚å›¾ä¸­çš„<code>http://user.shopping.com:8080/order/buy</code>ï¼ŒTomcat å¦‚ä½•å°†è¿™ä¸ª URL å®šä½åˆ°ä¸€ä¸ª Servlet å‘¢ï¼Ÿ</p>
<ol>
<li><strong>é¦–å…ˆï¼Œæ ¹æ®åè®®å’Œç«¯å£å·é€‰å®š Service å’Œ Engineã€‚</strong></li>
<li><strong>ç„¶åï¼Œæ ¹æ®åŸŸåé€‰å®š Hostã€‚</strong></li>
<li><strong>ä¹‹åï¼Œæ ¹æ® URL è·¯å¾„æ‰¾åˆ° Context ç»„ä»¶ã€‚</strong></li>
<li><strong>æœ€åï¼Œæ ¹æ® URL è·¯å¾„æ‰¾åˆ° Wrapperï¼ˆServletï¼‰ã€‚</strong></li>
</ol>
<p>è¿™ä¸ªè·¯ç”±åˆ†å‘è¿‡ç¨‹å…·ä½“æ˜¯æ€ä¹ˆå®ç°çš„å‘¢ï¼Ÿç­”æ¡ˆæ˜¯ä½¿ç”¨ Pipeline-Valve ç®¡é“ã€‚</p>
<h4 id="3-3-2-Pipeline-Value"><a href="#3-3-2-Pipeline-Value" class="headerlink" title="3.3.2. Pipeline-Value"></a>3.3.2. Pipeline-Value</h4><p>Pipeline å¯ä»¥ç†è§£ä¸ºç°å®ä¸­çš„ç®¡é“ï¼ŒValve ä¸ºç®¡é“ä¸­çš„é˜€é—¨ï¼ŒRequest å’Œ Response å¯¹è±¡åœ¨ç®¡é“ä¸­ç»è¿‡å„ä¸ªé˜€é—¨çš„å¤„ç†å’Œæ§åˆ¶ã€‚</p>
<p>Pipeline-Valve æ˜¯è´£ä»»é“¾æ¨¡å¼ï¼Œè´£ä»»é“¾æ¨¡å¼æ˜¯æŒ‡åœ¨ä¸€ä¸ªè¯·æ±‚å¤„ç†çš„è¿‡ç¨‹ä¸­æœ‰å¾ˆå¤šå¤„ç†è€…ä¾æ¬¡å¯¹è¯·æ±‚è¿›è¡Œå¤„ç†ï¼Œæ¯ä¸ªå¤„ç†è€…è´Ÿè´£åšè‡ªå·±ç›¸åº”çš„å¤„ç†ï¼Œå¤„ç†å®Œä¹‹åå°†å†è°ƒç”¨ä¸‹ä¸€ä¸ªå¤„ç†è€…ç»§ç»­å¤„ç†ã€‚Valve è¡¨ç¤ºä¸€ä¸ªå¤„ç†ç‚¹ï¼Œæ¯”å¦‚æƒé™è®¤è¯å’Œè®°å½•æ—¥å¿—ã€‚</p>
<p>å…ˆæ¥äº†è§£ä¸€ä¸‹ Valve å’Œ Pipeline æ¥å£çš„è®¾è®¡ï¼š</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/cs/java/javaweb/tools/tomcat/Pipeline%E4%B8%8EValve.png" alt="img"></p>
<ul>
<li>æ¯ä¸€ä¸ªå®¹å™¨éƒ½æœ‰ä¸€ä¸ª Pipeline å¯¹è±¡ï¼Œåªè¦è§¦å‘è¿™ä¸ª Pipeline çš„ç¬¬ä¸€ä¸ª Valveï¼Œè¿™ä¸ªå®¹å™¨é‡Œ Pipeline ä¸­çš„ Valve å°±éƒ½ä¼šè¢«è°ƒç”¨åˆ°ã€‚ä½†æ˜¯ï¼Œä¸åŒå®¹å™¨çš„ Pipeline æ˜¯æ€ä¹ˆé“¾å¼è§¦å‘çš„å‘¢ï¼Œæ¯”å¦‚ Engine ä¸­ Pipeline éœ€è¦è°ƒç”¨ä¸‹å±‚å®¹å™¨ Host ä¸­çš„ Pipelineã€‚</li>
<li>è¿™æ˜¯å› ä¸º Pipeline ä¸­è¿˜æœ‰ä¸ª getBasic æ–¹æ³•ã€‚è¿™ä¸ª BasicValve å¤„äº Valve é“¾è¡¨çš„æœ«ç«¯ï¼Œå®ƒæ˜¯ Pipeline ä¸­å¿…ä¸å¯å°‘çš„ä¸€ä¸ª Valveï¼Œè´Ÿè´£è°ƒç”¨ä¸‹å±‚å®¹å™¨çš„ Pipeline é‡Œçš„ç¬¬ä¸€ä¸ª Valveã€‚</li>
<li>Pipeline ä¸­æœ‰ addValve æ–¹æ³•ã€‚Pipeline ä¸­ç»´æŠ¤äº† Valve é“¾è¡¨ï¼ŒValve å¯ä»¥æ’å…¥åˆ° Pipeline ä¸­ï¼Œå¯¹è¯·æ±‚åšæŸäº›å¤„ç†ã€‚æˆ‘ä»¬è¿˜å‘ç° Pipeline ä¸­æ²¡æœ‰ invoke æ–¹æ³•ï¼Œå› ä¸ºæ•´ä¸ªè°ƒç”¨é“¾çš„è§¦å‘æ˜¯ Valve æ¥å®Œæˆçš„ï¼ŒValve å®Œæˆè‡ªå·±çš„å¤„ç†åï¼Œè°ƒç”¨ <code>getNext.invoke()</code> æ¥è§¦å‘ä¸‹ä¸€ä¸ª Valve è°ƒç”¨ã€‚</li>
<li>Valve ä¸­ä¸»è¦çš„ä¸‰ä¸ªæ–¹æ³•ï¼š<code>setNext</code>ã€<code>getNext</code>ã€<code>invoke</code>ã€‚Valve ä¹‹é—´çš„å…³ç³»æ˜¯å•å‘é“¾å¼ç»“æ„ï¼Œæœ¬èº« <code>invoke</code> æ–¹æ³•ä¸­ä¼šè°ƒç”¨ä¸‹ä¸€ä¸ª Valve çš„ <code>invoke</code> æ–¹æ³•ã€‚</li>
<li>å„å±‚å®¹å™¨å¯¹åº”çš„ basic valve åˆ†åˆ«æ˜¯ <code>StandardEngineValve</code>ã€<code>StandardHostValve</code>ã€ <code>StandardContextValve</code>ã€<code>StandardWrapperValve</code>ã€‚</li>
<li>ç”±äº Valve æ˜¯ä¸€ä¸ªå¤„ç†ç‚¹ï¼Œå› æ­¤ invoke æ–¹æ³•å°±æ˜¯æ¥å¤„ç†è¯·æ±‚çš„ã€‚æ³¨æ„åˆ° Valve ä¸­æœ‰ getNext å’Œ setNext æ–¹æ³•ï¼Œå› æ­¤æˆ‘ä»¬å¤§æ¦‚å¯ä»¥çŒœåˆ°æœ‰ä¸€ä¸ªé“¾è¡¨å°† Valve é“¾èµ·æ¥äº†ã€‚</li>
</ul>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/cs/java/javaweb/tools/tomcat/%E8%AF%B7%E6%B1%82%E5%A4%84%E7%90%86%E8%BF%87%E7%A8%8B.png" alt="img"></p>
<p>æ•´ä¸ªè°ƒç”¨è¿‡ç¨‹ç”±è¿æ¥å™¨ä¸­çš„ Adapter è§¦å‘çš„ï¼Œå®ƒä¼šè°ƒç”¨ Engine çš„ç¬¬ä¸€ä¸ª Valveï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">connector.getService().getContainer().getPipeline().getFirst().invoke(request, response);</span><br></pre></td></tr></table></figure>

<h2 id="4-Tomcat-ç”Ÿå‘½å‘¨æœŸ"><a href="#4-Tomcat-ç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="4. Tomcat ç”Ÿå‘½å‘¨æœŸ"></a>4. Tomcat ç”Ÿå‘½å‘¨æœŸ</h2><h3 id="4-1-Tomcat-çš„å¯åŠ¨è¿‡ç¨‹"><a href="#4-1-Tomcat-çš„å¯åŠ¨è¿‡ç¨‹" class="headerlink" title="4.1. Tomcat çš„å¯åŠ¨è¿‡ç¨‹"></a>4.1. Tomcat çš„å¯åŠ¨è¿‡ç¨‹</h3><p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/20201118145455.png" alt="img"></p>
<ol>
<li>Tomcat æ˜¯ä¸€ä¸ª Java ç¨‹åºï¼Œå®ƒçš„è¿è¡Œä»æ‰§è¡Œ <code>startup.sh</code> è„šæœ¬å¼€å§‹ã€‚<code>startup.sh</code> ä¼šå¯åŠ¨ä¸€ä¸ª JVM æ¥è¿è¡Œ Tomcat çš„å¯åŠ¨ç±» <code>Bootstrap</code>ã€‚</li>
<li><code>Bootstrap</code> ä¼šåˆå§‹åŒ– Tomcat çš„ç±»åŠ è½½å™¨å¹¶å®ä¾‹åŒ– <code>Catalina</code>ã€‚</li>
<li><code>Catalina</code> ä¼šé€šè¿‡ Digester è§£æ <code>server.xml</code>ï¼Œæ ¹æ®å…¶ä¸­çš„é…ç½®ä¿¡æ¯æ¥åˆ›å»ºç›¸åº”ç»„ä»¶ï¼Œå¹¶è°ƒç”¨ <code>Server</code> çš„ <code>start</code> æ–¹æ³•ã€‚</li>
<li><code>Server</code> è´Ÿè´£ç®¡ç† <code>Service</code> ç»„ä»¶ï¼Œå®ƒä¼šè°ƒç”¨ <code>Service</code> çš„ <code>start</code> æ–¹æ³•ã€‚</li>
<li><code>Service</code> è´Ÿè´£ç®¡ç† <code>Connector</code> å’Œé¡¶å±‚å®¹å™¨ <code>Engine</code>ï¼Œå®ƒä¼šè°ƒç”¨ <code>Connector</code> å’Œ <code>Engine</code> çš„ <code>start</code> æ–¹æ³•ã€‚</li>
</ol>
<h4 id="4-1-1-Catalina-ç»„ä»¶"><a href="#4-1-1-Catalina-ç»„ä»¶" class="headerlink" title="4.1.1. Catalina ç»„ä»¶"></a>4.1.1. Catalina ç»„ä»¶</h4><p>Catalina çš„èŒè´£å°±æ˜¯è§£æ server.xml é…ç½®ï¼Œå¹¶æ®æ­¤å®ä¾‹åŒ– Serverã€‚æ¥ä¸‹æ¥ï¼Œè°ƒç”¨ Server ç»„ä»¶çš„ init æ–¹æ³•å’Œ start æ–¹æ³•ï¼Œå°† Tomcat å¯åŠ¨èµ·æ¥ã€‚</p>
<p>Catalina è¿˜éœ€è¦å¤„ç†å„ç§â€œå¼‚å¸¸â€æƒ…å†µï¼Œæ¯”å¦‚å½“æˆ‘ä»¬é€šè¿‡â€œCtrl + Câ€å…³é—­ Tomcat æ—¶ï¼ŒTomcat å°†å¦‚ä½•ä¼˜é›…çš„åœæ­¢å¹¶ä¸”æ¸…ç†èµ„æºå‘¢ï¼Ÿå› æ­¤ Catalina åœ¨ JVM ä¸­æ³¨å†Œä¸€ä¸ªâ€œå…³é—­é’©å­â€ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//1. å¦‚æœæŒæœ‰çš„ Server å®ä¾‹ä¸ºç©ºï¼Œå°±è§£æ server.xml åˆ›å»ºå‡ºæ¥</span></span><br><span class="line">    <span class="keyword">if</span> (getServer() == <span class="literal">null</span>) &#123;</span><br><span class="line">        load();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2. å¦‚æœåˆ›å»ºå¤±è´¥ï¼ŒæŠ¥é”™é€€å‡º</span></span><br><span class="line">    <span class="keyword">if</span> (getServer() == <span class="literal">null</span>) &#123;</span><br><span class="line">        log.fatal(sm.getString(<span class="string">&quot;catalina.noServer&quot;</span>));</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//3. å¯åŠ¨ Server</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        getServer().start();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (LifecycleException e) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»ºå¹¶æ³¨å†Œå…³é—­é’©å­</span></span><br><span class="line">    <span class="keyword">if</span> (useShutdownHook) &#123;</span><br><span class="line">        <span class="keyword">if</span> (shutdownHook == <span class="literal">null</span>) &#123;</span><br><span class="line">            shutdownHook = <span class="keyword">new</span> <span class="title class_">CatalinaShutdownHook</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        Runtime.getRuntime().addShutdownHook(shutdownHook);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç”¨ await æ–¹æ³•ç›‘å¬åœæ­¢è¯·æ±‚</span></span><br><span class="line">    <span class="keyword">if</span> (await) &#123;</span><br><span class="line">        await();</span><br><span class="line">        stop();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸ºä»€ä¹ˆéœ€è¦å…³é—­é’©å­ï¼Ÿ</p>
<p>å¦‚æœæˆ‘ä»¬éœ€è¦åœ¨ JVM å…³é—­æ—¶åšä¸€äº›æ¸…ç†å·¥ä½œï¼Œæ¯”å¦‚å°†ç¼“å­˜æ•°æ®åˆ·åˆ°ç£ç›˜ä¸Šï¼Œæˆ–è€…æ¸…ç†ä¸€äº›ä¸´æ—¶æ–‡ä»¶ï¼Œå¯ä»¥å‘ JVM æ³¨å†Œä¸€ä¸ªâ€œå…³é—­é’©å­â€ã€‚â€œå…³é—­é’©å­â€å…¶å®å°±æ˜¯ä¸€ä¸ªçº¿ç¨‹ï¼ŒJVM åœ¨åœæ­¢ä¹‹å‰ä¼šå°è¯•æ‰§è¡Œè¿™ä¸ªçº¿ç¨‹çš„ <code>run</code> æ–¹æ³•ã€‚</p>
<p>Tomcat çš„â€œå…³é—­é’©å­â€â€”â€” <code>CatalinaShutdownHook</code> åšäº†äº›ä»€ä¹ˆå‘¢ï¼Ÿ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">class</span> <span class="title class_">CatalinaShutdownHook</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (getServer() != <span class="literal">null</span>) &#123;</span><br><span class="line">                Catalina.<span class="built_in">this</span>.stop();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">           ...</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Tomcat çš„â€œå…³é—­é’©å­â€å®é™…ä¸Šå°±æ‰§è¡Œäº† <code>Server</code> çš„ <code>stop</code> æ–¹æ³•ï¼Œ<code>Server</code> çš„ <code>stop</code> æ–¹æ³•ä¼šé‡Šæ”¾å’Œæ¸…ç†æ‰€æœ‰çš„èµ„æºã€‚</p>
<h4 id="4-1-2-Server-ç»„ä»¶"><a href="#4-1-2-Server-ç»„ä»¶" class="headerlink" title="4.1.2. Server ç»„ä»¶"></a>4.1.2. Server ç»„ä»¶</h4><p>Server ç»„ä»¶çš„å…·ä½“å®ç°ç±»æ˜¯ StandardServerï¼ŒServer ç»§æ‰¿äº† LifeCycleBaseï¼Œå®ƒçš„ç”Ÿå‘½å‘¨æœŸè¢«ç»Ÿä¸€ç®¡ç†ï¼Œå¹¶ä¸”å®ƒçš„å­ç»„ä»¶æ˜¯ Serviceï¼Œå› æ­¤å®ƒè¿˜éœ€è¦ç®¡ç† Service çš„ç”Ÿå‘½å‘¨æœŸï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨å¯åŠ¨æ—¶è°ƒç”¨ Service ç»„ä»¶çš„å¯åŠ¨æ–¹æ³•ï¼Œåœ¨åœæ­¢æ—¶è°ƒç”¨å®ƒä»¬çš„åœæ­¢æ–¹æ³•ã€‚Server åœ¨å†…éƒ¨ç»´æŠ¤äº†è‹¥å¹² Service ç»„ä»¶ï¼Œå®ƒæ˜¯ä»¥æ•°ç»„æ¥ä¿å­˜çš„ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addService</span><span class="params">(Service service)</span> &#123;</span><br><span class="line"></span><br><span class="line">    service.setServer(<span class="built_in">this</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (servicesLock) &#123;</span><br><span class="line">        <span class="comment">// åˆ›å»ºä¸€ä¸ªé•¿åº¦ +1 çš„æ–°æ•°ç»„</span></span><br><span class="line">        Service results[] = <span class="keyword">new</span> <span class="title class_">Service</span>[services.length + <span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å°†è€çš„æ•°æ®å¤åˆ¶è¿‡å»</span></span><br><span class="line">        System.arraycopy(services, <span class="number">0</span>, results, <span class="number">0</span>, services.length);</span><br><span class="line">        results[services.length] = service;</span><br><span class="line">        services = results;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¯åŠ¨ Service ç»„ä»¶</span></span><br><span class="line">        <span class="keyword">if</span> (getState().isAvailable()) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                service.start();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (LifecycleException e) &#123;</span><br><span class="line">                <span class="comment">// Ignore</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è§¦å‘ç›‘å¬äº‹ä»¶</span></span><br><span class="line">        support.firePropertyChange(<span class="string">&quot;service&quot;</span>, <span class="literal">null</span>, service);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Server å¹¶æ²¡æœ‰ä¸€å¼€å§‹å°±åˆ†é…ä¸€ä¸ªå¾ˆé•¿çš„æ•°ç»„ï¼Œè€Œæ˜¯åœ¨æ·»åŠ çš„è¿‡ç¨‹ä¸­åŠ¨æ€åœ°æ‰©å±•æ•°ç»„é•¿åº¦ï¼Œå½“æ·»åŠ ä¸€ä¸ªæ–°çš„ Service å®ä¾‹æ—¶ï¼Œä¼šåˆ›å»ºä¸€ä¸ªæ–°æ•°ç»„å¹¶æŠŠåŸæ¥æ•°ç»„å†…å®¹å¤åˆ¶åˆ°æ–°æ•°ç»„ï¼Œè¿™æ ·åšçš„ç›®çš„å…¶å®æ˜¯ä¸ºäº†èŠ‚çœå†…å­˜ç©ºé—´ã€‚</p>
<p>é™¤æ­¤ä¹‹å¤–ï¼ŒServer ç»„ä»¶è¿˜æœ‰ä¸€ä¸ªé‡è¦çš„ä»»åŠ¡æ˜¯å¯åŠ¨ä¸€ä¸ª Socket æ¥ç›‘å¬åœæ­¢ç«¯å£ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆä½ èƒ½é€šè¿‡ shutdown å‘½ä»¤æ¥å…³é—­ Tomcatã€‚ä¸çŸ¥é“ä½ ç•™æ„åˆ°æ²¡æœ‰ï¼Œä¸Šé¢ Caralina çš„å¯åŠ¨æ–¹æ³•çš„æœ€åä¸€è¡Œä»£ç å°±æ˜¯è°ƒç”¨äº† Server çš„ await æ–¹æ³•ã€‚</p>
<p>åœ¨ await æ–¹æ³•é‡Œä¼šåˆ›å»ºä¸€ä¸ª Socket ç›‘å¬ 8005 ç«¯å£ï¼Œå¹¶åœ¨ä¸€ä¸ªæ­»å¾ªç¯é‡Œæ¥æ”¶ Socket ä¸Šçš„è¿æ¥è¯·æ±‚ï¼Œå¦‚æœæœ‰æ–°çš„è¿æ¥åˆ°æ¥å°±å»ºç«‹è¿æ¥ï¼Œç„¶åä» Socket ä¸­è¯»å–æ•°æ®ï¼›å¦‚æœè¯»åˆ°çš„æ•°æ®æ˜¯åœæ­¢å‘½ä»¤â€œSHUTDOWNâ€ï¼Œå°±é€€å‡ºå¾ªç¯ï¼Œè¿›å…¥ stop æµç¨‹ã€‚</p>
<h4 id="4-1-3-Service-ç»„ä»¶"><a href="#4-1-3-Service-ç»„ä»¶" class="headerlink" title="4.1.3. Service ç»„ä»¶"></a>4.1.3. Service ç»„ä»¶</h4><p>Service ç»„ä»¶çš„å…·ä½“å®ç°ç±»æ˜¯ StandardServiceã€‚</p>
<p>ã€æºç ã€‘StandardService æºç å®šä¹‰</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StandardService</span> <span class="keyword">extends</span> <span class="title class_">LifecycleBase</span> <span class="keyword">implements</span> <span class="title class_">Service</span> &#123;</span><br><span class="line">    <span class="comment">// åå­—</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Server å®ä¾‹</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Server</span> <span class="variable">server</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¿æ¥å™¨æ•°ç»„</span></span><br><span class="line">    <span class="keyword">protected</span> Connector connectors[] = <span class="keyword">new</span> <span class="title class_">Connector</span>[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">connectorsLock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¯¹åº”çš„ Engine å®¹å™¨</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Engine</span> <span class="variable">engine</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ˜ å°„å™¨åŠå…¶ç›‘å¬å™¨</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> <span class="type">Mapper</span> <span class="variable">mapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Mapper</span>();</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> <span class="type">MapperListener</span> <span class="variable">mapperListener</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MapperListener</span>(<span class="built_in">this</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>StandardService ç»§æ‰¿äº† LifecycleBase æŠ½è±¡ç±»ã€‚</p>
<p>StandardService ç»´æŠ¤äº†ä¸€ä¸ª MapperListener ç”¨äºæ”¯æŒ Tomcat çƒ­éƒ¨ç½²ã€‚å½“ Web åº”ç”¨çš„éƒ¨ç½²å‘ç”Ÿå˜åŒ–æ—¶ï¼ŒMapper ä¸­çš„æ˜ å°„ä¿¡æ¯ä¹Ÿè¦è·Ÿç€å˜åŒ–ï¼ŒMapperListener å°±æ˜¯ä¸€ä¸ªç›‘å¬å™¨ï¼Œå®ƒç›‘å¬å®¹å™¨çš„å˜åŒ–ï¼Œå¹¶æŠŠä¿¡æ¯æ›´æ–°åˆ° Mapper ä¸­ï¼Œè¿™æ˜¯å…¸å‹çš„è§‚å¯Ÿè€…æ¨¡å¼ã€‚</p>
<p>ä½œä¸ºâ€œç®¡ç†â€è§’è‰²çš„ç»„ä»¶ï¼Œæœ€é‡è¦çš„æ˜¯ç»´æŠ¤å…¶ä»–ç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸã€‚æ­¤å¤–åœ¨å¯åŠ¨å„ç§ç»„ä»¶æ—¶ï¼Œè¦æ³¨æ„å®ƒä»¬çš„ä¾èµ–å…³ç³»ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œè¦æ³¨æ„å¯åŠ¨çš„é¡ºåºã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">startInternal</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//1. è§¦å‘å¯åŠ¨ç›‘å¬å™¨</span></span><br><span class="line">    setState(LifecycleState.STARTING);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2. å…ˆå¯åŠ¨ Engineï¼ŒEngine ä¼šå¯åŠ¨å®ƒå­å®¹å™¨</span></span><br><span class="line">    <span class="keyword">if</span> (engine != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (engine) &#123;</span><br><span class="line">            engine.start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//3. å†å¯åŠ¨ Mapper ç›‘å¬å™¨</span></span><br><span class="line">    mapperListener.start();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//4. æœ€åå¯åŠ¨è¿æ¥å™¨ï¼Œè¿æ¥å™¨ä¼šå¯åŠ¨å®ƒå­ç»„ä»¶ï¼Œæ¯”å¦‚ Endpoint</span></span><br><span class="line">    <span class="keyword">synchronized</span> (connectorsLock) &#123;</span><br><span class="line">        <span class="keyword">for</span> (Connector connector: connectors) &#123;</span><br><span class="line">            <span class="keyword">if</span> (connector.getState() != LifecycleState.FAILED) &#123;</span><br><span class="line">                connector.start();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä»å¯åŠ¨æ–¹æ³•å¯ä»¥çœ‹åˆ°ï¼ŒService å…ˆå¯åŠ¨äº† Engine ç»„ä»¶ï¼Œå†å¯åŠ¨ Mapper ç›‘å¬å™¨ï¼Œæœ€åæ‰æ˜¯å¯åŠ¨è¿æ¥å™¨ã€‚è¿™å¾ˆå¥½ç†è§£ï¼Œå› ä¸ºå†…å±‚ç»„ä»¶å¯åŠ¨å¥½äº†æ‰èƒ½å¯¹å¤–æä¾›æœåŠ¡ï¼Œæ‰èƒ½å¯åŠ¨å¤–å±‚çš„è¿æ¥å™¨ç»„ä»¶ã€‚è€Œ Mapper ä¹Ÿä¾èµ–å®¹å™¨ç»„ä»¶ï¼Œå®¹å™¨ç»„ä»¶å¯åŠ¨å¥½äº†æ‰èƒ½ç›‘å¬å®ƒä»¬çš„å˜åŒ–ï¼Œå› æ­¤ Mapper å’Œ MapperListener åœ¨å®¹å™¨ç»„ä»¶ä¹‹åå¯åŠ¨ã€‚ç»„ä»¶åœæ­¢çš„é¡ºåºè·Ÿå¯åŠ¨é¡ºåºæ­£å¥½ç›¸åçš„ï¼Œä¹Ÿæ˜¯åŸºäºå®ƒä»¬çš„ä¾èµ–å…³ç³»ã€‚</p>
<h4 id="4-1-4-Engine-ç»„ä»¶"><a href="#4-1-4-Engine-ç»„ä»¶" class="headerlink" title="4.1.4. Engine ç»„ä»¶"></a>4.1.4. Engine ç»„ä»¶</h4><p>Engine æœ¬è´¨æ˜¯ä¸€ä¸ªå®¹å™¨ï¼Œå› æ­¤å®ƒç»§æ‰¿äº† ContainerBase åŸºç±»ï¼Œå¹¶ä¸”å®ç°äº† Engine æ¥å£ã€‚</p>
<h3 id="4-2-Web-åº”ç”¨çš„éƒ¨ç½²æ–¹å¼"><a href="#4-2-Web-åº”ç”¨çš„éƒ¨ç½²æ–¹å¼" class="headerlink" title="4.2. Web åº”ç”¨çš„éƒ¨ç½²æ–¹å¼"></a>4.2. Web åº”ç”¨çš„éƒ¨ç½²æ–¹å¼</h3><p>æ³¨ï¼šcatalina.homeï¼šå®‰è£…ç›®å½•;catalina.baseï¼šå·¥ä½œç›®å½•;é»˜è®¤å€¼ user.dir</p>
<ul>
<li>Server.xml é…ç½® Host å…ƒç´ ï¼ŒæŒ‡å®š appBase å±æ€§ï¼Œé»˜è®¤$catalina.base&#x2F;webapps&#x2F;</li>
<li>Server.xml é…ç½® Context å…ƒç´ ï¼ŒæŒ‡å®š docBaseï¼Œå…ƒç´ ï¼ŒæŒ‡å®š web åº”ç”¨çš„è·¯å¾„</li>
<li>è‡ªå®šä¹‰é…ç½®ï¼šåœ¨$catalina.base&#x2F;EngineName&#x2F;HostName&#x2F;XXX.xml é…ç½® Context å…ƒç´ </li>
</ul>
<p>HostConfig ç›‘å¬äº† StandardHost å®¹å™¨çš„äº‹ä»¶ï¼Œåœ¨ start æ–¹æ³•ä¸­è§£æä¸Šè¿°é…ç½®æ–‡ä»¶ï¼š</p>
<ul>
<li>æ‰«æ appbase è·¯å¾„ä¸‹çš„æ‰€æœ‰æ–‡ä»¶å¤¹å’Œ war åŒ…ï¼Œè§£æå„ä¸ªåº”ç”¨çš„ META-INF&#x2F;context.xmlï¼Œå¹¶ åˆ›å»º StandardContextï¼Œå¹¶å°† Context åŠ å…¥åˆ° Host çš„å­å®¹å™¨ä¸­ã€‚</li>
<li>è§£æ$catalina.base&#x2F;EngineName&#x2F;HostName&#x2F;ä¸‹çš„æ‰€æœ‰ Context é…ç½®ï¼Œæ‰¾åˆ°ç›¸åº” web åº” ç”¨çš„ä½ç½®ï¼Œè§£æå„ä¸ªåº”ç”¨çš„ META-INF&#x2F;context.xmlï¼Œå¹¶åˆ›å»º StandardContextï¼Œå¹¶å°† Context åŠ å…¥åˆ° Host çš„å­å®¹å™¨ä¸­ã€‚</li>
</ul>
<p>æ³¨ï¼š</p>
<ul>
<li>HostConfig å¹¶æ²¡æœ‰å®é™…è§£æ Context.xmlï¼Œè€Œæ˜¯åœ¨ ContextConfig ä¸­è¿›è¡Œçš„ã€‚</li>
<li>HostConfig ä¸­ä¼šå®šæœŸæ£€æŸ¥ watched èµ„æºæ–‡ä»¶(context.xml é…ç½®æ–‡ä»¶)</li>
</ul>
<p>ContextConfig è§£æ context.xml é¡ºåºï¼š</p>
<ul>
<li>å…ˆè§£æå…¨å±€çš„é…ç½® config&#x2F;context.xml</li>
<li>ç„¶åè§£æ Host çš„é»˜è®¤é…ç½® EngineName&#x2F;HostName&#x2F;context.xml.default</li>
<li>æœ€åè§£æåº”ç”¨çš„ META-INF&#x2F;context.xml</li>
</ul>
<p>ContextConfig è§£æ web.xml é¡ºåºï¼š</p>
<ul>
<li>å…ˆè§£æå…¨å±€çš„é…ç½® config&#x2F;web.xml</li>
<li>ç„¶åè§£æ Host çš„é»˜è®¤é…ç½® EngineName&#x2F;HostName&#x2F;web.xml.default æ¥ç€è§£æåº”ç”¨çš„ MEB-INF&#x2F;web.xml</li>
<li>æ‰«æåº”ç”¨ WEB-INF&#x2F;lib&#x2F;ä¸‹çš„ jar æ–‡ä»¶ï¼Œè§£æå…¶ä¸­çš„ META-INF&#x2F;web-fragment.xml æœ€ååˆå¹¶ xml å°è£…æˆ WebXmlï¼Œå¹¶è®¾ç½® Context</li>
</ul>
<p>æ³¨ï¼š</p>
<ul>
<li>æ‰«æ web åº”ç”¨å’Œ jar ä¸­çš„æ³¨è§£(Filterã€Listenerã€Servlet)å°±æ˜¯ä¸Šè¿°æ­¥éª¤ä¸­è¿›è¡Œçš„ã€‚</li>
<li>å®¹å™¨çš„å®šæœŸæ‰§è¡Œï¼šbackgroundProcessï¼Œç”± ContainerBase æ¥å®ç°çš„ï¼Œå¹¶ä¸”åªæœ‰åœ¨é¡¶å±‚å®¹å™¨ ä¸­æ‰ä¼šå¼€å¯çº¿ç¨‹ã€‚(backgroundProcessorDelay&#x3D;10 æ ‡å¿—ä½æ¥æ§åˆ¶)</li>
</ul>
<h3 id="4-3-LifeCycle"><a href="#4-3-LifeCycle" class="headerlink" title="4.3. LifeCycle"></a>4.3. LifeCycle</h3><p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/20201118105012.png" alt="img"></p>
<h4 id="4-3-1-è¯·æ±‚å¤„ç†è¿‡ç¨‹"><a href="#4-3-1-è¯·æ±‚å¤„ç†è¿‡ç¨‹" class="headerlink" title="4.3.1. è¯·æ±‚å¤„ç†è¿‡ç¨‹"></a>4.3.1. è¯·æ±‚å¤„ç†è¿‡ç¨‹</h4><div align="center">
<img src="https://raw.githubusercontent.com/dunwu/images/master/cs/java/javaweb/tools/tomcat/è¯·æ±‚å¤„ç†è¿‡ç¨‹.png" width="600">
</div>

<ol>
<li>æ ¹æ® server.xml é…ç½®çš„æŒ‡å®šçš„ connector ä»¥åŠç«¯å£ç›‘å¬ httpã€æˆ–è€… ajp è¯·æ±‚</li>
<li>è¯·æ±‚åˆ°æ¥æ—¶å»ºç«‹è¿æ¥,è§£æè¯·æ±‚å‚æ•°,åˆ›å»º Request å’Œ Response å¯¹è±¡,è°ƒç”¨é¡¶å±‚å®¹å™¨ pipeline çš„ invoke æ–¹æ³•</li>
<li>å®¹å™¨ä¹‹é—´å±‚å±‚è°ƒç”¨,æœ€ç»ˆè°ƒç”¨ä¸šåŠ¡ servlet çš„ service æ–¹æ³•</li>
<li>Connector å°† response æµä¸­çš„æ•°æ®å†™åˆ° socket ä¸­</li>
</ol>
<h3 id="4-4-Connector-æµç¨‹"><a href="#4-4-Connector-æµç¨‹" class="headerlink" title="4.4. Connector æµç¨‹"></a>4.4. Connector æµç¨‹</h3><div align="center">
<img src="https://raw.githubusercontent.com/dunwu/images/master/cs/java/javaweb/tools/tomcat/connector.png" width="600">
</div>

<h4 id="4-4-1-é˜»å¡-IO"><a href="#4-4-1-é˜»å¡-IO" class="headerlink" title="4.4.1. é˜»å¡ IO"></a>4.4.1. é˜»å¡ IO</h4><div align="center">
<img src="https://raw.githubusercontent.com/dunwu/images/master/cs/java/javaweb/tools/tomcat/é˜»å¡IO.png" width="600">
</div>

<h4 id="4-4-2-éé˜»å¡-IO"><a href="#4-4-2-éé˜»å¡-IO" class="headerlink" title="4.4.2. éé˜»å¡ IO"></a>4.4.2. éé˜»å¡ IO</h4><div align="center">
<img src="https://raw.githubusercontent.com/dunwu/images/master/cs/java/javaweb/tools/tomcat/éé˜»å¡IO.png" width="600">
</div>

<h4 id="4-4-3-IO-å¤šè·¯å¤ç”¨"><a href="#4-4-3-IO-å¤šè·¯å¤ç”¨" class="headerlink" title="4.4.3. IO å¤šè·¯å¤ç”¨"></a>4.4.3. IO å¤šè·¯å¤ç”¨</h4><div align="center">
<img src="https://raw.githubusercontent.com/dunwu/images/master/cs/java/javaweb/tools/tomcat/IOå¤šè·¯å¤ç”¨.png" width="600">
</div>

<p>é˜»å¡ä¸éé˜»å¡çš„åŒºåˆ«åœ¨äºè¿›è¡Œè¯»æ“ä½œå’Œå†™æ“ä½œçš„ç³»ç»Ÿè°ƒç”¨æ—¶ï¼Œå¦‚æœæ­¤æ—¶å†…æ ¸æ€æ²¡æœ‰æ•°æ®å¯è¯»æˆ–è€…æ²¡æœ‰ç¼“å†²ç©ºé—´å¯å†™æ—¶ï¼Œæ˜¯å¦é˜»å¡ã€‚</p>
<p>IO å¤šè·¯å¤ç”¨çš„å¥½å¤„åœ¨äºå¯åŒæ—¶ç›‘å¬å¤šä¸ª socket çš„å¯è¯»å’Œå¯å†™äº‹ä»¶ï¼Œè¿™æ ·å°±èƒ½ä½¿å¾—åº”ç”¨å¯ä»¥åŒæ—¶ç›‘å¬å¤šä¸ª socketï¼Œé‡Šæ”¾äº†åº”ç”¨çº¿ç¨‹èµ„æºã€‚</p>
<h4 id="4-4-4-Tomcat-å„ç±»-Connector-å¯¹æ¯”"><a href="#4-4-4-Tomcat-å„ç±»-Connector-å¯¹æ¯”" class="headerlink" title="4.4.4. Tomcat å„ç±» Connector å¯¹æ¯”"></a>4.4.4. Tomcat å„ç±» Connector å¯¹æ¯”</h4><div align="center">
<img src="https://raw.githubusercontent.com/dunwu/images/master/cs/java/javaweb/tools/tomcat/Tomcatå„ç±»Connectorå¯¹æ¯”.jpg" width="500">
</div>

<ul>
<li>JIOï¼šç”¨ java.io ç¼–å†™çš„ TCP æ¨¡å—ï¼Œé˜»å¡ IO</li>
<li>NIOï¼šç”¨ java.nio ç¼–å†™çš„ TCP æ¨¡å—ï¼Œéé˜»å¡ IOï¼Œï¼ˆIO å¤šè·¯å¤ç”¨ï¼‰</li>
<li>APRï¼šå…¨ç§° Apache Portable Runtimeï¼Œä½¿ç”¨ JNI çš„æ–¹å¼æ¥è¿›è¡Œè¯»å–æ–‡ä»¶ä»¥åŠè¿›è¡Œç½‘ç»œä¼ è¾“</li>
</ul>
<p>Apache Portable Runtime æ˜¯ä¸€ä¸ªé«˜åº¦å¯ç§»æ¤çš„åº“ï¼Œå®ƒæ˜¯ Apache HTTP Server 2.x çš„æ ¸å¿ƒã€‚ APR å…·æœ‰è®¸å¤šç”¨é€”ï¼ŒåŒ…æ‹¬è®¿é—®é«˜çº§ IO åŠŸèƒ½ï¼ˆå¦‚ sendfileï¼Œepoll å’Œ OpenSSLï¼‰ï¼Œæ“ä½œç³»ç»Ÿçº§åŠŸèƒ½ï¼ˆéšæœºæ•°ç”Ÿæˆï¼Œç³»ç»ŸçŠ¶æ€ç­‰ï¼‰å’Œæœ¬åœ°è¿›ç¨‹å¤„ç†ï¼ˆå…±äº«å†…å­˜ï¼ŒNT ç®¡é“å’Œ Unix å¥—æ¥å­—ï¼‰ã€‚</p>
<p>è¡¨æ ¼ä¸­å­—æ®µå«ä¹‰è¯´æ˜ï¼š</p>
<ul>
<li>Support Polling - æ˜¯å¦æ”¯æŒåŸºäº IO å¤šè·¯å¤ç”¨çš„ socket äº‹ä»¶è½®è¯¢</li>
<li>Polling Size - è½®è¯¢çš„æœ€å¤§è¿æ¥æ•°</li>
<li>Wait for next Request - åœ¨ç­‰å¾…ä¸‹ä¸€ä¸ªè¯·æ±‚æ—¶ï¼Œå¤„ç†çº¿ç¨‹æ˜¯å¦é‡Šæ”¾ï¼ŒBIO æ˜¯æ²¡æœ‰é‡Šæ”¾çš„ï¼Œæ‰€ä»¥åœ¨ keep-alive&#x3D;true çš„æƒ…å†µä¸‹å¤„ç†çš„å¹¶å‘è¿æ¥æ•°æœ‰é™</li>
<li>Read Request Headers - ç”±äº request header æ•°æ®è¾ƒå°‘ï¼Œå¯ä»¥ç”±å®¹å™¨æå‰è§£æå®Œæ¯•ï¼Œä¸éœ€è¦é˜»å¡</li>
<li>Read Request Body - è¯»å– request body çš„æ•°æ®æ˜¯åº”ç”¨ä¸šåŠ¡é€»è¾‘çš„äº‹æƒ…ï¼ŒåŒæ—¶ Servlet çš„é™åˆ¶ï¼Œæ˜¯éœ€è¦é˜»å¡è¯»å–çš„</li>
<li>Write Response - è·Ÿè¯»å– request body çš„é€»è¾‘ç±»ä¼¼ï¼ŒåŒæ ·éœ€è¦é˜»å¡å†™</li>
</ul>
<p><strong>NIO å¤„ç†ç›¸å…³ç±»</strong></p>
<div align="center">
<img src="https://raw.githubusercontent.com/dunwu/images/master/cs/java/javaweb/tools/tomcat/NIOå¤„ç†ç›¸å…³ç±».jpg" width="500">
</div>

<p>Poller çº¿ç¨‹ä» EventQueue è·å– PollerEventï¼Œå¹¶æ‰§è¡Œ PollerEvent çš„ run æ–¹æ³•ï¼Œè°ƒç”¨ Selector çš„ select æ–¹æ³•ï¼Œå¦‚æœæœ‰å¯è¯»çš„ Socket åˆ™åˆ›å»º Http11NioProcessorï¼Œæ”¾å…¥åˆ°çº¿ç¨‹æ± ä¸­æ‰§è¡Œï¼›</p>
<p>CoyoteAdapter æ˜¯ Connector åˆ° Container çš„é€‚é…å™¨ï¼ŒHttp11NioProcessor è°ƒç”¨å…¶æä¾›çš„ service æ–¹æ³•ï¼Œå†…éƒ¨åˆ›å»º Request å’Œ Response å¯¹è±¡ï¼Œå¹¶è°ƒç”¨æœ€é¡¶å±‚å®¹å™¨çš„ Pipeline ä¸­çš„ç¬¬ä¸€ä¸ª Valve çš„ invoke æ–¹æ³•</p>
<p>Mapper ä¸»è¦å¤„ç† http url åˆ° servlet çš„æ˜ å°„è§„åˆ™çš„è§£æï¼Œå¯¹å¤–æä¾› map æ–¹æ³•</p>
<h3 id="4-5-Comet"><a href="#4-5-Comet" class="headerlink" title="4.5. Comet"></a>4.5. Comet</h3><p>Comet æ˜¯ä¸€ç§ç”¨äº web çš„æ¨é€æŠ€æœ¯ï¼Œèƒ½ä½¿æœåŠ¡å™¨å®æ—¶åœ°å°†æ›´æ–°çš„ä¿¡æ¯ä¼ é€åˆ°å®¢æˆ·ç«¯ï¼Œè€Œæ— é¡»å®¢æˆ·ç«¯å‘å‡ºè¯·æ±‚<br>åœ¨ WebSocket å‡ºæ¥ä¹‹å‰ï¼Œå¦‚æœä¸é€‚ç”¨ cometï¼Œåªèƒ½é€šè¿‡æµè§ˆå™¨ç«¯è½®è¯¢ Server æ¥æ¨¡æ‹Ÿå®ç°æœåŠ¡å™¨ç«¯æ¨é€ã€‚<br>Comet æ”¯æŒ servlet å¼‚æ­¥å¤„ç† IOï¼Œå½“è¿æ¥ä¸Šæ•°æ®å¯è¯»æ—¶è§¦å‘äº‹ä»¶ï¼Œå¹¶å¼‚æ­¥å†™æ•°æ®(é˜»å¡)</p>
<p>Tomcat è¦å®ç° Cometï¼Œåªéœ€ç»§æ‰¿ HttpServlet åŒæ—¶ï¼Œå®ç° CometProcessor æ¥å£</p>
<ul>
<li>Beginï¼šæ–°çš„è¯·æ±‚è¿æ¥æ¥å…¥è°ƒç”¨ï¼Œå¯è¿›è¡Œä¸ Request å’Œ Response ç›¸å…³çš„å¯¹è±¡åˆå§‹åŒ–æ“ä½œï¼Œå¹¶ä¿å­˜ response å¯¹è±¡ï¼Œç”¨äºåç»­å†™å…¥æ•°æ®</li>
<li>Readï¼šè¯·æ±‚è¿æ¥æœ‰æ•°æ®å¯è¯»æ—¶è°ƒç”¨</li>
<li>Endï¼šå½“æ•°æ®å¯ç”¨æ—¶ï¼Œå¦‚æœè¯»å–åˆ°æ–‡ä»¶ç»“æŸæˆ–è€… response è¢«å…³é—­æ—¶åˆ™è¢«è°ƒç”¨</li>
<li>Errorï¼šåœ¨è¿æ¥ä¸Šå‘ç”Ÿå¼‚å¸¸æ—¶è°ƒç”¨ï¼Œæ•°æ®è¯»å–å¼‚å¸¸ã€è¿æ¥æ–­å¼€ã€å¤„ç†å¼‚å¸¸ã€socket è¶…æ—¶</li>
</ul>
<p>Noteï¼š</p>
<ul>
<li>Readï¼šåœ¨ post è¯·æ±‚æœ‰æ•°æ®ï¼Œä½†åœ¨ begin äº‹ä»¶ä¸­æ²¡æœ‰å¤„ç†ï¼Œåˆ™ä¼šè°ƒç”¨ readï¼Œå¦‚æœ read æ²¡æœ‰è¯»å–æ•°æ®ï¼Œåœ¨ä¼šè§¦å‘ Error å›è°ƒï¼Œå…³é—­ socket</li>
<li>Endï¼šå½“ socket è¶…æ—¶ï¼Œå¹¶ä¸” response è¢«å…³é—­æ—¶ä¹Ÿä¼šè°ƒç”¨ï¼›server è¢«å…³é—­æ—¶è°ƒç”¨</li>
<li>Errorï¼šé™¤äº† socket è¶…æ—¶ä¸ä¼šå…³é—­ socketï¼Œå…¶ä»–éƒ½ä¼šå…³é—­ socket</li>
<li>End å’Œ Error æ—¶é—´è§¦å‘æ—¶åº”å…³é—­å½“å‰ comet ä¼šè¯ï¼Œå³è°ƒç”¨ CometEvent çš„ close æ–¹æ³•<br>Noteï¼šåœ¨äº‹ä»¶è§¦å‘æ—¶è¦åšå¥½çº¿ç¨‹å®‰å…¨çš„æ“ä½œ</li>
</ul>
<h3 id="4-6-å¼‚æ­¥-Servlet"><a href="#4-6-å¼‚æ­¥-Servlet" class="headerlink" title="4.6. å¼‚æ­¥ Servlet"></a>4.6. å¼‚æ­¥ Servlet</h3><div align="center">
<img src="https://raw.githubusercontent.com/dunwu/images/master/cs/java/javaweb/tools/tomcat/ä¼ ç»ŸServletå¤„ç†æµç¨‹.png" >
</div>

<p>ä¼ ç»Ÿæµç¨‹ï¼š</p>
<ul>
<li>é¦–å…ˆï¼ŒServlet æ¥æ”¶åˆ°è¯·æ±‚ä¹‹åï¼Œrequest æ•°æ®è§£æï¼›</li>
<li>æ¥ç€ï¼Œè°ƒç”¨ä¸šåŠ¡æ¥å£çš„æŸäº›æ–¹æ³•ï¼Œä»¥å®Œæˆä¸šåŠ¡å¤„ç†ï¼›</li>
<li>æœ€åï¼Œæ ¹æ®å¤„ç†çš„ç»“æœæäº¤å“åº”ï¼ŒServlet çº¿ç¨‹ç»“æŸ</li>
</ul>
<div align="center">
<img src="https://raw.githubusercontent.com/dunwu/images/master/cs/java/javaweb/tools/tomcat/å¼‚æ­¥Servletå¤„ç†æµç¨‹.png" >
</div>

<p>å¼‚æ­¥å¤„ç†æµç¨‹ï¼š</p>
<ul>
<li>å®¢æˆ·ç«¯å‘é€ä¸€ä¸ªè¯·æ±‚</li>
<li>Servlet å®¹å™¨åˆ†é…ä¸€ä¸ªçº¿ç¨‹æ¥å¤„ç†å®¹å™¨ä¸­çš„ä¸€ä¸ª servlet</li>
<li>servlet è°ƒç”¨ request.startAsync()ï¼Œä¿å­˜ AsyncContext, ç„¶åè¿”å›</li>
<li>ä»»ä½•æ–¹å¼å­˜åœ¨çš„å®¹å™¨çº¿ç¨‹éƒ½å°†é€€å‡ºï¼Œä½†æ˜¯ response ä»ç„¶ä¿æŒå¼€æ”¾</li>
<li>ä¸šåŠ¡çº¿ç¨‹ä½¿ç”¨ä¿å­˜çš„ AsyncContext æ¥å®Œæˆå“åº”ï¼ˆçº¿ç¨‹æ± ï¼‰</li>
<li>å®¢æˆ·ç«¯æ”¶åˆ°å“åº”</li>
</ul>
<p>Servlet çº¿ç¨‹å°†è¯·æ±‚è½¬äº¤ç»™ä¸€ä¸ªå¼‚æ­¥çº¿ç¨‹æ¥æ‰§è¡Œä¸šåŠ¡å¤„ç†ï¼Œçº¿ç¨‹æœ¬èº«è¿”å›è‡³å®¹å™¨ï¼Œæ­¤æ—¶ Servlet è¿˜æ²¡æœ‰ç”Ÿæˆå“åº”æ•°æ®ï¼Œå¼‚æ­¥çº¿ç¨‹å¤„ç†å®Œä¸šåŠ¡ä»¥åï¼Œå¯ä»¥ç›´æ¥ç”Ÿæˆå“åº”æ•°æ®ï¼ˆå¼‚æ­¥çº¿ç¨‹æ‹¥æœ‰ ServletRequest å’Œ ServletResponse å¯¹è±¡çš„å¼•ç”¨ï¼‰</p>
<p><strong>ä¸ºä»€ä¹ˆ web åº”ç”¨ä¸­æ”¯æŒå¼‚æ­¥ï¼Ÿ</strong></p>
<p>æ¨å‡ºå¼‚æ­¥ï¼Œä¸»è¦æ˜¯é’ˆå¯¹é‚£äº›æ¯”è¾ƒè€—æ—¶çš„è¯·æ±‚ï¼šæ¯”å¦‚ä¸€æ¬¡ç¼“æ…¢çš„æ•°æ®åº“æŸ¥è¯¢ï¼Œä¸€æ¬¡å¤–éƒ¨ REST API è°ƒç”¨, æˆ–è€…æ˜¯å…¶ä»–ä¸€äº› I&#x2F;O å¯†é›†å‹æ“ä½œã€‚è¿™ç§è€—æ—¶çš„è¯·æ±‚ä¼šå¾ˆå¿«çš„è€—å…‰ Servlet å®¹å™¨çš„çº¿ç¨‹æ± ï¼Œç»§è€Œå½±å“å¯æ‰©å±•æ€§ã€‚</p>
<p>Noteï¼šä»å®¢æˆ·ç«¯çš„è§’åº¦æ¥çœ‹ï¼Œrequest ä»ç„¶åƒä»»ä½•å…¶ä»–çš„ HTTP çš„ request-response äº¤äº’ä¸€æ ·ï¼Œåªæ˜¯è€—è´¹äº†æ›´é•¿çš„æ—¶é—´è€Œå·²</p>
<p><strong>å¼‚æ­¥äº‹ä»¶ç›‘å¬</strong></p>
<ul>
<li>onStartAsyncï¼šRequest è°ƒç”¨ startAsync æ–¹æ³•æ—¶è§¦å‘</li>
<li>onCompleteï¼šsyncContext è°ƒç”¨ complete æ–¹æ³•æ—¶è§¦å‘</li>
<li>onErrorï¼šå¤„ç†è¯·æ±‚çš„è¿‡ç¨‹å‡ºç°å¼‚å¸¸æ—¶è§¦å‘</li>
<li>onTimeoutï¼šsocket è¶…æ—¶è§¦å‘</li>
</ul>
<p>Note :<br>onError&#x2F; onTimeout è§¦å‘åï¼Œä¼šç´§æ¥ç€å›è°ƒ onComplete<br>onComplete æ‰§è¡Œåï¼Œå°±ä¸å¯å†æ“ä½œ request å’Œ response</p>
<h2 id="5-å‚è€ƒèµ„æ–™"><a href="#5-å‚è€ƒèµ„æ–™" class="headerlink" title="5. å‚è€ƒèµ„æ–™"></a>5. å‚è€ƒèµ„æ–™</h2><ul>
<li><p><strong>å®˜æ–¹</strong></p>
<ul>
<li><a target="_blank" rel="noopener" href="http://tomcat.apache.org/">Tomcat å®˜æ–¹ç½‘ç«™</a></li>
<li><a target="_blank" rel="noopener" href="http://wiki.apache.org/tomcat/FrontPage">Tomcat Wiki</a></li>
<li><a target="_blank" rel="noopener" href="http://tomee.apache.org/">Tomee å®˜æ–¹ç½‘ç«™</a></li>
</ul>
</li>
<li><p><strong>æ–‡ç« </strong></p>
<ul>
<li><a target="_blank" rel="noopener" href="http://www.oracle.com/webfolder/technetwork/tutorials/obe/java/basic_app_embedded_tomcat/basic_app-tomcat-embedded.html">Creating a Web App with Bootstrap and Tomcat Embedded</a></li>
<li><a target="_blank" rel="noopener" href="https://juejin.im/post/58eb5fdda0bb9f00692a78fc">Tomcat ç»„æˆä¸å·¥ä½œåŸç†</a></li>
<li><a target="_blank" rel="noopener" href="https://www.ibm.com/developerworks/cn/java/j-lo-tomcat1/index.html">Tomcat å·¥ä½œåŸç†</a></li>
<li><a target="_blank" rel="noopener" href="https://www.ibm.com/developerworks/cn/java/j-lo-tomcat2/index.html?ca=drs-">Tomcat è®¾è®¡æ¨¡å¼åˆ†æ</a></li>
</ul>
</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://dunwu.github.io/blog/pages/b3690c15/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/uploads/avatar.gif">
      <meta itemprop="name" content="é’æ‚Ÿ â—¾ Dunwu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dunwu Blog">
      <meta itemprop="description" content="é’æ‚Ÿçš„ä¸ªäººåšå®¢">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Dunwu Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/pages/b3690c15/" class="post-title-link" itemprop="url">Tomcatè¿æ¥å™¨</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2022-02-17 22:34:30" itemprop="dateCreated datePublished" datetime="2022-02-17T22:34:30+08:00">2022-02-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">æ›´æ–°äº</span>
      <time title="ä¿®æ”¹æ—¶é—´ï¼š2025-09-13 17:56:53" itemprop="dateModified" datetime="2025-09-13T17:56:53+08:00">2025-09-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
        </span>
          ï¼Œ
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/JavaEE/" itemprop="url" rel="index"><span itemprop="name">JavaEE</span></a>
        </span>
          ï¼Œ
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/JavaEE/%E6%9C%8D%E5%8A%A1%E5%99%A8/" itemprop="url" rel="index"><span itemprop="name">æœåŠ¡å™¨</span></a>
        </span>
          ï¼Œ
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/JavaEE/%E6%9C%8D%E5%8A%A1%E5%99%A8/Tomcat/" itemprop="url" rel="index"><span itemprop="name">Tomcat</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
      <span>18k</span>
    </span>
    <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
      <span>16 åˆ†é’Ÿ</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Tomcat-è¿æ¥å™¨"><a href="#Tomcat-è¿æ¥å™¨" class="headerlink" title="Tomcat è¿æ¥å™¨"></a>Tomcat è¿æ¥å™¨</h1><h2 id="1-NioEndpoint-ç»„ä»¶"><a href="#1-NioEndpoint-ç»„ä»¶" class="headerlink" title="1. NioEndpoint ç»„ä»¶"></a>1. NioEndpoint ç»„ä»¶</h2><p>Tomcat çš„ NioEndPoint ç»„ä»¶åˆ©ç”¨ Java NIO å®ç°äº† I&#x2F;O å¤šè·¯å¤ç”¨æ¨¡å‹ã€‚</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/20201127094302.jpg" alt="img"></p>
<p>NioEndPoint å­ç»„ä»¶åŠŸèƒ½ç®€ä»‹ï¼š</p>
<ul>
<li><code>LimitLatch</code> æ˜¯è¿æ¥æ§åˆ¶å™¨ï¼Œè´Ÿè´£æ§åˆ¶æœ€å¤§è¿æ¥æ•°ã€‚NIO æ¨¡å¼ä¸‹é»˜è®¤æ˜¯ 10000ï¼Œè¾¾åˆ°è¿™ä¸ªé˜ˆå€¼åï¼Œè¿æ¥è¯·æ±‚è¢«æ‹’ç»ã€‚</li>
<li><code>Acceptor</code> è´Ÿè´£ç›‘å¬è¿æ¥è¯·æ±‚ã€‚<code>Acceptor</code> è¿è¡Œåœ¨ä¸€ä¸ªå•ç‹¬çš„çº¿ç¨‹é‡Œï¼Œå®ƒåœ¨ä¸€ä¸ªæ­»å¾ªç¯é‡Œè°ƒç”¨ accept æ–¹æ³•æ¥æ¥æ”¶æ–°è¿æ¥ï¼Œä¸€æ—¦æœ‰æ–°çš„è¿æ¥è¯·æ±‚åˆ°æ¥ï¼Œaccept æ–¹æ³•è¿”å›ä¸€ä¸ª <code>Channel</code> å¯¹è±¡ï¼Œæ¥ç€æŠŠ <code>Channel</code> å¯¹è±¡äº¤ç»™ <code>Poller</code> å»å¤„ç†ã€‚</li>
<li><code>Poller</code> çš„æœ¬è´¨æ˜¯ä¸€ä¸ª <code>Selector</code>ï¼Œä¹Ÿè¿è¡Œåœ¨å•ç‹¬çº¿ç¨‹é‡Œã€‚<code>Poller</code> å†…éƒ¨ç»´æŠ¤ä¸€ä¸ª <code>Channel</code> æ•°ç»„ï¼Œå®ƒåœ¨ä¸€ä¸ªæ­»å¾ªç¯é‡Œä¸æ–­æ£€æµ‹ <code>Channel</code> çš„æ•°æ®å°±ç»ªçŠ¶æ€ï¼Œä¸€æ—¦æœ‰ <code>Channel</code> å¯è¯»ï¼Œå°±ç”Ÿæˆä¸€ä¸ª <code>SocketProcessor</code> ä»»åŠ¡å¯¹è±¡æ‰”ç»™ <code>Executor</code> å»å¤„ç†ã€‚</li>
<li><code>Executor</code> å°±æ˜¯çº¿ç¨‹æ± ï¼Œè´Ÿè´£è¿è¡Œ <code>SocketProcessor</code> ä»»åŠ¡ç±»ï¼Œ<code>SocketProcessor</code> çš„ run æ–¹æ³•ä¼šè°ƒç”¨ <code>Http11Processor</code> æ¥è¯»å–å’Œè§£æè¯·æ±‚æ•°æ®ã€‚æˆ‘ä»¬çŸ¥é“ï¼Œ<code>Http11Processor</code> æ˜¯åº”ç”¨å±‚åè®®çš„å°è£…ï¼Œå®ƒä¼šè°ƒç”¨å®¹å™¨è·å¾—å“åº”ï¼Œå†æŠŠå“åº”é€šè¿‡ <code>Channel</code> å†™å‡ºã€‚</li>
</ul>
<p>NioEndpoint å¦‚ä½•å®ç°é«˜å¹¶å‘çš„å‘¢ï¼Ÿ</p>
<p>è¦å®ç°é«˜å¹¶å‘éœ€è¦åˆç†è®¾è®¡çº¿ç¨‹æ¨¡å‹å……åˆ†åˆ©ç”¨ CPU èµ„æºï¼Œå°½é‡ä¸è¦è®©çº¿ç¨‹é˜»å¡ï¼›å¦å¤–ï¼Œå°±æ˜¯æœ‰å¤šå°‘ä»»åŠ¡ï¼Œå°±ç”¨ç›¸åº”è§„æ¨¡çš„çº¿ç¨‹æ•°å»å¤„ç†ã€‚</p>
<p>NioEndpoint è¦å®Œæˆä¸‰ä»¶äº‹æƒ…ï¼šæ¥æ”¶è¿æ¥ã€æ£€æµ‹ I&#x2F;O äº‹ä»¶ä»¥åŠå¤„ç†è¯·æ±‚ï¼Œé‚£ä¹ˆæœ€æ ¸å¿ƒçš„å°±æ˜¯æŠŠè¿™ä¸‰ä»¶äº‹æƒ…åˆ†å¼€ï¼Œç”¨ä¸åŒè§„æ¨¡çš„çº¿ç¨‹å»å¤„ç†ï¼Œæ¯”å¦‚ç”¨ä¸“é—¨çš„çº¿ç¨‹ç»„å»è·‘ Acceptorï¼Œå¹¶ä¸” Acceptor çš„ä¸ªæ•°å¯ä»¥é…ç½®ï¼›ç”¨ä¸“é—¨çš„çº¿ç¨‹ç»„å»è·‘ Pollerï¼ŒPoller çš„ä¸ªæ•°ä¹Ÿå¯ä»¥é…ç½®ï¼›æœ€åå…·ä½“ä»»åŠ¡çš„æ‰§è¡Œä¹Ÿç”±ä¸“é—¨çš„çº¿ç¨‹æ± æ¥å¤„ç†ï¼Œä¹Ÿå¯ä»¥é…ç½®çº¿ç¨‹æ± çš„å¤§å°ã€‚</p>
<h3 id="1-1-LimitLatch"><a href="#1-1-LimitLatch" class="headerlink" title="1.1. LimitLatch"></a>1.1. LimitLatch</h3><p><code>LimitLatch</code> ç”¨æ¥æ§åˆ¶è¿æ¥ä¸ªæ•°ï¼Œå½“è¿æ¥æ•°åˆ°è¾¾æœ€å¤§æ—¶é˜»å¡çº¿ç¨‹ï¼Œç›´åˆ°åç»­ç»„ä»¶å¤„ç†å®Œä¸€ä¸ªè¿æ¥åå°†è¿æ¥æ•°å‡ 1ã€‚è¯·ä½ æ³¨æ„åˆ°è¾¾æœ€å¤§è¿æ¥æ•°åæ“ä½œç³»ç»Ÿåº•å±‚è¿˜æ˜¯ä¼šæ¥æ”¶å®¢æˆ·ç«¯è¿æ¥ï¼Œä½†ç”¨æˆ·å±‚å·²ç»ä¸å†æ¥æ”¶ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LimitLatch</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">Sync</span> <span class="keyword">extends</span> <span class="title class_">AbstractQueuedSynchronizer</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">protected</span> <span class="type">int</span> <span class="title function_">tryAcquireShared</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="type">long</span> <span class="variable">newCount</span> <span class="operator">=</span> count.incrementAndGet();</span><br><span class="line">            <span class="keyword">if</span> (newCount &gt; limit) &#123;</span><br><span class="line">                count.decrementAndGet();</span><br><span class="line">                <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">tryReleaseShared</span><span class="params">(<span class="type">int</span> arg)</span> &#123;</span><br><span class="line">            count.decrementAndGet();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Sync sync;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AtomicLong count;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">long</span> limit;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// çº¿ç¨‹è°ƒç”¨è¿™ä¸ªæ–¹æ³•æ¥è·å¾—æ¥æ”¶æ–°è¿æ¥çš„è®¸å¯ï¼Œçº¿ç¨‹å¯èƒ½è¢«é˜»å¡</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">countUpOrAwait</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">      sync.acquireSharedInterruptibly(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è°ƒç”¨è¿™ä¸ªæ–¹æ³•æ¥é‡Šæ”¾ä¸€ä¸ªè¿æ¥è®¸å¯ï¼Œé‚£ä¹ˆå‰é¢é˜»å¡çš„çº¿ç¨‹å¯èƒ½è¢«å”¤é†’</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">countDown</span><span class="params">()</span> &#123;</span><br><span class="line">      sync.releaseShared(<span class="number">0</span>);</span><br><span class="line">      <span class="type">long</span> <span class="variable">result</span> <span class="operator">=</span> getCount();</span><br><span class="line">      <span class="keyword">return</span> result;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>LimitLatch å†…æ­¥å®šä¹‰äº†å†…éƒ¨ç±» Syncï¼Œè€Œ Sync æ‰©å±•äº† AQSï¼ŒAQS æ˜¯ Java å¹¶å‘åŒ…ä¸­çš„ä¸€ä¸ªæ ¸å¿ƒç±»ï¼Œå®ƒåœ¨å†…éƒ¨ç»´æŠ¤ä¸€ä¸ªçŠ¶æ€å’Œä¸€ä¸ªçº¿ç¨‹é˜Ÿåˆ—ï¼Œå¯ä»¥ç”¨æ¥<strong>æ§åˆ¶çº¿ç¨‹ä»€ä¹ˆæ—¶å€™æŒ‚èµ·ï¼Œä»€ä¹ˆæ—¶å€™å”¤é†’</strong>ã€‚æˆ‘ä»¬å¯ä»¥æ‰©å±•å®ƒæ¥å®ç°è‡ªå·±çš„åŒæ­¥å™¨ï¼Œå®é™…ä¸Š Java å¹¶å‘åŒ…é‡Œçš„é”å’Œæ¡ä»¶å˜é‡ç­‰ç­‰éƒ½æ˜¯é€šè¿‡ AQS æ¥å®ç°çš„ï¼Œè€Œè¿™é‡Œçš„ LimitLatch ä¹Ÿä¸ä¾‹å¤–ã€‚</p>
<p>ç†è§£æºç è¦ç‚¹ï¼š</p>
<ul>
<li>ç”¨æˆ·çº¿ç¨‹é€šè¿‡è°ƒç”¨ LimitLatch çš„ countUpOrAwait æ–¹æ³•æ¥æ‹¿åˆ°é”ï¼Œå¦‚æœæš‚æ—¶æ— æ³•è·å–ï¼Œè¿™ä¸ªçº¿ç¨‹ä¼šè¢«é˜»å¡åˆ° AQS çš„é˜Ÿåˆ—ä¸­ã€‚é‚£ AQS æ€ä¹ˆçŸ¥é“æ˜¯é˜»å¡è¿˜æ˜¯ä¸é˜»å¡ç”¨æˆ·çº¿ç¨‹å‘¢ï¼Ÿå…¶å®è¿™æ˜¯ç”± AQS çš„ä½¿ç”¨è€…æ¥å†³å®šçš„ï¼Œä¹Ÿå°±æ˜¯å†…éƒ¨ç±» Sync æ¥å†³å®šçš„ï¼Œå› ä¸º Sync ç±»é‡å†™äº† AQS çš„<strong>tryAcquireShared() æ–¹æ³•</strong>ã€‚å®ƒçš„å®ç°é€»è¾‘æ˜¯å¦‚æœå½“å‰è¿æ¥æ•° count å°äº limitï¼Œçº¿ç¨‹èƒ½è·å–é”ï¼Œè¿”å› 1ï¼Œå¦åˆ™è¿”å› -1ã€‚</li>
<li>å¦‚ä½•ç”¨æˆ·çº¿ç¨‹è¢«é˜»å¡åˆ°äº† AQS çš„é˜Ÿåˆ—ï¼Œé‚£ä»€ä¹ˆæ—¶å€™å”¤é†’å‘¢ï¼ŸåŒæ ·æ˜¯ç”± Sync å†…éƒ¨ç±»å†³å®šï¼ŒSync é‡å†™äº† AQS çš„<strong>releaseShared() æ–¹æ³•</strong>ï¼Œå…¶å®å°±æ˜¯å½“ä¸€ä¸ªè¿æ¥è¯·æ±‚å¤„ç†å®Œäº†ï¼Œè¿™æ—¶åˆå¯ä»¥æ¥æ”¶ä¸€ä¸ªæ–°è¿æ¥äº†ï¼Œè¿™æ ·å‰é¢é˜»å¡çš„çº¿ç¨‹å°†ä¼šè¢«å”¤é†’ã€‚</li>
</ul>
<h3 id="1-2-Acceptor"><a href="#1-2-Acceptor" class="headerlink" title="1.2. Acceptor"></a>1.2. Acceptor</h3><p>Acceptor å®ç°äº† Runnable æ¥å£ï¼Œå› æ­¤å¯ä»¥è·‘åœ¨å•ç‹¬çº¿ç¨‹é‡Œã€‚ä¸€ä¸ªç«¯å£å·åªèƒ½å¯¹åº”ä¸€ä¸ª ServerSocketChannelï¼Œå› æ­¤è¿™ä¸ª ServerSocketChannel æ˜¯åœ¨å¤šä¸ª Acceptor çº¿ç¨‹ä¹‹é—´å…±äº«çš„ï¼Œå®ƒæ˜¯ Endpoint çš„å±æ€§ï¼Œç”± Endpoint å®Œæˆåˆå§‹åŒ–å’Œç«¯å£ç»‘å®šã€‚</p>
<figure class="highlight nim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">serverSock = <span class="type">ServerSocketChannel</span>.open();</span><br><span class="line">serverSock.socket().<span class="keyword">bind</span>(<span class="keyword">addr</span>,getAcceptCount());</span><br><span class="line">serverSock.configureBlocking(<span class="literal">true</span>);</span><br></pre></td></tr></table></figure>

<ul>
<li>bind æ–¹æ³•çš„ç¬¬äºŒä¸ªå‚æ•°è¡¨ç¤ºæ“ä½œç³»ç»Ÿçš„ç­‰å¾…é˜Ÿåˆ—é•¿åº¦ï¼Œæˆ‘åœ¨ä¸Šé¢æåˆ°ï¼Œå½“åº”ç”¨å±‚é¢çš„è¿æ¥æ•°åˆ°è¾¾æœ€å¤§å€¼æ—¶ï¼Œæ“ä½œç³»ç»Ÿå¯ä»¥ç»§ç»­æ¥æ”¶è¿æ¥ï¼Œé‚£ä¹ˆæ“ä½œç³»ç»Ÿèƒ½ç»§ç»­æ¥æ”¶çš„æœ€å¤§è¿æ¥æ•°å°±æ˜¯è¿™ä¸ªé˜Ÿåˆ—é•¿åº¦ï¼Œå¯ä»¥é€šè¿‡ acceptCount å‚æ•°é…ç½®ï¼Œé»˜è®¤æ˜¯ 100ã€‚</li>
<li>ServerSocketChannel è¢«è®¾ç½®æˆé˜»å¡æ¨¡å¼ï¼Œä¹Ÿå°±æ˜¯è¯´å®ƒæ˜¯ä»¥é˜»å¡çš„æ–¹å¼æ¥æ”¶è¿æ¥çš„ã€‚ServerSocketChannel é€šè¿‡ accept() æ¥å—æ–°çš„è¿æ¥ï¼Œaccept() æ–¹æ³•è¿”å›è·å¾— SocketChannel å¯¹è±¡ï¼Œç„¶åå°† SocketChannel å¯¹è±¡å°è£…åœ¨ä¸€ä¸ª PollerEvent å¯¹è±¡ä¸­ï¼Œå¹¶å°† PollerEvent å¯¹è±¡å‹å…¥ Poller çš„ Queue é‡Œï¼Œè¿™æ˜¯ä¸ªå…¸å‹çš„ç”Ÿäº§è€… - æ¶ˆè´¹è€…æ¨¡å¼ï¼ŒAcceptor ä¸ Poller çº¿ç¨‹ä¹‹é—´é€šè¿‡ Queue é€šä¿¡ã€‚</li>
</ul>
<h3 id="1-3-Poller"><a href="#1-3-Poller" class="headerlink" title="1.3. Poller"></a>1.3. Poller</h3><p><code>Poller</code> æœ¬è´¨æ˜¯ä¸€ä¸ª <code>Selector</code>ï¼Œå®ƒå†…éƒ¨ç»´æŠ¤ä¸€ä¸ª <code>Queue</code>ã€‚</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">SynchronizedQueue</span>&lt;<span class="type">PollerEvent</span>&gt; events <span class="operator">=</span> new <span class="type">SynchronizedQueue</span>&lt;&gt;();</span><br></pre></td></tr></table></figure>

<p><code>SynchronizedQueue</code> çš„æ ¸å¿ƒæ–¹æ³•éƒ½ä½¿ç”¨äº† <code>Synchronized</code> å…³é”®å­—è¿›è¡Œä¿®é¥°ï¼Œç”¨æ¥ä¿è¯åŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªçº¿ç¨‹è¿›è¡Œè¯»å†™ã€‚</p>
<p>ä½¿ç”¨ <code>SynchronizedQueue</code>ï¼Œæ„å‘³ç€åŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ª <code>Acceptor</code> çº¿ç¨‹å¯¹é˜Ÿåˆ—è¿›è¡Œè¯»å†™ï¼›åŒæ—¶æœ‰å¤šä¸ª <code>Poller</code> çº¿ç¨‹åœ¨è¿è¡Œï¼Œæ¯ä¸ª <code>Poller</code> çº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„é˜Ÿåˆ—ã€‚æ¯ä¸ª <code>Poller</code> çº¿ç¨‹å¯èƒ½åŒæ—¶è¢«å¤šä¸ª <code>Acceptor</code> çº¿ç¨‹è°ƒç”¨æ¥æ³¨å†Œ <code>PollerEvent</code>ã€‚åŒæ · <code>Poller</code> çš„ä¸ªæ•°å¯ä»¥é€šè¿‡ pollers å‚æ•°é…ç½®ã€‚</p>
<p><code>Poller</code> ä¸æ–­çš„é€šè¿‡å†…éƒ¨çš„ <code>Selector</code> å¯¹è±¡å‘å†…æ ¸æŸ¥è¯¢ <code>Channel</code> çš„çŠ¶æ€ï¼Œä¸€æ—¦å¯è¯»å°±ç”Ÿæˆä»»åŠ¡ç±» <code>SocketProcessor</code> äº¤ç»™ <code>Executor</code> å»å¤„ç†ã€‚<code>Poller</code> çš„å¦ä¸€ä¸ªé‡è¦ä»»åŠ¡æ˜¯å¾ªç¯éå†æ£€æŸ¥è‡ªå·±æ‰€ç®¡ç†çš„ <code>SocketChannel</code> æ˜¯å¦å·²ç»è¶…æ—¶ï¼Œå¦‚æœæœ‰è¶…æ—¶å°±å…³é—­è¿™ä¸ª <code>SocketChannel</code>ã€‚</p>
<h3 id="1-4-SocketProcessor"><a href="#1-4-SocketProcessor" class="headerlink" title="1.4. SocketProcessor"></a>1.4. SocketProcessor</h3><p>æˆ‘ä»¬çŸ¥é“ï¼Œ<code>Poller</code> ä¼šåˆ›å»º <code>SocketProcessor</code> ä»»åŠ¡ç±»äº¤ç»™çº¿ç¨‹æ± å¤„ç†ï¼Œè€Œ <code>SocketProcessor</code> å®ç°äº† <code>Runnable</code> æ¥å£ï¼Œç”¨æ¥å®šä¹‰ <code>Executor</code> ä¸­çº¿ç¨‹æ‰€æ‰§è¡Œçš„ä»»åŠ¡ï¼Œä¸»è¦å°±æ˜¯è°ƒç”¨ <code>Http11Processor</code> ç»„ä»¶æ¥å¤„ç†è¯·æ±‚ã€‚<code>Http11Processor</code> è¯»å– <code>Channel</code> çš„æ•°æ®æ¥ç”Ÿæˆ <code>ServletRequest</code> å¯¹è±¡ï¼Œè¿™é‡Œè¯·ä½ æ³¨æ„ï¼š</p>
<p><code>Http11Processor</code> å¹¶ä¸æ˜¯ç›´æ¥è¯»å– <code>Channel</code> çš„ã€‚è¿™æ˜¯å› ä¸º Tomcat æ”¯æŒåŒæ­¥éé˜»å¡ I&#x2F;O æ¨¡å‹å’Œå¼‚æ­¥ I&#x2F;O æ¨¡å‹ï¼Œåœ¨ Java API ä¸­ï¼Œç›¸åº”çš„ Channel ç±»ä¹Ÿæ˜¯ä¸ä¸€æ ·çš„ï¼Œæ¯”å¦‚æœ‰ <code>AsynchronousSocketChannel</code> å’Œ <code>SocketChannel</code>ï¼Œä¸ºäº†å¯¹ <code>Http11Processor</code> å±è”½è¿™äº›å·®å¼‚ï¼ŒTomcat è®¾è®¡äº†ä¸€ä¸ªåŒ…è£…ç±»å«ä½œ <code>SocketWrapper</code>ï¼Œ<code>Http11Processor</code> åªè°ƒç”¨ <code>SocketWrapper</code> çš„æ–¹æ³•å»è¯»å†™æ•°æ®ã€‚</p>
<h2 id="2-Nio2Endpoint-ç»„ä»¶"><a href="#2-Nio2Endpoint-ç»„ä»¶" class="headerlink" title="2. Nio2Endpoint ç»„ä»¶"></a>2. Nio2Endpoint ç»„ä»¶</h2><p>Nio2Endpoint å·¥ä½œæµç¨‹è·Ÿ NioEndpoint è¾ƒä¸ºç›¸ä¼¼ã€‚</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/20201127143839.jpg" alt="img"></p>
<p>Nio2Endpoint å­ç»„ä»¶åŠŸèƒ½è¯´æ˜ï¼š</p>
<ul>
<li><code>LimitLatch</code> æ˜¯è¿æ¥æ§åˆ¶å™¨ï¼Œå®ƒè´Ÿè´£æ§åˆ¶æœ€å¤§è¿æ¥æ•°ã€‚</li>
<li><code>Nio2Acceptor</code> æ‰©å±•äº† <code>Acceptor</code>ï¼Œç”¨å¼‚æ­¥ I&#x2F;O çš„æ–¹å¼æ¥æ¥æ”¶è¿æ¥ï¼Œè·‘åœ¨ä¸€ä¸ªå•ç‹¬çš„çº¿ç¨‹é‡Œï¼Œä¹Ÿæ˜¯ä¸€ä¸ªçº¿ç¨‹ç»„ã€‚<code>Nio2Acceptor</code> æ¥æ”¶æ–°çš„è¿æ¥åï¼Œå¾—åˆ°ä¸€ä¸ª <code>AsynchronousSocketChannel</code>ï¼Œ<code>Nio2Acceptor</code> æŠŠ <code>AsynchronousSocketChannel</code> å°è£…æˆä¸€ä¸ª <code>Nio2SocketWrapper</code>ï¼Œå¹¶åˆ›å»ºä¸€ä¸ª <code>SocketProcessor</code> ä»»åŠ¡ç±»äº¤ç»™çº¿ç¨‹æ± å¤„ç†ï¼Œå¹¶ä¸” <code>SocketProcessor</code> æŒæœ‰ <code>Nio2SocketWrapper</code> å¯¹è±¡ã€‚</li>
<li><code>Executor</code> åœ¨æ‰§è¡Œ <code>SocketProcessor</code> æ—¶ï¼Œ<code>SocketProcessor</code> çš„ run æ–¹æ³•ä¼šè°ƒç”¨ <code>Http11Processor</code> æ¥å¤„ç†è¯·æ±‚ï¼Œ<code>Http11Processor</code> ä¼šé€šè¿‡ <code>Nio2SocketWrapper</code> è¯»å–å’Œè§£æè¯·æ±‚æ•°æ®ï¼Œè¯·æ±‚ç»è¿‡å®¹å™¨å¤„ç†åï¼Œå†æŠŠå“åº”é€šè¿‡ <code>Nio2SocketWrapper</code> å†™å‡ºã€‚</li>
</ul>
<p>Nio2Endpoint è·Ÿ NioEndpoint çš„ä¸€ä¸ªæ˜æ˜¾ä¸åŒç‚¹æ˜¯ï¼Œ<strong>Nio2Endpoint ä¸­æ²¡æœ‰ Poller ç»„ä»¶ï¼Œä¹Ÿå°±æ˜¯æ²¡æœ‰ Selectorã€‚è¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿå› ä¸ºåœ¨å¼‚æ­¥ I&#x2F;O æ¨¡å¼ä¸‹ï¼ŒSelector çš„å·¥ä½œäº¤ç»™å†…æ ¸æ¥åšäº†ã€‚</strong></p>
<h3 id="2-1-Nio2Acceptor"><a href="#2-1-Nio2Acceptor" class="headerlink" title="2.1. Nio2Acceptor"></a>2.1. Nio2Acceptor</h3><p>å’Œ <code>NioEndpint</code> ä¸€æ ·ï¼Œ<code>Nio2Endpoint</code> çš„åŸºæœ¬æ€è·¯æ˜¯ç”¨ <code>LimitLatch</code> ç»„ä»¶æ¥æ§åˆ¶è¿æ¥æ•°ã€‚</p>
<p>ä½†æ˜¯ <code>Nio2Acceptor</code> çš„ç›‘å¬è¿æ¥çš„è¿‡ç¨‹ä¸æ˜¯åœ¨ä¸€ä¸ªæ­»å¾ªç¯é‡Œä¸æ–­çš„è°ƒ accept æ–¹æ³•ï¼Œè€Œæ˜¯é€šè¿‡å›è°ƒå‡½æ•°æ¥å®Œæˆçš„ã€‚æˆ‘ä»¬æ¥çœ‹çœ‹å®ƒçš„è¿æ¥ç›‘å¬æ–¹æ³•ï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">serverSock.accept(<span class="literal">null</span>, <span class="keyword">this</span>);</span><br></pre></td></tr></table></figure>

<p>å…¶å®å°±æ˜¯è°ƒç”¨äº† accept æ–¹æ³•ï¼Œæ³¨æ„å®ƒçš„ç¬¬äºŒä¸ªå‚æ•°æ˜¯ thisï¼Œè¡¨æ˜ <code>Nio2Acceptor</code> è‡ªå·±å°±æ˜¯å¤„ç†è¿æ¥çš„å›è°ƒç±»ï¼Œå› æ­¤ <code>Nio2Acceptor</code> å®ç°äº† <code>CompletionHandler</code> æ¥å£ã€‚é‚£ä¹ˆå®ƒæ˜¯å¦‚ä½•å®ç° <code>CompletionHandler</code> æ¥å£çš„å‘¢ï¼Ÿ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">class</span> <span class="title class_">Nio2Acceptor</span> <span class="keyword">extends</span> <span class="title class_">Acceptor</span>&lt;AsynchronousSocketChannel&gt;</span><br><span class="line">    <span class="keyword">implements</span> <span class="title class_">CompletionHandler</span>&lt;AsynchronousSocketChannel, Void&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">completed</span><span class="params">(AsynchronousSocketChannel socket,</span></span><br><span class="line"><span class="params">        Void attachment)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (isRunning() &amp;&amp; !isPaused()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (getMaxConnections() == -<span class="number">1</span>) &#123;</span><br><span class="line">                <span class="comment">// å¦‚æœæ²¡æœ‰è¿æ¥é™åˆ¶ï¼Œç»§ç»­æ¥æ”¶æ–°çš„è¿æ¥</span></span><br><span class="line">                serverSock.accept(<span class="literal">null</span>, <span class="built_in">this</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// å¦‚æœæœ‰è¿æ¥é™åˆ¶ï¼Œå°±åœ¨çº¿ç¨‹æ± é‡Œè·‘ Run æ–¹æ³•ï¼ŒRun æ–¹æ³•ä¼šæ£€æŸ¥è¿æ¥æ•°</span></span><br><span class="line">                getExecutor().execute(<span class="built_in">this</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// å¤„ç†è¯·æ±‚</span></span><br><span class="line">            <span class="keyword">if</span> (!setSocketOptions(socket)) &#123;</span><br><span class="line">                closeSocket(socket);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ° <code>CompletionHandler</code> çš„ä¸¤ä¸ªæ¨¡æ¿å‚æ•°åˆ†åˆ«æ˜¯ <code>AsynchronousServerSocketChannel</code> å’Œ Voidï¼Œæˆ‘åœ¨å‰é¢è¯´è¿‡ç¬¬ä¸€ä¸ªå‚æ•°å°±æ˜¯ <code>accept</code> æ–¹æ³•çš„è¿”å›å€¼ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯é™„ä»¶ç±»ï¼Œç”±ç”¨æˆ·è‡ªå·±å†³å®šï¼Œè¿™é‡Œä¸º Voidã€‚<code>completed</code> æ–¹æ³•çš„å¤„ç†é€»è¾‘æ¯”è¾ƒç®€å•ï¼š</p>
<ul>
<li>å¦‚æœæ²¡æœ‰è¿æ¥é™åˆ¶ï¼Œç»§ç»­åœ¨æœ¬çº¿ç¨‹ä¸­è°ƒç”¨ <code>accept</code> æ–¹æ³•æ¥æ”¶æ–°çš„è¿æ¥ã€‚</li>
<li>å¦‚æœæœ‰è¿æ¥é™åˆ¶ï¼Œå°±åœ¨çº¿ç¨‹æ± é‡Œè·‘ <code>run</code> æ–¹æ³•å»æ¥æ”¶æ–°çš„è¿æ¥ã€‚é‚£ä¸ºä»€ä¹ˆè¦è·‘ <code>run</code> æ–¹æ³•å‘¢ï¼Œå› ä¸ºåœ¨ <code>run</code> æ–¹æ³•é‡Œä¼šæ£€æŸ¥è¿æ¥æ•°ï¼Œå½“è¿æ¥è¾¾åˆ°æœ€å¤§æ•°æ—¶ï¼Œçº¿ç¨‹å¯èƒ½ä¼šè¢« <code>LimitLatch</code> é˜»å¡ã€‚ä¸ºä»€ä¹ˆè¦æ”¾åœ¨çº¿ç¨‹æ± é‡Œè·‘å‘¢ï¼Ÿè¿™æ˜¯å› ä¸ºå¦‚æœæ”¾åœ¨å½“å‰çº¿ç¨‹é‡Œæ‰§è¡Œï¼Œ<code>completed</code> æ–¹æ³•å¯èƒ½è¢«é˜»å¡ï¼Œä¼šå¯¼è‡´è¿™ä¸ªå›è°ƒæ–¹æ³•ä¸€ç›´ä¸è¿”å›ã€‚</li>
</ul>
<p>æ¥ç€ <code>completed</code> æ–¹æ³•ä¼šè°ƒç”¨ <code>setSocketOptions</code> æ–¹æ³•ï¼Œåœ¨è¿™ä¸ªæ–¹æ³•é‡Œï¼Œä¼šåˆ›å»º <code>Nio2SocketWrapper</code> å’Œ <code>SocketProcessor</code>ï¼Œå¹¶äº¤ç»™çº¿ç¨‹æ± å¤„ç†ã€‚</p>
<h3 id="2-2-Nio2SocketWrapper"><a href="#2-2-Nio2SocketWrapper" class="headerlink" title="2.2. Nio2SocketWrapper"></a>2.2. Nio2SocketWrapper</h3><p><code>Nio2SocketWrapper</code> çš„ä¸»è¦ä½œç”¨æ˜¯å°è£… Channelï¼Œå¹¶æä¾›æ¥å£ç»™ <code>Http11Processor</code> è¯»å†™æ•°æ®ã€‚è®²åˆ°è¿™é‡Œä½ æ˜¯ä¸æ˜¯æœ‰ä¸ªç–‘é—®ï¼š<code>Http11Processor</code> æ˜¯ä¸èƒ½é˜»å¡ç­‰å¾…æ•°æ®çš„ï¼ŒæŒ‰ç…§å¼‚æ­¥ I&#x2F;O çš„å¥—è·¯ï¼Œ<code>Http11Processor</code> åœ¨è°ƒç”¨ <code>Nio2SocketWrapper</code> çš„ read æ–¹æ³•æ—¶éœ€è¦æ³¨å†Œå›è°ƒç±»ï¼Œread è°ƒç”¨ä¼šç«‹å³è¿”å›ï¼Œé—®é¢˜æ˜¯ç«‹å³è¿”å›å <code>Http11Processor</code> è¿˜æ²¡æœ‰è¯»åˆ°æ•°æ®ï¼Œ æ€ä¹ˆåŠå‘¢ï¼Ÿè¿™ä¸ªè¯·æ±‚çš„å¤„ç†ä¸å°±å¤±è´¥äº†å—ï¼Ÿ</p>
<p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œ<code>Http11Processor</code> æ˜¯é€šè¿‡ 2 æ¬¡ read è°ƒç”¨æ¥å®Œæˆæ•°æ®è¯»å–æ“ä½œçš„ã€‚</p>
<ul>
<li>ç¬¬ä¸€æ¬¡ read è°ƒç”¨ï¼šè¿æ¥åˆšåˆšå»ºç«‹å¥½åï¼Œ<code>Acceptor</code> åˆ›å»º <code>SocketProcessor</code> ä»»åŠ¡ç±»äº¤ç»™çº¿ç¨‹æ± å»å¤„ç†ï¼Œ<code>Http11Processor</code> åœ¨å¤„ç†è¯·æ±‚çš„è¿‡ç¨‹ä¸­ï¼Œä¼šè°ƒç”¨ <code>Nio2SocketWrapper</code> çš„ read æ–¹æ³•å‘å‡ºç¬¬ä¸€æ¬¡è¯»è¯·æ±‚ï¼ŒåŒæ—¶æ³¨å†Œäº†å›è°ƒç±» <code>readCompletionHandler</code>ï¼Œå› ä¸ºæ•°æ®æ²¡è¯»åˆ°ï¼Œ<code>Http11Processor</code> æŠŠå½“å‰çš„ <code>Nio2SocketWrapper</code> æ ‡è®°ä¸ºæ•°æ®ä¸å®Œæ•´ã€‚<strong>æ¥ç€ <code>SocketProcessor</code> çº¿ç¨‹è¢«å›æ”¶ï¼Œ<code>Http11Processor</code> å¹¶æ²¡æœ‰é˜»å¡ç­‰å¾…æ•°æ®</strong>ã€‚è¿™é‡Œè¯·æ³¨æ„ï¼Œ<code>Http11Processor</code> ç»´æŠ¤äº†ä¸€ä¸ª <code>Nio2SocketWrapper</code> åˆ—è¡¨ï¼Œä¹Ÿå°±æ˜¯ç»´æŠ¤äº†è¿æ¥çš„çŠ¶æ€ã€‚</li>
<li>ç¬¬äºŒæ¬¡ read è°ƒç”¨ï¼šå½“æ•°æ®åˆ°è¾¾åï¼Œå†…æ ¸å·²ç»æŠŠæ•°æ®æ‹·è´åˆ° <code>Http11Processor</code> æŒ‡å®šçš„ Buffer é‡Œï¼ŒåŒæ—¶å›è°ƒç±» <code>readCompletionHandler</code> è¢«è°ƒç”¨ï¼Œåœ¨è¿™ä¸ªå›è°ƒå¤„ç†æ–¹æ³•é‡Œä¼š<strong>é‡æ–°åˆ›å»ºä¸€ä¸ªæ–°çš„ <code>SocketProcessor</code> ä»»åŠ¡æ¥ç»§ç»­å¤„ç†è¿™ä¸ªè¿æ¥</strong>ï¼Œè€Œè¿™ä¸ªæ–°çš„ <code>SocketProcessor</code> ä»»åŠ¡ç±»æŒæœ‰åŸæ¥é‚£ä¸ª <code>Nio2SocketWrapper</code>ï¼Œè¿™ä¸€æ¬¡ <code>Http11Processor</code> å¯ä»¥é€šè¿‡ <code>Nio2SocketWrapper</code> è¯»å–æ•°æ®äº†ï¼Œå› ä¸ºæ•°æ®å·²ç»åˆ°äº†åº”ç”¨å±‚çš„ Bufferã€‚</li>
</ul>
<p>è¿™ä¸ªå›è°ƒç±» <code>readCompletionHandler</code> çš„æºç å¦‚ä¸‹ï¼Œæœ€å…³é”®çš„ä¸€ç‚¹æ˜¯ï¼Œ**<code>Nio2SocketWrapper</code> æ˜¯ä½œä¸ºé™„ä»¶ç±»æ¥ä¼ é€’çš„**ï¼Œè¿™æ ·åœ¨å›è°ƒå‡½æ•°é‡Œèƒ½æ‹¿åˆ°æ‰€æœ‰çš„ä¸Šä¸‹æ–‡ã€‚</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">this</span>.<span class="property">readCompletionHandler</span> = <span class="keyword">new</span> <span class="title class_">CompletionHandler</span>&lt;<span class="title class_">Integer</span>, <span class="title class_">SocketWrapperBase</span>&lt;<span class="title class_">Nio2Channel</span>&gt;&gt;() &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">completed</span>(<span class="params"><span class="title class_">Integer</span> nBytes, <span class="title class_">SocketWrapperBase</span>&lt;<span class="title class_">Nio2Channel</span>&gt; attachment</span>) &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">// é€šè¿‡é™„ä»¶ç±» SocketWrapper æ‹¿åˆ°æ‰€æœ‰çš„ä¸Šä¸‹æ–‡</span></span><br><span class="line">        <span class="title class_">Nio2SocketWrapper</span>.<span class="property">this</span>.<span class="title function_">getEndpoint</span>().<span class="title function_">processSocket</span>(attachment, <span class="title class_">SocketEvent</span>.<span class="property">OPEN_READ</span>, <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">failed</span>(<span class="params"><span class="title class_">Throwable</span> exc, <span class="title class_">SocketWrapperBase</span>&lt;<span class="title class_">Nio2Channel</span>&gt; attachment</span>) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-AprEndpoint-ç»„ä»¶"><a href="#3-AprEndpoint-ç»„ä»¶" class="headerlink" title="3. AprEndpoint ç»„ä»¶"></a>3. AprEndpoint ç»„ä»¶</h2><p>æˆ‘ä»¬åœ¨ä½¿ç”¨ Tomcat æ—¶ï¼Œå¯èƒ½ä¼šåœ¨å¯åŠ¨æ—¥å¿—é‡Œçœ‹åˆ°è¿™æ ·çš„æç¤ºä¿¡æ¯ï¼š</p>
<blockquote>
<p>The APR based Apache Tomcat Native library which allows optimal performance in production environments was not found on the java.library.path: ***</p>
</blockquote>
<p>è¿™å¥è¯çš„æ„æ€å°±æ˜¯æ¨èä½ å»å®‰è£… APR åº“ï¼Œå¯ä»¥æé«˜ç³»ç»Ÿæ€§èƒ½ã€‚</p>
<p>APRï¼ˆApache Portable Runtime Librariesï¼‰æ˜¯ Apache å¯ç§»æ¤è¿è¡Œæ—¶åº“ï¼Œå®ƒæ˜¯ç”¨ C è¯­è¨€å®ç°çš„ï¼Œå…¶ç›®çš„æ˜¯å‘ä¸Šå±‚åº”ç”¨ç¨‹åºæä¾›ä¸€ä¸ªè·¨å¹³å°çš„æ“ä½œç³»ç»Ÿæ¥å£åº“ã€‚Tomcat å¯ä»¥ç”¨å®ƒæ¥å¤„ç†åŒ…æ‹¬æ–‡ä»¶å’Œç½‘ç»œ I&#x2F;Oï¼Œä»è€Œæå‡æ€§èƒ½ã€‚Tomcat æ”¯æŒçš„è¿æ¥å™¨æœ‰ NIOã€NIO.2 å’Œ APRã€‚è·Ÿ NioEndpoint ä¸€æ ·ï¼ŒAprEndpoint ä¹Ÿå®ç°äº†éé˜»å¡ I&#x2F;Oï¼Œå®ƒä»¬çš„åŒºåˆ«æ˜¯ï¼šNioEndpoint é€šè¿‡è°ƒç”¨ Java çš„ NIO API æ¥å®ç°éé˜»å¡ I&#x2F;Oï¼Œè€Œ AprEndpoint æ˜¯é€šè¿‡ JNI è°ƒç”¨ APR æœ¬åœ°åº“è€Œå®ç°éé˜»å¡ I&#x2F;O çš„ã€‚</p>
<p>åŒæ ·æ˜¯éé˜»å¡ I&#x2F;Oï¼Œä¸ºä»€ä¹ˆ Tomcat ä¼šæç¤ºä½¿ç”¨ APR æœ¬åœ°åº“çš„æ€§èƒ½ä¼šæ›´å¥½å‘¢ï¼Ÿè¿™æ˜¯å› ä¸ºåœ¨æŸäº›åœºæ™¯ä¸‹ï¼Œæ¯”å¦‚éœ€è¦é¢‘ç¹ä¸æ“ä½œç³»ç»Ÿè¿›è¡Œäº¤äº’ï¼ŒSocket ç½‘ç»œé€šä¿¡å°±æ˜¯è¿™æ ·ä¸€ä¸ªåœºæ™¯ï¼Œç‰¹åˆ«æ˜¯å¦‚æœä½ çš„ Web åº”ç”¨ä½¿ç”¨äº† TLS æ¥åŠ å¯†ä¼ è¾“ï¼Œæˆ‘ä»¬çŸ¥é“ TLS åè®®åœ¨æ¡æ‰‹è¿‡ç¨‹ä¸­æœ‰å¤šæ¬¡ç½‘ç»œäº¤äº’ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ Java è·Ÿ C è¯­è¨€ç¨‹åºç›¸æ¯”è¿˜æ˜¯æœ‰ä¸€å®šçš„å·®è·ï¼Œè€Œè¿™æ­£æ˜¯ APR çš„å¼ºé¡¹ã€‚</p>
<p>Tomcat æœ¬èº«æ˜¯ Java ç¼–å†™çš„ï¼Œä¸ºäº†è°ƒç”¨ C è¯­è¨€ç¼–å†™çš„ APRï¼Œéœ€è¦é€šè¿‡ JNI æ–¹å¼æ¥è°ƒç”¨ã€‚JNIï¼ˆJava Native Interfaceï¼‰ æ˜¯ JDK æä¾›çš„ä¸€ä¸ªç¼–ç¨‹æ¥å£ï¼Œå®ƒå…è®¸ Java ç¨‹åºè°ƒç”¨å…¶ä»–è¯­è¨€ç¼–å†™çš„ç¨‹åºæˆ–è€…ä»£ç åº“ï¼Œå…¶å® JDK æœ¬èº«çš„å®ç°ä¹Ÿå¤§é‡ç”¨åˆ° JNI æŠ€æœ¯æ¥è°ƒç”¨æœ¬åœ° C ç¨‹åºåº“ã€‚</p>
<h3 id="3-1-AprEndpoint-å·¥ä½œæµç¨‹"><a href="#3-1-AprEndpoint-å·¥ä½œæµç¨‹" class="headerlink" title="3.1. AprEndpoint å·¥ä½œæµç¨‹"></a>3.1. AprEndpoint å·¥ä½œæµç¨‹</h3><p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/20201127145740.jpg" alt="img"></p>
<h4 id="3-1-1-Acceptor"><a href="#3-1-1-Acceptor" class="headerlink" title="3.1.1. Acceptor"></a>3.1.1. Acceptor</h4><p>Accpetor çš„åŠŸèƒ½å°±æ˜¯ç›‘å¬è¿æ¥ï¼Œæ¥æ”¶å¹¶å»ºç«‹è¿æ¥ã€‚å®ƒçš„æœ¬è´¨å°±æ˜¯è°ƒç”¨äº†å››ä¸ªæ“ä½œç³»ç»Ÿ APIï¼šsocketã€bindã€listen å’Œ acceptã€‚é‚£ Java è¯­è¨€å¦‚ä½•ç›´æ¥è°ƒç”¨ C è¯­è¨€ API å‘¢ï¼Ÿç­”æ¡ˆå°±æ˜¯é€šè¿‡ JNIã€‚å…·ä½“æ¥è¯´å°±æ˜¯ä¸¤æ­¥ï¼šå…ˆå°è£…ä¸€ä¸ª Java ç±»ï¼Œåœ¨é‡Œé¢å®šä¹‰ä¸€å †ç”¨<strong>native å…³é”®å­—</strong>ä¿®é¥°çš„æ–¹æ³•ï¼Œåƒä¸‹é¢è¿™æ ·ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Socket</span> &#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">// ç”¨ native ä¿®é¥°è¿™ä¸ªæ–¹æ³•ï¼Œè¡¨æ˜è¿™ä¸ªå‡½æ•°æ˜¯ C è¯­è¨€å®ç°</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">native</span> <span class="type">long</span> <span class="title function_">create</span><span class="params">(<span class="type">int</span> family, <span class="type">int</span> type,</span></span><br><span class="line"><span class="params">                                 <span class="type">int</span> protocol, <span class="type">long</span> cont)</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">native</span> <span class="type">int</span> <span class="title function_">bind</span><span class="params">(<span class="type">long</span> sock, <span class="type">long</span> sa)</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">native</span> <span class="type">int</span> <span class="title function_">listen</span><span class="params">(<span class="type">long</span> sock, <span class="type">int</span> backlog)</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">native</span> <span class="type">long</span> <span class="title function_">accept</span><span class="params">(<span class="type">long</span> sock)</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ¥ç€ç”¨ C ä»£ç å®ç°è¿™äº›æ–¹æ³•ï¼Œæ¯”å¦‚ bind å‡½æ•°å°±æ˜¯è¿™æ ·å®ç°çš„ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ³¨æ„å‡½æ•°çš„åå­—è¦ç¬¦åˆ JNI è§„èŒƒçš„è¦æ±‚</span></span><br><span class="line">JNIEXPORT jint JNICALL</span><br><span class="line"><span class="title function_">Java_org_apache_tomcat_jni_Socket_bind</span><span class="params">(JNIEnv *e, jlong sock,jlong sa)</span></span><br><span class="line">	&#123;</span><br><span class="line">	    <span class="type">jint</span> <span class="variable">rv</span> <span class="operator">=</span> APR_SUCCESS;</span><br><span class="line">	    tcn_socket_t *s = (tcn_socket_t *ï¼‰sock;</span><br><span class="line">	    apr_sockaddr_t *a = (apr_sockaddr_t *) sa;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è°ƒç”¨ APR åº“è‡ªå·±å®ç°çš„ bind å‡½æ•°</span></span><br><span class="line">	    rv = (jint)apr_socket_bind(s-&gt;sock, a);</span><br><span class="line">	    <span class="keyword">return</span> rv;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸“æ é‡Œæˆ‘å°±ä¸å±•å¼€ JNI çš„ç»†èŠ‚äº†ï¼Œä½ å¯ä»¥<a target="_blank" rel="noopener" href="http://jnicookbook.owsiak.org/contents/">æ‰©å±•é˜…è¯»</a>è·å¾—æ›´å¤šä¿¡æ¯å’Œä¾‹å­ã€‚æˆ‘ä»¬è¦æ³¨æ„çš„æ˜¯å‡½æ•°åå­—è¦ç¬¦åˆ JNI çš„è§„èŒƒï¼Œä»¥åŠ Java å’Œ C è¯­è¨€å¦‚ä½•äº’ç›¸ä¼ é€’å‚æ•°ï¼Œæ¯”å¦‚åœ¨ C è¯­è¨€æœ‰æŒ‡é’ˆï¼ŒJava æ²¡æœ‰æŒ‡é’ˆçš„æ¦‚å¿µï¼Œæ‰€ä»¥åœ¨ Java ä¸­ç”¨ long ç±»å‹æ¥è¡¨ç¤ºæŒ‡é’ˆã€‚AprEndpoint çš„ Acceptor ç»„ä»¶å°±æ˜¯è°ƒç”¨äº† APR å®ç°çš„å››ä¸ª APIã€‚</p>
<h4 id="3-1-2-Poller"><a href="#3-1-2-Poller" class="headerlink" title="3.1.2. Poller"></a>3.1.2. Poller</h4><p>Acceptor æ¥æ”¶åˆ°ä¸€ä¸ªæ–°çš„ Socket è¿æ¥åï¼ŒæŒ‰ç…§ NioEndpoint çš„å®ç°ï¼Œå®ƒä¼šæŠŠè¿™ä¸ª Socket äº¤ç»™ Poller å»æŸ¥è¯¢ I&#x2F;O äº‹ä»¶ã€‚AprEndpoint ä¹Ÿæ˜¯è¿™æ ·åšçš„ï¼Œä¸è¿‡ AprEndpoint çš„ Poller å¹¶ä¸æ˜¯è°ƒç”¨ Java NIO é‡Œçš„ Selector æ¥æŸ¥è¯¢ Socket çš„çŠ¶æ€ï¼Œè€Œæ˜¯é€šè¿‡ JNI è°ƒç”¨ APR ä¸­çš„ poll æ–¹æ³•ï¼Œè€Œ APR åˆæ˜¯è°ƒç”¨äº†æ“ä½œç³»ç»Ÿçš„ epoll API æ¥å®ç°çš„ã€‚</p>
<p>è¿™é‡Œæœ‰ä¸ªç‰¹åˆ«çš„åœ°æ–¹æ˜¯åœ¨ AprEndpoint ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é…ç½®ä¸€ä¸ªå«<code>deferAccept</code>çš„å‚æ•°ï¼Œå®ƒå¯¹åº”çš„æ˜¯ TCP åè®®ä¸­çš„<code>TCP_DEFER_ACCEPT</code>ï¼Œè®¾ç½®è¿™ä¸ªå‚æ•°åï¼Œå½“ TCP å®¢æˆ·ç«¯æœ‰æ–°çš„è¿æ¥è¯·æ±‚åˆ°è¾¾æ—¶ï¼ŒTCP æœåŠ¡ç«¯å…ˆä¸å»ºç«‹è¿æ¥ï¼Œè€Œæ˜¯å†ç­‰ç­‰ï¼Œç›´åˆ°å®¢æˆ·ç«¯æœ‰è¯·æ±‚æ•°æ®å‘è¿‡æ¥æ—¶å†å»ºç«‹è¿æ¥ã€‚è¿™æ ·çš„å¥½å¤„æ˜¯æœåŠ¡ç«¯ä¸éœ€è¦ç”¨ Selector å»åå¤æŸ¥è¯¢è¯·æ±‚æ•°æ®æ˜¯å¦å°±ç»ªã€‚</p>
<p>è¿™æ˜¯ä¸€ç§ TCP åè®®å±‚çš„ä¼˜åŒ–ï¼Œä¸æ˜¯æ¯ä¸ªæ“ä½œç³»ç»Ÿå†…æ ¸éƒ½æ”¯æŒï¼Œå› ä¸º Java ä½œä¸ºä¸€ç§è·¨å¹³å°è¯­è¨€ï¼Œéœ€è¦å±è”½å„ç§æ“ä½œç³»ç»Ÿçš„å·®å¼‚ï¼Œå› æ­¤å¹¶æ²¡æœ‰æŠŠè¿™ä¸ªå‚æ•°æä¾›ç»™ç”¨æˆ·ï¼›ä½†æ˜¯å¯¹äº APR æ¥è¯´ï¼Œå®ƒçš„ç›®çš„å°±æ˜¯å°½å¯èƒ½æå‡æ€§èƒ½ï¼Œå› æ­¤å®ƒå‘ç”¨æˆ·æš´éœ²äº†è¿™ä¸ªå‚æ•°ã€‚</p>
<h3 id="3-2-APR-æå‡æ€§èƒ½çš„ç§˜å¯†"><a href="#3-2-APR-æå‡æ€§èƒ½çš„ç§˜å¯†" class="headerlink" title="3.2. APR æå‡æ€§èƒ½çš„ç§˜å¯†"></a>3.2. APR æå‡æ€§èƒ½çš„ç§˜å¯†</h3><p>APR è¿æ¥å™¨ä¹‹æ‰€ä»¥èƒ½æé«˜ Tomcat çš„æ€§èƒ½ï¼Œé™¤äº† APR æœ¬èº«æ˜¯ C ç¨‹åºåº“ä¹‹å¤–ï¼Œè¿˜æœ‰å“ªäº›æé€Ÿçš„ç§˜å¯†å‘¢ï¼Ÿ</p>
<p><strong>JVM å † VS æœ¬åœ°å†…å­˜</strong></p>
<p>æˆ‘ä»¬çŸ¥é“ Java çš„ç±»å®ä¾‹ä¸€èˆ¬åœ¨ JVM å †ä¸Šåˆ†é…ï¼Œè€Œ Java æ˜¯é€šè¿‡ JNI è°ƒç”¨ C ä»£ç æ¥å®ç° Socket é€šä¿¡çš„ï¼Œé‚£ä¹ˆ C ä»£ç åœ¨è¿è¡Œè¿‡ç¨‹ä¸­éœ€è¦çš„å†…å­˜åˆæ˜¯ä»å“ªé‡Œåˆ†é…çš„å‘¢ï¼ŸC ä»£ç èƒ½å¦ç›´æ¥æ“ä½œ Java å †ï¼Ÿ</p>
<p>ä¸ºäº†å›ç­”è¿™äº›é—®é¢˜ï¼Œæˆ‘å…ˆæ¥è¯´è¯´ JVM å’Œç”¨æˆ·è¿›ç¨‹çš„å…³ç³»ã€‚å¦‚æœä½ æƒ³è¿è¡Œä¸€ä¸ª Java ç±»æ–‡ä»¶ï¼Œå¯ä»¥ç”¨ä¸‹é¢çš„ Java å‘½ä»¤æ¥æ‰§è¡Œã€‚</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java <span class="keyword">my</span>.<span class="built_in">class</span></span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªå‘½ä»¤è¡Œä¸­çš„<code>java</code>å…¶å®æ˜¯<strong>ä¸€ä¸ªå¯æ‰§è¡Œç¨‹åºï¼Œè¿™ä¸ªç¨‹åºä¼šåˆ›å»º JVM æ¥åŠ è½½å’Œè¿è¡Œä½ çš„ Java ç±»</strong>ã€‚æ“ä½œç³»ç»Ÿä¼šåˆ›å»ºä¸€ä¸ªè¿›ç¨‹æ¥æ‰§è¡Œè¿™ä¸ª<code>java</code>å¯æ‰§è¡Œç¨‹åºï¼Œè€Œæ¯ä¸ªè¿›ç¨‹éƒ½æœ‰è‡ªå·±çš„è™šæ‹Ÿåœ°å€ç©ºé—´ï¼ŒJVM ç”¨åˆ°çš„å†…å­˜ï¼ˆåŒ…æ‹¬å †ã€æ ˆå’Œæ–¹æ³•åŒºï¼‰å°±æ˜¯ä»è¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´ä¸Šåˆ†é…çš„ã€‚è¯·ä½ æ³¨æ„çš„æ˜¯ï¼ŒJVM å†…å­˜åªæ˜¯è¿›ç¨‹ç©ºé—´çš„ä¸€éƒ¨åˆ†ï¼Œé™¤æ­¤ä¹‹å¤–è¿›ç¨‹ç©ºé—´å†…è¿˜æœ‰ä»£ç æ®µã€æ•°æ®æ®µã€å†…å­˜æ˜ å°„åŒºã€å†…æ ¸ç©ºé—´ç­‰ã€‚ä» JVM çš„è§’åº¦çœ‹ï¼ŒJVM å†…å­˜ä¹‹å¤–çš„éƒ¨åˆ†å«ä½œæœ¬åœ°å†…å­˜ï¼ŒC ç¨‹åºä»£ç åœ¨è¿è¡Œè¿‡ç¨‹ä¸­ç”¨åˆ°çš„å†…å­˜å°±æ˜¯æœ¬åœ°å†…å­˜ä¸­åˆ†é…çš„ã€‚ä¸‹é¢æˆ‘ä»¬é€šè¿‡ä¸€å¼ å›¾æ¥ç†è§£ä¸€ä¸‹ã€‚</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/20201127150729.jpg" alt="img"></p>
<p>Tomcat çš„ Endpoint ç»„ä»¶åœ¨æ¥æ”¶ç½‘ç»œæ•°æ®æ—¶éœ€è¦é¢„å…ˆåˆ†é…å¥½ä¸€å— Bufferï¼Œæ‰€è°“çš„ Buffer å°±æ˜¯å­—èŠ‚æ•°ç»„<code>byte[]</code>ï¼ŒJava é€šè¿‡ JNI è°ƒç”¨æŠŠè¿™å— Buffer çš„åœ°å€ä¼ ç»™ C ä»£ç ï¼ŒC ä»£ç é€šè¿‡æ“ä½œç³»ç»Ÿ API è¯»å– Socket å¹¶æŠŠæ•°æ®å¡«å……åˆ°è¿™å— Bufferã€‚Java NIO API æä¾›äº†ä¸¤ç§ Buffer æ¥æ¥æ”¶æ•°æ®ï¼šHeapByteBuffer å’Œ DirectByteBufferï¼Œä¸‹é¢çš„ä»£ç æ¼”ç¤ºäº†å¦‚ä½•åˆ›å»ºä¸¤ç§ Bufferã€‚</p>
<figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// åˆ†é… HeapByteBuffer</span><br><span class="line">ByteBuffer buf <span class="operator">=</span> ByteBuffer.allocate(<span class="number">1024</span>)<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">// åˆ†é… DirectByteBuffer</span><br><span class="line">ByteBuffer buf <span class="operator">=</span> ByteBuffer.allocateDirect(<span class="number">1024</span>)<span class="comment">;</span></span><br></pre></td></tr></table></figure>

<p>åˆ›å»ºå¥½ Buffer åç›´æ¥ä¼ ç»™ Channel çš„ read æˆ–è€… write å‡½æ•°ï¼Œæœ€ç»ˆè¿™å— Buffer ä¼šé€šè¿‡ JNI è°ƒç”¨ä¼ é€’ç»™ C ç¨‹åºã€‚</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å°† buf ä½œä¸º read å‡½æ•°çš„å‚æ•°</span></span><br><span class="line"><span class="keyword">int</span> bytesRead = socketChannel.<span class="keyword">read</span>(buf);</span><br></pre></td></tr></table></figure>

<p>é‚£ HeapByteBuffer å’Œ DirectByteBuffer æœ‰ä»€ä¹ˆåŒºåˆ«å‘¢ï¼ŸHeapByteBuffer å¯¹è±¡æœ¬èº«åœ¨ JVM å †ä¸Šåˆ†é…ï¼Œå¹¶ä¸”å®ƒæŒæœ‰çš„å­—èŠ‚æ•°ç»„<code>byte[]</code>ä¹Ÿæ˜¯åœ¨ JVM å †ä¸Šåˆ†é…ã€‚ä½†æ˜¯å¦‚æœç”¨<strong>HeapByteBuffer</strong>æ¥æ¥æ”¶ç½‘ç»œæ•°æ®ï¼Œ<strong>éœ€è¦æŠŠæ•°æ®ä»å†…æ ¸å…ˆæ‹·è´åˆ°ä¸€ä¸ªä¸´æ—¶çš„æœ¬åœ°å†…å­˜ï¼Œå†ä»ä¸´æ—¶æœ¬åœ°å†…å­˜æ‹·è´åˆ° JVM å †</strong>ï¼Œè€Œä¸æ˜¯ç›´æ¥ä»å†…æ ¸æ‹·è´åˆ° JVM å †ä¸Šã€‚è¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿè¿™æ˜¯å› ä¸ºæ•°æ®ä»å†…æ ¸æ‹·è´åˆ° JVM å †çš„è¿‡ç¨‹ä¸­ï¼ŒJVM å¯èƒ½ä¼šå‘ç”Ÿ GCï¼ŒGC è¿‡ç¨‹ä¸­å¯¹è±¡å¯èƒ½ä¼šè¢«ç§»åŠ¨ï¼Œä¹Ÿå°±æ˜¯è¯´ JVM å †ä¸Šçš„å­—èŠ‚æ•°ç»„å¯èƒ½ä¼šè¢«ç§»åŠ¨ï¼Œè¿™æ ·çš„è¯ Buffer åœ°å€å°±å¤±æ•ˆäº†ã€‚å¦‚æœè¿™ä¸­é—´ç»è¿‡æœ¬åœ°å†…å­˜ä¸­è½¬ï¼Œä»æœ¬åœ°å†…å­˜åˆ° JVM å †çš„æ‹·è´è¿‡ç¨‹ä¸­ JVM å¯ä»¥ä¿è¯ä¸åš GCã€‚</p>
<p>å¦‚æœä½¿ç”¨ HeapByteBufferï¼Œä½ ä¼šå‘ç° JVM å †å’Œå†…æ ¸ä¹‹é—´å¤šäº†ä¸€å±‚ä¸­è½¬ï¼Œè€Œ DirectByteBuffer ç”¨æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒDirectByteBuffer å¯¹è±¡æœ¬èº«åœ¨ JVM å †ä¸Šï¼Œä½†æ˜¯å®ƒæŒæœ‰çš„å­—èŠ‚æ•°ç»„ä¸æ˜¯ä» JVM å †ä¸Šåˆ†é…çš„ï¼Œè€Œæ˜¯ä»æœ¬åœ°å†…å­˜åˆ†é…çš„ã€‚DirectByteBuffer å¯¹è±¡ä¸­æœ‰ä¸ª long ç±»å‹å­—æ®µ addressï¼Œè®°å½•ç€æœ¬åœ°å†…å­˜çš„åœ°å€ï¼Œè¿™æ ·åœ¨æ¥æ”¶æ•°æ®çš„æ—¶å€™ï¼Œç›´æ¥æŠŠè¿™ä¸ªæœ¬åœ°å†…å­˜åœ°å€ä¼ é€’ç»™ C ç¨‹åºï¼ŒC ç¨‹åºä¼šå°†ç½‘ç»œæ•°æ®ä»å†…æ ¸æ‹·è´åˆ°è¿™ä¸ªæœ¬åœ°å†…å­˜ï¼ŒJVM å¯ä»¥ç›´æ¥è¯»å–è¿™ä¸ªæœ¬åœ°å†…å­˜ï¼Œè¿™ç§æ–¹å¼æ¯” HeapByteBuffer å°‘äº†ä¸€æ¬¡æ‹·è´ï¼Œå› æ­¤ä¸€èˆ¬æ¥è¯´å®ƒçš„é€Ÿåº¦ä¼šæ¯” HeapByteBuffer å¿«å¥½å‡ å€ã€‚ä½ å¯ä»¥é€šè¿‡ä¸Šé¢çš„å›¾åŠ æ·±ç†è§£ã€‚</p>
<p>Tomcat ä¸­çš„ AprEndpoint å°±æ˜¯é€šè¿‡ DirectByteBuffer æ¥æ¥æ”¶æ•°æ®çš„ï¼Œè€Œ NioEndpoint å’Œ Nio2Endpoint æ˜¯é€šè¿‡ HeapByteBuffer æ¥æ¥æ”¶æ•°æ®çš„ã€‚ä½ å¯èƒ½ä¼šé—®ï¼ŒNioEndpoint å’Œ Nio2Endpoint ä¸ºä»€ä¹ˆä¸ç”¨ DirectByteBuffer å‘¢ï¼Ÿè¿™æ˜¯å› ä¸ºæœ¬åœ°å†…å­˜ä¸å¥½ç®¡ç†ï¼Œå‘ç”Ÿå†…å­˜æ³„æ¼éš¾ä»¥å®šä½ï¼Œä»ç¨³å®šæ€§è€ƒè™‘ï¼ŒNioEndpoint å’Œ Nio2Endpoint æ²¡æœ‰å»å†’è¿™ä¸ªé™©ã€‚</p>
<h4 id="3-2-1-sendfile"><a href="#3-2-1-sendfile" class="headerlink" title="3.2.1. sendfile"></a>3.2.1. sendfile</h4><p>æˆ‘ä»¬å†æ¥è€ƒè™‘å¦ä¸€ä¸ªç½‘ç»œé€šä¿¡çš„åœºæ™¯ï¼Œä¹Ÿå°±æ˜¯é™æ€æ–‡ä»¶çš„å¤„ç†ã€‚æµè§ˆå™¨é€šè¿‡ Tomcat æ¥è·å–ä¸€ä¸ª HTML æ–‡ä»¶ï¼Œè€Œ Tomcat çš„å¤„ç†é€»è¾‘æ— éæ˜¯ä¸¤æ­¥ï¼š</p>
<ol>
<li>ä»ç£ç›˜è¯»å– HTML åˆ°å†…å­˜ã€‚</li>
<li>å°†è¿™æ®µå†…å­˜çš„å†…å®¹é€šè¿‡ Socket å‘é€å‡ºå»ã€‚</li>
</ol>
<p>ä½†æ˜¯åœ¨ä¼ ç»Ÿæ–¹å¼ä¸‹ï¼Œæœ‰å¾ˆå¤šæ¬¡çš„å†…å­˜æ‹·è´ï¼š</p>
<ul>
<li>è¯»å–æ–‡ä»¶æ—¶ï¼Œé¦–å…ˆæ˜¯å†…æ ¸æŠŠæ–‡ä»¶å†…å®¹è¯»å–åˆ°å†…æ ¸ç¼“å†²åŒºã€‚</li>
<li>å¦‚æœä½¿ç”¨ HeapByteBufferï¼Œæ–‡ä»¶æ•°æ®ä»å†…æ ¸åˆ° JVM å †å†…å­˜éœ€è¦ç»è¿‡æœ¬åœ°å†…å­˜ä¸­è½¬ã€‚</li>
<li>åŒæ ·åœ¨å°†æ–‡ä»¶å†…å®¹æ¨å…¥ç½‘ç»œæ—¶ï¼Œä» JVM å †åˆ°å†…æ ¸ç¼“å†²åŒºéœ€è¦ç»è¿‡æœ¬åœ°å†…å­˜ä¸­è½¬ã€‚</li>
<li>æœ€åè¿˜éœ€è¦æŠŠæ–‡ä»¶ä»å†…æ ¸ç¼“å†²åŒºæ‹·è´åˆ°ç½‘å¡ç¼“å†²åŒºã€‚</li>
</ul>
<p>ä»ä¸‹é¢çš„å›¾ä½ ä¼šå‘ç°è¿™ä¸ªè¿‡ç¨‹æœ‰ 6 æ¬¡å†…å­˜æ‹·è´ï¼Œå¹¶ä¸” read å’Œ write ç­‰ç³»ç»Ÿè°ƒç”¨å°†å¯¼è‡´è¿›ç¨‹ä»ç”¨æˆ·æ€åˆ°å†…æ ¸æ€çš„åˆ‡æ¢ï¼Œä¼šè€—è´¹å¤§é‡çš„ CPU å’Œå†…å­˜èµ„æºã€‚</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/20201127151041.jpg" alt="img"></p>
<p>è€Œ Tomcat çš„ AprEndpoint é€šè¿‡æ“ä½œç³»ç»Ÿå±‚é¢çš„ sendfile ç‰¹æ€§è§£å†³äº†è¿™ä¸ªé—®é¢˜ï¼Œsendfile ç³»ç»Ÿè°ƒç”¨æ–¹å¼éå¸¸ç®€æ´ã€‚</p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sendfile</span>(socket, file, len);</span><br></pre></td></tr></table></figure>

<p>å®ƒå¸¦æœ‰ä¸¤ä¸ªå…³é”®å‚æ•°ï¼šSocket å’Œæ–‡ä»¶å¥æŸ„ã€‚å°†æ–‡ä»¶ä»ç£ç›˜å†™å…¥ Socket çš„è¿‡ç¨‹åªæœ‰ä¸¤æ­¥ï¼š</p>
<p>ç¬¬ä¸€æ­¥ï¼šå°†æ–‡ä»¶å†…å®¹è¯»å–åˆ°å†…æ ¸ç¼“å†²åŒºã€‚</p>
<p>ç¬¬äºŒæ­¥ï¼šæ•°æ®å¹¶æ²¡æœ‰ä»å†…æ ¸ç¼“å†²åŒºå¤åˆ¶åˆ° Socket å…³è”çš„ç¼“å†²åŒºï¼Œåªæœ‰è®°å½•æ•°æ®ä½ç½®å’Œé•¿åº¦çš„æè¿°ç¬¦è¢«æ·»åŠ åˆ° Socket ç¼“å†²åŒºä¸­ï¼›æ¥ç€æŠŠæ•°æ®ç›´æ¥ä»å†…æ ¸ç¼“å†²åŒºä¼ é€’ç»™ç½‘å¡ã€‚è¿™ä¸ªè¿‡ç¨‹ä½ å¯ä»¥çœ‹ä¸‹é¢çš„å›¾ã€‚</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/20201127151155.jpg" alt="img"></p>
<h2 id="4-Executor-ç»„ä»¶"><a href="#4-Executor-ç»„ä»¶" class="headerlink" title="4. Executor ç»„ä»¶"></a>4. Executor ç»„ä»¶</h2><p>ä¸ºäº†æé«˜å¤„ç†èƒ½åŠ›å’Œå¹¶å‘åº¦ï¼ŒWeb å®¹å™¨ä¸€èˆ¬ä¼šæŠŠå¤„ç†è¯·æ±‚çš„å·¥ä½œæ”¾åˆ°çº¿ç¨‹æ± é‡Œæ¥æ‰§è¡Œï¼ŒTomcat æ‰©å±•äº†åŸç”Ÿçš„ Java çº¿ç¨‹æ± ï¼Œæ¥æ»¡è¶³ Web å®¹å™¨é«˜å¹¶å‘çš„éœ€æ±‚ã€‚</p>
<h3 id="4-1-Tomcat-å®šåˆ¶çº¿ç¨‹æ± "><a href="#4-1-Tomcat-å®šåˆ¶çº¿ç¨‹æ± " class="headerlink" title="4.1. Tomcat å®šåˆ¶çº¿ç¨‹æ± "></a>4.1. Tomcat å®šåˆ¶çº¿ç¨‹æ± </h3><p>Tomcat çš„çº¿ç¨‹æ± ä¹Ÿæ˜¯ä¸€ä¸ªå®šåˆ¶ç‰ˆçš„ ThreadPoolExecutorã€‚Tomcat ä¼ å…¥çš„å‚æ•°æ˜¯è¿™æ ·çš„ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å®šåˆ¶ç‰ˆçš„ä»»åŠ¡é˜Ÿåˆ—</span></span><br><span class="line">taskqueue = <span class="keyword">new</span> <span class="title class_">TaskQueue</span>(maxQueueSize);</span><br><span class="line"></span><br><span class="line"><span class="comment">// å®šåˆ¶ç‰ˆçš„çº¿ç¨‹å·¥å‚</span></span><br><span class="line"><span class="type">TaskThreadFactory</span> <span class="variable">tf</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TaskThreadFactory</span>(namePrefix,daemon,getThreadPriority());</span><br><span class="line"></span><br><span class="line"><span class="comment">// å®šåˆ¶ç‰ˆçš„çº¿ç¨‹æ± </span></span><br><span class="line">executor = <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(getMinSpareThreads(), getMaxThreads(), maxIdleTime, TimeUnit.MILLISECONDS,taskqueue, tf);</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­çš„ä¸¤ä¸ªå…³é”®ç‚¹ï¼š</p>
<ul>
<li>Tomcat æœ‰è‡ªå·±çš„å®šåˆ¶ç‰ˆä»»åŠ¡é˜Ÿåˆ—å’Œçº¿ç¨‹å·¥å‚ï¼Œå¹¶ä¸”å¯ä»¥é™åˆ¶ä»»åŠ¡é˜Ÿåˆ—çš„é•¿åº¦ï¼Œå®ƒçš„æœ€å¤§é•¿åº¦æ˜¯ maxQueueSizeã€‚</li>
<li>Tomcat å¯¹çº¿ç¨‹æ•°ä¹Ÿæœ‰é™åˆ¶ï¼Œè®¾ç½®äº†æ ¸å¿ƒçº¿ç¨‹æ•°ï¼ˆminSpareThreadsï¼‰å’Œæœ€å¤§çº¿ç¨‹æ± æ•°ï¼ˆmaxThreadsï¼‰ã€‚</li>
</ul>
<p>é™¤äº†èµ„æºé™åˆ¶ä»¥å¤–ï¼ŒTomcat çº¿ç¨‹æ± è¿˜å®šåˆ¶è‡ªå·±çš„ä»»åŠ¡å¤„ç†æµç¨‹ã€‚æˆ‘ä»¬çŸ¥é“ Java åŸç”Ÿçº¿ç¨‹æ± çš„ä»»åŠ¡å¤„ç†é€»è¾‘æ¯”è¾ƒç®€å•ï¼š</p>
<ol>
<li>å‰ corePoolSize ä¸ªä»»åŠ¡æ—¶ï¼Œæ¥ä¸€ä¸ªä»»åŠ¡å°±åˆ›å»ºä¸€ä¸ªæ–°çº¿ç¨‹ã€‚</li>
<li>åé¢å†æ¥ä»»åŠ¡ï¼Œå°±æŠŠä»»åŠ¡æ·»åŠ åˆ°ä»»åŠ¡é˜Ÿåˆ—é‡Œè®©æ‰€æœ‰çš„çº¿ç¨‹å»æŠ¢ï¼Œå¦‚æœé˜Ÿåˆ—æ»¡äº†å°±åˆ›å»ºä¸´æ—¶çº¿ç¨‹ã€‚</li>
<li>å¦‚æœæ€»çº¿ç¨‹æ•°è¾¾åˆ° maximumPoolSizeï¼Œ<strong>æ‰§è¡Œæ‹’ç»ç­–ç•¥ã€‚</strong></li>
</ol>
<p>Tomcat çº¿ç¨‹æ± æ‰©å±•äº†åŸç”Ÿçš„ ThreadPoolExecutorï¼Œé€šè¿‡é‡å†™ execute æ–¹æ³•å®ç°äº†è‡ªå·±çš„ä»»åŠ¡å¤„ç†é€»è¾‘ï¼š</p>
<ol>
<li>å‰ corePoolSize ä¸ªä»»åŠ¡æ—¶ï¼Œæ¥ä¸€ä¸ªä»»åŠ¡å°±åˆ›å»ºä¸€ä¸ªæ–°çº¿ç¨‹ã€‚</li>
<li>å†æ¥ä»»åŠ¡çš„è¯ï¼Œå°±æŠŠä»»åŠ¡æ·»åŠ åˆ°ä»»åŠ¡é˜Ÿåˆ—é‡Œè®©æ‰€æœ‰çš„çº¿ç¨‹å»æŠ¢ï¼Œå¦‚æœé˜Ÿåˆ—æ»¡äº†å°±åˆ›å»ºä¸´æ—¶çº¿ç¨‹ã€‚</li>
<li>å¦‚æœæ€»çº¿ç¨‹æ•°è¾¾åˆ° maximumPoolSizeï¼Œ<strong>åˆ™ç»§ç»­å°è¯•æŠŠä»»åŠ¡æ·»åŠ åˆ°ä»»åŠ¡é˜Ÿåˆ—ä¸­å»ã€‚</strong></li>
<li><strong>å¦‚æœç¼“å†²é˜Ÿåˆ—ä¹Ÿæ»¡äº†ï¼Œæ’å…¥å¤±è´¥ï¼Œæ‰§è¡Œæ‹’ç»ç­–ç•¥ã€‚</strong></li>
</ol>
<p>è§‚å¯Ÿ Tomcat çº¿ç¨‹æ± å’Œ Java åŸç”Ÿçº¿ç¨‹æ± çš„åŒºåˆ«ï¼Œå…¶å®å°±æ˜¯åœ¨ç¬¬ 3 æ­¥ï¼ŒTomcat åœ¨çº¿ç¨‹æ€»æ•°è¾¾åˆ°æœ€å¤§æ•°æ—¶ï¼Œä¸æ˜¯ç«‹å³æ‰§è¡Œæ‹’ç»ç­–ç•¥ï¼Œè€Œæ˜¯å†å°è¯•å‘ä»»åŠ¡é˜Ÿåˆ—æ·»åŠ ä»»åŠ¡ï¼Œæ·»åŠ å¤±è´¥åå†æ‰§è¡Œæ‹’ç»ç­–ç•¥ã€‚é‚£å…·ä½“å¦‚ä½•å®ç°å‘¢ï¼Œå…¶å®å¾ˆç®€å•ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ Tomcat çº¿ç¨‹æ± çš„ execute æ–¹æ³•çš„æ ¸å¿ƒä»£ç ã€‚</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">ThreadPoolExecutor</span> <span class="keyword">extends</span> <span class="title">java</span>.<span class="title">util</span>.<span class="title">concurrent</span>.<span class="title">ThreadPoolExecutor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  public void execute(<span class="type">Runnable</span> command, long timeout, <span class="type">TimeUnit</span> unit) &#123;</span><br><span class="line">      submittedCount.incrementAndGet();</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="comment">// è°ƒç”¨ Java åŸç”Ÿçº¿ç¨‹æ± çš„ execute å»æ‰§è¡Œä»»åŠ¡</span></span><br><span class="line">          <span class="keyword">super</span>.execute(command);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (<span class="type">RejectedExecutionException</span> rx) &#123;</span><br><span class="line">         <span class="comment">// å¦‚æœæ€»çº¿ç¨‹æ•°è¾¾åˆ° maximumPoolSizeï¼ŒJava åŸç”Ÿçº¿ç¨‹æ± æ‰§è¡Œæ‹’ç»ç­–ç•¥</span></span><br><span class="line">          <span class="keyword">if</span> (<span class="keyword">super</span>.getQueue() instanceof <span class="type">TaskQueue</span>) &#123;</span><br><span class="line">              <span class="keyword">final</span> <span class="type">TaskQueue</span> queue = (<span class="type">TaskQueue</span>)<span class="keyword">super</span>.getQueue();</span><br><span class="line">              <span class="keyword">try</span> &#123;</span><br><span class="line">                  <span class="comment">// ç»§ç»­å°è¯•æŠŠä»»åŠ¡æ”¾åˆ°ä»»åŠ¡é˜Ÿåˆ—ä¸­å»</span></span><br><span class="line">                  <span class="keyword">if</span> (!queue.force(command, timeout, unit)) &#123;</span><br><span class="line">                      submittedCount.decrementAndGet();</span><br><span class="line">                      <span class="comment">// å¦‚æœç¼“å†²é˜Ÿåˆ—ä¹Ÿæ»¡äº†ï¼Œæ’å…¥å¤±è´¥ï¼Œæ‰§è¡Œæ‹’ç»ç­–ç•¥ã€‚</span></span><br><span class="line">                      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">RejectedExecutionException</span>(<span class="string">&quot;...&quot;</span>);</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä»è¿™ä¸ªæ–¹æ³•ä½ å¯ä»¥çœ‹åˆ°ï¼ŒTomcat çº¿ç¨‹æ± çš„ execute æ–¹æ³•ä¼šè°ƒç”¨ Java åŸç”Ÿçº¿ç¨‹æ± çš„ execute å»æ‰§è¡Œä»»åŠ¡ï¼Œå¦‚æœæ€»çº¿ç¨‹æ•°è¾¾åˆ° maximumPoolSizeï¼ŒJava åŸç”Ÿçº¿ç¨‹æ± çš„ execute æ–¹æ³•ä¼šæŠ›å‡º RejectedExecutionException å¼‚å¸¸ï¼Œä½†æ˜¯è¿™ä¸ªå¼‚å¸¸ä¼šè¢« Tomcat çº¿ç¨‹æ± çš„ execute æ–¹æ³•æ•è·åˆ°ï¼Œå¹¶ç»§ç»­å°è¯•æŠŠè¿™ä¸ªä»»åŠ¡æ”¾åˆ°ä»»åŠ¡é˜Ÿåˆ—ä¸­å»ï¼›å¦‚æœä»»åŠ¡é˜Ÿåˆ—ä¹Ÿæ»¡äº†ï¼Œå†æ‰§è¡Œæ‹’ç»ç­–ç•¥ã€‚</p>
<h3 id="4-2-Tomcat-å®šåˆ¶ä»»åŠ¡é˜Ÿåˆ—"><a href="#4-2-Tomcat-å®šåˆ¶ä»»åŠ¡é˜Ÿåˆ—" class="headerlink" title="4.2. Tomcat å®šåˆ¶ä»»åŠ¡é˜Ÿåˆ—"></a>4.2. Tomcat å®šåˆ¶ä»»åŠ¡é˜Ÿåˆ—</h3><p>ç»†å¿ƒçš„ä½ æœ‰æ²¡æœ‰å‘ç°ï¼Œåœ¨ Tomcat çº¿ç¨‹æ± çš„ execute æ–¹æ³•æœ€å¼€å§‹æœ‰è¿™ä¹ˆä¸€è¡Œï¼š</p>
<figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">submittedCount.incrementAndGet()<span class="comment">;</span></span><br></pre></td></tr></table></figure>

<p>è¿™è¡Œä»£ç çš„æ„æ€æŠŠ submittedCount è¿™ä¸ªåŸå­å˜é‡åŠ ä¸€ï¼Œå¹¶ä¸”åœ¨ä»»åŠ¡æ‰§è¡Œå¤±è´¥ï¼ŒæŠ›å‡ºæ‹’ç»å¼‚å¸¸æ—¶ï¼Œå°†è¿™ä¸ªåŸå­å˜é‡å‡ä¸€ï¼š</p>
<figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">submittedCount.decrementAndGet()<span class="comment">;</span></span><br></pre></td></tr></table></figure>

<p>å…¶å® Tomcat çº¿ç¨‹æ± æ˜¯ç”¨è¿™ä¸ªå˜é‡ submittedCount æ¥ç»´æŠ¤å·²ç»æäº¤åˆ°äº†çº¿ç¨‹æ± ï¼Œä½†æ˜¯è¿˜æ²¡æœ‰æ‰§è¡Œå®Œçš„ä»»åŠ¡ä¸ªæ•°ã€‚Tomcat ä¸ºä»€ä¹ˆè¦ç»´æŠ¤è¿™ä¸ªå˜é‡å‘¢ï¼Ÿè¿™è·Ÿ Tomcat çš„å®šåˆ¶ç‰ˆçš„ä»»åŠ¡é˜Ÿåˆ—æœ‰å…³ã€‚Tomcat çš„ä»»åŠ¡é˜Ÿåˆ— TaskQueue æ‰©å±•äº† Java ä¸­çš„ LinkedBlockingQueueï¼Œæˆ‘ä»¬çŸ¥é“ LinkedBlockingQueue é»˜è®¤æƒ…å†µä¸‹é•¿åº¦æ˜¯æ²¡æœ‰é™åˆ¶çš„ï¼Œé™¤éç»™å®ƒä¸€ä¸ª capacityã€‚å› æ­¤ Tomcat ç»™äº†å®ƒä¸€ä¸ª capacityï¼ŒTaskQueue çš„æ„é€ å‡½æ•°ä¸­æœ‰ä¸ªæ•´å‹çš„å‚æ•° capacityï¼ŒTaskQueue å°† capacity ä¼ ç»™çˆ¶ç±» LinkedBlockingQueue çš„æ„é€ å‡½æ•°ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TaskQueue</span> <span class="keyword">extends</span> <span class="title class_">LinkedBlockingQueue</span>&lt;Runnable&gt; &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">TaskQueue</span><span class="params">(<span class="type">int</span> capacity)</span> &#123;</span><br><span class="line">      <span class="built_in">super</span>(capacity);</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ª capacity å‚æ•°æ˜¯é€šè¿‡ Tomcat çš„ maxQueueSize å‚æ•°æ¥è®¾ç½®çš„ï¼Œä½†é—®é¢˜æ˜¯é»˜è®¤æƒ…å†µä¸‹ maxQueueSize çš„å€¼æ˜¯<code>Integer.MAX_VALUE</code>ï¼Œç­‰äºæ²¡æœ‰é™åˆ¶ï¼Œè¿™æ ·å°±å¸¦æ¥ä¸€ä¸ªé—®é¢˜ï¼šå½“å‰çº¿ç¨‹æ•°è¾¾åˆ°æ ¸å¿ƒçº¿ç¨‹æ•°ä¹‹åï¼Œå†æ¥ä»»åŠ¡çš„è¯çº¿ç¨‹æ± ä¼šæŠŠä»»åŠ¡æ·»åŠ åˆ°ä»»åŠ¡é˜Ÿåˆ—ï¼Œå¹¶ä¸”æ€»æ˜¯ä¼šæˆåŠŸï¼Œè¿™æ ·æ°¸è¿œä¸ä¼šæœ‰æœºä¼šåˆ›å»ºæ–°çº¿ç¨‹äº†ã€‚</p>
<p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒTaskQueue é‡å†™äº† LinkedBlockingQueue çš„ offer æ–¹æ³•ï¼Œåœ¨åˆé€‚çš„æ—¶æœºè¿”å› falseï¼Œè¿”å› false è¡¨ç¤ºä»»åŠ¡æ·»åŠ å¤±è´¥ï¼Œè¿™æ—¶çº¿ç¨‹æ± ä¼šåˆ›å»ºæ–°çš„çº¿ç¨‹ã€‚é‚£ä»€ä¹ˆæ˜¯åˆé€‚çš„æ—¶æœºå‘¢ï¼Ÿè¯·çœ‹ä¸‹é¢ offer æ–¹æ³•çš„æ ¸å¿ƒæºç ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TaskQueue</span> <span class="keyword">extends</span> <span class="title class_">LinkedBlockingQueue</span>&lt;Runnable&gt; &#123;</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">  <span class="comment">// çº¿ç¨‹æ± è°ƒç”¨ä»»åŠ¡é˜Ÿåˆ—çš„æ–¹æ³•æ—¶ï¼Œå½“å‰çº¿ç¨‹æ•°è‚¯å®šå·²ç»å¤§äºæ ¸å¿ƒçº¿ç¨‹æ•°äº†</span></span><br><span class="line">  <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">offer</span><span class="params">(Runnable o)</span> &#123;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// å¦‚æœçº¿ç¨‹æ•°å·²ç»åˆ°äº†æœ€å¤§å€¼ï¼Œä¸èƒ½åˆ›å»ºæ–°çº¿ç¨‹äº†ï¼Œåªèƒ½æŠŠä»»åŠ¡æ·»åŠ åˆ°ä»»åŠ¡é˜Ÿåˆ—ã€‚</span></span><br><span class="line">      <span class="keyword">if</span> (parent.getPoolSize() == parent.getMaximumPoolSize())</span><br><span class="line">          <span class="keyword">return</span> <span class="built_in">super</span>.offer(o);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// æ‰§è¡Œåˆ°è¿™é‡Œï¼Œè¡¨æ˜å½“å‰çº¿ç¨‹æ•°å¤§äºæ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œå¹¶ä¸”å°äºæœ€å¤§çº¿ç¨‹æ•°ã€‚</span></span><br><span class="line">      <span class="comment">// è¡¨æ˜æ˜¯å¯ä»¥åˆ›å»ºæ–°çº¿ç¨‹çš„ï¼Œé‚£åˆ°åº•è¦ä¸è¦åˆ›å»ºå‘¢ï¼Ÿåˆ†ä¸¤ç§æƒ…å†µï¼š</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">//1. å¦‚æœå·²æäº¤çš„ä»»åŠ¡æ•°å°äºå½“å‰çº¿ç¨‹æ•°ï¼Œè¡¨ç¤ºè¿˜æœ‰ç©ºé—²çº¿ç¨‹ï¼Œæ— éœ€åˆ›å»ºæ–°çº¿ç¨‹</span></span><br><span class="line">      <span class="keyword">if</span> (parent.getSubmittedCount()&lt;=(parent.getPoolSize()))</span><br><span class="line">          <span class="keyword">return</span> <span class="built_in">super</span>.offer(o);</span><br><span class="line"></span><br><span class="line">      <span class="comment">//2. å¦‚æœå·²æäº¤çš„ä»»åŠ¡æ•°å¤§äºå½“å‰çº¿ç¨‹æ•°ï¼Œçº¿ç¨‹ä¸å¤Ÿç”¨äº†ï¼Œè¿”å› false å»åˆ›å»ºæ–°çº¿ç¨‹</span></span><br><span class="line">      <span class="keyword">if</span> (parent.getPoolSize()&lt;parent.getMaximumPoolSize())</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// é»˜è®¤æƒ…å†µä¸‹æ€»æ˜¯æŠŠä»»åŠ¡æ·»åŠ åˆ°ä»»åŠ¡é˜Ÿåˆ—</span></span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">super</span>.offer(o);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä»ä¸Šé¢çš„ä»£ç æˆ‘ä»¬çœ‹åˆ°ï¼Œåªæœ‰å½“å‰çº¿ç¨‹æ•°å¤§äºæ ¸å¿ƒçº¿ç¨‹æ•°ã€å°äºæœ€å¤§çº¿ç¨‹æ•°ï¼Œå¹¶ä¸”å·²æäº¤çš„ä»»åŠ¡ä¸ªæ•°å¤§äºå½“å‰çº¿ç¨‹æ•°æ—¶ï¼Œä¹Ÿå°±æ˜¯è¯´çº¿ç¨‹ä¸å¤Ÿç”¨äº†ï¼Œä½†æ˜¯çº¿ç¨‹æ•°åˆæ²¡è¾¾åˆ°æé™ï¼Œæ‰ä¼šå»åˆ›å»ºæ–°çš„çº¿ç¨‹ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆ Tomcat éœ€è¦ç»´æŠ¤å·²æäº¤ä»»åŠ¡æ•°è¿™ä¸ªå˜é‡ï¼Œå®ƒçš„ç›®çš„å°±æ˜¯<strong>åœ¨ä»»åŠ¡é˜Ÿåˆ—çš„é•¿åº¦æ— é™åˆ¶çš„æƒ…å†µä¸‹ï¼Œè®©çº¿ç¨‹æ± æœ‰æœºä¼šåˆ›å»ºæ–°çš„çº¿ç¨‹</strong>ã€‚</p>
<p>å½“ç„¶é»˜è®¤æƒ…å†µä¸‹ Tomcat çš„ä»»åŠ¡é˜Ÿåˆ—æ˜¯æ²¡æœ‰é™åˆ¶çš„ï¼Œä½ å¯ä»¥é€šè¿‡è®¾ç½® maxQueueSize å‚æ•°æ¥é™åˆ¶ä»»åŠ¡é˜Ÿåˆ—çš„é•¿åº¦ã€‚</p>
<h2 id="5-WebSocket-ç»„ä»¶"><a href="#5-WebSocket-ç»„ä»¶" class="headerlink" title="5. WebSocket ç»„ä»¶"></a>5. WebSocket ç»„ä»¶</h2><p>HTTP åè®®æ˜¯â€œè¯·æ±‚ - å“åº”â€æ¨¡å¼ï¼Œæµè§ˆå™¨å¿…é¡»å…ˆå‘è¯·æ±‚ç»™æœåŠ¡å™¨ï¼ŒæœåŠ¡å™¨æ‰ä¼šå“åº”è¿™ä¸ªè¯·æ±‚ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒæœåŠ¡å™¨ä¸ä¼šä¸»åŠ¨å‘é€æ•°æ®ç»™æµè§ˆå™¨ã€‚</p>
<p>å¯¹äºå®æ—¶æ€§è¦æ±‚æ¯”è¾ƒçš„é«˜çš„åº”ç”¨ï¼Œæ¯”å¦‚åœ¨çº¿æ¸¸æˆã€è‚¡ç¥¨åŸºé‡‘å®æ—¶æŠ¥ä»·å’Œåœ¨çº¿ååŒç¼–è¾‘ç­‰ï¼Œæµè§ˆå™¨éœ€è¦å®æ—¶æ˜¾ç¤ºæœåŠ¡å™¨ä¸Šæœ€æ–°çš„æ•°æ®ï¼Œå› æ­¤å‡ºç°äº† Ajax å’Œ Comet æŠ€æœ¯ã€‚Ajax æœ¬è´¨ä¸Šè¿˜æ˜¯è½®è¯¢ï¼Œè€Œ Comet æ˜¯åœ¨ HTTP é•¿è¿æ¥çš„åŸºç¡€ä¸Šåšäº†ä¸€äº› hackï¼Œä½†æ˜¯å®ƒä»¬çš„å®æ—¶æ€§ä¸é«˜ï¼Œå¦å¤–é¢‘ç¹çš„è¯·æ±‚ä¼šç»™æœåŠ¡å™¨å¸¦æ¥å‹åŠ›ï¼Œä¹Ÿä¼šæµªè´¹ç½‘ç»œæµé‡å’Œå¸¦å®½ã€‚äºæ˜¯ HTML5 æ¨å‡ºäº† WebSocket æ ‡å‡†ï¼Œä½¿å¾—æµè§ˆå™¨å’ŒæœåŠ¡å™¨ä¹‹é—´ä»»ä½•ä¸€æ–¹éƒ½å¯ä»¥ä¸»åŠ¨å‘æ¶ˆæ¯ç»™å¯¹æ–¹ï¼Œè¿™æ ·æœåŠ¡å™¨æœ‰æ–°æ•°æ®æ—¶å¯ä»¥ä¸»åŠ¨æ¨é€ç»™æµè§ˆå™¨ã€‚</p>
<p>Tomcat å¦‚ä½•æ”¯æŒ WebSocketï¼Ÿç®€å•æ¥è¯´ï¼ŒTomcat åšäº†ä¸¤ä»¶äº‹ï¼š</p>
<ul>
<li>Endpoint åŠ è½½</li>
<li>WebSocket è¯·æ±‚å¤„ç†</li>
</ul>
<h3 id="5-1-WebSocket-åŠ è½½"><a href="#5-1-WebSocket-åŠ è½½" class="headerlink" title="5.1. WebSocket åŠ è½½"></a>5.1. WebSocket åŠ è½½</h3><p>Tomcat çš„ WebSocket åŠ è½½æ˜¯é€šè¿‡ SCI æœºåˆ¶å®Œæˆçš„ã€‚SCI å…¨ç§° ServletContainerInitializerï¼Œæ˜¯ Servlet 3.0 è§„èŒƒä¸­å®šä¹‰çš„ç”¨æ¥<strong>æ¥æ”¶ Web åº”ç”¨å¯åŠ¨äº‹ä»¶çš„æ¥å£</strong>ã€‚é‚£ä¸ºä»€ä¹ˆè¦ç›‘å¬ Servlet å®¹å™¨çš„å¯åŠ¨äº‹ä»¶å‘¢ï¼Ÿå› ä¸ºè¿™æ ·æˆ‘ä»¬æœ‰æœºä¼šåœ¨ Web åº”ç”¨å¯åŠ¨æ—¶åšä¸€äº›åˆå§‹åŒ–å·¥ä½œï¼Œæ¯”å¦‚ WebSocket éœ€è¦æ‰«æå’ŒåŠ è½½ Endpoint ç±»ã€‚SCI çš„ä½¿ç”¨ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œå°†å®ç° ServletContainerInitializer æ¥å£çš„ç±»å¢åŠ  HandlesTypes æ³¨è§£ï¼Œå¹¶ä¸”åœ¨æ³¨è§£å†…æŒ‡å®šçš„ä¸€ç³»åˆ—ç±»å’Œæ¥å£é›†åˆã€‚æ¯”å¦‚ Tomcat ä¸ºäº†æ‰«æå’ŒåŠ è½½ Endpoint è€Œå®šä¹‰çš„ SCI ç±»å¦‚ä¸‹ï¼š</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@HandlesTypes(&#123;ServerEndpoint.<span class="keyword">class</span>, ServerApplicationConfig.<span class="keyword">class</span>, Endpoint.<span class="keyword">class</span>&#125;)</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> WsSci <span class="keyword">implements</span> ServletContainerInitializer &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> onStartup(Set&lt;<span class="keyword">Class</span>&lt;?&gt;&gt; clazzes, ServletContext ctx) <span class="keyword">throws</span> ServletException &#123;</span><br><span class="line">  ...</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸€æ—¦å®šä¹‰å¥½äº† SCIï¼ŒTomcat åœ¨å¯åŠ¨é˜¶æ®µæ‰«æç±»æ—¶ï¼Œä¼šå°† HandlesTypes æ³¨è§£ä¸­æŒ‡å®šçš„ç±»éƒ½æ‰«æå‡ºæ¥ï¼Œä½œä¸º SCI çš„ onStartup æ–¹æ³•çš„å‚æ•°ï¼Œå¹¶è°ƒç”¨ SCI çš„ onStartup æ–¹æ³•ã€‚æ³¨æ„åˆ° WsSci çš„ HandlesTypes æ³¨è§£ä¸­å®šä¹‰äº†<code>ServerEndpoint.class</code>ã€<code>ServerApplicationConfig.class</code>å’Œ<code>Endpoint.class</code>ï¼Œå› æ­¤åœ¨ Tomcat çš„å¯åŠ¨é˜¶æ®µä¼šå°†è¿™äº›ç±»çš„ç±»å®ä¾‹ï¼ˆæ³¨æ„ä¸æ˜¯å¯¹è±¡å®ä¾‹ï¼‰ä¼ é€’ç»™ WsSci çš„ onStartup æ–¹æ³•ã€‚é‚£ä¹ˆ WsSci çš„ onStartup æ–¹æ³•åˆåšäº†ä»€ä¹ˆäº‹å‘¢ï¼Ÿ</p>
<p>å®ƒä¼šæ„é€ ä¸€ä¸ª WebSocketContainer å®ä¾‹ï¼Œä½ å¯ä»¥æŠŠ WebSocketContainer ç†è§£æˆä¸€ä¸ªä¸“é—¨å¤„ç† WebSocket è¯·æ±‚çš„<strong>Endpoint å®¹å™¨</strong>ã€‚ä¹Ÿå°±æ˜¯è¯´ Tomcat ä¼šæŠŠæ‰«æåˆ°çš„ Endpoint å­ç±»å’Œæ·»åŠ äº†æ³¨è§£<code>@ServerEndpoint</code>çš„ç±»æ³¨å†Œåˆ°è¿™ä¸ªå®¹å™¨ä¸­ï¼Œå¹¶ä¸”è¿™ä¸ªå®¹å™¨è¿˜ç»´æŠ¤äº† URL åˆ° Endpoint çš„æ˜ å°„å…³ç³»ï¼Œè¿™æ ·é€šè¿‡è¯·æ±‚ URL å°±èƒ½æ‰¾åˆ°å…·ä½“çš„ Endpoint æ¥å¤„ç† WebSocket è¯·æ±‚ã€‚</p>
<h3 id="5-2-WebSocket-è¯·æ±‚å¤„ç†"><a href="#5-2-WebSocket-è¯·æ±‚å¤„ç†" class="headerlink" title="5.2. WebSocket è¯·æ±‚å¤„ç†"></a>5.2. WebSocket è¯·æ±‚å¤„ç†</h3><p>Tomcat ç”¨ ProtocolHandler ç»„ä»¶å±è”½åº”ç”¨å±‚åè®®çš„å·®å¼‚ï¼Œå…¶ä¸­ ProtocolHandler ä¸­æœ‰ä¸¤ä¸ªå…³é”®ç»„ä»¶ï¼šEndpoint å’Œ Processorã€‚éœ€è¦æ³¨æ„ï¼Œè¿™é‡Œçš„ Endpoint è·Ÿä¸Šæ–‡æåˆ°çš„ WebSocket ä¸­çš„ Endpoint å®Œå…¨æ˜¯ä¸¤å›äº‹ï¼Œè¿æ¥å™¨ä¸­çš„ Endpoint ç»„ä»¶ç”¨æ¥å¤„ç† I&#x2F;O é€šä¿¡ã€‚WebSocket æœ¬è´¨å°±æ˜¯ä¸€ä¸ªåº”ç”¨å±‚åè®®ï¼Œå› æ­¤ä¸èƒ½ç”¨ HttpProcessor æ¥å¤„ç† WebSocket è¯·æ±‚ï¼Œè€Œè¦ç”¨ä¸“é—¨ Processor æ¥å¤„ç†ï¼Œè€Œåœ¨ Tomcat ä¸­è¿™æ ·çš„ Processor å«ä½œ UpgradeProcessorã€‚</p>
<p>ä¸ºä»€ä¹ˆå« Upgrade Processor å‘¢ï¼Ÿè¿™æ˜¯å› ä¸º Tomcat æ˜¯å°† HTTP åè®®å‡çº§æˆ WebSocket åè®®çš„ã€‚</p>
<p>WebSocket æ˜¯é€šè¿‡ HTTP åè®®æ¥è¿›è¡Œæ¡æ‰‹çš„ï¼Œå› æ­¤å½“ WebSocket çš„æ¡æ‰‹è¯·æ±‚åˆ°æ¥æ—¶ï¼ŒHttpProtocolHandler é¦–å…ˆæ¥æ”¶åˆ°è¿™ä¸ªè¯·æ±‚ï¼Œåœ¨å¤„ç†è¿™ä¸ª HTTP è¯·æ±‚æ—¶ï¼ŒTomcat é€šè¿‡ä¸€ä¸ªç‰¹æ®Šçš„ Filter åˆ¤æ–­è¯¥å½“å‰ HTTP è¯·æ±‚æ˜¯å¦æ˜¯ä¸€ä¸ª WebSocket Upgrade è¯·æ±‚ï¼ˆå³åŒ…å«<code>Upgrade: websocket</code>çš„ HTTP å¤´ä¿¡æ¯ï¼‰ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™åœ¨ HTTP å“åº”é‡Œæ·»åŠ  WebSocket ç›¸å…³çš„å“åº”å¤´ä¿¡æ¯ï¼Œå¹¶è¿›è¡Œåè®®å‡çº§ã€‚å…·ä½“æ¥è¯´å°±æ˜¯ç”¨ UpgradeProtocolHandler æ›¿æ¢å½“å‰çš„ HttpProtocolHandlerï¼Œç›¸åº”çš„ï¼ŒæŠŠå½“å‰ Socket çš„ Processor æ›¿æ¢æˆ UpgradeProcessorï¼ŒåŒæ—¶ Tomcat ä¼šåˆ›å»º WebSocket Session å®ä¾‹å’Œ Endpoint å®ä¾‹ï¼Œå¹¶è·Ÿå½“å‰çš„ WebSocket è¿æ¥ä¸€ä¸€å¯¹åº”èµ·æ¥ã€‚è¿™ä¸ª WebSocket è¿æ¥ä¸ä¼šç«‹å³å…³é—­ï¼Œå¹¶ä¸”åœ¨è¯·æ±‚å¤„ç†ä¸­ï¼Œä¸å†ä½¿ç”¨åŸæœ‰çš„ HttpProcessorï¼Œè€Œæ˜¯ç”¨ä¸“é—¨çš„ UpgradeProcessorï¼ŒUpgradeProcessor æœ€ç»ˆä¼šè°ƒç”¨ç›¸åº”çš„ Endpoint å®ä¾‹æ¥å¤„ç†è¯·æ±‚ã€‚</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/20201127153521.jpg" alt="img"></p>
<p>ä½ å¯ä»¥çœ‹åˆ°ï¼ŒTomcat å¯¹ WebSocket è¯·æ±‚çš„å¤„ç†æ²¡æœ‰ç»è¿‡ Servlet å®¹å™¨ï¼Œè€Œæ˜¯é€šè¿‡ UpgradeProcessor ç»„ä»¶ç›´æ¥æŠŠè¯·æ±‚å‘åˆ° ServerEndpoint å®ä¾‹ï¼Œå¹¶ä¸” Tomcat çš„ WebSocket å®ç°ä¸éœ€è¦å…³æ³¨å…·ä½“ I&#x2F;O æ¨¡å‹çš„ç»†èŠ‚ï¼Œä»è€Œå®ç°äº†ä¸å…·ä½“ I&#x2F;O æ–¹å¼çš„è§£è€¦ã€‚</p>
<h2 id="6-å‚è€ƒèµ„æ–™"><a href="#6-å‚è€ƒèµ„æ–™" class="headerlink" title="6. å‚è€ƒèµ„æ–™"></a>6. å‚è€ƒèµ„æ–™</h2><ul>
<li><strong>å®˜æ–¹</strong><ul>
<li><a target="_blank" rel="noopener" href="http://tomcat.apache.org/">Tomcat å®˜æ–¹ç½‘ç«™</a></li>
<li><a target="_blank" rel="noopener" href="http://wiki.apache.org/tomcat/FrontPage">Tomcat Wiki</a></li>
<li><a target="_blank" rel="noopener" href="http://tomee.apache.org/">Tomee å®˜æ–¹ç½‘ç«™</a></li>
</ul>
</li>
<li><strong>æ•™ç¨‹</strong><ul>
<li><a target="_blank" rel="noopener" href="https://time.geekbang.org/column/intro/100027701">æ·±å…¥æ‹†è§£ Tomcat &amp; Jetty</a></li>
</ul>
</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://dunwu.github.io/blog/pages/a6eabb5c/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/uploads/avatar.gif">
      <meta itemprop="name" content="é’æ‚Ÿ â—¾ Dunwu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dunwu Blog">
      <meta itemprop="description" content="é’æ‚Ÿçš„ä¸ªäººåšå®¢">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Dunwu Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/pages/a6eabb5c/" class="post-title-link" itemprop="url">Tomcatä¼˜åŒ–</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2022-02-17 22:34:30" itemprop="dateCreated datePublished" datetime="2022-02-17T22:34:30+08:00">2022-02-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">æ›´æ–°äº</span>
      <time title="ä¿®æ”¹æ—¶é—´ï¼š2025-09-13 17:56:53" itemprop="dateModified" datetime="2025-09-13T17:56:53+08:00">2025-09-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
        </span>
          ï¼Œ
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/JavaEE/" itemprop="url" rel="index"><span itemprop="name">JavaEE</span></a>
        </span>
          ï¼Œ
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/JavaEE/%E6%9C%8D%E5%8A%A1%E5%99%A8/" itemprop="url" rel="index"><span itemprop="name">æœåŠ¡å™¨</span></a>
        </span>
          ï¼Œ
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/JavaEE/%E6%9C%8D%E5%8A%A1%E5%99%A8/Tomcat/" itemprop="url" rel="index"><span itemprop="name">Tomcat</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
      <span>4k</span>
    </span>
    <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
      <span>4 åˆ†é’Ÿ</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Tomcat-ä¼˜åŒ–"><a href="#Tomcat-ä¼˜åŒ–" class="headerlink" title="Tomcat ä¼˜åŒ–"></a>Tomcat ä¼˜åŒ–</h1><h2 id="Tomcat-å¯åŠ¨ä¼˜åŒ–"><a href="#Tomcat-å¯åŠ¨ä¼˜åŒ–" class="headerlink" title="Tomcat å¯åŠ¨ä¼˜åŒ–"></a>Tomcat å¯åŠ¨ä¼˜åŒ–</h2><p>å¦‚æœ Tomcat å¯åŠ¨æ¯”è¾ƒæ…¢ï¼Œå¯ä»¥è€ƒè™‘ä¸€äº›ä¼˜åŒ–ç‚¹</p>
<h3 id="æ¸…ç†-Tomcat"><a href="#æ¸…ç†-Tomcat" class="headerlink" title="æ¸…ç† Tomcat"></a>æ¸…ç† Tomcat</h3><ul>
<li><strong>æ¸…ç†ä¸å¿…è¦çš„ Web åº”ç”¨</strong>ï¼šé¦–å…ˆæˆ‘ä»¬è¦åšçš„æ˜¯åˆ é™¤æ‰ webapps æ–‡ä»¶å¤¹ä¸‹ä¸éœ€è¦çš„å·¥ç¨‹ï¼Œä¸€èˆ¬æ˜¯ host-managerã€exampleã€doc ç­‰è¿™äº›é»˜è®¤çš„å·¥ç¨‹ï¼Œå¯èƒ½è¿˜æœ‰ä»¥å‰æ·»åŠ çš„ä½†ç°åœ¨ç”¨ä¸ç€çš„å·¥ç¨‹ï¼Œæœ€å¥½æŠŠè¿™äº›å…¨éƒ½åˆ é™¤æ‰ã€‚</li>
<li><strong>æ¸…ç† XML é…ç½®æ–‡ä»¶</strong>ï¼šTomcat åœ¨å¯åŠ¨æ—¶ä¼šè§£ææ‰€æœ‰çš„ XML é…ç½®æ–‡ä»¶ï¼Œè§£æ XML è¾ƒä¸ºè€—æ—¶ï¼Œæ‰€ä»¥åº”è¯¥å°½é‡ä¿æŒé…ç½®æ–‡ä»¶çš„ç®€æ´ã€‚</li>
<li><strong>æ¸…ç† JAR æ–‡ä»¶</strong>ï¼šJVM çš„ç±»åŠ è½½å™¨åœ¨åŠ è½½ç±»æ—¶ï¼Œéœ€è¦æŸ¥æ‰¾æ¯ä¸€ä¸ª JAR æ–‡ä»¶ï¼Œå»æ‰¾åˆ°æ‰€éœ€è¦çš„ç±»ã€‚å¦‚æœåˆ é™¤äº†ä¸éœ€è¦çš„ JAR æ–‡ä»¶ï¼ŒæŸ¥æ‰¾çš„é€Ÿåº¦å°±ä¼šå¿«ä¸€äº›ã€‚è¿™é‡Œè¯·æ³¨æ„ï¼š<strong>Web åº”ç”¨ä¸­çš„ lib ç›®å½•ä¸‹ä¸åº”è¯¥å‡ºç° Servlet API æˆ–è€… Tomcat è‡ªèº«çš„ JAR</strong>ï¼Œè¿™äº› JAR ç”± Tomcat è´Ÿè´£æä¾›ã€‚</li>
<li><strong>æ¸…ç†å…¶ä»–æ–‡ä»¶</strong>ï¼šåŠæ—¶æ¸…ç†æ—¥å¿—ï¼Œåˆ é™¤ logs æ–‡ä»¶å¤¹ä¸‹ä¸éœ€è¦çš„æ—¥å¿—æ–‡ä»¶ã€‚åŒæ ·è¿˜æœ‰ work æ–‡ä»¶å¤¹ä¸‹çš„ catalina æ–‡ä»¶å¤¹ï¼Œå®ƒå…¶å®æ˜¯ Tomcat æŠŠ JSP è½¬æ¢ä¸º Class æ–‡ä»¶çš„å·¥ä½œç›®å½•ã€‚æœ‰æ—¶å€™æˆ‘ä»¬ä¹Ÿè®¸ä¼šé‡åˆ°ä¿®æ”¹äº†ä»£ç ï¼Œé‡å¯äº† Tomcatï¼Œä½†æ˜¯ä»æ²¡æ•ˆæœï¼Œè¿™æ—¶å€™ä¾¿å¯ä»¥åˆ é™¤æ‰è¿™ä¸ªæ–‡ä»¶å¤¹ï¼ŒTomcat ä¸‹æ¬¡å¯åŠ¨çš„æ—¶å€™ä¼šé‡æ–°ç”Ÿæˆã€‚</li>
</ul>
<h3 id="ç¦æ­¢-Tomcat-TLD-æ‰«æ"><a href="#ç¦æ­¢-Tomcat-TLD-æ‰«æ" class="headerlink" title="ç¦æ­¢ Tomcat TLD æ‰«æ"></a>ç¦æ­¢ Tomcat TLD æ‰«æ</h3><p>Tomcat ä¸ºäº†æ”¯æŒ JSPï¼Œåœ¨åº”ç”¨å¯åŠ¨çš„æ—¶å€™ä¼šæ‰«æ JAR åŒ…é‡Œé¢çš„ TLD æ–‡ä»¶ï¼ŒåŠ è½½é‡Œé¢å®šä¹‰çš„æ ‡ç­¾åº“ã€‚æ‰€ä»¥åœ¨ Tomcat çš„å¯åŠ¨æ—¥å¿—é‡Œï¼Œä½ å¯èƒ½ä¼šç¢°åˆ°è¿™ç§æç¤ºï¼š</p>
<blockquote>
<p>At least one JAR was scanned for TLDs yet contained no TLDs. Enable debug logging for this logger for a complete list of JARs that were scanned but no TLDs were found in them. Skipping unneeded JARs during scanning can improve startup time and JSP compilation time.</p>
</blockquote>
<p>Tomcat çš„æ„æ€æ˜¯ï¼Œæˆ‘æ‰«æäº†ä½  Web åº”ç”¨ä¸‹çš„ JAR åŒ…ï¼Œå‘ç° JAR åŒ…é‡Œæ²¡æœ‰ TLD æ–‡ä»¶ã€‚æˆ‘å»ºè®®é…ç½®ä¸€ä¸‹ Tomcat ä¸è¦å»æ‰«æè¿™äº› JAR åŒ…ï¼Œè¿™æ ·å¯ä»¥æé«˜ Tomcat çš„å¯åŠ¨é€Ÿåº¦ï¼Œå¹¶èŠ‚çœ JSP ç¼–è¯‘æ—¶é—´ã€‚</p>
<p>å¦‚ä½•é…ç½®ä¸å»æ‰«æè¿™äº› JAR åŒ…å‘¢ï¼Œè¿™é‡Œåˆ†ä¸¤ç§æƒ…å†µï¼š</p>
<ul>
<li><p>å¦‚æœä½ çš„é¡¹ç›®æ²¡æœ‰ä½¿ç”¨ JSP ä½œä¸º Web é¡µé¢æ¨¡æ¿ï¼Œè€Œæ˜¯ä½¿ç”¨ Velocity ä¹‹ç±»çš„æ¨¡æ¿å¼•æ“ï¼Œä½ å®Œå…¨å¯ä»¥æŠŠ TLD æ‰«æç¦æ­¢æ‰ã€‚æ–¹æ³•æ˜¯ï¼Œæ‰¾åˆ° Tomcat çš„<code>conf/</code>ç›®å½•ä¸‹çš„<code>context.xml</code>æ–‡ä»¶ï¼Œåœ¨è¿™ä¸ªæ–‡ä»¶é‡Œ Context æ ‡ç­¾ä¸‹ï¼ŒåŠ ä¸Š<strong>JarScanner</strong>å’Œ<strong>JarScanFilter</strong>å­æ ‡ç­¾ï¼Œåƒä¸‹é¢è¿™æ ·ã€‚</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Context</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">JarScanner</span> &gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">JarScanFilter</span> <span class="attr">defaultTldScan</span>=<span class="string">&quot;true&quot;</span> <span class="attr">defaultpluggabilityScan</span>=<span class="string">&quot;true&quot;</span> /&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">JarScanner</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Context</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>å¦‚æœä½ çš„é¡¹ç›®ä½¿ç”¨äº† JSP ä½œä¸º Web é¡µé¢æ¨¡å—ï¼Œæ„å‘³ç€ TLD æ‰«ææ— æ³•é¿å…ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥é€šè¿‡é…ç½®æ¥å‘Šè¯‰ Tomcatï¼Œåªæ‰«æé‚£äº›åŒ…å« TLD æ–‡ä»¶çš„ JAR åŒ…ã€‚æ–¹æ³•æ˜¯ï¼Œæ‰¾åˆ° Tomcat çš„<code>conf/</code>ç›®å½•ä¸‹çš„<code>catalina.properties</code>æ–‡ä»¶ï¼Œåœ¨è¿™ä¸ªæ–‡ä»¶é‡Œçš„ jarsToSkip é…ç½®é¡¹ä¸­ï¼ŒåŠ ä¸Šä½ çš„ JAR åŒ…ã€‚</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tomcat<span class="selector-class">.util</span><span class="selector-class">.scan</span><span class="selector-class">.StandardJarScanFilter</span>.jarsToSkip=xxx.jar</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="å…³é—­-WebSocket-æ”¯æŒ"><a href="#å…³é—­-WebSocket-æ”¯æŒ" class="headerlink" title="å…³é—­ WebSocket æ”¯æŒ"></a>å…³é—­ WebSocket æ”¯æŒ</h3><p>Tomcat ä¼šæ‰«æ WebSocket æ³¨è§£çš„ API å®ç°ï¼Œæ¯”å¦‚ <code>@ServerEndpoint</code> æ³¨è§£çš„ç±»ã€‚å¦‚æœä¸éœ€è¦ä½¿ç”¨ WebSockets å°±å¯ä»¥å…³é—­å®ƒã€‚å…·ä½“æ–¹æ³•æ˜¯ï¼Œæ‰¾åˆ° Tomcat çš„ <code>conf/</code> ç›®å½•ä¸‹çš„ <code>context.xml</code> æ–‡ä»¶ï¼Œç»™ <code>Context</code> æ ‡ç­¾åŠ ä¸€ä¸ª <strong><code>containerSciFilter</code></strong> çš„å±æ€§ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Context</span> <span class="attr">containerSciFilter</span>=<span class="string">&quot;org.apache.tomcat.websocket.server.WsSci&quot;</span>&gt;</span></span><br><span class="line">...</span><br><span class="line"><span class="tag">&lt;/<span class="name">Context</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>æ›´è¿›ä¸€æ­¥ï¼Œå¦‚æœä½ ä¸éœ€è¦ WebSockets è¿™ä¸ªåŠŸèƒ½ï¼Œä½ å¯ä»¥æŠŠ Tomcat <code>lib</code> ç›®å½•ä¸‹çš„ <code>websocket-api.jar</code> å’Œ <code>tomcat-websocket.jar</code> è¿™ä¸¤ä¸ª JAR æ–‡ä»¶åˆ é™¤æ‰ï¼Œè¿›ä¸€æ­¥æé«˜æ€§èƒ½ã€‚</p>
<h3 id="å…³é—­-JSP-æ”¯æŒ"><a href="#å…³é—­-JSP-æ”¯æŒ" class="headerlink" title="å…³é—­ JSP æ”¯æŒ"></a>å…³é—­ JSP æ”¯æŒ</h3><p>å¦‚æœä¸éœ€è¦ä½¿ç”¨ JSPï¼Œå¯ä»¥å…³é—­ JSP åŠŸèƒ½ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Context</span> <span class="attr">containerSciFilter</span>=<span class="string">&quot;org.apache.jasper.servlet.JasperInitializer&quot;</span>&gt;</span></span><br><span class="line">...</span><br><span class="line"><span class="tag">&lt;/<span class="name">Context</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>å¦‚æœè¦åŒæ—¶å…³é—­ WebSocket å’Œ Jspï¼Œå¯ä»¥è¿™æ ·é…ç½®ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Context</span> <span class="attr">containerSciFilter</span>=<span class="string">&quot;org.apache.tomcat.websocket.server.WsSci | org.apache.jasper.servlet.JasperInitializer&quot;</span>&gt;</span></span><br><span class="line">...</span><br><span class="line"><span class="tag">&lt;/<span class="name">Context</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="ç¦æ­¢æ‰«æ-Servlet-æ³¨è§£"><a href="#ç¦æ­¢æ‰«æ-Servlet-æ³¨è§£" class="headerlink" title="ç¦æ­¢æ‰«æ Servlet æ³¨è§£"></a>ç¦æ­¢æ‰«æ Servlet æ³¨è§£</h3><p>Servlet 3.0 å¼•å…¥äº†æ³¨è§£ Servletï¼ŒTomcat ä¸ºäº†æ”¯æŒè¿™ä¸ªç‰¹æ€§ï¼Œä¼šåœ¨ Web åº”ç”¨å¯åŠ¨æ—¶æ‰«æä½ çš„ç±»æ–‡ä»¶ï¼Œå› æ­¤å¦‚æœä½ æ²¡æœ‰ä½¿ç”¨ Servlet æ³¨è§£è¿™ä¸ªåŠŸèƒ½ï¼Œå¯ä»¥å‘Šè¯‰ Tomcat ä¸è¦å»æ‰«æ Servlet æ³¨è§£ã€‚å…·ä½“é…ç½®æ–¹æ³•æ˜¯ï¼Œåœ¨ä½ çš„ Web åº”ç”¨çš„<code>web.xml</code>æ–‡ä»¶ä¸­ï¼Œè®¾ç½®<code>&lt;web-app&gt;</code>å…ƒç´ çš„å±æ€§<code>metadata-complete=&quot;true&quot;</code>ï¼Œåƒä¸‹é¢è¿™æ ·ã€‚</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">web-app</span> <span class="attr">metadata-complete</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>metadata-complete</code> çš„æ„æ€æ˜¯ï¼Œ<code>web.xml</code> é‡Œé…ç½®çš„ Servlet æ˜¯å®Œæ•´çš„ï¼Œä¸éœ€è¦å†å»åº“ç±»ä¸­æ‰¾ Servlet çš„å®šä¹‰ã€‚</p>
<h3 id="é…ç½®-Web-Fragment-æ‰«æ"><a href="#é…ç½®-Web-Fragment-æ‰«æ" class="headerlink" title="é…ç½® Web-Fragment æ‰«æ"></a>é…ç½® Web-Fragment æ‰«æ</h3><p>Servlet 3.0 è¿˜å¼•å…¥äº†â€œWeb æ¨¡å—éƒ¨ç½²æè¿°ç¬¦ç‰‡æ®µâ€çš„ <code>web-fragment.xml</code>ï¼Œè¿™æ˜¯ä¸€ä¸ªéƒ¨ç½²æè¿°æ–‡ä»¶ï¼Œå¯ä»¥å®Œæˆ <code>web.xml</code> çš„é…ç½®åŠŸèƒ½ã€‚è€Œè¿™ä¸ª <code>web-fragment.xml</code> æ–‡ä»¶å¿…é¡»å­˜æ”¾åœ¨ JAR æ–‡ä»¶çš„ <code>META-INF</code> ç›®å½•ä¸‹ï¼Œè€Œ JAR åŒ…é€šå¸¸æ”¾åœ¨ <code>WEB-INF/lib</code> ç›®å½•ä¸‹ï¼Œå› æ­¤ Tomcat éœ€è¦å¯¹ JAR æ–‡ä»¶è¿›è¡Œæ‰«ææ‰èƒ½æ”¯æŒè¿™ä¸ªåŠŸèƒ½ã€‚</p>
<p>å¯ä»¥é€šè¿‡é…ç½® <code>web.xml</code> é‡Œé¢çš„ <code>&lt;absolute-ordering&gt;</code> å…ƒç´ ç›´æ¥æŒ‡å®šäº†å“ªäº› JAR åŒ…éœ€è¦æ‰«æ <code>web fragment</code>ï¼Œå¦‚æœ <code>&lt;absolute-ordering/&gt;</code> å…ƒç´ æ˜¯ç©ºçš„ï¼Œ åˆ™è¡¨ç¤ºä¸éœ€è¦æ‰«æï¼Œåƒä¸‹é¢è¿™æ ·ã€‚</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">web-app</span> <span class="attr">metadata-complete</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">...</span><br><span class="line"><span class="tag">&lt;<span class="name">absolute-ordering</span> /&gt;</span></span><br><span class="line">...</span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="éšæœºæ•°ç†µæºä¼˜åŒ–"><a href="#éšæœºæ•°ç†µæºä¼˜åŒ–" class="headerlink" title="éšæœºæ•°ç†µæºä¼˜åŒ–"></a>éšæœºæ•°ç†µæºä¼˜åŒ–</h3><p>Tomcat 7 ä»¥ä¸Šçš„ç‰ˆæœ¬ä¾èµ– Java çš„ SecureRandom ç±»æ¥ç”Ÿæˆéšæœºæ•°ï¼Œæ¯”å¦‚ Session IDã€‚è€Œ JVM é»˜è®¤ä½¿ç”¨é˜»å¡å¼ç†µæºï¼ˆ<code>/dev/random</code>ï¼‰ï¼Œ åœ¨æŸäº›æƒ…å†µä¸‹å°±ä¼šå¯¼è‡´ Tomcat å¯åŠ¨å˜æ…¢ã€‚å½“é˜»å¡æ—¶é—´è¾ƒé•¿æ—¶ï¼Œ ä½ ä¼šçœ‹åˆ°è¿™æ ·ä¸€æ¡è­¦å‘Šæ—¥å¿—ï¼š</p>
<figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;DATE&gt; org.apache.catalina.util.SessionIdGenerator createSecureRandom</span><br><span class="line">INFO: Creation of SecureRandom<span class="built_in"> instance </span>for session ID generation using [SHA1PRNG] took [8152] milliseconds.</span><br></pre></td></tr></table></figure>

<p>è§£å†³æ–¹æ¡ˆæ˜¯é€šè¿‡è®¾ç½®ï¼Œè®© JVM ä½¿ç”¨éé˜»å¡å¼çš„ç†µæºã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥è®¾ç½® JVM çš„å‚æ•°ï¼š</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-Djava.security.egd=<span class="keyword">file</span>:<span class="regexp">/dev/</span>./urandom</span><br></pre></td></tr></table></figure>

<p>æˆ–è€…æ˜¯è®¾ç½® <code>java.security</code> æ–‡ä»¶ï¼Œä½äº <code>$JAVA_HOME/jre/lib/security</code> ç›®å½•ä¹‹ä¸‹ï¼š <code>securerandom.source=file:/dev/./urandom</code></p>
<p>è¿™é‡Œè¯·ä½ æ³¨æ„ï¼Œ<code>/dev/./urandom</code> ä¸­é—´æœ‰ä¸ª <code>./</code> çš„åŸå› æ˜¯ Oracle JRE ä¸­çš„ Bugï¼ŒJava 8 é‡Œé¢çš„ SecureRandom ç±»å·²ç»ä¿®æ­£è¿™ä¸ª Bugã€‚ é˜»å¡å¼çš„ç†µæºï¼ˆ<code>/dev/random</code>ï¼‰å®‰å…¨æ€§è¾ƒé«˜ï¼Œ éé˜»å¡å¼çš„ç†µæºï¼ˆ<code>/dev/./urandom</code>ï¼‰å®‰å…¨æ€§ä¼šä½ä¸€äº›ï¼Œå› ä¸ºå¦‚æœä½ å¯¹éšæœºæ•°çš„è¦æ±‚æ¯”è¾ƒé«˜ï¼Œ å¯ä»¥è€ƒè™‘ä½¿ç”¨ç¡¬ä»¶æ–¹å¼ç”Ÿæˆç†µæºã€‚</p>
<h3 id="å¹¶è¡Œå¯åŠ¨å¤šä¸ª-Web-åº”ç”¨"><a href="#å¹¶è¡Œå¯åŠ¨å¤šä¸ª-Web-åº”ç”¨" class="headerlink" title="å¹¶è¡Œå¯åŠ¨å¤šä¸ª Web åº”ç”¨"></a>å¹¶è¡Œå¯åŠ¨å¤šä¸ª Web åº”ç”¨</h3><p>Tomcat å¯åŠ¨çš„æ—¶å€™ï¼Œé»˜è®¤æƒ…å†µä¸‹ Web åº”ç”¨éƒ½æ˜¯ä¸€ä¸ªä¸€ä¸ªå¯åŠ¨çš„ï¼Œç­‰æ‰€æœ‰ Web åº”ç”¨å…¨éƒ¨å¯åŠ¨å®Œæˆï¼ŒTomcat æ‰ç®—å¯åŠ¨å®Œæ¯•ã€‚å¦‚æœåœ¨ä¸€ä¸ª Tomcat ä¸‹æœ‰å¤šä¸ª Web åº”ç”¨ï¼Œä¸ºäº†ä¼˜åŒ–å¯åŠ¨é€Ÿåº¦ï¼Œä½ å¯ä»¥é…ç½®å¤šä¸ªåº”ç”¨ç¨‹åºå¹¶è¡Œå¯åŠ¨ï¼Œå¯ä»¥é€šè¿‡ä¿®æ”¹ <code>server.xml</code> ä¸­ Host å…ƒç´ çš„ <code>startStopThreads</code> å±æ€§æ¥å®Œæˆã€‚<code>startStopThreads</code> çš„å€¼è¡¨ç¤ºä½ æƒ³ç”¨å¤šå°‘ä¸ªçº¿ç¨‹æ¥å¯åŠ¨ä½ çš„ Web åº”ç”¨ï¼Œå¦‚æœè®¾æˆ 0 è¡¨ç¤ºä½ è¦å¹¶è¡Œå¯åŠ¨ Web åº”ç”¨ï¼Œåƒä¸‹é¢è¿™æ ·çš„é…ç½®ã€‚</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Engine</span> <span class="attr">startStopThreads</span>=<span class="string">&quot;0&quot;</span>&gt;</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="tag">&lt;<span class="name">Host</span> <span class="attr">startStopThreads</span>=<span class="string">&quot;0&quot;</span>&gt;</span></span><br><span class="line">        ...</span><br><span class="line">    <span class="tag">&lt;/<span class="name">Host</span>&gt;</span></span><br><span class="line">    ...</span><br><span class="line"><span class="tag">&lt;/<span class="name">Engine</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒEngine å…ƒç´ é‡Œä¹Ÿé…ç½®äº†è¿™ä¸ªå‚æ•°ï¼Œè¿™æ„å‘³ç€å¦‚æœä½ çš„ Tomcat é…ç½®äº†å¤šä¸ª Hostï¼ˆè™šæ‹Ÿä¸»æœºï¼‰ï¼ŒTomcat ä¼šä»¥å¹¶è¡Œçš„æ–¹å¼å¯åŠ¨å¤šä¸ª Hostã€‚</p>
<h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ul>
<li><strong>å®˜æ–¹</strong><ul>
<li><a target="_blank" rel="noopener" href="http://tomcat.apache.org/">Tomcat å®˜æ–¹ç½‘ç«™</a></li>
<li><a target="_blank" rel="noopener" href="http://wiki.apache.org/tomcat/FrontPage">Tomcat Wiki</a></li>
<li><a target="_blank" rel="noopener" href="http://tomee.apache.org/">Tomee å®˜æ–¹ç½‘ç«™</a></li>
</ul>
</li>
<li><strong>æ•™ç¨‹</strong><ul>
<li><a target="_blank" rel="noopener" href="https://time.geekbang.org/column/intro/100027701">æ·±å…¥æ‹†è§£ Tomcat &amp; Jetty</a></li>
</ul>
</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://dunwu.github.io/blog/pages/678f0b0e/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/uploads/avatar.gif">
      <meta itemprop="name" content="é’æ‚Ÿ â—¾ Dunwu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dunwu Blog">
      <meta itemprop="description" content="é’æ‚Ÿçš„ä¸ªäººåšå®¢">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Dunwu Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/pages/678f0b0e/" class="post-title-link" itemprop="url">Tomcatå®¹å™¨</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2022-02-17 22:34:30" itemprop="dateCreated datePublished" datetime="2022-02-17T22:34:30+08:00">2022-02-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">æ›´æ–°äº</span>
      <time title="ä¿®æ”¹æ—¶é—´ï¼š2025-09-13 17:56:53" itemprop="dateModified" datetime="2025-09-13T17:56:53+08:00">2025-09-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
        </span>
          ï¼Œ
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/JavaEE/" itemprop="url" rel="index"><span itemprop="name">JavaEE</span></a>
        </span>
          ï¼Œ
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/JavaEE/%E6%9C%8D%E5%8A%A1%E5%99%A8/" itemprop="url" rel="index"><span itemprop="name">æœåŠ¡å™¨</span></a>
        </span>
          ï¼Œ
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/JavaEE/%E6%9C%8D%E5%8A%A1%E5%99%A8/Tomcat/" itemprop="url" rel="index"><span itemprop="name">Tomcat</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
      <span>20k</span>
    </span>
    <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
      <span>18 åˆ†é’Ÿ</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Tomcat-å®¹å™¨"><a href="#Tomcat-å®¹å™¨" class="headerlink" title="Tomcat å®¹å™¨"></a>Tomcat å®¹å™¨</h1><h2 id="Tomcat-å®ç°çƒ­éƒ¨ç½²å’Œçƒ­åŠ è½½"><a href="#Tomcat-å®ç°çƒ­éƒ¨ç½²å’Œçƒ­åŠ è½½" class="headerlink" title="Tomcat å®ç°çƒ­éƒ¨ç½²å’Œçƒ­åŠ è½½"></a>Tomcat å®ç°çƒ­éƒ¨ç½²å’Œçƒ­åŠ è½½</h2><ul>
<li>çƒ­åŠ è½½çš„å®ç°æ–¹å¼æ˜¯ Web å®¹å™¨å¯åŠ¨ä¸€ä¸ªåå°çº¿ç¨‹ï¼Œå®šæœŸæ£€æµ‹ç±»æ–‡ä»¶çš„å˜åŒ–ï¼Œå¦‚æœæœ‰å˜åŒ–ï¼Œå°±é‡æ–°åŠ è½½ç±»ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ä¸ä¼šæ¸…ç©º Session ï¼Œä¸€èˆ¬ç”¨åœ¨å¼€å‘ç¯å¢ƒã€‚</li>
<li>çƒ­éƒ¨ç½²åŸç†ç±»ä¼¼ï¼Œä¹Ÿæ˜¯ç”±åå°çº¿ç¨‹å®šæ—¶æ£€æµ‹ Web åº”ç”¨çš„å˜åŒ–ï¼Œä½†å®ƒä¼šé‡æ–°åŠ è½½æ•´ä¸ª Web åº”ç”¨ã€‚è¿™ç§æ–¹å¼ä¼šæ¸…ç©º Sessionï¼Œæ¯”çƒ­åŠ è½½æ›´åŠ å¹²å‡€ã€å½»åº•ï¼Œä¸€èˆ¬ç”¨åœ¨ç”Ÿäº§ç¯å¢ƒã€‚</li>
</ul>
<p>Tomcat é€šè¿‡å¼€å¯åå°çº¿ç¨‹ï¼Œä½¿å¾—å„ä¸ªå±‚æ¬¡çš„å®¹å™¨ç»„ä»¶éƒ½æœ‰æœºä¼šå®Œæˆä¸€äº›å‘¨æœŸæ€§ä»»åŠ¡ã€‚Tomcat æ˜¯åŸºäº ScheduledThreadPoolExecutor å®ç°å‘¨æœŸæ€§ä»»åŠ¡çš„ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">bgFuture = exec.scheduleWithFixedDelay(</span><br><span class="line">              <span class="keyword">new</span> <span class="title class_">ContainerBackgroundProcessor</span>(),<span class="comment">// è¦æ‰§è¡Œçš„ Runnable</span></span><br><span class="line">              backgroundProcessorDelay, <span class="comment">// ç¬¬ä¸€æ¬¡æ‰§è¡Œå»¶è¿Ÿå¤šä¹…</span></span><br><span class="line">              backgroundProcessorDelay, <span class="comment">// ä¹‹åæ¯æ¬¡æ‰§è¡Œé—´éš”å¤šä¹…</span></span><br><span class="line">              TimeUnit.SECONDS);        <span class="comment">// æ—¶é—´å•ä½</span></span><br></pre></td></tr></table></figure>

<p>ç¬¬ä¸€ä¸ªå‚æ•°å°±æ˜¯è¦å‘¨æœŸæ€§æ‰§è¡Œçš„ä»»åŠ¡ç±» ContainerBackgroundProcessorï¼Œå®ƒæ˜¯ä¸€ä¸ª Runnableï¼ŒåŒæ—¶ä¹Ÿæ˜¯ ContainerBase çš„å†…éƒ¨ç±»ï¼ŒContainerBase æ˜¯æ‰€æœ‰å®¹å™¨ç»„ä»¶çš„åŸºç±»ï¼Œæˆ‘ä»¬æ¥å›å¿†ä¸€ä¸‹å®¹å™¨ç»„ä»¶æœ‰å“ªäº›ï¼Œæœ‰ Engineã€Hostã€Context å’Œ Wrapper ç­‰ï¼Œå®ƒä»¬å…·æœ‰çˆ¶å­å…³ç³»ã€‚</p>
<h3 id="ContainerBackgroundProcessor-å®ç°"><a href="#ContainerBackgroundProcessor-å®ç°" class="headerlink" title="ContainerBackgroundProcessor å®ç°"></a>ContainerBackgroundProcessor å®ç°</h3><p>æˆ‘ä»¬æ¥æ¥çœ‹ ContainerBackgroundProcessor å…·ä½“æ˜¯å¦‚ä½•å®ç°çš„ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">class</span> <span class="title class_">ContainerBackgroundProcessor</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// è¯·æ³¨æ„è¿™é‡Œä¼ å…¥çš„å‚æ•°æ˜¯ &quot; å®¿ä¸»ç±» &quot; çš„å®ä¾‹</span></span><br><span class="line">        processChildren(ContainerBase.<span class="built_in">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">processChildren</span><span class="params">(Container container)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//1. è°ƒç”¨å½“å‰å®¹å™¨çš„ backgroundProcess æ–¹æ³•ã€‚</span></span><br><span class="line">            container.backgroundProcess();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//2. éå†æ‰€æœ‰çš„å­å®¹å™¨ï¼Œé€’å½’è°ƒç”¨ processChildrenï¼Œ</span></span><br><span class="line">            <span class="comment">// è¿™æ ·å½“å‰å®¹å™¨çš„å­å­™éƒ½ä¼šè¢«å¤„ç†</span></span><br><span class="line">            Container[] children = container.findChildren();</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; children.length; i++) &#123;</span><br><span class="line">            <span class="comment">// è¿™é‡Œè¯·ä½ æ³¨æ„ï¼Œå®¹å™¨åŸºç±»æœ‰ä¸ªå˜é‡å«åš backgroundProcessorDelayï¼Œå¦‚æœå¤§äº 0ï¼Œè¡¨æ˜å­å®¹å™¨æœ‰è‡ªå·±çš„åå°çº¿ç¨‹ï¼Œæ— éœ€çˆ¶å®¹å™¨æ¥è°ƒç”¨å®ƒçš„ processChildren æ–¹æ³•ã€‚</span></span><br><span class="line">                <span class="keyword">if</span> (children[i].getBackgroundProcessorDelay() &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    processChildren(children[i]);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123; ... &#125;</span><br></pre></td></tr></table></figure>

<p>ä¸Šé¢çš„ä»£ç é€»è¾‘ä¹Ÿæ˜¯æ¯”è¾ƒæ¸…æ™°çš„ï¼Œé¦–å…ˆ ContainerBackgroundProcessor æ˜¯ä¸€ä¸ª Runnableï¼Œå®ƒéœ€è¦å®ç° run æ–¹æ³•ï¼Œå®ƒçš„ run å¾ˆç®€å•ï¼Œå°±æ˜¯è°ƒç”¨äº† processChildren æ–¹æ³•ã€‚è¿™é‡Œæœ‰ä¸ªå°æŠ€å·§ï¼Œå®ƒæŠŠâ€œå®¿ä¸»ç±»â€ï¼Œä¹Ÿå°±æ˜¯<strong>ContainerBase çš„ç±»å®ä¾‹å½“æˆå‚æ•°ä¼ ç»™äº† run æ–¹æ³•</strong>ã€‚</p>
<p>è€Œåœ¨ processChildren æ–¹æ³•é‡Œï¼Œå°±åšäº†ä¸¤æ­¥ï¼šè°ƒç”¨å½“å‰å®¹å™¨çš„ backgroundProcess æ–¹æ³•ï¼Œä»¥åŠé€’å½’è°ƒç”¨å­å­™çš„ backgroundProcess æ–¹æ³•ã€‚è¯·ä½ æ³¨æ„ backgroundProcess æ˜¯ Container æ¥å£ä¸­çš„æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯è¯´æ‰€æœ‰ç±»å‹çš„å®¹å™¨éƒ½å¯ä»¥å®ç°è¿™ä¸ªæ–¹æ³•ï¼Œåœ¨è¿™ä¸ªæ–¹æ³•é‡Œå®Œæˆéœ€è¦å‘¨æœŸæ€§æ‰§è¡Œçš„ä»»åŠ¡ã€‚</p>
<p>è¿™æ ·çš„è®¾è®¡æ„å‘³ç€ä»€ä¹ˆå‘¢ï¼Ÿæˆ‘ä»¬åªéœ€è¦åœ¨é¡¶å±‚å®¹å™¨ï¼Œä¹Ÿå°±æ˜¯ Engine å®¹å™¨ä¸­å¯åŠ¨ä¸€ä¸ªåå°çº¿ç¨‹ï¼Œé‚£ä¹ˆè¿™ä¸ªçº¿ç¨‹<strong>ä¸ä½†ä¼šæ‰§è¡Œ Engine å®¹å™¨çš„å‘¨æœŸæ€§ä»»åŠ¡ï¼Œå®ƒè¿˜ä¼šæ‰§è¡Œæ‰€æœ‰å­å®¹å™¨çš„å‘¨æœŸæ€§ä»»åŠ¡</strong>ã€‚</p>
<h3 id="backgroundProcess-æ–¹æ³•"><a href="#backgroundProcess-æ–¹æ³•" class="headerlink" title="backgroundProcess æ–¹æ³•"></a>backgroundProcess æ–¹æ³•</h3><p>ä¸Šè¿°ä»£ç éƒ½æ˜¯åœ¨åŸºç±» ContainerBase ä¸­å®ç°çš„ï¼Œé‚£å…·ä½“å®¹å™¨ç±»éœ€è¦åšä»€ä¹ˆå‘¢ï¼Ÿå…¶å®å¾ˆç®€å•ï¼Œå¦‚æœæœ‰å‘¨æœŸæ€§ä»»åŠ¡è¦æ‰§è¡Œï¼Œå°±å®ç° backgroundProcess æ–¹æ³•ï¼›å¦‚æœæ²¡æœ‰ï¼Œå°±é‡ç”¨åŸºç±» ContainerBase çš„æ–¹æ³•ã€‚ContainerBase çš„ backgroundProcess æ–¹æ³•å®ç°å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">backgroundProcess</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//1. æ‰§è¡Œå®¹å™¨ä¸­ Cluster ç»„ä»¶çš„å‘¨æœŸæ€§ä»»åŠ¡</span></span><br><span class="line">    <span class="type">Cluster</span> <span class="variable">cluster</span> <span class="operator">=</span> getClusterInternal();</span><br><span class="line">    <span class="keyword">if</span> (cluster != <span class="literal">null</span>) &#123;</span><br><span class="line">        cluster.backgroundProcess();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2. æ‰§è¡Œå®¹å™¨ä¸­ Realm ç»„ä»¶çš„å‘¨æœŸæ€§ä»»åŠ¡</span></span><br><span class="line">    <span class="type">Realm</span> <span class="variable">realm</span> <span class="operator">=</span> getRealmInternal();</span><br><span class="line">    <span class="keyword">if</span> (realm != <span class="literal">null</span>) &#123;</span><br><span class="line">        realm.backgroundProcess();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">//3. æ‰§è¡Œå®¹å™¨ä¸­ Valve ç»„ä»¶çš„å‘¨æœŸæ€§ä»»åŠ¡</span></span><br><span class="line">    <span class="type">Valve</span> <span class="variable">current</span> <span class="operator">=</span> pipeline.getFirst();</span><br><span class="line">    <span class="keyword">while</span> (current != <span class="literal">null</span>) &#123;</span><br><span class="line">       current.backgroundProcess();</span><br><span class="line">       current = current.getNext();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//4. è§¦å‘å®¹å™¨çš„ &quot; å‘¨æœŸäº‹ä»¶ &quot;ï¼ŒHost å®¹å™¨çš„ç›‘å¬å™¨ HostConfig å°±é å®ƒæ¥è°ƒç”¨</span></span><br><span class="line">    fireLifecycleEvent(Lifecycle.PERIODIC_EVENT, <span class="literal">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä»ä¸Šé¢çš„ä»£ç å¯ä»¥çœ‹åˆ°ï¼Œä¸ä»…æ¯ä¸ªå®¹å™¨å¯ä»¥æœ‰å‘¨æœŸæ€§ä»»åŠ¡ï¼Œæ¯ä¸ªå®¹å™¨ä¸­çš„å…¶ä»–é€šç”¨ç»„ä»¶ï¼Œæ¯”å¦‚è·Ÿé›†ç¾¤ç®¡ç†æœ‰å…³çš„ Cluster ç»„ä»¶ã€è·Ÿå®‰å…¨ç®¡ç†æœ‰å…³çš„ Realm ç»„ä»¶éƒ½å¯ä»¥æœ‰è‡ªå·±çš„å‘¨æœŸæ€§ä»»åŠ¡ã€‚</p>
<p>æˆ‘åœ¨å‰é¢çš„ä¸“æ é‡Œæåˆ°è¿‡ï¼Œå®¹å™¨ä¹‹é—´çš„é“¾å¼è°ƒç”¨æ˜¯é€šè¿‡ Pipeline-Valve æœºåˆ¶æ¥å®ç°çš„ï¼Œä»ä¸Šé¢çš„ä»£ç ä½ å¯ä»¥çœ‹åˆ°å®¹å™¨ä¸­çš„ Valve ä¹Ÿå¯ä»¥æœ‰å‘¨æœŸæ€§ä»»åŠ¡ï¼Œå¹¶ä¸”è¢« ContainerBase ç»Ÿä¸€å¤„ç†ã€‚</p>
<p>è¯·ä½ ç‰¹åˆ«æ³¨æ„çš„æ˜¯ï¼Œåœ¨ backgroundProcess æ–¹æ³•çš„æœ€åï¼Œè¿˜è§¦å‘äº†å®¹å™¨çš„â€œå‘¨æœŸäº‹ä»¶â€ã€‚æˆ‘ä»¬çŸ¥é“å®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸäº‹ä»¶æœ‰åˆå§‹åŒ–ã€å¯åŠ¨å’Œåœæ­¢ç­‰ï¼Œé‚£â€œå‘¨æœŸäº‹ä»¶â€åˆæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿå®ƒè·Ÿç”Ÿå‘½å‘¨æœŸäº‹ä»¶ä¸€æ ·ï¼Œæ˜¯ä¸€ç§æ‰©å±•æœºåˆ¶ï¼Œä½ å¯ä»¥è¿™æ ·ç†è§£ï¼š</p>
<p>åˆä¸€æ®µæ—¶é—´è¿‡å»äº†ï¼Œå®¹å™¨è¿˜æ´»ç€ï¼Œä½ æƒ³åšç‚¹ä»€ä¹ˆå—ï¼Ÿå¦‚æœä½ æƒ³åšç‚¹ä»€ä¹ˆï¼Œå°±åˆ›å»ºä¸€ä¸ªç›‘å¬å™¨æ¥ç›‘å¬è¿™ä¸ªâ€œå‘¨æœŸäº‹ä»¶â€ï¼Œäº‹ä»¶åˆ°äº†æˆ‘è´Ÿè´£è°ƒç”¨ä½ çš„æ–¹æ³•ã€‚</p>
<p>æ€»ä¹‹ï¼Œæœ‰äº† ContainerBase ä¸­çš„åå°çº¿ç¨‹å’Œ backgroundProcess æ–¹æ³•ï¼Œå„ç§å­å®¹å™¨å’Œé€šç”¨ç»„ä»¶ä¸éœ€è¦å„è‡ªå¼„ä¸€ä¸ªåå°çº¿ç¨‹æ¥å¤„ç†å‘¨æœŸæ€§ä»»åŠ¡ï¼Œè¿™æ ·çš„è®¾è®¡æ˜¾å¾—ä¼˜é›…å’Œæ•´æ´ã€‚</p>
<h3 id="Tomcat-çƒ­åŠ è½½"><a href="#Tomcat-çƒ­åŠ è½½" class="headerlink" title="Tomcat çƒ­åŠ è½½"></a>Tomcat çƒ­åŠ è½½</h3><p>æœ‰äº† ContainerBase çš„å‘¨æœŸæ€§ä»»åŠ¡å¤„ç†â€œæ¡†æ¶â€ï¼Œä½œä¸ºå…·ä½“å®¹å™¨å­ç±»ï¼Œåªéœ€è¦å®ç°è‡ªå·±çš„å‘¨æœŸæ€§ä»»åŠ¡å°±è¡Œã€‚è€Œ Tomcat çš„çƒ­åŠ è½½ï¼Œå°±æ˜¯åœ¨ Context å®¹å™¨ä¸­å®ç°çš„ã€‚Context å®¹å™¨çš„ backgroundProcess æ–¹æ³•æ˜¯è¿™æ ·å®ç°çš„ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">backgroundProcess</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//WebappLoader å‘¨æœŸæ€§çš„æ£€æŸ¥ WEB-INF/classes å’Œ WEB-INF/lib ç›®å½•ä¸‹çš„ç±»æ–‡ä»¶</span></span><br><span class="line">    <span class="type">Loader</span> <span class="variable">loader</span> <span class="operator">=</span> getLoader();</span><br><span class="line">    <span class="keyword">if</span> (loader != <span class="literal">null</span>) &#123;</span><br><span class="line">        loader.backgroundProcess();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Session ç®¡ç†å™¨å‘¨æœŸæ€§çš„æ£€æŸ¥æ˜¯å¦æœ‰è¿‡æœŸçš„ Session</span></span><br><span class="line">    <span class="type">Manager</span> <span class="variable">manager</span> <span class="operator">=</span> getManager();</span><br><span class="line">    <span class="keyword">if</span> (manager != <span class="literal">null</span>) &#123;</span><br><span class="line">        manager.backgroundProcess();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å‘¨æœŸæ€§çš„æ£€æŸ¥é™æ€èµ„æºæ˜¯å¦æœ‰å˜åŒ–</span></span><br><span class="line">    <span class="type">WebResourceRoot</span> <span class="variable">resources</span> <span class="operator">=</span> getResources();</span><br><span class="line">    <span class="keyword">if</span> (resources != <span class="literal">null</span>) &#123;</span><br><span class="line">        resources.backgroundProcess();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è°ƒç”¨çˆ¶ç±» ContainerBase çš„ backgroundProcess æ–¹æ³•</span></span><br><span class="line">    <span class="built_in">super</span>.backgroundProcess();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä»ä¸Šé¢çš„ä»£ç æˆ‘ä»¬çœ‹åˆ° Context å®¹å™¨é€šè¿‡ WebappLoader æ¥æ£€æŸ¥ç±»æ–‡ä»¶æ˜¯å¦æœ‰æ›´æ–°ï¼Œé€šè¿‡ Session ç®¡ç†å™¨æ¥æ£€æŸ¥æ˜¯å¦æœ‰ Session è¿‡æœŸï¼Œå¹¶ä¸”é€šè¿‡èµ„æºç®¡ç†å™¨æ¥æ£€æŸ¥é™æ€èµ„æºæ˜¯å¦æœ‰æ›´æ–°ï¼Œæœ€åè¿˜è°ƒç”¨äº†çˆ¶ç±» ContainerBase çš„ backgroundProcess æ–¹æ³•ã€‚</p>
<p>è¿™é‡Œæˆ‘ä»¬è¦é‡ç‚¹å…³æ³¨ï¼ŒWebappLoader æ˜¯å¦‚ä½•å®ç°çƒ­åŠ è½½çš„ï¼Œå®ƒä¸»è¦æ˜¯è°ƒç”¨äº† Context å®¹å™¨çš„ reload æ–¹æ³•ï¼Œè€Œ Context çš„ reload æ–¹æ³•æ¯”è¾ƒå¤æ‚ï¼Œæ€»ç»“èµ·æ¥ï¼Œä¸»è¦å®Œæˆäº†ä¸‹é¢è¿™äº›ä»»åŠ¡ï¼š</p>
<ol>
<li>åœæ­¢å’Œé”€æ¯ Context å®¹å™¨åŠå…¶æ‰€æœ‰å­å®¹å™¨ï¼Œå­å®¹å™¨å…¶å®å°±æ˜¯ Wrapperï¼Œä¹Ÿå°±æ˜¯è¯´ Wrapper é‡Œé¢ Servlet å®ä¾‹ä¹Ÿè¢«é”€æ¯äº†ã€‚</li>
<li>åœæ­¢å’Œé”€æ¯ Context å®¹å™¨å…³è”çš„ Listener å’Œ Filterã€‚</li>
<li>åœæ­¢å’Œé”€æ¯ Context ä¸‹çš„ Pipeline å’Œå„ç§ Valveã€‚</li>
<li>åœæ­¢å’Œé”€æ¯ Context çš„ç±»åŠ è½½å™¨ï¼Œä»¥åŠç±»åŠ è½½å™¨åŠ è½½çš„ç±»æ–‡ä»¶èµ„æºã€‚</li>
<li>å¯åŠ¨ Context å®¹å™¨ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ä¼šé‡æ–°åˆ›å»ºå‰é¢å››æ­¥è¢«é”€æ¯çš„èµ„æºã€‚</li>
</ol>
<p>åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œç±»åŠ è½½å™¨å‘æŒ¥ç€å…³é”®ä½œç”¨ã€‚ä¸€ä¸ª Context å®¹å™¨å¯¹åº”ä¸€ä¸ªç±»åŠ è½½å™¨ï¼Œç±»åŠ è½½å™¨åœ¨é”€æ¯çš„è¿‡ç¨‹ä¸­ä¼šæŠŠå®ƒåŠ è½½çš„æ‰€æœ‰ç±»ä¹Ÿå…¨éƒ¨é”€æ¯ã€‚Context å®¹å™¨åœ¨å¯åŠ¨è¿‡ç¨‹ä¸­ï¼Œä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ç±»åŠ è½½å™¨æ¥åŠ è½½æ–°çš„ç±»æ–‡ä»¶ã€‚</p>
<p>åœ¨ Context çš„ reload æ–¹æ³•é‡Œï¼Œå¹¶æ²¡æœ‰è°ƒç”¨ Session ç®¡ç†å™¨çš„ distroy æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™ä¸ª Context å…³è”çš„ Session æ˜¯æ²¡æœ‰é”€æ¯çš„ã€‚ä½ è¿˜éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒTomcat çš„çƒ­åŠ è½½é»˜è®¤æ˜¯å…³é—­çš„ï¼Œä½ éœ€è¦åœ¨ conf ç›®å½•ä¸‹çš„ Context.xml æ–‡ä»¶ä¸­è®¾ç½® reloadable å‚æ•°æ¥å¼€å¯è¿™ä¸ªåŠŸèƒ½ï¼Œåƒä¸‹é¢è¿™æ ·ï¼š</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;Context <span class="attribute">reloadable</span>=<span class="string">&quot;true&quot;</span>/&gt;</span><br></pre></td></tr></table></figure>

<h3 id="Tomcat-çƒ­éƒ¨ç½²"><a href="#Tomcat-çƒ­éƒ¨ç½²" class="headerlink" title="Tomcat çƒ­éƒ¨ç½²"></a>Tomcat çƒ­éƒ¨ç½²</h3><p>æˆ‘ä»¬å†æ¥çœ‹çœ‹çƒ­éƒ¨ç½²ï¼Œçƒ­éƒ¨ç½²è·Ÿçƒ­åŠ è½½çš„æœ¬è´¨åŒºåˆ«æ˜¯ï¼Œçƒ­éƒ¨ç½²ä¼šé‡æ–°éƒ¨ç½² Web åº”ç”¨ï¼ŒåŸæ¥çš„ Context å¯¹è±¡ä¼šæ•´ä¸ªè¢«é”€æ¯æ‰ï¼Œå› æ­¤è¿™ä¸ª Context æ‰€å…³è”çš„ä¸€åˆ‡èµ„æºéƒ½ä¼šè¢«é”€æ¯ï¼ŒåŒ…æ‹¬ Sessionã€‚</p>
<p>é‚£ä¹ˆ Tomcat çƒ­éƒ¨ç½²åˆæ˜¯ç”±å“ªä¸ªå®¹å™¨æ¥å®ç°çš„å‘¢ï¼Ÿåº”è¯¥ä¸æ˜¯ç”± Contextï¼Œå› ä¸ºçƒ­éƒ¨ç½²è¿‡ç¨‹ä¸­ Context å®¹å™¨è¢«é”€æ¯äº†ï¼Œé‚£ä¹ˆè¿™ä¸ªé‡æ‹…å°±è½åœ¨ Host èº«ä¸Šäº†ï¼Œå› ä¸ºå®ƒæ˜¯ Context çš„çˆ¶å®¹å™¨ã€‚</p>
<p>è·Ÿ Context ä¸ä¸€æ ·ï¼ŒHost å®¹å™¨å¹¶æ²¡æœ‰åœ¨ backgroundProcess æ–¹æ³•ä¸­å®ç°å‘¨æœŸæ€§æ£€æµ‹çš„ä»»åŠ¡ï¼Œè€Œæ˜¯é€šè¿‡ç›‘å¬å™¨ HostConfig æ¥å®ç°çš„ï¼ŒHostConfig å°±æ˜¯å‰é¢æåˆ°çš„â€œå‘¨æœŸäº‹ä»¶â€çš„ç›‘å¬å™¨ï¼Œé‚£â€œå‘¨æœŸäº‹ä»¶â€è¾¾åˆ°æ—¶ï¼ŒHostConfig ä¼šåšä»€ä¹ˆäº‹å‘¢ï¼Ÿ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">lifecycleEvent</span><span class="params">(LifecycleEvent event)</span> &#123;</span><br><span class="line">    <span class="comment">// æ‰§è¡Œ check æ–¹æ³•ã€‚</span></span><br><span class="line">    <span class="keyword">if</span> (event.getType().equals(Lifecycle.PERIODIC_EVENT)) &#123;</span><br><span class="line">        check();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å®ƒæ‰§è¡Œäº† check æ–¹æ³•ï¼Œæˆ‘ä»¬æ¥ç€æ¥çœ‹ check æ–¹æ³•é‡Œåšäº†ä»€ä¹ˆã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">check</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (host.getAutoDeploy()) &#123;</span><br><span class="line">        <span class="comment">// æ£€æŸ¥è¿™ä¸ª Host ä¸‹æ‰€æœ‰å·²ç»éƒ¨ç½²çš„ Web åº”ç”¨</span></span><br><span class="line">        DeployedApplication[] apps =</span><br><span class="line">            deployed.values().toArray(<span class="keyword">new</span> <span class="title class_">DeployedApplication</span>[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; apps.length; i++) &#123;</span><br><span class="line">            <span class="comment">// æ£€æŸ¥ Web åº”ç”¨ç›®å½•æ˜¯å¦æœ‰å˜åŒ–</span></span><br><span class="line">            checkResources(apps[i], <span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ‰§è¡Œéƒ¨ç½²</span></span><br><span class="line">        deployApps();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…¶å® HostConfig ä¼šæ£€æŸ¥ webapps ç›®å½•ä¸‹çš„æ‰€æœ‰ Web åº”ç”¨ï¼š</p>
<ul>
<li>å¦‚æœåŸæ¥ Web åº”ç”¨ç›®å½•è¢«åˆ æ‰äº†ï¼Œå°±æŠŠç›¸åº” Context å®¹å™¨æ•´ä¸ªé”€æ¯æ‰ã€‚</li>
<li>æ˜¯å¦æœ‰æ–°çš„ Web åº”ç”¨ç›®å½•æ”¾è¿›æ¥äº†ï¼Œæˆ–è€…æœ‰æ–°çš„ WAR åŒ…æ”¾è¿›æ¥äº†ï¼Œå°±éƒ¨ç½²ç›¸åº”çš„ Web åº”ç”¨ã€‚</li>
</ul>
<p>å› æ­¤ HostConfig åšçš„äº‹æƒ…éƒ½æ˜¯æ¯”è¾ƒâ€œå®è§‚â€çš„ï¼Œå®ƒä¸ä¼šå»æ£€æŸ¥å…·ä½“ç±»æ–‡ä»¶æˆ–è€…èµ„æºæ–‡ä»¶æ˜¯å¦æœ‰å˜åŒ–ï¼Œè€Œæ˜¯æ£€æŸ¥ Web åº”ç”¨ç›®å½•çº§åˆ«çš„å˜åŒ–ã€‚</p>
<h2 id="Tomcat-çš„ç±»åŠ è½½æœºåˆ¶"><a href="#Tomcat-çš„ç±»åŠ è½½æœºåˆ¶" class="headerlink" title="Tomcat çš„ç±»åŠ è½½æœºåˆ¶"></a>Tomcat çš„ç±»åŠ è½½æœºåˆ¶</h2><p>Tomcat çš„è‡ªå®šä¹‰ç±»åŠ è½½å™¨ <code>WebAppClassLoader</code> æ‰“ç ´äº†åŒäº²å§”æ´¾æœºåˆ¶ï¼Œå®ƒ<strong>é¦–å…ˆè‡ªå·±å°è¯•å»åŠ è½½æŸä¸ªç±»ï¼Œå¦‚æœæ‰¾ä¸åˆ°å†ä»£ç†ç»™çˆ¶ç±»åŠ è½½å™¨</strong>ï¼Œå…¶ç›®çš„æ˜¯ä¼˜å…ˆåŠ è½½ Web åº”ç”¨è‡ªå·±å®šä¹‰çš„ç±»ã€‚å…·ä½“å®ç°å°±æ˜¯é‡å†™ ClassLoader çš„ä¸¤ä¸ªæ–¹æ³•ï¼šfindClass å’Œ loadClassã€‚</p>
<h3 id="findClass-æ–¹æ³•"><a href="#findClass-æ–¹æ³•" class="headerlink" title="findClass æ–¹æ³•"></a>findClass æ–¹æ³•</h3><p>æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ findClass æ–¹æ³•çš„å®ç°ï¼Œä¸ºäº†æ–¹ä¾¿ç†è§£å’Œé˜…è¯»ï¼Œæˆ‘å»æ‰äº†ä¸€äº›ç»†èŠ‚ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Class&lt;?&gt; findClass(String name) <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    Class&lt;?&gt; clazz = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//1. å…ˆåœ¨ Web åº”ç”¨ç›®å½•ä¸‹æŸ¥æ‰¾ç±»</span></span><br><span class="line">            clazz = findClassInternal(name);</span><br><span class="line">    &#125;  <span class="keyword">catch</span> (RuntimeException e) &#123;</span><br><span class="line">           <span class="keyword">throw</span> e;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (clazz == <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//2. å¦‚æœåœ¨æœ¬åœ°ç›®å½•æ²¡æœ‰æ‰¾åˆ°ï¼Œäº¤ç»™çˆ¶åŠ è½½å™¨å»æŸ¥æ‰¾</span></span><br><span class="line">            clazz = <span class="built_in">super</span>.findClass(name);</span><br><span class="line">    &#125;  <span class="keyword">catch</span> (RuntimeException e) &#123;</span><br><span class="line">           <span class="keyword">throw</span> e;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//3. å¦‚æœçˆ¶ç±»ä¹Ÿæ²¡æ‰¾åˆ°ï¼ŒæŠ›å‡º ClassNotFoundException</span></span><br><span class="line">    <span class="keyword">if</span> (clazz == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ClassNotFoundException</span>(name);</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> clazz;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨ findClass æ–¹æ³•é‡Œï¼Œä¸»è¦æœ‰ä¸‰ä¸ªæ­¥éª¤ï¼š</p>
<ol>
<li>å…ˆåœ¨ Web åº”ç”¨æœ¬åœ°ç›®å½•ä¸‹æŸ¥æ‰¾è¦åŠ è½½çš„ç±»ã€‚</li>
<li>å¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œäº¤ç»™çˆ¶åŠ è½½å™¨å»æŸ¥æ‰¾ï¼Œå®ƒçš„çˆ¶åŠ è½½å™¨å°±æ˜¯ä¸Šé¢æåˆ°çš„ç³»ç»Ÿç±»åŠ è½½å™¨ AppClassLoaderã€‚</li>
<li>å¦‚ä½•çˆ¶åŠ è½½å™¨ä¹Ÿæ²¡æ‰¾åˆ°è¿™ä¸ªç±»ï¼ŒæŠ›å‡º ClassNotFound å¼‚å¸¸ã€‚</li>
</ol>
<h3 id="loadClass-æ–¹æ³•"><a href="#loadClass-æ–¹æ³•" class="headerlink" title="loadClass æ–¹æ³•"></a>loadClass æ–¹æ³•</h3><p>æ¥ç€æˆ‘ä»¬å†æ¥çœ‹ Tomcat ç±»åŠ è½½å™¨çš„ loadClass æ–¹æ³•çš„å®ç°ï¼ŒåŒæ ·æˆ‘ä¹Ÿå»æ‰äº†ä¸€äº›ç»†èŠ‚ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Class&lt;?&gt; loadClass(String name, <span class="type">boolean</span> resolve) <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (getClassLoadingLock(name)) &#123;</span><br><span class="line"></span><br><span class="line">        Class&lt;?&gt; clazz = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//1. å…ˆåœ¨æœ¬åœ° cache æŸ¥æ‰¾è¯¥ç±»æ˜¯å¦å·²ç»åŠ è½½è¿‡</span></span><br><span class="line">        clazz = findLoadedClass0(name);</span><br><span class="line">        <span class="keyword">if</span> (clazz != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (resolve)</span><br><span class="line">                resolveClass(clazz);</span><br><span class="line">            <span class="keyword">return</span> clazz;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2. ä»ç³»ç»Ÿç±»åŠ è½½å™¨çš„ cache ä¸­æŸ¥æ‰¾æ˜¯å¦åŠ è½½è¿‡</span></span><br><span class="line">        clazz = findLoadedClass(name);</span><br><span class="line">        <span class="keyword">if</span> (clazz != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (resolve)</span><br><span class="line">                resolveClass(clazz);</span><br><span class="line">            <span class="keyword">return</span> clazz;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. å°è¯•ç”¨ ExtClassLoader ç±»åŠ è½½å™¨ç±»åŠ è½½ï¼Œä¸ºä»€ä¹ˆï¼Ÿ</span></span><br><span class="line">        <span class="type">ClassLoader</span> <span class="variable">javaseLoader</span> <span class="operator">=</span> getJavaseClassLoader();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            clazz = javaseLoader.loadClass(name);</span><br><span class="line">            <span class="keyword">if</span> (clazz != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (resolve)</span><br><span class="line">                    resolveClass(clazz);</span><br><span class="line">                <span class="keyword">return</span> clazz;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            <span class="comment">// Ignore</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4. å°è¯•åœ¨æœ¬åœ°ç›®å½•æœç´¢ class å¹¶åŠ è½½</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            clazz = findClass(name);</span><br><span class="line">            <span class="keyword">if</span> (clazz != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (resolve)</span><br><span class="line">                    resolveClass(clazz);</span><br><span class="line">                <span class="keyword">return</span> clazz;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            <span class="comment">// Ignore</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5. å°è¯•ç”¨ç³»ç»Ÿç±»åŠ è½½å™¨ (ä¹Ÿå°±æ˜¯ AppClassLoader) æ¥åŠ è½½</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                clazz = Class.forName(name, <span class="literal">false</span>, parent);</span><br><span class="line">                <span class="keyword">if</span> (clazz != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (resolve)</span><br><span class="line">                        resolveClass(clazz);</span><br><span class="line">                    <span class="keyword">return</span> clazz;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">                <span class="comment">// Ignore</span></span><br><span class="line">            &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//6. ä¸Šè¿°è¿‡ç¨‹éƒ½åŠ è½½å¤±è´¥ï¼ŒæŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ClassNotFoundException</span>(name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>loadClass æ–¹æ³•ç¨å¾®å¤æ‚ä¸€ç‚¹ï¼Œä¸»è¦æœ‰å…­ä¸ªæ­¥éª¤ï¼š</p>
<ol>
<li>å…ˆåœ¨æœ¬åœ° Cache æŸ¥æ‰¾è¯¥ç±»æ˜¯å¦å·²ç»åŠ è½½è¿‡ï¼Œä¹Ÿå°±æ˜¯è¯´ Tomcat çš„ç±»åŠ è½½å™¨æ˜¯å¦å·²ç»åŠ è½½è¿‡è¿™ä¸ªç±»ã€‚</li>
<li>å¦‚æœ Tomcat ç±»åŠ è½½å™¨æ²¡æœ‰åŠ è½½è¿‡è¿™ä¸ªç±»ï¼Œå†çœ‹çœ‹ç³»ç»Ÿç±»åŠ è½½å™¨æ˜¯å¦åŠ è½½è¿‡ã€‚</li>
<li>å¦‚æœéƒ½æ²¡æœ‰ï¼Œå°±è®©<strong>ExtClassLoader</strong>å»åŠ è½½ï¼Œè¿™ä¸€æ­¥æ¯”è¾ƒå…³é”®ï¼Œç›®çš„<strong>é˜²æ­¢ Web åº”ç”¨è‡ªå·±çš„ç±»è¦†ç›– JRE çš„æ ¸å¿ƒç±»</strong>ã€‚å› ä¸º Tomcat éœ€è¦æ‰“ç ´åŒäº²å§”æ´¾æœºåˆ¶ï¼Œå‡å¦‚ Web åº”ç”¨é‡Œè‡ªå®šä¹‰äº†ä¸€ä¸ªå« Object çš„ç±»ï¼Œå¦‚æœå…ˆåŠ è½½è¿™ä¸ª Object ç±»ï¼Œå°±ä¼šè¦†ç›– JRE é‡Œé¢çš„é‚£ä¸ª Object ç±»ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆ Tomcat çš„ç±»åŠ è½½å™¨ä¼šä¼˜å…ˆå°è¯•ç”¨ ExtClassLoader å»åŠ è½½ï¼Œå› ä¸º ExtClassLoader ä¼šå§”æ‰˜ç»™ BootstrapClassLoader å»åŠ è½½ï¼ŒBootstrapClassLoader å‘ç°è‡ªå·±å·²ç»åŠ è½½äº† Object ç±»ï¼Œç›´æ¥è¿”å›ç»™ Tomcat çš„ç±»åŠ è½½å™¨ï¼Œè¿™æ · Tomcat çš„ç±»åŠ è½½å™¨å°±ä¸ä¼šå»åŠ è½½ Web åº”ç”¨ä¸‹çš„ Object ç±»äº†ï¼Œä¹Ÿå°±é¿å…äº†è¦†ç›– JRE æ ¸å¿ƒç±»çš„é—®é¢˜ã€‚</li>
<li>å¦‚æœ ExtClassLoader åŠ è½½å™¨åŠ è½½å¤±è´¥ï¼Œä¹Ÿå°±æ˜¯è¯´ JRE æ ¸å¿ƒç±»ä¸­æ²¡æœ‰è¿™ç±»ï¼Œé‚£ä¹ˆå°±åœ¨æœ¬åœ° Web åº”ç”¨ç›®å½•ä¸‹æŸ¥æ‰¾å¹¶åŠ è½½ã€‚</li>
<li>å¦‚æœæœ¬åœ°ç›®å½•ä¸‹æ²¡æœ‰è¿™ä¸ªç±»ï¼Œè¯´æ˜ä¸æ˜¯ Web åº”ç”¨è‡ªå·±å®šä¹‰çš„ç±»ï¼Œé‚£ä¹ˆç”±ç³»ç»Ÿç±»åŠ è½½å™¨å»åŠ è½½ã€‚è¿™é‡Œè¯·ä½ æ³¨æ„ï¼ŒWeb åº”ç”¨æ˜¯é€šè¿‡<code>Class.forName</code>è°ƒç”¨äº¤ç»™ç³»ç»Ÿç±»åŠ è½½å™¨çš„ï¼Œå› ä¸º<code>Class.forName</code>çš„é»˜è®¤åŠ è½½å™¨å°±æ˜¯ç³»ç»Ÿç±»åŠ è½½å™¨ã€‚</li>
<li>å¦‚æœä¸Šè¿°åŠ è½½è¿‡ç¨‹å…¨éƒ¨å¤±è´¥ï¼ŒæŠ›å‡º ClassNotFound å¼‚å¸¸ã€‚</li>
</ol>
<p>ä»ä¸Šé¢çš„è¿‡ç¨‹æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒTomcat çš„ç±»åŠ è½½å™¨æ‰“ç ´äº†åŒäº²å§”æ´¾æœºåˆ¶ï¼Œæ²¡æœ‰ä¸€ä¸Šæ¥å°±ç›´æ¥å§”æ‰˜ç»™çˆ¶åŠ è½½å™¨ï¼Œè€Œæ˜¯å…ˆåœ¨æœ¬åœ°ç›®å½•ä¸‹åŠ è½½ï¼Œä¸ºäº†é¿å…æœ¬åœ°ç›®å½•ä¸‹çš„ç±»è¦†ç›– JRE çš„æ ¸å¿ƒç±»ï¼Œå…ˆå°è¯•ç”¨ JVM æ‰©å±•ç±»åŠ è½½å™¨ ExtClassLoader å»åŠ è½½ã€‚é‚£ä¸ºä»€ä¹ˆä¸å…ˆç”¨ç³»ç»Ÿç±»åŠ è½½å™¨ AppClassLoader å»åŠ è½½ï¼Ÿå¾ˆæ˜¾ç„¶ï¼Œå¦‚æœæ˜¯è¿™æ ·çš„è¯ï¼Œé‚£å°±å˜æˆåŒäº²å§”æ´¾æœºåˆ¶äº†ï¼Œè¿™å°±æ˜¯ Tomcat ç±»åŠ è½½å™¨çš„å·§å¦™ä¹‹å¤„ã€‚</p>
<h3 id="Tomcat-å®ç°åº”ç”¨éš”ç¦»"><a href="#Tomcat-å®ç°åº”ç”¨éš”ç¦»" class="headerlink" title="Tomcat å®ç°åº”ç”¨éš”ç¦»"></a>Tomcat å®ç°åº”ç”¨éš”ç¦»</h3><p>Tomcat ä½œä¸º Web å®¹å™¨ï¼Œéœ€è¦è§£å†³ä»¥ä¸‹é—®é¢˜ï¼š</p>
<ol>
<li>å¦‚æœåœ¨ Tomcat ä¸­è¿è¡Œäº†ä¸¤ä¸ª Web åº”ç”¨ç¨‹åºï¼Œä¸¤ä¸ª Web åº”ç”¨ä¸­æœ‰åŒåçš„ Servletï¼Œä½†æ˜¯åŠŸèƒ½ä¸åŒï¼ŒTomcat éœ€è¦åŒæ—¶åŠ è½½å’Œç®¡ç†è¿™ä¸¤ä¸ªåŒåçš„ Servlet ç±»ï¼Œä¿è¯å®ƒä»¬ä¸ä¼šå†²çªï¼Œå› æ­¤ Web åº”ç”¨ä¹‹é—´çš„ç±»éœ€è¦éš”ç¦»ã€‚</li>
<li>ä¸¤ä¸ª Web åº”ç”¨éƒ½ä¾èµ–åŒä¸€ä¸ªç¬¬ä¸‰æ–¹çš„ JAR åŒ…ï¼Œæ¯”å¦‚ Springï¼Œé‚£ Spring çš„ JAR åŒ…è¢«åŠ è½½åˆ°å†…å­˜åï¼ŒTomcat è¦ä¿è¯è¿™ä¸¤ä¸ª Web åº”ç”¨èƒ½å¤Ÿå…±äº«ï¼Œä¹Ÿå°±æ˜¯è¯´ Spring çš„ JAR åŒ…åªè¢«åŠ è½½ä¸€æ¬¡ï¼Œå¦åˆ™éšç€ä¾èµ–çš„ç¬¬ä¸‰æ–¹ JAR åŒ…å¢å¤šï¼ŒJVM çš„å†…å­˜ä¼šè†¨èƒ€ã€‚</li>
<li>éœ€è¦éš”ç¦» Tomcat æœ¬èº«çš„ç±»å’Œ Web åº”ç”¨çš„ç±»ã€‚</li>
</ol>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/20201130141536.png" alt="img"></p>
<h4 id="WebAppClassLoader"><a href="#WebAppClassLoader" class="headerlink" title="WebAppClassLoader"></a>WebAppClassLoader</h4><p>é’ˆå¯¹ç¬¬ä¸€ä¸ªé—®é¢˜ï¼š</p>
<p>å¦‚æœä½¿ç”¨ JVM é»˜è®¤ AppClassLoader æ¥åŠ è½½ Web åº”ç”¨ï¼ŒAppClassLoader åªèƒ½åŠ è½½ä¸€ä¸ª Servlet ç±»ï¼Œåœ¨åŠ è½½ç¬¬äºŒä¸ªåŒå Servlet ç±»æ—¶ï¼ŒAppClassLoader ä¼šè¿”å›ç¬¬ä¸€ä¸ª Servlet ç±»çš„ Class å®ä¾‹ï¼Œè¿™æ˜¯å› ä¸ºåœ¨ AppClassLoader çœ‹æ¥ï¼ŒåŒåçš„ Servlet ç±»åªè¢«åŠ è½½ä¸€æ¬¡ã€‚</p>
<p>Tomcat çš„è§£å†³æ–¹æ¡ˆæ˜¯è‡ªå®šä¹‰ä¸€ä¸ªç±»åŠ è½½å™¨ WebAppClassLoaderï¼Œ å¹¶ä¸”ç»™æ¯ä¸ª Web åº”ç”¨åˆ›å»ºä¸€ä¸ªç±»åŠ è½½å™¨å®ä¾‹ã€‚æˆ‘ä»¬çŸ¥é“ï¼ŒContext å®¹å™¨ç»„ä»¶å¯¹åº”ä¸€ä¸ª Web åº”ç”¨ï¼Œå› æ­¤ï¼Œæ¯ä¸ª Context å®¹å™¨è´Ÿè´£åˆ›å»ºå’Œç»´æŠ¤ä¸€ä¸ª WebAppClassLoader åŠ è½½å™¨å®ä¾‹ã€‚è¿™èƒŒåçš„åŸç†æ˜¯ï¼Œ<strong>ä¸åŒçš„åŠ è½½å™¨å®ä¾‹åŠ è½½çš„ç±»è¢«è®¤ä¸ºæ˜¯ä¸åŒçš„ç±»</strong>ï¼Œå³ä½¿å®ƒä»¬çš„ç±»åç›¸åŒã€‚è¿™å°±ç›¸å½“äºåœ¨ Java è™šæ‹Ÿæœºå†…éƒ¨åˆ›å»ºäº†ä¸€ä¸ªä¸ªç›¸äº’éš”ç¦»çš„ Java ç±»ç©ºé—´ï¼Œæ¯ä¸€ä¸ª Web åº”ç”¨éƒ½æœ‰è‡ªå·±çš„ç±»ç©ºé—´ï¼ŒWeb åº”ç”¨ä¹‹é—´é€šè¿‡å„è‡ªçš„ç±»åŠ è½½å™¨äº’ç›¸éš”ç¦»ã€‚</p>
<h4 id="SharedClassLoader"><a href="#SharedClassLoader" class="headerlink" title="SharedClassLoader"></a>SharedClassLoader</h4><p>é’ˆå¯¹ç¬¬äºŒä¸ªé—®é¢˜ï¼š</p>
<p>æœ¬è´¨éœ€æ±‚æ˜¯ä¸¤ä¸ª Web åº”ç”¨ä¹‹é—´æ€ä¹ˆå…±äº«åº“ç±»ï¼Œå¹¶ä¸”ä¸èƒ½é‡å¤åŠ è½½ç›¸åŒçš„ç±»ã€‚æˆ‘ä»¬çŸ¥é“ï¼Œåœ¨åŒäº²å§”æ´¾æœºåˆ¶é‡Œï¼Œå„ä¸ªå­åŠ è½½å™¨éƒ½å¯ä»¥é€šè¿‡çˆ¶åŠ è½½å™¨å»åŠ è½½ç±»ï¼Œé‚£ä¹ˆæŠŠéœ€è¦å…±äº«çš„ç±»æ”¾åˆ°çˆ¶åŠ è½½å™¨çš„åŠ è½½è·¯å¾„ä¸‹ä¸å°±è¡Œäº†å—ï¼Œåº”ç”¨ç¨‹åºä¹Ÿæ­£æ˜¯é€šè¿‡è¿™ç§æ–¹å¼å…±äº« JRE çš„æ ¸å¿ƒç±»ã€‚å› æ­¤ Tomcat çš„è®¾è®¡è€…åˆåŠ äº†ä¸€ä¸ªç±»åŠ è½½å™¨ SharedClassLoaderï¼Œä½œä¸º WebAppClassLoader çš„çˆ¶åŠ è½½å™¨ï¼Œä¸“é—¨æ¥åŠ è½½ Web åº”ç”¨ä¹‹é—´å…±äº«çš„ç±»ã€‚å¦‚æœ WebAppClassLoader è‡ªå·±æ²¡æœ‰åŠ è½½åˆ°æŸä¸ªç±»ï¼Œå°±ä¼šå§”æ‰˜çˆ¶åŠ è½½å™¨ SharedClassLoader å»åŠ è½½è¿™ä¸ªç±»ï¼ŒSharedClassLoader ä¼šåœ¨æŒ‡å®šç›®å½•ä¸‹åŠ è½½å…±äº«ç±»ï¼Œä¹‹åè¿”å›ç»™ WebAppClassLoaderï¼Œè¿™æ ·å…±äº«çš„é—®é¢˜å°±è§£å†³äº†ã€‚</p>
<h4 id="CatalinaClassloader"><a href="#CatalinaClassloader" class="headerlink" title="CatalinaClassloader"></a>CatalinaClassloader</h4><p>å¦‚ä½•éš”ç¦» Tomcat æœ¬èº«çš„ç±»å’Œ Web åº”ç”¨çš„ç±»ï¼Ÿ</p>
<p>è¦å…±äº«å¯ä»¥é€šè¿‡çˆ¶å­å…³ç³»ï¼Œè¦éš”ç¦»é‚£å°±éœ€è¦å…„å¼Ÿå…³ç³»äº†ã€‚å…„å¼Ÿå…³ç³»å°±æ˜¯æŒ‡ä¸¤ä¸ªç±»åŠ è½½å™¨æ˜¯å¹³è¡Œçš„ï¼Œå®ƒä»¬å¯èƒ½æ‹¥æœ‰åŒä¸€ä¸ªçˆ¶åŠ è½½å™¨ï¼Œä½†æ˜¯ä¸¤ä¸ªå…„å¼Ÿç±»åŠ è½½å™¨åŠ è½½çš„ç±»æ˜¯éš”ç¦»çš„ã€‚åŸºäºæ­¤ Tomcat åˆè®¾è®¡ä¸€ä¸ªç±»åŠ è½½å™¨ CatalinaClassloaderï¼Œä¸“é—¨æ¥åŠ è½½ Tomcat è‡ªèº«çš„ç±»ã€‚è¿™æ ·è®¾è®¡æœ‰ä¸ªé—®é¢˜ï¼Œé‚£ Tomcat å’Œå„ Web åº”ç”¨ä¹‹é—´éœ€è¦å…±äº«ä¸€äº›ç±»æ—¶è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿ</p>
<h4 id="CommonClassLoader"><a href="#CommonClassLoader" class="headerlink" title="CommonClassLoader"></a>CommonClassLoader</h4><p>è€åŠæ³•ï¼Œè¿˜æ˜¯å†å¢åŠ ä¸€ä¸ª CommonClassLoaderï¼Œä½œä¸º CatalinaClassloader å’Œ SharedClassLoader çš„çˆ¶åŠ è½½å™¨ã€‚CommonClassLoader èƒ½åŠ è½½çš„ç±»éƒ½å¯ä»¥è¢« CatalinaClassLoader å’Œ SharedClassLoader ä½¿ç”¨ï¼Œè€Œ CatalinaClassLoader å’Œ SharedClassLoader èƒ½åŠ è½½çš„ç±»åˆ™ä¸å¯¹æ–¹ç›¸äº’éš”ç¦»ã€‚WebAppClassLoader å¯ä»¥ä½¿ç”¨ SharedClassLoader åŠ è½½åˆ°çš„ç±»ï¼Œä½†å„ä¸ª WebAppClassLoader å®ä¾‹ä¹‹é—´ç›¸äº’éš”ç¦»ã€‚</p>
<h2 id="Tomcat-å®ç°-Servlet-è§„èŒƒ"><a href="#Tomcat-å®ç°-Servlet-è§„èŒƒ" class="headerlink" title="Tomcat å®ç° Servlet è§„èŒƒ"></a>Tomcat å®ç° Servlet è§„èŒƒ</h2><p>Servlet å®¹å™¨æœ€é‡è¦çš„ä»»åŠ¡å°±æ˜¯åˆ›å»º Servlet çš„å®ä¾‹å¹¶ä¸”è°ƒç”¨ Servletã€‚</p>
<p>ä¸€ä¸ª Web åº”ç”¨é‡Œå¾€å¾€æœ‰å¤šä¸ª Servletï¼Œè€Œåœ¨ Tomcat ä¸­ä¸€ä¸ª Web åº”ç”¨å¯¹åº”ä¸€ä¸ª Context å®¹å™¨ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸€ä¸ª Context å®¹å™¨éœ€è¦ç®¡ç†å¤šä¸ª Servlet å®ä¾‹ã€‚ä½† Context å®¹å™¨å¹¶ä¸ç›´æ¥æŒæœ‰ Servlet å®ä¾‹ï¼Œè€Œæ˜¯é€šè¿‡å­å®¹å™¨ Wrapper æ¥ç®¡ç† Servletï¼Œä½ å¯ä»¥æŠŠ Wrapper å®¹å™¨çœ‹ä½œæ˜¯ Servlet çš„åŒ…è£…ã€‚</p>
<p>ä¸ºä»€ä¹ˆéœ€è¦ Wrapper å‘¢ï¼ŸContext å®¹å™¨ç›´æ¥ç»´æŠ¤ä¸€ä¸ª Servlet æ•°ç»„ä¸å°±è¡Œäº†å—ï¼Ÿè¿™æ˜¯å› ä¸º Servlet ä¸ä»…ä»…æ˜¯ä¸€ä¸ªç±»å®ä¾‹ï¼Œå®ƒè¿˜æœ‰ç›¸å…³çš„é…ç½®ä¿¡æ¯ï¼Œæ¯”å¦‚å®ƒçš„ URL æ˜ å°„ã€å®ƒçš„åˆå§‹åŒ–å‚æ•°ï¼Œå› æ­¤è®¾è®¡å‡ºäº†ä¸€ä¸ªåŒ…è£…å™¨ï¼ŒæŠŠ Servlet æœ¬èº«å’Œå®ƒç›¸å…³çš„æ•°æ®åŒ…èµ·æ¥ï¼Œæ²¡é”™ï¼Œè¿™å°±æ˜¯é¢å‘å¯¹è±¡çš„æ€æƒ³ã€‚</p>
<p>é™¤æ­¤ä»¥å¤–ï¼ŒServlet è§„èŒƒä¸­è¿˜æœ‰ä¸¤ä¸ªé‡è¦ç‰¹æ€§ï¼šListener å’Œ Filterï¼ŒTomcat ä¹Ÿéœ€è¦åˆ›å»ºå®ƒä»¬çš„å®ä¾‹ï¼Œå¹¶åœ¨åˆé€‚çš„æ—¶æœºå»è°ƒç”¨å®ƒä»¬çš„æ–¹æ³•ã€‚</p>
<h3 id="Servlet-ç®¡ç†"><a href="#Servlet-ç®¡ç†" class="headerlink" title="Servlet ç®¡ç†"></a>Servlet ç®¡ç†</h3><p>Tomcat æ˜¯ç”¨ Wrapper å®¹å™¨æ¥ç®¡ç† Servlet çš„ï¼Œé‚£ Wrapper å®¹å™¨å…·ä½“é•¿ä»€ä¹ˆæ ·å­å‘¢ï¼Ÿæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹å®ƒé‡Œé¢æœ‰å“ªäº›å…³é”®çš„æˆå‘˜å˜é‡ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">volatile</span> <span class="type">Servlet</span> <span class="variable">instance</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br></pre></td></tr></table></figure>

<p>å®ƒæ‹¥æœ‰ä¸€ä¸ª Servlet å®ä¾‹ï¼Œå¹¶ä¸” Wrapper é€šè¿‡ loadServlet æ–¹æ³•æ¥å®ä¾‹åŒ– Servletã€‚ä¸ºäº†æ–¹ä¾¿ä½ é˜…è¯»ï¼Œæˆ‘ç®€åŒ–äº†ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">synchronized</span> Servlet <span class="title function_">loadServlet</span><span class="params">()</span> <span class="keyword">throws</span> ServletException &#123;</span><br><span class="line">    Servlet servlet;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//1. åˆ›å»ºä¸€ä¸ª Servlet å®ä¾‹</span></span><br><span class="line">    servlet = (Servlet) instanceManager.newInstance(servletClass);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2. è°ƒç”¨äº† Servlet çš„ init æ–¹æ³•ï¼Œè¿™æ˜¯ Servlet è§„èŒƒè¦æ±‚çš„</span></span><br><span class="line">    initServlet(servlet);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> servlet;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…¶å® loadServlet ä¸»è¦åšäº†ä¸¤ä»¶äº‹ï¼šåˆ›å»º Servlet çš„å®ä¾‹ï¼Œå¹¶ä¸”è°ƒç”¨ Servlet çš„ init æ–¹æ³•ï¼Œå› ä¸ºè¿™æ˜¯ Servlet è§„èŒƒè¦æ±‚çš„ã€‚</p>
<p>é‚£æ¥ä¸‹æ¥çš„é—®é¢˜æ˜¯ï¼Œä»€ä¹ˆæ—¶å€™ä¼šè°ƒåˆ°è¿™ä¸ª loadServlet æ–¹æ³•å‘¢ï¼Ÿä¸ºäº†åŠ å¿«ç³»ç»Ÿçš„å¯åŠ¨é€Ÿåº¦ï¼Œæˆ‘ä»¬å¾€å¾€ä¼šé‡‡å–èµ„æºå»¶è¿ŸåŠ è½½çš„ç­–ç•¥ï¼ŒTomcat ä¹Ÿä¸ä¾‹å¤–ï¼Œé»˜è®¤æƒ…å†µä¸‹ Tomcat åœ¨å¯åŠ¨æ—¶ä¸ä¼šåŠ è½½ä½ çš„ Servletï¼Œé™¤éä½ æŠŠ Servlet çš„<code>loadOnStartup</code>å‚æ•°è®¾ç½®ä¸º<code>true</code>ã€‚</p>
<p>è¿™é‡Œè¿˜éœ€è¦ä½ æ³¨æ„çš„æ˜¯ï¼Œè™½ç„¶ Tomcat åœ¨å¯åŠ¨æ—¶ä¸ä¼šåˆ›å»º Servlet å®ä¾‹ï¼Œä½†æ˜¯ä¼šåˆ›å»º Wrapper å®¹å™¨ï¼Œå°±å¥½æ¯”å°½ç®¡æªé‡Œé¢è¿˜æ²¡æœ‰å­å¼¹ï¼Œå…ˆæŠŠæªé€ å‡ºæ¥ã€‚é‚£å­å¼¹ä»€ä¹ˆæ—¶å€™é€ å‘¢ï¼Ÿæ˜¯çœŸæ­£éœ€è¦å¼€æªçš„æ—¶å€™ï¼Œä¹Ÿå°±æ˜¯è¯´æœ‰è¯·æ±‚æ¥è®¿é—®æŸä¸ª Servlet æ—¶ï¼Œè¿™ä¸ª Servlet çš„å®ä¾‹æ‰ä¼šè¢«åˆ›å»ºã€‚</p>
<p>é‚£ Servlet æ˜¯è¢«è°è°ƒç”¨çš„å‘¢ï¼Ÿæˆ‘ä»¬å›å¿†ä¸€ä¸‹ä¸“æ å‰é¢æåˆ°è¿‡ Tomcat çš„ Pipeline-Valve æœºåˆ¶ï¼Œæ¯ä¸ªå®¹å™¨ç»„ä»¶éƒ½æœ‰è‡ªå·±çš„ Pipelineï¼Œæ¯ä¸ª Pipeline ä¸­æœ‰ä¸€ä¸ª Valve é“¾ï¼Œå¹¶ä¸”æ¯ä¸ªå®¹å™¨ç»„ä»¶æœ‰ä¸€ä¸ª BasicValveï¼ˆåŸºç¡€é˜€ï¼‰ã€‚Wrapper ä½œä¸ºä¸€ä¸ªå®¹å™¨ç»„ä»¶ï¼Œå®ƒä¹Ÿæœ‰è‡ªå·±çš„ Pipeline å’Œ BasicValveï¼ŒWrapper çš„ BasicValve å« <strong>StandardWrapperValve</strong>ã€‚</p>
<p>ä½ å¯ä»¥æƒ³åˆ°ï¼Œå½“è¯·æ±‚åˆ°æ¥æ—¶ï¼ŒContext å®¹å™¨çš„ BasicValve ä¼šè°ƒç”¨ Wrapper å®¹å™¨ä¸­ Pipeline ä¸­çš„ç¬¬ä¸€ä¸ª Valveï¼Œç„¶åä¼šè°ƒç”¨åˆ° StandardWrapperValveã€‚æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹å®ƒçš„ invoke æ–¹æ³•æ˜¯å¦‚ä½•å®ç°çš„ï¼ŒåŒæ ·ä¸ºäº†æ–¹ä¾¿ä½ é˜…è¯»ï¼Œæˆ‘ç®€åŒ–äº†ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">invoke</span><span class="params">(Request request, Response response)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//1. å®ä¾‹åŒ– Servlet</span></span><br><span class="line">    servlet = wrapper.allocate();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2. ç»™å½“å‰è¯·æ±‚åˆ›å»ºä¸€ä¸ª Filter é“¾</span></span><br><span class="line">    <span class="type">ApplicationFilterChain</span> <span class="variable">filterChain</span> <span class="operator">=</span></span><br><span class="line">        ApplicationFilterFactory.createFilterChain(request, wrapper, servlet);</span><br><span class="line"></span><br><span class="line">   <span class="comment">//3. è°ƒç”¨è¿™ä¸ª Filter é“¾ï¼ŒFilter é“¾ä¸­çš„æœ€åä¸€ä¸ª Filter ä¼šè°ƒç”¨ Servlet</span></span><br><span class="line">   filterChain.doFilter(request.getRequest(), response.getResponse());</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>StandardWrapperValve çš„ invoke æ–¹æ³•æ¯”è¾ƒå¤æ‚ï¼Œå»æ‰å…¶ä»–å¼‚å¸¸å¤„ç†çš„ä¸€äº›ç»†èŠ‚ï¼Œæœ¬è´¨ä¸Šå°±æ˜¯ä¸‰æ­¥ï¼š</p>
<ul>
<li>ç¬¬ä¸€æ­¥ï¼Œåˆ›å»º Servlet å®ä¾‹ï¼›</li>
<li>ç¬¬äºŒæ­¥ï¼Œç»™å½“å‰è¯·æ±‚åˆ›å»ºä¸€ä¸ª Filter é“¾ï¼›</li>
<li>ç¬¬ä¸‰æ­¥ï¼Œè°ƒç”¨è¿™ä¸ª Filter é“¾ã€‚</li>
</ul>
<p>ä½ å¯èƒ½ä¼šé—®ï¼Œä¸ºä»€ä¹ˆéœ€è¦ç»™æ¯ä¸ªè¯·æ±‚åˆ›å»ºä¸€ä¸ª Filter é“¾ï¼Ÿè¿™æ˜¯å› ä¸ºæ¯ä¸ªè¯·æ±‚çš„è¯·æ±‚è·¯å¾„éƒ½ä¸ä¸€æ ·ï¼Œè€Œ Filter éƒ½æœ‰ç›¸åº”çš„è·¯å¾„æ˜ å°„ï¼Œå› æ­¤ä¸æ˜¯æ‰€æœ‰çš„ Filter éƒ½éœ€è¦æ¥å¤„ç†å½“å‰çš„è¯·æ±‚ï¼Œæˆ‘ä»¬éœ€è¦æ ¹æ®è¯·æ±‚çš„è·¯å¾„æ¥é€‰æ‹©ç‰¹å®šçš„ä¸€äº› Filter æ¥å¤„ç†ã€‚</p>
<p>ç¬¬äºŒä¸ªé—®é¢˜æ˜¯ï¼Œä¸ºä»€ä¹ˆæ²¡æœ‰çœ‹åˆ°è°ƒåˆ° Servlet çš„ service æ–¹æ³•ï¼Ÿè¿™æ˜¯å› ä¸º Filter é“¾çš„ doFilter æ–¹æ³•ä¼šè´Ÿè´£è°ƒç”¨ Servletï¼Œå…·ä½“æ¥è¯´å°±æ˜¯ Filter é“¾ä¸­çš„æœ€åä¸€ä¸ª Filter ä¼šè´Ÿè´£è°ƒç”¨ Servletã€‚</p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹ Filter çš„å®ç°åŸç†ã€‚</p>
<h3 id="Filter-ç®¡ç†"><a href="#Filter-ç®¡ç†" class="headerlink" title="Filter ç®¡ç†"></a>Filter ç®¡ç†</h3><p>æˆ‘ä»¬çŸ¥é“ï¼Œè·Ÿ Servlet ä¸€æ ·ï¼ŒFilter ä¹Ÿå¯ä»¥åœ¨<code>web.xml</code>æ–‡ä»¶é‡Œè¿›è¡Œé…ç½®ï¼Œä¸åŒçš„æ˜¯ï¼ŒFilter çš„ä½œç”¨åŸŸæ˜¯æ•´ä¸ª Web åº”ç”¨ï¼Œå› æ­¤ Filter çš„å®ä¾‹æ˜¯åœ¨ Context å®¹å™¨ä¸­è¿›è¡Œç®¡ç†çš„ï¼ŒContext å®¹å™¨ç”¨ Map é›†åˆæ¥ä¿å­˜ Filterã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Map&lt;String, FilterDef&gt; filterDefs = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br></pre></td></tr></table></figure>

<p>é‚£ä¸Šé¢æåˆ°çš„ Filter é“¾åˆæ˜¯ä»€ä¹ˆå‘¢ï¼ŸFilter é“¾çš„å­˜æ´»æœŸå¾ˆçŸ­ï¼Œå®ƒæ˜¯è·Ÿæ¯ä¸ªè¯·æ±‚å¯¹åº”çš„ã€‚ä¸€ä¸ªæ–°çš„è¯·æ±‚æ¥äº†ï¼Œå°±åŠ¨æ€åˆ›å»ºä¸€ä¸ª FIlter é“¾ï¼Œè¯·æ±‚å¤„ç†å®Œäº†ï¼ŒFilter é“¾ä¹Ÿå°±è¢«å›æ”¶äº†ã€‚ç†è§£å®ƒçš„åŸç†ä¹Ÿéå¸¸å…³é”®ï¼Œæˆ‘ä»¬è¿˜æ˜¯æ¥çœ‹çœ‹æºç ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">ApplicationFilterChain</span> <span class="keyword">implements</span> <span class="title class_">FilterChain</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//Filter é“¾ä¸­æœ‰ Filter æ•°ç»„ï¼Œè¿™ä¸ªå¥½ç†è§£</span></span><br><span class="line">  <span class="keyword">private</span> ApplicationFilterConfig[] filters = <span class="keyword">new</span> <span class="title class_">ApplicationFilterConfig</span>[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">  <span class="comment">//Filter é“¾ä¸­çš„å½“å‰çš„è°ƒç”¨ä½ç½®</span></span><br><span class="line">  <span class="keyword">private</span> <span class="type">int</span> <span class="variable">pos</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ€»å…±æœ‰å¤šå°‘äº† Filter</span></span><br><span class="line">  <span class="keyword">private</span> <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ¯ä¸ª Filter é“¾å¯¹åº”ä¸€ä¸ª Servletï¼Œä¹Ÿå°±æ˜¯å®ƒè¦è°ƒç”¨çš„ Servlet</span></span><br><span class="line">  <span class="keyword">private</span> <span class="type">Servlet</span> <span class="variable">servlet</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest req, ServletResponse res)</span> &#123;</span><br><span class="line">        internalDoFilter(request,response);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">internalDoFilter</span><span class="params">(ServletRequest req,</span></span><br><span class="line"><span class="params">                                ServletResponse res)</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¯ä¸ª Filter é“¾åœ¨å†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ª Filter æ•°ç»„</span></span><br><span class="line">    <span class="keyword">if</span> (pos &lt; n) &#123;</span><br><span class="line">        <span class="type">ApplicationFilterConfig</span> <span class="variable">filterConfig</span> <span class="operator">=</span> filters[pos++];</span><br><span class="line">        <span class="type">Filter</span> <span class="variable">filter</span> <span class="operator">=</span> filterConfig.getFilter();</span><br><span class="line"></span><br><span class="line">        filter.doFilter(request, response, <span class="built_in">this</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    servlet.service(request, response);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä» ApplicationFilterChain çš„æºç æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å‡ ä¸ªå…³é”®ä¿¡æ¯ï¼š</p>
<ul>
<li>Filter é“¾ä¸­é™¤äº†æœ‰ Filter å¯¹è±¡çš„æ•°ç»„ï¼Œè¿˜æœ‰ä¸€ä¸ªæ•´æ•°å˜é‡ posï¼Œè¿™ä¸ªå˜é‡ç”¨æ¥è®°å½•å½“å‰è¢«è°ƒç”¨çš„ Filter åœ¨æ•°ç»„ä¸­çš„ä½ç½®ã€‚</li>
<li>Filter é“¾ä¸­æœ‰ä¸ª Servlet å®ä¾‹ï¼Œè¿™ä¸ªå¥½ç†è§£ï¼Œå› ä¸ºä¸Šé¢æåˆ°äº†ï¼Œæ¯ä¸ª Filter é“¾æœ€åéƒ½ä¼šè°ƒåˆ°ä¸€ä¸ª Servletã€‚</li>
<li>Filter é“¾æœ¬èº«ä¹Ÿå®ç°äº† doFilter æ–¹æ³•ï¼Œç›´æ¥è°ƒç”¨äº†ä¸€ä¸ªå†…éƒ¨æ–¹æ³• internalDoFilterã€‚</li>
<li>internalDoFilter æ–¹æ³•çš„å®ç°æ¯”è¾ƒæœ‰æ„æ€ï¼Œå®ƒåšäº†ä¸€ä¸ªåˆ¤æ–­ï¼Œå¦‚æœå½“å‰ Filter çš„ä½ç½®å°äº Filter æ•°ç»„çš„é•¿åº¦ï¼Œä¹Ÿå°±æ˜¯è¯´ Filter è¿˜æ²¡è°ƒå®Œï¼Œå°±ä» Filter æ•°ç»„æ‹¿ä¸‹ä¸€ä¸ª Filterï¼Œè°ƒç”¨å®ƒçš„ doFilter æ–¹æ³•ã€‚å¦åˆ™ï¼Œæ„å‘³ç€æ‰€æœ‰ Filter éƒ½è°ƒåˆ°äº†ï¼Œå°±è°ƒç”¨ Servlet çš„ service æ–¹æ³•ã€‚</li>
</ul>
<p>ä½†é—®é¢˜æ˜¯ï¼Œæ–¹æ³•ä½“é‡Œæ²¡çœ‹åˆ°å¾ªç¯ï¼Œè°åœ¨ä¸åœåœ°è°ƒç”¨ Filter é“¾çš„ doFIlter æ–¹æ³•å‘¢ï¼ŸFilter æ˜¯æ€ä¹ˆä¾æ¬¡è°ƒåˆ°çš„å‘¢ï¼Ÿ</p>
<p>ç­”æ¡ˆæ˜¯<strong>Filter æœ¬èº«çš„ doFilter æ–¹æ³•ä¼šè°ƒç”¨ Filter é“¾çš„ doFilter æ–¹æ³•</strong>ï¼Œæˆ‘ä»¬è¿˜æ˜¯æ¥çœ‹çœ‹ä»£ç å°±æ˜ç™½äº†ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest request, ServletResponse response,</span></span><br><span class="line"><span class="params">        FilterChain chain)</span>&#123;</span><br><span class="line"></span><br><span class="line">          ...</span><br><span class="line"></span><br><span class="line">          <span class="comment">// è°ƒç”¨ Filter çš„æ–¹æ³•</span></span><br><span class="line">          chain.doFilter(request, response);</span><br><span class="line"></span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>

<p>æ³¨æ„ Filter çš„ doFilter æ–¹æ³•æœ‰ä¸ªå…³é”®å‚æ•° FilterChainï¼Œå°±æ˜¯ Filter é“¾ã€‚å¹¶ä¸”æ¯ä¸ª Filter åœ¨å®ç° doFilter æ—¶ï¼Œå¿…é¡»è¦è°ƒç”¨ Filter é“¾çš„ doFilter æ–¹æ³•ï¼Œè€Œ Filter é“¾ä¸­ä¿å­˜å½“å‰ FIlter çš„ä½ç½®ï¼Œä¼šè°ƒç”¨ä¸‹ä¸€ä¸ª FIlter çš„ doFilter æ–¹æ³•ï¼Œè¿™æ ·é“¾å¼è°ƒç”¨å°±å®Œæˆäº†ã€‚</p>
<p>Filter é“¾è·Ÿ Tomcat çš„ Pipeline-Valve æœ¬è´¨éƒ½æ˜¯è´£ä»»é“¾æ¨¡å¼ï¼Œä½†æ˜¯åœ¨å…·ä½“å®ç°ä¸Šç¨æœ‰ä¸åŒï¼Œä½ å¯ä»¥ç»†ç»†ä½“ä¼šä¸€ä¸‹ã€‚</p>
<h3 id="Listener-ç®¡ç†"><a href="#Listener-ç®¡ç†" class="headerlink" title="Listener ç®¡ç†"></a>Listener ç®¡ç†</h3><p>æˆ‘ä»¬æ¥ç€èŠ Servlet è§„èŒƒé‡Œ Listenerã€‚è·Ÿ Filter ä¸€æ ·ï¼ŒListener ä¹Ÿæ˜¯ä¸€ç§æ‰©å±•æœºåˆ¶ï¼Œä½ å¯ä»¥ç›‘å¬å®¹å™¨å†…éƒ¨å‘ç”Ÿçš„äº‹ä»¶ï¼Œä¸»è¦æœ‰ä¸¤ç±»äº‹ä»¶ï¼š</p>
<ul>
<li>ç¬¬ä¸€ç±»æ˜¯ç”Ÿå‘½çŠ¶æ€çš„å˜åŒ–ï¼Œæ¯”å¦‚ Context å®¹å™¨å¯åŠ¨å’Œåœæ­¢ã€Session çš„åˆ›å»ºå’Œé”€æ¯ã€‚</li>
<li>ç¬¬äºŒç±»æ˜¯å±æ€§çš„å˜åŒ–ï¼Œæ¯”å¦‚ Context å®¹å™¨æŸä¸ªå±æ€§å€¼å˜äº†ã€Session çš„æŸä¸ªå±æ€§å€¼å˜äº†ä»¥åŠæ–°çš„è¯·æ±‚æ¥äº†ç­‰ã€‚</li>
</ul>
<p>æˆ‘ä»¬å¯ä»¥åœ¨<code>web.xml</code>é…ç½®æˆ–è€…é€šè¿‡æ³¨è§£çš„æ–¹å¼æ¥æ·»åŠ ç›‘å¬å™¨ï¼Œåœ¨ç›‘å¬å™¨é‡Œå®ç°æˆ‘ä»¬çš„ä¸šåŠ¡é€»è¾‘ã€‚å¯¹äº Tomcat æ¥è¯´ï¼Œå®ƒéœ€è¦è¯»å–é…ç½®æ–‡ä»¶ï¼Œæ‹¿åˆ°ç›‘å¬å™¨ç±»çš„åå­—ï¼Œå®ä¾‹åŒ–è¿™äº›ç±»ï¼Œå¹¶ä¸”åœ¨åˆé€‚çš„æ—¶æœºè°ƒç”¨è¿™äº›ç›‘å¬å™¨çš„æ–¹æ³•ã€‚</p>
<p>Tomcat æ˜¯é€šè¿‡ Context å®¹å™¨æ¥ç®¡ç†è¿™äº›ç›‘å¬å™¨çš„ã€‚Context å®¹å™¨å°†ä¸¤ç±»äº‹ä»¶åˆ†å¼€æ¥ç®¡ç†ï¼Œåˆ†åˆ«ç”¨ä¸åŒçš„é›†åˆæ¥å­˜æ”¾ä¸åŒç±»å‹äº‹ä»¶çš„ç›‘å¬å™¨ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç›‘å¬å±æ€§å€¼å˜åŒ–çš„ç›‘å¬å™¨</span></span><br><span class="line"><span class="keyword">private</span> List&lt;Object&gt; applicationEventListenersList = <span class="keyword">new</span> <span class="title class_">CopyOnWriteArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç›‘å¬ç”Ÿå‘½äº‹ä»¶çš„ç›‘å¬å™¨</span></span><br><span class="line"><span class="keyword">private</span> Object applicationLifecycleListenersObjects[] = <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>];</span><br></pre></td></tr></table></figure>

<p>å‰©ä¸‹çš„äº‹æƒ…å°±æ˜¯è§¦å‘ç›‘å¬å™¨äº†ï¼Œæ¯”å¦‚åœ¨ Context å®¹å™¨çš„å¯åŠ¨æ–¹æ³•é‡Œï¼Œå°±è§¦å‘äº†æ‰€æœ‰çš„ ServletContextListenerï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//1. æ‹¿åˆ°æ‰€æœ‰çš„ç”Ÿå‘½å‘¨æœŸç›‘å¬å™¨</span></span><br><span class="line">Object instances[] = getApplicationLifecycleListeners();</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; instances.length; i++) &#123;</span><br><span class="line">   <span class="comment">//2. åˆ¤æ–­ Listener çš„ç±»å‹æ˜¯ä¸æ˜¯ ServletContextListener</span></span><br><span class="line">   <span class="keyword">if</span> (!(instances[i] <span class="keyword">instanceof</span> ServletContextListener))</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">//3. è§¦å‘ Listener çš„æ–¹æ³•</span></span><br><span class="line">   <span class="type">ServletContextListener</span> <span class="variable">lr</span> <span class="operator">=</span> (ServletContextListener) instances[i];</span><br><span class="line">   lr.contextInitialized(event);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œçš„ ServletContextListener æ¥å£æ˜¯ä¸€ç§ç•™ç»™ç”¨æˆ·çš„æ‰©å±•æœºåˆ¶ï¼Œç”¨æˆ·å¯ä»¥å®ç°è¿™ä¸ªæ¥å£æ¥å®šä¹‰è‡ªå·±çš„ç›‘å¬å™¨ï¼Œç›‘å¬ Context å®¹å™¨çš„å¯åœäº‹ä»¶ã€‚Spring å°±æ˜¯è¿™ä¹ˆåšçš„ã€‚ServletContextListener è·Ÿ Tomcat è‡ªå·±çš„ç”Ÿå‘½å‘¨æœŸäº‹ä»¶ LifecycleListener æ˜¯ä¸åŒçš„ã€‚LifecycleListener å®šä¹‰åœ¨ç”Ÿå‘½å‘¨æœŸç®¡ç†ç»„ä»¶ä¸­ï¼Œç”±åŸºç±» LifeCycleBase ç»Ÿä¸€ç®¡ç†ã€‚</p>
<h2 id="Tomcat-æ”¯æŒå¼‚æ­¥-Servlet"><a href="#Tomcat-æ”¯æŒå¼‚æ­¥-Servlet" class="headerlink" title="Tomcat æ”¯æŒå¼‚æ­¥ Servlet"></a>Tomcat æ”¯æŒå¼‚æ­¥ Servlet</h2><h3 id="å¼‚æ­¥ç¤ºä¾‹"><a href="#å¼‚æ­¥ç¤ºä¾‹" class="headerlink" title="å¼‚æ­¥ç¤ºä¾‹"></a>å¼‚æ­¥ç¤ºä¾‹</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@WebServlet(urlPatterns = &#123;&quot;/async&quot;&#125;, asyncSupported = true)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AsyncServlet</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Web åº”ç”¨çº¿ç¨‹æ± ï¼Œç”¨æ¥å¤„ç†å¼‚æ­¥ Servlet</span></span><br><span class="line">    <span class="type">ExecutorService</span> <span class="variable">executor</span> <span class="operator">=</span> Executors.newSingleThreadExecutor();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">service</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> &#123;</span><br><span class="line">        <span class="comment">//1. è°ƒç”¨ startAsync æˆ–è€…å¼‚æ­¥ä¸Šä¸‹æ–‡</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">AsyncContext</span> <span class="variable">ctx</span> <span class="operator">=</span> req.startAsync();</span><br><span class="line"></span><br><span class="line">       <span class="comment">// ç”¨çº¿ç¨‹æ± æ¥æ‰§è¡Œè€—æ—¶æ“ä½œ</span></span><br><span class="line">        executor.execute(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// åœ¨è¿™é‡Œåšè€—æ—¶çš„æ“ä½œ</span></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    ctx.getResponse().getWriter().println(<span class="string">&quot;Handling Async Servlet&quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;&#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//3. å¼‚æ­¥ Servlet å¤„ç†å®Œäº†è°ƒç”¨å¼‚æ­¥ä¸Šä¸‹æ–‡çš„ complete æ–¹æ³•</span></span><br><span class="line">                ctx.complete();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æœ‰ä¸‰ä¸ªè¦ç‚¹ï¼š</p>
<ol>
<li>é€šè¿‡æ³¨è§£çš„æ–¹å¼æ¥æ³¨å†Œ Servletï¼Œé™¤äº† @WebServlet æ³¨è§£ï¼Œè¿˜éœ€è¦åŠ ä¸Š asyncSupported&#x3D;true çš„å±æ€§ï¼Œè¡¨æ˜å½“å‰çš„ Servlet æ˜¯ä¸€ä¸ªå¼‚æ­¥ Servletã€‚</li>
<li>Web åº”ç”¨ç¨‹åºéœ€è¦è°ƒç”¨ Request å¯¹è±¡çš„ startAsync æ–¹æ³•æ¥æ‹¿åˆ°ä¸€ä¸ªå¼‚æ­¥ä¸Šä¸‹æ–‡ AsyncContextã€‚è¿™ä¸ªä¸Šä¸‹æ–‡ä¿å­˜äº†è¯·æ±‚å’Œå“åº”å¯¹è±¡ã€‚</li>
<li>Web åº”ç”¨éœ€è¦å¼€å¯ä¸€ä¸ªæ–°çº¿ç¨‹æ¥å¤„ç†è€—æ—¶çš„æ“ä½œï¼Œå¤„ç†å®Œæˆåéœ€è¦è°ƒç”¨ AsyncContext çš„ complete æ–¹æ³•ã€‚ç›®çš„æ˜¯å‘Šè¯‰ Tomcatï¼Œè¯·æ±‚å·²ç»å¤„ç†å®Œæˆã€‚</li>
</ol>
<p>è¿™é‡Œè¯·ä½ æ³¨æ„ï¼Œè™½ç„¶å¼‚æ­¥ Servlet å…è®¸ç”¨æ›´é•¿çš„æ—¶é—´æ¥å¤„ç†è¯·æ±‚ï¼Œä½†æ˜¯ä¹Ÿæœ‰è¶…æ—¶é™åˆ¶çš„ï¼Œé»˜è®¤æ˜¯ 30 ç§’ï¼Œå¦‚æœ 30 ç§’å†…è¯·æ±‚è¿˜æ²¡å¤„ç†å®Œï¼ŒTomcat ä¼šè§¦å‘è¶…æ—¶æœºåˆ¶ï¼Œå‘æµè§ˆå™¨è¿”å›è¶…æ—¶é”™è¯¯ï¼Œå¦‚æœè¿™ä¸ªæ—¶å€™ä½ çš„ Web åº”ç”¨å†è°ƒç”¨<code>ctx.complete</code>æ–¹æ³•ï¼Œä¼šå¾—åˆ°ä¸€ä¸ª IllegalStateException å¼‚å¸¸ã€‚</p>
<h3 id="å¼‚æ­¥-Servlet-åŸç†"><a href="#å¼‚æ­¥-Servlet-åŸç†" class="headerlink" title="å¼‚æ­¥ Servlet åŸç†"></a>å¼‚æ­¥ Servlet åŸç†</h3><p>é€šè¿‡ä¸Šé¢çš„ä¾‹å­ï¼Œç›¸ä¿¡ä½ å¯¹ Servlet çš„å¼‚æ­¥å®ç°æœ‰äº†åŸºæœ¬çš„ç†è§£ã€‚è¦ç†è§£ Tomcat åœ¨è¿™ä¸ªè¿‡ç¨‹éƒ½åšäº†ä»€ä¹ˆäº‹æƒ…ï¼Œå…³é”®å°±æ˜¯è¦å¼„æ¸…æ¥š<code>req.startAsync</code>æ–¹æ³•å’Œ<code>ctx.complete</code>æ–¹æ³•éƒ½åšäº†ä»€ä¹ˆã€‚</p>
<h4 id="startAsync-æ–¹æ³•"><a href="#startAsync-æ–¹æ³•" class="headerlink" title="startAsync æ–¹æ³•"></a>startAsync æ–¹æ³•</h4><p>startAsync æ–¹æ³•å…¶å®å°±æ˜¯åˆ›å»ºäº†ä¸€ä¸ªå¼‚æ­¥ä¸Šä¸‹æ–‡ AsyncContext å¯¹è±¡ï¼ŒAsyncContext å¯¹è±¡çš„ä½œç”¨æ˜¯ä¿å­˜è¯·æ±‚çš„ä¸­é—´ä¿¡æ¯ï¼Œæ¯”å¦‚ Request å’Œ Response å¯¹è±¡ç­‰ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚ä½ æ¥æ€è€ƒä¸€ä¸‹ä¸ºä»€ä¹ˆéœ€è¦ä¿å­˜è¿™äº›ä¿¡æ¯å‘¢ï¼Ÿ</p>
<p>è¿™æ˜¯å› ä¸º Tomcat çš„å·¥ä½œçº¿ç¨‹åœ¨<code>Request.startAsync</code>è°ƒç”¨ä¹‹åï¼Œå°±ç›´æ¥ç»“æŸå›åˆ°çº¿ç¨‹æ± ä¸­äº†ï¼Œçº¿ç¨‹æœ¬èº«ä¸ä¼šä¿å­˜ä»»ä½•ä¿¡æ¯ã€‚ä¹Ÿå°±æ˜¯è¯´ä¸€ä¸ªè¯·æ±‚åˆ°æœåŠ¡ç«¯ï¼Œæ‰§è¡Œåˆ°ä¸€åŠï¼Œä½ çš„ Web åº”ç”¨æ­£åœ¨å¤„ç†ï¼Œè¿™ä¸ªæ—¶å€™ Tomcat çš„å·¥ä½œçº¿ç¨‹æ²¡äº†ï¼Œè¿™å°±éœ€è¦æœ‰ä¸ªç¼“å­˜èƒ½å¤Ÿä¿å­˜åŸå§‹çš„ Request å’Œ Response å¯¹è±¡ï¼Œè€Œè¿™ä¸ªç¼“å­˜å°±æ˜¯ AsyncContextã€‚</p>
<p>æœ‰äº† AsyncContextï¼Œä½ çš„ Web åº”ç”¨é€šè¿‡å®ƒæ‹¿åˆ° request å’Œ response å¯¹è±¡ï¼Œæ‹¿åˆ° Request å¯¹è±¡åå°±å¯ä»¥è¯»å–è¯·æ±‚ä¿¡æ¯ï¼Œè¯·æ±‚å¤„ç†å®Œäº†è¿˜éœ€è¦é€šè¿‡ Response å¯¹è±¡å°† HTTP å“åº”å‘é€ç»™æµè§ˆå™¨ã€‚</p>
<p>é™¤äº†åˆ›å»º AsyncContext å¯¹è±¡ï¼ŒstartAsync è¿˜éœ€è¦å®Œæˆä¸€ä¸ªå…³é”®ä»»åŠ¡ï¼Œé‚£å°±æ˜¯å‘Šè¯‰ Tomcat å½“å‰çš„ Servlet å¤„ç†æ–¹æ³•è¿”å›æ—¶ï¼Œä¸è¦æŠŠå“åº”å‘åˆ°æµè§ˆå™¨ï¼Œå› ä¸ºè¿™ä¸ªæ—¶å€™ï¼Œå“åº”è¿˜æ²¡ç”Ÿæˆå‘¢ï¼›å¹¶ä¸”ä¸èƒ½æŠŠ Request å¯¹è±¡å’Œ Response å¯¹è±¡é”€æ¯ï¼Œå› ä¸ºåé¢ Web åº”ç”¨è¿˜è¦ç”¨å‘¢ã€‚</p>
<p>åœ¨ Tomcat ä¸­ï¼Œè´Ÿè´£ flush å“åº”æ•°æ®çš„æ˜¯ CoyoteAdaptorï¼Œå®ƒè¿˜ä¼šé”€æ¯ Request å¯¹è±¡å’Œ Response å¯¹è±¡ï¼Œå› æ­¤éœ€è¦é€šè¿‡æŸç§æœºåˆ¶é€šçŸ¥ CoyoteAdaptorï¼Œå…·ä½“æ¥è¯´æ˜¯é€šè¿‡ä¸‹é¢è¿™è¡Œä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">this</span>.request.getCoyoteRequest().action(ActionCode.ASYNC_START, <span class="built_in">this</span>);</span><br></pre></td></tr></table></figure>

<p>ä½ å¯ä»¥æŠŠå®ƒç†è§£ä¸ºä¸€ä¸ª Callbackï¼Œåœ¨è¿™ä¸ª action æ–¹æ³•é‡Œè®¾ç½®äº† Request å¯¹è±¡çš„çŠ¶æ€ï¼Œè®¾ç½®å®ƒä¸ºä¸€ä¸ªå¼‚æ­¥ Servlet è¯·æ±‚ã€‚</p>
<p>æˆ‘ä»¬çŸ¥é“è¿æ¥å™¨æ˜¯è°ƒç”¨ CoyoteAdapter çš„ service æ–¹æ³•æ¥å¤„ç†è¯·æ±‚çš„ï¼Œè€Œ CoyoteAdapter ä¼šè°ƒç”¨å®¹å™¨çš„ service æ–¹æ³•ï¼Œå½“å®¹å™¨çš„ service æ–¹æ³•è¿”å›æ—¶ï¼ŒCoyoteAdapter åˆ¤æ–­å½“å‰çš„è¯·æ±‚æ˜¯ä¸æ˜¯å¼‚æ­¥ Servlet è¯·æ±‚ï¼Œå¦‚æœæ˜¯ï¼Œå°±ä¸ä¼šé”€æ¯ Request å’Œ Response å¯¹è±¡ï¼Œä¹Ÿä¸ä¼šæŠŠå“åº”ä¿¡æ¯å‘åˆ°æµè§ˆå™¨ã€‚ä½ å¯ä»¥é€šè¿‡ä¸‹é¢çš„ä»£ç ç†è§£ä¸€ä¸‹ï¼Œè¿™æ˜¯ CoyoteAdapter çš„ service æ–¹æ³•ï¼Œæˆ‘å¯¹å®ƒè¿›è¡Œäº†ç®€åŒ–ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">service</span><span class="params">(org.apache.coyote.Request req, org.apache.coyote.Response res)</span> &#123;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// è°ƒç”¨å®¹å™¨çš„ service æ–¹æ³•å¤„ç†è¯·æ±‚</span></span><br><span class="line">    connector.getService().getContainer().getPipeline().</span><br><span class="line">           getFirst().invoke(request, response);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// å¦‚æœæ˜¯å¼‚æ­¥ Servlet è¯·æ±‚ï¼Œä»…ä»…è®¾ç½®ä¸€ä¸ªæ ‡å¿—ï¼Œ</span></span><br><span class="line">   <span class="comment">// å¦åˆ™è¯´æ˜æ˜¯åŒæ­¥ Servlet è¯·æ±‚ï¼Œå°±å°†å“åº”æ•°æ®åˆ·åˆ°æµè§ˆå™¨</span></span><br><span class="line">    <span class="keyword">if</span> (request.isAsync()) &#123;</span><br><span class="line">        async = <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        request.finishRequest();</span><br><span class="line">        response.finishResponse();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// å¦‚æœä¸æ˜¯å¼‚æ­¥ Servlet è¯·æ±‚ï¼Œå°±é”€æ¯ Request å¯¹è±¡å’Œ Response å¯¹è±¡</span></span><br><span class="line">    <span class="keyword">if</span> (!async) &#123;</span><br><span class="line">        request.recycle();</span><br><span class="line">        response.recycle();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥ï¼Œå½“ CoyoteAdaptor çš„ service æ–¹æ³•è¿”å›åˆ° ProtocolHandler ç»„ä»¶æ—¶ï¼ŒProtocolHandler åˆ¤æ–­è¿”å›å€¼ï¼Œå¦‚æœå½“å‰è¯·æ±‚æ˜¯ä¸€ä¸ªå¼‚æ­¥ Servlet è¯·æ±‚ï¼Œå®ƒä¼šæŠŠå½“å‰ Socket çš„åè®®å¤„ç†è€… Processor ç¼“å­˜èµ·æ¥ï¼Œå°† SocketWrapper å¯¹è±¡å’Œç›¸åº”çš„ Processor å­˜åˆ°ä¸€ä¸ª Map æ•°æ®ç»“æ„é‡Œã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;S,Processor&gt; connections = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br></pre></td></tr></table></figure>

<p>ä¹‹æ‰€ä»¥è¦ç¼“å­˜æ˜¯å› ä¸ºè¿™ä¸ªè¯·æ±‚æ¥ä¸‹æ¥è¿˜è¦æ¥ç€å¤„ç†ï¼Œè¿˜æ˜¯ç”±åŸæ¥çš„ Processor æ¥å¤„ç†ï¼Œé€šè¿‡ SocketWrapper å°±èƒ½ä» Map é‡Œæ‰¾åˆ°ç›¸åº”çš„ Processorã€‚</p>
<h4 id="complete-æ–¹æ³•"><a href="#complete-æ–¹æ³•" class="headerlink" title="complete æ–¹æ³•"></a>complete æ–¹æ³•</h4><p>æ¥ç€æˆ‘ä»¬å†æ¥çœ‹å…³é”®çš„<code>ctx.complete</code>æ–¹æ³•ï¼Œå½“è¯·æ±‚å¤„ç†å®Œæˆæ—¶ï¼ŒWeb åº”ç”¨è°ƒç”¨è¿™ä¸ªæ–¹æ³•ã€‚é‚£ä¹ˆè¿™ä¸ªæ–¹æ³•åšäº†äº›ä»€ä¹ˆäº‹æƒ…å‘¢ï¼Ÿæœ€é‡è¦çš„å°±æ˜¯æŠŠå“åº”æ•°æ®å‘é€åˆ°æµè§ˆå™¨ã€‚</p>
<p>è¿™ä»¶äº‹æƒ…ä¸èƒ½ç”± Web åº”ç”¨çº¿ç¨‹æ¥åšï¼Œä¹Ÿå°±æ˜¯è¯´<code>ctx.complete</code>æ–¹æ³•ä¸èƒ½ç›´æ¥æŠŠå“åº”æ•°æ®å‘é€åˆ°æµè§ˆå™¨ï¼Œå› ä¸ºè¿™ä»¶äº‹æƒ…åº”è¯¥ç”± Tomcat çº¿ç¨‹æ¥åšï¼Œä½†å…·ä½“æ€ä¹ˆåšå‘¢ï¼Ÿ</p>
<p>æˆ‘ä»¬çŸ¥é“ï¼Œè¿æ¥å™¨ä¸­çš„ Endpoint ç»„ä»¶æ£€æµ‹åˆ°æœ‰è¯·æ±‚æ•°æ®è¾¾åˆ°æ—¶ï¼Œä¼šåˆ›å»ºä¸€ä¸ª SocketProcessor å¯¹è±¡äº¤ç»™çº¿ç¨‹æ± å»å¤„ç†ï¼Œå› æ­¤ Endpoint çš„é€šä¿¡å¤„ç†å’Œå…·ä½“è¯·æ±‚å¤„ç†åœ¨ä¸¤ä¸ªçº¿ç¨‹é‡Œè¿è¡Œã€‚</p>
<p>åœ¨å¼‚æ­¥ Servlet çš„åœºæ™¯é‡Œï¼ŒWeb åº”ç”¨é€šè¿‡è°ƒç”¨<code>ctx.complete</code>æ–¹æ³•æ—¶ï¼Œä¹Ÿå¯ä»¥ç”Ÿæˆä¸€ä¸ªæ–°çš„ SocketProcessor ä»»åŠ¡ç±»ï¼Œäº¤ç»™çº¿ç¨‹æ± å¤„ç†ã€‚å¯¹äºå¼‚æ­¥ Servlet è¯·æ±‚æ¥è¯´ï¼Œç›¸åº”çš„ Socket å’Œåè®®å¤„ç†ç»„ä»¶ Processor éƒ½è¢«ç¼“å­˜èµ·æ¥äº†ï¼Œå¹¶ä¸”è¿™äº›å¯¹è±¡éƒ½å¯ä»¥é€šè¿‡ Request å¯¹è±¡æ‹¿åˆ°ã€‚</p>
<p>è®²åˆ°è¿™é‡Œï¼Œä½ å¯èƒ½å·²ç»çŒœåˆ°<code>ctx.complete</code>æ˜¯å¦‚ä½•å®ç°çš„äº†ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">complete</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// æ£€æŸ¥çŠ¶æ€åˆæ³•æ€§ï¼Œæˆ‘ä»¬å…ˆå¿½ç•¥è¿™å¥</span></span><br><span class="line">    check();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è°ƒç”¨ Request å¯¹è±¡çš„ action æ–¹æ³•ï¼Œå…¶å®å°±æ˜¯é€šçŸ¥è¿æ¥å™¨ï¼Œè¿™ä¸ªå¼‚æ­¥è¯·æ±‚å¤„ç†å®Œäº†</span></span><br><span class="line">request.getCoyoteRequest().action(ActionCode.ASYNC_COMPLETE, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ° complete æ–¹æ³•è°ƒç”¨äº† Request å¯¹è±¡çš„ action æ–¹æ³•ã€‚è€Œåœ¨ action æ–¹æ³•é‡Œï¼Œåˆ™æ˜¯è°ƒç”¨äº† Processor çš„ processSocketEvent æ–¹æ³•ï¼Œå¹¶ä¸”ä¼ å…¥äº†æ“ä½œç  OPEN_READã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> ASYNC_COMPLETE: &#123;</span><br><span class="line">    clearDispatches();</span><br><span class="line">    <span class="keyword">if</span> (asyncStateMachine.asyncComplete()) &#123;</span><br><span class="line">        processSocketEvent(SocketEvent.OPEN_READ, <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬æ¥ç€çœ‹ processSocketEvent æ–¹æ³•ï¼Œå®ƒè°ƒç”¨ SocketWrapper çš„ processSocket æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">processSocketEvent</span><span class="params">(SocketEvent event, <span class="type">boolean</span> dispatch)</span> &#123;</span><br><span class="line">    SocketWrapperBase&lt;?&gt; socketWrapper = getSocketWrapper();</span><br><span class="line">    <span class="keyword">if</span> (socketWrapper != <span class="literal">null</span>) &#123;</span><br><span class="line">        socketWrapper.processSocket(event, dispatch);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è€Œ SocketWrapper çš„ processSocket æ–¹æ³•ä¼šåˆ›å»º SocketProcessor ä»»åŠ¡ç±»ï¼Œå¹¶é€šè¿‡ Tomcat çº¿ç¨‹æ± æ¥å¤„ç†ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">processSocket</span><span class="params">(SocketWrapperBase&lt;S&gt; socketWrapper,</span></span><br><span class="line"><span class="params">        SocketEvent event, <span class="type">boolean</span> dispatch)</span> &#123;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (socketWrapper == <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      SocketProcessorBase&lt;S&gt; sc = processorCache.pop();</span><br><span class="line">      <span class="keyword">if</span> (sc == <span class="literal">null</span>) &#123;</span><br><span class="line">          sc = createSocketProcessor(socketWrapper, event);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          sc.reset(socketWrapper, event);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// çº¿ç¨‹æ± è¿è¡Œ</span></span><br><span class="line">      <span class="type">Executor</span> <span class="variable">executor</span> <span class="operator">=</span> getExecutor();</span><br><span class="line">      <span class="keyword">if</span> (dispatch &amp;&amp; executor != <span class="literal">null</span>) &#123;</span><br><span class="line">          executor.execute(sc);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          sc.run();</span><br><span class="line">      &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¯·ä½ æ³¨æ„ createSocketProcessor å‡½æ•°çš„ç¬¬äºŒä¸ªå‚æ•°æ˜¯ SocketEventï¼Œè¿™é‡Œæˆ‘ä»¬ä¼ å…¥çš„æ˜¯ OPEN_READã€‚é€šè¿‡è¿™ä¸ªå‚æ•°ï¼Œæˆ‘ä»¬å°±èƒ½æ§åˆ¶ SocketProcessor çš„è¡Œä¸ºï¼Œå› ä¸ºæˆ‘ä»¬ä¸éœ€è¦å†æŠŠè¯·æ±‚å‘é€åˆ°å®¹å™¨è¿›è¡Œå¤„ç†ï¼Œåªéœ€è¦å‘æµè§ˆå™¨ç«¯å‘é€æ•°æ®ï¼Œå¹¶ä¸”é‡æ–°åœ¨è¿™ä¸ª Socket ä¸Šç›‘å¬æ–°çš„è¯·æ±‚å°±è¡Œäº†ã€‚</p>
<h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ul>
<li><strong>å®˜æ–¹</strong><ul>
<li><a target="_blank" rel="noopener" href="http://tomcat.apache.org/">Tomcat å®˜æ–¹ç½‘ç«™</a></li>
<li><a target="_blank" rel="noopener" href="http://wiki.apache.org/tomcat/FrontPage">Tomcat Wiki</a></li>
<li><a target="_blank" rel="noopener" href="http://tomee.apache.org/">Tomee å®˜æ–¹ç½‘ç«™</a></li>
</ul>
</li>
<li><strong>æ•™ç¨‹</strong><ul>
<li><a target="_blank" rel="noopener" href="https://time.geekbang.org/column/intro/100027701">æ·±å…¥æ‹†è§£ Tomcat &amp; Jetty</a></li>
</ul>
</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://dunwu.github.io/blog/pages/9e448b84/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/uploads/avatar.gif">
      <meta itemprop="name" content="é’æ‚Ÿ â—¾ Dunwu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dunwu Blog">
      <meta itemprop="description" content="é’æ‚Ÿçš„ä¸ªäººåšå®¢">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Dunwu Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/pages/9e448b84/" class="post-title-link" itemprop="url">Tomcat å’Œ Jetty</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2022-02-17 22:34:30" itemprop="dateCreated datePublished" datetime="2022-02-17T22:34:30+08:00">2022-02-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">æ›´æ–°äº</span>
      <time title="ä¿®æ”¹æ—¶é—´ï¼š2025-09-13 17:56:53" itemprop="dateModified" datetime="2025-09-13T17:56:53+08:00">2025-09-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
        </span>
          ï¼Œ
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/JavaEE/" itemprop="url" rel="index"><span itemprop="name">JavaEE</span></a>
        </span>
          ï¼Œ
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/JavaEE/%E6%9C%8D%E5%8A%A1%E5%99%A8/" itemprop="url" rel="index"><span itemprop="name">æœåŠ¡å™¨</span></a>
        </span>
          ï¼Œ
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/JavaEE/%E6%9C%8D%E5%8A%A1%E5%99%A8/Tomcat/" itemprop="url" rel="index"><span itemprop="name">Tomcat</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
      <span>845</span>
    </span>
    <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
      <span>1 åˆ†é’Ÿ</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="Tomcat-å’Œ-Jetty"><a href="#Tomcat-å’Œ-Jetty" class="headerlink" title="Tomcat å’Œ Jetty"></a>Tomcat å’Œ Jetty</h2><p>Web å®¹å™¨ Tomcat æˆ– Jettyï¼Œä½œä¸ºé‡è¦çš„ç³»ç»Ÿä¸­é—´ä»¶ï¼Œè¿æ¥ç€æµè§ˆå™¨å’Œä½ çš„ Web åº”ç”¨ï¼Œå¹¶ä¸”æ”¯æ’‘ç€ Web ç¨‹åºçš„è¿è¡Œï¼Œå¯ä»¥è¯´ï¼Œ<strong>å¼„æ‡‚äº† Tomcat å’Œ Jetty çš„åŸç†ï¼ŒJava Web å¼€å‘å¯¹ä½ æ¥è¯´å°±æ¯«æ— ç§˜å¯†å¯è¨€</strong>ã€‚</p>
<h2 id="Web-å®¹å™¨"><a href="#Web-å®¹å™¨" class="headerlink" title="Web å®¹å™¨"></a>Web å®¹å™¨</h2><p>æ—©æœŸçš„ Web åº”ç”¨ä¸»è¦ç”¨äºæµè§ˆæ–°é—»ç­‰é™æ€é¡µé¢ï¼ŒHTTP æœåŠ¡å™¨ï¼ˆæ¯”å¦‚ Apacheã€Nginxï¼‰å‘æµè§ˆå™¨è¿”å›é™æ€ HTMLï¼Œæµè§ˆå™¨è´Ÿè´£è§£æ HTMLï¼Œå°†ç»“æœå‘ˆç°ç»™ç”¨æˆ·ã€‚</p>
<p>éšç€äº’è”ç½‘çš„å‘å±•ï¼Œæˆ‘ä»¬å·²ç»ä¸æ»¡è¶³äºä»…ä»…æµè§ˆé™æ€é¡µé¢ï¼Œè¿˜å¸Œæœ›é€šè¿‡ä¸€äº›äº¤äº’æ“ä½œï¼Œæ¥è·å–åŠ¨æ€ç»“æœï¼Œå› æ­¤ä¹Ÿå°±éœ€è¦ä¸€äº›æ‰©å±•æœºåˆ¶èƒ½å¤Ÿè®© HTTP æœåŠ¡å™¨è°ƒç”¨æœåŠ¡ç«¯ç¨‹åºã€‚</p>
<p>äºæ˜¯ Sun å…¬å¸æ¨å‡ºäº† Servlet æŠ€æœ¯ã€‚ä½ å¯ä»¥æŠŠ Servlet ç®€å•ç†è§£ä¸ºè¿è¡Œåœ¨æœåŠ¡ç«¯çš„ Java å°ç¨‹åºï¼Œä½†æ˜¯ Servlet æ²¡æœ‰ main æ–¹æ³•ï¼Œä¸èƒ½ç‹¬ç«‹è¿è¡Œï¼Œå› æ­¤å¿…é¡»æŠŠå®ƒéƒ¨ç½²åˆ° Servlet å®¹å™¨ä¸­ï¼Œç”±å®¹å™¨æ¥å®ä¾‹åŒ–å¹¶è°ƒç”¨ Servletã€‚</p>
<p>è€Œ Tomcat å’Œ Jetty å°±æ˜¯ä¸€ä¸ª Servlet å®¹å™¨ã€‚ä¸ºäº†æ–¹ä¾¿ä½¿ç”¨ï¼Œå®ƒä»¬ä¹Ÿå…·æœ‰ HTTP æœåŠ¡å™¨çš„åŠŸèƒ½ï¼Œå› æ­¤<strong>Tomcat æˆ–è€… Jetty å°±æ˜¯ä¸€ä¸ªâ€œHTTP æœåŠ¡å™¨ + Servlet å®¹å™¨â€ï¼Œæˆ‘ä»¬ä¹Ÿå«å®ƒä»¬ Web å®¹å™¨ã€‚</strong></p>
<p>å…¶ä»–åº”ç”¨æœåŠ¡å™¨æ¯”å¦‚ JBoss å’Œ WebLogicï¼Œå®ƒä»¬ä¸ä»…ä»…æœ‰ Servlet å®¹å™¨çš„åŠŸèƒ½ï¼Œä¹ŸåŒ…å« EJB å®¹å™¨ï¼Œæ˜¯å®Œæ•´çš„ Java EE åº”ç”¨æœåŠ¡å™¨ã€‚ä»è¿™ä¸ªè§’åº¦çœ‹ï¼ŒTomcat å’Œ Jetty ç®—æ˜¯ä¸€ä¸ªè½»é‡çº§çš„åº”ç”¨æœåŠ¡å™¨ã€‚</p>
<p>åœ¨å¾®æœåŠ¡æ¶æ„æ—¥æ¸æµè¡Œçš„ä»Šå¤©ï¼Œå¼€å‘äººå‘˜æ›´å–œæ¬¢ç¨³å®šçš„ã€è½»é‡çº§çš„åº”ç”¨æœåŠ¡å™¨ï¼Œå¹¶ä¸”åº”ç”¨ç¨‹åºç”¨å†…åµŒçš„æ–¹å¼æ¥è¿è¡Œ Servlet å®¹å™¨ä¹Ÿé€æ¸æµè¡Œèµ·æ¥ã€‚ä¹‹æ‰€ä»¥é€‰æ‹©è½»é‡çº§ï¼Œæ˜¯å› ä¸ºåœ¨å¾®æœåŠ¡æ¶æ„ä¸‹ï¼Œæˆ‘ä»¬æŠŠä¸€ä¸ªå¤§è€Œå…¨çš„å•ä½“åº”ç”¨ï¼Œæ‹†åˆ†æˆä¸€ä¸ªä¸ªåŠŸèƒ½å•ä¸€çš„å¾®æœåŠ¡ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼ŒæœåŠ¡çš„æ•°é‡å¿…ç„¶è¦å¢åŠ ï¼Œä½†ä¸ºäº†å‡å°‘èµ„æºçš„æ¶ˆè€—ï¼Œå¹¶ä¸”é™ä½éƒ¨ç½²çš„æˆæœ¬ï¼Œæˆ‘ä»¬å¸Œæœ›è¿è¡ŒæœåŠ¡çš„ Web å®¹å™¨ä¹Ÿæ˜¯è½»é‡çº§çš„ï¼ŒWeb å®¹å™¨æœ¬èº«åº”è¯¥æ¶ˆè€—è¾ƒå°‘çš„å†…å­˜å’Œ CPU èµ„æºï¼Œå¹¶ä¸”ç”±åº”ç”¨æœ¬èº«æ¥å¯åŠ¨ä¸€ä¸ªåµŒå…¥å¼çš„ Web å®¹å™¨ï¼Œè€Œä¸æ˜¯é€šè¿‡ Web å®¹å™¨æ¥éƒ¨ç½²å’Œå¯åŠ¨åº”ç”¨ï¼Œè¿™æ ·å¯ä»¥é™ä½åº”ç”¨éƒ¨ç½²çš„å¤æ‚åº¦ã€‚</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://dunwu.github.io/blog/pages/3510f99a/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/uploads/avatar.gif">
      <meta itemprop="name" content="é’æ‚Ÿ â—¾ Dunwu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dunwu Blog">
      <meta itemprop="description" content="é’æ‚Ÿçš„ä¸ªäººåšå®¢">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Dunwu Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/pages/3510f99a/" class="post-title-link" itemprop="url">MQ é¢è¯•</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2022-02-17 22:34:30" itemprop="dateCreated datePublished" datetime="2022-02-17T22:34:30+08:00">2022-02-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">æ›´æ–°äº</span>
      <time title="ä¿®æ”¹æ—¶é—´ï¼š2025-09-13 17:56:53" itemprop="dateModified" datetime="2025-09-13T17:56:53+08:00">2025-09-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/%E5%88%86%E5%B8%83%E5%BC%8F/" itemprop="url" rel="index"><span itemprop="name">åˆ†å¸ƒå¼</span></a>
        </span>
          ï¼Œ
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/%E5%88%86%E5%B8%83%E5%BC%8F/%E5%88%86%E5%B8%83%E5%BC%8F%E9%80%9A%E4%BF%A1/" itemprop="url" rel="index"><span itemprop="name">åˆ†å¸ƒå¼é€šä¿¡</span></a>
        </span>
          ï¼Œ
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/%E5%88%86%E5%B8%83%E5%BC%8F/%E5%88%86%E5%B8%83%E5%BC%8F%E9%80%9A%E4%BF%A1/MQ/" itemprop="url" rel="index"><span itemprop="name">MQ</span></a>
        </span>
          ï¼Œ
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/%E5%88%86%E5%B8%83%E5%BC%8F/%E5%88%86%E5%B8%83%E5%BC%8F%E9%80%9A%E4%BF%A1/MQ/MQ%E7%BB%BC%E5%90%88/" itemprop="url" rel="index"><span itemprop="name">MQç»¼åˆ</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
      <span>35k</span>
    </span>
    <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
      <span>32 åˆ†é’Ÿ</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="MQ-é¢è¯•"><a href="#MQ-é¢è¯•" class="headerlink" title="MQ é¢è¯•"></a>MQ é¢è¯•</h1><blockquote>
<p>æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆMessage Queueï¼Œç®€ç§° MQï¼‰æŠ€æœ¯æ˜¯<strong>åº”ç”¨é—´äº¤æ¢ä¿¡æ¯</strong>çš„ä¸€ç§æŠ€æœ¯ã€‚</p>
<p>æ¶ˆæ¯é˜Ÿåˆ—ä¸»è¦è§£å†³å¼‚æ­¥å¤„ç†ã€åº”ç”¨é—´è€¦åˆï¼Œæµé‡å‰Šé”‹ç­‰é—®é¢˜ï¼Œå®ç°é«˜æ€§èƒ½ï¼Œé«˜å¯ç”¨ï¼Œå¯ä¼¸ç¼©å’Œæœ€ç»ˆä¸€è‡´æ€§æ¶æ„ã€‚æ˜¯å¤§å‹åˆ†å¸ƒå¼ç³»ç»Ÿä¸å¯ç¼ºå°‘çš„ä¸­é—´ä»¶ã€‚</p>
<p>ç›®å‰ä¸»æµçš„ MQ æœ‰ï¼šKafkaã€RabbitMQã€RocketMQã€ActiveMQï¼Œè€Œéƒ¨åˆ†æ•°æ®åº“å¦‚ Redisã€MySQL ä»¥åŠ phxsql ä¹Ÿå¯å®ç°æ¶ˆæ¯é˜Ÿåˆ—çš„åŠŸèƒ½ã€‚</p>
<p>æ³¨æ„ï¼š_ä¸ºäº†ç®€ä¾¿ï¼Œä¸‹æ–‡ä¸­é™¤äº†æ–‡ç« æ ‡é¢˜ï¼Œä¸€å¾‹ä½¿ç”¨ MQ ç®€ç§°_ã€‚</p>
</blockquote>
<h2 id="MQ-ç®€ä»‹"><a href="#MQ-ç®€ä»‹" class="headerlink" title="MQ ç®€ä»‹"></a>MQ ç®€ä»‹</h2><h3 id="ã€ç®€å•ã€‘ä»€ä¹ˆæ˜¯-MQï¼Ÿ"><a href="#ã€ç®€å•ã€‘ä»€ä¹ˆæ˜¯-MQï¼Ÿ" class="headerlink" title="ã€ç®€å•ã€‘ä»€ä¹ˆæ˜¯ MQï¼Ÿ"></a>ã€ç®€å•ã€‘ä»€ä¹ˆæ˜¯ MQï¼Ÿ</h3><p><strong>MQï¼ˆMessage Queueï¼Œæ¶ˆæ¯é˜Ÿåˆ—ï¼‰</strong> æ˜¯ä¸€ç§<strong>å¼‚æ­¥é€šä¿¡æœºåˆ¶</strong>ï¼Œç”¨äºåœ¨ä¸åŒæœåŠ¡ã€åº”ç”¨æˆ–ç³»ç»Ÿç»„ä»¶ä¹‹é—´<strong>å¯é åœ°ä¼ é€’æ¶ˆæ¯</strong>ã€‚å®ƒçš„æ ¸å¿ƒæ€æƒ³æ˜¯<strong>è§£è€¦ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…</strong>ï¼Œé€šè¿‡ç¼“å†²æ¶ˆæ¯æ¥æé«˜ç³»ç»Ÿçš„å¯é æ€§ã€æ‰©å±•æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚</p>
<p><strong>MQ çš„æ ¸å¿ƒæ¦‚å¿µ</strong></p>
<ul>
<li><strong>ç”Ÿäº§è€…ï¼ˆProducerï¼‰</strong>ï¼šå‘é€æ¶ˆæ¯çš„åº”ç”¨æˆ–æœåŠ¡ã€‚</li>
<li><strong>æ¶ˆè´¹è€…ï¼ˆConsumerï¼‰</strong>ï¼šæ¥æ”¶å¹¶å¤„ç†æ¶ˆæ¯çš„åº”ç”¨æˆ–æœåŠ¡ã€‚</li>
<li><strong>æ¶ˆæ¯ï¼ˆMessageï¼‰</strong>ï¼šä¼ è¾“çš„æ•°æ®å•ä½ï¼Œå¯ä»¥æ˜¯æ–‡æœ¬ã€JSONã€äºŒè¿›åˆ¶ç­‰æ ¼å¼ã€‚</li>
<li><strong>é˜Ÿåˆ—ï¼ˆQueueï¼‰</strong>ï¼šå­˜å‚¨æ¶ˆæ¯çš„ç¼“å†²åŒºï¼Œéµå¾ª <strong>FIFOï¼ˆå…ˆè¿›å…ˆå‡ºï¼‰</strong> æˆ–ä¼˜å…ˆçº§ç­–ç•¥ã€‚</li>
<li><strong>Brokerï¼ˆæ¶ˆæ¯ä»£ç†ï¼‰</strong>ï¼šè´Ÿè´£æ¥æ”¶ã€å­˜å‚¨å’Œè½¬å‘æ¶ˆæ¯çš„ä¸­é—´ä»¶ï¼ˆå¦‚ RabbitMQã€Kafkaï¼‰ã€‚</li>
</ul>
<p>æ¶ˆæ¯é˜Ÿåˆ—ä¸»è¦è§£å†³åº”ç”¨è€¦åˆï¼Œå¼‚æ­¥æ¶ˆæ¯ï¼Œæµé‡å‰Šé”‹ç­‰é—®é¢˜ï¼Œå®ç°é«˜æ€§èƒ½ï¼Œé«˜å¯ç”¨ï¼Œå¯ä¼¸ç¼©å’Œæœ€ç»ˆä¸€è‡´æ€§æ¶æ„ã€‚æ˜¯å¤§å‹åˆ†å¸ƒå¼ç³»ç»Ÿä¸å¯ç¼ºå°‘çš„ä¸­é—´ä»¶ã€‚</p>
<p>MQ æ˜¯æ¶ˆè´¹-ç”Ÿäº§è€…æ¨¡å‹çš„ä¸€ä¸ªå…¸å‹çš„ä»£è¡¨ï¼Œä¸€ç«¯å¾€æ¶ˆæ¯é˜Ÿåˆ—ä¸­ä¸æ–­å†™å…¥æ¶ˆæ¯ï¼Œè€Œå¦ä¸€ç«¯åˆ™å¯ä»¥è¯»å–é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯ã€‚æ¶ˆæ¯å‘å¸ƒè€…åªç®¡æŠŠæ¶ˆæ¯å‘å¸ƒåˆ° MQ ä¸­è€Œä¸ç”¨ç®¡è°æ¥å–ï¼Œæ¶ˆæ¯ä½¿ç”¨è€…åªç®¡ä» MQ ä¸­å–æ¶ˆæ¯è€Œä¸ç®¡æ˜¯è°å‘å¸ƒçš„ã€‚è¿™æ ·å‘å¸ƒè€…å’Œä½¿ç”¨è€…éƒ½ä¸ç”¨çŸ¥é“å¯¹æ–¹çš„å­˜åœ¨ã€‚</p>
<p>MQ çš„æ•°æ®å¯é©»ç•™åœ¨å†…å­˜æˆ–ç£ç›˜ä¸Šï¼Œç›´åˆ°å®ƒä»¬è¢«åº”ç”¨ç¨‹åºè¯»å–ã€‚é€šè¿‡ MQï¼Œåº”ç”¨ç¨‹åºå¯ç‹¬ç«‹åœ°æ‰§è¡Œï¼Œå®ƒä»¬ä¸éœ€è¦çŸ¥é“å½¼æ­¤çš„ä½ç½®ï¼Œä¸éœ€è¦ç­‰å¾…æ¥æ”¶ç¨‹åºæ¥æ”¶æ­¤æ¶ˆæ¯ã€‚åœ¨åˆ†å¸ƒå¼è®¡ç®—ç¯å¢ƒä¸­ï¼Œä¸ºäº†é›†æˆåˆ†å¸ƒå¼åº”ç”¨ï¼Œå¼€å‘è€…éœ€è¦å¯¹å¼‚æ„ç½‘ç»œç¯å¢ƒä¸‹çš„åˆ†å¸ƒå¼åº”ç”¨æä¾›æœ‰æ•ˆçš„é€šä¿¡æ‰‹æ®µã€‚ä¸ºäº†ç®¡ç†éœ€è¦å…±äº«çš„ä¿¡æ¯ï¼Œå¯¹åº”ç”¨æä¾›å…¬å…±çš„ä¿¡æ¯äº¤æ¢æœºåˆ¶æ˜¯é‡è¦çš„ã€‚</p>
<p>ç›®å‰ä¸»æµçš„ MQ æœ‰ï¼šKafkaã€RabbitMQã€RocketMQã€ActiveMQã€‚</p>
<h3 id="ã€ç®€å•ã€‘ä¸ºä»€ä¹ˆéœ€è¦-MQï¼Ÿ"><a href="#ã€ç®€å•ã€‘ä¸ºä»€ä¹ˆéœ€è¦-MQï¼Ÿ" class="headerlink" title="ã€ç®€å•ã€‘ä¸ºä»€ä¹ˆéœ€è¦ MQï¼Ÿ"></a>ã€ç®€å•ã€‘ä¸ºä»€ä¹ˆéœ€è¦ MQï¼Ÿ</h3><p><strong>MQ çš„å…¸å‹åº”ç”¨åœºæ™¯</strong></p>
<ul>
<li><strong>å¼‚æ­¥å¤„ç†</strong></li>
<li><strong>ç³»ç»Ÿè§£è€¦</strong></li>
<li><strong>æµé‡å‰Šå³°</strong></li>
<li><strong>ç³»ç»Ÿé—´é€šä¿¡</strong></li>
<li><strong>ä¼ è¾“ç¼“å†²</strong></li>
<li><strong>æœ€ç»ˆä¸€è‡´æ€§</strong></li>
</ul>
<p>::: info å¼‚æ­¥å¤„ç†</p>
<p>:::</p>
<p>MQ å¯ä»¥å°†ç³»ç»Ÿé—´çš„å¤„ç†æµç¨‹å¼‚æ­¥åŒ–ï¼Œå‡å°‘ç­‰å¾…å“åº”çš„æ—¶é—´ï¼Œä»è€Œæé«˜æ•´ä½“å¹¶å‘ååé‡ã€‚ä¸€èˆ¬ï¼ŒMQ å¼‚æ­¥å¤„ç†åº”ç”¨äºéæ ¸å¿ƒæµç¨‹ï¼Œä¾‹å¦‚ï¼šçŸ­ä¿¡&#x2F;é‚®ä»¶é€šçŸ¥ã€æ•°æ®æ¨é€ã€ä¸ŠæŠ¥æ•°æ®åˆ°ç›‘æ§ä¸­å¿ƒã€æ—¥å¿—ä¸­å¿ƒç­‰ã€‚</p>
<p>å‡è®¾è¿™æ ·ä¸€ä¸ªåœºæ™¯ï¼Œç”¨æˆ·å‘ç³»ç»Ÿ A å‘èµ·è¯·æ±‚ï¼Œç³»ç»Ÿ A å¤„ç†è®¡ç®—åªéœ€è¦ <code>10ms</code>ï¼Œç„¶åé€šçŸ¥ç³»ç»Ÿ BCD å†™åº“ï¼Œç³»ç»Ÿ BCD å†™åº“è€—æ—¶åˆ†åˆ«ä¸ºï¼š<code>100ms</code>ã€<code>200ms</code>ã€<code>300ms</code>ã€‚æœ€ç»ˆæ€»è€—æ—¶ä¸ºï¼š <code>10ms+100ms+200ms+300ms=610ms</code>ã€‚æ­¤å¤–ï¼ŒåŠ ä¸Šè¯·æ±‚å’Œå“åº”çš„ç½‘ç»œä¼ è¾“æ—¶é—´ï¼Œä»ç”¨æˆ·è§’åº¦çœ‹ï¼Œå¯èƒ½è¦ç­‰å¾…å°†è¿‘ <code>1s</code> æ‰èƒ½å¾—åˆ°ç»“æœã€‚</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/202502021707928.png"></p>
<p>å¦‚æœä½¿ç”¨ MQï¼Œç³»ç»Ÿ A æ¥åˆ°è¯·æ±‚åï¼Œè€—æ—¶ <code>10ms</code> å¤„ç†è®¡ç®—ï¼Œç„¶åå‘ç³»ç»Ÿ BCD è¿ç»­å‘é€æ¶ˆæ¯ï¼Œå‡è®¾è€—æ—¶ <code>5ms</code>ã€‚é‚£ä¹ˆ è¿™ä¸€è¿‡ç¨‹çš„æ€»è€—æ—¶ä¸º <code>3ms + 5ms = 8ms</code>ï¼Œè¿™ç›¸æ¯”äº <code>610 ms</code>ï¼Œå¤§å¤§ç¼©çŸ­äº†å“åº”æ—¶é—´ã€‚è‡³äºç³»ç»Ÿ BCD çš„å†™åº“æ“ä½œï¼Œåªè¦è‡ªè¡Œæ¶ˆè´¹ MQ åå¤„ç†å³å¯ï¼Œç”¨æˆ·æ— éœ€å…³æ³¨ã€‚</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/202502021707517.png"></p>
<p>::: info ç³»ç»Ÿè§£è€¦</p>
<p>:::</p>
<p>é€šè¿‡ MQï¼Œå¯ä»¥æ¶ˆé™¤ç³»ç»Ÿé—´çš„å¼ºè€¦åˆã€‚å®ƒçš„å¥½å¤„åœ¨äºï¼š</p>
<ul>
<li>æ¶ˆæ¯çš„æ¶ˆè´¹è€…ç³»ç»Ÿå¯ä»¥éšæ„å¢åŠ ï¼Œæ— éœ€ä¿®æ”¹ç”Ÿäº§è€…ç³»ç»Ÿçš„ä»£ç ã€‚</li>
<li>ç”Ÿäº§è€…ç³»ç»Ÿã€æ¶ˆè´¹è€…ç³»ç»Ÿå½¼æ­¤ä¸ä¼šå½±å“å¯¹æ–¹çš„æµç¨‹ã€‚<ul>
<li>å¦‚æœç”Ÿäº§è€…ç³»ç»Ÿå®•æœºï¼Œæ¶ˆè´¹è€…ç³»ç»Ÿæ”¶ä¸åˆ°æ¶ˆæ¯ï¼Œå°±ä¸ä¼šæœ‰ä¸‹ä¸€æ­¥çš„åŠ¨ä½œã€‚</li>
<li>å¦‚æœæ¶ˆè´¹è€…ç³»ç»Ÿå®•æœºï¼Œç”Ÿäº§è€…ç³»ç»Ÿè®©ç„¶å¯ä»¥æ­£å¸¸å‘é€æ¶ˆæ¯ï¼Œä¸å½±å“æµç¨‹ã€‚</li>
</ul>
</li>
</ul>
<p>ä¸åŒç³»ç»Ÿå¦‚æœè¦å»ºç«‹é€šä¿¡ï¼Œä¼ ç»Ÿçš„åšæ³•æ˜¯ï¼šè°ƒç”¨æ¥å£ã€‚</p>
<p>å¦‚æœéœ€è¦å’Œæ–°çš„ç³»ç»Ÿå»ºç«‹é€šä¿¡æˆ–åˆ é™¤å·²å»ºç«‹çš„é€šä¿¡ï¼Œéƒ½éœ€è¦ä¿®æ”¹ä»£ç ï¼Œè¿™ç§æ–¹æ¡ˆæ˜¾ç„¶è€¦åˆåº¦å¾ˆé«˜ã€‚</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/202502021719775.png"></p>
<p>å¦‚æœä½¿ç”¨ MQï¼Œç³»ç»Ÿé—´çš„é€šä¿¡åªéœ€è¦é€šè¿‡å‘å¸ƒ&#x2F;è®¢é˜…ï¼ˆPub&#x2F;Subï¼‰æ¨¡å‹å³å¯ï¼Œå½¼æ­¤æ²¡æœ‰ç›´æ¥è”ç³»ï¼Œä¹Ÿå°±ä¸éœ€è¦ç›¸äº’æ„ŸçŸ¥ï¼Œä»è€Œè¾¾åˆ° <strong>è§£è€¦</strong>ã€‚</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/202502021719470.png"></p>
<p>::: info æµé‡å‰Šå³°</p>
<p>:::</p>
<p>å½“ <strong>ä¸Šä¸‹æ¸¸ç³»ç»Ÿ</strong> å¤„ç†èƒ½åŠ›å­˜åœ¨å·®è·çš„æ—¶å€™ï¼Œåˆ©ç”¨ MQ åšä¸€ä¸ª â€œ<strong>æ¼æ–—</strong>â€ æ¨¡å‹ï¼Œè¿›è¡Œ <strong>æµæ§</strong>ã€‚æŠŠ MQ å½“æˆå¯é çš„ <strong>æ¶ˆæ¯ç¼“å†²æ± </strong>ï¼Œè¿›è¡Œä¸€å®šç¨‹åº¦çš„ <strong>æ¶ˆæ¯å †ç§¯</strong>ï¼›åœ¨ä¸‹æ¸¸æœ‰èƒ½åŠ›å¤„ç†çš„æ—¶å€™ï¼Œå†å‘é€æ¶ˆæ¯ã€‚</p>
<p>MQ çš„æµé‡å‰Šå³°å¸¸ç”¨äºé«˜å¹¶å‘åœºæ™¯ï¼ˆä¾‹å¦‚ï¼šç§’æ€ã€å›¢æŠ¢ç­‰ä¸šåŠ¡åœºæ™¯ï¼‰ï¼Œå®ƒæ˜¯ç¼“è§£ç¬æ—¶æš´å¢æµé‡çš„æ ¸å¿ƒæ‰‹æ®µä¹‹ä¸€ã€‚</p>
<p>å¦‚æœæ²¡æœ‰ MQï¼Œä¸¤ä¸ªç³»ç»Ÿä¹‹é—´é€šè¿‡ <strong>åå•†</strong>ã€<strong>æ»‘åŠ¨çª—å£</strong>ã€<strong>é™æµ</strong>&#x2F;<strong>é™çº§</strong>&#x2F;<strong>ç†”æ–­</strong> ç­‰å¤æ‚çš„æ–¹æ¡ˆä¹Ÿèƒ½å®ç° <strong>æµæ§</strong>ã€‚ä½† <strong>ç³»ç»Ÿå¤æ‚æ€§</strong> æŒ‡æ•°çº§å¢é•¿ï¼ŒåŠ¿å¿…åœ¨ä¸Šæ¸¸æˆ–è€…ä¸‹æ¸¸åšå­˜å‚¨ï¼Œå¹¶ä¸”è¦å¤„ç† <strong>å®šæ—¶</strong>ã€<strong>æ‹¥å¡</strong> ç­‰ä¸€ç³»åˆ—é—®é¢˜ã€‚è€Œä¸”æ¯å½“æœ‰ <strong>å¤„ç†èƒ½åŠ›æœ‰å·®è·</strong> çš„æ—¶å€™ï¼Œéƒ½éœ€è¦ <strong>å•ç‹¬</strong> å¼€å‘ä¸€å¥—é€»è¾‘æ¥ç»´æŠ¤è¿™å¥—é€»è¾‘ã€‚</p>
<p>å‡è®¾æŸä¸ªç³»ç»Ÿè¯»å†™æ•°æ®åº“çš„ç¨³å®šæ€§èƒ½ä¸ºæ¯ç§’å¤„ç† 1000 æ¡æ•°æ®ã€‚å¹³å¸¸æƒ…å†µä¸‹ï¼Œè¿œè¿œè¾¾ä¸åˆ°è¿™ä¹ˆå¤§çš„å¤„ç†é‡ã€‚å‡è®¾ï¼Œå› ä¸ºå› ä¸ºåšæ´»åŠ¨ï¼Œç³»ç»Ÿçš„ç¬æ—¶è¯·æ±‚é‡å‰§å¢ï¼Œè¾¾åˆ°æ¯ç§’ 10000 ä¸ªå¹¶å‘è¯·æ±‚ï¼Œæ•°æ®åº“æ ¹æœ¬æ‰¿å—ä¸äº†ï¼Œå¯èƒ½ç›´æ¥å°±æŠŠæ•°æ®åº“ç»™æ•´å´©æºƒäº†ï¼Œè¿™æ ·ç³»ç»ŸæœåŠ¡å°±ä¸å¯ç”¨äº†ã€‚</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/202502021738906.png"></p>
<p>å¦‚æœä½¿ç”¨ MQï¼Œæ¯ç§’å†™å…¥ 10000 æ¡è¯·æ±‚ï¼Œä½†æ˜¯ç³»ç»Ÿ A æ¯ç§’åªä» MQ ä¸­æ¶ˆè´¹ 1000 æ¡è¯·æ±‚ï¼Œç„¶åå†™å…¥æ•°æ®åº“ã€‚è¿™æ ·ï¼Œå°±ä¸ä¼šè¶…è¿‡æ•°æ®åº“çš„æ‰¿å—èƒ½åŠ›ï¼Œè€Œæ˜¯æŠŠè¯·æ±‚ç§¯å‹åœ¨ MQ ä¸­ã€‚åªè¦é«˜å³°æœŸä¸€è¿‡ï¼Œç³»ç»Ÿ A å°±ä¼šå¾ˆå¿«æŠŠç§¯å‹çš„æ¶ˆæ¯ç»™å¤„ç†æ‰ã€‚</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/202502021739806.png"></p>
<p>::: info ç³»ç»Ÿé—´é€šä¿¡</p>
<p>:::</p>
<p>æ¶ˆæ¯é˜Ÿåˆ—ä¸€èˆ¬éƒ½å†…ç½®äº† <strong>é«˜æ•ˆçš„é€šä¿¡æœºåˆ¶</strong>ï¼Œå› æ­¤ä¹Ÿå¯ä»¥ç”¨äºå•çº¯çš„ <strong>æ¶ˆæ¯é€šè®¯</strong>ï¼Œæ¯”å¦‚å®ç° <strong>ç‚¹å¯¹ç‚¹æ¶ˆæ¯é˜Ÿåˆ—</strong> æˆ–è€… <strong>èŠå¤©å®¤</strong> ç­‰ã€‚</p>
<p><strong>ç”Ÿäº§è€…&#x2F;æ¶ˆè´¹è€…</strong> æ¨¡å¼ï¼Œåªéœ€è¦å…³å¿ƒæ¶ˆæ¯æ˜¯å¦ <strong>é€è¾¾é˜Ÿåˆ—</strong>ï¼Œè‡³äºè°å¸Œæœ›è®¢é˜…å’Œéœ€è¦æ¶ˆè´¹ï¼Œæ˜¯ <strong>ä¸‹æ¸¸</strong> çš„äº‹æƒ…ï¼Œæ— ç–‘æå¤§åœ°å‡å°‘äº†å¼€å‘å’Œè”è°ƒçš„å·¥ä½œé‡ã€‚</p>
<p>::: info ä¼ è¾“ç¼“å†²</p>
<p>:::</p>
<p>ï¼ˆ1ï¼‰MQ å¸¸è¢«ç”¨äºåšæµ·é‡æ•°æ®çš„ä¼ è¾“ç¼“å†²ã€‚</p>
<p>ä¾‹å¦‚ï¼ŒKafka å¸¸è¢«ç”¨äºåšä¸ºå„ç§æ—¥å¿—æ•°æ®ã€é‡‡é›†æ•°æ®çš„æ•°æ®ä¸­è½¬ã€‚ç„¶åï¼ŒKafka å°†æ•°æ®è½¬å‘ç»™ Logstashã€Elasticsearch ä¸­ï¼Œç„¶ååŸºäº Elasticsearch æ¥åšæ—¥å¿—ä¸­å¿ƒï¼Œæä¾›æ£€ç´¢ã€èšåˆã€åˆ†ææ—¥å¿—çš„èƒ½åŠ›ã€‚å¼€å‘è€…å¯ä»¥é€šè¿‡ Kibana é›†æˆ Elasticsearch æ•°æ®è¿›è¡Œå¯è§†åŒ–å±•ç¤ºï¼Œæˆ–è‡ªè¡Œè¿›è¡Œå®šåˆ¶åŒ–å¼€å‘ã€‚</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/20200930164342.png" alt="img"></p>
<p>ï¼ˆ2ï¼‰MQ ä¹Ÿå¯ä»¥è¢«ç”¨äºæµå¼å¤„ç†ã€‚</p>
<p>ä¾‹å¦‚ï¼ŒKafka å‡ ä¹å·²ç»æ˜¯æµè®¡ç®—çš„æ•°æ®é‡‡é›†ç«¯çš„æ ‡å‡†ç»„ä»¶ã€‚è€Œæµè®¡ç®—é€šè¿‡å®æ—¶æ•°æ®å¤„ç†èƒ½åŠ›ï¼Œæä¾›äº†æ›´ä¸ºå¿«æ·çš„èšåˆè®¡ç®—èƒ½åŠ›ï¼Œè¢«å¤§é‡åº”ç”¨äºé“¾è·¯ç›‘æ§ã€å®æ—¶ç›‘æ§ã€å®æ—¶æ•°ä»“ã€å®æ—¶å¤§å±ã€é£æ§ã€æ¨èç­‰åº”ç”¨é¢†åŸŸã€‚</p>
<p>::: info æœ€ç»ˆä¸€è‡´æ€§</p>
<p>:::</p>
<p><strong>æœ€ç»ˆä¸€è‡´æ€§</strong> ä¸æ˜¯ <strong>æ¶ˆæ¯é˜Ÿåˆ—</strong> çš„å¿…å¤‡ç‰¹æ€§ï¼Œä½†ç¡®å®å¯ä»¥ä¾é  <strong>æ¶ˆæ¯é˜Ÿåˆ—</strong> æ¥åš <strong>æœ€ç»ˆä¸€è‡´æ€§</strong> çš„äº‹æƒ…ã€‚</p>
<ul>
<li><strong>å…ˆå†™æ¶ˆæ¯å†æ“ä½œ</strong>ï¼Œç¡®ä¿æ“ä½œå®Œæˆåå†ä¿®æ”¹æ¶ˆæ¯çŠ¶æ€ã€‚<strong>å®šæ—¶ä»»åŠ¡è¡¥å¿æœºåˆ¶</strong> å®ç°æ¶ˆæ¯ <strong>å¯é å‘é€æ¥æ”¶</strong>ã€ä¸šåŠ¡æ“ä½œçš„å¯é æ‰§è¡Œï¼Œè¦æ³¨æ„ <strong>æ¶ˆæ¯é‡å¤</strong> ä¸ <strong>å¹‚ç­‰è®¾è®¡</strong>ã€‚</li>
<li>æ‰€æœ‰ä¸ä¿è¯ <code>100%</code> <strong>ä¸ä¸¢æ¶ˆæ¯</strong> çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œç†è®ºä¸Šæ— æ³•å®ç° <strong>æœ€ç»ˆä¸€è‡´æ€§</strong>ã€‚</li>
</ul>
<blockquote>
<p>åƒ <code>Kafka</code> ä¸€ç±»çš„è®¾è®¡ï¼Œåœ¨è®¾è®¡å±‚é¢ä¸Šå°±æœ‰ <strong>ä¸¢æ¶ˆæ¯</strong> çš„å¯èƒ½ï¼ˆæ¯”å¦‚ <strong>å®šæ—¶åˆ·ç›˜</strong>ï¼Œå¦‚æœæ‰ç”µå°±ä¼šä¸¢æ¶ˆæ¯ï¼‰ã€‚å“ªæ€•åªä¸¢åƒåˆ†ä¹‹ä¸€çš„æ¶ˆæ¯ï¼Œä¸šåŠ¡ä¹Ÿå¿…é¡»ç”¨å…¶ä»–çš„æ‰‹æ®µæ¥ä¿è¯ç»“æœæ­£ç¡®ã€‚</p>
</blockquote>
<h3 id="ã€ä¸­ç­‰ã€‘å¼•å…¥-MQ-å¸¦æ¥å“ªäº›é—®é¢˜ï¼Ÿ"><a href="#ã€ä¸­ç­‰ã€‘å¼•å…¥-MQ-å¸¦æ¥å“ªäº›é—®é¢˜ï¼Ÿ" class="headerlink" title="ã€ä¸­ç­‰ã€‘å¼•å…¥ MQ å¸¦æ¥å“ªäº›é—®é¢˜ï¼Ÿ"></a>ã€ä¸­ç­‰ã€‘å¼•å…¥ MQ å¸¦æ¥å“ªäº›é—®é¢˜ï¼Ÿ</h3><p>ä»»ä½•æŠ€æœ¯éƒ½ä¼šæœ‰åˆ©æœ‰å¼Šï¼ŒMQ ç»™æ•´ä½“ç³»ç»Ÿæ¶æ„å¸¦æ¥å¾ˆå¤šå¥½å¤„ï¼Œä½†ä¹Ÿä¼šä»˜å‡ºä¸€å®šçš„ä»£ä»·ã€‚</p>
<p>MQ ä¸»è¦å¼•å…¥äº†ä»¥ä¸‹é—®é¢˜ï¼š</p>
<ul>
<li><strong>ç³»ç»Ÿå¯ç”¨æ€§é™ä½</strong>ï¼šå¼•å…¥äº† MQ åï¼Œé€šä¿¡éœ€è¦åŸºäº MQ å®Œæˆï¼Œå¦‚æœ MQ å®•æœºï¼Œåˆ™æœåŠ¡ä¸å¯ç”¨ã€‚å› æ­¤ï¼ŒMQ è¦ä¿è¯æ˜¯é«˜å¯ç”¨çš„ã€‚</li>
<li><strong>ç³»ç»Ÿå¤æ‚åº¦æé«˜</strong>ï¼šä½¿ç”¨ MQï¼Œéœ€è¦å…³æ³¨ä¸€äº›æ–°çš„é—®é¢˜ï¼š<ul>
<li>å¦‚ä½•ä¿è¯æ¶ˆæ¯æ²¡æœ‰ <strong>é‡å¤æ¶ˆè´¹</strong>ï¼Ÿ</li>
<li>å¦‚ä½•å¤„ç† <strong>æ¶ˆæ¯ä¸¢å¤±</strong> çš„é—®é¢˜ï¼Ÿ</li>
<li>å¦‚ä½•ä¿è¯ä¼ é€’ <strong>æ¶ˆæ¯çš„é¡ºåºæ€§</strong>ï¼Ÿ</li>
<li>å¦‚ä½•å¤„ç†å¤§é‡ <strong>æ¶ˆæ¯ç§¯å‹</strong> çš„é—®é¢˜ï¼Ÿ</li>
</ul>
</li>
<li><strong>ä¸€è‡´æ€§é—®é¢˜</strong>ï¼šå‡è®¾ç³»ç»Ÿ A å¤„ç†å®Œç›´æ¥è¿”å›æˆåŠŸçš„ç»“æœç»™ç”¨æˆ·ï¼Œç”¨æˆ·è®¤ä¸ºè¯·æ±‚æˆåŠŸã€‚ä½†å¦‚æœæ­¤æ—¶ï¼Œç³»ç»Ÿ BCD ä¸­åªè¦æœ‰ä»»æ„ä¸€ä¸ªå†™åº“å¤±è´¥ï¼Œé‚£ä¹ˆæ•°æ®å°±ä¸ä¸€è‡´äº†ã€‚è¿™ç§æƒ…å†µå¦‚ä½•å¤„ç†ï¼Ÿ</li>
</ul>
<h3 id="ã€ä¸­ç­‰ã€‘MQ-æœ‰å“ªäº›é€šä¿¡æ¨¡å‹ï¼Ÿ"><a href="#ã€ä¸­ç­‰ã€‘MQ-æœ‰å“ªäº›é€šä¿¡æ¨¡å‹ï¼Ÿ" class="headerlink" title="ã€ä¸­ç­‰ã€‘MQ æœ‰å“ªäº›é€šä¿¡æ¨¡å‹ï¼Ÿ"></a>ã€ä¸­ç­‰ã€‘MQ æœ‰å“ªäº›é€šä¿¡æ¨¡å‹ï¼Ÿ</h3><p>MQï¼ˆæ¶ˆæ¯é˜Ÿåˆ—ï¼‰å¸¸è§çš„é€šä¿¡æ¨¡å‹ä¸»è¦æœ‰ä»¥ä¸‹å‡ ç§ï¼Œé€‚ç”¨äºä¸åŒçš„ä¸šåŠ¡åœºæ™¯ï¼š</p>
<p><strong>ç‚¹å¯¹ç‚¹ï¼ˆPoint-to-Point &#x2F; Queueï¼‰</strong></p>
<ul>
<li><strong>ç‰¹ç‚¹</strong>ï¼šæ¶ˆæ¯ç”± <strong>ä¸€ä¸ªç”Ÿäº§è€…</strong> å‘é€åˆ° <strong>ä¸€ä¸ªé˜Ÿåˆ—</strong>ï¼Œ<strong>åªæœ‰ä¸€ä¸ªæ¶ˆè´¹è€…</strong> èƒ½æ¶ˆè´¹è¯¥æ¶ˆæ¯ï¼ˆç«äº‰æ¶ˆè´¹ï¼‰ï¼Œæ¶ˆæ¯è¢«æ¶ˆè´¹åå³ä»é˜Ÿåˆ—åˆ é™¤ã€‚</li>
<li><strong>é€‚ç”¨åœºæ™¯</strong>ï¼šä»»åŠ¡åˆ†å‘ï¼ˆå¦‚è®¢å•å¤„ç†ã€å¼‚æ­¥ä»»åŠ¡ï¼‰ã€‚</li>
<li><strong>ç¤ºä¾‹</strong>ï¼šRabbitMQ çš„æ™®é€šé˜Ÿåˆ—ã€ActiveMQ çš„ Queueã€‚</li>
</ul>
<p><strong>å‘å¸ƒ&#x2F;è®¢é˜…ï¼ˆPublish&#x2F;Subscribe &#x2F; Topicï¼‰</strong></p>
<ul>
<li><strong>ç‰¹ç‚¹</strong>ï¼šæ¶ˆæ¯ç”± <strong>ä¸€ä¸ªç”Ÿäº§è€…</strong> å‘é€åˆ° <strong>Topicï¼ˆä¸»é¢˜ï¼‰</strong>ï¼Œ<strong>å¤šä¸ªæ¶ˆè´¹è€…</strong>ï¼ˆè®¢é˜…è€…ï¼‰å¯åŒæ—¶æ¥æ”¶åŒä¸€æ¶ˆæ¯ï¼Œæ¶ˆæ¯ä¼šå¹¿æ’­ç»™æ‰€æœ‰è®¢é˜…è€…ã€‚</li>
<li><strong>é€‚ç”¨åœºæ™¯</strong>ï¼šäº‹ä»¶é€šçŸ¥ï¼ˆå¦‚ç³»ç»Ÿæ—¥å¿—å¹¿æ’­ã€å®æ—¶æ•°æ®åŒæ­¥ï¼‰ã€‚</li>
<li><strong>ç¤ºä¾‹</strong>ï¼šRabbitMQ çš„ Exchange + Fanout æ¨¡å¼ã€Kafka çš„ Topicã€‚</li>
</ul>
<p><strong>è¯·æ±‚&#x2F;å“åº”ï¼ˆRequest&#x2F;Replyï¼‰</strong></p>
<ul>
<li><strong>ç‰¹ç‚¹</strong>ï¼šç”Ÿäº§è€…å‘é€æ¶ˆæ¯åï¼Œæ¶ˆè´¹è€…å¤„ç†å¹¶è¿”å›å“åº”ï¼ˆç±»ä¼¼ RPCï¼‰ï¼Œé€šå¸¸éœ€è¦ <strong>ä¸´æ—¶é˜Ÿåˆ—</strong> å­˜å‚¨å“åº”ã€‚</li>
<li><strong>é€‚ç”¨åœºæ™¯</strong>ï¼šéœ€è¦åŒæ­¥ç»“æœçš„å¼‚æ­¥è°ƒç”¨ï¼ˆå¦‚æ”¯ä»˜çŠ¶æ€æŸ¥è¯¢ï¼‰ã€‚</li>
<li><strong>ç¤ºä¾‹</strong>ï¼šRabbitMQ çš„ RPC æ¨¡å¼ã€Kafka çš„ Request-Reply æ‰©å±•ã€‚</li>
</ul>
<p><strong>æ‰‡å‡ºï¼ˆFanoutï¼‰</strong></p>
<ul>
<li><strong>ç‰¹ç‚¹</strong>ï¼šæ¶ˆæ¯å‘é€åˆ° Exchange åï¼Œ<strong>æ— æ¡ä»¶å¹¿æ’­</strong> ç»™æ‰€æœ‰ç»‘å®šçš„é˜Ÿåˆ—ï¼ˆæ— è·¯ç”±è§„åˆ™ï¼‰ï¼Œç±»ä¼¼å‘å¸ƒ&#x2F;è®¢é˜…ï¼Œä½†æ›´ç®€å•ã€‚</li>
<li><strong>é€‚ç”¨åœºæ™¯</strong>ï¼šå®æ—¶é€šçŸ¥å¤šä¸ªç³»ç»Ÿï¼ˆå¦‚ä»·æ ¼å˜åŠ¨ã€åº“å­˜æ›´æ–°ï¼‰ã€‚</li>
<li><strong>ç¤ºä¾‹</strong>ï¼šRabbitMQ çš„ Fanout Exchangeã€‚</li>
</ul>
<p><strong>è·¯ç”±ï¼ˆRouting &#x2F; Directï¼‰</strong></p>
<ul>
<li><strong>ç‰¹ç‚¹</strong>ï¼šæ¶ˆæ¯æ ¹æ® <strong>Routing Key</strong> è¢«ç²¾å‡†æŠ•é€’åˆ°åŒ¹é…çš„é˜Ÿåˆ—ï¼Œæ¶ˆè´¹è€…åªæ¥æ”¶ç¬¦åˆè§„åˆ™çš„æ¶ˆæ¯ã€‚</li>
<li><strong>é€‚ç”¨åœºæ™¯</strong>ï¼šæ¡ä»¶è¿‡æ»¤ï¼ˆå¦‚é”™è¯¯æ—¥å¿—åˆ†çº§å¤„ç†ï¼‰ã€‚</li>
<li><strong>ç¤ºä¾‹</strong>ï¼šRabbitMQ çš„ Direct Exchangeã€‚</li>
</ul>
<p><strong>ä¸»é¢˜è·¯ç”±ï¼ˆTopicï¼‰</strong></p>
<ul>
<li><strong>ç‰¹ç‚¹</strong>ï¼šåŸºäº <strong>é€šé…ç¬¦</strong>ï¼ˆå¦‚ <code>user.*</code>ï¼‰åŒ¹é… Routing Keyï¼Œå®ç°çµæ´»è®¢é˜…ï¼Œæ¯” Direct æ›´çµæ´»ï¼Œæ¯” Fanout æ›´ç²¾å‡†ã€‚</li>
<li><strong>é€‚ç”¨åœºæ™¯</strong>ï¼šå¤æ‚äº‹ä»¶åˆ†å‘ï¼ˆå¦‚ç‰©è”ç½‘è®¾å¤‡æ¶ˆæ¯åˆ†ç±»ï¼‰ã€‚</li>
<li><strong>ç¤ºä¾‹</strong>ï¼šRabbitMQ çš„ Topic Exchangeã€MQTT çš„ Topicã€‚</li>
</ul>
<p><strong>æ€»ç»“</strong></p>
<table>
<thead>
<tr>
<th>æ¨¡å‹</th>
<th>ç”Ÿäº§è€…-æ¶ˆè´¹è€…å…³ç³»</th>
<th>å…¸å‹åº”ç”¨åœºæ™¯</th>
</tr>
</thead>
<tbody><tr>
<td><strong>ç‚¹å¯¹ç‚¹</strong></td>
<td>1:1ï¼ˆç«äº‰æ¶ˆè´¹ï¼‰</td>
<td>ä»»åŠ¡é˜Ÿåˆ—ã€è®¢å•å¤„ç†</td>
</tr>
<tr>
<td><strong>å‘å¸ƒ&#x2F;è®¢é˜…</strong></td>
<td>1:Nï¼ˆå¹¿æ’­ï¼‰</td>
<td>æ—¥å¿—å¹¿æ’­ã€å®æ—¶é€šçŸ¥</td>
</tr>
<tr>
<td><strong>è¯·æ±‚&#x2F;å“åº”</strong></td>
<td>1:1ï¼ˆå¸¦å“åº”ï¼‰</td>
<td>å¼‚æ­¥ RPCã€ç»“æœå›è°ƒ</td>
</tr>
<tr>
<td><strong>æ‰‡å‡º</strong></td>
<td>1:Nï¼ˆæ— æ¡ä»¶å¹¿æ’­ï¼‰</td>
<td>å¤šç³»ç»Ÿæ•°æ®åŒæ­¥</td>
</tr>
<tr>
<td><strong>è·¯ç”±</strong></td>
<td>1:1ï¼ˆç²¾å‡†åŒ¹é…ï¼‰</td>
<td>æ¡ä»¶è¿‡æ»¤ã€ä¼˜å…ˆçº§é˜Ÿåˆ—</td>
</tr>
<tr>
<td><strong>ä¸»é¢˜è·¯ç”±</strong></td>
<td>1:Nï¼ˆé€šé…ç¬¦åŒ¹é…ï¼‰</td>
<td>å¤æ‚äº‹ä»¶åˆ†ç±»ï¼ˆå¦‚ IoTï¼‰</td>
</tr>
</tbody></table>
<h3 id="ã€ä¸­ç­‰ã€‘MQ-æ¨æ‹‰æ¨¡å¼å„æœ‰ä»€ä¹ˆåˆ©å¼Šï¼Œå¦‚ä½•é€‰æ‹©ï¼Ÿ"><a href="#ã€ä¸­ç­‰ã€‘MQ-æ¨æ‹‰æ¨¡å¼å„æœ‰ä»€ä¹ˆåˆ©å¼Šï¼Œå¦‚ä½•é€‰æ‹©ï¼Ÿ" class="headerlink" title="ã€ä¸­ç­‰ã€‘MQ æ¨æ‹‰æ¨¡å¼å„æœ‰ä»€ä¹ˆåˆ©å¼Šï¼Œå¦‚ä½•é€‰æ‹©ï¼Ÿ"></a>ã€ä¸­ç­‰ã€‘MQ æ¨æ‹‰æ¨¡å¼å„æœ‰ä»€ä¹ˆåˆ©å¼Šï¼Œå¦‚ä½•é€‰æ‹©ï¼Ÿ</h3><p>æ¶ˆæ¯å¼•æ“ï¼ˆMQï¼‰è·å–æ¶ˆæ¯çš„æ¨¡å¼ä¸»è¦åˆ†ä¸º <strong>Pushï¼ˆæ¨ï¼‰</strong> å’Œ <strong>Pullï¼ˆæ‹‰ï¼‰</strong> ä¸¤ç§ï¼Œä¸åŒæ¶ˆæ¯é˜Ÿåˆ—ä¸­é—´ä»¶é‡‡ç”¨ä¸åŒçš„ç­–ç•¥ï¼Œéƒ¨åˆ†ç³»ç»Ÿè¿˜æ”¯æŒ <strong>æ··åˆæ¨¡å¼</strong>ã€‚</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/202502031317162.png"></p>
<p><strong>Push æ¨¡å¼ï¼ˆæœåŠ¡ç«¯æ¨é€ï¼‰</strong></p>
<ul>
<li><strong>ç‰¹ç‚¹</strong>ï¼š<ul>
<li><strong>æ¶ˆæ¯ç”± Broker ä¸»åŠ¨æ¨é€ç»™æ¶ˆè´¹è€…</strong>ï¼Œæ¶ˆè´¹è€…è¢«åŠ¨æ¥æ”¶ã€‚</li>
<li>å®æ—¶æ€§é«˜ï¼Œå‡å°‘æ¶ˆè´¹è€…è½®è¯¢å¼€é”€ã€‚</li>
</ul>
</li>
<li><strong>ä¼˜ç‚¹</strong>ï¼šä½å»¶è¿Ÿï¼Œé€‚åˆå®æ—¶æ€§è¦æ±‚é«˜çš„åœºæ™¯ï¼ˆå¦‚å³æ—¶é€šè®¯ï¼‰ã€‚</li>
<li><strong>ç¼ºç‚¹</strong>ï¼šå¯èƒ½é€ æˆæ¶ˆè´¹è€…è¿‡è½½ï¼ˆéœ€èƒŒå‹æœºåˆ¶æ§åˆ¶æµé€Ÿï¼‰ã€‚</li>
<li><strong>å…¸å‹å®ç°</strong>ï¼šRabbitMQã€ActiveMQã€RocketMQï¼ˆé»˜è®¤é•¿è½®è¯¢æ¨¡æ‹Ÿ Pushï¼‰ã€‚</li>
</ul>
<p><strong>Pull æ¨¡å¼ï¼ˆå®¢æˆ·ç«¯æ‹‰å–ï¼‰</strong></p>
<ul>
<li><strong>ç‰¹ç‚¹</strong>ï¼š<ul>
<li><strong>æ¶ˆè´¹è€…ä¸»åŠ¨ä» Broker æ‹‰å–æ¶ˆæ¯</strong>ï¼ŒæŒ‰éœ€è·å–ã€‚</li>
<li>æ¶ˆè´¹è€…æ§åˆ¶æ¶ˆè´¹é€Ÿç‡ã€‚</li>
</ul>
</li>
<li><strong>ä¼˜ç‚¹</strong>ï¼šé¿å…æ¶ˆæ¯å †ç§¯å†²å‡»æ¶ˆè´¹è€…ï¼Œé€‚åˆé«˜åååœºæ™¯ï¼ˆå¦‚æ—¥å¿—å¤„ç†ï¼‰ã€‚</li>
<li><strong>ç¼ºç‚¹</strong>ï¼šå­˜åœ¨ç©ºè½®è¯¢å¼€é”€ï¼ˆå¯é€šè¿‡é•¿è½®è¯¢ä¼˜åŒ–ï¼‰ã€‚</li>
<li><strong>å…¸å‹å®ç°</strong>ï¼šKafkaã€Pulsarï¼ˆåŸç”Ÿ Pullï¼‰ã€RocketMQï¼ˆæ”¯æŒæ˜¾å¼ Pullï¼‰ã€‚</li>
</ul>
<p><strong>é•¿è½®è¯¢ï¼ˆLong Pollingï¼‰</strong></p>
<ul>
<li><strong>ç‰¹ç‚¹</strong>ï¼š<strong>Push å’Œ Pull çš„æŠ˜ä¸­æ–¹æ¡ˆ</strong>ã€‚æ¶ˆè´¹è€…å‘èµ·è¯·æ±‚åï¼ŒBroker è‹¥æ— æ¶ˆæ¯åˆ™ä¿æŒè¿æ¥ï¼Œç›´åˆ°æœ‰æ¶ˆæ¯æˆ–è¶…æ—¶æ‰è¿”å›ã€‚</li>
<li><strong>ä¼˜ç‚¹</strong>ï¼šå‡å°‘æ— æ•ˆè½®è¯¢ï¼Œå¹³è¡¡å®æ—¶æ€§ä¸æœåŠ¡ç«¯å‹åŠ›ã€‚</li>
<li><strong>å…¸å‹å®ç°</strong>ï¼šRocketMQï¼ˆé»˜è®¤æ¨¡å¼ï¼‰ã€HTTP é•¿è½®è¯¢ï¼ˆå¦‚ WebSocketï¼‰ã€‚</li>
</ul>
<p><strong>æ··åˆæ¨¡å¼ï¼ˆPush + Pullï¼‰</strong></p>
<ul>
<li><strong>ç‰¹ç‚¹</strong>ï¼š<ul>
<li>å…³é”®æ¶ˆæ¯ç”¨ Push ä¿è¯å®æ—¶æ€§ï¼Œæ‰¹é‡æ•°æ®ç”¨ Pull æé«˜ååã€‚</li>
<li>æ¶ˆè´¹è€…å¯åŠ¨æ€åˆ‡æ¢æ¨¡å¼ã€‚</li>
</ul>
</li>
<li><strong>å…¸å‹å®ç°</strong>ï¼šPulsarï¼ˆæ”¯æŒå¤šæ¨¡å¼ï¼‰ã€éƒ¨åˆ†è‡ªç ” MQ ç³»ç»Ÿã€‚</li>
</ul>
<p><strong>å¯¹æ¯”æ€»ç»“</strong></p>
<table>
<thead>
<tr>
<th>æ¨¡å¼</th>
<th>å®æ—¶æ€§</th>
<th>æœåŠ¡ç«¯å‹åŠ›</th>
<th>æ¶ˆè´¹è€…æ§åˆ¶åŠ›</th>
<th>é€‚ç”¨åœºæ™¯</th>
</tr>
</thead>
<tbody><tr>
<td><strong>Push</strong></td>
<td>é«˜</td>
<td>é«˜</td>
<td>ä½</td>
<td>å³æ—¶é€šè®¯ã€äº‹ä»¶é€šçŸ¥</td>
</tr>
<tr>
<td><strong>Pull</strong></td>
<td>ä½</td>
<td>ä½</td>
<td>é«˜</td>
<td>å¤§æ•°æ®å¤„ç†ã€æ—¥å¿—æ”¶é›†</td>
</tr>
<tr>
<td><strong>é•¿è½®è¯¢</strong></td>
<td>ä¸­</td>
<td>ä¸­</td>
<td>ä¸­</td>
<td>å¹³è¡¡å®æ—¶æ€§ä¸æ€§èƒ½ï¼ˆå¦‚ç”µå•†ï¼‰</td>
</tr>
</tbody></table>
<p><strong>é€‰æ‹©å»ºè®®</strong></p>
<ul>
<li>éœ€è¦ä½å»¶è¿Ÿ â†’ <strong>Push</strong>ï¼ˆå¦‚ RabbitMQï¼‰ã€‚</li>
<li>éœ€è¦é«˜åå â†’ <strong>Pull</strong>ï¼ˆå¦‚ Kafkaï¼‰ã€‚</li>
<li>å¹³è¡¡åœºæ™¯ â†’ <strong>é•¿è½®è¯¢</strong>ï¼ˆå¦‚ RocketMQï¼‰ã€‚</li>
</ul>
<h2 id="MQ-å¯é ä¼ è¾“"><a href="#MQ-å¯é ä¼ è¾“" class="headerlink" title="MQ å¯é ä¼ è¾“"></a>MQ å¯é ä¼ è¾“</h2><h3 id="ã€å›°éš¾ã€‘å¦‚ä½•ä¿è¯-MQ-æ¶ˆæ¯ä¸ä¸¢å¤±ï¼Ÿ"><a href="#ã€å›°éš¾ã€‘å¦‚ä½•ä¿è¯-MQ-æ¶ˆæ¯ä¸ä¸¢å¤±ï¼Ÿ" class="headerlink" title="ã€å›°éš¾ã€‘å¦‚ä½•ä¿è¯ MQ æ¶ˆæ¯ä¸ä¸¢å¤±ï¼Ÿ"></a>ã€å›°éš¾ã€‘å¦‚ä½•ä¿è¯ MQ æ¶ˆæ¯ä¸ä¸¢å¤±ï¼Ÿ</h3><p>è¦ä¿è¯ MQ ä¸­çš„æ¶ˆæ¯ä¸ä¸¢å¤±ï¼Œéœ€ä» <strong>ç”Ÿäº§ç«¯ã€MQ æœåŠ¡ç«¯ã€æ¶ˆè´¹ç«¯</strong> ä¸‰ä¸ªç¯èŠ‚è¿›è¡Œå¯é æ€§è®¾è®¡ã€‚ä¸€è¨€ä»¥è”½ä¹‹ï¼Œ<strong>ç”Ÿäº§ç«¯ç¡®è®¤+æœåŠ¡ç«¯æŒä¹…åŒ–+æ¶ˆè´¹ç«¯æ‰‹åŠ¨ ACK+ç›‘æ§è¡¥å¿</strong> æ˜¯ä¿è¯æ¶ˆæ¯ä¸ä¸¢å¤±çš„æ ¸å¿ƒé€»è¾‘ï¼Œéœ€æ ¹æ®ä¸šåŠ¡åœºæ™¯æƒè¡¡æ€§èƒ½ä¸å¯é æ€§ã€‚</p>
<p>::: info ç”Ÿäº§ç«¯é˜²ä¸¢å¤±</p>
<p>:::</p>
<table>
<thead>
<tr>
<th></th>
<th>Kafka</th>
<th>RocketMQ</th>
</tr>
</thead>
<tbody><tr>
<td><strong>å‘é€æ–¹å¼</strong></td>
<td>æ”¯æŒåŒæ­¥ã€å¼‚æ­¥ã€å¼‚æ­¥å›è°ƒå‘é€æ–¹å¼<br/>åŒæ­¥æ€§èƒ½ä½ï¼›å¼‚æ­¥æ— è§†æˆåŠŸä¸å¦ï¼›å¼‚æ­¥å›è°ƒæ¯”è¾ƒåˆé€‚</td>
<td>æ”¯æŒåŒæ­¥ã€å¼‚æ­¥å›è°ƒå‘é€æ–¹å¼<br/>åŒæ­¥æ€§èƒ½ä½ï¼›å¼‚æ­¥å›è°ƒæ¯”è¾ƒåˆé€‚</td>
</tr>
<tr>
<td><strong>ç”Ÿäº§ ACK</strong></td>
<td><code>acks</code> å‚æ•°ç¡®ä¿æ¶ˆæ¯è¢«å¤šå°‘å‰¯æœ¬å†™å…¥æˆåŠŸåæ‰è¿”å›ç¡®è®¤<br/><code>min.insync.replicas</code> é…åˆ <code>acks</code> ä½¿ç”¨ï¼Œè®¾å®šæœ€å°‘å†™å…¥å‰¯æœ¬æ•°</td>
<td>ï¼ˆé…åˆåˆ·ç›˜æœºåˆ¶ï¼‰è‹¥é…ç½®ä¸ºåŒæ­¥åˆ·ç›˜ï¼Œæ¶ˆæ¯å¿…é¡»å…ˆæˆåŠŸå†™å…¥ç£ç›˜ï¼Œå‘é€æ–¹æ‰èƒ½æ”¶åˆ°å†™æˆåŠŸçš„ç¡®è®¤</td>
</tr>
<tr>
<td><strong>å¤±è´¥é‡è¯•</strong></td>
<td><code>retries</code> å‚æ•°æ§åˆ¶å¤±è´¥é‡è¯•æ¬¡æ•°</td>
<td><code>retryTimesWhenSendFailed</code> å‚æ•°æ§åˆ¶å¤±è´¥é‡è¯•æ¬¡æ•°</td>
</tr>
<tr>
<td><strong>äº‹åŠ¡</strong></td>
<td>é€šè¿‡äº‹åŠ¡+ç”Ÿäº§å¹‚ç­‰ï¼Œå®ç° exactly once è¯­ä¹‰ï¼ŒéçœŸæ­£çš„åˆ†å¸ƒå¼äº‹åŠ¡</td>
<td>å¯å®ç°åˆ†å¸ƒå¼äº‹åŠ¡</td>
</tr>
</tbody></table>
<p>::: info MQ æœåŠ¡ç«¯é˜²ä¸¢å¤±</p>
<p>:::</p>
<table>
<thead>
<tr>
<th></th>
<th>Kafka</th>
<th>RocketMQ</th>
</tr>
</thead>
<tbody><tr>
<td><strong>æŒä¹…åŒ–</strong></td>
<td>æ¶ˆæ¯å†™å…¥é¡µç¼“å­˜ï¼ˆPageCacheï¼‰ï¼Œå³å¯è¿”å›ç”Ÿäº§ ACKï¼Œç”± OS è´Ÿè´£åˆ·ç›˜ï¼ˆ<code>fsync</code>ï¼‰<br/>å¯è®¾ç½®è‡ªåŠ¨åˆ·ç›˜çš„é—´éš”æ—¶é—´æˆ–æ¶ˆæ¯æ•°é˜ˆå€¼<br/>å¯ä»¥é€šè¿‡AdminClientæ‰‹åŠ¨åˆ·ç›˜</td>
<td>é»˜è®¤é‡‡ç”¨å¼‚æ­¥åˆ·ç›˜ï¼Œç±»ä¼¼ Kafkaï¼Œå…ˆå†™å…¥é¡µç¼“å­˜ï¼ˆPageCacheï¼‰ï¼Œç”± OS è´Ÿè´£åˆ·ç›˜ï¼ˆ<code>fsync</code>ï¼‰<br/>ä¹Ÿæ”¯æŒåŒæ­¥åˆ·ç›˜ï¼Œæ¶ˆæ¯å¿…é¡»å…ˆæˆåŠŸå†™å…¥ç£ç›˜ï¼Œå‘é€æ–¹æ‰èƒ½æ”¶åˆ°å†™æˆåŠŸçš„ç¡®è®¤</td>
</tr>
<tr>
<td><strong>å‰¯æœ¬æœºåˆ¶</strong></td>
<td>é€šè¿‡å‰¯æœ¬æœºåˆ¶ä¿è¯å†—ä½™ï¼Œé¿å…å•ç‚¹æ•…éšœ<br/>å‰¯æœ¬çš„ç²’åº¦æ˜¯é’ˆå¯¹åˆ†åŒº<br/><code>replication.factor</code> è®¾ç½®åˆ†åŒºå‰¯æœ¬æ•°<br/><code>min.insync.replicas</code> æ§åˆ¶å†™å…¥åˆ°å¤šå°‘ä¸ªå‰¯æœ¬æ‰ç®—æ˜¯â€œå·²æäº¤â€</td>
<td>é€šè¿‡å‰¯æœ¬æœºåˆ¶ä¿è¯å†—ä½™ï¼Œé¿å…å•ç‚¹æ•…éšœ<br/>å‰¯æœ¬çš„ç²’åº¦æ˜¯é’ˆå¯¹èŠ‚ç‚¹ï¼ˆBrokerï¼‰</td>
</tr>
<tr>
<td><strong>æ•…éšœæ£€æµ‹</strong></td>
<td>æ‰€æœ‰Brokerä¼šå‘zkçš„<code>/borker</code>è·¯å¾„å†™ä¸´æ—¶èŠ‚ç‚¹ï¼Œè€ŒControllerä¼šç›‘å¬è¯¥ç›®å½•<br/>ä¸€æ—¦æœ‰Brokeræ•…éšœæˆ–å¤±è”ï¼Œzkä¼šè¯ä¸­æ–­ï¼Œzkè‡ªåŠ¨åˆ é™¤ä¸´æ—¶èŠ‚ç‚¹ï¼Œå¹¶é€šçŸ¥Controller<br/>Controllerå°†Brokerè§†ä¸ºä¸‹çº¿ï¼Œå¹¶å°†è¯¥Brokerä¸Šçš„åˆ†åŒºLeaderç½®ä¸ºæ— æ•ˆ</td>
<td>ä¸»èŠ‚ç‚¹å®šæœŸå‘ä»èŠ‚ç‚¹å‘é€å¿ƒè·³ä»¥ç»­æ´»<br/>è¶…æ—¶æœªæ”¶åˆ°æ¶ˆæ¯ï¼Œä»èŠ‚ç‚¹è§†ä¸»èŠ‚ç‚¹ä¸ºä¸‹çº¿</td>
</tr>
<tr>
<td><strong>æ•…éšœæ¢å¤</strong></td>
<td>Controller è´Ÿè´£é€‰æ–°çš„åˆ†åŒº Leaderï¼Œä¼˜å…ˆä»ISRä¸­é€‰<br/>é€šè¿‡ <code>unclean.leader.election.enable</code> å¯è®¾ç½®æ˜¯å¦å…è®¸ä»éISRä¸­é€‰Leaderï¼Œä½†ä¸¢å¤±æ•°æ®é£é™©å¢å¤§</td>
<td>é‡‡ç”¨ Raft æ¥é€‰ä¸»</td>
</tr>
</tbody></table>
<p>::: info æ¶ˆè´¹ç«¯é˜²ä¸¢å¤±</p>
<p>:::</p>
<table>
<thead>
<tr>
<th></th>
<th><strong>Kafka</strong></th>
<th><strong>RocketMQ</strong></th>
</tr>
</thead>
<tbody><tr>
<td><strong>æ¶ˆè´¹ ACK</strong></td>
<td>æ”¯æŒè‡ªåŠ¨ã€æ‰‹åŠ¨æäº¤Offsetï¼ˆ<code>enable.auto.commit=false</code>é…ç½®ï¼‰<br/>å…³é—­è‡ªåŠ¨æäº¤ï¼Œå¤„ç†å®Œæ•´äº‹åŠ¡åï¼Œå†æ‰‹åŠ¨æäº¤Offset</td>
<td>æ”¯æŒè‡ªåŠ¨ã€æ‰‹åŠ¨æäº¤Offsetï¼ˆconsumer.setAutoCommité…ç½®ï¼‰<br/>å…³é—­è‡ªåŠ¨æäº¤ï¼Œå¤„ç†å®Œæ•´äº‹åŠ¡åï¼Œå†æ‰‹åŠ¨æäº¤Offset</td>
</tr>
<tr>
<td><strong>é‡ç½® Offset</strong></td>
<td><code>auto.offset.reset</code> å¯ä»¥é‡ç½®æ¶ˆè´¹çš„ Offset</td>
<td></td>
</tr>
<tr>
<td><strong>å¤±è´¥é‡è¯•</strong></td>
<td>ä¸å®Œå–„ï¼šè‡ªåŠ¨æäº¤ä¸æ”¯æŒé‡è¯•ï¼›æ‰‹åŠ¨æäº¤ç»­è‡ªè¡Œå¤„ç†é‡è¯•é€»è¾‘</td>
<td>é»˜è®¤é‡è¯•16æ¬¡<br/>å¤šæ¬¡æ¶ˆè´¹å¤±è´¥åä¼šè¢«æŠ•é€’åˆ°<strong>æ­»ä¿¡é˜Ÿåˆ—</strong>ï¼Œä¾›åç»­ç‰¹æ®Šå¤„ç†</td>
</tr>
</tbody></table>
<p>::: info ç›‘æ§ä¸è¡¥å¿</p>
<p>:::</p>
<ul>
<li><strong>æ¶ˆæ¯å †ç§¯å‘Šè­¦</strong>ï¼šç›‘æ§é˜Ÿåˆ—é•¿åº¦ï¼ŒåŠæ—¶å‘ç°å¼‚å¸¸ã€‚</li>
<li><strong>å®šæœŸå¯¹è´¦</strong>ï¼šå¯¹æ¯”ç”Ÿäº§ä¸æ¶ˆè´¹çš„è®°å½•ï¼Œä¿®å¤å·®å¼‚ï¼ˆå¦‚å®šæ—¶æ‰«ææ•°æ®åº“è¡¥å‘ï¼‰ã€‚</li>
</ul>
<h3 id="ã€å›°éš¾ã€‘å¦‚ä½•ä¿è¯-MQ-æ¶ˆæ¯ä¸é‡å¤ï¼Ÿ"><a href="#ã€å›°éš¾ã€‘å¦‚ä½•ä¿è¯-MQ-æ¶ˆæ¯ä¸é‡å¤ï¼Ÿ" class="headerlink" title="ã€å›°éš¾ã€‘å¦‚ä½•ä¿è¯ MQ æ¶ˆæ¯ä¸é‡å¤ï¼Ÿ"></a>ã€å›°éš¾ã€‘å¦‚ä½•ä¿è¯ MQ æ¶ˆæ¯ä¸é‡å¤ï¼Ÿ</h3><p>::: info MQ ä¸ºä»€ä¹ˆä¼šå‡ºç°é‡å¤æ¶ˆæ¯ï¼Ÿ</p>
<p>:::</p>
<ul>
<li>ç”Ÿäº§ç«¯é‡è¯•ï¼ˆç½‘ç»œæŠ–åŠ¨æ—¶è‡ªåŠ¨é‡å‘ï¼‰</li>
<li>æ¶ˆè´¹ç«¯è¶…æ—¶å MQ é‡æ–°æŠ•é€’ï¼ˆå¦‚ RabbitMQ æœªåŠæ—¶ ACKï¼‰</li>
<li>æ¶ˆæ¯é˜Ÿåˆ—é›†ç¾¤è„‘è£‚ï¼ˆå¦‚ Kafka å‰¯æœ¬åˆ‡æ¢ï¼‰</li>
</ul>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/202502022054834.png"></p>
<p>ä»¥ Kafka ä¸¾ä¾‹ï¼ŒKafka æ¯ä¸ª Partition éƒ½æ˜¯ä¸€ä¸ªæœ‰åºçš„ã€ä¸å¯å˜çš„è®°å½•åºåˆ—ï¼Œä¸æ–­è¿½åŠ åˆ°ç»“æ„åŒ–çš„æäº¤æ—¥å¿—ä¸­ã€‚Partition ä¸­ä¸ºæ¯æ¡è®°å½•åˆ†é…ä¸€ä¸ªè¿ç»­çš„ id å·ï¼Œç§°ä¸ºåç§»é‡ï¼ˆOffsetï¼‰ï¼Œç”¨äºå”¯ä¸€æ ‡è¯† Partition å†…çš„è®°å½•ã€‚</p>
<p>Kafka çš„å®¢æˆ·ç«¯å’Œ Broker éƒ½ä¼šä¿å­˜ Offsetã€‚å®¢æˆ·ç«¯æ¶ˆè´¹æ¶ˆæ¯åï¼Œæ¯éš”ä¸€æ®µæ—¶é—´ï¼Œå°±æŠŠå·²æ¶ˆè´¹çš„ Offset æäº¤ç»™ Kafka Brokerï¼Œè¡¨ç¤ºå·²æ¶ˆè´¹ã€‚</p>
<p>åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œå¦‚æœå®¢æˆ·ç«¯åº”ç”¨æ¶ˆè´¹æ¶ˆæ¯åï¼Œå› ä¸ºå®•æœºã€é‡å¯ç­‰æƒ…å†µè€Œæ²¡æœ‰æäº¤å·²æ¶ˆè´¹çš„ Offset ã€‚å½“ç³»ç»Ÿæ¢å¤åï¼Œä¼šç»§ç»­æ¶ˆè´¹æ¶ˆæ¯ï¼Œç”±äº Offset æœªæäº¤ï¼Œå°±ä¼šå‡ºç°é‡å¤æ¶ˆè´¹çš„é—®é¢˜ã€‚</p>
<p>::: info é‡å¤æ¶ˆæ¯é€šç”¨è§£å†³æ–¹æ¡ˆ</p>
<p>:::</p>
<p>å¤„ç†é‡å¤æ¶ˆæ¯ &#x3D; <strong>â€œä¸šåŠ¡å¹‚ç­‰ä¸ºåŸºç¡€ï¼Œç¼“å­˜&#x2F;DB å»é‡ä¸ºè¾…åŠ©ï¼Œç›‘æ§å…œåº•ä¿ä¸‡ä¸€â€</strong>ã€‚</p>
<p>å¤„ç† MQ é‡å¤æ¶ˆæ¯çš„æ ¸å¿ƒæ€è·¯æ˜¯ <strong>å¹‚ç­‰æ€§è®¾è®¡</strong> + <strong>å»é‡æœºåˆ¶</strong>ï¼Œç¡®ä¿å³ä½¿æ¶ˆæ¯è¢«å¤šæ¬¡æ¶ˆè´¹ï¼Œä¸šåŠ¡ç»“æœä¹Ÿä¸ä¼šå‡ºé”™ã€‚</p>
<p>ï¼ˆ1ï¼‰<strong>ä¸šåŠ¡å±‚å¹‚ç­‰è®¾è®¡</strong></p>
<ul>
<li><p><strong>å”¯ä¸€æ ‡è¯†</strong>ï¼šæ¯æ¡æ¶ˆæ¯æºå¸¦å”¯ä¸€ä¸šåŠ¡ IDï¼ˆå¦‚è®¢å•å·ã€æ”¯ä»˜æµæ°´å·ï¼‰ï¼Œå¤„ç†å‰å…ˆæŸ¥åº“åˆ¤æ–­æ˜¯å¦å·²æ‰§è¡Œã€‚</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> status <span class="keyword">FROM</span> orders <span class="keyword">WHERE</span> order_id <span class="operator">=</span> <span class="string">&#x27;123&#x27;</span>;</span><br><span class="line"><span class="comment">-- è‹¥å·²å¤„ç†åˆ™ç›´æ¥è·³è¿‡</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>çŠ¶æ€æœºæ§åˆ¶</strong>ï¼šä¸šåŠ¡çŠ¶æ€ä¸¥æ ¼æµè½¬ï¼ˆå¦‚ã€Œå·²æ”¯ä»˜ã€è®¢å•ä¸å…è®¸é‡å¤æ‰£æ¬¾ï¼‰ã€‚</p>
</li>
</ul>
<p>ï¼ˆ2ï¼‰<strong>å»é‡è¡¨&#x2F;ç¼“å­˜</strong></p>
<ul>
<li><p><strong>æ•°æ®åº“å»é‡è¡¨</strong>ï¼šæ¶ˆè´¹å‰å…ˆ <code>INSERT</code> å”¯ä¸€é”®ï¼ˆæ¶ˆæ¯ IDï¼‰ï¼Œåˆ©ç”¨ä¸»é”®å†²çªé¿å…é‡å¤å¤„ç†ã€‚</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT INTO</span> message_processed(id) <span class="keyword">VALUES</span> (<span class="string">&#x27;msg_123&#x27;</span>) <span class="keyword">ON</span> DUPLICATE KEY IGNORE;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Redis å»é‡</strong>ï¼šç”¨ <code>SETNX</code> è®¾ç½®æ¶ˆæ¯ ID è¿‡æœŸæ—¶é—´ï¼ˆé€‚åˆé«˜é¢‘åœºæ™¯ï¼‰ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SETNX msg_123 1 EX 3600  <span class="comment"># 1 å°æ—¶å†…ä¸é‡å¤å¤„ç†</span></span><br></pre></td></tr></table></figure></li>
</ul>
<p>::: info ä¸»æµ MQ å¤„ç†</p>
<p>:::</p>
<table>
<thead>
<tr>
<th>æ¶ˆæ¯é˜Ÿåˆ—</th>
<th>é‡å¤è§¦å‘åœºæ™¯</th>
<th>æ¨èæ–¹æ¡ˆ</th>
</tr>
</thead>
<tbody><tr>
<td><strong>Kafka</strong></td>
<td>æ¶ˆè´¹è€…é‡å¯å¯¼è‡´ offset å›æ»š</td>
<td>ä¸šåŠ¡å¹‚ç­‰ + æœ¬åœ° offset æŒä¹…åŒ–</td>
</tr>
<tr>
<td><strong>RabbitMQ</strong></td>
<td>æœª ACK å¯¼è‡´é‡æ–°å…¥é˜Ÿ</td>
<td>æ‰‹åŠ¨ ACK + æ­»ä¿¡é˜Ÿåˆ—ç›‘æ§</td>
</tr>
<tr>
<td><strong>RocketMQ</strong></td>
<td>æ¶ˆæ¯é‡è¯•æœºåˆ¶ï¼ˆ16 æ¬¡åè¿›æ­»ä¿¡ï¼‰</td>
<td>æ¶ˆè´¹æ—¥å¿— + äººå·¥å¹²é¢„</td>
</tr>
</tbody></table>
<p>æç«¯æƒ…å†µå…œåº•ï¼š</p>
<ul>
<li><strong>å¯¹è´¦ç³»ç»Ÿ</strong>ï¼šå®šæ—¶æ‰«æä¸šåŠ¡æ•°æ®ä¸æ¶ˆæ¯è®°å½•ï¼Œä¿®å¤ä¸ä¸€è‡´ï¼ˆå¦‚å®šæ—¶è¡¥å‘çŸ­ä¿¡ï¼‰ã€‚</li>
<li><strong>äººå·¥å‘Šè­¦</strong>ï¼šç›‘æ§é‡å¤æ¶ˆæ¯é¢‘ç‡ï¼ˆå¦‚ 1 åˆ†é’ŸåŒæ¶ˆæ¯ ID å‡ºç° 3 æ¬¡ä»¥ä¸Šåˆ™æŠ¥è­¦ï¼‰ã€‚</li>
</ul>
<p>::: info æ–¹æ¡ˆé€‰å‹</p>
<p>:::</p>
<ul>
<li><strong>ä½é¢‘ä¸šåŠ¡</strong>ï¼šæ•°æ®åº“å”¯ä¸€ç´¢å¼•ï¼ˆç®€å•å¯é ï¼‰ã€‚</li>
<li><strong>é«˜é¢‘ä¸šåŠ¡</strong>ï¼šRedis + è¿‡æœŸæ—¶é—´ï¼ˆé«˜æ€§èƒ½ï¼‰ã€‚</li>
<li><strong>é‡‘èçº§åœºæ™¯</strong>ï¼šå¹‚ç­‰ + å¯¹è´¦ + äººå·¥å®¡æ ¸ï¼ˆå¼ºä¸€è‡´ï¼‰ã€‚</li>
</ul>
<h3 id="ã€å›°éš¾ã€‘å¦‚ä½•ä¿è¯-MQ-æ¶ˆæ¯çš„é¡ºåºæ€§ï¼Ÿ"><a href="#ã€å›°éš¾ã€‘å¦‚ä½•ä¿è¯-MQ-æ¶ˆæ¯çš„é¡ºåºæ€§ï¼Ÿ" class="headerlink" title="ã€å›°éš¾ã€‘å¦‚ä½•ä¿è¯ MQ æ¶ˆæ¯çš„é¡ºåºæ€§ï¼Ÿ"></a>ã€å›°éš¾ã€‘å¦‚ä½•ä¿è¯ MQ æ¶ˆæ¯çš„é¡ºåºæ€§ï¼Ÿ</h3><p>è¦ä¿è¯ MQ æ¶ˆæ¯çš„é¡ºåºæ€§ï¼Œéœ€ä» <strong>ç”Ÿäº§ã€å­˜å‚¨ã€æ¶ˆè´¹</strong> ä¸‰ä¸ªç¯èŠ‚æ§åˆ¶ã€‚</p>
<p>æ ¸å¿ƒæ€è·¯æ˜¯ï¼š<strong>â€œåŒä¸€ä¸šåŠ¡ ID é”å®šåŒä¸€é˜Ÿåˆ— + å•çº¿ç¨‹æ¶ˆè´¹â€</strong>ï¼Œéœ€ç»“åˆä¸šåŠ¡éœ€æ±‚é€‰æ‹©å±€éƒ¨é¡ºåºæˆ–å…¨å±€é¡ºåºæ–¹æ¡ˆã€‚</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/202502022152450.png"></p>
<p>::: info ç”Ÿäº§ç«¯ä¿åº</p>
<p>:::</p>
<ul>
<li><p><strong>å•ç”Ÿäº§è€…+å•çº¿ç¨‹å‘é€</strong>ï¼šåŒä¸€ä¸šåŠ¡ IDï¼ˆå¦‚è®¢å• IDï¼‰çš„æ¶ˆæ¯ç”± <strong>åŒä¸€ç”Ÿäº§è€…çº¿ç¨‹</strong> é¡ºåºå‘é€ï¼Œé¿å…å¤šçº¿ç¨‹å¹¶å‘ä¹±åºã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç¤ºä¾‹ï¼šç›¸åŒ orderId çš„æ¶ˆæ¯ç”±åŒä¸€çº¿ç¨‹å‘é€</span></span><br><span class="line">mqProducer.send(msg, orderId); <span class="comment">// é€šè¿‡ hash é€‰æ‹©åˆ†åŒº</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>ç¦ç”¨å¼‚æ­¥å‘é€é‡è¯•</strong>ï¼šå¼‚æ­¥å‘é€å¤±è´¥æ—¶å¯èƒ½ä¹±åºï¼Œéœ€åŒæ­¥å‘é€æˆ–å…³é—­é‡è¯•ï¼ˆå¦‚ Kafka é…ç½® <code>max.in.flight.requests.per.connection=1</code>ï¼‰ã€‚</p>
</li>
</ul>
<p>::: info MQ æœåŠ¡ç«¯ä¿åº</p>
<p>:::</p>
<ul>
<li><p><strong>å•åˆ†åŒº&#x2F;é˜Ÿåˆ—æœ‰åº</strong></p>
<ul>
<li><p><strong>Kafka&#x2F;RocketMQ</strong>ï¼šåŒä¸€ä¸šåŠ¡ ID çš„æ¶ˆæ¯å‘é€åˆ° <strong>åŒä¸€åˆ†åŒº</strong>ï¼ˆPartitionï¼‰ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ ¹æ® orderId å“ˆå¸Œé€‰æ‹©åˆ†åŒº</span></span><br><span class="line"><span class="type">int</span> <span class="variable">partition</span> <span class="operator">=</span> orderId.hashCode() % partitionNum;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>RabbitMQ</strong>ï¼šä½¿ç”¨å•é˜Ÿåˆ—ï¼ˆæˆ–ä¸€è‡´æ€§å“ˆå¸Œäº¤æ¢å™¨ç»‘å®šå”¯ä¸€é˜Ÿåˆ—ï¼‰ã€‚</p>
</li>
</ul>
</li>
<li><p><strong>å…³é—­åˆ†åŒº&#x2F;é˜Ÿåˆ—å¹¶è¡Œ</strong>ï¼šé¿å…æœåŠ¡ç«¯å¤šåˆ†åŒº&#x2F;å¤šå‰¯æœ¬é—´çš„é¡ºåºæ··ä¹±ï¼ˆå¦‚ Kafka çš„ <code>unclean.leader.election.enable=false</code>ï¼‰ã€‚</p>
</li>
</ul>
<p>::: info æ¶ˆè´¹ç«¯ä¿åº</p>
<p>:::</p>
<ul>
<li><strong>å•æ¶ˆè´¹è€…ä¸²è¡Œæ¶ˆè´¹</strong><ul>
<li>åŒä¸€é˜Ÿåˆ—&#x2F;åˆ†åŒºç”± <strong>å•æ¶ˆè´¹è€…çº¿ç¨‹</strong> å¤„ç†ï¼ˆå¦‚ Kafka å•çº¿ç¨‹æ¶ˆè´¹æˆ– <code>max.poll.records=1</code>ï¼‰ã€‚</li>
<li>å¤šæ¶ˆè´¹è€…æ—¶ï¼Œç›¸åŒä¸šåŠ¡ ID çš„æ¶ˆæ¯è·¯ç”±åˆ°åŒä¸€æ¶ˆè´¹è€…ï¼ˆå¦‚ RocketMQ çš„ <code>MessageQueueSelector</code>ï¼‰ã€‚</li>
</ul>
</li>
<li><strong>å†…å­˜é˜Ÿåˆ—æ’åº</strong>ï¼ˆå¤æ‚åœºæ™¯ï¼‰ï¼šæ¶ˆè´¹è€…æ‹‰å–æ¶ˆæ¯åï¼ŒæŒ‰ä¸šåŠ¡ ID åˆ†ç»„å­˜å…¥å†…å­˜é˜Ÿåˆ—ï¼Œç”±ä¸åŒçº¿ç¨‹åˆ†åˆ«ä¸²è¡Œå¤„ç†ã€‚</li>
</ul>
<p>::: info ç‰¹æ®Šåœºæ™¯å¤„ç†</p>
<p>:::</p>
<ul>
<li><strong>å…¨å±€ä¸¥æ ¼é¡ºåº</strong>ï¼šç‰ºç‰²æ€§èƒ½ï¼Œå…¨é“¾è·¯å•çº¿ç¨‹ï¼ˆç”Ÿäº§â†’MQâ†’æ¶ˆè´¹ï¼‰ï¼Œä»…é€‚åˆä½åååœºæ™¯ï¼ˆå¦‚ Binlog åŒæ­¥ï¼‰ã€‚</li>
<li><strong>å±€éƒ¨é¡ºåº</strong>ï¼šä»…ä¿è¯åŒä¸€ä¸šåŠ¡ ID çš„é¡ºåºï¼ˆå¦‚è®¢å•çš„åˆ›å»ºâ†’æ”¯ä»˜â†’é€€æ¬¾ï¼‰ï¼Œå…è®¸ä¸åŒè®¢å•å¹¶å‘ã€‚</li>
</ul>
<p>::: info ä¸»æµ MQ å¤„ç†</p>
<p>:::</p>
<table>
<thead>
<tr>
<th></th>
<th><strong>Kafka</strong></th>
<th><strong>RocketMQ</strong></th>
</tr>
</thead>
<tbody><tr>
<td><strong>å•åˆ†åŒº&#x2F;é˜Ÿåˆ—æœ‰åº</strong></td>
<td>å•åˆ†åŒºè¿½åŠ å†™å…¥ï¼Œå¤©ç„¶æœ‰åº</td>
<td>å•é˜Ÿåˆ—æœ‰åº</td>
</tr>
<tr>
<td><strong>å“ˆå¸Œè·¯ç”±</strong></td>
<td>é‡‡ç”¨å“ˆå¸Œè·¯ç”±ï¼Œç›¸åŒkeyå›ºå®šå‘å¾€åŒä¸€åˆ†åŒº<br/>å¦‚æœä¸æŒ‡å®škeyï¼Œåˆ™é‡‡ç”¨è½®è¯¢æ–¹å¼é€‰æ‹©åˆ†åŒº</td>
<td>ä½¿ç”¨ <code>MessageQueueSelector</code> æŒ‡å®šé˜Ÿåˆ—</td>
</tr>
<tr>
<td><strong>å•çº¿ç¨‹ç”Ÿäº§</strong></td>
<td><code>max.in.flight.requests.per.connection=1</code> æ§åˆ¶</td>
<td></td>
</tr>
<tr>
<td><strong>å•çº¿ç¨‹æ¶ˆè´¹</strong></td>
<td>ç¡®ä¿ä¸€ä¸ªåˆ†åŒºä»…ç”±ä¸€ä¸ªæ¶ˆè´¹è€…çº¿ç¨‹å¤„ç†ï¼ˆKafka é»˜è®¤è§„åˆ™ï¼‰</td>
<td>ä½¿ç”¨ <code>MessageListenerOrderly</code></td>
</tr>
<tr>
<td><strong>ä¸šåŠ¡ä¿è¯</strong></td>
<td>é¿å…å¤šçº¿ç¨‹å¹¶å‘æ¶ˆè´¹åŒä¸€é˜Ÿåˆ—<br/>åˆ†å¸ƒå¼é”ï¼ˆå¦‚ Redisï¼‰<br/>å…³é”®ä¸šåŠ¡æ“ä½œåŠ é”ï¼Œé˜²æ­¢å¹¶å‘æ‰§è¡Œä¹±åº</td>
<td>é¿å…å¤šçº¿ç¨‹å¹¶å‘æ¶ˆè´¹åŒä¸€é˜Ÿåˆ—<br/>åˆ†å¸ƒå¼é”ï¼ˆå¦‚ Redisï¼‰<br/>å…³é”®ä¸šåŠ¡æ“ä½œåŠ é”ï¼Œé˜²æ­¢å¹¶å‘æ‰§è¡Œä¹±åº</td>
</tr>
</tbody></table>
<p>::: info æ³¨æ„äº‹é¡¹</p>
<p>:::</p>
<ul>
<li><strong>æ€§èƒ½æƒè¡¡</strong>ï¼šé¡ºåºæ€§è¶Šé«˜ï¼Œå¹¶å‘æ€§èƒ½è¶Šä½ï¼ˆéœ€æ ¹æ®ä¸šåŠ¡å®¹å¿åº¦å¹³è¡¡ï¼‰ã€‚</li>
<li><strong>é”™è¯¯å¤„ç†</strong>ï¼šæ¶ˆè´¹å¤±è´¥æ—¶éœ€æš‚åœå½“å‰åˆ†åŒºæ¶ˆè´¹ï¼ˆå¦‚ Kafka çš„ <code>pause()</code>ï¼‰ï¼Œé¿å…è·³è¿‡æ¶ˆæ¯å¯¼è‡´ä¹±åºã€‚</li>
<li><strong>ç›‘æ§</strong>ï¼šå®šæœŸæ£€æŸ¥æ¶ˆæ¯ç§¯å‹å’Œé¡ºåºåç§»ï¼ˆå¦‚ Kafka çš„ <code>consumer.position()</code>ï¼‰ã€‚</li>
</ul>
<h3 id="ã€å›°éš¾ã€‘å¦‚ä½•å¤„ç†-MQ-æ¶ˆæ¯ç§¯å‹ï¼Ÿ"><a href="#ã€å›°éš¾ã€‘å¦‚ä½•å¤„ç†-MQ-æ¶ˆæ¯ç§¯å‹ï¼Ÿ" class="headerlink" title="ã€å›°éš¾ã€‘å¦‚ä½•å¤„ç† MQ æ¶ˆæ¯ç§¯å‹ï¼Ÿ"></a>ã€å›°éš¾ã€‘å¦‚ä½•å¤„ç† MQ æ¶ˆæ¯ç§¯å‹ï¼Ÿ</h3><p>å¤„ç† MQ æ¶ˆæ¯ç§¯å‹çš„æ ¸å¿ƒæ€è·¯æ˜¯ <strong>â€œå¿«é€Ÿæ¶ˆè´¹å­˜é‡+ä¼˜åŒ–ç”Ÿäº§é€Ÿç‡â€</strong>ï¼Œéœ€ç»“åˆç›‘æ§ã€æ‰©å®¹ã€é™çº§ç­‰æ‰‹æ®µç»¼åˆæ²»ç†ã€‚</p>
<p>å¤§è‡´å¯ä»¥å½’çº³ä¸ºï¼š</p>
<ul>
<li><strong>çŸ­æœŸ</strong>ï¼šæ‰©å®¹+é™çº§ï¼Œä¼˜å…ˆæ¢å¤æœåŠ¡ã€‚</li>
<li><strong>é•¿æœŸ</strong>ï¼šä¼˜åŒ–æ¶ˆè´¹é€»è¾‘+è‡ªåŠ¨åŒ–è¿ç»´ï¼Œé¢„é˜²å†æ¬¡ç§¯å‹ã€‚</li>
<li><strong>å£è¯€</strong>ï¼š<strong>ç›‘æ§æ—©å‘ç°ï¼Œæ‰©å®¹æ‰›æµé‡ï¼Œæ¶ˆè´¹æ”¹æ‰¹é‡ï¼Œç”Ÿäº§é™æµé€Ÿ</strong>ã€‚</li>
</ul>
<p>::: info å¿«é€Ÿæ¶ˆè´¹ç§¯å‹æ¶ˆæ¯</p>
<p>:::</p>
<ul>
<li><strong>å¢åŠ æ¶ˆè´¹è€…å®ä¾‹</strong>ï¼šæ¨ªå‘æ‰©å±•æ¶ˆè´¹è€…æœåŠ¡ï¼ˆå¦‚ Kubernetes åŠ¨æ€æ‰©å®¹ Podï¼‰ï¼Œæ³¨æ„åˆ†åŒºæ•°é™åˆ¶ï¼ˆKafka éœ€æå‰è§„åˆ’è¶³å¤Ÿåˆ†åŒºï¼‰ã€‚</li>
<li><strong>æå‡æ¶ˆè´¹å¹¶è¡Œåº¦</strong>ï¼š<ul>
<li>è°ƒæ•´æ¶ˆè´¹è€…å¹¶å‘å‚æ•°ï¼ˆå¦‚ Kafka çš„ <code>max.poll.records</code>ã€RabbitMQ çš„ <code>prefetch_count</code>ï¼‰ã€‚</li>
<li>å¤šçº¿ç¨‹æ¶ˆè´¹ï¼ˆéœ€ä¿è¯æ— é¡ºåºè¦æ±‚çš„åœºæ™¯ï¼‰ã€‚</li>
</ul>
</li>
<li><strong>ä¸´æ—¶é™çº§</strong>ï¼šéæ ¸å¿ƒä¸šåŠ¡æš‚åœæ¶ˆè´¹ï¼ˆå¦‚æ—¥å¿—å¤„ç†ï¼‰ï¼Œé›†ä¸­èµ„æºå¤„ç†æ ¸å¿ƒä¸šåŠ¡æ¶ˆæ¯ã€‚</li>
</ul>
<p>::: info ä¼˜åŒ–æ¶ˆè´¹èƒ½åŠ›</p>
<p>:::</p>
<ul>
<li><strong>æ‰¹é‡å¤„ç†</strong>ï¼šåˆå¹¶å¤šæ¡æ¶ˆæ¯ä¸€æ¬¡å¤„ç†ï¼ˆå¦‚æ•°æ®åº“æ‰¹é‡æ’å…¥ï¼‰ã€‚</li>
<li><strong>å¼‚æ­¥åŒ–+å‰Šå³°</strong>ï¼šæ¶ˆè´¹è€…å°†æ¶ˆæ¯å­˜å…¥å†…å­˜é˜Ÿåˆ—ï¼Œåå°çº¿ç¨‹å¼‚æ­¥å¤„ç†ï¼Œé¿å…åŒæ­¥é˜»å¡ã€‚</li>
<li><strong>è·³è¿‡éå…³é”®é€»è¾‘</strong>ï¼šä¸´æ—¶å…³é—­æ—¥å¿—è®°å½•ã€æ•°æ®æ ¡éªŒç­‰éå¿…è¦æ“ä½œã€‚</li>
</ul>
<p>::: info æ§åˆ¶ç”Ÿäº§ç«¯æµé‡</p>
<p>:::</p>
<ul>
<li><strong>é™æµ</strong>ï¼šç”Ÿäº§ç«¯å¯ç”¨é€Ÿç‡é™åˆ¶ï¼ˆå¦‚ Kafka çš„ <code>quota</code>ã€Redis ä»¤ç‰Œæ¡¶ï¼‰ã€‚</li>
<li><strong>å‰Šå³°å¡«è°·</strong>ï¼šæ¶ˆæ¯å…ˆå†™å…¥ç¼“å­˜å±‚ï¼ˆå¦‚ Redis Listï¼‰ï¼Œå†åŒ€é€Ÿå†™å…¥ MQã€‚</li>
<li><strong>ä¸šåŠ¡é™çº§</strong>ï¼šé«˜å³°æœŸå…³é—­éæ ¸å¿ƒåŠŸèƒ½çš„æ¶ˆæ¯ç”Ÿäº§ï¼ˆå¦‚æš‚åœæ¨èç³»ç»Ÿæ›´æ–°ï¼‰ã€‚</li>
</ul>
<p>::: info ç›‘æ§ä¸å‘Šè­¦</p>
<p>:::</p>
<ul>
<li><strong>å®æ—¶ç›‘æ§æŒ‡æ ‡</strong>ï¼š<ul>
<li>é˜Ÿåˆ—å †ç§¯é‡ï¼ˆå¦‚ Kafka çš„ <code>lag</code>ï¼‰ã€æ¶ˆè´¹é€Ÿç‡ï¼ˆTPSï¼‰ã€æ¶ˆè´¹è€…çŠ¶æ€ã€‚</li>
<li>è®¾ç½®é˜ˆå€¼å‘Šè­¦ï¼ˆå¦‚ç§¯å‹è¶…è¿‡ 10W æ¡è§¦å‘çŸ­ä¿¡é€šçŸ¥ï¼‰ã€‚</li>
</ul>
</li>
<li><strong>æ ¹å› åˆ†æå·¥å…·</strong>ï¼š<ul>
<li>æ—¥å¿—åˆ†æï¼ˆæ¶ˆè´¹è€…å¡é¡¿ã€GC é—®é¢˜ï¼‰ã€‚</li>
<li>é“¾è·¯è¿½è¸ªï¼ˆå¦‚ SkyWalking å®šä½æ…¢æ¶ˆè´¹ï¼‰ã€‚</li>
</ul>
</li>
</ul>
<p>::: info é•¿æœŸé¢„é˜²æªæ–½</p>
<p>:::</p>
<ul>
<li><strong>å®¹é‡è§„åˆ’</strong>ï¼šæ ¹æ®ä¸šåŠ¡å³°å€¼é¢„å…ˆæ‰©å®¹åˆ†åŒº&#x2F;é˜Ÿåˆ—ï¼ˆå¦‚ Kafka åˆ†åŒºæ•° &#x3D; æ¶ˆè´¹è€…æ•° Ã— 1.5ï¼‰ã€‚</li>
<li><strong>æ­»ä¿¡é˜Ÿåˆ—+é‡è¯•æœºåˆ¶</strong>ï¼šå¤„ç†å¤±è´¥çš„æ¶ˆæ¯è½¬å…¥æ­»ä¿¡é˜Ÿåˆ—ï¼Œé¿å…é˜»å¡æ­£å¸¸æ¶ˆè´¹ã€‚</li>
<li><strong>è‡ªåŠ¨åŒ–æ‰©ç¼©å®¹</strong>ï¼šåŸºäºç§¯å‹æŒ‡æ ‡åŠ¨æ€è°ƒæ•´æ¶ˆè´¹è€…æ•°é‡ï¼ˆå¦‚ K8s HPAï¼‰ã€‚</li>
</ul>
<p>::: info ä¸»æµ MQ å¤„ç†</p>
<p>:::</p>
<table>
<thead>
<tr>
<th>æ¶ˆæ¯é˜Ÿåˆ—</th>
<th>å…³é”®æ“ä½œ</th>
</tr>
</thead>
<tbody><tr>
<td><strong>Kafka</strong></td>
<td>å¢åŠ åˆ†åŒº+æ¶ˆè´¹è€…ï¼Œè°ƒæ•´ <code>fetch.max.bytes</code></td>
</tr>
<tr>
<td><strong>RabbitMQ</strong></td>
<td>é•œåƒé˜Ÿåˆ—æ‰©å®¹ï¼Œæé«˜ <code>prefetch_count</code></td>
</tr>
<tr>
<td><strong>RocketMQ</strong></td>
<td>æ¶ˆè´¹ç»„æ‰©å®¹ï¼Œå¯ç”¨å®šæ—¶æ¶ˆæ¯å»¶è¿Ÿæ¶ˆè´¹</td>
</tr>
</tbody></table>
<h2 id="MQ-é«˜å¯ç”¨"><a href="#MQ-é«˜å¯ç”¨" class="headerlink" title="MQ é«˜å¯ç”¨"></a>MQ é«˜å¯ç”¨</h2><h3 id="ã€å›°éš¾ã€‘å¦‚ä½•ä¿è¯-MQ-çš„é«˜å¯ç”¨ï¼Ÿ"><a href="#ã€å›°éš¾ã€‘å¦‚ä½•ä¿è¯-MQ-çš„é«˜å¯ç”¨ï¼Ÿ" class="headerlink" title="ã€å›°éš¾ã€‘å¦‚ä½•ä¿è¯ MQ çš„é«˜å¯ç”¨ï¼Ÿ"></a>ã€å›°éš¾ã€‘å¦‚ä½•ä¿è¯ MQ çš„é«˜å¯ç”¨ï¼Ÿ</h3><p>ä¸åŒ MQ å®ç°é«˜å¯ç”¨çš„åŸç†å„ä¸ç›¸åŒã€‚å› ä¸º Kafka æ¯”è¾ƒå…·æœ‰ä»£è¡¨æ€§ï¼Œæ‰€ä»¥è¿™é‡Œä»¥ Kafka ä¸ºä¾‹ã€‚</p>
<p>::: info Kafka çš„æ ¸å¿ƒæ¦‚å¿µ</p>
<p>:::</p>
<p>äº†è§£ Kafkaï¼Œå¿…é¡»å…ˆäº†è§£ Kafka çš„æ ¸å¿ƒæ¦‚å¿µï¼š</p>
<ul>
<li><p><strong>Broker</strong> - Kafka é›†ç¾¤åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªèŠ‚ç‚¹ï¼Œè¿™ç§èŠ‚ç‚¹è¢«ç§°ä¸º Brokerã€‚</p>
</li>
<li><p><strong>Topic</strong> - æ¯æ¡å‘å¸ƒåˆ° Kafka é›†ç¾¤çš„æ¶ˆæ¯éƒ½æœ‰ä¸€ä¸ªç±»åˆ«ï¼Œè¿™ä¸ªç±»åˆ«è¢«ç§°ä¸º Topicã€‚ï¼ˆä¸åŒ Topic çš„æ¶ˆæ¯æ˜¯ç‰©ç†éš”ç¦»çš„ï¼›åŒä¸€ä¸ª Topic çš„æ¶ˆæ¯ä¿å­˜åœ¨ä¸€ä¸ªæˆ–å¤šä¸ª Broker ä¸Šï¼Œä½†ç”¨æˆ·åªéœ€æŒ‡å®šæ¶ˆæ¯çš„ Topic å³å¯ç”Ÿäº§æˆ–æ¶ˆè´¹æ•°æ®è€Œä¸å¿…å…³å¿ƒæ•°æ®å­˜äºä½•å¤„ï¼‰ã€‚å¯¹äºæ¯ä¸€ä¸ª Topicï¼Œ Kafka é›†ç¾¤éƒ½ä¼šç»´æŒä¸€ä¸ªåˆ†åŒºæ—¥å¿—ã€‚</p>
</li>
<li><p><strong>Partition</strong> - äº†æé«˜ Kafka çš„ååç‡ï¼Œæ¯ä¸ª Topic åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ª Partitionï¼Œæ¯ä¸ª Partition åœ¨ç‰©ç†ä¸Šå¯¹åº”ä¸€ä¸ªæ–‡ä»¶å¤¹ï¼Œè¯¥æ–‡ä»¶å¤¹ä¸‹å­˜å‚¨è¿™ä¸ª Partition çš„æ‰€æœ‰æ¶ˆæ¯å’Œç´¢å¼•æ–‡ä»¶ã€‚</p>
<ul>
<li>Kafka æ—¥å¿—çš„åˆ†åŒºï¼ˆPartitionï¼‰åˆ†å¸ƒåœ¨ Kafka é›†ç¾¤çš„èŠ‚ç‚¹ä¸Šã€‚æ¯ä¸ªèŠ‚ç‚¹åœ¨å¤„ç†æ•°æ®å’Œè¯·æ±‚æ—¶ï¼Œå…±äº«è¿™äº›åˆ†åŒºã€‚æ¯ä¸€ä¸ªåˆ†åŒºéƒ½ä¼šåœ¨å·²é…ç½®çš„èŠ‚ç‚¹ä¸Šè¿›è¡Œå¤‡ä»½ï¼Œç¡®ä¿å®¹é”™æ€§ã€‚</li>
</ul>
</li>
</ul>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/cs/java/javaweb/distributed/mq/kafka/kafka-cluster-roles.png" alt="img"></p>
<p>::: info Kafka çš„å‰¯æœ¬æœºåˆ¶</p>
<p>:::</p>
<p>Kafka æ˜¯å¦‚ä½•å®ç°é«˜å¯ç”¨çš„å‘¢ï¼Ÿ</p>
<p>Kafka åœ¨ 0.8 ä»¥å‰çš„ç‰ˆæœ¬ä¸­ï¼Œå¦‚æœä¸€ä¸ª Broker å®•æœºäº†ï¼Œå…¶ä¸Šé¢çš„ Partition éƒ½ä¸èƒ½ç”¨äº†ï¼Œè¿™è‡ªç„¶ä¸æ˜¯é«˜å¯ç”¨çš„ã€‚</p>
<p>ä¸ºäº†å®ç°é«˜å¯ç”¨ï¼ŒKafka å¼•å…¥äº†å¤åˆ¶åŠŸèƒ½ï¼Œç®€å•æ¥è¯´ï¼Œå°±æ˜¯å‰¯æœ¬æœºåˆ¶ï¼ˆ Replicate ï¼‰ï¼š</p>
<p><strong>æ¯ä¸ª Partition éƒ½æœ‰ä¸€ä¸ª Leaderï¼Œé›¶ä¸ªæˆ–å¤šä¸ª Follower</strong>ã€‚Leader å’Œ Follower éƒ½æ˜¯ Brokerï¼Œæ¯ä¸ª Broker éƒ½ä¼šæˆä¸ºæŸäº›åˆ†åŒºçš„ Leader å’ŒæŸäº›åˆ†åŒºçš„ Followerï¼Œå› æ­¤é›†ç¾¤çš„è´Ÿè½½æ˜¯å¹³è¡¡çš„ã€‚</p>
<ul>
<li><strong>Leader å¤„ç†ä¸€åˆ‡å¯¹ Partition ï¼ˆåˆ†åŒºï¼‰çš„è¯»å†™è¯·æ±‚</strong>ï¼›</li>
<li><strong>è€Œ Follower åªéœ€è¢«åŠ¨çš„åŒæ­¥ Leader ä¸Šçš„æ•°æ®</strong>ã€‚</li>
</ul>
<p><strong>åŒä¸€ä¸ª Topic çš„ä¸åŒ Partition ä¼šåˆ†å¸ƒåœ¨å¤šä¸ª Broker ä¸Šï¼Œè€Œä¸”ä¸€ä¸ª Partition è¿˜ä¼šåœ¨å…¶ä»–çš„ Broker ä¸Šé¢è¿›è¡Œå¤‡ä»½</strong>ï¼ŒProducer åœ¨å‘å¸ƒæ¶ˆæ¯åˆ°æŸä¸ª Partition æ—¶ï¼Œå…ˆæ‰¾åˆ°è¯¥ Partition çš„ Leaderï¼Œç„¶åå‘è¿™ä¸ª Leader æ¨é€æ¶ˆæ¯ï¼›æ¯ä¸ª Follower éƒ½ä» Leader æ‹‰å–æ¶ˆæ¯ï¼Œæ‹‰å–æ¶ˆæ¯æˆåŠŸä¹‹åï¼Œå‘ Leader å‘é€ä¸€ä¸ª ACK ç¡®è®¤ã€‚</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/cs/java/javaweb/distributed/mq/kafka/kafka-replication.png" alt="img"></p>
<blockquote>
<p>FAQ</p>
<p>é—®ï¼šä¸ºä»€ä¹ˆè®© Leader å¤„ç†ä¸€åˆ‡å¯¹å¯¹ Partition ï¼ˆåˆ†åŒºï¼‰çš„è¯»å†™è¯·æ±‚ï¼Ÿ</p>
<p>ç­”ï¼šå› ä¸ºå¦‚æœå…è®¸æ‰€æœ‰ Broker éƒ½å¯ä»¥å¤„ç†è¯»å†™è¯·æ±‚ï¼Œå°±å¯èƒ½äº§ç”Ÿæ•°æ®ä¸€è‡´æ€§é—®é¢˜ã€‚</p>
</blockquote>
<p>::: info Kafka é€‰ä¸¾ Leader</p>
<p>:::</p>
<p>ç”±ä¸Šæ–‡å¯çŸ¥ï¼ŒPartition åœ¨å¤šä¸ª Broker ä¸Šå­˜åœ¨å‰¯æœ¬ã€‚</p>
<p>å¦‚æœæŸä¸ª Follower å®•æœºï¼Œå•¥äº‹å„¿æ²¡æœ‰ï¼Œæ­£å¸¸å·¥ä½œã€‚</p>
<p>å¦‚æœ Leader å®•æœºäº†ï¼Œä¼šä» Follower ä¸­<strong>é‡æ–°é€‰ä¸¾</strong>ä¸€ä¸ªæ–°çš„ Leaderã€‚</p>
<h2 id="MQ-æ¶æ„"><a href="#MQ-æ¶æ„" class="headerlink" title="MQ æ¶æ„"></a>MQ æ¶æ„</h2><h3 id="ã€å›°éš¾ã€‘Kafkaã€ActiveMQã€RabbitMQã€RocketMQ-æœ‰ä»€ä¹ˆä¼˜ç¼ºç‚¹ï¼Ÿ"><a href="#ã€å›°éš¾ã€‘Kafkaã€ActiveMQã€RabbitMQã€RocketMQ-æœ‰ä»€ä¹ˆä¼˜ç¼ºç‚¹ï¼Ÿ" class="headerlink" title="ã€å›°éš¾ã€‘Kafkaã€ActiveMQã€RabbitMQã€RocketMQ æœ‰ä»€ä¹ˆä¼˜ç¼ºç‚¹ï¼Ÿ"></a>ã€å›°éš¾ã€‘Kafkaã€ActiveMQã€RabbitMQã€RocketMQ æœ‰ä»€ä¹ˆä¼˜ç¼ºç‚¹ï¼Ÿ</h3><p>::: info ActiveMQ</p>
<p>:::</p>
<p><code>ActiveMQ</code> æ˜¯ç”± <code>Apache</code> å‡ºå“ï¼Œ<code>ActiveMQ</code> æ˜¯ä¸€ä¸ªå®Œå…¨æ”¯æŒ<code>JMS1.1</code> å’Œ <code>J2EE 1.4</code> è§„èŒƒçš„ <code>JMS Provider</code> å®ç°ã€‚å®ƒéå¸¸å¿«é€Ÿï¼Œæ”¯æŒ <strong>å¤šç§è¯­è¨€çš„å®¢æˆ·ç«¯</strong> å’Œ <strong>åè®®</strong>ï¼Œè€Œä¸”å¯ä»¥éå¸¸å®¹æ˜“çš„åµŒå…¥åˆ°ä¼ä¸šçš„åº”ç”¨ç¯å¢ƒä¸­ï¼Œå¹¶æœ‰è®¸å¤šé«˜çº§åŠŸèƒ½ã€‚</p>
<p><strong>(a) ä¸»è¦ç‰¹æ€§</strong></p>
<ol>
<li><strong>æœä» JMS è§„èŒƒ</strong>ï¼š<code>JMS</code> è§„èŒƒæä¾›äº†è‰¯å¥½çš„æ ‡å‡†å’Œä¿è¯ï¼ŒåŒ…æ‹¬ï¼š<strong>åŒæ­¥</strong> æˆ– <strong>å¼‚æ­¥</strong> çš„æ¶ˆæ¯åˆ†å‘ï¼Œä¸€æ¬¡å’Œä»…ä¸€æ¬¡çš„æ¶ˆæ¯åˆ†å‘ï¼Œ<strong>æ¶ˆæ¯æ¥æ”¶</strong> å’Œ <strong>è®¢é˜…</strong> ç­‰ç­‰ã€‚éµä» <code>JMS</code> è§„èŒƒçš„å¥½å¤„åœ¨äºï¼Œä¸è®ºä½¿ç”¨ä»€ä¹ˆ <code>JMS</code> å®ç°æä¾›è€…ï¼Œè¿™äº›åŸºç¡€ç‰¹æ€§éƒ½æ˜¯å¯ç”¨çš„ï¼›</li>
<li><strong>è¿æ¥çµæ´»æ€§</strong>ï¼š<code>ActiveMQ</code> æä¾›äº†å¹¿æ³›çš„ <strong>è¿æ¥åè®®</strong>ï¼Œæ”¯æŒçš„åè®®æœ‰ï¼š<code>HTTP/S</code>ï¼Œ<code>IP</code> <strong>å¤šæ’­</strong>ï¼Œ<code>SSL</code>ï¼Œ<code>TCP</code>ï¼Œ<code>UDP</code> ç­‰ç­‰ã€‚å¯¹ä¼—å¤šåè®®çš„æ”¯æŒè®© <code>ActiveMQ</code> æ‹¥æœ‰äº†å¾ˆå¥½çš„çµæ´»æ€§ï¼›</li>
<li><strong>æ”¯æŒçš„åè®®ç§ç±»å¤š</strong>ï¼š<code>OpenWire</code>ã€<code>STOMP</code>ã€<code>REST</code>ã€<code>XMPP</code>ã€<code>AMQP</code>ï¼›</li>
<li><strong>æŒä¹…åŒ–æ’ä»¶å’Œå®‰å…¨æ’ä»¶</strong>ï¼š<code>ActiveMQ</code> æä¾›äº† <strong>å¤šç§æŒä¹…åŒ–</strong> é€‰æ‹©ã€‚è€Œä¸”ï¼Œ<code>ActiveMQ</code> çš„å®‰å…¨æ€§ä¹Ÿå¯ä»¥å®Œå…¨ä¾æ®ç”¨æˆ·éœ€æ±‚è¿›è¡Œ <strong>è‡ªå®šä¹‰é‰´æƒ</strong> å’Œ <strong>æˆæƒ</strong>ï¼›</li>
<li><strong>æ”¯æŒçš„å®¢æˆ·ç«¯è¯­è¨€ç§ç±»å¤š</strong>ï¼šé™¤äº† <code>Java</code> ä¹‹å¤–ï¼Œè¿˜æœ‰ï¼š<code>C/C++</code>ï¼Œ<code>.NET</code>ï¼Œ<code>Perl</code>ï¼Œ<code>PHP</code>ï¼Œ<code>Python</code>ï¼Œ<code>Ruby</code>ï¼›</li>
<li><strong>ä»£ç†é›†ç¾¤</strong>ï¼šå¤šä¸ª <code>ActiveMQ</code> <strong>ä»£ç†</strong> å¯ä»¥ç»„æˆä¸€ä¸ª <strong>é›†ç¾¤</strong> æ¥æä¾›æœåŠ¡ï¼›</li>
<li><strong>å¼‚å¸¸ç®€å•çš„ç®¡ç†</strong>ï¼š<code>ActiveMQ</code> æ˜¯ä»¥å¼€å‘è€…æ€ç»´è¢«è®¾è®¡çš„ã€‚æ‰€ä»¥ï¼Œå®ƒå¹¶ä¸éœ€è¦ä¸“é—¨çš„ç®¡ç†å‘˜ï¼Œå› ä¸ºå®ƒæä¾›äº†ç®€å•åˆä½¿ç”¨çš„ç®¡ç†ç‰¹æ€§ã€‚æœ‰å¾ˆå¤šä¸­æ–¹æ³•å¯ä»¥ <strong>ç›‘æ§</strong> <code>ActiveMQ</code> ä¸åŒå±‚é¢çš„æ•°æ®ï¼ŒåŒ…æ‹¬ä½¿ç”¨åœ¨ <code>JConsole</code> æˆ–è€…åœ¨ <code>ActiveMQ</code> çš„ <code>Web Console</code> ä¸­ä½¿ç”¨ <code>JMX</code>ã€‚é€šè¿‡å¤„ç† <code>JMX</code> çš„å‘Šè­¦æ¶ˆæ¯ï¼Œé€šè¿‡ä½¿ç”¨ <strong>å‘½ä»¤è¡Œè„šæœ¬</strong>ï¼Œç”šè‡³å¯ä»¥é€šè¿‡ç›‘æ§å„ç§ç±»å‹çš„ <strong>æ—¥å¿—</strong>ã€‚</li>
</ol>
<p><strong>(b) éƒ¨ç½²ç¯å¢ƒ</strong></p>
<p><code>ActiveMQ</code> å¯ä»¥è¿è¡Œåœ¨ <code>Java</code> è¯­è¨€æ‰€æ”¯æŒçš„å¹³å°ä¹‹ä¸Šã€‚ä½¿ç”¨ <code>ActiveMQ</code> éœ€è¦ï¼š</p>
<ul>
<li><code>Java JDK</code></li>
<li><code>ActiveMQ</code> å®‰è£…åŒ…</li>
</ul>
<p><strong>(c) ä¼˜ç‚¹</strong></p>
<ol>
<li><strong>è·¨å¹³å°</strong> (<code>JAVA</code> ç¼–å†™ä¸å¹³å°æ— å…³ï¼Œ<code>ActiveMQ</code> å‡ ä¹å¯ä»¥è¿è¡Œåœ¨ä»»ä½•çš„ <code>JVM</code> ä¸Šï¼‰ï¼›</li>
<li>å¯ä»¥ç”¨ <code>JDBC</code>ï¼šå¯ä»¥å°† <strong>æ•°æ®æŒä¹…åŒ–</strong> åˆ°æ•°æ®åº“ã€‚è™½ç„¶ä½¿ç”¨ <code>JDBC</code> ä¼šé™ä½ <code>ActiveMQ</code> çš„æ€§èƒ½ï¼Œä½†æ˜¯æ•°æ®åº“ä¸€ç›´éƒ½æ˜¯å¼€å‘äººå‘˜æœ€ç†Ÿæ‚‰çš„å­˜å‚¨ä»‹è´¨ï¼›</li>
<li>æ”¯æŒ <code>JMS</code> è§„èŒƒï¼šæ”¯æŒ <code>JMS</code> è§„èŒƒæä¾›çš„ <strong>ç»Ÿä¸€æ¥å£</strong>;</li>
<li>æ”¯æŒ <strong>è‡ªåŠ¨é‡è¿</strong> å’Œ <strong>é”™è¯¯é‡è¯•æœºåˆ¶</strong>ï¼›</li>
<li>æœ‰å®‰å…¨æœºåˆ¶ï¼šæ”¯æŒåŸºäº <code>shiro</code>ï¼Œ<code>jaas</code> ç­‰å¤šç§ <strong>å®‰å…¨é…ç½®æœºåˆ¶</strong>ï¼Œå¯ä»¥å¯¹ <code>Queue/Topic</code> è¿›è¡Œ <strong>è®¤è¯å’Œæˆæƒ</strong>ï¼›</li>
<li>ç›‘æ§å®Œå–„ï¼šæ‹¥æœ‰å®Œå–„çš„ <strong>ç›‘æ§</strong>ï¼ŒåŒ…æ‹¬ <code>Web Console</code>ï¼Œ<code>JMX</code>ï¼Œ<code>Shell</code> å‘½ä»¤è¡Œï¼Œ<code>Jolokia</code> çš„ <code>RESTful API</code>ï¼›</li>
<li>ç•Œé¢å‹å–„ï¼šæä¾›çš„ <code>Web Console</code> å¯ä»¥æ»¡è¶³å¤§éƒ¨åˆ†æƒ…å†µï¼Œè¿˜æœ‰å¾ˆå¤š <strong>ç¬¬ä¸‰æ–¹çš„ç»„ä»¶</strong> å¯ä»¥ä½¿ç”¨ï¼Œæ¯”å¦‚ <code>hawtio</code>ï¼›</li>
</ol>
<p><strong>(d) ç¼ºç‚¹</strong></p>
<ol>
<li>ç¤¾åŒºæ´»è·ƒåº¦ä¸åŠ <code>RabbitMQ</code> é«˜ï¼›</li>
<li>æ ¹æ®å…¶ä»–ç”¨æˆ·åé¦ˆï¼Œä¼šå‡ºè«åå…¶å¦™çš„é—®é¢˜ï¼Œä¼š <strong>ä¸¢å¤±æ¶ˆæ¯</strong>ï¼›</li>
<li>ç›®å‰é‡å¿ƒæ”¾åˆ° <code>activemq 6.0</code> äº§å“ <code>Apollo</code>ï¼Œå¯¹ <code>5.x</code> çš„ç»´æŠ¤è¾ƒå°‘ï¼›</li>
<li>ä¸é€‚åˆç”¨äº <strong>ä¸Šåƒä¸ªé˜Ÿåˆ—</strong> çš„åº”ç”¨åœºæ™¯ï¼›</li>
</ol>
<p>::: info RabbitMQ</p>
<p>:::</p>
<p><code>RabbitMQ</code> äº <code>2007</code> å¹´å‘å¸ƒï¼Œæ˜¯ä¸€ä¸ªåœ¨ <code>AMQP</code> (<strong>é«˜çº§æ¶ˆæ¯é˜Ÿåˆ—åè®®</strong>) åŸºç¡€ä¸Šå®Œæˆçš„ï¼Œå¯å¤ç”¨çš„ä¼ä¸šæ¶ˆæ¯ç³»ç»Ÿï¼Œæ˜¯å½“å‰æœ€ä¸»æµçš„æ¶ˆæ¯ä¸­é—´ä»¶ä¹‹ä¸€ã€‚</p>
<p><strong>(a) ä¸»è¦ç‰¹æ€§</strong></p>
<ol>
<li><strong>å¯é æ€§</strong>ï¼šæä¾›äº†å¤šç§æŠ€æœ¯å¯ä»¥è®©ä½ åœ¨ <strong>æ€§èƒ½</strong> å’Œ <strong>å¯é æ€§</strong> ä¹‹é—´è¿›è¡Œ <strong>æƒè¡¡</strong>ã€‚è¿™äº›æŠ€æœ¯åŒ…æ‹¬ <strong>æŒä¹…æ€§æœºåˆ¶</strong>ã€<strong>æŠ•é€’ç¡®è®¤</strong>ã€<strong>å‘å¸ƒè€…è¯å®</strong> å’Œ <strong>é«˜å¯ç”¨æ€§æœºåˆ¶</strong>ï¼›</li>
<li><strong>çµæ´»çš„è·¯ç”±</strong>ï¼šæ¶ˆæ¯åœ¨åˆ°è¾¾é˜Ÿåˆ—å‰æ˜¯é€šè¿‡ <strong>äº¤æ¢æœº</strong> è¿›è¡Œ <strong>è·¯ç”±</strong> çš„ã€‚<code>RabbitMQ</code> ä¸ºå…¸å‹çš„è·¯ç”±é€»è¾‘æä¾›äº† <strong>å¤šç§å†…ç½®äº¤æ¢æœº</strong> ç±»å‹ã€‚å¦‚æœä½ æœ‰æ›´å¤æ‚çš„è·¯ç”±éœ€æ±‚ï¼Œå¯ä»¥å°†è¿™äº›äº¤æ¢æœºç»„åˆèµ·æ¥ä½¿ç”¨ï¼Œä½ ç”šè‡³å¯ä»¥å®ç°è‡ªå·±çš„äº¤æ¢æœºç±»å‹ï¼Œå¹¶ä¸”å½“åš <code>RabbitMQ</code> çš„ <strong>æ’ä»¶</strong> æ¥ä½¿ç”¨ï¼›</li>
<li><strong>æ¶ˆæ¯é›†ç¾¤</strong>ï¼šåœ¨ç›¸åŒå±€åŸŸç½‘ä¸­çš„å¤šä¸ª <code>RabbitMQ</code> æœåŠ¡å™¨å¯ä»¥ <strong>èšåˆ</strong> åœ¨ä¸€èµ·ï¼Œä½œä¸ºä¸€ä¸ªç‹¬ç«‹çš„é€»è¾‘ä»£ç†æ¥ä½¿ç”¨ï¼›</li>
<li><strong>é˜Ÿåˆ—é«˜å¯ç”¨</strong>ï¼šé˜Ÿåˆ—å¯ä»¥åœ¨é›†ç¾¤ä¸­çš„æœºå™¨ä¸Š <strong>è¿›è¡Œé•œåƒ</strong>ï¼Œä»¥ç¡®ä¿åœ¨ç¡¬ä»¶é—®é¢˜ä¸‹è¿˜ä¿è¯ <strong>æ¶ˆæ¯å®‰å…¨</strong>ï¼›</li>
<li><strong>æ”¯æŒå¤šç§åè®®</strong>ï¼šæ”¯æŒ <strong>å¤šç§æ¶ˆæ¯é˜Ÿåˆ—åè®®</strong>ï¼›</li>
<li><strong>æ”¯æŒå¤šç§è¯­è¨€</strong>ï¼šç”¨ <code>Erlang</code> è¯­è¨€ç¼–å†™ï¼Œæ”¯æŒåªè¦æ˜¯ä½ èƒ½æƒ³åˆ°çš„ <strong>æ‰€æœ‰ç¼–ç¨‹è¯­è¨€</strong>ï¼›</li>
<li><strong>ç®¡ç†ç•Œé¢</strong>ï¼š <code>RabbitMQ</code> æœ‰ä¸€ä¸ªæ˜“ç”¨çš„ <strong>ç”¨æˆ·ç•Œé¢</strong>ï¼Œä½¿å¾—ç”¨æˆ·å¯ä»¥ <strong>ç›‘æ§</strong> å’Œ <strong>ç®¡ç†</strong> æ¶ˆæ¯ <code>Broker</code> çš„è®¸å¤šæ–¹é¢ï¼›</li>
<li><strong>è·Ÿè¸ªæœºåˆ¶</strong>ï¼šå¦‚æœ <strong>æ¶ˆæ¯å¼‚å¸¸</strong>ï¼Œ<code>RabbitMQ</code> æä¾›æ¶ˆæ¯è·Ÿè¸ªæœºåˆ¶ï¼Œä½¿ç”¨è€…å¯ä»¥æ‰¾å‡ºå‘ç”Ÿäº†ä»€ä¹ˆï¼›</li>
<li><strong>æ’ä»¶æœºåˆ¶</strong>ï¼šæä¾›äº†è®¸å¤š <strong>æ’ä»¶</strong>ï¼Œæ¥ä»å¤šæ–¹é¢è¿›è¡Œæ‰©å±•ï¼Œä¹Ÿå¯ä»¥ç¼–å†™è‡ªå·±çš„æ’ä»¶ã€‚</li>
</ol>
<p><strong>(b) éƒ¨ç½²ç¯å¢ƒ</strong></p>
<p><code>RabbitMQ</code> å¯ä»¥è¿è¡Œåœ¨ <code>Erlang</code> è¯­è¨€æ‰€æ”¯æŒçš„å¹³å°ä¹‹ä¸Šï¼ŒåŒ…æ‹¬ <code>Solaris</code>ï¼Œ<code>BSD</code>ï¼Œ<code>Linux</code>ï¼Œ<code>MacOSX</code>ï¼Œ<code>TRU64</code>ï¼Œ<code>Windows</code> ç­‰ã€‚ä½¿ç”¨ <code>RabbitMQ</code> éœ€è¦ï¼š</p>
<ul>
<li><code>ErLang</code> è¯­è¨€åŒ…</li>
<li><code>RabbitMQ</code> å®‰è£…åŒ…</li>
</ul>
<p><strong>(c) ä¼˜ç‚¹</strong></p>
<ol>
<li>ç”±äº <code>Erlang</code> è¯­è¨€çš„ç‰¹æ€§ï¼Œæ¶ˆæ¯é˜Ÿåˆ—æ€§èƒ½è¾ƒå¥½ï¼Œæ”¯æŒ <strong>é«˜å¹¶å‘</strong>ï¼›</li>
<li>å¥å£®ã€ç¨³å®šã€æ˜“ç”¨ã€<strong>è·¨å¹³å°</strong>ã€æ”¯æŒ <strong>å¤šç§è¯­è¨€</strong>ã€æ–‡æ¡£é½å…¨ï¼›</li>
<li>æœ‰æ¶ˆæ¯ <strong>ç¡®è®¤æœºåˆ¶</strong> å’Œ <strong>æŒä¹…åŒ–æœºåˆ¶</strong>ï¼Œå¯é æ€§é«˜ï¼›</li>
<li>é«˜åº¦å¯å®šåˆ¶çš„ <strong>è·¯ç”±</strong>ï¼›</li>
<li><strong>ç®¡ç†ç•Œé¢</strong> è¾ƒä¸°å¯Œï¼Œåœ¨äº’è”ç½‘å…¬å¸ä¹Ÿæœ‰è¾ƒå¤§è§„æ¨¡çš„åº”ç”¨ï¼Œç¤¾åŒºæ´»è·ƒåº¦é«˜ã€‚</li>
</ol>
<p><strong>(d) ç¼ºç‚¹</strong></p>
<ol>
<li>å°½ç®¡ç»“åˆ <code>Erlang</code> è¯­è¨€æœ¬èº«çš„å¹¶å‘ä¼˜åŠ¿ï¼Œæ€§èƒ½è¾ƒå¥½ï¼Œä½†æ˜¯ä¸åˆ©äºåš <strong>äºŒæ¬¡å¼€å‘å’Œç»´æŠ¤</strong>ï¼›</li>
<li>å®ç°äº† <strong>ä»£ç†æ¶æ„</strong>ï¼Œæ„å‘³ç€æ¶ˆæ¯åœ¨å‘é€åˆ°å®¢æˆ·ç«¯ä¹‹å‰å¯ä»¥åœ¨ <strong>ä¸­å¤®èŠ‚ç‚¹</strong> ä¸Šæ’é˜Ÿã€‚æ­¤ç‰¹æ€§ä½¿å¾— <code>RabbitMQ</code> æ˜“äºä½¿ç”¨å’Œéƒ¨ç½²ï¼Œä½†æ˜¯ä½¿å¾—å…¶ <strong>è¿è¡Œé€Ÿåº¦è¾ƒæ…¢</strong>ï¼Œå› ä¸ºä¸­å¤®èŠ‚ç‚¹ <strong>å¢åŠ äº†å»¶è¿Ÿ</strong>ï¼Œ<strong>æ¶ˆæ¯å°è£…å</strong> ä¹Ÿæ¯”è¾ƒå¤§ï¼›</li>
<li>éœ€è¦å­¦ä¹  <strong>æ¯”è¾ƒå¤æ‚</strong> çš„ <strong>æ¥å£å’Œåè®®</strong>ï¼Œå­¦ä¹ å’Œç»´æŠ¤æˆæœ¬è¾ƒé«˜ã€‚</li>
</ol>
<p>::: info RocketMQ</p>
<p>:::</p>
<p><code>RocketMQ</code> å‡ºè‡ª <strong>é˜¿é‡Œ</strong> çš„å¼€æºäº§å“ï¼Œç”¨ <code>Java</code> è¯­è¨€å®ç°ï¼Œåœ¨è®¾è®¡æ—¶å‚è€ƒäº† <code>Kafka</code>ï¼Œå¹¶åšå‡ºäº†è‡ªå·±çš„ä¸€äº›æ”¹è¿›ï¼Œ<strong>æ¶ˆæ¯å¯é æ€§ä¸Š</strong> æ¯” <code>Kafka</code> æ›´å¥½ã€‚<code>RocketMQ</code> åœ¨é˜¿é‡Œå†…éƒ¨  è¢«å¹¿æ³›åº”ç”¨åœ¨ <strong>è®¢å•</strong>ï¼Œ<strong>äº¤æ˜“</strong>ï¼Œ<strong>å……å€¼</strong>ï¼Œ<strong>æµè®¡ç®—</strong>ï¼Œ<strong>æ¶ˆæ¯æ¨é€</strong>ï¼Œ<strong>æ—¥å¿—æµå¼å¤„ç†</strong>ï¼Œ<code>binglog</code> <strong>åˆ†å‘</strong> ç­‰åœºæ™¯ã€‚</p>
<p><strong>(a) ä¸»è¦ç‰¹æ€§</strong></p>
<ol>
<li>åŸºäº <strong>é˜Ÿåˆ—æ¨¡å‹</strong>ï¼šå…·æœ‰ <strong>é«˜æ€§èƒ½</strong>ã€<strong>é«˜å¯é </strong>ã€<strong>é«˜å®æ—¶</strong>ã€<strong>åˆ†å¸ƒå¼</strong> ç­‰ç‰¹ç‚¹ï¼›</li>
<li><code>Producer</code>ã€<code>Consumer</code>ã€<strong>é˜Ÿåˆ—</strong> éƒ½æ”¯æŒ <strong>åˆ†å¸ƒå¼</strong>ï¼›</li>
<li><code>Producer</code> å‘ä¸€äº›é˜Ÿåˆ—è½®æµå‘é€æ¶ˆæ¯ï¼Œ<strong>é˜Ÿåˆ—é›†åˆ</strong> ç§°ä¸º <code>Topic</code>ã€‚<code>Consumer</code> å¦‚æœåš <strong>å¹¿æ’­æ¶ˆè´¹</strong>ï¼Œåˆ™ä¸€ä¸ª <code>Consumer</code> å®ä¾‹æ¶ˆè´¹è¿™ä¸ª <code>Topic</code> å¯¹åº”çš„ <strong>æ‰€æœ‰é˜Ÿåˆ—</strong>ï¼›å¦‚æœåš <strong>é›†ç¾¤æ¶ˆè´¹</strong>ï¼Œåˆ™ <strong>å¤šä¸ª</strong> <code>Consumer</code> å®ä¾‹ <strong>å¹³å‡æ¶ˆè´¹</strong> è¿™ä¸ª <code>Topic</code> å¯¹åº”çš„é˜Ÿåˆ—é›†åˆï¼›</li>
<li>èƒ½å¤Ÿä¿è¯ <strong>ä¸¥æ ¼çš„æ¶ˆæ¯é¡ºåº</strong>ï¼›</li>
<li>æä¾›ä¸°å¯Œçš„ <strong>æ¶ˆæ¯æ‹‰å–æ¨¡å¼</strong>ï¼›</li>
<li>é«˜æ•ˆçš„è®¢é˜…è€… <strong>æ°´å¹³æ‰©å±•</strong>èƒ½åŠ›ï¼›</li>
<li><strong>å®æ—¶</strong> çš„ <strong>æ¶ˆæ¯è®¢é˜…æœºåˆ¶</strong>ï¼›</li>
<li>äº¿çº§ <strong>æ¶ˆæ¯å †ç§¯</strong> èƒ½åŠ›ï¼›</li>
<li>è¾ƒå°‘çš„å¤–éƒ¨ä¾èµ–ã€‚</li>
</ol>
<p><strong>(b) éƒ¨ç½²ç¯å¢ƒ</strong></p>
<p><code>RocketMQ</code> å¯ä»¥è¿è¡Œåœ¨ <code>Java</code> è¯­è¨€æ‰€æ”¯æŒçš„å¹³å°ä¹‹ä¸Šã€‚ä½¿ç”¨ <code>RocketMQ</code> éœ€è¦ï¼š</p>
<ul>
<li><code>Java JDK</code></li>
<li>å®‰è£… <code>git</code>ã€<code>Maven</code></li>
<li><code>RocketMQ</code> å®‰è£…åŒ…</li>
</ul>
<p><strong>(c) ä¼˜ç‚¹</strong></p>
<ol>
<li><strong>å•æœº</strong> æ”¯æŒ <code>1</code> ä¸‡ä»¥ä¸Š <strong>æŒä¹…åŒ–é˜Ÿåˆ—</strong>ï¼›</li>
<li><code>RocketMQ</code> çš„æ‰€æœ‰æ¶ˆæ¯éƒ½æ˜¯ <strong>æŒä¹…åŒ–çš„</strong>ï¼Œå…ˆå†™å…¥ç³»ç»Ÿ <code>PAGECACHE</code>ï¼Œç„¶å <strong>åˆ·ç›˜</strong>ï¼Œå¯ä»¥ä¿è¯ <strong>å†…å­˜</strong> ä¸ <strong>ç£ç›˜</strong> éƒ½æœ‰ä¸€ä»½æ•°æ®ï¼Œè€Œ <strong>è®¿é—®</strong> æ—¶ï¼Œç›´æ¥ <strong>ä»å†…å­˜è¯»å–</strong>ã€‚</li>
<li>æ¨¡å‹ç®€å•ï¼Œæ¥å£æ˜“ç”¨ï¼ˆ<code>JMS</code> çš„æ¥å£å¾ˆå¤šåœºåˆå¹¶ä¸å¤ªå®ç”¨ï¼‰ï¼›</li>
<li><strong>æ€§èƒ½éå¸¸å¥½</strong>ï¼Œå¯ä»¥å…è®¸ <strong>å¤§é‡å †ç§¯æ¶ˆæ¯</strong> åœ¨ <code>Broker</code> ä¸­ï¼›</li>
<li>æ”¯æŒ <strong>å¤šç§æ¶ˆè´¹æ¨¡å¼</strong>ï¼ŒåŒ…æ‹¬ <strong>é›†ç¾¤æ¶ˆè´¹</strong>ã€<strong>å¹¿æ’­æ¶ˆè´¹</strong>ç­‰ï¼›</li>
<li>å„ä¸ªç¯èŠ‚ <strong>åˆ†å¸ƒå¼æ‰©å±•è®¾è®¡</strong>ï¼Œæ”¯æŒ <strong>ä¸»ä»</strong> å’Œ <strong>é«˜å¯ç”¨</strong>ï¼›</li>
<li>å¼€å‘åº¦è¾ƒæ´»è·ƒï¼Œç‰ˆæœ¬æ›´æ–°å¾ˆå¿«ã€‚</li>
</ol>
<p><strong>(d) ç¼ºç‚¹</strong></p>
<ol>
<li>æ”¯æŒçš„ <strong>å®¢æˆ·ç«¯è¯­è¨€</strong> ä¸å¤šï¼Œç›®å‰æ˜¯ <code>Java</code> åŠ <code>C++</code>ï¼Œå…¶ä¸­ <code>C++</code> è¿˜ä¸æˆç†Ÿï¼›</li>
<li><code>RocketMQ</code> ç¤¾åŒºå…³æ³¨åº¦åŠæˆç†Ÿåº¦ä¹Ÿä¸åŠå‰ä¸¤è€…ï¼›</li>
<li>æ²¡æœ‰ <code>Web</code> ç®¡ç†ç•Œé¢ï¼Œæä¾›äº†ä¸€ä¸ª <code>CLI</code> ï¼ˆå‘½ä»¤è¡Œç•Œé¢ï¼‰ ç®¡ç†å·¥å…·å¸¦æ¥ <strong>æŸ¥è¯¢</strong>ã€<strong>ç®¡ç†</strong> å’Œ <strong>è¯Šæ–­å„ç§é—®é¢˜</strong>ï¼›</li>
<li>æ²¡æœ‰åœ¨ <code>MQ</code> æ ¸å¿ƒé‡Œå®ç° <code>JMS</code> ç­‰æ¥å£ï¼›</li>
</ol>
<p>::: info Kafka</p>
<p>:::</p>
<p><code>Apache Kafka</code> æ˜¯ä¸€ä¸ª <strong>åˆ†å¸ƒå¼æ¶ˆæ¯å‘å¸ƒè®¢é˜…</strong> ç³»ç»Ÿã€‚å®ƒæœ€åˆç”± <code>LinkedIn</code> å…¬å¸åŸºäºç‹¬ç‰¹çš„è®¾è®¡å®ç°ä¸ºä¸€ä¸ª <strong>åˆ†å¸ƒå¼çš„æ—¥å¿—æäº¤ç³»ç»Ÿ</strong> (<code>a distributed commit log</code>)ï¼Œä¹‹åæˆä¸º <code>Apache</code> é¡¹ç›®çš„ä¸€éƒ¨åˆ†ã€‚<code>Kafka</code> <strong>æ€§èƒ½é«˜æ•ˆ</strong>ã€<strong>å¯æ‰©å±•è‰¯å¥½</strong> å¹¶ä¸” <strong>å¯æŒä¹…åŒ–</strong>ã€‚å®ƒçš„ <strong>åˆ†åŒºç‰¹æ€§</strong>ï¼Œ<strong>å¯å¤åˆ¶</strong> å’Œ <strong>å¯å®¹é”™</strong> éƒ½æ˜¯å…¶ä¸é”™çš„ç‰¹æ€§ã€‚</p>
<p><strong>(a) ä¸»è¦ç‰¹æ€§</strong></p>
<ol>
<li><strong>å¿«é€ŸæŒä¹…åŒ–</strong>ï¼šå¯ä»¥åœ¨ <code>O(1)</code> çš„ç³»ç»Ÿå¼€é”€ä¸‹è¿›è¡Œ <strong>æ¶ˆæ¯æŒä¹…åŒ–</strong>ï¼›</li>
<li><strong>é«˜åå</strong>ï¼šåœ¨ä¸€å°æ™®é€šçš„æœåŠ¡å™¨ä¸Šæ—¢å¯ä»¥è¾¾åˆ° <code>10W/s</code> çš„ <strong>ååé€Ÿç‡</strong>ï¼›</li>
<li><strong>å®Œå…¨çš„åˆ†å¸ƒå¼ç³»ç»Ÿ</strong>ï¼š<code>Broker</code>ã€<code>Producer</code> å’Œ <code>Consumer</code> éƒ½åŸç”Ÿè‡ªåŠ¨æ”¯æŒ <strong>åˆ†å¸ƒå¼</strong>ï¼Œè‡ªåŠ¨å®ç° <strong>è´Ÿè½½å‡è¡¡</strong>ï¼›</li>
<li>æ”¯æŒ <strong>åŒæ­¥</strong> å’Œ <strong>å¼‚æ­¥</strong> å¤åˆ¶ä¸¤ç§ <strong>é«˜å¯ç”¨æœºåˆ¶</strong>ï¼›</li>
<li>æ”¯æŒ <strong>æ•°æ®æ‰¹é‡å‘é€</strong> å’Œ <strong>æ‹‰å–</strong>ï¼›</li>
<li>**é›¶æ‹·è´æŠ€æœ¯ (zero-copy)**ï¼šå‡å°‘ <code>IO</code> æ“ä½œæ­¥éª¤ï¼Œæé«˜ <strong>ç³»ç»Ÿååé‡</strong>ï¼›</li>
<li><strong>æ•°æ®è¿ç§»</strong>ã€<strong>æ‰©å®¹</strong> å¯¹ç”¨æˆ·é€æ˜ï¼›</li>
<li><strong>æ— éœ€åœæœº</strong> å³å¯æ‰©å±•æœºå™¨ï¼›</li>
<li><strong>å…¶ä»–ç‰¹æ€§</strong>ï¼šä¸°å¯Œçš„ <strong>æ¶ˆæ¯æ‹‰å–æ¨¡å‹</strong>ã€é«˜æ•ˆ <strong>è®¢é˜…è€…æ°´å¹³æ‰©å±•</strong>ã€å®æ—¶çš„ <strong>æ¶ˆæ¯è®¢é˜…</strong>ã€äº¿çº§çš„ <strong>æ¶ˆæ¯å †ç§¯èƒ½åŠ›</strong>ã€å®šæœŸåˆ é™¤æœºåˆ¶ï¼›</li>
</ol>
<p><strong>(b) éƒ¨ç½²ç¯å¢ƒ</strong></p>
<p>ä½¿ç”¨ <code>Kafka</code> éœ€è¦ï¼š</p>
<ul>
<li><code>Java JDK</code></li>
<li><code>Kafka</code> å®‰è£…åŒ…</li>
</ul>
<p><strong>(c) ä¼˜ç‚¹</strong></p>
<ol>
<li><strong>å®¢æˆ·ç«¯è¯­è¨€ä¸°å¯Œ</strong>ï¼šæ”¯æŒ <code>Java</code>ã€<code>.Net</code>ã€<code>PHP</code>ã€<code>Ruby</code>ã€<code>Python</code>ã€<code>Go</code> ç­‰å¤šç§è¯­è¨€ï¼›</li>
<li><strong>é«˜æ€§èƒ½</strong>ï¼šå•æœºå†™å…¥ <code>TPS</code> çº¦åœ¨ <code>100</code> ä¸‡æ¡&#x2F;ç§’ï¼Œæ¶ˆæ¯å¤§å° <code>10</code> ä¸ªå­—èŠ‚ï¼›</li>
<li>æä¾› <strong>å®Œå…¨åˆ†å¸ƒå¼æ¶æ„</strong>ï¼Œå¹¶æœ‰ <code>replica</code> æœºåˆ¶ï¼Œæ‹¥æœ‰è¾ƒé«˜çš„ <strong>å¯ç”¨æ€§</strong> å’Œ <strong>å¯é æ€§</strong>ï¼Œç†è®ºä¸Šæ”¯æŒ <strong>æ¶ˆæ¯æ— é™å †ç§¯</strong>ï¼›</li>
<li>æ”¯æŒæ‰¹é‡æ“ä½œï¼›</li>
<li><strong>æ¶ˆè´¹è€…</strong> é‡‡ç”¨ <code>Pull</code> æ–¹å¼è·å–æ¶ˆæ¯ã€‚<strong>æ¶ˆæ¯æœ‰åº</strong>ï¼Œ<strong>é€šè¿‡æ§åˆ¶</strong> èƒ½å¤Ÿä¿è¯æ‰€æœ‰æ¶ˆæ¯è¢«æ¶ˆè´¹ä¸”ä»…è¢«æ¶ˆè´¹ <strong>ä¸€æ¬¡</strong>ï¼›</li>
<li>æœ‰ä¼˜ç§€çš„ç¬¬ä¸‰æ–¹ <code>Kafka Web</code> ç®¡ç†ç•Œé¢ <code>Kafka-Manager</code>ï¼›</li>
<li>åœ¨ <strong>æ—¥å¿—é¢†åŸŸ</strong> æ¯”è¾ƒæˆç†Ÿï¼Œè¢«å¤šå®¶å…¬å¸å’Œå¤šä¸ªå¼€æºé¡¹ç›®ä½¿ç”¨ã€‚</li>
</ol>
<p><strong>(d) ç¼ºç‚¹</strong></p>
<ol>
<li><code>Kafka</code> å•æœºè¶…è¿‡ <code>64</code> ä¸ª <strong>é˜Ÿåˆ—&#x2F;åˆ†åŒº</strong> æ—¶ï¼Œ<code>Load</code> æ—¶ä¼šå‘ç”Ÿæ˜æ˜¾çš„é£™é«˜ç°è±¡ã€‚<strong>é˜Ÿåˆ—</strong> è¶Šå¤šï¼Œ<strong>è´Ÿè½½</strong> è¶Šé«˜ï¼Œå‘é€æ¶ˆæ¯ <strong>å“åº”æ—¶é—´å˜é•¿</strong>ï¼›</li>
<li>ä½¿ç”¨ <strong>çŸ­è½®è¯¢æ–¹å¼</strong>ï¼Œ<strong>å®æ—¶æ€§</strong> å–å†³äº <strong>è½®è¯¢é—´éš”æ—¶é—´</strong>ï¼›</li>
<li>æ¶ˆè´¹å¤±è´¥ <strong>ä¸æ”¯æŒé‡è¯•</strong>ï¼›</li>
<li>æ”¯æŒ <strong>æ¶ˆæ¯é¡ºåº</strong>ï¼Œä½†æ˜¯ <strong>ä¸€å°ä»£ç†å®•æœº</strong> åï¼Œå°±ä¼šäº§ç”Ÿ <strong>æ¶ˆæ¯ä¹±åº</strong>ï¼›</li>
<li>ç¤¾åŒºæ›´æ–°è¾ƒæ…¢ã€‚</li>
</ol>
<p>::: info æŠ€æœ¯é€‰å‹</p>
<p>:::</p>
<table>
<thead>
<tr>
<th>ç‰¹æ€§</th>
<th>ActiveMQ</th>
<th>RabbitMQ</th>
<th>RocketMQ</th>
<th>Kafka</th>
</tr>
</thead>
<tbody><tr>
<td>å•æœºååé‡</td>
<td>ä¸‡çº§ï¼Œæ¯” RocketMQã€Kafka ä½ä¸€ä¸ªæ•°é‡çº§</td>
<td>åŒ ActiveMQ</td>
<td>10 ä¸‡çº§ï¼Œæ”¯æ’‘é«˜åå</td>
<td>10 ä¸‡çº§ï¼Œé«˜ååï¼Œä¸€èˆ¬é…åˆå¤§æ•°æ®ç±»çš„ç³»ç»Ÿæ¥è¿›è¡Œå®æ—¶æ•°æ®è®¡ç®—ã€æ—¥å¿—é‡‡é›†ç­‰åœºæ™¯</td>
</tr>
<tr>
<td>topic æ•°é‡å¯¹ååé‡çš„å½±å“</td>
<td></td>
<td></td>
<td>topic å¯ä»¥è¾¾åˆ°å‡ ç™¾&#x2F;å‡ åƒçš„çº§åˆ«ï¼Œååé‡ä¼šæœ‰è¾ƒå°å¹…åº¦çš„ä¸‹é™ï¼Œè¿™æ˜¯ RocketMQ çš„ä¸€å¤§ä¼˜åŠ¿ï¼Œåœ¨åŒç­‰æœºå™¨ä¸‹ï¼Œå¯ä»¥æ”¯æ’‘å¤§é‡çš„ topic</td>
<td>topic ä»å‡ ååˆ°å‡ ç™¾ä¸ªæ—¶å€™ï¼Œååé‡ä¼šå¤§å¹…åº¦ä¸‹é™ï¼Œåœ¨åŒç­‰æœºå™¨ä¸‹ï¼ŒKafka å°½é‡ä¿è¯ topic æ•°é‡ä¸è¦è¿‡å¤šï¼Œå¦‚æœè¦æ”¯æ’‘å¤§è§„æ¨¡çš„ topicï¼Œéœ€è¦å¢åŠ æ›´å¤šçš„æœºå™¨èµ„æº</td>
</tr>
<tr>
<td>æ—¶æ•ˆæ€§</td>
<td>ms çº§</td>
<td>å¾®ç§’çº§ï¼Œè¿™æ˜¯ RabbitMQ çš„ä¸€å¤§ç‰¹ç‚¹ï¼Œå»¶è¿Ÿæœ€ä½</td>
<td>ms çº§</td>
<td>å»¶è¿Ÿåœ¨ ms çº§ä»¥å†…</td>
</tr>
<tr>
<td>å¯ç”¨æ€§</td>
<td>é«˜ï¼ŒåŸºäºä¸»ä»æ¶æ„å®ç°é«˜å¯ç”¨</td>
<td>åŒ ActiveMQ</td>
<td>éå¸¸é«˜ï¼Œåˆ†å¸ƒå¼æ¶æ„</td>
<td>éå¸¸é«˜ï¼Œåˆ†å¸ƒå¼ï¼Œä¸€ä¸ªæ•°æ®å¤šä¸ªå‰¯æœ¬ï¼Œå°‘æ•°æœºå™¨å®•æœºï¼Œä¸ä¼šä¸¢å¤±æ•°æ®ï¼Œä¸ä¼šå¯¼è‡´ä¸å¯ç”¨</td>
</tr>
<tr>
<td>æ¶ˆæ¯å¯é æ€§</td>
<td>æœ‰è¾ƒä½çš„æ¦‚ç‡ä¸¢å¤±æ•°æ®</td>
<td>åŸºæœ¬ä¸ä¸¢</td>
<td>ç»è¿‡å‚æ•°ä¼˜åŒ–é…ç½®ï¼Œå¯ä»¥åšåˆ° 0 ä¸¢å¤±</td>
<td>åŒ RocketMQ</td>
</tr>
<tr>
<td>åŠŸèƒ½æ”¯æŒ</td>
<td>MQ é¢†åŸŸçš„åŠŸèƒ½æå…¶å®Œå¤‡</td>
<td>åŸºäº erlang å¼€å‘ï¼Œå¹¶å‘èƒ½åŠ›å¾ˆå¼ºï¼Œæ€§èƒ½æå¥½ï¼Œå»¶æ—¶å¾ˆä½</td>
<td>MQ åŠŸèƒ½è¾ƒä¸ºå®Œå–„ï¼Œè¿˜æ˜¯åˆ†å¸ƒå¼çš„ï¼Œæ‰©å±•æ€§å¥½</td>
<td>åŠŸèƒ½è¾ƒä¸ºç®€å•ï¼Œä¸»è¦æ”¯æŒç®€å•çš„ MQ åŠŸèƒ½ï¼Œåœ¨å¤§æ•°æ®é¢†åŸŸçš„å®æ—¶è®¡ç®—ä»¥åŠæ—¥å¿—é‡‡é›†è¢«å¤§è§„æ¨¡ä½¿ç”¨</td>
</tr>
</tbody></table>
<p>ç»¼ä¸Šï¼Œå„ç§å¯¹æ¯”ä¹‹åï¼Œæœ‰å¦‚ä¸‹å»ºè®®ï¼š</p>
<ul>
<li>ä¸€èˆ¬çš„ä¸šåŠ¡ç³»ç»Ÿè¦å¼•å…¥ MQï¼Œæœ€æ—©å¤§å®¶éƒ½ç”¨ ActiveMQï¼Œä½†æ˜¯ç°åœ¨ç¡®å®å¤§å®¶ç”¨çš„ä¸å¤šäº†ï¼Œæ²¡ç»è¿‡å¤§è§„æ¨¡ååé‡åœºæ™¯çš„éªŒè¯ï¼Œç¤¾åŒºä¹Ÿä¸æ˜¯å¾ˆæ´»è·ƒï¼Œæ‰€ä»¥å¤§å®¶è¿˜æ˜¯ç®—äº†å§ï¼Œæˆ‘ä¸ªäººä¸æ¨èç”¨è¿™ä¸ªäº†ï¼›</li>
<li>åæ¥å¤§å®¶å¼€å§‹ç”¨ RabbitMQï¼Œä½†æ˜¯ç¡®å® erlang è¯­è¨€é˜»æ­¢äº†å¤§é‡çš„ Java å·¥ç¨‹å¸ˆå»æ·±å…¥ç ”ç©¶å’ŒæŒæ§å®ƒï¼Œå¯¹å…¬å¸è€Œè¨€ï¼Œå‡ ä¹å¤„äºä¸å¯æ§çš„çŠ¶æ€ï¼Œä½†æ˜¯ç¡®å®äººå®¶æ˜¯å¼€æºçš„ï¼Œæ¯”è¾ƒç¨³å®šçš„æ”¯æŒï¼Œæ´»è·ƒåº¦ä¹Ÿé«˜ï¼›</li>
<li>ä¸è¿‡ç°åœ¨ç¡®å®è¶Šæ¥è¶Šå¤šçš„å…¬å¸ä¼šå»ç”¨ RocketMQï¼Œç¡®å®å¾ˆä¸é”™ï¼Œæ¯•ç«Ÿæ˜¯é˜¿é‡Œå‡ºå“ï¼Œä½†ç¤¾åŒºå¯èƒ½æœ‰çªç„¶é»„æ‰çš„é£é™©ï¼ˆç›®å‰ RocketMQ å·²æç»™ <a target="_blank" rel="noopener" href="https://github.com/apache/rocketmq">Apache</a>ï¼Œä½† GitHub ä¸Šçš„æ´»è·ƒåº¦å…¶å®ä¸ç®—é«˜ï¼‰å¯¹è‡ªå·±å…¬å¸æŠ€æœ¯å®åŠ›æœ‰ç»å¯¹è‡ªä¿¡çš„ï¼Œæ¨èç”¨ RocketMQï¼Œå¦åˆ™å›å»è€è€å®å®ç”¨ RabbitMQ å§ï¼Œäººå®¶æœ‰æ´»è·ƒçš„å¼€æºç¤¾åŒºï¼Œç»å¯¹ä¸ä¼šé»„ã€‚</li>
<li>æ‰€ä»¥<strong>ä¸­å°å‹å…¬å¸</strong>ï¼ŒæŠ€æœ¯å®åŠ›è¾ƒä¸ºä¸€èˆ¬ï¼ŒæŠ€æœ¯æŒ‘æˆ˜ä¸æ˜¯ç‰¹åˆ«é«˜ï¼Œç”¨ RabbitMQ æ˜¯ä¸é”™çš„é€‰æ‹©ï¼›<strong>å¤§å‹å…¬å¸</strong>ï¼ŒåŸºç¡€æ¶æ„ç ”å‘å®åŠ›è¾ƒå¼ºï¼Œç”¨ RocketMQ æ˜¯å¾ˆå¥½çš„é€‰æ‹©ã€‚</li>
<li>å¦‚æœæ˜¯<strong>å¤§æ•°æ®é¢†åŸŸ</strong>çš„å®æ—¶è®¡ç®—ã€æ—¥å¿—é‡‡é›†ç­‰åœºæ™¯ï¼Œç”¨ Kafka æ˜¯ä¸šå†…æ ‡å‡†çš„ï¼Œç»å¯¹æ²¡é—®é¢˜ï¼Œç¤¾åŒºæ´»è·ƒåº¦å¾ˆé«˜ï¼Œç»å¯¹ä¸ä¼šé»„ï¼Œä½•å†µå‡ ä¹æ˜¯å…¨ä¸–ç•Œè¿™ä¸ªé¢†åŸŸçš„äº‹å®æ€§è§„èŒƒã€‚</li>
</ul>
<h3 id="ã€å›°éš¾ã€‘ä»€ä¹ˆæ˜¯-JMSï¼Ÿ"><a href="#ã€å›°éš¾ã€‘ä»€ä¹ˆæ˜¯-JMSï¼Ÿ" class="headerlink" title="ã€å›°éš¾ã€‘ä»€ä¹ˆæ˜¯ JMSï¼Ÿ"></a>ã€å›°éš¾ã€‘ä»€ä¹ˆæ˜¯ JMSï¼Ÿ</h3><p>æåˆ° MQï¼Œå°±é¡ºä¾¿æä¸€ä¸‹ JMS ã€‚</p>
<p><strong>JMSï¼ˆJAVA Message Serviceï¼Œjava æ¶ˆæ¯æœåŠ¡ï¼‰API æ˜¯ä¸€ä¸ªæ¶ˆæ¯æœåŠ¡çš„æ ‡å‡†&#x2F;è§„èŒƒï¼Œå…è®¸åº”ç”¨ç¨‹åºç»„ä»¶åŸºäº JavaEE å¹³å°åˆ›å»ºã€å‘é€ã€æ¥æ”¶å’Œè¯»å–æ¶ˆæ¯</strong>ã€‚å®ƒä½¿åˆ†å¸ƒå¼é€šä¿¡è€¦åˆåº¦æ›´ä½ï¼Œæ¶ˆæ¯æœåŠ¡æ›´åŠ å¯é ä»¥åŠå¼‚æ­¥æ€§ã€‚</p>
<p>åœ¨ EJB æ¶æ„ä¸­ï¼Œæœ‰æ¶ˆæ¯ bean å¯ä»¥æ— ç¼çš„ä¸ JMS æ¶ˆæ¯æœåŠ¡é›†æˆã€‚åœ¨ J2EE æ¶æ„æ¨¡å¼ä¸­ï¼Œæœ‰æ¶ˆæ¯æœåŠ¡è€…æ¨¡å¼ï¼Œç”¨äºå®ç°æ¶ˆæ¯ä¸åº”ç”¨ç›´æ¥çš„è§£è€¦ã€‚</p>
<p>::: info JMS æ¶ˆæ¯æ¨¡å‹</p>
<p>:::</p>
<p>åœ¨ JMS æ ‡å‡†ä¸­ï¼Œæœ‰ä¸¤ç§æ¶ˆæ¯æ¨¡å‹ï¼š</p>
<ul>
<li>P2P(Point to Point)</li>
<li>Pub&#x2F;Sub(Publish&#x2F;Subscribe)</li>
</ul>
<p><strong>P2P æ¨¡å¼</strong></p>
<p><img src="http://upload-images.jianshu.io/upload_images/3101171-2adc66e2367cd2c2.png"></p>
<p>P2P æ¨¡å¼åŒ…å«ä¸‰ä¸ªè§’è‰²ï¼šMQï¼ˆQueueï¼‰ï¼Œå‘é€è€… (Sender)ï¼Œæ¥æ”¶è€… (Receiver)ã€‚æ¯ä¸ªæ¶ˆæ¯éƒ½è¢«å‘é€åˆ°ä¸€ä¸ªç‰¹å®šçš„é˜Ÿåˆ—ï¼Œæ¥æ”¶è€…ä»é˜Ÿåˆ—ä¸­è·å–æ¶ˆæ¯ã€‚é˜Ÿåˆ—ä¿ç•™ç€æ¶ˆæ¯ï¼Œç›´åˆ°ä»–ä»¬è¢«æ¶ˆè´¹æˆ–è¶…æ—¶ã€‚</p>
<p>P2P çš„ç‰¹ç‚¹</p>
<ul>
<li>æ¯ä¸ªæ¶ˆæ¯åªæœ‰ä¸€ä¸ªæ¶ˆè´¹è€…ï¼ˆConsumerï¼‰ï¼ˆå³ä¸€æ—¦è¢«æ¶ˆè´¹ï¼Œæ¶ˆæ¯å°±ä¸å†åœ¨ MQ ä¸­ï¼‰</li>
<li>å‘é€è€…å’Œæ¥æ”¶è€…ä¹‹é—´åœ¨æ—¶é—´ä¸Šæ²¡æœ‰ä¾èµ–æ€§ï¼Œä¹Ÿå°±æ˜¯è¯´å½“å‘é€è€…å‘é€äº†æ¶ˆæ¯ä¹‹åï¼Œä¸ç®¡æ¥æ”¶è€…æœ‰æ²¡æœ‰æ­£åœ¨è¿è¡Œï¼Œå®ƒä¸ä¼šå½±å“åˆ°æ¶ˆæ¯è¢«å‘é€åˆ°é˜Ÿåˆ—</li>
<li>æ¥æ”¶è€…åœ¨æˆåŠŸæ¥æ”¶æ¶ˆæ¯ä¹‹åéœ€å‘é˜Ÿåˆ—åº”ç­”æˆåŠŸ</li>
</ul>
<p>å¦‚æœå¸Œæœ›å‘é€çš„æ¯ä¸ªæ¶ˆæ¯éƒ½ä¼šè¢«æˆåŠŸå¤„ç†çš„è¯ï¼Œé‚£ä¹ˆéœ€è¦ P2P æ¨¡å¼ã€‚</p>
<p><strong>Pub&#x2F;sub æ¨¡å¼</strong></p>
<p><img src="http://upload-images.jianshu.io/upload_images/3101171-12afe9581da889ea.png"></p>
<p>åŒ…å«ä¸‰ä¸ªè§’è‰²ä¸»é¢˜ï¼ˆTopicï¼‰ï¼Œå‘å¸ƒè€…ï¼ˆPublisherï¼‰ï¼Œè®¢é˜…è€…ï¼ˆSubscriberï¼‰ ã€‚å¤šä¸ªå‘å¸ƒè€…å°†æ¶ˆæ¯å‘é€åˆ° Topic, ç³»ç»Ÿå°†è¿™äº›æ¶ˆæ¯ä¼ é€’ç»™å¤šä¸ªè®¢é˜…è€…ã€‚</p>
<p>Pub&#x2F;Sub çš„ç‰¹ç‚¹</p>
<ul>
<li>æ¯ä¸ªæ¶ˆæ¯å¯ä»¥æœ‰å¤šä¸ªæ¶ˆè´¹è€…</li>
<li>å‘å¸ƒè€…å’Œè®¢é˜…è€…ä¹‹é—´æœ‰æ—¶é—´ä¸Šçš„ä¾èµ–æ€§ã€‚é’ˆå¯¹æŸä¸ªä¸»é¢˜ï¼ˆTopicï¼‰çš„è®¢é˜…è€…ï¼Œå®ƒå¿…é¡»åˆ›å»ºä¸€ä¸ªè®¢é˜…è€…ä¹‹åï¼Œæ‰èƒ½æ¶ˆè´¹å‘å¸ƒè€…çš„æ¶ˆæ¯ã€‚</li>
<li>ä¸ºäº†æ¶ˆè´¹æ¶ˆæ¯ï¼Œè®¢é˜…è€…å¿…é¡»ä¿æŒè¿è¡Œçš„çŠ¶æ€ã€‚</li>
</ul>
<p>ä¸ºäº†ç¼“å’Œè¿™æ ·ä¸¥æ ¼çš„æ—¶é—´ç›¸å…³æ€§ï¼ŒJMS å…è®¸è®¢é˜…è€…åˆ›å»ºä¸€ä¸ªå¯æŒä¹…åŒ–çš„è®¢é˜…ã€‚è¿™æ ·ï¼Œå³ä½¿è®¢é˜…è€…æ²¡æœ‰è¢«æ¿€æ´»ï¼ˆè¿è¡Œï¼‰ï¼Œå®ƒä¹Ÿèƒ½æ¥æ”¶åˆ°å‘å¸ƒè€…çš„æ¶ˆæ¯ã€‚</p>
<p>å¦‚æœå¸Œæœ›å‘é€çš„æ¶ˆæ¯å¯ä»¥ä¸è¢«åšä»»ä½•å¤„ç†ã€æˆ–è€…åªè¢«ä¸€ä¸ªæ¶ˆæ¯è€…å¤„ç†ã€æˆ–è€…å¯ä»¥è¢«å¤šä¸ªæ¶ˆè´¹è€…å¤„ç†çš„è¯ï¼Œé‚£ä¹ˆå¯ä»¥é‡‡ç”¨ Pub&#x2F;Sub æ¨¡å‹ã€‚</p>
<p>::: info JMS æ¶ˆæ¯æ¶ˆè´¹</p>
<p>:::</p>
<p>åœ¨ JMS ä¸­ï¼Œæ¶ˆæ¯çš„äº§ç”Ÿå’Œæ¶ˆè´¹éƒ½æ˜¯å¼‚æ­¥çš„ã€‚å¯¹äºæ¶ˆè´¹æ¥è¯´ï¼ŒJMS çš„æ¶ˆæ¯è€…å¯ä»¥é€šè¿‡ä¸¤ç§æ–¹å¼æ¥æ¶ˆè´¹æ¶ˆæ¯ã€‚</p>
<ul>
<li><strong>åŒæ­¥</strong> - è®¢é˜…è€…æˆ–æ¥æ”¶è€…é€šè¿‡ <code>receive</code> æ–¹æ³•æ¥æ¥æ”¶æ¶ˆæ¯ï¼Œ<code>receive</code> æ–¹æ³•åœ¨æ¥æ”¶åˆ°æ¶ˆæ¯ä¹‹å‰ï¼ˆæˆ–è¶…æ—¶ä¹‹å‰ï¼‰å°†ä¸€ç›´é˜»å¡ï¼›</li>
<li><strong>å¼‚æ­¥</strong> - è®¢é˜…è€…æˆ–æ¥æ”¶è€…å¯ä»¥æ³¨å†Œä¸ºä¸€ä¸ªæ¶ˆæ¯ç›‘å¬å™¨ã€‚å½“æ¶ˆæ¯åˆ°è¾¾ä¹‹åï¼Œç³»ç»Ÿè‡ªåŠ¨è°ƒç”¨ç›‘å¬å™¨çš„ <code>onMessage</code> æ–¹æ³•ã€‚</li>
</ul>
<p><code>JNDI</code> - Java å‘½åå’Œç›®å½•æ¥å£ï¼Œæ˜¯ä¸€ç§æ ‡å‡†çš„ Java å‘½åç³»ç»Ÿæ¥å£ã€‚å¯ä»¥åœ¨ç½‘ç»œä¸ŠæŸ¥æ‰¾å’Œè®¿é—®æœåŠ¡ã€‚é€šè¿‡æŒ‡å®šä¸€ä¸ªèµ„æºåç§°ï¼Œè¯¥åç§°å¯¹åº”äºæ•°æ®åº“æˆ–å‘½åæœåŠ¡ä¸­çš„ä¸€ä¸ªè®°å½•ï¼ŒåŒæ—¶è¿”å›èµ„æºè¿æ¥å»ºç«‹æ‰€å¿…é¡»çš„ä¿¡æ¯ã€‚</p>
<p>JNDI åœ¨ JMS ä¸­èµ·åˆ°æŸ¥æ‰¾å’Œè®¿é—®å‘é€ç›®æ ‡æˆ–æ¶ˆæ¯æ¥æºçš„ä½œç”¨ã€‚</p>
<h3 id="ã€ä¸­ç­‰ã€‘ä»€ä¹ˆæ˜¯-AMQPï¼Ÿ"><a href="#ã€ä¸­ç­‰ã€‘ä»€ä¹ˆæ˜¯-AMQPï¼Ÿ" class="headerlink" title="ã€ä¸­ç­‰ã€‘ä»€ä¹ˆæ˜¯ AMQPï¼Ÿ"></a>ã€ä¸­ç­‰ã€‘ä»€ä¹ˆæ˜¯ AMQPï¼Ÿ</h3><p>AMQPï¼ˆAdvanced Message Queuing Protocolï¼‰æ˜¯ä¸€ç§åº”ç”¨å±‚åè®®ï¼Œ<strong>ç”¨äºåœ¨æ¶ˆæ¯é˜Ÿåˆ—ç³»ç»Ÿä¸­å®šä¹‰æ¶ˆæ¯çš„æ ¼å¼ã€ä¼ è¾“æ–¹å¼å’Œå¤„ç†æœºåˆ¶</strong>ã€‚</p>
<p>AMQP æ˜¯ä¸€ä¸ª<strong>é¢å‘æ¶ˆæ¯çš„</strong>ã€<strong>å¼‚æ­¥ä¼ è¾“</strong>çš„åè®®ï¼Œå…·æœ‰é«˜å¯é æ€§ã€å¯æ‹“å±•æ€§ã€è·¨å¹³å°çš„ç‰¹æ€§ï¼Œé€‚åˆåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ä¼ è¾“é‡è¦æ•°æ®ã€‚å®ƒæ˜¯ RabbitMQã€ActiveMQ ç­‰æ¶ˆæ¯ä¸­é—´ä»¶çš„åº•å±‚åè®®ã€‚</p>
<p><strong>æ ¸å¿ƒç»„ä»¶</strong></p>
<table>
<thead>
<tr>
<th><strong>ç»„ä»¶</strong></th>
<th><strong>ä½œç”¨</strong></th>
</tr>
</thead>
<tbody><tr>
<td><strong>Connection</strong></td>
<td>å®¢æˆ·ç«¯ä¸æ¶ˆæ¯ä»£ç†ï¼ˆå¦‚ RabbitMQï¼‰çš„ç‰©ç†è¿æ¥</td>
</tr>
<tr>
<td><strong>Channel</strong></td>
<td>é€»è¾‘é€šä¿¡é“¾è·¯ï¼ˆå¤šè·¯å¤ç”¨è¿æ¥ï¼Œå‡å°‘å¼€é”€ï¼‰</td>
</tr>
<tr>
<td><strong>Exchange</strong></td>
<td>æ¶ˆæ¯è·¯ç”±æ¢çº½ï¼ˆæ”¯æŒå¤šç§è·¯ç”±ç­–ç•¥ï¼‰</td>
</tr>
<tr>
<td><strong>Queue</strong></td>
<td>å­˜å‚¨æ¶ˆæ¯çš„å®¹å™¨ï¼Œæ¶ˆè´¹è€…ä»ä¸­æ‹‰å–æ•°æ®</td>
</tr>
<tr>
<td><strong>Binding</strong></td>
<td>å®šä¹‰ Exchange ä¸ Queue çš„æ˜ å°„å…³ç³»ï¼ˆå«è·¯ç”±è§„åˆ™ï¼‰</td>
</tr>
</tbody></table>
<p><strong>è·¯ç”±æ¨¡å‹</strong></p>
<ul>
<li><strong>Direct</strong>ï¼šç²¾ç¡®åŒ¹é…è·¯ç”±é”®ï¼ˆå¦‚ <code>order.create</code>ï¼‰</li>
<li><strong>Fanout</strong>ï¼šå¹¿æ’­åˆ°æ‰€æœ‰ç»‘å®šé˜Ÿåˆ—ï¼ˆæ— è§†è·¯ç”±é”®ï¼‰</li>
<li><strong>Topic</strong>ï¼šé€šé…ç¬¦åŒ¹é…ï¼ˆå¦‚ <code>order.*</code>ï¼‰</li>
<li><strong>Headers</strong>ï¼šåŸºäºæ¶ˆæ¯å¤´é”®å€¼åŒ¹é…ï¼ˆéè·¯ç”±é”®ï¼‰</li>
</ul>
<p><strong>å¯é æ€§ä¿éšœ</strong></p>
<ul>
<li><strong>æ¶ˆæ¯ç¡®è®¤</strong>ï¼šæ¶ˆè´¹è€…æ‰‹åŠ¨ç¡®è®¤ï¼Œå¤±è´¥åˆ™é‡å…¥é˜Ÿåˆ—</li>
<li><strong>æŒä¹…åŒ–</strong>ï¼šé˜Ÿåˆ—&#x2F;æ¶ˆæ¯æŒä¹…åŒ–é˜²ä¸¢å¤±</li>
<li><strong>äº‹åŠ¡</strong>ï¼šæ”¯æŒåŸå­æ€§æäº¤&#x2F;å›æ»šï¼ˆæ‰¹é‡æ“ä½œï¼‰</li>
</ul>
<p><strong>åè®®å¯¹æ¯”</strong></p>
<table>
<thead>
<tr>
<th><strong>åè®®</strong></th>
<th><strong>ä¼˜åŠ¿åœºæ™¯</strong></th>
<th><strong>å±€é™æ€§</strong></th>
</tr>
</thead>
<tbody><tr>
<td><strong>AMQP</strong></td>
<td>ä¼ä¸šçº§åº”ç”¨ï¼ˆå¼ºäº‹åŠ¡ã€é«˜å¯é ï¼‰</td>
<td>ç•¥é‡ï¼ˆä¸é€‚åˆ IoT è½»é‡åœºæ™¯ï¼‰</td>
</tr>
<tr>
<td><strong>MQTT</strong></td>
<td>ç‰©è”ç½‘ï¼ˆä½åŠŸè€—ã€ä½å¸¦å®½ï¼‰</td>
<td>åŠŸèƒ½ç®€å•ï¼ˆæ— å¤æ‚è·¯ç”±ï¼‰</td>
</tr>
<tr>
<td><strong>JMS</strong></td>
<td>Java ç”Ÿæ€é›†æˆ</td>
<td>ä»…é™ Javaï¼Œè·¨å¹³å°æ€§å¼±</td>
</tr>
</tbody></table>
<h2 id="Kafka"><a href="#Kafka" class="headerlink" title="Kafka"></a>Kafka</h2><h3 id="ã€å›°éš¾ã€‘Kafka-ä¸ºä»€ä¹ˆæ€§èƒ½é«˜ï¼Ÿ"><a href="#ã€å›°éš¾ã€‘Kafka-ä¸ºä»€ä¹ˆæ€§èƒ½é«˜ï¼Ÿ" class="headerlink" title="ã€å›°éš¾ã€‘Kafka ä¸ºä»€ä¹ˆæ€§èƒ½é«˜ï¼Ÿ"></a>ã€å›°éš¾ã€‘Kafka ä¸ºä»€ä¹ˆæ€§èƒ½é«˜ï¼Ÿ</h3><p>Kafka çš„æ•°æ®å­˜å‚¨åœ¨ç£ç›˜ä¸Šï¼Œä¸ºä»€ä¹ˆè¿˜èƒ½è¿™ä¹ˆå¿«ï¼Ÿ</p>
<p>è¯´ Kafka å¾ˆå¿«æ—¶ï¼Œä»–ä»¬é€šå¸¸æŒ‡çš„æ˜¯ Kafka é«˜æ•ˆç§»åŠ¨å¤§é‡æ•°æ®çš„èƒ½åŠ›ã€‚Kafka ä¸ºäº†æé«˜ä¼ è¾“æ•ˆç‡ï¼Œåšäº†å¾ˆå¤šç²¾å¦™çš„è®¾è®¡ã€‚</p>
<p>::: info é¡ºåº I&#x2F;Oï¼ˆè¿½åŠ å†™å…¥ï¼‰</p>
<p>:::</p>
<p>ç£ç›˜è¯»å†™æœ‰ä¸¤ç§æ–¹å¼ï¼šé¡ºåºè¯»å†™æˆ–è€…éšæœºè¯»å†™ã€‚åœ¨é¡ºåºè¯»å†™çš„æƒ…å†µä¸‹ï¼Œç£ç›˜çš„é¡ºåºè¯»å†™é€Ÿåº¦å’Œå†…å­˜æ¥è¿‘ã€‚å› ä¸ºç£ç›˜æ˜¯æœºæ¢°ç»“æ„ï¼Œæ¯æ¬¡è¯»å†™éƒ½ä¼šå¯»å€å†™å…¥ï¼Œå…¶ä¸­å¯»å€æ˜¯ä¸€ä¸ªâ€œæœºæ¢°åŠ¨ä½œâ€ã€‚Kafka åˆ©ç”¨äº†ä¸€ç§åˆ†æ®µå¼çš„ã€åªè¿½åŠ  (Append-Only) çš„æ—¥å¿—ï¼ŒåŸºæœ¬ä¸ŠæŠŠè‡ªèº«çš„è¯»å†™æ“ä½œé™åˆ¶ä¸º<strong>é¡ºåº I&#x2F;O</strong>ï¼Œä¹Ÿå°±ä½¿å¾—å®ƒåœ¨å„ç§å­˜å‚¨ä»‹è´¨ä¸Šèƒ½æœ‰å¾ˆå¿«çš„é€Ÿåº¦ã€‚</p>
<p>::: info é›¶æ‹·è´</p>
<p>:::</p>
<p>Kafka æ•°æ®ä¼ è¾“æ˜¯ä¸€ä¸ªä»ç½‘ç»œåˆ°ç£ç›˜ï¼Œå†ç”±ç£ç›˜åˆ°ç½‘ç»œçš„è¿‡ç¨‹ã€‚åœ¨ç½‘ç»œå’Œç£ç›˜ä¹‹é—´ä¼ è¾“æ•°æ®æ—¶ï¼Œæ¶ˆé™¤å¤šä½™çš„å¤åˆ¶æ˜¯æé«˜æ•ˆç‡çš„å…³é”®ã€‚<strong>Kafka åˆ©ç”¨é›¶æ‹·è´æŠ€æœ¯æ¥æ¶ˆé™¤ä¼ è¾“è¿‡ç¨‹ä¸­çš„å¤šä½™å¤åˆ¶</strong>ã€‚</p>
<p>å¦‚æœä¸é‡‡ç”¨é›¶æ‹·è´ï¼ŒKafka å°†æ•°æ®åŒæ­¥ç»™æ¶ˆè´¹è€…çš„å¤§è‡´æµç¨‹æ˜¯ï¼š</p>
<ol>
<li>ä»ç£ç›˜åŠ è½½æ•°æ®åˆ° os buffer</li>
<li>æ‹·è´æ•°æ®åˆ° app buffer</li>
<li>å†æ‹·è´æ•°æ®åˆ° socket buffer</li>
<li>æ¥ä¸‹æ¥ï¼Œå°†æ•°æ®æ‹·è´åˆ°ç½‘å¡ buffer</li>
<li>æœ€åï¼Œé€šè¿‡ç½‘ç»œä¼ è¾“ï¼Œå°†æ•°æ®å‘é€åˆ°æ¶ˆè´¹è€…</li>
</ol>
<p>é‡‡ç”¨é›¶æ‹·è´æŠ€æœ¯ï¼ŒKafka ä½¿ç”¨ <code>sendfile()</code> ç³»ç»Ÿæ–¹æ³•ï¼Œå°†æ•°æ®ä» os buffer ç›´æ¥å¤åˆ¶åˆ°ç½‘å¡ bufferã€‚è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œå”¯ä¸€ä¸€æ¬¡å¤åˆ¶æ•°æ®æ˜¯ä» os buffer åˆ°ç½‘å¡ bufferã€‚è¿™ä¸ªå¤åˆ¶è¿‡ç¨‹æ˜¯é€šè¿‡ DMAï¼ˆDirect Memory Accessï¼Œç›´æ¥å†…å­˜è®¿é—®ï¼‰ å®Œæˆçš„ã€‚ä½¿ç”¨ DMA æ—¶ï¼ŒCPU ä¸å‚ä¸ï¼Œè¿™ä½¿å¾—å®ƒéå¸¸é«˜æ•ˆã€‚</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/202502070727055.webp"></p>
<p>::: info å…¶ä»–æ€§èƒ½è®¾è®¡</p>
<p>:::</p>
<ul>
<li><strong>é¡µç¼“å­˜</strong> - Kafka çš„æ•°æ®å¹¶ä¸æ˜¯å®æ—¶çš„å†™å…¥ç£ç›˜ï¼Œå®ƒå……åˆ†åˆ©ç”¨äº†ç°ä»£æ“ä½œç³»ç»Ÿåˆ†é¡µå­˜å‚¨æ¥åˆ©ç”¨å†…å­˜æé«˜ I&#x2F;O æ•ˆç‡ã€‚å…·ä½“æ¥è¯´ï¼Œå°±æ˜¯æŠŠç£ç›˜ä¸­çš„æ•°æ®ç¼“å­˜åˆ°å†…å­˜ä¸­ï¼ŒæŠŠå¯¹ç£ç›˜çš„è®¿é—®å˜ä¸ºå¯¹å†…å­˜çš„è®¿é—®ã€‚Kafka æ¥æ”¶æ¥è‡ª socket buffer çš„ç½‘ç»œæ•°æ®ï¼Œåº”ç”¨è¿›ç¨‹ä¸éœ€è¦ä¸­é—´å¤„ç†ã€ç›´æ¥è¿›è¡ŒæŒä¹…åŒ–æ—¶ã€‚å¯ä»¥ä½¿ç”¨ mmap å†…å­˜æ–‡ä»¶æ˜ å°„ã€‚</li>
<li><strong>å‹ç¼©</strong> - Kafka å†…ç½®äº†å‡ ç§å‹ç¼©ç®—æ³•ï¼Œå¹¶å…è®¸å®šåˆ¶åŒ–å‹ç¼©ç®—æ³•ã€‚é€šè¿‡å‹ç¼©ç®—æ³•ï¼Œå¯ä»¥æœ‰æ•ˆå‡å°‘ä¼ è¾“æ•°æ®çš„å¤§å°ï¼Œä»è€Œæå‡ä¼ è¾“æ•ˆç‡ã€‚</li>
<li><strong>æ‰¹å¤„ç†</strong> - Kafka çš„ Clients å’Œ Brokers ä¼šæŠŠå¤šæ¡è¯»å†™çš„æ—¥å¿—è®°å½•åˆå¹¶æˆä¸€ä¸ªæ‰¹æ¬¡ï¼Œç„¶åæ‰é€šè¿‡ç½‘ç»œå‘é€å‡ºå»ã€‚æ—¥å¿—è®°å½•çš„æ‰¹å¤„ç†é€šè¿‡ä½¿ç”¨æ›´å¤§çš„åŒ…ä»¥åŠæé«˜å¸¦å®½æ•ˆç‡æ¥æ‘Šè–„ç½‘ç»œå¾€è¿”çš„å¼€é”€ã€‚</li>
<li><strong>åˆ†åŒº</strong> - Kafka å°† Topic åˆ†åŒºï¼Œæ¯ä¸ªåˆ†åŒºå¯¹åº”ä¸€ä¸ªåä¸ºçš„ Log çš„ç£ç›˜ç›®å½•ï¼Œè€Œ Log åˆæ ¹æ®å¤§å°ï¼Œå¯ä»¥åˆ†ä¸ºå¤šä¸ª Log Segment æ–‡ä»¶ã€‚è¿™ç§åˆ†è€Œæ²»ä¹‹çš„ç­–ç•¥ï¼Œä½¿å¾— Kafka å¯ä»¥<strong>å¹¶å‘</strong>è¯»ï¼Œä»¥æ”¯æ’‘éå¸¸é«˜çš„ååé‡ã€‚æ­¤å¤–ï¼ŒKafka æ”¯æŒè´Ÿè½½å‡è¡¡æœºåˆ¶ï¼Œå°†æ•°æ®åˆ†åŒºè¿‘ä¼¼å‡åŒ€åœ°åˆ†é…ç»™æ¶ˆè´¹è€…ç¾¤ç»„çš„å„ä¸ªæ¶ˆè´¹è€…ã€‚</li>
</ul>
<h3 id="ã€å›°éš¾ã€‘ZooKeeper-åœ¨-Kafka-ä¸­çš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#ã€å›°éš¾ã€‘ZooKeeper-åœ¨-Kafka-ä¸­çš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="ã€å›°éš¾ã€‘ZooKeeper åœ¨ Kafka ä¸­çš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ"></a>ã€å›°éš¾ã€‘ZooKeeper åœ¨ Kafka ä¸­çš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ</h3><p>ZooKeeper åœ¨ Kafka ä¸­æ‰®æ¼”ç€<strong>æ ¸å¿ƒçš„åè°ƒè€…è§’è‰²</strong>ï¼Œä¸»è¦è´Ÿè´£é›†ç¾¤çš„å…ƒæ•°æ®ç®¡ç†ã€Broker åè°ƒå’ŒçŠ¶æ€ç»´æŠ¤ã€‚è¿™äº›ç®¡ç†æœºåˆ¶å¯ä»¥ç¡®ä¿é›†ç¾¤ä¸€è‡´æ€§ã€é«˜å¯ç”¨æ€§å’Œåè°ƒèƒ½åŠ›ã€‚</p>
<p><strong>Broker ç®¡ç†</strong></p>
<ul>
<li><strong>èŠ‚ç‚¹æ³¨å†Œä¸å­˜æ´»ç›‘æ§</strong>ï¼šæ¯ä¸ª Kafka Broker å¯åŠ¨æ—¶ä¼šåœ¨ ZooKeeper ä¸­æ³¨å†Œä¸´æ—¶èŠ‚ç‚¹ï¼ˆ<code>/brokers/ids</code>ï¼‰ã€‚ZooKeeper é€šè¿‡å¿ƒè·³æœºåˆ¶ç›‘æ§ Broker å­˜æ´»çŠ¶æ€ï¼Œè‹¥ Broker å®•æœºï¼Œä¸´æ—¶èŠ‚ç‚¹æ¶ˆå¤±ï¼Œé›†ç¾¤ä¼šè§¦å‘é‡æ–°é€‰ä¸¾æˆ–åˆ†åŒºé‡æ–°åˆ†é…ã€‚</li>
<li><strong>Leader é€‰ä¸¾</strong>ï¼šKafka åˆ†åŒºçš„ Leader å‰¯æœ¬é€‰ä¸¾ç”± ZooKeeper åè°ƒå®Œæˆï¼ˆæ—§ç‰ˆæœ¬ä¾èµ– ZooKeeperï¼Œæ–°ç‰ˆæœ¬å·²é€æ­¥è¿ç§»è‡³ Kafka è‡ªèº«åè®®ï¼‰ã€‚</li>
</ul>
<p><strong>Topic ä¸åˆ†åŒºå…ƒæ•°æ®</strong></p>
<ul>
<li><strong>å­˜å‚¨æ‹“æ‰‘ä¿¡æ¯</strong>ï¼šTopic çš„åˆ†åŒºæ•°é‡ã€å‰¯æœ¬åˆ†å¸ƒï¼ˆ<code>/brokers/topics/[topic]</code>ï¼‰ç­‰å…ƒæ•°æ®ç”± ZooKeeper ç»´æŠ¤ï¼Œä¾›æ‰€æœ‰ Broker å’Œå®¢æˆ·ç«¯æŸ¥è¯¢ã€‚</li>
<li><strong>åˆ†åŒºçŠ¶æ€åŒæ­¥</strong>ï¼šåˆ†åŒº Leader å˜æ›´ã€ISRï¼ˆIn-Sync Replicasï¼‰åˆ—è¡¨æ›´æ–°ç­‰æ“ä½œé€šè¿‡ ZooKeeper é€šçŸ¥å…¶ä»– Brokerã€‚</li>
</ul>
<p><strong>æ§åˆ¶å™¨ï¼ˆControllerï¼‰é€‰ä¸¾</strong></p>
<p>Kafka é›†ç¾¤ä¸­çš„æŸä¸ª Broker ä¼šè¢«é€‰ä¸¾ä¸º Controllerï¼ˆé€šè¿‡ ZooKeeper çš„ä¸´æ—¶èŠ‚ç‚¹ç«äº‰ï¼‰ï¼Œè´Ÿè´£åˆ†åŒº Leader é€‰ä¸¾ã€å‰¯æœ¬åˆ†é…ç­‰å…³é”®ä»»åŠ¡ã€‚Controller æ•…éšœæ—¶ï¼ŒZooKeeper ä¼šè§¦å‘é‡æ–°é€‰ä¸¾ã€‚</p>
<p><strong>å®¢æˆ·ç«¯æœåŠ¡å‘ç°</strong></p>
<p>ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…é€šè¿‡ ZooKeeperï¼ˆæ—§ç‰ˆæœ¬ï¼‰æˆ–ç›´æ¥é€šè¿‡ Brokerï¼ˆæ–°ç‰ˆæœ¬ï¼‰è·å–é›†ç¾¤çš„ Broker åˆ—è¡¨å’Œ Topic å…ƒæ•°æ®ï¼Œä»¥ç¡®å®šæ•°æ®çš„è¯»å†™ä½ç½®ã€‚</p>
<p><strong>ACL ä¸é…é¢ç®¡ç†</strong>ï¼ˆå¯é€‰ï¼‰</p>
<p>ZooKeeper å­˜å‚¨è®¿é—®æ§åˆ¶åˆ—è¡¨ï¼ˆACLï¼‰å’Œå®¢æˆ·ç«¯é…é¢é…ç½®ï¼Œç”¨äºæƒé™æ§åˆ¶å’Œæµé‡é™åˆ¶ã€‚</p>
<p><strong>KRaft å°†æ›¿ä»£ ZooKeeper</strong></p>
<p><strong>Kafka 2.8+ ç‰ˆæœ¬</strong>å¼€å§‹æ”¯æŒ** KRaft æ¨¡å¼**ï¼ˆåŸºäº Raft åè®®ï¼‰ï¼Œé€æ­¥å¼ƒç”¨ ZooKeeperï¼Œå°†å…ƒæ•°æ®ç®¡ç†å’Œé€‰ä¸¾é€»è¾‘å†…ç½®äº Kafka è‡ªèº«ï¼Œä»¥ç®€åŒ–æ¶æ„å¹¶æå‡æ€§èƒ½ã€‚ä½†åœ¨å¤§å¤šæ•°ç”Ÿäº§ç¯å¢ƒä¸­ï¼ŒZooKeeper ä»å¹¿æ³›ä½¿ç”¨ã€‚</p>
<h3 id="ã€ä¸­ç­‰ã€‘Kafka-ä¸ºä»€ä¹ˆè¦å¼ƒç”¨-Zookeeperï¼Ÿ"><a href="#ã€ä¸­ç­‰ã€‘Kafka-ä¸ºä»€ä¹ˆè¦å¼ƒç”¨-Zookeeperï¼Ÿ" class="headerlink" title="ã€ä¸­ç­‰ã€‘Kafka ä¸ºä»€ä¹ˆè¦å¼ƒç”¨ Zookeeperï¼Ÿ"></a>ã€ä¸­ç­‰ã€‘Kafka ä¸ºä»€ä¹ˆè¦å¼ƒç”¨ Zookeeperï¼Ÿ</h3><p>Kafka å¼ƒç”¨ ZooKeeper ä¸»è¦æ˜¯ä¸ºäº†<strong>ç®€åŒ–æ¶æ„ã€æå‡æ€§èƒ½ã€é™ä½è¿ç»´å¤æ‚åº¦</strong>ã€‚</p>
<p><strong>å‡å°‘å¤–éƒ¨ä¾èµ–</strong></p>
<ul>
<li><strong>æ¶æ„ç®€åŒ–</strong>ï¼šZooKeeper æ˜¯ç‹¬ç«‹çš„å¤–éƒ¨ç³»ç»Ÿï¼Œéœ€é¢å¤–éƒ¨ç½²å’Œç»´æŠ¤ã€‚ç§»é™¤åï¼ŒKafka æˆä¸ºå®Œå…¨è‡ªåŒ…å«çš„ç³»ç»Ÿï¼Œé™ä½éƒ¨ç½²å’Œè¿ç»´æˆæœ¬ã€‚</li>
<li><strong>é¿å…å•ç‚¹é£é™©</strong>ï¼šZooKeeper æœ¬èº«éœ€è¦é›†ç¾¤åŒ–ï¼Œè‹¥å‡ºç°æ•…éšœä¼šå½±å“ Kafka çš„å…ƒæ•°æ®ç®¡ç†ï¼Œå†…åµŒæ²»ç†é€»è¾‘å¯å‡å°‘æ­¤ç±»é£é™©ã€‚</li>
</ul>
<p><strong>æå‡æ‰©å±•æ€§ä¸æ€§èƒ½</strong></p>
<ul>
<li><strong>å…ƒæ•°æ®æ•ˆç‡</strong>ï¼šZooKeeper çš„å†™æ“ä½œï¼ˆå¦‚ Leader é€‰ä¸¾ï¼‰æ˜¯ä¸²è¡Œçš„ï¼Œå¯èƒ½æˆä¸ºç“¶é¢ˆã€‚Kafka å†…ç½®çš„ <strong>KRaft åè®®</strong>ï¼ˆåŸºäº Raftï¼‰æ”¯æŒå¹¶è¡Œæ—¥å¿—å†™å…¥ï¼Œæ˜¾è‘—æå‡å…ƒæ•°æ®å¤„ç†é€Ÿåº¦ï¼ˆå¦‚åˆ†åŒºæ‰©å®¹ã€Leader åˆ‡æ¢ï¼‰ã€‚</li>
<li><strong>é™ä½å»¶è¿Ÿ</strong>ï¼šçœå»ä¸ ZooKeeper çš„ç½‘ç»œé€šä¿¡ï¼Œå…ƒæ•°æ®æ“ä½œï¼ˆå¦‚ Broker æ³¨å†Œã€Topic å˜æ›´ï¼‰å»¶è¿Ÿæ›´ä½ã€‚</li>
</ul>
<p><strong>ç»Ÿä¸€å…ƒæ•°æ®ç®¡ç†</strong></p>
<ul>
<li><strong>ä¸€è‡´æ€§æ¨¡å‹ç»Ÿä¸€</strong>ï¼šZooKeeper ä½¿ç”¨ ZAB åè®®ï¼Œè€Œ Kafka ä½¿ç”¨è‡ªèº«çš„æ—¥å¿—å¤åˆ¶æœºåˆ¶ï¼Œä¸¤è€…ä¸ä¸€è‡´å¯èƒ½å¯¼è‡´åè°ƒé—®é¢˜ã€‚KRaft æ¨¡å¼é€šè¿‡å•ä¸€åè®®ï¼ˆRaftï¼‰ç®¡ç†æ‰€æœ‰å…ƒæ•°æ®ï¼Œé€»è¾‘æ›´æ¸…æ™°ã€‚</li>
<li><strong>ç®€åŒ–å®¢æˆ·ç«¯è®¿é—®</strong>ï¼šæ—§ç‰ˆå®¢æˆ·ç«¯éœ€åŒæ—¶è¿æ¥ Kafka å’Œ ZooKeeperï¼Œæ–°ç‰ˆåªéœ€ç›´è¿ Kafka Brokerã€‚</li>
</ul>
<p><strong>æ”¯æŒæ›´å¤§è§„æ¨¡é›†ç¾¤</strong></p>
<p><strong>ZooKeeper çš„å±€é™æ€§</strong>ï¼šZooKeeper å¯¹èŠ‚ç‚¹æ•°é‡ï¼ˆé€šå¸¸â‰¤7ï¼‰å’Œ Watcher æ•°é‡æœ‰é™åˆ¶ï¼Œå½±å“ Kafka é›†ç¾¤çš„æ‰©å±•æ€§ã€‚KRaft æ¨¡å¼é€šè¿‡åˆ†ç‰‡å’Œæµå¼å…ƒæ•°æ®ä¼ é€’ï¼Œæ”¯æŒè¶…å¤§è§„æ¨¡é›†ç¾¤ï¼ˆå¦‚æ•°åä¸‡åˆ†åŒºï¼‰ã€‚</p>
<p><strong>è¡¥å……è¯´æ˜</strong></p>
<ul>
<li>Kafka 2.8+ å¼€å§‹å®éªŒæ€§æ”¯æŒ KRaft æ¨¡å¼ï¼Œ3.0+ é€æ­¥ç¨³å®šï¼Œä½†ä»å…¼å®¹ ZooKeeper æ¨¡å¼ã€‚</li>
<li>å®Œå…¨ç§»é™¤ ZooKeeper éœ€ç¡®ä¿ KRaft åœ¨ç”Ÿäº§ç¯å¢ƒä¸­çš„æˆç†Ÿåº¦ï¼ˆå¦‚æ•…éšœæ¢å¤ã€ç›‘æ§å·¥å…·é“¾å®Œå–„ï¼‰ã€‚</li>
</ul>
<h3 id="ã€ä¸­ç­‰ã€‘Kafka-ä¸­å¦‚ä½•å®ç°æ—¶é—´è½®ï¼Ÿ"><a href="#ã€ä¸­ç­‰ã€‘Kafka-ä¸­å¦‚ä½•å®ç°æ—¶é—´è½®ï¼Ÿ" class="headerlink" title="ã€ä¸­ç­‰ã€‘Kafka ä¸­å¦‚ä½•å®ç°æ—¶é—´è½®ï¼Ÿ"></a>ã€ä¸­ç­‰ã€‘Kafka ä¸­å¦‚ä½•å®ç°æ—¶é—´è½®ï¼Ÿ</h3><p>æ—¶é—´è½®æ˜¯ç”¨äºé«˜æ•ˆç®¡ç†å’Œè°ƒåº¦å¤§é‡å®šæ—¶ä»»åŠ¡çš„<strong>ç¯å½¢æ•°æ®ç»“æ„</strong>ï¼Œé€šè¿‡æ—¶é—´åˆ†ç‰‡ï¼ˆæ§½ï¼‰ç®¡ç†ä»»åŠ¡ï¼Œä¼˜åŒ–è°ƒåº¦æ•ˆç‡ã€‚</p>
<p><strong>æ•°æ®ç»“æ„</strong></p>
<ul>
<li><strong>ç¯å½¢æ•°ç»„</strong>ï¼šæ¯ä¸ªæ§½ä»£è¡¨ä¸€ä¸ªæ—¶é—´ç‰‡ï¼ˆå¦‚ 1 ç§’ï¼‰ï¼Œå­˜å‚¨åŒå‘é“¾è¡¨ç®¡ç†çš„ä»»åŠ¡ã€‚</li>
<li><strong>æŒ‡é’ˆç§»åŠ¨</strong>ï¼šä»¥å›ºå®šæ—¶é—´æ­¥é•¿æ¨è¿›ï¼Œè§¦å‘å½“å‰æ§½çš„ä»»åŠ¡æ‰§è¡Œã€‚</li>
</ul>
<p><strong>å·¥ä½œåŸç†</strong></p>
<ul>
<li><strong>ä»»åŠ¡æ’å…¥</strong>ï¼šæ ¹æ®å»¶è¿Ÿæ—¶é—´è®¡ç®—æ§½ä½ï¼ˆå¦‚ <code>å»¶è¿Ÿ % æ§½æ•°</code>ï¼‰ï¼Œæ’å…¥é“¾è¡¨å°¾éƒ¨ï¼ˆ<code>O(1)</code> å¤æ‚åº¦ï¼‰ã€‚</li>
<li><strong>ä»»åŠ¡è§¦å‘</strong>ï¼šæŒ‡é’ˆæ¯ç§»åŠ¨ä¸€æ ¼ï¼Œæ‰§è¡Œå¯¹åº”æ§½ä¸­æ‰€æœ‰ä»»åŠ¡ã€‚</li>
</ul>
<p><strong>å¤„ç†é•¿å»¶è¿Ÿä»»åŠ¡</strong></p>
<ul>
<li><strong>æ–¹æ¡ˆ 1ï¼šè½®æ¬¡ï¼ˆNettyï¼‰</strong>ï¼šè®¡ç®—è½®æ•°ï¼ˆå¦‚ <code>ï¼ˆå»¶è¿Ÿ-1)/æ§½æ•°</code>ï¼‰ï¼Œè½®æ•°å½’é›¶æ—¶è§¦å‘ã€‚</li>
<li><strong>æ–¹æ¡ˆ 2ï¼šå¤šå±‚æ¬¡æ—¶é—´è½®ï¼ˆKafkaï¼‰</strong><ul>
<li><strong>å±‚çº§é€’è¿›</strong>ï¼šé«˜å±‚æ§½è¦†ç›–æ›´å¤§æ—¶é—´èŒƒå›´ï¼ˆå¦‚ç§’â†’åˆ†â†’æ—¶ï¼‰ã€‚</li>
<li><strong>é™çº§æœºåˆ¶</strong>ï¼šä»»åŠ¡éšæ—¶é—´æ¨ç§»ä»é«˜å±‚ç§»è‡³åº•å±‚ï¼Œä¿è¯ç²¾åº¦ã€‚</li>
</ul>
</li>
</ul>
<p><strong>ä¼˜ç‚¹</strong></p>
<ul>
<li><strong>é«˜æ•ˆæ€§</strong>ï¼šæ’å…¥&#x2F;åˆ é™¤ä»»åŠ¡ O(1) å¤æ‚åº¦ã€‚</li>
<li><strong>ä½å†…å­˜å¼€é”€</strong>ï¼šå›ºå®šæ§½æ•°ï¼Œå†…å­˜å ç”¨ç¨³å®šã€‚</li>
</ul>
<p><strong>åº”ç”¨åœºæ™¯</strong></p>
<ul>
<li>é«˜å¹¶å‘å®šæ—¶ä»»åŠ¡ï¼ˆå¦‚ Netty çš„è¶…æ—¶æ£€æµ‹ï¼‰ã€‚</li>
<li>ç½‘ç»œæœåŠ¡å™¨ï¼ˆè¿æ¥&#x2F;è¯·æ±‚è¶…æ—¶ç®¡ç†ï¼‰ã€‚</li>
<li>åˆ†å¸ƒå¼ç³»ç»Ÿï¼ˆèŠ‚ç‚¹é—´ä»»åŠ¡åè°ƒï¼‰ã€‚</li>
</ul>
<p><strong>å®é™…åº”ç”¨</strong></p>
<ul>
<li><strong>Netty</strong>ï¼š<code>HashedWheelTimer</code>ï¼ˆå•å±‚+è½®æ¬¡ï¼‰ã€‚</li>
<li><strong>Kafka</strong>ï¼šå¤šå±‚æ¬¡æ—¶é—´è½®+é™çº§ã€‚</li>
<li><strong>Caffeine Cache</strong>ï¼šæœ¬åœ°ç¼“å­˜çš„ä»»åŠ¡è°ƒåº¦ã€‚</li>
</ul>
<h3 id="ã€ä¸­ç­‰ã€‘Kafka-çš„ç´¢å¼•è®¾è®¡æœ‰ä»€ä¹ˆäº®ç‚¹ï¼Ÿ"><a href="#ã€ä¸­ç­‰ã€‘Kafka-çš„ç´¢å¼•è®¾è®¡æœ‰ä»€ä¹ˆäº®ç‚¹ï¼Ÿ" class="headerlink" title="ã€ä¸­ç­‰ã€‘Kafka çš„ç´¢å¼•è®¾è®¡æœ‰ä»€ä¹ˆäº®ç‚¹ï¼Ÿ"></a>ã€ä¸­ç­‰ã€‘Kafka çš„ç´¢å¼•è®¾è®¡æœ‰ä»€ä¹ˆäº®ç‚¹ï¼Ÿ</h3><p>Kafka çš„ç´¢å¼•è®¾è®¡é€šè¿‡<strong>ç¨€ç–ç´¢å¼• + äºŒåˆ†æŸ¥æ‰¾ + åˆ†æ®µå­˜å‚¨</strong>ï¼Œåœ¨<strong>æŸ¥è¯¢æ•ˆç‡ã€å­˜å‚¨æˆæœ¬ã€æ‰©å±•æ€§</strong>ä¹‹é—´å–å¾—å¹³è¡¡ï¼Œé€‚åˆé«˜ååã€ä½å»¶è¿Ÿçš„æ¶ˆæ¯ç³»ç»Ÿéœ€æ±‚ã€‚</p>
<p>Kafka çš„ç´¢å¼•è®¾è®¡ï¼ˆä¸»è¦æ¶‰åŠ<strong>åç§»é‡ç´¢å¼•ï¼ˆ.indexï¼‰å’Œæ—¶é—´æˆ³ç´¢å¼•ï¼ˆ.timeindexï¼‰</strong>ï¼‰å…·æœ‰ä»¥ä¸‹æ ¸å¿ƒä¼˜åŠ¿ï¼š</p>
<p><strong>é«˜æ•ˆæŸ¥è¯¢ï¼ˆO(1) ~ O(logN) å¤æ‚åº¦ï¼‰</strong></p>
<ul>
<li><strong>ç¨€ç–ç´¢å¼•</strong>ï¼šä¸å­˜å‚¨æ¯æ¡æ¶ˆæ¯çš„ç´¢å¼•ï¼Œè€Œæ˜¯æŒ‰ä¸€å®šé—´éš”ï¼ˆå¦‚æ¯ 4KB æ•°æ®ï¼‰å»ºç«‹ç´¢å¼•é¡¹ï¼Œå¤§å¹…å‡å°‘ç´¢å¼•æ–‡ä»¶å¤§å°ã€‚</li>
<li><strong>äºŒåˆ†æŸ¥æ‰¾</strong>ï¼šé€šè¿‡ç´¢å¼•å¿«é€Ÿå®šä½æ¶ˆæ¯æ‰€åœ¨çš„<strong>ç‰©ç†ä½ç½®ï¼ˆç£ç›˜æ–‡ä»¶+åç§»é‡ï¼‰</strong>ï¼Œå‡å°‘å…¨é‡æ‰«æã€‚</li>
</ul>
<p><strong>ä½å­˜å‚¨å¼€é”€</strong></p>
<ul>
<li><strong>ç´§å‡‘ç»“æ„</strong>ï¼šç´¢å¼•æ–‡ä»¶ä»…å­˜å‚¨<strong>åç§»é‡ + ç‰©ç†ä½ç½®</strong>ï¼ˆå›ºå®š 8 å­—èŠ‚&#x2F;é¡¹ï¼‰ï¼Œå ç”¨ç©ºé—´æå°ã€‚</li>
<li><strong>åˆ†æ®µå­˜å‚¨</strong>ï¼šæ¯ä¸ªæ—¥å¿—æ®µï¼ˆSegmentï¼‰ç‹¬ç«‹ç»´æŠ¤ç´¢å¼•ï¼Œé¿å…å•ä¸€å¤§æ–‡ä»¶ç´¢å¼•çš„æ€§èƒ½ç“¶é¢ˆã€‚</li>
</ul>
<p><strong>å¿«é€Ÿæ•…éšœæ¢å¤</strong></p>
<ul>
<li><strong>å†…å­˜æ˜ å°„ï¼ˆMMAPï¼‰</strong>ï¼šç´¢å¼•æ–‡ä»¶é€šè¿‡å†…å­˜æ˜ å°„åŠ é€Ÿè¯»å–ï¼Œé‡å¯æ—¶æ— éœ€å…¨é‡åŠ è½½ã€‚</li>
<li><strong>æ‡’åŠ è½½</strong>ï¼šä»…åŠ è½½æ´»è·ƒåˆ†ç‰‡çš„ç´¢å¼•ï¼Œå‡å°‘å¯åŠ¨æ—¶é—´ã€‚</li>
</ul>
<p><strong>æ”¯æŒæ—¶é—´èŒƒå›´æŸ¥è¯¢</strong>ï¼š<strong>æ—¶é—´æˆ³ç´¢å¼•ï¼ˆ.timeindexï¼‰</strong>å…è®¸æŒ‰æ—¶é—´æˆ³å¿«é€Ÿå®šä½æ¶ˆæ¯ï¼Œé€‚ç”¨äºæ—¥å¿—å›æº¯ã€ç›‘æ§ç­‰åœºæ™¯ã€‚</p>
<p><strong>ç´¢å¼•è‡ªåŠ¨æ›´æ–°</strong>ï¼šæ—¥å¿—å‹ç¼©ï¼ˆCompactionï¼‰æˆ–åˆ é™¤ï¼ˆRetentionï¼‰æ—¶ï¼Œç´¢å¼•åŒæ­¥æ¸…ç†ï¼Œé¿å…æ— æ•ˆæŸ¥è¯¢ã€‚</p>
<h3 id="ã€å›°éš¾ã€‘Kafka-å¤„ç†è¯·æ±‚çš„å…¨æµç¨‹ï¼Ÿ"><a href="#ã€å›°éš¾ã€‘Kafka-å¤„ç†è¯·æ±‚çš„å…¨æµç¨‹ï¼Ÿ" class="headerlink" title="ã€å›°éš¾ã€‘Kafka å¤„ç†è¯·æ±‚çš„å…¨æµç¨‹ï¼Ÿ"></a>ã€å›°éš¾ã€‘Kafka å¤„ç†è¯·æ±‚çš„å…¨æµç¨‹ï¼Ÿ</h3><p>Kafka é‡‡ç”¨ <strong>å¤šçº¿ç¨‹æ±  + äº‹ä»¶é©±åŠ¨</strong> æ¨¡å‹ï¼Œæ ¸å¿ƒçº¿ç¨‹ç»„åˆ†å·¥å¦‚ä¸‹ï¼š</p>
<p><strong>ç½‘ç»œé€šä¿¡å±‚ï¼ˆ1 ä¸ª Acceptor + N ä¸ª Processorï¼‰</strong></p>
<ul>
<li><strong>Acceptor çº¿ç¨‹</strong>ï¼ˆ1 ä¸ªï¼‰ï¼šç›‘å¬ <code>ServerSocket</code>ï¼Œæ¥æ”¶å®¢æˆ·ç«¯è¿æ¥ï¼Œè½®è¯¢åˆ†å‘ç»™ <code>Processor</code> çº¿ç¨‹ã€‚</li>
<li><strong>Processor çº¿ç¨‹</strong>ï¼ˆé»˜è®¤ 3 ä¸ªï¼Œå¯é…ç½®ï¼‰ï¼šæ¯ä¸ª <code>Processor</code> ç»´æŠ¤ä¸€ä¸ª <code>Selector</code>ï¼ˆNIOï¼‰ï¼Œè´Ÿè´£ï¼š<ul>
<li><strong>è¯»è¯·æ±‚</strong>ï¼šè§£æè¯·æ±‚æ•°æ®ï¼Œæ”¾å…¥<strong>å…±äº«è¯·æ±‚é˜Ÿåˆ—</strong>ï¼ˆ<code>RequestChannel</code>ï¼‰ã€‚</li>
<li><strong>å†™å“åº”</strong>ï¼šä» <code>ResponseQueue</code> è·å–ç»“æœï¼Œé€šè¿‡ <code>Socket</code> è¿”å›å®¢æˆ·ç«¯ã€‚</li>
</ul>
</li>
</ul>
<p><strong>è¯·æ±‚å¤„ç†å±‚ï¼ˆKafkaRequestHandlerPoolï¼‰</strong></p>
<p><strong>IO çº¿ç¨‹æ± </strong>ï¼ˆé»˜è®¤ 8 ä¸ªï¼Œå¯é…ç½®ï¼‰ä» <code>RequestChannel</code> æ‹‰å–è¯·æ±‚ï¼Œæ ¹æ®ç±»å‹è°ƒç”¨å¯¹åº” <code>API å±‚</code> å¤„ç†ï¼ˆå¦‚ <code>handleProduceRequest</code>ï¼‰ã€‚</p>
<p>å…³é”®æ“ä½œï¼š</p>
<ul>
<li><strong>ç”Ÿäº§è¯·æ±‚</strong>ï¼šå†™å…¥ Leader å‰¯æœ¬çš„ <code>LogSegment</code>ï¼ˆå†…å­˜â†’PageCacheâ†’ç£ç›˜ï¼‰ã€‚</li>
<li><strong>æ¶ˆè´¹è¯·æ±‚</strong>ï¼šä» <code>PageCache</code> æˆ–ç£ç›˜è¯»å–æ•°æ®ï¼ˆé›¶æ‹·è´ä¼˜åŒ–ï¼‰ã€‚</li>
</ul>
<p><strong>åå°çº¿ç¨‹</strong></p>
<ul>
<li><strong>Log Cleaner</strong>ï¼šæ—¥å¿—å‹ç¼©ï¼ˆCompactionï¼‰å’Œåˆ é™¤ï¼ˆRetentionï¼‰ã€‚</li>
<li><strong>Replica Manager</strong>ï¼šå‰¯æœ¬åŒæ­¥ï¼ˆISRï¼‰ã€Leader é€‰ä¸¾ã€‚</li>
<li><strong>Delayed Operation</strong>ï¼šå¤„ç†å»¶è¿Ÿæ“ä½œï¼ˆå¦‚ <code>Produce</code> çš„ ACK ç­‰å¾…ï¼‰ã€‚</li>
</ul>
<p><img src="https://rahulvishwakarma.wordpress.com/wp-content/uploads/2016/06/kafka-broker-internals.png?w=634" alt="kafka broker internals"></p>
<p><strong>æ ¸å¿ƒè®¾è®¡ä¼˜åŠ¿</strong></p>
<ul>
<li><strong>è§£è€¦ç½‘ç»œ I&#x2F;O ä¸ä¸šåŠ¡å¤„ç†</strong>ï¼š<code>Processor</code> ä»…è´Ÿè´£é€šä¿¡ï¼Œ<code>Handler</code> ä¸“æ³¨é€»è¾‘ã€‚</li>
<li><strong>æ— é”é˜Ÿåˆ—</strong>ï¼š<code>RequestChannel</code> ä½¿ç”¨ <code>ConcurrentLinkedQueue</code>ï¼Œå‡å°‘ç«äº‰ã€‚</li>
<li><strong>åŠ¨æ€æ‰©å±•</strong>ï¼šå¯è°ƒæ•´ <code>Processor</code> å’Œ <code>Handler</code> çº¿ç¨‹æ•°é€‚é…è´Ÿè½½ã€‚</li>
</ul>
<h3 id="ã€å›°éš¾ã€‘Kafka-ä¸­å¦‚ä½•å®ç°äº‹åŠ¡æœºåˆ¶ï¼Ÿ"><a href="#ã€å›°éš¾ã€‘Kafka-ä¸­å¦‚ä½•å®ç°äº‹åŠ¡æœºåˆ¶ï¼Ÿ" class="headerlink" title="ã€å›°éš¾ã€‘Kafka ä¸­å¦‚ä½•å®ç°äº‹åŠ¡æœºåˆ¶ï¼Ÿ"></a>ã€å›°éš¾ã€‘Kafka ä¸­å¦‚ä½•å®ç°äº‹åŠ¡æœºåˆ¶ï¼Ÿ</h3><p>::: info Kafka äº‹åŠ¡å®ç°</p>
<p>:::</p>
<p>Kafka äº‹åŠ¡æ˜¯ä¸ºäº†å®ç°æ¶ˆæ¯çš„ <strong>Exactly-Once è¯­ä¹‰</strong>ï¼Œç¡®ä¿æ¶ˆæ¯åœ¨ç”Ÿäº§ã€ä¼ è¾“ã€æ¶ˆè´¹è¿‡ç¨‹ä¸­<strong>ä»…å¤„ç†ä¸€æ¬¡</strong>ã€‚</p>
<p><strong>å…³é”®ç»„ä»¶</strong></p>
<ul>
<li><strong>äº‹åŠ¡åè°ƒå™¨</strong>ï¼šç®¡ç†äº‹åŠ¡ç”Ÿå‘½å‘¨æœŸï¼ŒçŠ¶æ€æŒä¹…åŒ–åˆ°<code>__transaction_state</code>ä¸»é¢˜ã€‚</li>
<li><strong>å¹‚ç­‰ç”Ÿäº§è€…</strong>ï¼šé€šè¿‡<code>Producer ID + Sequence Number</code>é¿å…é‡å¤æ¶ˆæ¯ã€‚</li>
<li><strong>äº‹åŠ¡æ€§æ¶ˆè´¹</strong>ï¼šæ”¯æŒ<code>read_committed</code>éš”ç¦»çº§åˆ«ï¼Œè¿‡æ»¤æœªæäº¤æ¶ˆæ¯ã€‚</li>
</ul>
<p><strong>å·¥ä½œæµç¨‹</strong></p>
<ul>
<li><strong>å¯äº‹åŠ¡</strong>ï¼šç”Ÿäº§è€…å‘åè°ƒå™¨æ³¨å†Œäº‹åŠ¡</li>
<li><strong>å†™æ¶ˆæ¯</strong>ï¼šå¸¦äº‹åŠ¡ ID çš„æ¶ˆæ¯å†™å…¥åˆ†åŒºï¼ˆæ ‡è®°ä¸ºæœªæäº¤ï¼‰</li>
<li><strong>å®šç»“å±€</strong>ï¼šåè°ƒå™¨æœ€ç»ˆæäº¤ï¼ˆå†™ Commit æ ‡è®°ï¼‰æˆ–å›æ»š</li>
<li><strong>æ§æ¶ˆè´¹</strong>ï¼šæ¶ˆè´¹è€…ä»…è¯»å–å·²æäº¤æ¶ˆæ¯</li>
</ul>
<p><strong>è®¾è®¡ç‰¹ç‚¹</strong></p>
<ul>
<li>è½»é‡çº§äº‹åŠ¡ï¼ˆéå®Œæ•´ 2PCï¼‰</li>
<li>ä¸é«˜ååæ¶æ„å…¼å®¹</li>
<li>æ•…éšœè‡ªåŠ¨æ¢å¤ï¼ˆé€šè¿‡äº‹åŠ¡æ—¥å¿—ï¼‰</li>
</ul>
<p>::: info Kafka äº‹åŠ¡ å’Œ RocketMQ äº‹åŠ¡çš„åŒºåˆ«</p>
<p>:::</p>
<ul>
<li><strong>Kafka äº‹åŠ¡</strong>ä¸»è¦è§£å†³ <strong>Exactly-Once è¯­ä¹‰</strong>ï¼ˆç”Ÿäº§ã€æ¶ˆè´¹çš„ç²¾ç¡®ä¸€æ¬¡å¤„ç†ï¼‰ï¼Œé€‚ç”¨äº <strong>æµå¤„ç†åœºæ™¯</strong>ï¼ˆå¦‚ Flinkã€Kafka Streams çš„çŠ¶æ€ä¸€è‡´æ€§ï¼‰ã€‚</li>
<li><strong>RocketMQ äº‹åŠ¡</strong>ä¸»è¦è§£å†³ <strong>åˆ†å¸ƒå¼äº‹åŠ¡</strong>ï¼ˆå¦‚è®¢å•+åº“å­˜çš„è·¨ç³»ç»Ÿäº‹åŠ¡ï¼‰ï¼Œé€‚ç”¨äº <strong>ä¸šåŠ¡äº‹åŠ¡åœºæ™¯</strong>ï¼ˆå¦‚ç”µå•†ã€é‡‘èçš„æœ€ç»ˆä¸€è‡´æ€§ï¼‰ã€‚</li>
</ul>
<p><strong>å®ç°æœºåˆ¶å·®å¼‚</strong></p>
<table>
<thead>
<tr>
<th><strong>ç‰¹æ€§</strong></th>
<th><strong>Kafka</strong></th>
<th><strong>RocketMQ</strong></th>
</tr>
</thead>
<tbody><tr>
<td><strong>äº‹åŠ¡åè°ƒè€…</strong></td>
<td>å†…ç½® <code>TransactionCoordinator</code></td>
<td>ä¾èµ–å¤–éƒ¨ <strong>äº‹åŠ¡æ¶ˆæ¯å­˜å‚¨</strong>ï¼ˆå¦‚ MySQLï¼‰</td>
</tr>
<tr>
<td><strong>äº‹åŠ¡çŠ¶æ€å­˜å‚¨</strong></td>
<td>å†…éƒ¨ Topic <code>__transaction_state</code></td>
<td>ç‹¬ç«‹å­˜å‚¨ï¼ˆå¦‚æ•°æ®åº“ã€ZKï¼‰</td>
</tr>
<tr>
<td><strong>äº‹åŠ¡æ¶ˆæ¯å¯è§æ€§</strong></td>
<td>æ”¯æŒ <code>read_committed</code> éš”ç¦»</td>
<td>éœ€æ¶ˆè´¹è€…ä¸»åŠ¨å›æŸ¥ï¼ˆåŠæ¶ˆæ¯æœºåˆ¶ï¼‰</td>
</tr>
<tr>
<td><strong>äº‹åŠ¡æäº¤æ–¹å¼</strong></td>
<td>ä¸¤é˜¶æ®µæäº¤ï¼ˆ2PCï¼‰</td>
<td>æœ¬åœ°äº‹åŠ¡+å®šæ—¶ä»»åŠ¡ï¼ˆäº‹åŠ¡å›æŸ¥ï¼‰</td>
</tr>
</tbody></table>
<p><strong>åº”ç”¨åœºæ™¯</strong></p>
<ul>
<li><strong>Kafka</strong>ï¼š<ul>
<li>æµå¤„ç†ä»»åŠ¡çš„ <strong>ç«¯åˆ°ç«¯ç²¾ç¡®ä¸€æ¬¡</strong>ï¼ˆå¦‚ Flink+Kafkaï¼‰ã€‚</li>
<li>è·¨åˆ†åŒºçš„åŸå­å†™å…¥ï¼ˆå¦‚å¤šä¸ª Topic çš„å…³è”æ“ä½œï¼‰ã€‚</li>
</ul>
</li>
<li><strong>RocketMQ</strong>ï¼š<ul>
<li>è·¨ç³»ç»Ÿäº‹åŠ¡ï¼ˆå¦‚ <strong>è®¢å•åˆ›å»º+æ‰£åº“å­˜</strong>ï¼‰ã€‚</li>
<li>éœ€è¦ <strong>ä¸šåŠ¡å›æŸ¥</strong> çš„æœ€ç»ˆä¸€è‡´æ€§åœºæ™¯ã€‚</li>
</ul>
</li>
</ul>
<h3 id="ã€å›°éš¾ã€‘Kafka-æ§åˆ¶å™¨å¦‚ä½•å¤„ç†äº‹ä»¶ï¼Ÿ"><a href="#ã€å›°éš¾ã€‘Kafka-æ§åˆ¶å™¨å¦‚ä½•å¤„ç†äº‹ä»¶ï¼Ÿ" class="headerlink" title="ã€å›°éš¾ã€‘Kafka æ§åˆ¶å™¨å¦‚ä½•å¤„ç†äº‹ä»¶ï¼Ÿ"></a>ã€å›°éš¾ã€‘Kafka æ§åˆ¶å™¨å¦‚ä½•å¤„ç†äº‹ä»¶ï¼Ÿ</h3><p>æ§åˆ¶å™¨æ˜¯ Kafka é›†ç¾¤çš„<strong>ç®¡ç†ä¸­æ¢</strong>ï¼ŒåŸºäº ZooKeeper&#x2F;KRaft é€‰ä¸¾ï¼Œå…¶æœ¬è´¨æ˜¯<strong>ä¸€ä¸ªç‰¹æ®Šçš„ Broker</strong>ï¼Œé¢å¤–æ‰¿æ‹…é›†ç¾¤ç®¡ç†èŒè´£ã€‚</p>
<p><strong>æ§åˆ¶å™¨é€‰ä¸¾</strong></p>
<ul>
<li>æ¯ä¸ª Broker å¯åŠ¨æ—¶å°è¯•åœ¨ ZooKeeper åˆ›å»º<code>/controller</code>ä¸´æ—¶èŠ‚ç‚¹</li>
<li>æˆåŠŸåˆ›å»ºçš„ Broker æˆä¸ºæ§åˆ¶å™¨ï¼ˆLeaderï¼‰</li>
<li>å…¶ä»– Broker ç›‘å¬è¯¥èŠ‚ç‚¹ï¼Œå®ç°æ•…éšœè½¬ç§»</li>
</ul>
<p><strong>äº‹ä»¶å¤„ç†æµç¨‹</strong></p>
<ul>
<li><strong>äº‹ä»¶æ•è·</strong>ï¼šé€šè¿‡ ZooKeeper Watch æœºåˆ¶ç›‘å¬å…³é”®è·¯å¾„ï¼š<ul>
<li><code>/brokers/ids</code>ï¼ˆBroker ä¸Šä¸‹çº¿ï¼‰</li>
<li><code>/admin/delete_topics</code>ï¼ˆä¸»é¢˜åˆ é™¤ï¼‰</li>
<li><code>/isr_change_notification</code>ï¼ˆISR å˜æ›´ï¼‰</li>
</ul>
</li>
<li><strong>äº‹ä»¶å…¥é˜Ÿ</strong><ul>
<li>æ§åˆ¶å™¨å°†äº‹ä»¶æ”¾å…¥<strong>å¼‚æ­¥äº‹ä»¶é˜Ÿåˆ—</strong>ï¼ˆControllerEventManagerï¼‰</li>
<li>ä¿è¯äº‹ä»¶é¡ºåºå¤„ç†ï¼ˆå•çº¿ç¨‹æ¨¡å‹ï¼‰</li>
</ul>
</li>
<li><strong>äº‹ä»¶å¤„ç†</strong><ul>
<li><strong>åˆ†åŒºå†å‡è¡¡</strong>ï¼šè§¦å‘ Leader é€‰ä¸¾ï¼Œæ›´æ–° ISR åˆ—è¡¨</li>
<li><strong>Broker æ•…éšœ</strong>ï¼š<ul>
<li>å°†è¯¥ Broker ä¸Šçš„ Leader åˆ†åŒºè¿ç§»åˆ°å…¶ä»– Broker</li>
<li>æ›´æ–°å…ƒæ•°æ®å¹¶åŒæ­¥åˆ°æ‰€æœ‰ Broker</li>
</ul>
</li>
<li><strong>ä¸»é¢˜å˜æ›´</strong>ï¼šæ›´æ–°åˆ†åŒºåˆ†é…æ–¹æ¡ˆå¹¶æŒä¹…åŒ–åˆ° ZooKeeper</li>
</ul>
</li>
<li><strong>å…ƒæ•°æ®åŒæ­¥</strong><ul>
<li>é€šè¿‡ <strong>UpdateMetadataRequest</strong> å°†æœ€æ–°å…ƒæ•°æ®å¹¿æ’­ç»™æ‰€æœ‰ Broker</li>
<li>Broker æ›´æ–°æœ¬åœ°ç¼“å­˜ï¼ˆMetadataCacheï¼‰</li>
</ul>
</li>
</ul>
<p><strong>å…³é”®è®¾è®¡</strong></p>
<ul>
<li><strong>å•çº¿ç¨‹æ¨¡å‹</strong>ï¼šé¿å…å¹¶å‘é—®é¢˜ï¼ˆæ‰€æœ‰äº‹ä»¶ä¸²è¡Œå¤„ç†ï¼‰</li>
<li><strong>æ‰¹å¤„ç†ä¼˜åŒ–</strong>ï¼šåˆå¹¶ç›¸ä¼¼äº‹ä»¶ï¼ˆå¦‚å¤šä¸ªåˆ†åŒº Leader é€‰ä¸¾ï¼‰</li>
<li><strong>ZooKeeper è§£è€¦</strong>ï¼šæ–°ç‰ˆé€æ¸ç”¨ KRaft æ›¿ä»£ ZK ä¾èµ–</li>
</ul>
<p><strong>å®¹é”™æœºåˆ¶</strong></p>
<ul>
<li>æ§åˆ¶å™¨æ•…éšœæ—¶é€šè¿‡ ZK é‡æ–°é€‰ä¸¾</li>
<li>äº‹ä»¶å¤„ç†å¤±è´¥ä¼šé‡è¯•æˆ–è§¦å‘æ–°ä¸€è½®é€‰ä¸¾</li>
<li>é€šè¿‡ <strong>epoch æœºåˆ¶</strong>é˜²æ­¢è„‘è£‚ï¼ˆæ§åˆ¶å™¨åˆ‡æ¢æ—¶é€’å¢ epochï¼‰</li>
</ul>
<p><strong>æµç¨‹å›¾è§£</strong></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">ZooKeeper</span> äº‹ä»¶è§¦å‘</span><br><span class="line">       â†“</span><br><span class="line">æ§åˆ¶å™¨äº‹ä»¶é˜Ÿåˆ—ï¼ˆControllerEventManagerï¼‰</span><br><span class="line">       â†“</span><br><span class="line">å•çº¿ç¨‹äº‹ä»¶å¤„ç†å™¨</span><br><span class="line">â”œâ”€ åˆ†åŒº Leader é€‰ä¸¾</span><br><span class="line">â”œâ”€ ISR åˆ—è¡¨æ›´æ–°</span><br><span class="line">â”œâ”€ å‰¯æœ¬é‡åˆ†é…</span><br><span class="line">       â†“</span><br><span class="line">UpdateMetadataRequest å¹¿æ’­</span><br><span class="line">       â†“</span><br><span class="line">é›†ç¾¤å…ƒæ•°æ®æœ€ç»ˆä¸€è‡´</span><br></pre></td></tr></table></figure>

<p><strong>ç‰¹ç‚¹</strong>ï¼šé«˜å¯é æ€§ä½†å­˜åœ¨å•ç‚¹ç“¶é¢ˆï¼ˆæ–°ç‰ˆ KRaft æ”¹è¿›ä¸ºåˆ†å¸ƒå¼æ§åˆ¶å™¨ï¼‰</p>
<h2 id="RocketMQ"><a href="#RocketMQ" class="headerlink" title="RocketMQ"></a>RocketMQ</h2><h3 id="ã€ä¸­ç­‰ã€‘RocketMQ-çš„äº‹åŠ¡æ¶ˆæ¯æœ‰ä»€ä¹ˆç¼ºç‚¹ï¼Ÿä½ è¿˜äº†è§£è¿‡åˆ«çš„äº‹åŠ¡æ¶ˆæ¯å®ç°å—ï¼Ÿ"><a href="#ã€ä¸­ç­‰ã€‘RocketMQ-çš„äº‹åŠ¡æ¶ˆæ¯æœ‰ä»€ä¹ˆç¼ºç‚¹ï¼Ÿä½ è¿˜äº†è§£è¿‡åˆ«çš„äº‹åŠ¡æ¶ˆæ¯å®ç°å—ï¼Ÿ" class="headerlink" title="ã€ä¸­ç­‰ã€‘RocketMQ çš„äº‹åŠ¡æ¶ˆæ¯æœ‰ä»€ä¹ˆç¼ºç‚¹ï¼Ÿä½ è¿˜äº†è§£è¿‡åˆ«çš„äº‹åŠ¡æ¶ˆæ¯å®ç°å—ï¼Ÿ"></a>ã€ä¸­ç­‰ã€‘RocketMQ çš„äº‹åŠ¡æ¶ˆæ¯æœ‰ä»€ä¹ˆç¼ºç‚¹ï¼Ÿä½ è¿˜äº†è§£è¿‡åˆ«çš„äº‹åŠ¡æ¶ˆæ¯å®ç°å—ï¼Ÿ</h3><h3 id="ã€ä¸­ç­‰ã€‘ä¸ºä»€ä¹ˆ-RocketMQ-ä¸ä½¿ç”¨-Zookeeper-ä½œä¸ºæ³¨å†Œä¸­å¿ƒï¼Ÿ"><a href="#ã€ä¸­ç­‰ã€‘ä¸ºä»€ä¹ˆ-RocketMQ-ä¸ä½¿ç”¨-Zookeeper-ä½œä¸ºæ³¨å†Œä¸­å¿ƒï¼Ÿ" class="headerlink" title="ã€ä¸­ç­‰ã€‘ä¸ºä»€ä¹ˆ RocketMQ ä¸ä½¿ç”¨ Zookeeper ä½œä¸ºæ³¨å†Œä¸­å¿ƒï¼Ÿ"></a>ã€ä¸­ç­‰ã€‘ä¸ºä»€ä¹ˆ RocketMQ ä¸ä½¿ç”¨ Zookeeper ä½œä¸ºæ³¨å†Œä¸­å¿ƒï¼Ÿ</h3><p>RocketMQ è‡ªç ” <strong>NameServer</strong> æ˜¯ä¸ºäº†ï¼š</p>
<ul>
<li>è§„é¿ ZooKeeper çš„ <strong>æ€§èƒ½ç“¶é¢ˆ</strong></li>
<li>é€‚åº” <strong>å¤§è§„æ¨¡åˆ†å¸ƒå¼é˜Ÿåˆ—åœºæ™¯</strong></li>
<li>å®ç° <strong>ç®€å•é«˜æ•ˆçš„æœåŠ¡å‘ç°</strong></li>
</ul>
<blockquote>
<p>æ³¨ï¼šé˜¿é‡Œå†…éƒ¨æ—©æœŸç‰ˆæœ¬æ›¾ç”¨ ZKï¼Œåå› æ€§èƒ½é—®é¢˜é‡æ„</p>
</blockquote>
<p><strong>è®¾è®¡ç›®æ ‡å·®å¼‚</strong></p>
<ul>
<li><strong>ZooKeeper</strong>ï¼šå¼ºä¸€è‡´æ€§ï¼ˆCPï¼‰ï¼Œé€‚åˆå°è§„æ¨¡å…ƒæ•°æ®ç®¡ç†ï¼ˆå¦‚ Kafka çš„ Controller é€‰ä¸¾ï¼‰</li>
<li><strong>RocketMQ</strong>ï¼šé«˜å¯ç”¨æ€§ï¼ˆAPï¼‰ï¼Œéœ€è¦æ”¯æŒ <strong>é«˜é¢‘è¯»å†™</strong>ï¼ˆå¦‚ Broker æ³¨å†Œã€å¿ƒè·³æ£€æµ‹ï¼‰</li>
</ul>
<p><strong>æ€§èƒ½ç“¶é¢ˆ</strong></p>
<table>
<thead>
<tr>
<th><strong>åœºæ™¯</strong></th>
<th><strong>ZooKeeper</strong></th>
<th><strong>RocketMQ é€‰æ‹©</strong></th>
</tr>
</thead>
<tbody><tr>
<td><strong>æ³¨å†Œä¸­å¿ƒè¯»å†™é¢‘ç‡</strong></td>
<td>ä½é¢‘ï¼ˆç§’çº§ï¼‰</td>
<td>é«˜é¢‘ï¼ˆæ¯«ç§’çº§ Broker å¿ƒè·³ï¼‰</td>
</tr>
<tr>
<td><strong>èŠ‚ç‚¹è§„æ¨¡</strong></td>
<td>é€‚åˆä¸­å°é›†ç¾¤ï¼ˆ&lt;100 èŠ‚ç‚¹ï¼‰</td>
<td>æ”¯æŒå¤§è§„æ¨¡é›†ç¾¤ï¼ˆæ•°åƒèŠ‚ç‚¹ï¼‰</td>
</tr>
<tr>
<td><strong>ååé‡</strong></td>
<td>å†™æ€§èƒ½å—é™ï¼ˆéœ€å…¨å±€æœ‰åºï¼‰</td>
<td>è‡ªç ” NameServerï¼ˆæ— å¼ºä¸€è‡´æ€§è¦æ±‚ï¼‰</td>
</tr>
</tbody></table>
<p><strong>æ¶æ„ç®€åŒ–</strong></p>
<ul>
<li><strong>NameServer è½»é‡åŒ–</strong>ï¼š<ul>
<li>æ— é€‰ä¸¾æœºåˆ¶ï¼ˆæ‰€æœ‰èŠ‚ç‚¹å¹³ç­‰ï¼‰</li>
<li>æœ€ç»ˆä¸€è‡´æ€§ï¼ˆé€šè¿‡å®šæ—¶å¿ƒè·³ç»´æŠ¤çŠ¶æ€ï¼‰</li>
<li>æ— æŒä¹…åŒ–å­˜å‚¨ï¼ˆé‡å¯åä¾èµ– Broker é‡æ–°æ³¨å†Œï¼‰</li>
</ul>
</li>
<li><strong>é¿å… ZooKeeper çš„ä¾èµ–</strong>ï¼š<ul>
<li>å‡å°‘è¿ç»´å¤æ‚åº¦ï¼ˆæ— éœ€å•ç‹¬ç»´æŠ¤ ZK é›†ç¾¤ï¼‰</li>
<li>é™ä½ç½‘ç»œå¼€é”€ï¼ˆZK çš„ Watcher æœºåˆ¶åœ¨å¤§è§„æ¨¡ä¸‹å‹åŠ›å¤§ï¼‰</li>
</ul>
</li>
</ul>
<p><strong>å®¹ç¾èƒ½åŠ›</strong></p>
<ul>
<li><strong>ZooKeeper</strong><ul>
<li>é›†ç¾¤åŠæ•°ä»¥ä¸ŠèŠ‚ç‚¹å­˜æ´»æ‰å¯ç”¨</li>
<li>è„‘è£‚é—®é¢˜éœ€äººå·¥å¹²é¢„</li>
</ul>
</li>
<li><strong>NameServer</strong><ul>
<li>å•èŠ‚ç‚¹æ•…éšœä¸å½±å“æ•´ä½“æœåŠ¡ï¼ˆæ— çŠ¶æ€ï¼‰</li>
<li>ä»»æ„å­˜æ´»èŠ‚ç‚¹å‡å¯æä¾›æœåŠ¡</li>
</ul>
</li>
</ul>
<p><strong>ä¸šåŠ¡åœºæ™¯é€‚é…</strong></p>
<p>RocketMQ çš„æ ¸å¿ƒéœ€æ±‚</p>
<ul>
<li>å¿«é€Ÿå‘ç° Brokerï¼ˆè·¯ç”±ä¿¡æ¯ï¼‰</li>
<li>å®¹å¿çŸ­æš‚æ•°æ®ä¸ä¸€è‡´ï¼ˆæ¶ˆæ¯é˜Ÿåˆ—åœºæ™¯å¯æ¥å—ï¼‰</li>
<li>ä½å»¶è¿Ÿå“åº”ï¼ˆProducer&#x2F;Consumer é¢‘ç¹æ‹‰å–è·¯ç”±è¡¨ï¼‰</li>
</ul>
<h3 id="ã€ä¸­ç­‰ã€‘RocketMQ-çš„å»¶è¿Ÿæ¶ˆæ¯æ˜¯æ€ä¹ˆå®ç°çš„ï¼Ÿ"><a href="#ã€ä¸­ç­‰ã€‘RocketMQ-çš„å»¶è¿Ÿæ¶ˆæ¯æ˜¯æ€ä¹ˆå®ç°çš„ï¼Ÿ" class="headerlink" title="ã€ä¸­ç­‰ã€‘RocketMQ çš„å»¶è¿Ÿæ¶ˆæ¯æ˜¯æ€ä¹ˆå®ç°çš„ï¼Ÿ"></a>ã€ä¸­ç­‰ã€‘RocketMQ çš„å»¶è¿Ÿæ¶ˆæ¯æ˜¯æ€ä¹ˆå®ç°çš„ï¼Ÿ</h3><p>RocketMQ çš„å»¶è¿Ÿæ¶ˆæ¯é‡‡ç”¨ <strong>å¤šçº§æ—¶é—´è½® + å®šæ—¶ä»»åŠ¡æ‰«æ</strong> å®ç°ï¼Œéå®æ—¶æŠ•é€’è€Œæ˜¯å»¶è¿Ÿè§¦å‘ã€‚</p>
<p><strong>å®ç°æ­¥éª¤</strong></p>
<ol>
<li><p><strong>æ¶ˆæ¯æ ‡è®°</strong></p>
<ul>
<li>Producer å‘é€æ¶ˆæ¯æ—¶æŒ‡å®š <code>delayTimeLevel</code>ï¼ˆå¦‚ <code>3</code> è¡¨ç¤ºå»¶è¿Ÿ 10 ç§’ï¼‰</li>
<li>æ”¯æŒ 18 ä¸ªå›ºå®šå»¶è¿Ÿçº§åˆ«ï¼ˆ1s&#x2F;5s&#x2F;10s&#x2F;30s&#x2F;1mâ€¦2hï¼‰</li>
</ul>
</li>
<li><p><strong>å»¶è¿Ÿå­˜å‚¨</strong></p>
<ul>
<li>Broker å°†å»¶è¿Ÿæ¶ˆæ¯å­˜å…¥ <strong>ä¸“ç”¨ Topic</strong>ï¼ˆ<code>SCHEDULE_TOPIC_XXXX</code>ï¼‰</li>
<li>æŒ‰å»¶è¿Ÿçº§åˆ«åˆ†é˜Ÿåˆ—ï¼ˆå¦‚ <code>delayLevel=3</code> çš„æ¶ˆæ¯å­˜å…¥ <code>SCHEDULE_TOPIC_XXXX</code> çš„ Queue3ï¼‰</li>
</ul>
</li>
<li><p><strong>å®šæ—¶æ‰«æ</strong></p>
<ul>
<li><strong>æ—¶é—´è½®ç®—æ³•</strong> ç®¡ç†å»¶è¿Ÿé˜Ÿåˆ—</li>
<li>æ¯ç§’æ‰«æå¯¹åº”é˜Ÿåˆ—ï¼Œå°†åˆ°æœŸæ¶ˆæ¯ <strong>é‡æ–°æŠ•é€’</strong> åˆ°ç›®æ ‡ Topic</li>
</ul>
</li>
<li><p><strong>æ¶ˆæ¯æŠ•é€’</strong></p>
<ul>
<li>åˆ°æœŸåï¼ŒBroker å°†æ¶ˆæ¯ä»å»¶è¿Ÿ Topic è½¬ç§»åˆ°åŸå§‹ Topic</li>
<li>Consumer æ­£å¸¸æ¶ˆè´¹</li>
</ul>
</li>
</ol>
<p><strong>å…³é”®è®¾è®¡</strong></p>
<table>
<thead>
<tr>
<th><strong>ç»„ä»¶</strong></th>
<th><strong>ä½œç”¨</strong></th>
</tr>
</thead>
<tbody><tr>
<td><strong>ScheduleTopic</strong></td>
<td>å­˜å‚¨æ‰€æœ‰å»¶è¿Ÿæ¶ˆæ¯ï¼ˆå†…éƒ¨ Topicï¼Œå¯¹ç”¨æˆ·é€æ˜ï¼‰</td>
</tr>
<tr>
<td><strong>TimerWheel</strong></td>
<td>é«˜æ•ˆè§¦å‘å»¶è¿Ÿä»»åŠ¡ï¼ˆO(1) æ—¶é—´å¤æ‚åº¦ï¼‰</td>
</tr>
<tr>
<td><strong>å®šæ—¶çº¿ç¨‹</strong></td>
<td>æ¯ç§’æ‰«ææ—¶é—´è½®ï¼Œå°†åˆ°æœŸæ¶ˆæ¯ç§»å‡ºå»¶è¿Ÿé˜Ÿåˆ—</td>
</tr>
</tbody></table>
<p><strong>ç‰¹ç‚¹</strong></p>
<ul>
<li><strong>å›ºå®šå»¶è¿Ÿçº§åˆ«</strong>ï¼šä¸æ”¯æŒä»»æ„æ—¶é—´ç²¾åº¦ï¼ˆå¦‚ 23 ç§’ï¼‰</li>
<li><strong>æŠ•é€’è¯¯å·®</strong>ï¼šÂ±1 ç§’ï¼ˆä¾èµ–æ‰«æé—´éš”ï¼‰</li>
<li><strong>é«˜åå</strong>ï¼šæ—¶é—´è½®ç®—æ³•é¿å…éå†æ‰€æœ‰æ¶ˆæ¯</li>
</ul>
<p><strong>ç¤ºä¾‹ä»£ç </strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Message</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Message</span>(<span class="string">&quot;TestTopic&quot;</span>, <span class="string">&quot;Hello Delay&quot;</span>.getBytes());</span><br><span class="line"><span class="comment">// è®¾ç½®å»¶è¿Ÿçº§åˆ« 3ï¼ˆå¯¹åº” 10 ç§’ï¼‰</span></span><br><span class="line">msg.setDelayTimeLevel(<span class="number">3</span>);</span><br><span class="line">producer.send(msg);</span><br></pre></td></tr></table></figure>

<p><strong>å¯¹æ¯” Kafka</strong></p>
<table>
<thead>
<tr>
<th><strong>ç‰¹æ€§</strong></th>
<th><strong>RocketMQ</strong></th>
<th><strong>Kafka</strong></th>
</tr>
</thead>
<tbody><tr>
<td><strong>å»¶è¿Ÿç²¾åº¦</strong></td>
<td>å›ºå®šçº§åˆ«ï¼ˆ18 ç§ï¼‰</td>
<td>éœ€å¤–éƒ¨å®ç°ï¼ˆå¦‚ Streams å»¶è¿Ÿå¤„ç†ï¼‰</td>
</tr>
<tr>
<td><strong>å®ç°å¤æ‚åº¦</strong></td>
<td>å†…ç½®æ”¯æŒ</td>
<td>éœ€è‡ªå®šä¹‰é€»è¾‘</td>
</tr>
<tr>
<td><strong>é€‚ç”¨åœºæ™¯</strong></td>
<td>è®¢å•è¶…æ—¶ã€å®šæ—¶é€šçŸ¥</td>
<td>æµå¤„ç†ä¸­çš„çª—å£æ“ä½œ</td>
</tr>
</tbody></table>
<p><strong>æ³¨</strong>ï¼šRocketMQ 5.0+ æ”¯æŒ <strong>å®šæ—¶æ¶ˆæ¯</strong>ï¼ˆç²¾ç¡®åˆ°æ¯«ç§’ï¼‰ï¼Œåº•å±‚æ”¹ç”¨æ—¶é—´æˆ³+å“ˆå¸Œåˆ†ç‰‡ã€‚</p>
<h3 id="ã€ä¸­ç­‰ã€‘RocketMQ-å’Œ-Kafka-åœ¨æ¶æ„å’ŒåŠŸèƒ½ä¸Šæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ"><a href="#ã€ä¸­ç­‰ã€‘RocketMQ-å’Œ-Kafka-åœ¨æ¶æ„å’ŒåŠŸèƒ½ä¸Šæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ" class="headerlink" title="ã€ä¸­ç­‰ã€‘RocketMQ å’Œ Kafka åœ¨æ¶æ„å’ŒåŠŸèƒ½ä¸Šæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ"></a>ã€ä¸­ç­‰ã€‘RocketMQ å’Œ Kafka åœ¨æ¶æ„å’ŒåŠŸèƒ½ä¸Šæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ</h3><p>::: info RocketMQ å’Œ Kafka æ¶æ„å¯¹æ¯”</p>
<p>:::</p>
<table>
<thead>
<tr>
<th><strong>ç»´åº¦</strong></th>
<th><strong>RocketMQ</strong></th>
<th><strong>Kafka</strong></th>
</tr>
</thead>
<tbody><tr>
<td><strong>æ³¨å†Œä¸­å¿ƒ</strong></td>
<td>è‡ªç ”è½»é‡çº§ <strong>NameServer</strong>ï¼ˆAP æ¨¡å‹ï¼‰</td>
<td>ä¾èµ– <strong>ZooKeeper</strong>ï¼ˆCP æ¨¡å‹ï¼‰ï¼ŒKafka æ–°ç‰ˆæœ¬è®¡åˆ’ç”¨ KRaft å–ä»£ ZooKeeper</td>
</tr>
<tr>
<td><strong>Broker è§’è‰²</strong></td>
<td>ä¸»ä»æ¶æ„ï¼ˆMaster-Slaveï¼‰</td>
<td>æ— ä¸»ä»åŒºåˆ†ï¼ˆæ‰€æœ‰èŠ‚ç‚¹å¹³ç­‰ï¼‰</td>
</tr>
<tr>
<td><strong>å­˜å‚¨æ¨¡å‹</strong></td>
<td>å•ä¸ª CommitLog æ–‡ä»¶ï¼ˆå«æ‰€æœ‰ Topic æ•°æ®ï¼‰ + æ¶ˆè´¹é˜Ÿåˆ—ç´¢å¼•</td>
<td><strong>ä¸»é¢˜-åˆ†åŒº-æ®µ</strong>çš„å±‚çº§ç»“æ„</td>
</tr>
<tr>
<td><strong>æ¶ˆè´¹æ¨¡å¼</strong></td>
<td>æ”¯æŒ Push&#x2F;Pull ä¸¤ç§æ¨¡å¼</td>
<td>ä»… Pull æ¨¡å¼</td>
</tr>
</tbody></table>
<p>::: info RocketMQ å’Œ Kafka åŠŸèƒ½å¯¹æ¯”</p>
<p>:::</p>
<p>è®¾è®¡å·®å¼‚ï¼š</p>
<ul>
<li><strong>RocketMQ</strong>ï¼š<ul>
<li><strong>ä¸šåŠ¡å‹å¥½</strong>ï¼šå¼ºäº‹åŠ¡ã€å»¶è¿Ÿæ¶ˆæ¯ã€è¿‡æ»¤ç­‰å¼€ç®±å³ç”¨</li>
<li><strong>è½»é‡å¯æ§</strong>ï¼šNameServer ç®€åŒ–é›†ç¾¤ç®¡ç†</li>
</ul>
</li>
<li><strong>Kafka</strong>ï¼š<ul>
<li><strong>æµå¼ä¼˜å…ˆ</strong>ï¼šé«˜ååã€åˆ†åŒºå¼¹æ€§ä¼¸ç¼©</li>
<li><strong>ç”Ÿæ€æ•´åˆ</strong>ï¼šä¸ Flink&#x2F;Spark ç­‰æ·±åº¦å…¼å®¹</li>
</ul>
</li>
</ul>
<p>ä¸»è¦åŠŸèƒ½å·®å¼‚å¦‚ä¸‹ï¼š</p>
<table>
<thead>
<tr>
<th><strong>åŠŸèƒ½</strong></th>
<th><strong>RocketMQ</strong></th>
<th><strong>Kafka</strong></th>
</tr>
</thead>
<tbody><tr>
<td><strong>æ¶ˆæ¯ç±»å‹</strong></td>
<td>æ™®é€šæ¶ˆæ¯ã€é¡ºåºæ¶ˆæ¯ã€äº‹åŠ¡æ¶ˆæ¯ã€å»¶è¿Ÿæ¶ˆæ¯</td>
<td>ä¸»è¦æ”¯æŒæ™®é€šæ¶ˆæ¯ï¼ˆéœ€æ‰©å±•å®ç°å…¶ä»–ç‰¹æ€§ï¼‰</td>
</tr>
<tr>
<td><strong>äº‹åŠ¡æ”¯æŒ</strong></td>
<td>äºŒé˜¶æ®µæäº¤+äº‹åŠ¡å›æŸ¥ï¼ˆä¸šåŠ¡çº§äº‹åŠ¡ï¼‰</td>
<td>ç²¾ç¡®ä¸€æ¬¡è¯­ä¹‰ï¼ˆå†…éƒ¨æ¶ˆæ¯äº‹åŠ¡ï¼‰</td>
</tr>
<tr>
<td><strong>å»¶è¿Ÿæ¶ˆæ¯</strong></td>
<td>å†…ç½® 18 ä¸ªå›ºå®šå»¶è¿Ÿçº§åˆ«</td>
<td>éœ€å¤–éƒ¨å®ç°ï¼ˆå¦‚æµå¤„ç†æˆ–è‡ªå®šä¹‰è°ƒåº¦ï¼‰</td>
</tr>
<tr>
<td><strong>æ¶ˆæ¯å›æº¯</strong></td>
<td>æ”¯æŒæŒ‰æ—¶é—´&#x2F;åç§»é‡å›æº¯</td>
<td>ä»…æ”¯æŒæŒ‰åç§»é‡å›æº¯</td>
</tr>
<tr>
<td><strong>æ¶ˆæ¯è¿‡æ»¤</strong></td>
<td>æ”¯æŒç»™ Topic æ‰“æ ‡ç­¾ï¼Œè¿›ä¸€æ­¥åˆ†ç±»</td>
<td>ä»…æ”¯æŒé€šè¿‡ Topic ç»™æ¶ˆæ¯åˆ†ç±»</td>
</tr>
<tr>
<td><strong>æ­»ä¿¡é˜Ÿåˆ—</strong></td>
<td>æ¶ˆæ¯æ¶ˆè´¹é‡è¯•å¤±è´¥å¤šæ¬¡åï¼Œè¿›å…¥æ­»ä¿¡é˜Ÿåˆ—</td>
<td>Kafka åŸç”Ÿä¸æ”¯æŒ</td>
</tr>
</tbody></table>
<p>::: info RocketMQ å’Œ Kafka æ€§èƒ½ä¸æ‰©å±•å¯¹æ¯”</p>
<p>:::</p>
<table>
<thead>
<tr>
<th><strong>ç»´åº¦</strong></th>
<th><strong>RocketMQ</strong></th>
<th><strong>Kafka</strong></th>
</tr>
</thead>
<tbody><tr>
<td><strong>ååé‡</strong></td>
<td>å•æœºçº¦ 10 ä¸‡ TPS</td>
<td>å•æœºå¯è¾¾ç™¾ä¸‡ TPSï¼ˆæ›´é«˜ååï¼‰</td>
</tr>
<tr>
<td><strong>å»¶è¿Ÿ</strong></td>
<td>æ¯«ç§’çº§ï¼ˆä¼˜åŒ–åæ›´ä½ï¼‰</td>
<td>æ¯«ç§’çº§ï¼ˆä¾èµ– PageCacheï¼‰</td>
</tr>
<tr>
<td><strong>æ°´å¹³æ‰©å±•</strong></td>
<td>éœ€æ‰‹åŠ¨è°ƒæ•´é˜Ÿåˆ—æ•°</td>
<td>åˆ†åŒºè‡ªåŠ¨å‡è¡¡ï¼ˆæ›´æ˜“æ‰©å±•ï¼‰</td>
</tr>
<tr>
<td><strong>æ•°æ®ä¿ç•™</strong></td>
<td>åŸºäºæ—¶é—´&#x2F;å¤§å°ç­–ç•¥</td>
<td>åŸºäºæ—¶é—´&#x2F;å¤§å°ç­–ç•¥ï¼ˆæ”¯æŒæ—¥å¿—å‹ç¼©ï¼‰</td>
</tr>
</tbody></table>
<p>::: info RocketMQ å’Œ Kafka åº”ç”¨åœºæ™¯ä¸é€‰å‹</p>
<p>:::</p>
<table>
<thead>
<tr>
<th><strong>åœºæ™¯</strong></th>
<th><strong>RocketMQ</strong></th>
<th><strong>Kafka</strong></th>
</tr>
</thead>
<tbody><tr>
<td><strong>ç”µå•†&#x2F;é‡‘èä¸šåŠ¡</strong></td>
<td>è®¢å•ã€æ”¯ä»˜ç­‰ä¸šåŠ¡çº§äº‹åŠ¡</td>
<td>æ—¥å¿—æ”¶é›†ã€æµå¤„ç†ï¼ˆå¦‚ Flinkï¼‰</td>
</tr>
<tr>
<td><strong>å»¶è¿Ÿ&#x2F;å®šæ—¶ä»»åŠ¡</strong></td>
<td>å†…ç½®æ”¯æŒï¼ˆå¦‚è®¢å•è¶…æ—¶ï¼‰</td>
<td>éœ€å¤–éƒ¨ç³»ç»Ÿé…åˆ</td>
</tr>
<tr>
<td><strong>å¤§è§„æ¨¡æ—¥å¿—æµ</strong></td>
<td>é€‚åˆä¸­å°è§„æ¨¡</td>
<td>è¶…å¤§è§„æ¨¡æ—¥å¿—åœºæ™¯ï¼ˆå¦‚å¤§æ•°æ®ç®¡é“ï¼‰</td>
</tr>
<tr>
<td><strong>å¤šåè®®æ”¯æŒ</strong></td>
<td>å…¼å®¹ JMSã€MQTT ç­‰</td>
<td>ä»…åŸç”Ÿåè®®</td>
</tr>
</tbody></table>
<p><strong>æ€»ç»“é€‰æ‹©å»ºè®®</strong>ï¼š</p>
<ul>
<li>é€‰ <strong>RocketMQ</strong>ï¼šéœ€è¦ <strong>ä¸šåŠ¡çº§äº‹åŠ¡ã€å»¶è¿Ÿæ¶ˆæ¯ã€å¤šåè®®æ”¯æŒ</strong> çš„åœºæ™¯</li>
<li>é€‰ <strong>Kafka</strong>ï¼šéœ€è¦ <strong>è¶…é«˜ååã€æµå¤„ç†é›†æˆã€å¤§è§„æ¨¡æ—¥å¿—</strong> çš„åœºæ™¯</li>
</ul>
<h3 id="ã€å›°éš¾ã€‘RocketMQ-å¦‚ä½•å®ç°äº‹åŠ¡æ¶ˆæ¯ï¼Ÿ"><a href="#ã€å›°éš¾ã€‘RocketMQ-å¦‚ä½•å®ç°äº‹åŠ¡æ¶ˆæ¯ï¼Ÿ" class="headerlink" title="ã€å›°éš¾ã€‘RocketMQ å¦‚ä½•å®ç°äº‹åŠ¡æ¶ˆæ¯ï¼Ÿ"></a>ã€å›°éš¾ã€‘RocketMQ å¦‚ä½•å®ç°äº‹åŠ¡æ¶ˆæ¯ï¼Ÿ</h3><p>RocketMQ äº‹åŠ¡æ¶ˆæ¯é‡‡ç”¨ <strong>â€œåŠæ¶ˆæ¯ï¼ˆHalf Messageï¼‰ + äº‹åŠ¡çŠ¶æ€å›æŸ¥â€</strong> çš„äºŒé˜¶æ®µæ–¹æ¡ˆï¼Œç¡®ä¿åˆ†å¸ƒå¼äº‹åŠ¡çš„æœ€ç»ˆä¸€è‡´æ€§ã€‚</p>
<p><strong>å…³é”®æµç¨‹</strong></p>
<ol>
<li><p><strong>ç¬¬ä¸€é˜¶æ®µï¼šå‘é€åŠæ¶ˆæ¯</strong></p>
<ul>
<li>Producer å‘é€<strong>åŠæ¶ˆæ¯</strong>ï¼ˆå¯¹ Consumer ä¸å¯è§ï¼‰</li>
<li>Broker æŒä¹…åŒ–æ¶ˆæ¯å¹¶è¿”å›ç¡®è®¤å“åº”</li>
<li>Producer æ‰§è¡Œ<strong>æœ¬åœ°äº‹åŠ¡</strong>ï¼ˆå¦‚æ•°æ®åº“æ“ä½œï¼‰</li>
</ul>
</li>
<li><p><strong>ç¬¬äºŒé˜¶æ®µï¼šäº‹åŠ¡çŠ¶æ€ç¡®è®¤</strong></p>
<ul>
<li><strong>æˆåŠŸ</strong>ï¼šProducer æäº¤äº‹åŠ¡ç¡®è®¤ â†’ Broker å°†æ¶ˆæ¯æ”¹ä¸ºå¯æ¶ˆè´¹çŠ¶æ€</li>
<li><strong>å¤±è´¥</strong>ï¼šProducer å›æ»š â†’ Broker ä¸¢å¼ƒæ¶ˆæ¯</li>
<li><strong>è¶…æ—¶æœªå†³</strong>ï¼šBroker ä¸»åŠ¨å›æŸ¥ Producer çš„äº‹åŠ¡çŠ¶æ€ï¼ˆé»˜è®¤æ¯åˆ†é’Ÿ 1 æ¬¡ï¼‰</li>
</ul>
</li>
<li><p><strong>æ¶ˆæ¯æŠ•é€’</strong></p>
<ul>
<li>ä»…æäº¤åçš„æ¶ˆæ¯ä¼šè¢« Consumer æ¶ˆè´¹</li>
<li>æ”¯æŒæ¶ˆæ¯é‡è¯•å’Œæ­»ä¿¡é˜Ÿåˆ—æœºåˆ¶</li>
</ul>
</li>
</ol>
<p><strong>æ ¸å¿ƒç»„ä»¶</strong></p>
<ul>
<li><strong>äº‹åŠ¡ç›‘å¬å™¨</strong>ï¼ˆTransactionListenerï¼‰ï¼šå®ç°æœ¬åœ°äº‹åŠ¡æ‰§è¡Œå’Œå›æŸ¥é€»è¾‘</li>
<li><strong>äº‹åŠ¡æ—¥å¿—å­˜å‚¨</strong>ï¼šBroker å­˜å‚¨åŠæ¶ˆæ¯å’Œäº‹åŠ¡çŠ¶æ€ï¼ˆåŸºäºæ–‡ä»¶æˆ– DBï¼‰</li>
<li><strong>å®šæ—¶å›æŸ¥çº¿ç¨‹</strong>ï¼šå¤„ç†è¶…æ—¶æœªç¡®è®¤çš„äº‹åŠ¡</li>
</ul>
<p><strong>ç‰¹ç‚¹</strong></p>
<ul>
<li><strong>æœ€ç»ˆä¸€è‡´æ€§</strong>ï¼šä¾èµ–å®šæœŸå›æŸ¥æœºåˆ¶</li>
<li><strong>ä¸šåŠ¡è€¦åˆ</strong>ï¼šéœ€å®ç°æœ¬åœ°äº‹åŠ¡å’Œå›æŸ¥æ¥å£</li>
<li><strong>é«˜å¯ç”¨</strong>ï¼šBroker é›†ç¾¤ä¿è¯æ¶ˆæ¯ä¸ä¸¢å¤±</li>
</ul>
<p><strong>åº”ç”¨åœºæ™¯</strong></p>
<ul>
<li>è®¢å•æ”¯ä»˜ï¼ˆæ‰£åº“å­˜+ç”Ÿæˆè®¢å•ï¼‰</li>
<li>è·¨ç³»ç»Ÿæ•°æ®åŒæ­¥</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç¤ºä¾‹ï¼šäº‹åŠ¡ç”Ÿäº§è€…</span></span><br><span class="line"><span class="type">TransactionMQProducer</span> <span class="variable">producer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransactionMQProducer</span>();</span><br><span class="line">producer.setTransactionListener(<span class="keyword">new</span> <span class="title class_">TransactionListener</span>() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> LocalTransactionState <span class="title function_">executeLocalTransaction</span><span class="params">(Message msg, Object arg)</span> &#123;</span><br><span class="line">        <span class="comment">// æ‰§è¡Œæœ¬åœ°äº‹åŠ¡</span></span><br><span class="line">        <span class="keyword">return</span> LocalTransactionState.COMMIT_MESSAGE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> LocalTransactionState <span class="title function_">checkLocalTransaction</span><span class="params">(MessageExt msg)</span> &#123;</span><br><span class="line">        <span class="comment">// äº‹åŠ¡çŠ¶æ€å›æŸ¥</span></span><br><span class="line">        <span class="keyword">return</span> LocalTransactionState.UNKNOW;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h2 id="RabbitMQ"><a href="#RabbitMQ" class="headerlink" title="RabbitMQ"></a>RabbitMQ</h2><h3 id="ã€ç®€å•ã€‘RabbitMQ-çš„-routing-key-å’Œ-binding-key-çš„æœ€å¤§é•¿åº¦æ˜¯å¤šå°‘å­—èŠ‚ï¼Ÿ"><a href="#ã€ç®€å•ã€‘RabbitMQ-çš„-routing-key-å’Œ-binding-key-çš„æœ€å¤§é•¿åº¦æ˜¯å¤šå°‘å­—èŠ‚ï¼Ÿ" class="headerlink" title="ã€ç®€å•ã€‘RabbitMQ çš„ routing key å’Œ binding key çš„æœ€å¤§é•¿åº¦æ˜¯å¤šå°‘å­—èŠ‚ï¼Ÿ"></a>ã€ç®€å•ã€‘RabbitMQ çš„ routing key å’Œ binding key çš„æœ€å¤§é•¿åº¦æ˜¯å¤šå°‘å­—èŠ‚ï¼Ÿ</h3><p><strong>é•¿åº¦é™åˆ¶</strong></p>
<ul>
<li><strong>æœ€å¤§ 255 å­—èŠ‚</strong>ï¼ˆè¶…é™ä¼šæŠ›å‡ºå¼‚å¸¸ï¼‰ã€‚</li>
<li>é€‚ç”¨äº <strong>Routing Key</strong>ï¼ˆç”Ÿäº§è€…æŒ‡å®šï¼‰å’Œ <strong>Binding Key</strong>ï¼ˆé˜Ÿåˆ—ç»‘å®šäº¤æ¢æœºæ—¶æŒ‡å®šï¼‰ã€‚</li>
</ul>
<p><strong>åŒ¹é…è§„åˆ™ï¼ˆä¸åŒäº¤æ¢æœºç±»å‹ï¼‰</strong></p>
<table>
<thead>
<tr>
<th><strong>äº¤æ¢æœºç±»å‹</strong></th>
<th><strong>åŒ¹é…æ–¹å¼</strong></th>
<th><strong>ç¤ºä¾‹</strong></th>
</tr>
</thead>
<tbody><tr>
<td><strong>Direct</strong></td>
<td>å®Œå…¨åŒ¹é…</td>
<td><code>routing_key == binding_key</code></td>
</tr>
<tr>
<td><strong>Topic</strong></td>
<td>é€šé…ç¬¦åŒ¹é…ï¼ˆ<code>*</code> åŒ¹é…ä¸€ä¸ªè¯ï¼Œ<code>#</code> åŒ¹é…å¤šä¸ªè¯ï¼‰</td>
<td><code>*.order.#</code> åŒ¹é… <code>user.order.create</code></td>
</tr>
<tr>
<td><strong>Headers</strong></td>
<td>ä¸ä¾èµ– Routing Keyï¼ŒåŸºäºæ¶ˆæ¯å¤´é”®å€¼å¯¹åŒ¹é…</td>
<td><code>x-match: all/any</code></td>
</tr>
</tbody></table>
<p><strong>æœ€ä½³å®è·µ</strong></p>
<ul>
<li><strong>ä¿æŒç®€çŸ­</strong>ï¼šé¿å…æ¥è¿‘ 255 å­—èŠ‚ï¼Œæå‡æ€§èƒ½ã€‚</li>
<li><strong>å‘½åè§„èŒƒ</strong>ï¼šå¦‚ <code>&#123;æœåŠ¡&#125;.&#123;æ¨¡å—&#125;.&#123;äº‹ä»¶&#125;</code>ï¼ˆä¾‹ï¼š<code>user.order.paid</code>ï¼‰ã€‚</li>
<li><strong>Topic é€šé…ç¬¦</strong>ï¼šåˆç†ä½¿ç”¨ <code>*</code> å’Œ <code>#</code>ï¼Œé¿å…è¿‡åº¦å¤æ‚ã€‚</li>
</ul>
<blockquote>
<p>âš ï¸ <strong>æ³¨æ„</strong>ï¼šHeaders äº¤æ¢æœºå¿½ç•¥ Routing Keyï¼Œä»…ä¾èµ–æ¶ˆæ¯å¤´ï¼ˆHeadersï¼‰åŒ¹é…ã€‚</p>
</blockquote>
<h3 id="ã€ä¸­ç­‰ã€‘RabbitMQ-ä¸­æ— æ³•è·¯ç”±çš„æ¶ˆæ¯ä¼šå»åˆ°å“ªé‡Œï¼Ÿ"><a href="#ã€ä¸­ç­‰ã€‘RabbitMQ-ä¸­æ— æ³•è·¯ç”±çš„æ¶ˆæ¯ä¼šå»åˆ°å“ªé‡Œï¼Ÿ" class="headerlink" title="ã€ä¸­ç­‰ã€‘RabbitMQ ä¸­æ— æ³•è·¯ç”±çš„æ¶ˆæ¯ä¼šå»åˆ°å“ªé‡Œï¼Ÿ"></a>ã€ä¸­ç­‰ã€‘RabbitMQ ä¸­æ— æ³•è·¯ç”±çš„æ¶ˆæ¯ä¼šå»åˆ°å“ªé‡Œï¼Ÿ</h3><p>åœ¨ RabbitMQ ä¸­ï¼Œ<strong>æ— æ³•è·¯ç”±çš„æ¶ˆæ¯</strong>ï¼ˆå³æ— æ³•è¢«æŠ•é€’åˆ°ä»»ä½•é˜Ÿåˆ—çš„æ¶ˆæ¯ï¼‰çš„å¤„ç†æ–¹å¼å–å†³äºæ¶ˆæ¯çš„ <strong><code>mandatory</code> å’Œ <code>immediate</code> å±æ€§</strong>ï¼ˆRabbitMQ 3.0+ å·²å¼ƒç”¨ <code>immediate</code>ï¼‰ï¼Œå…·ä½“è§„åˆ™å¦‚ä¸‹ï¼š</p>
<p><strong>é»˜è®¤æƒ…å†µï¼ˆæœªè®¾ç½® <code>mandatory</code>ï¼‰</strong></p>
<ul>
<li><strong>æ¶ˆæ¯è¢«ç›´æ¥ä¸¢å¼ƒ</strong>ï¼ˆå³ â€œé™é»˜ä¸¢å¤±â€ï¼‰ã€‚</li>
<li><strong>ç”Ÿäº§è€…æ— æ„ŸçŸ¥</strong>ï¼šBroker ä¸ä¼šè¿”å›ä»»ä½•é€šçŸ¥ã€‚</li>
</ul>
<p><strong>è®¾ç½®äº† <code>mandatory=true</code></strong></p>
<ul>
<li><p>è‹¥æ¶ˆæ¯æ— æ³•è·¯ç”±åˆ°ä»»ä½•é˜Ÿåˆ—ï¼ŒBroker ä¼šé€šè¿‡ <strong><code>basic.return</code></strong> æ–¹æ³•å°†æ¶ˆæ¯è¿”å›ç»™ç”Ÿäº§è€…ã€‚</p>
</li>
<li><p><strong>ç”Ÿäº§è€…éœ€ç›‘å¬è¿”å›æ¶ˆæ¯</strong>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">channel.basicPublish(<span class="string">&quot;exchange&quot;</span>, <span class="string">&quot;routingKey&quot;</span>,</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">AMQP</span>.BasicProperties.Builder().mandatory(<span class="literal">true</span>).build(),</span><br><span class="line">    message.getBytes());</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ·»åŠ  ReturnListener ç›‘å¬è¿”å›æ¶ˆæ¯</span></span><br><span class="line">channel.addReturnListener((replyCode, replyText, exchange, routingKey, properties, body) -&gt; &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;æ¶ˆæ¯æœªè¢«è·¯ç”±ï¼š&quot;</span> + <span class="keyword">new</span> <span class="title class_">String</span>(body));</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>é€‚ç”¨åœºæ™¯</strong>ï¼šéœ€ä¸¥æ ¼ç¡®ä¿æ¶ˆæ¯è·¯ç”±æˆåŠŸçš„ä¸šåŠ¡ï¼ˆå¦‚å…³é”®è®¢å•é€šçŸ¥ï¼‰ã€‚</p>
</li>
</ul>
<p><strong>å¤‡ç”¨äº¤æ¢æœºï¼ˆAlternate Exchangeï¼‰</strong></p>
<ul>
<li><p><strong>é¢„å…ˆå£°æ˜ä¸€ä¸ªå¤‡ç”¨äº¤æ¢æœº</strong>ï¼Œç»‘å®šä¸€ä¸ªé˜Ÿåˆ—ï¼ˆå¦‚ <code>unrouted_queue</code>ï¼‰æ¥æ”¶æ— æ³•è·¯ç”±çš„æ¶ˆæ¯ã€‚</p>
</li>
<li><p><strong>é…ç½®æ–¹å¼</strong>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;String, Object&gt; args = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">args.put(<span class="string">&quot;alternate-exchange&quot;</span>, <span class="string">&quot;my_ae&quot;</span>); <span class="comment">// æŒ‡å®šå¤‡ç”¨äº¤æ¢æœº</span></span><br><span class="line">channel.exchangeDeclare(<span class="string">&quot;main_exchange&quot;</span>, <span class="string">&quot;direct&quot;</span>, <span class="literal">false</span>, <span class="literal">false</span>, args);</span><br><span class="line"></span><br><span class="line"><span class="comment">// å£°æ˜å¤‡ç”¨äº¤æ¢æœºå’Œé˜Ÿåˆ—</span></span><br><span class="line">channel.exchangeDeclare(<span class="string">&quot;my_ae&quot;</span>, <span class="string">&quot;fanout&quot;</span>);</span><br><span class="line">channel.queueDeclare(<span class="string">&quot;unrouted_queue&quot;</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">channel.queueBind(<span class="string">&quot;unrouted_queue&quot;</span>, <span class="string">&quot;my_ae&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>é€»è¾‘</strong>ï¼šè‹¥æ¶ˆæ¯æ— æ³•é€šè¿‡ <code>main_exchange</code> è·¯ç”±ï¼Œåˆ™è‡ªåŠ¨è½¬å‘åˆ° <code>my_ae</code>ï¼Œæœ€ç»ˆè¿›å…¥ <code>unrouted_queue</code>ã€‚</p>
</li>
</ul>
<p><strong>å…³é”®åŒºåˆ«</strong></p>
<table>
<thead>
<tr>
<th>å¤„ç†æ–¹å¼</th>
<th>æ¡ä»¶</th>
<th>ç»“æœ</th>
<th>é€‚ç”¨åœºæ™¯</th>
</tr>
</thead>
<tbody><tr>
<td><strong>ç›´æ¥ä¸¢å¼ƒ</strong></td>
<td>é»˜è®¤æƒ…å†µ</td>
<td>æ¶ˆæ¯ä¸¢å¤±ï¼Œæ— é€šçŸ¥</td>
<td>å…è®¸æ¶ˆæ¯ä¸¢å¤±çš„éå…³é”®ä¸šåŠ¡</td>
</tr>
<tr>
<td><strong>è¿”å›ç”Ÿäº§è€…</strong></td>
<td><code>mandatory=true</code></td>
<td>é€šè¿‡ <code>basic.return</code> å›é€€æ¶ˆæ¯</td>
<td>éœ€ä¸¥æ ¼ç›‘æ§è·¯ç”±å¤±è´¥çš„åœºæ™¯</td>
</tr>
<tr>
<td><strong>è½¬å‘åˆ°å¤‡ç”¨äº¤æ¢æœº</strong></td>
<td>é…ç½®äº† Alternate Exchange</td>
<td>æ¶ˆæ¯å­˜å…¥å¤‡ç”¨é˜Ÿåˆ—</td>
<td>éœ€å®¡è®¡æˆ–è¡¥å¿æ— æ³•è·¯ç”±çš„æ¶ˆæ¯</td>
</tr>
</tbody></table>
<p><strong>æœ€ä½³å®è·µ</strong></p>
<ul>
<li><strong>å…³é”®æ¶ˆæ¯</strong>ï¼šå§‹ç»ˆè®¾ç½® <code>mandatory=true</code> å¹¶ç›‘å¬ <code>basic.return</code>ã€‚</li>
<li><strong>æ—¥å¿—ä¸ç›‘æ§</strong>ï¼šä½¿ç”¨å¤‡ç”¨äº¤æ¢æœºæ”¶é›†æ— æ³•è·¯ç”±çš„æ¶ˆæ¯ï¼Œä¾¿äºæ’æŸ¥é—®é¢˜ã€‚</li>
<li><strong>é¿å…æ¶ˆæ¯ä¸¢å¤±</strong>ï¼šç¡®ä¿äº¤æ¢æœºå’Œé˜Ÿåˆ—çš„ç»‘å®šå…³ç³»æ­£ç¡®ï¼Œæˆ–ä½¿ç”¨ <strong>æ­»ä¿¡é˜Ÿåˆ—ï¼ˆDLXï¼‰</strong> å¤„ç†å¼‚å¸¸æ¶ˆæ¯ã€‚</li>
</ul>
<blockquote>
<p>ğŸ“Œ <strong>æ³¨æ„</strong>ï¼šRabbitMQ 3.0+ å·²ç§»é™¤ <code>immediate</code> å‚æ•°ï¼Œæ—§ç‰ˆæœ¬ä¸­è®¾ç½® <code>immediate=true</code> ä¼šå¯¼è‡´æ— æ³•è·¯ç”±çš„æ¶ˆæ¯è¢«ä¸¢å¼ƒï¼ˆé™¤éåŒæ—¶è®¾ç½® <code>mandatory</code>ï¼‰ã€‚</p>
</blockquote>
<h3 id="ã€ä¸­ç­‰ã€‘RabbitMQ-ä¸­æ¶ˆæ¯ä»€ä¹ˆæ—¶å€™ä¼šè¿›å…¥æ­»ä¿¡äº¤æ¢æœºï¼Ÿ"><a href="#ã€ä¸­ç­‰ã€‘RabbitMQ-ä¸­æ¶ˆæ¯ä»€ä¹ˆæ—¶å€™ä¼šè¿›å…¥æ­»ä¿¡äº¤æ¢æœºï¼Ÿ" class="headerlink" title="ã€ä¸­ç­‰ã€‘RabbitMQ ä¸­æ¶ˆæ¯ä»€ä¹ˆæ—¶å€™ä¼šè¿›å…¥æ­»ä¿¡äº¤æ¢æœºï¼Ÿ"></a>ã€ä¸­ç­‰ã€‘RabbitMQ ä¸­æ¶ˆæ¯ä»€ä¹ˆæ—¶å€™ä¼šè¿›å…¥æ­»ä¿¡äº¤æ¢æœºï¼Ÿ</h3><p>é€šè¿‡åˆç†é…ç½® DLXï¼Œå¯ä»¥å®ç°æ¶ˆæ¯çš„ä¼˜é›…é™çº§å’Œæ•…éšœéš”ç¦»ã€‚</p>
<p>::: info RabbitMQ ä¸­æ¶ˆæ¯è¿›å…¥æ­»ä¿¡äº¤æ¢æœºçš„è§¦å‘æƒ…å†µ</p>
<p>:::</p>
<p>åœ¨ RabbitMQ ä¸­ï¼Œæ¶ˆæ¯è¿›å…¥ <strong>æ­»ä¿¡äº¤æ¢æœºï¼ˆDead Letter Exchange, DLXï¼‰</strong> é€šå¸¸ç”±ä»¥ä¸‹ <strong>5 ç§æƒ…å†µ</strong>è§¦å‘ï¼š</p>
<p><strong>ï¼ˆ1ï¼‰æ¶ˆæ¯è¢«æ¶ˆè´¹è€…æ‹’ç»</strong>ï¼šæ¶ˆè´¹è€…æ˜¾å¼æ‹’ç»æ¶ˆæ¯ä¸”ä¸é‡æ–°å…¥é˜Ÿã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">channel.basicReject(deliveryTag, <span class="literal">false</span>); <span class="comment">// æˆ– basicNack ä¸” requeue=false</span></span><br></pre></td></tr></table></figure>

<ul>
<li><strong>å…¸å‹åœºæ™¯</strong>ï¼šæ¶ˆæ¯å¤„ç†å¤±è´¥ä¸”æ— éœ€é‡è¯•ï¼ˆå¦‚ä¸šåŠ¡æ ¡éªŒä¸é€šè¿‡ï¼‰ã€‚</li>
</ul>
<p><strong>ï¼ˆ2ï¼‰æ¶ˆæ¯è¿‡æœŸï¼ˆTTL è¶…æ—¶ï¼‰</strong>ï¼š</p>
<ul>
<li>æ¶ˆæ¯è®¾ç½®äº† <strong>TTLï¼ˆTime-To-Liveï¼‰</strong>ï¼Œä¸”æœªåœ¨è¿‡æœŸå‰è¢«æ¶ˆè´¹ã€‚</li>
<li>é˜Ÿåˆ—è®¾ç½®äº† <code>x-message-ttl</code>ï¼Œæ¶ˆæ¯åœ¨é˜Ÿåˆ—ä¸­åœç•™è¶…æ—¶ã€‚</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è®¾ç½®æ¶ˆæ¯ TTL</span></span><br><span class="line">AMQP.<span class="type">BasicProperties</span> <span class="variable">props</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AMQP</span>.BasicProperties.Builder()</span><br><span class="line">    .expiration(<span class="string">&quot;60000&quot;</span>) <span class="comment">// 60 ç§’è¿‡æœŸ</span></span><br><span class="line">    .build();</span><br><span class="line">channel.basicPublish(<span class="string">&quot;&quot;</span>, <span class="string">&quot;normal_queue&quot;</span>, props, message.getBytes());</span><br></pre></td></tr></table></figure>

<p><strong>ï¼ˆ3ï¼‰é˜Ÿåˆ—è¾¾åˆ°æœ€å¤§é•¿åº¦</strong>ï¼šé˜Ÿåˆ—è®¾ç½®äº† <code>x-max-length</code> æˆ– <code>x-max-length-bytes</code>ï¼Œä¸”æ–°æ¶ˆæ¯åˆ°è¾¾æ—¶é˜Ÿåˆ—å·²æ»¡ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å£°æ˜é˜Ÿåˆ—æ—¶è®¾ç½®æœ€å¤§é•¿åº¦</span></span><br><span class="line">Map&lt;String, Object&gt; args = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">args.put(<span class="string">&quot;x-max-length&quot;</span>, <span class="number">1000</span>); <span class="comment">// æœ€å¤š 1000 æ¡æ¶ˆæ¯</span></span><br><span class="line">channel.queueDeclare(<span class="string">&quot;normal_queue&quot;</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">false</span>, args);</span><br></pre></td></tr></table></figure>

<p><strong>ï¼ˆ4ï¼‰é˜Ÿåˆ—è¢«åˆ é™¤</strong>ï¼šæ¶ˆæ¯æ‰€åœ¨çš„é˜Ÿåˆ—è¢«åˆ é™¤ï¼ˆ<code>queueDelete</code>ï¼‰ï¼Œä¸”æ¶ˆæ¯æœªè¢«æ¶ˆè´¹ã€‚</p>
<p><strong>ï¼ˆ5ï¼‰ä¸»èŠ‚ç‚¹å´©æºƒ</strong>ï¼š<strong>é•œåƒé˜Ÿåˆ—ï¼ˆMirrored Queueï¼‰</strong> ä¸­ä¸»èŠ‚ç‚¹å´©æºƒï¼Œä¸”æ¶ˆæ¯æœªåŒæ­¥åˆ°ä»èŠ‚ç‚¹ã€‚</p>
<p>::: info å…³é”®é…ç½®æ­¥éª¤</p>
<p>:::</p>
<ol>
<li><p><strong>å£°æ˜æ­»ä¿¡äº¤æ¢æœºï¼ˆDLXï¼‰å’Œæ­»ä¿¡é˜Ÿåˆ—</strong>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å£°æ˜æ­»ä¿¡äº¤æ¢æœºï¼ˆç±»å‹é€šå¸¸ä¸º direct/fanoutï¼‰</span></span><br><span class="line">channel.exchangeDeclare(<span class="string">&quot;dlx_exchange&quot;</span>, <span class="string">&quot;direct&quot;</span>);</span><br><span class="line"><span class="comment">// å£°æ˜æ­»ä¿¡é˜Ÿåˆ—</span></span><br><span class="line">channel.queueDeclare(<span class="string">&quot;dlx_queue&quot;</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">channel.queueBind(<span class="string">&quot;dlx_queue&quot;</span>, <span class="string">&quot;dlx_exchange&quot;</span>, <span class="string">&quot;dlx_routing_key&quot;</span>);</span><br></pre></td></tr></table></figure></li>
</ol>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="number">2.</span> **ä¸ºæ™®é€šé˜Ÿåˆ—ç»‘å®šæ­»ä¿¡äº¤æ¢æœº**ï¼š</span><br><span class="line"></span><br><span class="line">   ```java</span><br><span class="line">   Map&lt;String, Object&gt; <span class="keyword">args</span> = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">   <span class="keyword">args</span>.put(<span class="string">&quot;x-dead-letter-exchange&quot;</span>, <span class="string">&quot;dlx_exchange&quot;</span>); <span class="comment">// æŒ‡å®š DLX</span></span><br><span class="line">   <span class="keyword">args</span>.put(<span class="string">&quot;x-dead-letter-routing-key&quot;</span>, <span class="string">&quot;dlx_routing_key&quot;</span>); <span class="comment">// å¯é€‰</span></span><br><span class="line">   channel.queueDeclare(<span class="string">&quot;normal_queue&quot;</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="keyword">args</span>);</span><br></pre></td></tr></table></figure>

<p><strong>æ³¨æ„äº‹é¡¹</strong></p>
<ul>
<li>æ­»ä¿¡æ¶ˆæ¯çš„ <strong>åŸå§‹å±æ€§</strong>ï¼ˆå¦‚ headersï¼‰ä¼šè¢«ä¿ç•™ï¼Œä½† <code>exchange</code> å’Œ <code>routingKey</code> ä¼šè¢«æ›¿æ¢ä¸º DLX çš„é…ç½®ã€‚</li>
<li>è‹¥æœªæŒ‡å®š <code>x-dead-letter-routing-key</code>ï¼Œåˆ™ä½¿ç”¨æ¶ˆæ¯åŸæ¥çš„ routing keyã€‚</li>
</ul>
<p><strong>å…¸å‹åº”ç”¨åœºæ™¯</strong></p>
<ul>
<li><strong>å»¶è¿Ÿé˜Ÿåˆ—</strong>ï¼šé€šè¿‡ TTL+DLX å®ç°æ¶ˆæ¯å»¶è¿ŸæŠ•é€’ã€‚</li>
<li><strong>å¤±è´¥å¤„ç†</strong>ï¼šå°†å¤„ç†å¤±è´¥çš„æ¶ˆæ¯è‡ªåŠ¨è·¯ç”±åˆ°æ­»ä¿¡é˜Ÿåˆ—ï¼Œä¾›äººå·¥æˆ–å¼‚æ­¥å¤„ç†ã€‚</li>
<li><strong>æµé‡æ§åˆ¶</strong>ï¼šé˜Ÿåˆ—æ»¡æ—¶è½¬ç§»æ—§æ¶ˆæ¯ï¼Œé¿å…é˜»å¡æ–°æ¶ˆæ¯ã€‚</li>
</ul>
<h3 id="ã€ä¸­ç­‰ã€‘RabbitMQ-å¦‚ä½•å®ç°äº‹åŠ¡æœºåˆ¶ï¼Ÿ"><a href="#ã€ä¸­ç­‰ã€‘RabbitMQ-å¦‚ä½•å®ç°äº‹åŠ¡æœºåˆ¶ï¼Ÿ" class="headerlink" title="ã€ä¸­ç­‰ã€‘RabbitMQ å¦‚ä½•å®ç°äº‹åŠ¡æœºåˆ¶ï¼Ÿ"></a>ã€ä¸­ç­‰ã€‘RabbitMQ å¦‚ä½•å®ç°äº‹åŠ¡æœºåˆ¶ï¼Ÿ</h3><p>RabbitMQ çš„äº‹åŠ¡æœºåˆ¶ï¼ˆTransactionï¼‰é€šè¿‡ <strong>ä¿¡é“ï¼ˆChannelï¼‰</strong> æä¾›äº†ä¸€ç§ä¿è¯æ¶ˆæ¯å¯é æŠ•é€’çš„æœºåˆ¶ï¼Œä½†å…¶è®¾è®¡ç®€å•ä¸”å¯¹æ€§èƒ½å½±å“è¾ƒå¤§ã€‚</p>
<p>RabbitMQ çš„äº‹åŠ¡é€šè¿‡åŒæ­¥æœºåˆ¶ç¡®ä¿æ¶ˆæ¯æŠ•é€’çš„åŸå­æ€§ï¼Œä½†æ€§èƒ½ä»£ä»·é«˜ã€‚<strong>åœ¨ç»å¤§å¤šæ•°ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œæ¨èä½¿ç”¨ Publisher Confirms æ›¿ä»£äº‹åŠ¡</strong>ï¼Œä»¥å…¼é¡¾å¯é æ€§å’Œååé‡ã€‚</p>
<p><strong>äº‹åŠ¡çš„æ ¸å¿ƒæ“ä½œ</strong></p>
<ul>
<li><p><strong>å¼€å¯äº‹åŠ¡</strong>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">channel.txSelect(); <span class="comment">// å¼€å¯äº‹åŠ¡æ¨¡å¼</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>æäº¤äº‹åŠ¡</strong>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">channel.txCommit(); <span class="comment">// æäº¤äº‹åŠ¡ï¼Œæ¶ˆæ¯çœŸæ­£æŠ•é€’åˆ°é˜Ÿåˆ—</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>å›æ»šäº‹åŠ¡</strong>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">channel.txRollback(); <span class="comment">// å›æ»šäº‹åŠ¡ï¼Œä¸¢å¼ƒæœªæäº¤çš„æ¶ˆæ¯</span></span><br></pre></td></tr></table></figure></li>
</ul>
<p><strong>äº‹åŠ¡çš„å·¥ä½œæµç¨‹</strong></p>
<ol>
<li>ç”Ÿäº§è€…å‘é€æ¶ˆæ¯åˆ° RabbitMQï¼ˆæ¶ˆæ¯æš‚å­˜äºä¿¡é“ç¼“å†²åŒºï¼Œæœªå†™å…¥é˜Ÿåˆ—ï¼‰ã€‚</li>
<li>æ‰§è¡Œ <code>txCommit()</code>ï¼šæ¶ˆæ¯æŒä¹…åŒ–åˆ°é˜Ÿåˆ—ï¼›è‹¥å¤±è´¥æˆ–è°ƒç”¨ <code>txRollback()</code>ï¼Œæ¶ˆæ¯ä¸¢å¼ƒã€‚</li>
<li><strong>åŒæ­¥é˜»å¡</strong>ï¼šäº‹åŠ¡æäº¤&#x2F;å›æ»šéœ€ç­‰å¾… Broker ç¡®è®¤ï¼Œæ€§èƒ½è¾ƒä½ã€‚</li>
</ol>
<p><strong>äº‹åŠ¡çš„å±€é™æ€§</strong></p>
<ul>
<li><strong>æ€§èƒ½å·®</strong>ï¼šæ¯æ¬¡æäº¤éœ€ç­‰å¾… Broker ç¡®è®¤ï¼Œååé‡æ˜¾è‘—ä¸‹é™ï¼ˆé€šå¸¸é™ä½ 100~200 å€ï¼‰ã€‚</li>
<li><strong>æ— åˆ†å¸ƒå¼äº‹åŠ¡</strong>ï¼šä»…ä¿è¯ç”Ÿäº§è€…åˆ° Broker çš„å¯é æ€§ï¼Œä¸æ¶‰åŠæ¶ˆè´¹è€…æˆ–ä¸‹æ¸¸ç³»ç»Ÿã€‚</li>
<li><strong>ä¸æ¨èé«˜é¢‘ä½¿ç”¨</strong>ï¼šé€‚åˆä½é¢‘å…³é”®ä¸šåŠ¡ï¼Œé«˜å¹¶å‘åœºæ™¯å»ºè®®ç”¨ <strong>ç¡®è®¤æœºåˆ¶ï¼ˆPublisher Confirmsï¼‰</strong>ã€‚</li>
</ul>
<p><strong>äº‹åŠ¡ vs. ç¡®è®¤æœºåˆ¶ï¼ˆPublisher Confirmsï¼‰</strong></p>
<table>
<thead>
<tr>
<th>ç‰¹æ€§</th>
<th>äº‹åŠ¡ï¼ˆTransactionï¼‰</th>
<th>ç¡®è®¤æœºåˆ¶ï¼ˆPublisher Confirmsï¼‰</th>
</tr>
</thead>
<tbody><tr>
<td><strong>å¯é æ€§</strong></td>
<td>å¼ºä¸€è‡´ï¼ˆåŒæ­¥é˜»å¡ï¼‰</td>
<td>æœ€ç»ˆä¸€è‡´ï¼ˆå¼‚æ­¥ï¼‰</td>
</tr>
<tr>
<td><strong>æ€§èƒ½</strong></td>
<td>æä½ï¼ˆåŒæ­¥ç­‰å¾…ï¼‰</td>
<td>é«˜ï¼ˆå¼‚æ­¥å›è°ƒï¼‰</td>
</tr>
<tr>
<td><strong>é€‚ç”¨åœºæ™¯</strong></td>
<td>ä½é¢‘å…³é”®æ¶ˆæ¯ï¼ˆå¦‚æ”¯ä»˜ï¼‰</td>
<td>é«˜é¢‘ä¸šåŠ¡ï¼ˆå¦‚æ—¥å¿—ã€è®¢å•ï¼‰</td>
</tr>
<tr>
<td><strong>å¤æ‚åº¦</strong></td>
<td>ç®€å•</td>
<td>éœ€å¤„ç†ç¡®è®¤&#x2F;æœªç¡®è®¤é€»è¾‘</td>
</tr>
</tbody></table>
<p><strong>ä»£ç ç¤ºä¾‹</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    channel.txSelect(); <span class="comment">// å¼€å¯äº‹åŠ¡</span></span><br><span class="line">    channel.basicPublish(<span class="string">&quot;&quot;</span>, <span class="string">&quot;queue1&quot;</span>, <span class="literal">null</span>, msg1.getBytes());</span><br><span class="line">    channel.basicPublish(<span class="string">&quot;&quot;</span>, <span class="string">&quot;queue2&quot;</span>, <span class="literal">null</span>, msg2.getBytes());</span><br><span class="line">    channel.txCommit(); <span class="comment">// æäº¤äº‹åŠ¡</span></span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    channel.txRollback(); <span class="comment">// å›æ»šäº‹åŠ¡</span></span><br><span class="line">    <span class="comment">// å¤„ç†å¼‚å¸¸</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>ä½¿ç”¨å»ºè®®</strong></p>
<ul>
<li><p><strong>ä¼˜å…ˆé€‰æ‹© Confirm æ¨¡å¼</strong>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">channel.confirmSelect(); <span class="comment">// å¼€å¯ç¡®è®¤æ¨¡å¼</span></span><br><span class="line">channel.addConfirmListener(...); <span class="comment">// å¼‚æ­¥å›è°ƒ</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>äº‹åŠ¡é€‚ç”¨åœºæ™¯</strong>ï¼š</p>
<ul>
<li>ä¸¥æ ¼ä¿è¯å•æ‰¹æ¬¡æ¶ˆæ¯çš„åŸå­æ€§ï¼ˆå¦‚åŒæ—¶æŠ•é€’è®¢å•å’Œåº“å­˜æ¶ˆæ¯ï¼‰ã€‚</li>
<li>å…¼å®¹æ—§ç‰ˆ RabbitMQï¼ˆConfirm æ¨¡å¼éœ€ v3.3+ï¼‰ã€‚</li>
</ul>
</li>
</ul>
<h3 id="ã€ä¸­ç­‰ã€‘RabbitMQ-ä¸­æœ‰å“ªäº›æ ¸å¿ƒæ¦‚å¿µï¼Ÿ"><a href="#ã€ä¸­ç­‰ã€‘RabbitMQ-ä¸­æœ‰å“ªäº›æ ¸å¿ƒæ¦‚å¿µï¼Ÿ" class="headerlink" title="ã€ä¸­ç­‰ã€‘RabbitMQ ä¸­æœ‰å“ªäº›æ ¸å¿ƒæ¦‚å¿µï¼Ÿ"></a>ã€ä¸­ç­‰ã€‘RabbitMQ ä¸­æœ‰å“ªäº›æ ¸å¿ƒæ¦‚å¿µï¼Ÿ</h3><p>RabbitMQ é€šè¿‡ <strong>ç”Ÿäº§è€…â†’äº¤æ¢æœºâ†’é˜Ÿåˆ—â†’æ¶ˆè´¹è€…</strong> çš„é“¾è·¯ä¼ é€’æ¶ˆæ¯ï¼Œæ ¸å¿ƒè®¾è®¡å›´ç»• <strong>è§£è€¦</strong> å’Œ <strong>çµæ´»è·¯ç”±</strong>ã€‚ç†è§£è¿™äº›è§’è‰²å’Œæ¦‚å¿µæ˜¯æŒæ¡å…¶å·¥ä½œåŸç†çš„åŸºç¡€ã€‚</p>
<p><strong>æ ¸å¿ƒè§’è‰²</strong></p>
<table>
<thead>
<tr>
<th><strong>è§’è‰²</strong></th>
<th><strong>ä½œç”¨</strong></th>
</tr>
</thead>
<tbody><tr>
<td><strong>ç”Ÿäº§è€…ï¼ˆProducerï¼‰</strong></td>
<td>å‘é€æ¶ˆæ¯åˆ°äº¤æ¢æœºçš„å®¢æˆ·ç«¯</td>
</tr>
<tr>
<td><strong>æ¶ˆè´¹è€…ï¼ˆConsumerï¼‰</strong></td>
<td>ä»é˜Ÿåˆ—è®¢é˜…å¹¶å¤„ç†æ¶ˆæ¯çš„å®¢æˆ·ç«¯</td>
</tr>
<tr>
<td><strong>æ¶ˆæ¯ä»£ç†ï¼ˆBrokerï¼‰</strong></td>
<td>RabbitMQ æœåŠ¡å®ä¾‹ï¼Œè´Ÿè´£æ¥æ”¶ã€è·¯ç”±å’Œå­˜å‚¨æ¶ˆæ¯ï¼ˆå³ RabbitMQ æœåŠ¡å™¨æœ¬èº«ï¼‰</td>
</tr>
</tbody></table>
<p><strong>æ ¸å¿ƒç»„ä»¶</strong></p>
<table>
<thead>
<tr>
<th><strong>ç»„ä»¶</strong></th>
<th><strong>åŠŸèƒ½</strong></th>
</tr>
</thead>
<tbody><tr>
<td><strong>è¿æ¥ï¼ˆConnectionï¼‰</strong></td>
<td>ç”Ÿäº§è€…&#x2F;æ¶ˆè´¹è€…ä¸ Broker ä¹‹é—´çš„ TCP é•¿è¿æ¥ï¼ˆå¤ç”¨å‡å°‘å¼€é”€ï¼‰</td>
</tr>
<tr>
<td><strong>ä¿¡é“ï¼ˆChannelï¼‰</strong></td>
<td>è¿æ¥ä¸­çš„è™šæ‹Ÿé€šé“ï¼ˆè½»é‡çº§ï¼Œé¿å…é¢‘ç¹åˆ›å»º TCP è¿æ¥ï¼‰</td>
</tr>
<tr>
<td><strong>äº¤æ¢æœºï¼ˆExchangeï¼‰</strong></td>
<td>æ¥æ”¶ç”Ÿäº§è€…æ¶ˆæ¯ï¼ŒæŒ‰è§„åˆ™è·¯ç”±åˆ°é˜Ÿåˆ—ï¼ˆç±»å‹å†³å®šè·¯ç”±é€»è¾‘ï¼‰</td>
</tr>
<tr>
<td><strong>é˜Ÿåˆ—ï¼ˆQueueï¼‰</strong></td>
<td>å­˜å‚¨æ¶ˆæ¯çš„å®¹å™¨ï¼Œæ¶ˆè´¹è€…ä»ä¸­æ‹‰å–æ•°æ®</td>
</tr>
<tr>
<td><strong>ç»‘å®šï¼ˆBindingï¼‰</strong></td>
<td>å®šä¹‰äº¤æ¢æœºä¸é˜Ÿåˆ—çš„æ˜ å°„å…³ç³»ï¼ˆå«è·¯ç”±é”®è§„åˆ™ï¼‰</td>
</tr>
</tbody></table>
<p><strong>è¾…åŠ©æ¦‚å¿µ</strong></p>
<table>
<thead>
<tr>
<th><strong>æ¦‚å¿µ</strong></th>
<th><strong>è¯´æ˜</strong></th>
</tr>
</thead>
<tbody><tr>
<td><strong>è·¯ç”±é”®ï¼ˆRouting Keyï¼‰</strong></td>
<td>ç”Ÿäº§è€…å‘é€æ—¶æŒ‡å®šçš„å…³é”®å­—ï¼Œç”¨äºäº¤æ¢æœºåŒ¹é…é˜Ÿåˆ—ï¼ˆç±»ä¼¼â€œé‚®ä»¶åœ°å€â€ï¼‰</td>
</tr>
<tr>
<td><strong>è™šæ‹Ÿä¸»æœºï¼ˆVHostï¼‰</strong></td>
<td>é€»è¾‘éš”ç¦»å•å…ƒï¼ˆç±»ä¼¼å‘½åç©ºé—´ï¼‰ï¼Œä¸åŒ VHost çš„é˜Ÿåˆ—&#x2F;äº¤æ¢æœºäº’ä¸å¯è§</td>
</tr>
<tr>
<td><strong>æ­»ä¿¡é˜Ÿåˆ—ï¼ˆDLXï¼‰</strong></td>
<td>å¤„ç†è¿‡æœŸ&#x2F;è¢«æ‹’ç»æ¶ˆæ¯çš„ç‰¹æ®Šé˜Ÿåˆ—ï¼ˆç”¨äºå»¶è¿Ÿé˜Ÿåˆ—æˆ–å¼‚å¸¸å¤„ç†ï¼‰</td>
</tr>
<tr>
<td><strong>æ¶ˆæ¯ç¡®è®¤ï¼ˆACKï¼‰</strong></td>
<td>æ¶ˆè´¹è€…æ‰‹åŠ¨ç¡®è®¤æ¶ˆæ¯å¤„ç†å®Œæˆï¼Œç¡®ä¿å¯é æ€§</td>
</tr>
</tbody></table>
<p><strong>å…³é”®åè®®ä¸æœºåˆ¶</strong></p>
<ul>
<li><strong>AMQP åè®®</strong>ï¼šRabbitMQ çš„æ ¸å¿ƒé€šä¿¡åè®®ï¼Œå®šä¹‰æ¶ˆæ¯æ ¼å¼ä¸äº¤äº’è§„åˆ™</li>
<li><strong>æŒä¹…åŒ–ï¼ˆDurableï¼‰</strong>ï¼šé˜Ÿåˆ—&#x2F;æ¶ˆæ¯å¯æŒä¹…åŒ–åˆ°ç£ç›˜ï¼Œé˜²æ­¢æœåŠ¡é‡å¯ä¸¢å¤±</li>
<li><strong>äº‹åŠ¡ï¼ˆTransactionï¼‰</strong>ï¼šç¡®ä¿æ‰¹é‡æ“ä½œçš„åŸå­æ€§ï¼ˆä½†æ€§èƒ½è¾ƒå·®ï¼Œé€šå¸¸ç”¨ ACK æ›¿ä»£ï¼‰</li>
</ul>
<h3 id="ã€ä¸­ç­‰ã€‘RabbitMQ-æœ‰å“ªäº›å·¥ä½œæ¨¡å¼ï¼Ÿ"><a href="#ã€ä¸­ç­‰ã€‘RabbitMQ-æœ‰å“ªäº›å·¥ä½œæ¨¡å¼ï¼Ÿ" class="headerlink" title="ã€ä¸­ç­‰ã€‘RabbitMQ æœ‰å“ªäº›å·¥ä½œæ¨¡å¼ï¼Ÿ"></a>ã€ä¸­ç­‰ã€‘RabbitMQ æœ‰å“ªäº›å·¥ä½œæ¨¡å¼ï¼Ÿ</h3><p>RabbitMQ æœ‰ä»¥ä¸‹å‡ ç§ä¸»è¦çš„å·¥ä½œæ¨¡å¼ï¼š</p>
<ul>
<li>ç®€å•æ¨¡å¼ï¼ˆSimpleï¼‰</li>
<li>å·¥ä½œé˜Ÿåˆ—æ¨¡å¼ï¼ˆWork Queueï¼‰</li>
<li>å‘å¸ƒ&#x2F;è®¢é˜…æ¨¡å¼ï¼ˆPublish&#x2F;Subscribeï¼‰</li>
<li>è·¯ç”±æ¨¡å¼ï¼ˆRoutingï¼‰</li>
<li>ä¸»é¢˜æ¨¡å¼ï¼ˆTopicï¼‰</li>
<li>RPC æ¨¡å¼ï¼ˆè¿œç¨‹è°ƒç”¨ï¼‰</li>
</ul>
<p>ä»¥ä¸‹ï¼Œå¯¹å‡ ç§å·¥ä½œæ¨¡å¼é€ä¸€è¿›è¡Œè¯´æ˜ï¼š</p>
<p><strong>ç®€å•æ¨¡å¼ï¼ˆSimpleï¼‰</strong></p>
<ul>
<li><strong>è§’è‰²</strong>ï¼š1 ç”Ÿäº§è€… â†’ 1 é˜Ÿåˆ— â†’ 1 æ¶ˆè´¹è€…</li>
<li><strong>ç‰¹ç‚¹</strong>ï¼šå•å‘é€šä¿¡ï¼Œæ— è·¯ç”±é€»è¾‘ï¼Œå³ç‚¹å¯¹ç‚¹æ¨¡å¼</li>
<li><strong>åœºæ™¯</strong>ï¼šå•ä»»åŠ¡å¤„ç†ï¼ˆå¦‚æ—¥å¿—è®°å½•ï¼‰</li>
</ul>
<p><strong>å·¥ä½œé˜Ÿåˆ—æ¨¡å¼ï¼ˆWork Queueï¼‰</strong></p>
<ul>
<li><strong>è§’è‰²</strong>ï¼š1 ç”Ÿäº§è€… â†’ 1 é˜Ÿåˆ— â†’ <strong>å¤šä¸ªæ¶ˆè´¹è€…ç«äº‰æ¶ˆè´¹</strong></li>
<li><strong>ç‰¹ç‚¹</strong>ï¼š<ul>
<li>æ¶ˆæ¯<strong>è½®è¯¢åˆ†å‘</strong>ï¼ˆé»˜è®¤ï¼‰æˆ–<strong>å…¬å¹³åˆ†å‘</strong>ï¼ˆéœ€è®¾ç½®<code>prefetch=1</code>ï¼‰</li>
<li>æ¶ˆè´¹è€…å¹¶è¡Œå¤„ç†</li>
</ul>
</li>
<li><strong>åœºæ™¯</strong>ï¼šä»»åŠ¡åˆ†å‘ï¼ˆå¦‚è®¢å•å¤„ç†ï¼‰</li>
</ul>
<p><strong>å‘å¸ƒ&#x2F;è®¢é˜…æ¨¡å¼ï¼ˆPublish&#x2F;Subscribeï¼‰</strong></p>
<ul>
<li><strong>è§’è‰²</strong>ï¼š1 ç”Ÿäº§è€… â†’ <strong>Fanout äº¤æ¢æœº</strong> â†’ ç»‘å®šå¤šä¸ªé˜Ÿåˆ— â†’ å¤šä¸ªæ¶ˆè´¹è€…</li>
<li><strong>ç‰¹ç‚¹</strong>ï¼š<ul>
<li>æ¶ˆæ¯<strong>å¹¿æ’­</strong>åˆ°æ‰€æœ‰é˜Ÿåˆ—</li>
<li>æ¶ˆè´¹è€…å„è‡ªç‹¬ç«‹æ¥æ”¶å…¨é‡æ¶ˆæ¯</li>
</ul>
</li>
<li><strong>åœºæ™¯</strong>ï¼šäº‹ä»¶é€šçŸ¥ï¼ˆå¦‚ç³»ç»Ÿå…¬å‘Šï¼‰</li>
</ul>
<p><strong>è·¯ç”±æ¨¡å¼ï¼ˆRoutingï¼‰</strong></p>
<ul>
<li><strong>è§’è‰²</strong>ï¼š1 ç”Ÿäº§è€… â†’ <strong>Direct äº¤æ¢æœº</strong> â†’ æ ¹æ®<code>routing_key</code>è·¯ç”±åˆ°ç‰¹å®šé˜Ÿåˆ—</li>
<li><strong>ç‰¹ç‚¹</strong>ï¼š<ul>
<li><strong>ç²¾ç¡®åŒ¹é…</strong>è·¯ç”±é”®</li>
<li>æ”¯æŒå¤šé˜Ÿåˆ—ç»‘å®šç›¸åŒè·¯ç”±é”®</li>
</ul>
</li>
<li><strong>åœºæ™¯</strong>ï¼šæ¡ä»¶è¿‡æ»¤ï¼ˆå¦‚é”™è¯¯æ—¥å¿—åˆ†çº§å¤„ç†ï¼‰</li>
</ul>
<p><strong>ä¸»é¢˜æ¨¡å¼ï¼ˆTopicï¼‰</strong></p>
<ul>
<li><strong>è§’è‰²</strong>ï¼š1 ç”Ÿäº§è€… â†’ <strong>Topic äº¤æ¢æœº</strong> â†’ åŸºäºé€šé…ç¬¦ï¼ˆ<code>*</code>&#x2F;<code>#</code>ï¼‰åŒ¹é…è·¯ç”±é”®</li>
<li><strong>ç‰¹ç‚¹</strong>ï¼š<ul>
<li><strong>æ¨¡ç³ŠåŒ¹é…</strong>ï¼ˆå¦‚<code>order.*</code>åŒ¹é…<code>order.create</code>ï¼‰</li>
<li>çµæ´»æ€§é«˜</li>
</ul>
</li>
<li><strong>åœºæ™¯</strong>ï¼šå¤æ‚è·¯ç”±ï¼ˆå¦‚å¤šç»´åº¦æ¶ˆæ¯åˆ†ç±»ï¼‰</li>
</ul>
<p><strong>RPC æ¨¡å¼ï¼ˆè¿œç¨‹è°ƒç”¨ï¼‰</strong></p>
<ul>
<li><strong>è§’è‰²</strong>ï¼šå®¢æˆ·ç«¯ â†’ è¯·æ±‚é˜Ÿåˆ— â†’ æœåŠ¡ç«¯ â†’ å“åº”é˜Ÿåˆ— â†’ å®¢æˆ·ç«¯</li>
<li><strong>ç‰¹ç‚¹</strong>ï¼š<ul>
<li>é€šè¿‡<code>reply_to</code>å’Œ<code>correlation_id</code>å…³è”è¯·æ±‚&#x2F;å“åº”</li>
<li>åŒæ­¥é˜»å¡å¼é€šä¿¡</li>
</ul>
</li>
<li><strong>åœºæ™¯</strong>ï¼šæœåŠ¡é—´è°ƒç”¨ï¼ˆéœ€å³æ—¶å“åº”ï¼‰</li>
</ul>
<p><strong>æ¨¡å¼å¯¹æ¯”</strong></p>
<table>
<thead>
<tr>
<th><strong>æ¨¡å¼</strong></th>
<th><strong>äº¤æ¢æœºç±»å‹</strong></th>
<th><strong>è·¯ç”±è§„åˆ™</strong></th>
<th><strong>å…¸å‹åº”ç”¨</strong></th>
</tr>
</thead>
<tbody><tr>
<td>ç®€å•æ¨¡å¼</td>
<td>æ— </td>
<td>æ— </td>
<td>å•ä»»åŠ¡å¤„ç†</td>
</tr>
<tr>
<td>å·¥ä½œé˜Ÿåˆ—</td>
<td>æ— </td>
<td>è½®è¯¢&#x2F;å…¬å¹³åˆ†å‘</td>
<td>å¹¶è¡Œä»»åŠ¡</td>
</tr>
<tr>
<td>å‘å¸ƒ&#x2F;è®¢é˜…</td>
<td>Fanout</td>
<td>å¹¿æ’­</td>
<td>å¤šç³»ç»Ÿé€šçŸ¥</td>
</tr>
<tr>
<td>è·¯ç”±æ¨¡å¼</td>
<td>Direct</td>
<td>ç²¾ç¡®åŒ¹é…<code>routing_key</code></td>
<td>æ¡ä»¶è¿‡æ»¤</td>
</tr>
<tr>
<td>ä¸»é¢˜æ¨¡å¼</td>
<td>Topic</td>
<td>é€šé…ç¬¦åŒ¹é…</td>
<td>å¤æ‚è·¯ç”±</td>
</tr>
<tr>
<td>RPC æ¨¡å¼</td>
<td>æ— </td>
<td>è¯·æ±‚-å“åº”å…³è”</td>
<td>åŒæ­¥æœåŠ¡è°ƒç”¨</td>
</tr>
</tbody></table>
<p><strong>é€‰æ‹©å»ºè®®</strong></p>
<ul>
<li><strong>å¹¿æ’­éœ€æ±‚</strong> â†’ Fanout</li>
<li><strong>æ¡ä»¶è¿‡æ»¤</strong> â†’ Direct&#x2F;Topic</li>
<li><strong>ä»»åŠ¡å¹¶è¡Œ</strong> â†’ Work Queue</li>
<li><strong>æœåŠ¡è°ƒç”¨</strong> â†’ RPC</li>
</ul>
<h3 id="ã€ä¸­ç­‰ã€‘RabbitMQ-æœ‰å“ªäº›é›†ç¾¤æ¨¡å¼ï¼Ÿ"><a href="#ã€ä¸­ç­‰ã€‘RabbitMQ-æœ‰å“ªäº›é›†ç¾¤æ¨¡å¼ï¼Ÿ" class="headerlink" title="ã€ä¸­ç­‰ã€‘RabbitMQ æœ‰å“ªäº›é›†ç¾¤æ¨¡å¼ï¼Ÿ"></a>ã€ä¸­ç­‰ã€‘RabbitMQ æœ‰å“ªäº›é›†ç¾¤æ¨¡å¼ï¼Ÿ</h3><p>RabbitMQ æœ‰ä»¥ä¸‹é›†ç¾¤æ¨¡å¼ï¼š</p>
<ul>
<li>æ™®é€šé›†ç¾¤</li>
<li>é•œåƒé˜Ÿåˆ—é›†ç¾¤ï¼ˆé«˜å¯ç”¨æ¨¡å¼ï¼‰</li>
<li>è”é‚¦é›†ç¾¤</li>
<li>åˆ†ç‰‡é›†ç¾¤</li>
</ul>
<p>æ‰€æœ‰é›†ç¾¤æ¨¡å¼å‡ä¾èµ– <strong>Erlang Cookie</strong> å®ç°èŠ‚ç‚¹é—´è®¤è¯ï¼Œéœ€ç¡®ä¿ä¸€è‡´ã€‚</p>
<p>::: info æ™®é€šé›†ç¾¤</p>
<p>:::</p>
<ul>
<li><strong>æ ¸å¿ƒç‰¹ç‚¹</strong><ul>
<li>å…ƒæ•°æ®ï¼ˆé˜Ÿåˆ—ã€äº¤æ¢æœºç­‰ï¼‰<strong>å…¨èŠ‚ç‚¹åŒæ­¥</strong></li>
<li><strong>æ¶ˆæ¯å®ä½“ä»…å­˜äºåˆ›å»ºé˜Ÿåˆ—çš„èŠ‚ç‚¹</strong>ï¼ˆå…¶ä»–èŠ‚ç‚¹é€šè¿‡æŒ‡é’ˆè®¿é—®ï¼‰</li>
</ul>
</li>
<li><strong>ä¼˜ç‚¹</strong><ul>
<li>èŠ‚çœå­˜å‚¨ï¼ˆæ¶ˆæ¯ä¸å†—ä½™ï¼‰</li>
<li>æ¨ªå‘æ‰©å±•æ–¹ä¾¿</li>
</ul>
</li>
<li><strong>ç¼ºç‚¹</strong><ul>
<li><strong>å•ç‚¹æ•…éšœé£é™©</strong>ï¼šè‹¥æŸèŠ‚ç‚¹å®•æœºï¼Œå…¶ä¸Šçš„é˜Ÿåˆ—æ¶ˆæ¯ä¸å¯ç”¨</li>
<li>è·¨èŠ‚ç‚¹è®¿é—®æ¶ˆæ¯éœ€ç½‘ç»œä¼ è¾“</li>
</ul>
</li>
</ul>
<p>::: info é•œåƒé˜Ÿåˆ—é›†ç¾¤ï¼ˆé«˜å¯ç”¨æ¨¡å¼ï¼‰</p>
<p>:::</p>
<ul>
<li><strong>æ ¸å¿ƒç‰¹ç‚¹</strong><ul>
<li>é˜Ÿåˆ—<strong>è·¨èŠ‚ç‚¹é•œåƒå¤åˆ¶</strong>ï¼ˆæ¶ˆæ¯å®ä½“å…¨èŠ‚ç‚¹å†—ä½™ï¼‰</li>
<li>é€šè¿‡ç­–ç•¥ï¼ˆPolicyï¼‰å®šä¹‰é•œåƒè§„åˆ™ï¼ˆå¦‚ <code>ha-mode=all</code> è¡¨ç¤ºå…¨èŠ‚ç‚¹å¤åˆ¶ï¼‰</li>
</ul>
</li>
<li><strong>ä¼˜ç‚¹</strong><ul>
<li><strong>é«˜å¯ç”¨</strong>ï¼šä»»ä¸€èŠ‚ç‚¹å®•æœºï¼Œå…¶ä»–èŠ‚ç‚¹å¯ç»§ç»­æœåŠ¡</li>
<li>è‡ªåŠ¨æ•…éšœè½¬ç§»ï¼ˆæ¶ˆè´¹è€…æ— æ„ŸçŸ¥ï¼‰</li>
</ul>
</li>
<li><strong>ç¼ºç‚¹</strong><ul>
<li><strong>å­˜å‚¨å¼€é”€å¤§</strong>ï¼ˆæ¶ˆæ¯å…¨é‡å¤åˆ¶ï¼‰</li>
<li>å†™å…¥æ€§èƒ½ç•¥ä½ï¼ˆéœ€åŒæ­¥æ‰€æœ‰å‰¯æœ¬ï¼‰</li>
</ul>
</li>
</ul>
<p>::: info è”é‚¦é›†ç¾¤ï¼ˆFederationï¼‰</p>
<p>:::</p>
<ul>
<li><strong>æ ¸å¿ƒç‰¹ç‚¹</strong><ul>
<li><strong>è·¨æœºæˆ¿&#x2F;åœ°åŸŸ</strong>éƒ¨ç½²ï¼Œæ¶ˆæ¯æŒ‰éœ€å¼‚æ­¥è½¬å‘</li>
<li>åŸºäºæ’ä»¶ï¼ˆ<code>rabbitmq_federation</code>ï¼‰å®ç°</li>
</ul>
</li>
<li><strong>é€‚ç”¨åœºæ™¯</strong><ul>
<li>å¼‚åœ°å®¹ç¾</li>
<li>å¤šåŒºåŸŸæ¶ˆæ¯åŒæ­¥</li>
</ul>
</li>
</ul>
<p>::: info åˆ†ç‰‡é›†ç¾¤ï¼ˆShardingï¼‰</p>
<p>:::</p>
<ul>
<li><strong>æ ¸å¿ƒç‰¹ç‚¹</strong><ul>
<li>é€šè¿‡æ’ä»¶ï¼ˆ<code>rabbitmq_sharding</code>ï¼‰å°†é˜Ÿåˆ—<strong>æ°´å¹³æ‹†åˆ†</strong>åˆ°ä¸åŒèŠ‚ç‚¹</li>
<li>ç”Ÿäº§è€…è‡ªåŠ¨è·¯ç”±åˆ°å¯¹åº”åˆ†ç‰‡</li>
</ul>
</li>
<li><strong>é€‚ç”¨åœºæ™¯</strong><ul>
<li>è¶…å¤§è§„æ¨¡é˜Ÿåˆ—ï¼ˆå‡è½»å•èŠ‚ç‚¹å‹åŠ›ï¼‰</li>
</ul>
</li>
</ul>
<p>::: info æ–¹æ¡ˆå¯¹æ¯”</p>
<p>:::</p>
<table>
<thead>
<tr>
<th><strong>æ¨¡å¼</strong></th>
<th><strong>æ•°æ®å†—ä½™</strong></th>
<th><strong>é«˜å¯ç”¨</strong></th>
<th><strong>è·¨åœ°åŸŸ</strong></th>
<th><strong>é€‚ç”¨åœºæ™¯</strong></th>
</tr>
</thead>
<tbody><tr>
<td>æ™®é€šé›†ç¾¤</td>
<td>æ— </td>
<td>âŒ</td>
<td>âŒ</td>
<td>å¼€å‘æµ‹è¯•ã€ä½é‡è¦æ€§æ•°æ®</td>
</tr>
<tr>
<td>é•œåƒé˜Ÿåˆ—</td>
<td>å…¨é‡å¤åˆ¶</td>
<td>âœ…</td>
<td>âŒ</td>
<td>ç”Ÿäº§ç¯å¢ƒï¼ˆå¦‚è®¢å•ã€æ”¯ä»˜ï¼‰</td>
</tr>
<tr>
<td>è”é‚¦é›†ç¾¤</td>
<td>æŒ‰éœ€åŒæ­¥</td>
<td>âœ…</td>
<td>âœ…</td>
<td>å¼‚åœ°å¤šæ´»</td>
</tr>
<tr>
<td>åˆ†ç‰‡é›†ç¾¤</td>
<td>æ— </td>
<td>âŒ</td>
<td>âŒ</td>
<td>è¶…å¤§è§„æ¨¡é˜Ÿåˆ—</td>
</tr>
</tbody></table>
<p><strong>é€‰æ‹©å»ºè®®</strong></p>
<ul>
<li><strong>ç”Ÿäº§ç¯å¢ƒ</strong>ï¼šä¼˜å…ˆä½¿ç”¨ <strong>é•œåƒé˜Ÿåˆ—é›†ç¾¤</strong>ï¼ˆéœ€æƒè¡¡æ€§èƒ½ä¸å†—ä½™ï¼‰</li>
<li><strong>å¼‚åœ°å®¹ç¾</strong>ï¼šç»“åˆ <strong>è”é‚¦é›†ç¾¤</strong> + é•œåƒé˜Ÿåˆ—</li>
<li><strong>æµ·é‡æ•°æ®</strong>ï¼šè€ƒè™‘ <strong>åˆ†ç‰‡é›†ç¾¤</strong>ï¼ˆä½†éœ€ä¸šåŠ¡é€‚é…ï¼‰</li>
</ul>
<h3 id="ã€ä¸­ç­‰ã€‘RabbitMQ-å¦‚ä½•å®ç°å»¶è¿Ÿé˜Ÿåˆ—ï¼Ÿ"><a href="#ã€ä¸­ç­‰ã€‘RabbitMQ-å¦‚ä½•å®ç°å»¶è¿Ÿé˜Ÿåˆ—ï¼Ÿ" class="headerlink" title="ã€ä¸­ç­‰ã€‘RabbitMQ å¦‚ä½•å®ç°å»¶è¿Ÿé˜Ÿåˆ—ï¼Ÿ"></a>ã€ä¸­ç­‰ã€‘RabbitMQ å¦‚ä½•å®ç°å»¶è¿Ÿé˜Ÿåˆ—ï¼Ÿ</h3><p>::: info åŸç”Ÿæ–¹æ¡ˆï¼šTTL+æ­»ä¿¡é˜Ÿåˆ—ï¼ˆDLXï¼‰</p>
<p>:::</p>
<ul>
<li><p><strong>æ ¸å¿ƒåŸç†</strong>ï¼šé€šè¿‡æ¶ˆæ¯ TTLï¼ˆå­˜æ´»æ—¶é—´ï¼‰å’Œæ­»ä¿¡äº¤æ¢æœºï¼ˆDLXï¼‰å®ç°å»¶è¿ŸæŠ•é€’ã€‚</p>
</li>
<li><p><strong>å®ç°æ­¥éª¤</strong></p>
<ol>
<li><strong>åˆ›å»ºå»¶è¿Ÿé˜Ÿåˆ—</strong>ï¼šè®¾ç½® <code>x-message-ttl</code>ï¼ˆæ¶ˆæ¯è¿‡æœŸæ—¶é—´ï¼‰å’Œ <code>x-dead-letter-exchange</code>ï¼ˆæ­»ä¿¡äº¤æ¢æœºï¼‰</li>
<li><strong>æ¶ˆæ¯æŠ•é€’</strong>ï¼šå‘é€åˆ°å»¶è¿Ÿé˜Ÿåˆ—ï¼Œç­‰å¾… TTL åˆ°æœŸ</li>
<li><strong>è‡ªåŠ¨è½¬å‘</strong>ï¼šè¿‡æœŸåç”± DLX å°†æ¶ˆæ¯è·¯ç”±åˆ°ç›®æ ‡é˜Ÿåˆ—</li>
<li><strong>æ¶ˆè´¹è€…</strong>ï¼šä»ç›®æ ‡é˜Ÿåˆ—è·å–å»¶è¿Ÿæ¶ˆæ¯</li>
</ol>
</li>
<li><p><strong>ç‰¹ç‚¹</strong></p>
<ul>
<li>å›ºå®šå»¶è¿Ÿæ—¶é—´ï¼ˆæ¯æ¡æ¶ˆæ¯ TTL éœ€å•ç‹¬è®¾ç½®ï¼‰</li>
<li>æ— éœ€æ’ä»¶ï¼Œä½†çµæ´»æ€§è¾ƒå·®</li>
</ul>
</li>
</ul>
<p>::: info æ’ä»¶æ–¹æ¡ˆï¼šrabbitmq_delayed_message_exchange</p>
<p>:::</p>
<ul>
<li><p><strong>æ ¸å¿ƒåŸç†</strong>ï¼šå®˜æ–¹æ’ä»¶æä¾› <code>x-delayed-message</code> äº¤æ¢æœºç±»å‹ï¼Œæ”¯æŒåŠ¨æ€å»¶è¿Ÿæ—¶é—´ã€‚</p>
</li>
<li><p><strong>å®ç°æ­¥éª¤</strong></p>
<ol>
<li><strong>å¯ç”¨æ’ä»¶</strong>ï¼šå®‰è£… <code>rabbitmq_delayed_message_exchange</code></li>
<li><strong>å£°æ˜äº¤æ¢æœº</strong>ï¼šç±»å‹è®¾ä¸º <code>x-delayed-message</code>ï¼Œå¹¶æŒ‡å®šè·¯ç”±è§„åˆ™ï¼ˆå¦‚ direct&#x2F;topicï¼‰</li>
<li><strong>å‘é€æ¶ˆæ¯</strong>ï¼šé€šè¿‡ <code>headers</code> è®¾ç½® <code>x-delay</code> å‚æ•°ï¼ˆæ¯«ç§’çº§å»¶è¿Ÿï¼‰</li>
<li><strong>è‡ªåŠ¨æŠ•é€’</strong>ï¼šæ’ä»¶å†…éƒ¨è°ƒåº¦ï¼Œåˆ°æœŸåæŠ•é€’åˆ°ç›®æ ‡é˜Ÿåˆ—</li>
</ol>
</li>
<li><p><strong>ç‰¹ç‚¹</strong></p>
<ul>
<li>æ”¯æŒåŠ¨æ€å»¶è¿Ÿæ—¶é—´ï¼ˆæ¯æ¡æ¶ˆæ¯å¯ç‹¬ç«‹è®¾ç½®ï¼‰</li>
<li>é«˜ç²¾åº¦ï¼ˆæ¯«ç§’çº§ï¼‰</li>
<li>éœ€é¢å¤–å®‰è£…æ’ä»¶</li>
</ul>
</li>
</ul>
<p>::: info æ–¹æ¡ˆå¯¹æ¯”</p>
<p>:::</p>
<table>
<thead>
<tr>
<th><strong>ç»´åº¦</strong></th>
<th><strong>TTL+DLX</strong></th>
<th><strong>æ’ä»¶æ–¹æ¡ˆ</strong></th>
</tr>
</thead>
<tbody><tr>
<td><strong>çµæ´»æ€§</strong></td>
<td>å›ºå®šå»¶è¿Ÿï¼ˆé˜Ÿåˆ—çº§åˆ«ï¼‰</td>
<td>åŠ¨æ€å»¶è¿Ÿï¼ˆæ¶ˆæ¯çº§åˆ«ï¼‰</td>
</tr>
<tr>
<td><strong>ç²¾åº¦</strong></td>
<td>ç§’çº§</td>
<td>æ¯«ç§’çº§</td>
</tr>
<tr>
<td><strong>å¤æ‚åº¦</strong></td>
<td>æ— éœ€æ’ä»¶ï¼Œéœ€é…ç½® DLX</td>
<td>éœ€å®‰è£…æ’ä»¶</td>
</tr>
<tr>
<td><strong>é€‚ç”¨åœºæ™¯</strong></td>
<td>ç®€å•å»¶è¿Ÿéœ€æ±‚ï¼ˆå¦‚ç»Ÿä¸€ 30 ç§’å»¶è¿Ÿï¼‰</td>
<td>å¤æ‚å»¶è¿Ÿéœ€æ±‚ï¼ˆå¦‚ä¸åŒè®¢å•è¶…æ—¶æ—¶é—´ï¼‰</td>
</tr>
<tr>
<td><strong>ç¼ºç‚¹</strong></td>
<td>é˜Ÿåˆ—ä¸­æ¶ˆæ¯è‹¥é˜»å¡ï¼Œä¼šå»¶è¿Ÿåç»­æ¶ˆæ¯æŠ•é€’ï¼ˆéœ€ç¡®ä¿ FIFO æ¶ˆè´¹ï¼‰</td>
<td>å¤§é‡å»¶è¿Ÿæ¶ˆæ¯å¯èƒ½å ç”¨è¾ƒé«˜å†…å­˜</td>
</tr>
</tbody></table>
<p><strong>ç¤ºä¾‹ä»£ç ï¼ˆæ’ä»¶æ–¹æ¡ˆï¼‰</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å£°æ˜å»¶è¿Ÿäº¤æ¢æœº</span></span><br><span class="line">channel.exchange_declare(</span><br><span class="line">    exchange=<span class="string">&#x27;delayed_exchange&#x27;</span>,</span><br><span class="line">    exchange_type=<span class="string">&#x27;x-delayed-message&#x27;</span>,  <span class="comment"># å…³é”®å‚æ•°</span></span><br><span class="line">    arguments=&#123;<span class="string">&#x27;x-delayed-type&#x27;</span>: <span class="string">&#x27;direct&#x27;</span>&#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># å‘é€å»¶è¿Ÿæ¶ˆæ¯ï¼ˆå»¶è¿Ÿ 5 ç§’ï¼‰</span></span><br><span class="line">channel.basic_publish(</span><br><span class="line">    exchange=<span class="string">&#x27;delayed_exchange&#x27;</span>,</span><br><span class="line">    routing_key=<span class="string">&#x27;order_queue&#x27;</span>,</span><br><span class="line">    body=message,</span><br><span class="line">    properties=pika.BasicProperties(</span><br><span class="line">        headers=&#123;<span class="string">&#x27;x-delay&#x27;</span>: <span class="number">5000</span>&#125;  <span class="comment"># å»¶è¿Ÿæ¯«ç§’æ•°</span></span><br><span class="line">    )</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ul>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/itfly8/p/5155983.html">å¤§å‹ç½‘ç«™æ¶æ„ç³»åˆ—ï¼šåˆ†å¸ƒå¼ MQï¼ˆä¸€ï¼‰</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/itfly8/p/5156155.html">å¤§å‹ç½‘ç«™æ¶æ„ç³»åˆ—ï¼šMQï¼ˆäºŒï¼‰</a></li>
<li><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/453c6e7ff81c">åˆ†å¸ƒå¼å¼€æ”¾ MQ(RocketMQ) çš„åŸç†ä¸å®è·µ</a></li>
<li><a target="_blank" rel="noopener" href="https://juejin.im/entry/5a0abfb5f265da43062a4a91">é˜¿é‡Œ RocketMQ ä¼˜åŠ¿å¯¹æ¯”</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/doocs/advanced-java/blob/master/docs/high-concurrency/mq-interview.md">advanced-java ä¹‹ MQ</a></li>
<li><a target="_blank" rel="noopener" href="https://juejin.im/post/6844903635046924296">æµ…è°ˆæ¶ˆæ¯é˜Ÿåˆ—åŠå¸¸è§çš„æ¶ˆæ¯ä¸­é—´ä»¶</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://dunwu.github.io/blog/pages/d407d3f9/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/uploads/avatar.gif">
      <meta itemprop="name" content="é’æ‚Ÿ â—¾ Dunwu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dunwu Blog">
      <meta itemprop="description" content="é’æ‚Ÿçš„ä¸ªäººåšå®¢">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Dunwu Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/pages/d407d3f9/" class="post-title-link" itemprop="url">RocketMQ å¿«é€Ÿå…¥é—¨</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2022-02-17 22:34:30" itemprop="dateCreated datePublished" datetime="2022-02-17T22:34:30+08:00">2022-02-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">æ›´æ–°äº</span>
      <time title="ä¿®æ”¹æ—¶é—´ï¼š2025-09-13 17:56:53" itemprop="dateModified" datetime="2025-09-13T17:56:53+08:00">2025-09-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/%E5%88%86%E5%B8%83%E5%BC%8F/" itemprop="url" rel="index"><span itemprop="name">åˆ†å¸ƒå¼</span></a>
        </span>
          ï¼Œ
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/%E5%88%86%E5%B8%83%E5%BC%8F/%E5%88%86%E5%B8%83%E5%BC%8F%E9%80%9A%E4%BF%A1/" itemprop="url" rel="index"><span itemprop="name">åˆ†å¸ƒå¼é€šä¿¡</span></a>
        </span>
          ï¼Œ
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/%E5%88%86%E5%B8%83%E5%BC%8F/%E5%88%86%E5%B8%83%E5%BC%8F%E9%80%9A%E4%BF%A1/MQ/" itemprop="url" rel="index"><span itemprop="name">MQ</span></a>
        </span>
          ï¼Œ
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/%E5%88%86%E5%B8%83%E5%BC%8F/%E5%88%86%E5%B8%83%E5%BC%8F%E9%80%9A%E4%BF%A1/MQ/RocketMQ/" itemprop="url" rel="index"><span itemprop="name">RocketMQ</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
      <span>13k</span>
    </span>
    <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
      <span>12 åˆ†é’Ÿ</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="RocketMQ-å¿«é€Ÿå…¥é—¨"><a href="#RocketMQ-å¿«é€Ÿå…¥é—¨" class="headerlink" title="RocketMQ å¿«é€Ÿå…¥é—¨"></a>RocketMQ å¿«é€Ÿå…¥é—¨</h1><p>Apache RocketMQ æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼ MQ å’Œæµå¤„ç†å¹³å°ï¼Œå…·æœ‰ä½å»¶è¿Ÿã€é«˜æ€§èƒ½å’Œå¯é æ€§ã€ä¸‡äº¿çº§å®¹é‡å’Œçµæ´»çš„å¯æ‰©å±•æ€§ã€‚</p>
<p>RocketMQ ç”±é˜¿é‡Œå·´å·´å­µåŒ–ï¼Œè¢«æèµ ç»™ Apacheï¼Œæˆä¸º Apache çš„é¡¶çº§é¡¹ç›®ã€‚</p>
<h2 id="RocketMQ-æ¦‚å¿µ"><a href="#RocketMQ-æ¦‚å¿µ" class="headerlink" title="RocketMQ æ¦‚å¿µ"></a>RocketMQ æ¦‚å¿µ</h2><p><img src="https://raw.githubusercontent.com/dunwu/images/master/cs/java/javaweb/distributed/mq/rocketmq/rmq-model.png" alt="img"></p>
<h3 id="æ¶ˆæ¯æ¨¡å‹ï¼ˆMessage-Modelï¼‰"><a href="#æ¶ˆæ¯æ¨¡å‹ï¼ˆMessage-Modelï¼‰" class="headerlink" title="æ¶ˆæ¯æ¨¡å‹ï¼ˆMessage Modelï¼‰"></a>æ¶ˆæ¯æ¨¡å‹ï¼ˆMessage Modelï¼‰</h3><p>RocketMQ ä¸»è¦ç”± Producerã€Brokerã€Consumer ä¸‰éƒ¨åˆ†ç»„æˆï¼Œå…¶ä¸­ Producer è´Ÿè´£ç”Ÿäº§æ¶ˆæ¯ï¼ŒConsumer è´Ÿè´£æ¶ˆè´¹æ¶ˆæ¯ï¼ŒBroker è´Ÿè´£å­˜å‚¨æ¶ˆæ¯ã€‚Broker åœ¨å®é™…éƒ¨ç½²è¿‡ç¨‹ä¸­å¯¹åº”ä¸€å°æœåŠ¡å™¨ï¼Œæ¯ä¸ª Broker å¯ä»¥å­˜å‚¨å¤šä¸ª Topic çš„æ¶ˆæ¯ï¼Œæ¯ä¸ª Topic çš„æ¶ˆæ¯ä¹Ÿå¯ä»¥åˆ†ç‰‡å­˜å‚¨äºä¸åŒçš„ Brokerã€‚Message Queue ç”¨äºå­˜å‚¨æ¶ˆæ¯çš„ç‰©ç†åœ°å€ï¼Œæ¯ä¸ª Topic ä¸­çš„æ¶ˆæ¯åœ°å€å­˜å‚¨äºå¤šä¸ª Message Queue ä¸­ã€‚ConsumerGroup ç”±å¤šä¸ª Consumer å®ä¾‹æ„æˆã€‚</p>
<h3 id="æ¶ˆæ¯ï¼ˆMessageï¼‰"><a href="#æ¶ˆæ¯ï¼ˆMessageï¼‰" class="headerlink" title="æ¶ˆæ¯ï¼ˆMessageï¼‰"></a>æ¶ˆæ¯ï¼ˆMessageï¼‰</h3><p>æ¶ˆæ¯ç³»ç»Ÿæ‰€ä¼ è¾“ä¿¡æ¯çš„ç‰©ç†è½½ä½“ï¼Œç”Ÿäº§å’Œæ¶ˆè´¹æ•°æ®çš„æœ€å°å•ä½ï¼Œæ¯æ¡æ¶ˆæ¯å¿…é¡»å±äºä¸€ä¸ªä¸»é¢˜ã€‚RocketMQ ä¸­æ¯ä¸ªæ¶ˆæ¯æ‹¥æœ‰å”¯ä¸€çš„ Message IDï¼Œä¸”å¯ä»¥æºå¸¦å…·æœ‰ä¸šåŠ¡æ ‡è¯†çš„ Keyã€‚ç³»ç»Ÿæä¾›äº†é€šè¿‡ Message ID å’Œ Key æŸ¥è¯¢æ¶ˆæ¯çš„åŠŸèƒ½ã€‚</p>
<p>æ¶ˆæ¯è¿˜å¯ä»¥å…·æœ‰å¯é€‰ Tag å’Œé¢å¤–çš„é”®å€¼å¯¹ã€‚ä¾‹å¦‚ï¼Œæ‚¨å¯ä»¥ä¸ºæ¶ˆæ¯è®¾ç½®ä¸šåŠ¡å¯†é’¥ï¼Œå¹¶åœ¨ä»£ç†æœåŠ¡å™¨ä¸ŠæŸ¥æ‰¾æ¶ˆæ¯ä»¥è¯Šæ–­å¼€å‘æœŸé—´çš„é—®é¢˜ã€‚</p>
<h3 id="æ ‡ç­¾ï¼ˆTagï¼‰"><a href="#æ ‡ç­¾ï¼ˆTagï¼‰" class="headerlink" title="æ ‡ç­¾ï¼ˆTagï¼‰"></a>æ ‡ç­¾ï¼ˆTagï¼‰</h3><p>ä¸ºæ¶ˆæ¯è®¾ç½®çš„æ ‡å¿—ï¼Œç”¨äºåŒä¸€ä¸»é¢˜ä¸‹åŒºåˆ†ä¸åŒç±»å‹çš„æ¶ˆæ¯ã€‚æ¥è‡ªåŒä¸€ä¸šåŠ¡å•å…ƒçš„æ¶ˆæ¯ï¼Œå¯ä»¥æ ¹æ®ä¸åŒä¸šåŠ¡ç›®çš„åœ¨åŒä¸€ä¸»é¢˜ä¸‹è®¾ç½®ä¸åŒæ ‡ç­¾ã€‚æ ‡ç­¾èƒ½å¤Ÿæœ‰æ•ˆåœ°ä¿æŒä»£ç çš„æ¸…æ™°åº¦å’Œè¿è´¯æ€§ï¼Œå¹¶ä¼˜åŒ– RocketMQ æä¾›çš„æŸ¥è¯¢ç³»ç»Ÿã€‚æ¶ˆè´¹è€…å¯ä»¥æ ¹æ® Tag å®ç°å¯¹ä¸åŒå­ä¸»é¢˜çš„ä¸åŒæ¶ˆè´¹é€»è¾‘ï¼Œå®ç°æ›´å¥½çš„æ‰©å±•æ€§ã€‚</p>
<p>Tag ç›¸å½“äºå­ä¸»é¢˜ï¼Œä¸ºç”¨æˆ·æä¾›äº†é¢å¤–çš„çµæ´»æ€§ã€‚å¯¹äº Tagï¼Œæ¥è‡ªåŒä¸€ä¸šåŠ¡æ¨¡å—çš„å…·æœ‰ä¸åŒç›®çš„çš„æ¶ˆæ¯å¯ä»¥å…·æœ‰ç›¸åŒçš„ä¸»é¢˜å’Œä¸åŒçš„ Tagã€‚</p>
<h3 id="ä¸»é¢˜ï¼ˆTopicï¼‰"><a href="#ä¸»é¢˜ï¼ˆTopicï¼‰" class="headerlink" title="ä¸»é¢˜ï¼ˆTopicï¼‰"></a>ä¸»é¢˜ï¼ˆTopicï¼‰</h3><p>è¡¨ç¤ºä¸€ç±»æ¶ˆæ¯çš„é›†åˆï¼Œæ¯ä¸ªä¸»é¢˜åŒ…å«è‹¥å¹²æ¡æ¶ˆæ¯ï¼Œæ¯æ¡æ¶ˆæ¯åªèƒ½å±äºä¸€ä¸ªä¸»é¢˜ï¼Œæ˜¯ RocketMQ è¿›è¡Œæ¶ˆæ¯è®¢é˜…çš„åŸºæœ¬å•ä½ã€‚</p>
<h3 id="ä»£ç†æœåŠ¡å™¨ï¼ˆBroker-Serverï¼‰"><a href="#ä»£ç†æœåŠ¡å™¨ï¼ˆBroker-Serverï¼‰" class="headerlink" title="ä»£ç†æœåŠ¡å™¨ï¼ˆBroker Serverï¼‰"></a>ä»£ç†æœåŠ¡å™¨ï¼ˆBroker Serverï¼‰</h3><p>æ¶ˆæ¯ä¸­è½¬è§’è‰²ï¼Œè´Ÿè´£å­˜å‚¨æ¶ˆæ¯ã€è½¬å‘æ¶ˆæ¯ã€‚ä»£ç†æœåŠ¡å™¨åœ¨ RocketMQ ç³»ç»Ÿä¸­è´Ÿè´£æ¥æ”¶ä»ç”Ÿäº§è€…å‘é€æ¥çš„æ¶ˆæ¯å¹¶å­˜å‚¨ã€åŒæ—¶ä¸ºæ¶ˆè´¹è€…çš„æ‹‰å–è¯·æ±‚ä½œå‡†å¤‡ã€‚ä»£ç†æœåŠ¡å™¨ä¹Ÿå­˜å‚¨æ¶ˆæ¯ç›¸å…³çš„å…ƒæ•°æ®ï¼ŒåŒ…æ‹¬æ¶ˆè´¹è€…ç»„ã€æ¶ˆè´¹è¿›åº¦åç§»å’Œä¸»é¢˜å’Œé˜Ÿåˆ—æ¶ˆæ¯ç­‰ã€‚</p>
<h3 id="åç§°æœåŠ¡ï¼ˆName-Serverï¼‰"><a href="#åç§°æœåŠ¡ï¼ˆName-Serverï¼‰" class="headerlink" title="åç§°æœåŠ¡ï¼ˆName Serverï¼‰"></a>åç§°æœåŠ¡ï¼ˆName Serverï¼‰</h3><p>åç§°æœåŠ¡å……å½“è·¯ç”±æ¶ˆæ¯çš„æä¾›è€…ã€‚ç”Ÿäº§è€…æˆ–æ¶ˆè´¹è€…èƒ½å¤Ÿé€šè¿‡åç§°æœåŠ¡æŸ¥æ‰¾å„ä¸»é¢˜ç›¸åº”çš„ Broker IP åˆ—è¡¨ã€‚å¤šä¸ª Namesrv å®ä¾‹ç»„æˆé›†ç¾¤ï¼Œä½†ç›¸äº’ç‹¬ç«‹ï¼Œæ²¡æœ‰ä¿¡æ¯äº¤æ¢ã€‚</p>
<h3 id="æ¶ˆæ¯ç”Ÿäº§è€…ï¼ˆProducerï¼‰"><a href="#æ¶ˆæ¯ç”Ÿäº§è€…ï¼ˆProducerï¼‰" class="headerlink" title="æ¶ˆæ¯ç”Ÿäº§è€…ï¼ˆProducerï¼‰"></a>æ¶ˆæ¯ç”Ÿäº§è€…ï¼ˆProducerï¼‰</h3><p>è´Ÿè´£ç”Ÿäº§æ¶ˆæ¯ï¼Œä¸€èˆ¬ç”±ä¸šåŠ¡ç³»ç»Ÿè´Ÿè´£ç”Ÿäº§æ¶ˆæ¯ã€‚ä¸€ä¸ªæ¶ˆæ¯ç”Ÿäº§è€…ä¼šæŠŠä¸šåŠ¡åº”ç”¨ç³»ç»Ÿé‡Œäº§ç”Ÿçš„æ¶ˆæ¯å‘é€åˆ° broker æœåŠ¡å™¨ã€‚RocketMQ æä¾›å¤šç§å‘é€æ–¹å¼ï¼ŒåŒæ­¥å‘é€ã€å¼‚æ­¥å‘é€ã€é¡ºåºå‘é€ã€å•å‘å‘é€ã€‚åŒæ­¥å’Œå¼‚æ­¥æ–¹å¼å‡éœ€è¦ Broker è¿”å›ç¡®è®¤ä¿¡æ¯ï¼Œå•å‘å‘é€ä¸éœ€è¦ã€‚</p>
<h3 id="ç”Ÿäº§è€…ç»„ï¼ˆProducer-Groupï¼‰"><a href="#ç”Ÿäº§è€…ç»„ï¼ˆProducer-Groupï¼‰" class="headerlink" title="ç”Ÿäº§è€…ç»„ï¼ˆProducer Groupï¼‰"></a>ç”Ÿäº§è€…ç»„ï¼ˆProducer Groupï¼‰</h3><p>åŒä¸€ç±» Producer çš„é›†åˆï¼Œè¿™ç±» Producer å‘é€åŒä¸€ç±»æ¶ˆæ¯ä¸”å‘é€é€»è¾‘ä¸€è‡´ã€‚å¦‚æœå‘é€çš„æ˜¯äº‹åŠ¡æ¶ˆæ¯ä¸”åŸå§‹ç”Ÿäº§è€…åœ¨å‘é€ä¹‹åå´©æºƒï¼Œåˆ™ Broker æœåŠ¡å™¨ä¼šè”ç³»åŒä¸€ç”Ÿäº§è€…ç»„çš„å…¶ä»–ç”Ÿäº§è€…å®ä¾‹ä»¥æäº¤æˆ–å›æº¯æ¶ˆè´¹ã€‚</p>
<p>è­¦å‘Šï¼šè€ƒè™‘åˆ°æä¾›çš„ Producer åœ¨å‘é€æ¶ˆæ¯æ–¹é¢è¶³å¤Ÿå¼ºå¤§ï¼Œ<strong>æ¯ä¸ª Producer ç»„åªå…è®¸ä¸€ä¸ªå®ä¾‹ï¼Œä»¥é¿å…ä¸å¿…è¦çš„ç”Ÿæˆå™¨å®ä¾‹åˆå§‹åŒ–</strong>ã€‚</p>
<h3 id="æ¶ˆæ¯æ¶ˆè´¹è€…ï¼ˆConsumerï¼‰"><a href="#æ¶ˆæ¯æ¶ˆè´¹è€…ï¼ˆConsumerï¼‰" class="headerlink" title="æ¶ˆæ¯æ¶ˆè´¹è€…ï¼ˆConsumerï¼‰"></a>æ¶ˆæ¯æ¶ˆè´¹è€…ï¼ˆConsumerï¼‰</h3><p>è´Ÿè´£æ¶ˆè´¹æ¶ˆæ¯ï¼Œä¸€èˆ¬æ˜¯åå°ç³»ç»Ÿè´Ÿè´£å¼‚æ­¥æ¶ˆè´¹ã€‚ä¸€ä¸ªæ¶ˆæ¯æ¶ˆè´¹è€…ä¼šä» Broker æœåŠ¡å™¨æ‹‰å–æ¶ˆæ¯ã€å¹¶å°†å…¶æä¾›ç»™åº”ç”¨ç¨‹åºã€‚ä»ç”¨æˆ·åº”ç”¨çš„è§’åº¦è€Œè¨€æä¾›äº†ä¸¤ç§æ¶ˆè´¹å½¢å¼ï¼šæ‹‰å–å¼æ¶ˆè´¹ã€æ¨åŠ¨å¼æ¶ˆè´¹ã€‚</p>
<h3 id="æ¶ˆè´¹è€…ç»„ï¼ˆConsumer-Groupï¼‰"><a href="#æ¶ˆè´¹è€…ç»„ï¼ˆConsumer-Groupï¼‰" class="headerlink" title="æ¶ˆè´¹è€…ç»„ï¼ˆConsumer Groupï¼‰"></a>æ¶ˆè´¹è€…ç»„ï¼ˆConsumer Groupï¼‰</h3><p>åŒä¸€ç±» Consumer çš„é›†åˆï¼Œè¿™ç±» Consumer é€šå¸¸æ¶ˆè´¹åŒä¸€ç±»æ¶ˆæ¯ä¸”æ¶ˆè´¹é€»è¾‘ä¸€è‡´ã€‚æ¶ˆè´¹è€…ç»„ä½¿å¾—åœ¨æ¶ˆæ¯æ¶ˆè´¹æ–¹é¢ï¼Œå®ç°è´Ÿè½½å‡è¡¡å’Œå®¹é”™çš„ç›®æ ‡å˜å¾—éå¸¸å®¹æ˜“ã€‚è¦æ³¨æ„çš„æ˜¯ï¼Œ<strong>æ¶ˆè´¹è€…ç»„çš„æ¶ˆè´¹è€…å®ä¾‹å¿…é¡»è®¢é˜…å®Œå…¨ç›¸åŒçš„ Topic</strong>ã€‚RocketMQ æ”¯æŒä¸¤ç§æ¶ˆæ¯æ¨¡å¼ï¼šé›†ç¾¤æ¶ˆè´¹ï¼ˆClusteringï¼‰å’Œå¹¿æ’­æ¶ˆè´¹ï¼ˆBroadcastingï¼‰ã€‚</p>
<h3 id="æ‹‰å–å¼æ¶ˆè´¹ï¼ˆPull-Consumerï¼‰"><a href="#æ‹‰å–å¼æ¶ˆè´¹ï¼ˆPull-Consumerï¼‰" class="headerlink" title="æ‹‰å–å¼æ¶ˆè´¹ï¼ˆPull Consumerï¼‰"></a>æ‹‰å–å¼æ¶ˆè´¹ï¼ˆPull Consumerï¼‰</h3><p>Consumer æ¶ˆè´¹çš„ä¸€ç§ç±»å‹ï¼Œåº”ç”¨é€šå¸¸ä¸»åŠ¨è°ƒç”¨ Consumer çš„æ‹‰æ¶ˆæ¯æ–¹æ³•ä» Broker æœåŠ¡å™¨æ‹‰æ¶ˆæ¯ã€ä¸»åŠ¨æƒç”±åº”ç”¨æ§åˆ¶ã€‚ä¸€æ—¦è·å–äº†æ‰¹é‡æ¶ˆæ¯ï¼Œåº”ç”¨å°±ä¼šå¯åŠ¨æ¶ˆè´¹è¿‡ç¨‹ã€‚</p>
<h3 id="æ¨åŠ¨å¼æ¶ˆè´¹ï¼ˆPush-Consumerï¼‰"><a href="#æ¨åŠ¨å¼æ¶ˆè´¹ï¼ˆPush-Consumerï¼‰" class="headerlink" title="æ¨åŠ¨å¼æ¶ˆè´¹ï¼ˆPush Consumerï¼‰"></a>æ¨åŠ¨å¼æ¶ˆè´¹ï¼ˆPush Consumerï¼‰</h3><p>Consumer æ¶ˆè´¹çš„ä¸€ç§ç±»å‹ï¼Œè¯¥æ¨¡å¼ä¸‹ Broker æ”¶åˆ°æ•°æ®åä¼šä¸»åŠ¨æ¨é€ç»™æ¶ˆè´¹ç«¯ï¼Œè¯¥æ¶ˆè´¹æ¨¡å¼ä¸€èˆ¬å®æ—¶æ€§è¾ƒé«˜ã€‚</p>
<h3 id="é›†ç¾¤æ¶ˆè´¹ï¼ˆClusteringï¼‰"><a href="#é›†ç¾¤æ¶ˆè´¹ï¼ˆClusteringï¼‰" class="headerlink" title="é›†ç¾¤æ¶ˆè´¹ï¼ˆClusteringï¼‰"></a>é›†ç¾¤æ¶ˆè´¹ï¼ˆClusteringï¼‰</h3><p>é›†ç¾¤æ¶ˆè´¹æ¨¡å¼ä¸‹,ç›¸åŒ Consumer Group çš„æ¯ä¸ª Consumer å®ä¾‹å¹³å‡åˆ†æ‘Šæ¶ˆæ¯ã€‚</p>
<h3 id="å¹¿æ’­æ¶ˆè´¹ï¼ˆBroadcastingï¼‰"><a href="#å¹¿æ’­æ¶ˆè´¹ï¼ˆBroadcastingï¼‰" class="headerlink" title="å¹¿æ’­æ¶ˆè´¹ï¼ˆBroadcastingï¼‰"></a>å¹¿æ’­æ¶ˆè´¹ï¼ˆBroadcastingï¼‰</h3><p>å¹¿æ’­æ¶ˆè´¹æ¨¡å¼ä¸‹ï¼Œç›¸åŒ Consumer Group çš„æ¯ä¸ª Consumer å®ä¾‹éƒ½æ¥æ”¶å…¨é‡çš„æ¶ˆæ¯ã€‚</p>
<h3 id="æ™®é€šé¡ºåºæ¶ˆæ¯ï¼ˆNormal-Ordered-Messageï¼‰"><a href="#æ™®é€šé¡ºåºæ¶ˆæ¯ï¼ˆNormal-Ordered-Messageï¼‰" class="headerlink" title="æ™®é€šé¡ºåºæ¶ˆæ¯ï¼ˆNormal Ordered Messageï¼‰"></a>æ™®é€šé¡ºåºæ¶ˆæ¯ï¼ˆNormal Ordered Messageï¼‰</h3><p>æ™®é€šé¡ºåºæ¶ˆè´¹æ¨¡å¼ä¸‹ï¼Œæ¶ˆè´¹è€…é€šè¿‡åŒä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼ˆ Topic åˆ†åŒºï¼Œç§°ä½œ Message Queueï¼‰ æ”¶åˆ°çš„æ¶ˆæ¯æ˜¯æœ‰é¡ºåºçš„ï¼Œä¸åŒæ¶ˆæ¯é˜Ÿåˆ—æ”¶åˆ°çš„æ¶ˆæ¯åˆ™å¯èƒ½æ˜¯æ— é¡ºåºçš„ã€‚</p>
<h3 id="ä¸¥æ ¼é¡ºåºæ¶ˆæ¯ï¼ˆStrictly-Ordered-Messageï¼‰"><a href="#ä¸¥æ ¼é¡ºåºæ¶ˆæ¯ï¼ˆStrictly-Ordered-Messageï¼‰" class="headerlink" title="ä¸¥æ ¼é¡ºåºæ¶ˆæ¯ï¼ˆStrictly Ordered Messageï¼‰"></a>ä¸¥æ ¼é¡ºåºæ¶ˆæ¯ï¼ˆStrictly Ordered Messageï¼‰</h3><p>ä¸¥æ ¼é¡ºåºæ¶ˆæ¯æ¨¡å¼ä¸‹ï¼Œæ¶ˆè´¹è€…æ”¶åˆ°çš„æ‰€æœ‰æ¶ˆæ¯å‡æ˜¯æœ‰é¡ºåºçš„ã€‚</p>
<h2 id="RocketMQ-ç‰¹æ€§"><a href="#RocketMQ-ç‰¹æ€§" class="headerlink" title="RocketMQ ç‰¹æ€§"></a>RocketMQ ç‰¹æ€§</h2><h3 id="è®¢é˜…ä¸å‘å¸ƒ"><a href="#è®¢é˜…ä¸å‘å¸ƒ" class="headerlink" title="è®¢é˜…ä¸å‘å¸ƒ"></a>è®¢é˜…ä¸å‘å¸ƒ</h3><p>æ¶ˆæ¯çš„å‘å¸ƒæ˜¯æŒ‡æŸä¸ªç”Ÿäº§è€…å‘æŸä¸ª topic å‘é€æ¶ˆæ¯ï¼›æ¶ˆæ¯çš„è®¢é˜…æ˜¯æŒ‡æŸä¸ªæ¶ˆè´¹è€…å…³æ³¨äº†æŸä¸ª topic ä¸­å¸¦æœ‰æŸäº› tag çš„æ¶ˆæ¯ï¼Œè¿›è€Œä»è¯¥ topic æ¶ˆè´¹æ•°æ®ã€‚</p>
<h3 id="æ¶ˆæ¯é¡ºåº"><a href="#æ¶ˆæ¯é¡ºåº" class="headerlink" title="æ¶ˆæ¯é¡ºåº"></a>æ¶ˆæ¯é¡ºåº</h3><p>æ¶ˆæ¯æœ‰åºæŒ‡çš„æ˜¯ä¸€ç±»æ¶ˆæ¯æ¶ˆè´¹æ—¶ï¼Œèƒ½æŒ‰ç…§å‘é€çš„é¡ºåºæ¥æ¶ˆè´¹ã€‚ä¾‹å¦‚ï¼šä¸€ä¸ªè®¢å•äº§ç”Ÿäº†ä¸‰æ¡æ¶ˆæ¯åˆ†åˆ«æ˜¯è®¢å•åˆ›å»ºã€è®¢å•ä»˜æ¬¾ã€è®¢å•å®Œæˆã€‚æ¶ˆè´¹æ—¶è¦æŒ‰ç…§è¿™ä¸ªé¡ºåºæ¶ˆè´¹æ‰èƒ½æœ‰æ„ä¹‰ï¼Œä½†æ˜¯åŒæ—¶è®¢å•ä¹‹é—´æ˜¯å¯ä»¥å¹¶è¡Œæ¶ˆè´¹çš„ã€‚RocketMQ å¯ä»¥ä¸¥æ ¼çš„ä¿è¯æ¶ˆæ¯æœ‰åºã€‚</p>
<p>é¡ºåºæ¶ˆæ¯åˆ†ä¸ºå…¨å±€é¡ºåºæ¶ˆæ¯ä¸åˆ†åŒºé¡ºåºæ¶ˆæ¯ï¼Œå…¨å±€é¡ºåºæ˜¯æŒ‡æŸä¸ª Topic ä¸‹çš„æ‰€æœ‰æ¶ˆæ¯éƒ½è¦ä¿è¯é¡ºåºï¼›éƒ¨åˆ†é¡ºåºæ¶ˆæ¯åªè¦ä¿è¯æ¯ä¸€ç»„æ¶ˆæ¯è¢«é¡ºåºæ¶ˆè´¹å³å¯ã€‚</p>
<ul>
<li>å…¨å±€é¡ºåº å¯¹äºæŒ‡å®šçš„ä¸€ä¸ª Topicï¼Œæ‰€æœ‰æ¶ˆæ¯æŒ‰ç…§ä¸¥æ ¼çš„å…ˆå…¥å…ˆå‡ºï¼ˆFIFOï¼‰çš„é¡ºåºè¿›è¡Œå‘å¸ƒå’Œæ¶ˆè´¹ã€‚ é€‚ç”¨åœºæ™¯ï¼šæ€§èƒ½è¦æ±‚ä¸é«˜ï¼Œæ‰€æœ‰çš„æ¶ˆæ¯ä¸¥æ ¼æŒ‰ç…§ FIFO åŸåˆ™è¿›è¡Œæ¶ˆæ¯å‘å¸ƒå’Œæ¶ˆè´¹çš„åœºæ™¯</li>
<li>åˆ†åŒºé¡ºåº å¯¹äºæŒ‡å®šçš„ä¸€ä¸ª Topicï¼Œæ‰€æœ‰æ¶ˆæ¯æ ¹æ® sharding key è¿›è¡ŒåŒºå—åˆ†åŒºã€‚ åŒä¸€ä¸ªåˆ†åŒºå†…çš„æ¶ˆæ¯æŒ‰ç…§ä¸¥æ ¼çš„ FIFO é¡ºåºè¿›è¡Œå‘å¸ƒå’Œæ¶ˆè´¹ã€‚ Sharding key æ˜¯é¡ºåºæ¶ˆæ¯ä¸­ç”¨æ¥åŒºåˆ†ä¸åŒåˆ†åŒºçš„å…³é”®å­—æ®µï¼Œå’Œæ™®é€šæ¶ˆæ¯çš„ Key æ˜¯å®Œå…¨ä¸åŒçš„æ¦‚å¿µã€‚ é€‚ç”¨åœºæ™¯ï¼šæ€§èƒ½è¦æ±‚é«˜ï¼Œä»¥ sharding key ä½œä¸ºåˆ†åŒºå­—æ®µï¼Œåœ¨åŒä¸€ä¸ªåŒºå—ä¸­ä¸¥æ ¼çš„æŒ‰ç…§ FIFO åŸåˆ™è¿›è¡Œæ¶ˆæ¯å‘å¸ƒå’Œæ¶ˆè´¹çš„åœºæ™¯ã€‚</li>
</ul>
<h3 id="æ¶ˆæ¯è¿‡æ»¤"><a href="#æ¶ˆæ¯è¿‡æ»¤" class="headerlink" title="æ¶ˆæ¯è¿‡æ»¤"></a>æ¶ˆæ¯è¿‡æ»¤</h3><p>RocketMQ çš„æ¶ˆè´¹è€…å¯ä»¥æ ¹æ® Tag è¿›è¡Œæ¶ˆæ¯è¿‡æ»¤ï¼Œä¹Ÿæ”¯æŒè‡ªå®šä¹‰å±æ€§è¿‡æ»¤ã€‚æ¶ˆæ¯è¿‡æ»¤ç›®å‰æ˜¯åœ¨ Broker ç«¯å®ç°çš„ï¼Œä¼˜ç‚¹æ˜¯å‡å°‘äº†å¯¹äº Consumer æ— ç”¨æ¶ˆæ¯çš„ç½‘ç»œä¼ è¾“ï¼Œç¼ºç‚¹æ˜¯å¢åŠ äº† Broker çš„è´Ÿæ‹…ã€è€Œä¸”å®ç°ç›¸å¯¹å¤æ‚ã€‚</p>
<h3 id="æ¶ˆæ¯å¯é æ€§"><a href="#æ¶ˆæ¯å¯é æ€§" class="headerlink" title="æ¶ˆæ¯å¯é æ€§"></a>æ¶ˆæ¯å¯é æ€§</h3><p>RocketMQ æ”¯æŒæ¶ˆæ¯çš„é«˜å¯é ï¼Œå½±å“æ¶ˆæ¯å¯é æ€§çš„å‡ ç§æƒ…å†µï¼š</p>
<ol>
<li>Broker éæ­£å¸¸å…³é—­</li>
<li>Broker å¼‚å¸¸ Crash</li>
<li>OS Crash</li>
<li>æœºå™¨æ‰ç”µï¼Œä½†æ˜¯èƒ½ç«‹å³æ¢å¤ä¾›ç”µæƒ…å†µ</li>
<li>æœºå™¨æ— æ³•å¼€æœºï¼ˆå¯èƒ½æ˜¯ cpuã€ä¸»æ¿ã€å†…å­˜ç­‰å…³é”®è®¾å¤‡æŸåï¼‰</li>
<li>ç£ç›˜è®¾å¤‡æŸå</li>
</ol>
<p>1)ã€2)ã€3)ã€4) å››ç§æƒ…å†µéƒ½å±äºç¡¬ä»¶èµ„æºå¯ç«‹å³æ¢å¤æƒ…å†µï¼ŒRocketMQ åœ¨è¿™å››ç§æƒ…å†µä¸‹èƒ½ä¿è¯æ¶ˆæ¯ä¸ä¸¢ï¼Œæˆ–è€…ä¸¢å¤±å°‘é‡æ•°æ®ï¼ˆä¾èµ–åˆ·ç›˜æ–¹å¼æ˜¯åŒæ­¥è¿˜æ˜¯å¼‚æ­¥ï¼‰ã€‚</p>
<p>5)ã€6)å±äºå•ç‚¹æ•…éšœï¼Œä¸”æ— æ³•æ¢å¤ï¼Œä¸€æ—¦å‘ç”Ÿï¼Œåœ¨æ­¤å•ç‚¹ä¸Šçš„æ¶ˆæ¯å…¨éƒ¨ä¸¢å¤±ã€‚RocketMQ åœ¨è¿™ä¸¤ç§æƒ…å†µä¸‹ï¼Œé€šè¿‡å¼‚æ­¥å¤åˆ¶ï¼Œå¯ä¿è¯ 99%çš„æ¶ˆæ¯ä¸ä¸¢ï¼Œä½†æ˜¯ä»ç„¶ä¼šæœ‰æå°‘é‡çš„æ¶ˆæ¯å¯èƒ½ä¸¢å¤±ã€‚é€šè¿‡åŒæ­¥åŒå†™æŠ€æœ¯å¯ä»¥å®Œå…¨é¿å…å•ç‚¹ï¼ŒåŒæ­¥åŒå†™åŠ¿å¿…ä¼šå½±å“æ€§èƒ½ï¼Œé€‚åˆå¯¹æ¶ˆæ¯å¯é æ€§è¦æ±‚æé«˜çš„åœºåˆï¼Œä¾‹å¦‚ä¸ Money ç›¸å…³çš„åº”ç”¨ã€‚æ³¨ï¼šRocketMQ ä» 3.0 ç‰ˆæœ¬å¼€å§‹æ”¯æŒåŒæ­¥åŒå†™ã€‚</p>
<h3 id="è‡³å°‘ä¸€æ¬¡"><a href="#è‡³å°‘ä¸€æ¬¡" class="headerlink" title="è‡³å°‘ä¸€æ¬¡"></a>è‡³å°‘ä¸€æ¬¡</h3><p>è‡³å°‘ä¸€æ¬¡(At least Once)æŒ‡æ¯ä¸ªæ¶ˆæ¯å¿…é¡»æŠ•é€’ä¸€æ¬¡ã€‚Consumer å…ˆ Pull æ¶ˆæ¯åˆ°æœ¬åœ°ï¼Œæ¶ˆè´¹å®Œæˆåï¼Œæ‰å‘æœåŠ¡å™¨è¿”å› ackï¼Œå¦‚æœæ²¡æœ‰æ¶ˆè´¹ä¸€å®šä¸ä¼š ack æ¶ˆæ¯ï¼Œæ‰€ä»¥ RocketMQ å¯ä»¥å¾ˆå¥½çš„æ”¯æŒæ­¤ç‰¹æ€§ã€‚</p>
<h3 id="å›æº¯æ¶ˆè´¹"><a href="#å›æº¯æ¶ˆè´¹" class="headerlink" title="å›æº¯æ¶ˆè´¹"></a>å›æº¯æ¶ˆè´¹</h3><p>å›æº¯æ¶ˆè´¹æ˜¯æŒ‡ Consumer å·²ç»æ¶ˆè´¹æˆåŠŸçš„æ¶ˆæ¯ï¼Œç”±äºä¸šåŠ¡ä¸Šéœ€æ±‚éœ€è¦é‡æ–°æ¶ˆè´¹ï¼Œè¦æ”¯æŒæ­¤åŠŸèƒ½ï¼ŒBroker åœ¨å‘ Consumer æŠ•é€’æˆåŠŸæ¶ˆæ¯åï¼Œæ¶ˆæ¯ä»ç„¶éœ€è¦ä¿ç•™ã€‚å¹¶ä¸”é‡æ–°æ¶ˆè´¹ä¸€èˆ¬æ˜¯æŒ‰ç…§æ—¶é—´ç»´åº¦ï¼Œä¾‹å¦‚ç”±äº Consumer ç³»ç»Ÿæ•…éšœï¼Œæ¢å¤åéœ€è¦é‡æ–°æ¶ˆè´¹ 1 å°æ—¶å‰çš„æ•°æ®ï¼Œé‚£ä¹ˆ Broker è¦æä¾›ä¸€ç§æœºåˆ¶ï¼Œå¯ä»¥æŒ‰ç…§æ—¶é—´ç»´åº¦æ¥å›é€€æ¶ˆè´¹è¿›åº¦ã€‚RocketMQ æ”¯æŒæŒ‰ç…§æ—¶é—´å›æº¯æ¶ˆè´¹ï¼Œæ—¶é—´ç»´åº¦ç²¾ç¡®åˆ°æ¯«ç§’ã€‚</p>
<h3 id="äº‹åŠ¡æ¶ˆæ¯"><a href="#äº‹åŠ¡æ¶ˆæ¯" class="headerlink" title="äº‹åŠ¡æ¶ˆæ¯"></a>äº‹åŠ¡æ¶ˆæ¯</h3><p>RocketMQ äº‹åŠ¡æ¶ˆæ¯ï¼ˆTransactional Messageï¼‰æ˜¯æŒ‡åº”ç”¨æœ¬åœ°äº‹åŠ¡å’Œå‘é€æ¶ˆæ¯æ“ä½œå¯ä»¥è¢«å®šä¹‰åˆ°å…¨å±€äº‹åŠ¡ä¸­ï¼Œè¦ä¹ˆåŒæ—¶æˆåŠŸï¼Œè¦ä¹ˆåŒæ—¶å¤±è´¥ã€‚RocketMQ çš„äº‹åŠ¡æ¶ˆæ¯æä¾›ç±»ä¼¼ X&#x2F;Open XA çš„åˆ†å¸ƒäº‹åŠ¡åŠŸèƒ½ï¼Œé€šè¿‡äº‹åŠ¡æ¶ˆæ¯èƒ½è¾¾åˆ°åˆ†å¸ƒå¼äº‹åŠ¡çš„æœ€ç»ˆä¸€è‡´ã€‚</p>
<h3 id="å®šæ—¶æ¶ˆæ¯"><a href="#å®šæ—¶æ¶ˆæ¯" class="headerlink" title="å®šæ—¶æ¶ˆæ¯"></a>å®šæ—¶æ¶ˆæ¯</h3><p>å®šæ—¶æ¶ˆæ¯ï¼ˆå»¶è¿Ÿé˜Ÿåˆ—ï¼‰æ˜¯æŒ‡æ¶ˆæ¯å‘é€åˆ° broker åï¼Œä¸ä¼šç«‹å³è¢«æ¶ˆè´¹ï¼Œç­‰å¾…ç‰¹å®šæ—¶é—´æŠ•é€’ç»™çœŸæ­£çš„ topicã€‚ broker æœ‰é…ç½®é¡¹ messageDelayLevelï¼Œé»˜è®¤å€¼ä¸ºâ€œ1s 5s 10s 30s 1m 2m 3m 4m 5m 6m 7m 8m 9m 10m 20m 30m 1h 2hâ€ï¼Œ18 ä¸ª levelã€‚å¯ä»¥é…ç½®è‡ªå®šä¹‰ messageDelayLevelã€‚æ³¨æ„ï¼ŒmessageDelayLevel æ˜¯ broker çš„å±æ€§ï¼Œä¸å±äºæŸä¸ª topicã€‚å‘æ¶ˆæ¯æ—¶ï¼Œè®¾ç½® delayLevel ç­‰çº§å³å¯ï¼šmsg.setDelayLevel(level)ã€‚level æœ‰ä»¥ä¸‹ä¸‰ç§æƒ…å†µï¼š</p>
<ul>
<li>level &#x3D;&#x3D; 0ï¼Œæ¶ˆæ¯ä¸ºéå»¶è¿Ÿæ¶ˆæ¯</li>
<li>1&lt;&#x3D;level&lt;&#x3D;maxLevelï¼Œæ¶ˆæ¯å»¶è¿Ÿç‰¹å®šæ—¶é—´ï¼Œä¾‹å¦‚ level&#x3D;&#x3D;1ï¼Œå»¶è¿Ÿ 1s</li>
<li>level &gt; maxLevelï¼Œåˆ™ level&#x3D;&#x3D; maxLevelï¼Œä¾‹å¦‚ level&#x3D;&#x3D;20ï¼Œå»¶è¿Ÿ 2h</li>
</ul>
<p>å®šæ—¶æ¶ˆæ¯ä¼šæš‚å­˜åœ¨åä¸º SCHEDULE_TOPIC_XXXX çš„ topic ä¸­ï¼Œå¹¶æ ¹æ® delayTimeLevel å­˜å…¥ç‰¹å®šçš„ queueï¼ŒqueueId &#x3D; delayTimeLevel â€“ 1ï¼Œå³ä¸€ä¸ª queue åªå­˜ç›¸åŒå»¶è¿Ÿçš„æ¶ˆæ¯ï¼Œä¿è¯å…·æœ‰ç›¸åŒå‘é€å»¶è¿Ÿçš„æ¶ˆæ¯èƒ½å¤Ÿé¡ºåºæ¶ˆè´¹ã€‚broker ä¼šè°ƒåº¦åœ°æ¶ˆè´¹ SCHEDULE_TOPIC_XXXXï¼Œå°†æ¶ˆæ¯å†™å…¥çœŸå®çš„ topicã€‚</p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå®šæ—¶æ¶ˆæ¯ä¼šåœ¨ç¬¬ä¸€æ¬¡å†™å…¥å’Œè°ƒåº¦å†™å…¥çœŸå® topic æ—¶éƒ½ä¼šè®¡æ•°ï¼Œå› æ­¤å‘é€æ•°é‡ã€tps éƒ½ä¼šå˜é«˜ã€‚</p>
<h3 id="æ¶ˆæ¯é‡è¯•"><a href="#æ¶ˆæ¯é‡è¯•" class="headerlink" title="æ¶ˆæ¯é‡è¯•"></a>æ¶ˆæ¯é‡è¯•</h3><p>Consumer æ¶ˆè´¹æ¶ˆæ¯å¤±è´¥åï¼Œè¦æä¾›ä¸€ç§é‡è¯•æœºåˆ¶ï¼Œä»¤æ¶ˆæ¯å†æ¶ˆè´¹ä¸€æ¬¡ã€‚Consumer æ¶ˆè´¹æ¶ˆæ¯å¤±è´¥é€šå¸¸å¯ä»¥è®¤ä¸ºæœ‰ä»¥ä¸‹å‡ ç§æƒ…å†µï¼š</p>
<ul>
<li>ç”±äºæ¶ˆæ¯æœ¬èº«çš„åŸå› ï¼Œä¾‹å¦‚ååºåˆ—åŒ–å¤±è´¥ï¼Œæ¶ˆæ¯æ•°æ®æœ¬èº«æ— æ³•å¤„ç†ï¼ˆä¾‹å¦‚è¯è´¹å……å€¼ï¼Œå½“å‰æ¶ˆæ¯çš„æ‰‹æœºå·è¢«æ³¨é”€ï¼Œæ— æ³•å……å€¼ï¼‰ç­‰ã€‚è¿™ç§é”™è¯¯é€šå¸¸éœ€è¦è·³è¿‡è¿™æ¡æ¶ˆæ¯ï¼Œå†æ¶ˆè´¹å…¶å®ƒæ¶ˆæ¯ï¼Œè€Œè¿™æ¡å¤±è´¥çš„æ¶ˆæ¯å³ä½¿ç«‹åˆ»é‡è¯•æ¶ˆè´¹ï¼Œ99%ä¹Ÿä¸æˆåŠŸï¼Œæ‰€ä»¥æœ€å¥½æä¾›ä¸€ç§å®šæ—¶é‡è¯•æœºåˆ¶ï¼Œå³è¿‡ 10 ç§’åå†é‡è¯•ã€‚</li>
<li>ç”±äºä¾èµ–çš„ä¸‹æ¸¸åº”ç”¨æœåŠ¡ä¸å¯ç”¨ï¼Œä¾‹å¦‚ db è¿æ¥ä¸å¯ç”¨ï¼Œå¤–ç³»ç»Ÿç½‘ç»œä¸å¯è¾¾ç­‰ã€‚é‡åˆ°è¿™ç§é”™è¯¯ï¼Œå³ä½¿è·³è¿‡å½“å‰å¤±è´¥çš„æ¶ˆæ¯ï¼Œæ¶ˆè´¹å…¶ä»–æ¶ˆæ¯åŒæ ·ä¹Ÿä¼šæŠ¥é”™ã€‚è¿™ç§æƒ…å†µå»ºè®®åº”ç”¨ sleep 30sï¼Œå†æ¶ˆè´¹ä¸‹ä¸€æ¡æ¶ˆæ¯ï¼Œè¿™æ ·å¯ä»¥å‡è½» Broker é‡è¯•æ¶ˆæ¯çš„å‹åŠ›ã€‚</li>
</ul>
<p>RocketMQ ä¼šä¸ºæ¯ä¸ªæ¶ˆè´¹ç»„éƒ½è®¾ç½®ä¸€ä¸ª Topic åç§°ä¸ºâ€œ%RETRY%+consumerGroupâ€çš„é‡è¯•é˜Ÿåˆ—ï¼ˆè¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸ª Topic çš„é‡è¯•é˜Ÿåˆ—æ˜¯é’ˆå¯¹æ¶ˆè´¹ç»„ï¼Œè€Œä¸æ˜¯é’ˆå¯¹æ¯ä¸ª Topic è®¾ç½®çš„ï¼‰ï¼Œç”¨äºæš‚æ—¶ä¿å­˜å› ä¸ºå„ç§å¼‚å¸¸è€Œå¯¼è‡´ Consumer ç«¯æ— æ³•æ¶ˆè´¹çš„æ¶ˆæ¯ã€‚è€ƒè™‘åˆ°å¼‚å¸¸æ¢å¤èµ·æ¥éœ€è¦ä¸€äº›æ—¶é—´ï¼Œä¼šä¸ºé‡è¯•é˜Ÿåˆ—è®¾ç½®å¤šä¸ªé‡è¯•çº§åˆ«ï¼Œæ¯ä¸ªé‡è¯•çº§åˆ«éƒ½æœ‰ä¸ä¹‹å¯¹åº”çš„é‡æ–°æŠ•é€’å»¶æ—¶ï¼Œé‡è¯•æ¬¡æ•°è¶Šå¤šæŠ•é€’å»¶æ—¶å°±è¶Šå¤§ã€‚RocketMQ å¯¹äºé‡è¯•æ¶ˆæ¯çš„å¤„ç†æ˜¯å…ˆä¿å­˜è‡³ Topic åç§°ä¸ºâ€œSCHEDULE_TOPIC_XXXXâ€çš„å»¶è¿Ÿé˜Ÿåˆ—ä¸­ï¼Œåå°å®šæ—¶ä»»åŠ¡æŒ‰ç…§å¯¹åº”çš„æ—¶é—´è¿›è¡Œ Delay åé‡æ–°ä¿å­˜è‡³â€œ%RETRY%+consumerGroupâ€çš„é‡è¯•é˜Ÿåˆ—ä¸­ã€‚</p>
<h3 id="æ¶ˆæ¯é‡æŠ•"><a href="#æ¶ˆæ¯é‡æŠ•" class="headerlink" title="æ¶ˆæ¯é‡æŠ•"></a>æ¶ˆæ¯é‡æŠ•</h3><p>ç”Ÿäº§è€…åœ¨å‘é€æ¶ˆæ¯æ—¶ï¼ŒåŒæ­¥æ¶ˆæ¯å¤±è´¥ä¼šé‡æŠ•ï¼Œå¼‚æ­¥æ¶ˆæ¯æœ‰é‡è¯•ï¼Œoneway æ²¡æœ‰ä»»ä½•ä¿è¯ã€‚æ¶ˆæ¯é‡æŠ•ä¿è¯æ¶ˆæ¯å°½å¯èƒ½å‘é€æˆåŠŸã€ä¸ä¸¢å¤±ï¼Œä½†å¯èƒ½ä¼šé€ æˆæ¶ˆæ¯é‡å¤ï¼Œæ¶ˆæ¯é‡å¤åœ¨ RocketMQ ä¸­æ˜¯æ— æ³•é¿å…çš„é—®é¢˜ã€‚æ¶ˆæ¯é‡å¤åœ¨ä¸€èˆ¬æƒ…å†µä¸‹ä¸ä¼šå‘ç”Ÿï¼Œå½“å‡ºç°æ¶ˆæ¯é‡å¤§ã€ç½‘ç»œæŠ–åŠ¨ï¼Œæ¶ˆæ¯é‡å¤å°±ä¼šæ˜¯å¤§æ¦‚ç‡äº‹ä»¶ã€‚å¦å¤–ï¼Œç”Ÿäº§è€…ä¸»åŠ¨é‡å‘ã€consumer è´Ÿè½½å˜åŒ–ä¹Ÿä¼šå¯¼è‡´é‡å¤æ¶ˆæ¯ã€‚å¦‚ä¸‹æ–¹æ³•å¯ä»¥è®¾ç½®æ¶ˆæ¯é‡è¯•ç­–ç•¥ï¼š</p>
<ul>
<li>retryTimesWhenSendFailed:åŒæ­¥å‘é€å¤±è´¥é‡æŠ•æ¬¡æ•°ï¼Œé»˜è®¤ä¸º 2ï¼Œå› æ­¤ç”Ÿäº§è€…ä¼šæœ€å¤šå°è¯•å‘é€ retryTimesWhenSendFailed + 1 æ¬¡ã€‚ä¸ä¼šé€‰æ‹©ä¸Šæ¬¡å¤±è´¥çš„ brokerï¼Œå°è¯•å‘å…¶ä»– broker å‘é€ï¼Œæœ€å¤§ç¨‹åº¦ä¿è¯æ¶ˆæ¯ä¸ä¸¢ã€‚è¶…è¿‡é‡æŠ•æ¬¡æ•°ï¼ŒæŠ›å‡ºå¼‚å¸¸ï¼Œç”±å®¢æˆ·ç«¯ä¿è¯æ¶ˆæ¯ä¸ä¸¢ã€‚å½“å‡ºç° RemotingExceptionã€MQClientException å’Œéƒ¨åˆ† MQBrokerException æ—¶ä¼šé‡æŠ•ã€‚</li>
<li>retryTimesWhenSendAsyncFailed:å¼‚æ­¥å‘é€å¤±è´¥é‡è¯•æ¬¡æ•°ï¼Œå¼‚æ­¥é‡è¯•ä¸ä¼šé€‰æ‹©å…¶ä»– brokerï¼Œä»…åœ¨åŒä¸€ä¸ª broker ä¸Šåšé‡è¯•ï¼Œä¸ä¿è¯æ¶ˆæ¯ä¸ä¸¢ã€‚</li>
<li>retryAnotherBrokerWhenNotStoreOK:æ¶ˆæ¯åˆ·ç›˜ï¼ˆä¸»æˆ–å¤‡ï¼‰è¶…æ—¶æˆ– slave ä¸å¯ç”¨ï¼ˆè¿”å›çŠ¶æ€é SEND_OKï¼‰ï¼Œæ˜¯å¦å°è¯•å‘é€åˆ°å…¶ä»– brokerï¼Œé»˜è®¤ falseã€‚ååˆ†é‡è¦æ¶ˆæ¯å¯ä»¥å¼€å¯ã€‚</li>
</ul>
<h3 id="é‡æ§åˆ¶"><a href="#é‡æ§åˆ¶" class="headerlink" title="é‡æ§åˆ¶"></a>é‡æ§åˆ¶</h3><p>ç”Ÿäº§è€…æµæ§ï¼Œå› ä¸º broker å¤„ç†èƒ½åŠ›è¾¾åˆ°ç“¶é¢ˆï¼›æ¶ˆè´¹è€…æµæ§ï¼Œå› ä¸ºæ¶ˆè´¹èƒ½åŠ›è¾¾åˆ°ç“¶é¢ˆã€‚</p>
<p>ç”Ÿäº§è€…æµæ§ï¼š</p>
<ul>
<li>commitLog æ–‡ä»¶è¢«é”æ—¶é—´è¶…è¿‡ osPageCacheBusyTimeOutMills æ—¶ï¼Œå‚æ•°é»˜è®¤ä¸º 1000msï¼Œè¿”å›æµæ§ã€‚</li>
<li>å¦‚æœå¼€å¯ transientStorePoolEnable &#x3D;&#x3D; trueï¼Œä¸” broker ä¸ºå¼‚æ­¥åˆ·ç›˜çš„ä¸»æœºï¼Œä¸” transientStorePool ä¸­èµ„æºä¸è¶³ï¼Œæ‹’ç»å½“å‰ send è¯·æ±‚ï¼Œè¿”å›æµæ§ã€‚</li>
<li>broker æ¯éš” 10ms æ£€æŸ¥ send è¯·æ±‚é˜Ÿåˆ—å¤´éƒ¨è¯·æ±‚çš„ç­‰å¾…æ—¶é—´ï¼Œå¦‚æœè¶…è¿‡ waitTimeMillsInSendQueueï¼Œé»˜è®¤ 200msï¼Œæ‹’ç»å½“å‰ send è¯·æ±‚ï¼Œè¿”å›æµæ§ã€‚</li>
<li>broker é€šè¿‡æ‹’ç» send è¯·æ±‚æ–¹å¼å®ç°æµé‡æ§åˆ¶ã€‚</li>
</ul>
<p>æ³¨æ„ï¼Œç”Ÿäº§è€…æµæ§ï¼Œä¸ä¼šå°è¯•æ¶ˆæ¯é‡æŠ•ã€‚</p>
<p>æ¶ˆè´¹è€…æµæ§ï¼š</p>
<ul>
<li>æ¶ˆè´¹è€…æœ¬åœ°ç¼“å­˜æ¶ˆæ¯æ•°è¶…è¿‡ pullThresholdForQueue æ—¶ï¼Œé»˜è®¤ 1000ã€‚</li>
<li>æ¶ˆè´¹è€…æœ¬åœ°ç¼“å­˜æ¶ˆæ¯å¤§å°è¶…è¿‡ pullThresholdSizeForQueue æ—¶ï¼Œé»˜è®¤ 100MBã€‚</li>
<li>æ¶ˆè´¹è€…æœ¬åœ°ç¼“å­˜æ¶ˆæ¯è·¨åº¦è¶…è¿‡ consumeConcurrentlyMaxSpan æ—¶ï¼Œé»˜è®¤ 2000ã€‚</li>
</ul>
<p>æ¶ˆè´¹è€…æµæ§çš„ç»“æœæ˜¯é™ä½æ‹‰å–é¢‘ç‡ã€‚</p>
<h3 id="æ­»ä¿¡é˜Ÿåˆ—"><a href="#æ­»ä¿¡é˜Ÿåˆ—" class="headerlink" title="æ­»ä¿¡é˜Ÿåˆ—"></a>æ­»ä¿¡é˜Ÿåˆ—</h3><p>æ­»ä¿¡é˜Ÿåˆ—ç”¨äºå¤„ç†æ— æ³•è¢«æ­£å¸¸æ¶ˆè´¹çš„æ¶ˆæ¯ã€‚å½“ä¸€æ¡æ¶ˆæ¯åˆæ¬¡æ¶ˆè´¹å¤±è´¥ï¼Œæ¶ˆæ¯é˜Ÿåˆ—ä¼šè‡ªåŠ¨è¿›è¡Œæ¶ˆæ¯é‡è¯•ï¼›è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°åï¼Œè‹¥æ¶ˆè´¹ä¾ç„¶å¤±è´¥ï¼Œåˆ™è¡¨æ˜æ¶ˆè´¹è€…åœ¨æ­£å¸¸æƒ…å†µä¸‹æ— æ³•æ­£ç¡®åœ°æ¶ˆè´¹è¯¥æ¶ˆæ¯ï¼Œæ­¤æ—¶ï¼Œæ¶ˆæ¯é˜Ÿåˆ— ä¸ä¼šç«‹åˆ»å°†æ¶ˆæ¯ä¸¢å¼ƒï¼Œè€Œæ˜¯å°†å…¶å‘é€åˆ°è¯¥æ¶ˆè´¹è€…å¯¹åº”çš„ç‰¹æ®Šé˜Ÿåˆ—ä¸­ã€‚</p>
<p>RocketMQ å°†è¿™ç§æ­£å¸¸æƒ…å†µä¸‹æ— æ³•è¢«æ¶ˆè´¹çš„æ¶ˆæ¯ç§°ä¸ºæ­»ä¿¡æ¶ˆæ¯ï¼ˆDead-Letter Messageï¼‰ï¼Œå°†å­˜å‚¨æ­»ä¿¡æ¶ˆæ¯çš„ç‰¹æ®Šé˜Ÿåˆ—ç§°ä¸ºæ­»ä¿¡é˜Ÿåˆ—ï¼ˆDead-Letter Queueï¼‰ã€‚åœ¨ RocketMQ ä¸­ï¼Œå¯ä»¥é€šè¿‡ä½¿ç”¨ console æ§åˆ¶å°å¯¹æ­»ä¿¡é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯è¿›è¡Œé‡å‘æ¥ä½¿å¾—æ¶ˆè´¹è€…å®ä¾‹å†æ¬¡è¿›è¡Œæ¶ˆè´¹ã€‚</p>
<h2 id="RocketMQ-ç»„ä»¶"><a href="#RocketMQ-ç»„ä»¶" class="headerlink" title="RocketMQ ç»„ä»¶"></a>RocketMQ ç»„ä»¶</h2><p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/20220712060550.png" alt="img"></p>
<p>RocketMQ ç”±å››éƒ¨åˆ†ç»„æˆï¼šNameServerã€Brokerã€Producerã€Consumerã€‚å…¶ä¸­ä»»æ„ä¸€ä¸ªç»„æˆéƒ½å¯ä»¥æ°´å¹³æ‰©å±•ä¸ºé›†ç¾¤æ¨¡å¼ï¼Œä»¥é¿å…å•ç‚¹æ•…éšœé—®é¢˜ã€‚</p>
<h3 id="NameServerï¼ˆå‘½åæœåŠ¡å™¨ï¼‰"><a href="#NameServerï¼ˆå‘½åæœåŠ¡å™¨ï¼‰" class="headerlink" title="NameServerï¼ˆå‘½åæœåŠ¡å™¨ï¼‰"></a>NameServerï¼ˆå‘½åæœåŠ¡å™¨ï¼‰</h3><p>NameServer æ˜¯ä¸€ä¸ª Topic è·¯ç”±æ³¨å†Œä¸­å¿ƒï¼Œå…¶è§’è‰²ç±»ä¼¼ Kafka ä¸­çš„ zookeeperï¼Œæ”¯æŒ Broker çš„åŠ¨æ€æ³¨å†Œä¸å‘ç°ã€‚æ¯ä¸ª NameServer è®°å½•å®Œæ•´çš„è·¯ç”±ä¿¡æ¯ï¼Œæä¾›ç›¸åº”çš„è¯»å†™æœåŠ¡ï¼Œæ”¯æŒå¿«é€Ÿå­˜å‚¨æ‰©å±•ã€‚</p>
<p>NameServer ä¸»è¦åŒ…æ‹¬ä¸¤ä¸ªåŠŸèƒ½ï¼š</p>
<ul>
<li><strong>Broker ç®¡ç†</strong>ï¼ŒNameServer æ¥å— Broker é›†ç¾¤çš„æ³¨å†Œä¿¡æ¯å¹¶ä¸”ä¿å­˜ä¸‹æ¥ä½œä¸ºè·¯ç”±ä¿¡æ¯çš„åŸºæœ¬æ•°æ®ã€‚ç„¶åæä¾›å¿ƒè·³æ£€æµ‹æœºåˆ¶ï¼Œæ£€æŸ¥ Broker æ˜¯å¦è¿˜å­˜æ´»ï¼›</li>
<li><strong>è·¯ç”±ä¿¡æ¯ç®¡ç†</strong>ï¼Œæ¯ä¸ª NameServer å°†ä¿å­˜å…³äº Broker é›†ç¾¤çš„æ•´ä¸ªè·¯ç”±ä¿¡æ¯å’Œç”¨äºå®¢æˆ·ç«¯æŸ¥è¯¢çš„é˜Ÿåˆ—ä¿¡æ¯ã€‚ç„¶å Producer å’Œ Conumser é€šè¿‡ NameServer å°±å¯ä»¥çŸ¥é“æ•´ä¸ª Broker é›†ç¾¤çš„è·¯ç”±ä¿¡æ¯ï¼Œä»è€Œè¿›è¡Œæ¶ˆæ¯çš„æŠ•é€’å’Œæ¶ˆè´¹ã€‚</li>
</ul>
<p>NameServer é€šå¸¸ä¹Ÿæ˜¯é›†ç¾¤çš„æ–¹å¼éƒ¨ç½²ï¼Œå„å®ä¾‹é—´ç›¸äº’ä¸è¿›è¡Œä¿¡æ¯é€šè®¯ã€‚Broker æ˜¯å‘æ¯ä¸€å° NameServer æ³¨å†Œè‡ªå·±çš„è·¯ç”±ä¿¡æ¯ï¼Œæ‰€ä»¥æ¯ä¸€ä¸ª NameServer å®ä¾‹ä¸Šé¢éƒ½ä¿å­˜ä¸€ä»½å®Œæ•´çš„è·¯ç”±ä¿¡æ¯ã€‚å½“æŸä¸ª NameServer å› æŸç§åŸå› ä¸‹çº¿äº†ï¼ŒBroker ä»ç„¶å¯ä»¥å‘å…¶å®ƒ NameServer åŒæ­¥å…¶è·¯ç”±ä¿¡æ¯ï¼ŒProducerã€Consumer ä»ç„¶å¯ä»¥åŠ¨æ€æ„ŸçŸ¥ Broker çš„è·¯ç”±çš„ä¿¡æ¯ã€‚</p>
<p>NameServer æ˜¯ä¸€ä¸ªåŠŸèƒ½é½å…¨çš„æœåŠ¡å™¨ï¼Œä¸»è¦åŒ…æ‹¬ä¸¤ä¸ªåŠŸèƒ½ï¼š</p>
<ol>
<li>Broker ç®¡ç† - NameServer æ¥å—æ¥è‡ª Broker é›†ç¾¤çš„æ³¨å†Œï¼Œå¹¶æä¾›å¿ƒè·³æœºåˆ¶æ¥æ£€æŸ¥ Broker èŠ‚ç‚¹æ˜¯å¦å­˜æ´»ã€‚</li>
<li>è·¯ç”±ç®¡ç† - æ¯ä¸ª NameServer å°†ä¿å­˜æœ‰å…³ Broker é›†ç¾¤çš„å®Œæ•´è·¯ç”±ä¿¡æ¯å’Œå®¢æˆ·ç«¯æŸ¥è¯¢çš„æŸ¥è¯¢é˜Ÿåˆ—ã€‚</li>
</ol>
<p>RocketMQ å®¢æˆ·ç«¯ï¼ˆProducer&#x2F;Consumerï¼‰å°†ä» NameServer æŸ¥è¯¢é˜Ÿåˆ—è·¯ç”±ä¿¡æ¯ã€‚</p>
<p>å°† NameServer åœ°å€åˆ—è¡¨æä¾›ç»™å®¢æˆ·ç«¯æœ‰å››ç§æ–¹æ³•ï¼š</p>
<ol>
<li>ç¼–ç¨‹æ–¹å¼ - ç±»ä¼¼ï¼š<code>producer.setNamesrvAddr(&quot;ip:port&quot;)</code></li>
<li>Java é€‰é¡¹ - ä½¿ç”¨ <code>rocketmq.namesrv.addr</code> å‚æ•°</li>
<li>ç¯å¢ƒå˜é‡ - è®¾ç½®ç¯å¢ƒå˜é‡ <code>NAMESRV_ADDR</code></li>
<li>HTTP ç«¯ç‚¹</li>
</ol>
<blockquote>
<p>æ›´è¯¦ç»†ä¿¡æ¯å¯ä»¥å‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼š<a target="_blank" rel="noopener" href="http://rocketmq.apache.org/rocketmq/four-methods-to-feed-name-server-address-list/">here</a></p>
</blockquote>
<h3 id="Brokerï¼ˆä»£ç†ï¼‰"><a href="#Brokerï¼ˆä»£ç†ï¼‰" class="headerlink" title="Brokerï¼ˆä»£ç†ï¼‰"></a>Brokerï¼ˆä»£ç†ï¼‰</h3><p>Broker ä¸»è¦è´Ÿè´£æ¶ˆæ¯çš„å­˜å‚¨ã€æŠ•é€’å’ŒæŸ¥è¯¢ä»¥åŠæœåŠ¡é«˜å¯ç”¨ä¿è¯ã€‚</p>
<p>Broker åŒæ—¶æ”¯æŒæ¨æ‹‰æ¨¡å‹ï¼ŒåŒ…å«å®¹é”™æœºåˆ¶ï¼ˆ2 å‰¯æœ¬æˆ– 3 å‰¯æœ¬ï¼‰ï¼Œå¹¶æä¾›å¼ºå¤§çš„å³°å€¼å¡«å……å’ŒæŒ‰åŸå§‹æ—¶é—´é¡ºåºç´¯ç§¯æ•°åƒäº¿æ¶ˆæ¯çš„èƒ½åŠ›ã€‚æ­¤å¤–ï¼ŒBroker æä¾›äº†ç¾éš¾æ¢å¤ã€ä¸°å¯Œçš„æŒ‡æ ‡ç»Ÿè®¡å’Œè­¦æŠ¥æœºåˆ¶ï¼Œè¿™äº›éƒ½æ˜¯ä¼ ç»Ÿ MQ æ‰€ç¼ºä¹çš„ã€‚</p>
<p>ä¸ºäº†å®ç°è¿™äº›åŠŸèƒ½ï¼ŒBroker åŒ…å«äº†ä»¥ä¸‹å‡ ä¸ªé‡è¦å­æ¨¡å—ï¼š</p>
<ul>
<li><strong>Remoting Module</strong>ï¼šæ•´ä¸ª Broker çš„å®ä½“ï¼Œè´Ÿè´£å¤„ç†æ¥è‡ª clients ç«¯çš„è¯·æ±‚ã€‚</li>
<li><strong>Client Manager</strong>ï¼šè´Ÿè´£ç®¡ç†å®¢æˆ·ç«¯(Producer&#x2F;Consumer)å’Œç»´æŠ¤ Consumer çš„ Topic è®¢é˜…ä¿¡æ¯ã€‚</li>
<li><strong>Store Service</strong>ï¼šæä¾›æ–¹ä¾¿ç®€å•çš„ API æ¥å£å¤„ç†æ¶ˆæ¯å­˜å‚¨åˆ°ç‰©ç†ç¡¬ç›˜å’ŒæŸ¥è¯¢åŠŸèƒ½ã€‚</li>
<li><strong>HA Service</strong>ï¼šé«˜å¯ç”¨æœåŠ¡ï¼Œæä¾› Master Broker å’Œ Slave Broker ä¹‹é—´çš„æ•°æ®åŒæ­¥åŠŸèƒ½ã€‚</li>
<li><strong>Index Service</strong>ï¼šæ ¹æ®ç‰¹å®šçš„ Message key å¯¹æŠ•é€’åˆ° Broker çš„æ¶ˆæ¯è¿›è¡Œç´¢å¼•æœåŠ¡ï¼Œä»¥æä¾›æ¶ˆæ¯çš„å¿«é€ŸæŸ¥è¯¢ã€‚</li>
</ul>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/cs/java/javaweb/distributed/mq/rocketmq/rmq-basic-component.png" alt="img"></p>
<h3 id="Producerï¼ˆç”Ÿäº§è€…ï¼‰"><a href="#Producerï¼ˆç”Ÿäº§è€…ï¼‰" class="headerlink" title="Producerï¼ˆç”Ÿäº§è€…ï¼‰"></a>Producerï¼ˆç”Ÿäº§è€…ï¼‰</h3><p>Producers æ”¯æŒåˆ†å¸ƒå¼é›†ç¾¤æ–¹å¼éƒ¨ç½²ã€‚Producer é€šè¿‡ MQ çš„è´Ÿè½½å‡è¡¡æ¨¡å—é€‰æ‹©ç›¸åº”çš„ Broker é›†ç¾¤é˜Ÿåˆ—è¿›è¡Œæ¶ˆæ¯æŠ•é€’ï¼ŒæŠ•é€’çš„è¿‡ç¨‹æ”¯æŒå¿«é€Ÿå¤±è´¥å¹¶ä¸”ä½å»¶è¿Ÿã€‚</p>
<h3 id="Consumerï¼ˆæ¶ˆè´¹è€…ï¼‰"><a href="#Consumerï¼ˆæ¶ˆè´¹è€…ï¼‰" class="headerlink" title="Consumerï¼ˆæ¶ˆè´¹è€…ï¼‰"></a>Consumerï¼ˆæ¶ˆè´¹è€…ï¼‰</h3><p>Consumer æ”¯æŒåˆ†å¸ƒå¼é›†ç¾¤æ–¹å¼éƒ¨ç½²ã€‚æ”¯æŒä»¥ push æ¨ï¼Œpull æ‹‰ä¸¤ç§æ¨¡å¼å¯¹æ¶ˆæ¯è¿›è¡Œæ¶ˆè´¹ã€‚åŒæ—¶ä¹Ÿæ”¯æŒé›†ç¾¤æ–¹å¼å’Œå¹¿æ’­æ–¹å¼çš„æ¶ˆè´¹ï¼Œå®ƒæä¾›å®æ—¶æ¶ˆæ¯è®¢é˜…æœºåˆ¶ï¼Œå¯ä»¥æ»¡è¶³å¤§å¤šæ•°ç”¨æˆ·çš„éœ€æ±‚ã€‚</p>
<h2 id="RocketMQ-å®‰è£…"><a href="#RocketMQ-å®‰è£…" class="headerlink" title="RocketMQ å®‰è£…"></a>RocketMQ å®‰è£…</h2><h3 id="ç¯å¢ƒè¦æ±‚"><a href="#ç¯å¢ƒè¦æ±‚" class="headerlink" title="ç¯å¢ƒè¦æ±‚"></a>ç¯å¢ƒè¦æ±‚</h3><ul>
<li>æ¨è 64 ä½æ“ä½œç³»ç»Ÿï¼šLinux&#x2F;Unix&#x2F;Mac</li>
<li>64bit JDK 1.8+</li>
<li>Maven 3.2.x</li>
<li>Git</li>
</ul>
<h3 id="ä¸‹è½½è§£å‹"><a href="#ä¸‹è½½è§£å‹" class="headerlink" title="ä¸‹è½½è§£å‹"></a>ä¸‹è½½è§£å‹</h3><p>è¿›å…¥å®˜æ–¹ä¸‹è½½åœ°å€ï¼š<a target="_blank" rel="noopener" href="https://rocketmq.apache.org/dowloading/releases/%EF%BC%8C%E9%80%89%E6%8B%A9%E5%90%88%E9%80%82%E7%89%88%E6%9C%AC">https://rocketmq.apache.org/dowloading/releases/ï¼Œé€‰æ‹©åˆé€‚ç‰ˆæœ¬</a></p>
<p>å»ºè®®é€‰æ‹© binary ç‰ˆæœ¬ã€‚</p>
<p>è§£å‹åˆ°æœ¬åœ°ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; unzip rocketmq-all-4.2.0-source-release.zip</span><br><span class="line">&gt; <span class="built_in">cd</span> rocketmq-all-4.2.0/</span><br></pre></td></tr></table></figure>

<h3 id="å¯åŠ¨-Name-Server"><a href="#å¯åŠ¨-Name-Server" class="headerlink" title="å¯åŠ¨ Name Server"></a>å¯åŠ¨ Name Server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="built_in">nohup</span> sh bin/mqnamesrv &amp;</span><br><span class="line">&gt; <span class="built_in">tail</span> -f ~/logs/rocketmqlogs/namesrv.log</span><br><span class="line">The Name Server boot success...</span><br></pre></td></tr></table></figure>

<h3 id="å¯åŠ¨-Broker"><a href="#å¯åŠ¨-Broker" class="headerlink" title="å¯åŠ¨ Broker"></a>å¯åŠ¨ Broker</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="built_in">nohup</span> sh bin/mqbroker -n localhost:9876 -c conf/broker.conf &amp;</span><br><span class="line">&gt; <span class="built_in">tail</span> -f ~/logs/rocketmqlogs/broker.log</span><br><span class="line">The broker[%s, 172.30.30.233:10911] boot success...</span><br></pre></td></tr></table></figure>

<h3 id="æ”¶å‘æ¶ˆæ¯"><a href="#æ”¶å‘æ¶ˆæ¯" class="headerlink" title="æ”¶å‘æ¶ˆæ¯"></a>æ”¶å‘æ¶ˆæ¯</h3><p>æ‰§è¡Œæ”¶å‘æ¶ˆæ¯æ“ä½œä¹‹å‰ï¼Œä¸è®¸å‘Šè¯‰å®¢æˆ·ç«¯å‘½åæœåŠ¡å™¨çš„ä½ç½®ã€‚åœ¨ RocketMQ ä¸­æœ‰å¤šç§æ–¹æ³•æ¥å®ç°è¿™ä¸ªç›®çš„ã€‚è¿™é‡Œï¼Œæˆ‘ä»¬ä½¿ç”¨æœ€ç®€å•çš„æ–¹æ³•â€”â€”è®¾ç½®ç¯å¢ƒå˜é‡ <code>NAMESRV_ADDR</code> ï¼š</p>
<blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="built_in">export</span> NAMESRV_ADDR=localhost:9876</span><br><span class="line">&gt; sh bin/tools.sh org.apache.rocketmq.example.quickstart.Producer</span><br><span class="line">SendResult [sendStatus=SEND_OK, msgId= ...</span><br><span class="line"></span><br><span class="line">&gt; sh bin/tools.sh org.apache.rocketmq.example.quickstart.Consumer</span><br><span class="line">ConsumeMessageThread_%d Receive New Messages: [MessageExt...</span><br></pre></td></tr></table></figure>
</blockquote>
<h3 id="å…³é—­æœåŠ¡å™¨"><a href="#å…³é—­æœåŠ¡å™¨" class="headerlink" title="å…³é—­æœåŠ¡å™¨"></a>å…³é—­æœåŠ¡å™¨</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&gt; sh bin/mqshutdown broker</span><br><span class="line">The mqbroker(36695) is running...</span><br><span class="line">Send shutdown request to mqbroker(36695) OK</span><br><span class="line"></span><br><span class="line">&gt; sh bin/mqshutdown namesrv</span><br><span class="line">The mqnamesrv(36664) is running...</span><br><span class="line">Send shutdown request to mqnamesrv(36664) OK</span><br></pre></td></tr></table></figure>

<h2 id="RocketMQ-å…¥é—¨çº§ç¤ºä¾‹"><a href="#RocketMQ-å…¥é—¨çº§ç¤ºä¾‹" class="headerlink" title="RocketMQ å…¥é—¨çº§ç¤ºä¾‹"></a>RocketMQ å…¥é—¨çº§ç¤ºä¾‹</h2><p>é¦–å…ˆåœ¨é¡¹ç›®ä¸­å¼•å…¥ maven ä¾èµ–ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.rocketmq<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>rocketmq-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.2.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="Producer"><a href="#Producer" class="headerlink" title="Producer"></a>Producer</h3><p>Producer åœ¨ RocketMQ ä¸­è´Ÿè´£å‘é€æ¶ˆæ¯ã€‚</p>
<p>RocketMQ æœ‰ä¸‰ç§æ¶ˆæ¯å‘é€æ–¹å¼ï¼š</p>
<ul>
<li>å¯é çš„åŒæ­¥å‘é€</li>
<li>å¯é çš„å¼‚æ­¥å‘é€</li>
<li>å•é¡¹å‘é€</li>
</ul>
<h4 id="å¯é çš„åŒæ­¥å‘é€"><a href="#å¯é çš„åŒæ­¥å‘é€" class="headerlink" title="å¯é çš„åŒæ­¥å‘é€"></a>å¯é çš„åŒæ­¥å‘é€</h4><p>å¯é çš„åŒæ­¥ä¼ è¾“ç”¨äºå¹¿æ³›çš„åœºæ™¯ï¼Œå¦‚é‡è¦çš„é€šçŸ¥æ¶ˆæ¯ï¼ŒçŸ­ä¿¡é€šçŸ¥ï¼ŒçŸ­ä¿¡è¥é”€ç³»ç»Ÿç­‰ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SyncProducer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//Instantiate with a producer group name.</span></span><br><span class="line">        <span class="type">DefaultMQProducer</span> <span class="variable">producer</span> <span class="operator">=</span> <span class="keyword">new</span></span><br><span class="line">            <span class="title class_">DefaultMQProducer</span>(<span class="string">&quot;please_rename_unique_group_name&quot;</span>);</span><br><span class="line">        <span class="comment">//Launch the instance.</span></span><br><span class="line">        producer.start();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">            <span class="comment">//Create a message instance, specifying topic, tag and message body.</span></span><br><span class="line">            <span class="type">Message</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Message</span>(<span class="string">&quot;TopicTest&quot;</span> <span class="comment">/* Topic */</span>,</span><br><span class="line">                <span class="string">&quot;TagA&quot;</span> <span class="comment">/* Tag */</span>,</span><br><span class="line">                (<span class="string">&quot;Hello RocketMQ &quot;</span> +</span><br><span class="line">                    i).getBytes(RemotingHelper.DEFAULT_CHARSET) <span class="comment">/* Message body */</span></span><br><span class="line">            );</span><br><span class="line">            <span class="comment">//Call send message to deliver message to one of brokers.</span></span><br><span class="line">            <span class="type">SendResult</span> <span class="variable">sendResult</span> <span class="operator">=</span> producer.send(msg);</span><br><span class="line">            System.out.printf(<span class="string">&quot;%s%n&quot;</span>, sendResult);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//Shut down once the producer instance is not longer in use.</span></span><br><span class="line">        producer.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="å¯é çš„å¼‚æ­¥å‘é€"><a href="#å¯é çš„å¼‚æ­¥å‘é€" class="headerlink" title="å¯é çš„å¼‚æ­¥å‘é€"></a>å¯é çš„å¼‚æ­¥å‘é€</h4><p>å¼‚æ­¥ä¼ è¾“é€šå¸¸ç”¨äºå“åº”æ—¶é—´æ•æ„Ÿçš„ä¸šåŠ¡åœºæ™¯ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AsyncProducer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//Instantiate with a producer group name.</span></span><br><span class="line">        <span class="type">DefaultMQProducer</span> <span class="variable">producer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultMQProducer</span>(<span class="string">&quot;ExampleProducerGroup&quot;</span>);</span><br><span class="line">        <span class="comment">//Launch the instance.</span></span><br><span class="line">        producer.start();</span><br><span class="line">        producer.setRetryTimesWhenSendAsyncFailed(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> i;</span><br><span class="line">                <span class="comment">//Create a message instance, specifying topic, tag and message body.</span></span><br><span class="line">                <span class="type">Message</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Message</span>(<span class="string">&quot;TopicTest&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;TagA&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;OrderID188&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;Hello world&quot;</span>.getBytes(RemotingHelper.DEFAULT_CHARSET));</span><br><span class="line">                producer.send(msg, <span class="keyword">new</span> <span class="title class_">SendCallback</span>() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onSuccess</span><span class="params">(SendResult sendResult)</span> &#123;</span><br><span class="line">                        System.out.printf(<span class="string">&quot;%-10d OK %s %n&quot;</span>, index,</span><br><span class="line">                            sendResult.getMsgId());</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onException</span><span class="params">(Throwable e)</span> &#123;</span><br><span class="line">                        System.out.printf(<span class="string">&quot;%-10d Exception %s %n&quot;</span>, index, e);</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//Shut down once the producer instance is not longer in use.</span></span><br><span class="line">        producer.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="å•å‘ä¼ è¾“"><a href="#å•å‘ä¼ è¾“" class="headerlink" title="å•å‘ä¼ è¾“"></a>å•å‘ä¼ è¾“</h4><p>å•å‘ä¼ è¾“ç”¨äºéœ€è¦ä¸­ç­‰å¯é æ€§çš„æƒ…å†µï¼Œä¾‹å¦‚æ—¥å¿—æ”¶é›†ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OnewayProducer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="comment">//Instantiate with a producer group name.</span></span><br><span class="line">        <span class="type">DefaultMQProducer</span> <span class="variable">producer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultMQProducer</span>(<span class="string">&quot;ExampleProducerGroup&quot;</span>);</span><br><span class="line">        <span class="comment">//Launch the instance.</span></span><br><span class="line">        producer.start();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">            <span class="comment">//Create a message instance, specifying topic, tag and message body.</span></span><br><span class="line">            <span class="type">Message</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Message</span>(<span class="string">&quot;TopicTest&quot;</span> <span class="comment">/* Topic */</span>,</span><br><span class="line">                <span class="string">&quot;TagA&quot;</span> <span class="comment">/* Tag */</span>,</span><br><span class="line">                (<span class="string">&quot;Hello RocketMQ &quot;</span> +</span><br><span class="line">                    i).getBytes(RemotingHelper.DEFAULT_CHARSET) <span class="comment">/* Message body */</span></span><br><span class="line">            );</span><br><span class="line">            <span class="comment">//Call send message to deliver message to one of brokers.</span></span><br><span class="line">            producer.sendOneway(msg);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//Shut down once the producer instance is not longer in use.</span></span><br><span class="line">        producer.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Consumer"><a href="#Consumer" class="headerlink" title="Consumer"></a>Consumer</h3><p>Consumer åœ¨ RocketMQ ä¸­è´Ÿè´£æ¥æ”¶æ¶ˆæ¯ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderedConsumer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">DefaultMQPushConsumer</span> <span class="variable">consumer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultMQPushConsumer</span>(<span class="string">&quot;example_group_name&quot;</span>);</span><br><span class="line">        consumer.setNamesrvAddr(RocketConfig.HOST);</span><br><span class="line"></span><br><span class="line">        consumer.setConsumeFromWhere(ConsumeFromWhere.CONSUME_FROM_FIRST_OFFSET);</span><br><span class="line"></span><br><span class="line">        consumer.subscribe(<span class="string">&quot;TopicTest&quot;</span>, <span class="string">&quot;TagA || TagC || TagD&quot;</span>);</span><br><span class="line"></span><br><span class="line">        consumer.registerMessageListener(<span class="keyword">new</span> <span class="title class_">MessageListenerOrderly</span>() &#123;</span><br><span class="line"></span><br><span class="line">            <span class="type">AtomicLong</span> <span class="variable">consumeTimes</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicLong</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> ConsumeOrderlyStatus <span class="title function_">consumeMessage</span><span class="params">(List&lt;MessageExt&gt; msgs,</span></span><br><span class="line"><span class="params">                ConsumeOrderlyContext context)</span> &#123;</span><br><span class="line">                context.setAutoCommit(<span class="literal">false</span>);</span><br><span class="line">                System.out.printf(Thread.currentThread().getName() + <span class="string">&quot; Receive New Messages: &quot;</span> + msgs + <span class="string">&quot;%n&quot;</span>);</span><br><span class="line">                <span class="built_in">this</span>.consumeTimes.incrementAndGet();</span><br><span class="line">                <span class="keyword">if</span> ((<span class="built_in">this</span>.consumeTimes.get() % <span class="number">2</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> ConsumeOrderlyStatus.SUCCESS;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((<span class="built_in">this</span>.consumeTimes.get() % <span class="number">3</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> ConsumeOrderlyStatus.ROLLBACK;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((<span class="built_in">this</span>.consumeTimes.get() % <span class="number">4</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> ConsumeOrderlyStatus.COMMIT;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((<span class="built_in">this</span>.consumeTimes.get() % <span class="number">5</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">                    context.setSuspendCurrentQueueTimeMillis(<span class="number">3000</span>);</span><br><span class="line">                    <span class="keyword">return</span> ConsumeOrderlyStatus.SUSPEND_CURRENT_QUEUE_A_MOMENT;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> ConsumeOrderlyStatus.SUCCESS;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        consumer.start();</span><br><span class="line"></span><br><span class="line">        System.out.printf(<span class="string">&quot;Consumer Started.%n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="RocketMQ-å®˜æ–¹ç¤ºä¾‹"><a href="#RocketMQ-å®˜æ–¹ç¤ºä¾‹" class="headerlink" title="RocketMQ å®˜æ–¹ç¤ºä¾‹"></a>RocketMQ å®˜æ–¹ç¤ºä¾‹</h2><ul>
<li><a target="_blank" rel="noopener" href="https://rocketmq.apache.org/docs/simple-example/">Simple Example</a><ul>
<li>ä½¿ç”¨ RocketMQ é€šè¿‡ä¸‰ç§æ–¹å¼å‘é€æ¶ˆæ¯ï¼šå¯é åŒæ­¥ã€å¯é å¼‚æ­¥ã€å•å‘ä¼ è¾“ã€‚</li>
<li>ä½¿ç”¨ RocketMQ æ¶ˆè´¹æ¶ˆæ¯ã€‚</li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://rocketmq.apache.org/docs/order-example/">Order Example</a>ï¼šRocketMQ ä½¿ç”¨ FIFO é¡ºåºæä¾›æœ‰åºæ¶ˆæ¯ã€‚</li>
<li><a target="_blank" rel="noopener" href="https://rocketmq.apache.org/docs/broadcast-example/">Broadcasting Example</a></li>
<li><a target="_blank" rel="noopener" href="https://rocketmq.apache.org/docs/schedule-example/">Schedule Example</a></li>
<li><a target="_blank" rel="noopener" href="https://rocketmq.apache.org/docs/batch-example/">Batch Example</a></li>
<li><a target="_blank" rel="noopener" href="https://rocketmq.apache.org/docs/filter-by-sql92-example/">Filter Example</a></li>
<li><a target="_blank" rel="noopener" href="https://rocketmq.apache.org/docs/logappender-example/">Logappender Example</a></li>
<li><a target="_blank" rel="noopener" href="https://rocketmq.apache.org/docs/openmessaging-example/">OpenMessaging Example</a></li>
<li><a target="_blank" rel="noopener" href="https://rocketmq.apache.org/docs/transaction-example/">Transaction Example</a></li>
</ul>
<h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ul>
<li><a target="_blank" rel="noopener" href="http://rocketmq.apache.org/docs/quick-start/">RocketMQ å®˜æ–¹æ–‡æ¡£</a></li>
<li><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/453c6e7ff81c">åˆ†å¸ƒå¼å¼€æ”¾æ¶ˆæ¯ç³»ç»Ÿ(RocketMQ)çš„åŸç†ä¸å®è·µ</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://dunwu.github.io/blog/pages/22e12f65/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/uploads/avatar.gif">
      <meta itemprop="name" content="é’æ‚Ÿ â—¾ Dunwu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dunwu Blog">
      <meta itemprop="description" content="é’æ‚Ÿçš„ä¸ªäººåšå®¢">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Dunwu Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/pages/22e12f65/" class="post-title-link" itemprop="url">ActiveMQ å¿«é€Ÿå…¥é—¨</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2022-02-17 22:34:30" itemprop="dateCreated datePublished" datetime="2022-02-17T22:34:30+08:00">2022-02-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">æ›´æ–°äº</span>
      <time title="ä¿®æ”¹æ—¶é—´ï¼š2025-09-13 17:56:53" itemprop="dateModified" datetime="2025-09-13T17:56:53+08:00">2025-09-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/%E5%88%86%E5%B8%83%E5%BC%8F/" itemprop="url" rel="index"><span itemprop="name">åˆ†å¸ƒå¼</span></a>
        </span>
          ï¼Œ
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/%E5%88%86%E5%B8%83%E5%BC%8F/%E5%88%86%E5%B8%83%E5%BC%8F%E9%80%9A%E4%BF%A1/" itemprop="url" rel="index"><span itemprop="name">åˆ†å¸ƒå¼é€šä¿¡</span></a>
        </span>
          ï¼Œ
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/%E5%88%86%E5%B8%83%E5%BC%8F/%E5%88%86%E5%B8%83%E5%BC%8F%E9%80%9A%E4%BF%A1/MQ/" itemprop="url" rel="index"><span itemprop="name">MQ</span></a>
        </span>
          ï¼Œ
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/%E5%88%86%E5%B8%83%E5%BC%8F/%E5%88%86%E5%B8%83%E5%BC%8F%E9%80%9A%E4%BF%A1/MQ/%E5%85%B6%E4%BB%96MQ/" itemprop="url" rel="index"><span itemprop="name">å…¶ä»–MQ</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
      <span>6.1k</span>
    </span>
    <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
      <span>6 åˆ†é’Ÿ</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="ActiveMQ-å¿«é€Ÿå…¥é—¨"><a href="#ActiveMQ-å¿«é€Ÿå…¥é—¨" class="headerlink" title="ActiveMQ å¿«é€Ÿå…¥é—¨"></a>ActiveMQ å¿«é€Ÿå…¥é—¨</h1><h2 id="JMS-åŸºæœ¬æ¦‚å¿µ"><a href="#JMS-åŸºæœ¬æ¦‚å¿µ" class="headerlink" title="JMS åŸºæœ¬æ¦‚å¿µ"></a>JMS åŸºæœ¬æ¦‚å¿µ</h2><p><code>JMS</code> å³ <strong>Java æ¶ˆæ¯æœåŠ¡ï¼ˆJava Message Serviceï¼‰API</strong>ï¼Œæ˜¯ä¸€ä¸ª Java å¹³å°ä¸­å…³äºé¢å‘æ¶ˆæ¯ä¸­é—´ä»¶çš„ APIã€‚å®ƒç”¨äºåœ¨ä¸¤ä¸ªåº”ç”¨ç¨‹åºä¹‹é—´ï¼Œæˆ–åˆ†å¸ƒå¼ç³»ç»Ÿä¸­å‘é€æ¶ˆæ¯ï¼Œè¿›è¡Œå¼‚æ­¥é€šä¿¡ã€‚Java æ¶ˆæ¯æœåŠ¡æ˜¯ä¸€ä¸ªä¸å…·ä½“å¹³å°æ— å…³çš„ APIï¼Œç»å¤§å¤šæ•° MOM æä¾›å•†éƒ½å¯¹ JMS æä¾›æ”¯æŒã€‚</p>
<h3 id="æ¶ˆæ¯æ¨¡å‹"><a href="#æ¶ˆæ¯æ¨¡å‹" class="headerlink" title="æ¶ˆæ¯æ¨¡å‹"></a>æ¶ˆæ¯æ¨¡å‹</h3><p>JMS æœ‰ä¸¤ç§æ¶ˆæ¯æ¨¡å‹ï¼š</p>
<ul>
<li>Point-to-Point(P2P)</li>
<li>Publish&#x2F;Subscribe(Pub&#x2F;Sub)</li>
</ul>
<h4 id="P2P-çš„ç‰¹ç‚¹"><a href="#P2P-çš„ç‰¹ç‚¹" class="headerlink" title="P2P çš„ç‰¹ç‚¹"></a>P2P çš„ç‰¹ç‚¹</h4><p><img src="https://raw.githubusercontent.com/dunwu/images/master/cs/java/javalib/jms/jms-pointToPoint.gif" alt="img"></p>
<p>åœ¨ç‚¹å¯¹ç‚¹çš„æ¶ˆæ¯ç³»ç»Ÿä¸­ï¼Œæ¶ˆæ¯åˆ†å‘ç»™ä¸€ä¸ªå•ç‹¬çš„ä½¿ç”¨è€…ã€‚ç‚¹å¯¹ç‚¹æ¶ˆæ¯å¾€å¾€ä¸é˜Ÿåˆ— <code>javax.jms.Queue</code> ç›¸å…³è”ã€‚</p>
<p>æ¯ä¸ªæ¶ˆæ¯åªæœ‰ä¸€ä¸ªæ¶ˆè´¹è€…ï¼ˆConsumerï¼‰(å³ä¸€æ—¦è¢«æ¶ˆè´¹ï¼Œæ¶ˆæ¯å°±ä¸å†åœ¨æ¶ˆæ¯é˜Ÿåˆ—ä¸­)ã€‚</p>
<p>å‘é€è€…å’Œæ¥æ”¶è€…ä¹‹é—´åœ¨æ—¶é—´ä¸Šæ²¡æœ‰ä¾èµ–æ€§ï¼Œä¹Ÿå°±æ˜¯è¯´å½“å‘é€è€…å‘é€äº†æ¶ˆæ¯ä¹‹åï¼Œä¸ç®¡æ¥æ”¶è€…æœ‰æ²¡æœ‰æ­£åœ¨è¿è¡Œï¼Œå®ƒä¸ä¼šå½±å“åˆ°æ¶ˆæ¯è¢«å‘é€åˆ°é˜Ÿåˆ—ã€‚</p>
<p>æ¥æ”¶è€…åœ¨æˆåŠŸæ¥æ”¶æ¶ˆæ¯ä¹‹åéœ€å‘é˜Ÿåˆ—åº”ç­”æˆåŠŸã€‚</p>
<p>å¦‚æœä½ å¸Œæœ›å‘é€çš„æ¯ä¸ªæ¶ˆæ¯éƒ½åº”è¯¥è¢«æˆåŠŸå¤„ç†çš„è¯ï¼Œé‚£ä¹ˆä½ éœ€è¦ P2P æ¨¡å¼ã€‚</p>
<h4 id="Pub-Sub-çš„ç‰¹ç‚¹"><a href="#Pub-Sub-çš„ç‰¹ç‚¹" class="headerlink" title="Pub&#x2F;Sub çš„ç‰¹ç‚¹"></a>Pub&#x2F;Sub çš„ç‰¹ç‚¹</h4><p><img src="https://raw.githubusercontent.com/dunwu/images/master/cs/java/javalib/jms/jms-publishSubscribe.gif" alt="img"></p>
<p>å‘å¸ƒ&#x2F;è®¢é˜…æ¶ˆæ¯ç³»ç»Ÿæ”¯æŒä¸€ä¸ªäº‹ä»¶é©±åŠ¨æ¨¡å‹ï¼Œæ¶ˆæ¯ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…éƒ½å‚ä¸æ¶ˆæ¯çš„ä¼ é€’ã€‚ç”Ÿäº§è€…å‘å¸ƒäº‹ä»¶ï¼Œè€Œä½¿ç”¨è€…è®¢é˜…æ„Ÿå…´è¶£çš„äº‹ä»¶ï¼Œå¹¶ä½¿ç”¨äº‹ä»¶ã€‚è¯¥ç±»å‹æ¶ˆæ¯ä¸€èˆ¬ä¸ç‰¹å®šçš„ä¸»é¢˜ <code>javax.jms.Topic</code> å…³è”ã€‚</p>
<p>æ¯ä¸ªæ¶ˆæ¯å¯ä»¥æœ‰å¤šä¸ªæ¶ˆè´¹è€…ã€‚</p>
<p>å‘å¸ƒè€…å’Œè®¢é˜…è€…ä¹‹é—´æœ‰æ—¶é—´ä¸Šçš„ä¾èµ–æ€§ã€‚é’ˆå¯¹æŸä¸ªä¸»é¢˜ï¼ˆTopicï¼‰çš„è®¢é˜…è€…ï¼Œå®ƒå¿…é¡»åˆ›å»ºä¸€ä¸ªè®¢é˜…è€…ä¹‹åï¼Œæ‰èƒ½æ¶ˆè´¹å‘å¸ƒè€…çš„æ¶ˆæ¯ï¼Œè€Œä¸”ä¸ºäº†æ¶ˆè´¹æ¶ˆæ¯ï¼Œè®¢é˜…è€…å¿…é¡»ä¿æŒè¿è¡Œçš„çŠ¶æ€ã€‚</p>
<p>ä¸ºäº†ç¼“å’Œè¿™æ ·ä¸¥æ ¼çš„æ—¶é—´ç›¸å…³æ€§ï¼ŒJMS å…è®¸è®¢é˜…è€…åˆ›å»ºä¸€ä¸ªå¯æŒä¹…åŒ–çš„è®¢é˜…ã€‚è¿™æ ·ï¼Œå³ä½¿è®¢é˜…è€…æ²¡æœ‰è¢«æ¿€æ´»ï¼ˆè¿è¡Œï¼‰ï¼Œå®ƒä¹Ÿèƒ½æ¥æ”¶åˆ°å‘å¸ƒè€…çš„æ¶ˆæ¯ã€‚</p>
<p>å¦‚æœä½ å¸Œæœ›å‘é€çš„æ¶ˆæ¯å¯ä»¥ä¸è¢«åšä»»ä½•å¤„ç†ã€æˆ–è€…è¢«ä¸€ä¸ªæ¶ˆæ¯è€…å¤„ç†ã€æˆ–è€…å¯ä»¥è¢«å¤šä¸ªæ¶ˆè´¹è€…å¤„ç†çš„è¯ï¼Œé‚£ä¹ˆå¯ä»¥é‡‡ç”¨ Pub&#x2F;Sub æ¨¡å‹ã€‚</p>
<h3 id="JMS-ç¼–ç¨‹æ¨¡å‹"><a href="#JMS-ç¼–ç¨‹æ¨¡å‹" class="headerlink" title="JMS ç¼–ç¨‹æ¨¡å‹"></a>JMS ç¼–ç¨‹æ¨¡å‹</h3><p><img src="https://raw.githubusercontent.com/dunwu/images/master/cs/java/javalib/jms/jms-publishSubscribe.gif" alt="img"></p>
<h4 id="ConnectionFactory"><a href="#ConnectionFactory" class="headerlink" title="ConnectionFactory"></a>ConnectionFactory</h4><p>åˆ›å»º <code>Connection</code> å¯¹è±¡çš„å·¥å‚ï¼Œé’ˆå¯¹ä¸¤ç§ä¸åŒçš„ jms æ¶ˆæ¯æ¨¡å‹ï¼Œåˆ†åˆ«æœ‰ <code>QueueConnectionFactory</code> å’Œ<code>TopicConnectionFactory</code> ä¸¤ç§ã€‚å¯ä»¥é€šè¿‡ JNDI æ¥æŸ¥æ‰¾ <code>ConnectionFactory</code> å¯¹è±¡ã€‚</p>
<h4 id="Connection"><a href="#Connection" class="headerlink" title="Connection"></a>Connection</h4><p><code>Connection</code> è¡¨ç¤ºåœ¨å®¢æˆ·ç«¯å’Œ JMS ç³»ç»Ÿä¹‹é—´å»ºç«‹çš„é“¾æ¥ï¼ˆå¯¹ TCP&#x2F;IP socket çš„åŒ…è£…ï¼‰ã€‚<code>Connection</code> å¯ä»¥äº§ç”Ÿä¸€ä¸ªæˆ–å¤šä¸ª<code>Session</code>ã€‚è·Ÿ <code>ConnectionFactory</code> ä¸€æ ·ï¼Œ<code>Connection</code> ä¹Ÿæœ‰ä¸¤ç§ç±»å‹ï¼š<code>QueueConnection</code> å’Œ <code>TopicConnection</code>ã€‚</p>
<h4 id="Destination"><a href="#Destination" class="headerlink" title="Destination"></a>Destination</h4><p><code>Destination</code> æ˜¯ä¸€ä¸ªåŒ…è£…äº†æ¶ˆæ¯ç›®æ ‡æ ‡è¯†ç¬¦çš„è¢«ç®¡å¯¹è±¡ã€‚æ¶ˆæ¯ç›®æ ‡æ˜¯æŒ‡æ¶ˆæ¯å‘å¸ƒå’Œæ¥æ”¶çš„åœ°ç‚¹ï¼Œæˆ–è€…æ˜¯é˜Ÿåˆ— <code>Queue</code> ï¼Œæˆ–è€…æ˜¯ä¸»é¢˜ <code>Topic</code> ã€‚JMS ç®¡ç†å‘˜åˆ›å»ºè¿™äº›å¯¹è±¡ï¼Œç„¶åç”¨æˆ·é€šè¿‡ JNDI å‘ç°å®ƒä»¬ã€‚å’Œè¿æ¥å·¥å‚ä¸€æ ·ï¼Œç®¡ç†å‘˜å¯ä»¥åˆ›å»ºä¸¤ç§ç±»å‹çš„ç›®æ ‡ï¼Œç‚¹å¯¹ç‚¹æ¨¡å‹çš„ <code>Queue</code>ï¼Œä»¥åŠå‘å¸ƒè€…&#x2F;è®¢é˜…è€…æ¨¡å‹çš„ <code>Topic</code>ã€‚</p>
<h4 id="Session"><a href="#Session" class="headerlink" title="Session"></a>Session</h4><p><code>Session</code> è¡¨ç¤ºä¸€ä¸ªå•çº¿ç¨‹çš„ä¸Šä¸‹æ–‡ï¼Œç”¨äºå‘é€å’Œæ¥æ”¶æ¶ˆæ¯ã€‚ç”±äºä¼šè¯æ˜¯å•çº¿ç¨‹çš„ï¼Œæ‰€ä»¥æ¶ˆæ¯æ˜¯è¿ç»­çš„ï¼Œå°±æ˜¯è¯´æ¶ˆæ¯æ˜¯æŒ‰ç…§å‘é€çš„é¡ºåºä¸€ä¸ªä¸€ä¸ªæ¥æ”¶çš„ã€‚ä¼šè¯çš„å¥½å¤„æ˜¯å®ƒæ”¯æŒäº‹åŠ¡ã€‚å¦‚æœç”¨æˆ·é€‰æ‹©äº†äº‹åŠ¡æ”¯æŒï¼Œä¼šè¯ä¸Šä¸‹æ–‡å°†ä¿å­˜ä¸€ç»„æ¶ˆæ¯ï¼Œç›´åˆ°äº‹åŠ¡è¢«æäº¤æ‰å‘é€è¿™äº›æ¶ˆæ¯ã€‚åœ¨æäº¤äº‹åŠ¡ä¹‹å‰ï¼Œç”¨æˆ·å¯ä»¥ä½¿ç”¨å›æ»šæ“ä½œå–æ¶ˆè¿™äº›æ¶ˆæ¯ã€‚ä¸€ä¸ªä¼šè¯å…è®¸ç”¨æˆ·åˆ›å»ºæ¶ˆæ¯ï¼Œç”Ÿäº§è€…æ¥å‘é€æ¶ˆæ¯ï¼Œæ¶ˆè´¹è€…æ¥æ¥æ”¶æ¶ˆæ¯ã€‚åŒæ ·ï¼Œ<code>Session</code> ä¹Ÿåˆ† <code>QueueSession</code> å’Œ <code>TopicSession</code>ã€‚</p>
<h4 id="MessageConsumer"><a href="#MessageConsumer" class="headerlink" title="MessageConsumer"></a>MessageConsumer</h4><p><code>MessageConsumer</code> ç”± <code>Session</code> åˆ›å»ºï¼Œå¹¶ç”¨äºå°†æ¶ˆæ¯å‘é€åˆ° <code>Destination</code>ã€‚æ¶ˆè´¹è€…å¯ä»¥åŒæ­¥åœ°ï¼ˆé˜»å¡æ¨¡å¼ï¼‰ï¼Œæˆ–ï¼ˆéé˜»å¡ï¼‰æ¥æ”¶ <code>Queue</code> å’Œ <code>Topic</code> ç±»å‹çš„æ¶ˆæ¯ã€‚åŒæ ·ï¼Œæ¶ˆæ¯ç”Ÿäº§è€…åˆ†ä¸¤ç§ç±»å‹ï¼š<code>QueueSender</code> å’Œ<code>TopicPublisher</code>ã€‚</p>
<h4 id="MessageProducer"><a href="#MessageProducer" class="headerlink" title="MessageProducer"></a>MessageProducer</h4><p><code>MessageProducer</code> ç”± <code>Session</code> åˆ›å»ºï¼Œç”¨äºæ¥æ”¶è¢«å‘é€åˆ° <code>Destination</code> çš„æ¶ˆæ¯ã€‚<code>MessageProducer</code> æœ‰ä¸¤ç§ç±»å‹ï¼š<code>QueueReceiver</code> å’Œ <code>TopicSubscriber</code>ã€‚å¯åˆ†åˆ«é€šè¿‡ <code>session</code> çš„ <code>createReceiver(Queue)</code> æˆ– <code>createSubscriber(Topic)</code> æ¥åˆ›å»ºã€‚å½“ç„¶ï¼Œä¹Ÿå¯ä»¥ <code>session</code> çš„ <code>creatDurableSubscriber</code> æ–¹æ³•æ¥åˆ›å»ºæŒä¹…åŒ–çš„è®¢é˜…è€…ã€‚</p>
<h4 id="Message"><a href="#Message" class="headerlink" title="Message"></a>Message</h4><p>æ˜¯åœ¨æ¶ˆè´¹è€…å’Œç”Ÿäº§è€…ä¹‹é—´ä¼ é€çš„å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯è¯´ä»ä¸€ä¸ªåº”ç”¨ç¨‹åºä¼ é€åˆ°å¦ä¸€ä¸ªåº”ç”¨ç¨‹åºã€‚ä¸€ä¸ªæ¶ˆæ¯æœ‰ä¸‰ä¸ªä¸»è¦éƒ¨åˆ†ï¼š</p>
<ul>
<li>æ¶ˆæ¯å¤´ï¼ˆå¿…é¡»ï¼‰ï¼šåŒ…å«ç”¨äºè¯†åˆ«å’Œä¸ºæ¶ˆæ¯å¯»æ‰¾è·¯ç”±çš„æ“ä½œè®¾ç½®ã€‚</li>
<li>ä¸€ç»„æ¶ˆæ¯å±æ€§ï¼ˆå¯é€‰ï¼‰ï¼šåŒ…å«é¢å¤–çš„å±æ€§ï¼Œæ”¯æŒå…¶ä»–æä¾›è€…å’Œç”¨æˆ·çš„å…¼å®¹ã€‚å¯ä»¥åˆ›å»ºå®šåˆ¶çš„å­—æ®µå’Œè¿‡æ»¤å™¨ï¼ˆæ¶ˆæ¯é€‰æ‹©å™¨ï¼‰ã€‚</li>
<li>ä¸€ä¸ªæ¶ˆæ¯ä½“ï¼ˆå¯é€‰ï¼‰ï¼šå…è®¸ç”¨æˆ·åˆ›å»ºäº”ç§ç±»å‹çš„æ¶ˆæ¯ï¼ˆæ–‡æœ¬æ¶ˆæ¯ï¼Œæ˜ å°„æ¶ˆæ¯ï¼Œå­—èŠ‚æ¶ˆæ¯ï¼Œæµæ¶ˆæ¯å’Œå¯¹è±¡æ¶ˆæ¯ï¼‰ã€‚</li>
</ul>
<p>æ¶ˆæ¯æ¥å£éå¸¸çµæ´»ï¼Œå¹¶æä¾›äº†è®¸å¤šæ–¹å¼æ¥å®šåˆ¶æ¶ˆæ¯çš„å†…å®¹ã€‚</p>
<table>
<thead>
<tr>
<th>Common</th>
<th>Point-to-Point</th>
<th>Publish-Subscribe</th>
</tr>
</thead>
<tbody><tr>
<td>ConnectionFactory</td>
<td>QueueConnectionFactory</td>
<td>TopicConnectionFactory</td>
</tr>
<tr>
<td>Connection</td>
<td>QueueConnection</td>
<td>TopicConnection</td>
</tr>
<tr>
<td>Destination</td>
<td>Queue</td>
<td>Topic</td>
</tr>
<tr>
<td>Session</td>
<td>QueueSession</td>
<td>TopicSession</td>
</tr>
<tr>
<td>MessageProducer</td>
<td>QueueSender</td>
<td>TopicPublisher</td>
</tr>
<tr>
<td>MessageSender</td>
<td>QueueReceiver, QueueBrowser</td>
<td>TopicSubscriber</td>
</tr>
</tbody></table>
<h2 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h2><p><strong>å®‰è£…æ¡ä»¶</strong></p>
<p>JDK1.7 åŠä»¥ä¸Šç‰ˆæœ¬</p>
<p>æœ¬åœ°é…ç½®äº† <strong>JAVA_HOME</strong> ç¯å¢ƒå˜é‡ã€‚</p>
<p><strong>ä¸‹è½½</strong></p>
<p>æ”¯æŒ Windows&#x2F;Unix&#x2F;Linux&#x2F;Cygwin</p>
<p><a target="_blank" rel="noopener" href="http://activemq.apache.org/download.html">ActiveMQ å®˜æ–¹ä¸‹è½½åœ°å€</a></p>
<p><strong>Windows ä¸‹è¿è¡Œ</strong></p>
<p>ï¼ˆ1ï¼‰è§£å‹å‹ç¼©åŒ…åˆ°æœ¬åœ°ï¼›</p>
<p>ï¼ˆ2ï¼‰æ‰“å¼€æ§åˆ¶å°ï¼Œè¿›å…¥å®‰è£…ç›®å½•çš„ <code>bin</code> ç›®å½•ä¸‹ï¼›</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">cd</span><span class="meta"> [activemq_install_dir]</span></span><br></pre></td></tr></table></figure>

<p>ï¼ˆ3ï¼‰æ‰§è¡Œ <code>activemq start</code> æ¥å¯åŠ¨ ActiveMQ</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin\activemq <span class="literal">start</span></span><br></pre></td></tr></table></figure>

<p><strong>æµ‹è¯•å®‰è£…æ˜¯å¦æˆåŠŸ</strong></p>
<p>ï¼ˆ1ï¼‰ActiveMQ é»˜è®¤ç›‘å¬ç«¯å£ä¸º 61616</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netstat -an|<span class="built_in">find</span> â€œ61616â€</span><br></pre></td></tr></table></figure>

<p>ï¼ˆ2ï¼‰è®¿é—® <a target="_blank" rel="noopener" href="http://127.0.0.1:8161/admin/">http://127.0.0.1:8161/admin/</a></p>
<p>ï¼ˆ3ï¼‰è¾“å…¥ç”¨æˆ·åã€å¯†ç </p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Login</span>: <span class="keyword">admin</span></span><br><span class="line">Passwort: <span class="keyword">admin</span></span><br></pre></td></tr></table></figure>

<p>ï¼ˆ4ï¼‰ç‚¹å‡»å¯¼èˆªæ çš„ Queues èœå•</p>
<p>ï¼ˆ5ï¼‰æ·»åŠ ä¸€ä¸ªé˜Ÿåˆ—ï¼ˆqueueï¼‰</p>
<h2 id="é¡¹ç›®ä¸­çš„åº”ç”¨"><a href="#é¡¹ç›®ä¸­çš„åº”ç”¨" class="headerlink" title="é¡¹ç›®ä¸­çš„åº”ç”¨"></a>é¡¹ç›®ä¸­çš„åº”ç”¨</h2><p><strong>å¼•å…¥ä¾èµ–</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.activemq<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>activemq-all<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.14.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>Sender.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Sender</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">SEND_NUMBER</span> <span class="operator">=</span> <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// ConnectionFactory ï¼šè¿æ¥å·¥å‚ï¼ŒJMS ç”¨å®ƒåˆ›å»ºè¿æ¥</span></span><br><span class="line">        ConnectionFactory connectionFactory;</span><br><span class="line">        <span class="comment">// Connection ï¼šJMS å®¢æˆ·ç«¯åˆ°JMS Provider çš„è¿æ¥</span></span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="comment">// Sessionï¼š ä¸€ä¸ªå‘é€æˆ–æ¥æ”¶æ¶ˆæ¯çš„çº¿ç¨‹</span></span><br><span class="line">        Session session;</span><br><span class="line">        <span class="comment">// Destination ï¼šæ¶ˆæ¯çš„ç›®çš„åœ°;æ¶ˆæ¯å‘é€ç»™è°.</span></span><br><span class="line">        Destination destination;</span><br><span class="line">        <span class="comment">// MessageProducerï¼šæ¶ˆæ¯å‘é€è€…</span></span><br><span class="line">        MessageProducer producer;</span><br><span class="line">        <span class="comment">// TextMessage message;</span></span><br><span class="line">        <span class="comment">// æ„é€ ConnectionFactoryå®ä¾‹å¯¹è±¡ï¼Œæ­¤å¤„é‡‡ç”¨ActiveMqçš„å®ç°jar</span></span><br><span class="line">        connectionFactory = <span class="keyword">new</span> <span class="title class_">ActiveMQConnectionFactory</span>(</span><br><span class="line">                ActiveMQConnection.DEFAULT_USER,</span><br><span class="line">                ActiveMQConnection.DEFAULT_PASSWORD,</span><br><span class="line">                <span class="string">&quot;tcp://localhost:61616&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// æ„é€ ä»å·¥å‚å¾—åˆ°è¿æ¥å¯¹è±¡</span></span><br><span class="line">            connection = connectionFactory.createConnection();</span><br><span class="line">            <span class="comment">// å¯åŠ¨</span></span><br><span class="line">            connection.start();</span><br><span class="line">            <span class="comment">// è·å–æ“ä½œè¿æ¥</span></span><br><span class="line">            session = connection.createSession(Boolean.TRUE,</span><br><span class="line">                    Session.AUTO_ACKNOWLEDGE);</span><br><span class="line">            <span class="comment">// è·å–sessionæ³¨æ„å‚æ•°å€¼xingbo.xu-queueæ˜¯ä¸€ä¸ªæœåŠ¡å™¨çš„queueï¼Œé¡»åœ¨åœ¨ActiveMqçš„consoleé…ç½®</span></span><br><span class="line">            destination = session.createQueue(<span class="string">&quot;FirstQueue&quot;</span>);</span><br><span class="line">            <span class="comment">// å¾—åˆ°æ¶ˆæ¯ç”Ÿæˆè€…ã€å‘é€è€…ã€‘</span></span><br><span class="line">            producer = session.createProducer(destination);</span><br><span class="line">            <span class="comment">// è®¾ç½®ä¸æŒä¹…åŒ–ï¼Œæ­¤å¤„å­¦ä¹ ï¼Œå®é™…æ ¹æ®é¡¹ç›®å†³å®š</span></span><br><span class="line">            producer.setDeliveryMode(DeliveryMode.NON_PERSISTENT);</span><br><span class="line">            <span class="comment">// æ„é€ æ¶ˆæ¯ï¼Œæ­¤å¤„å†™æ­»ï¼Œé¡¹ç›®å°±æ˜¯å‚æ•°ï¼Œæˆ–è€…æ–¹æ³•è·å–</span></span><br><span class="line">            sendMessage(session, producer);</span><br><span class="line">            session.commit();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="literal">null</span> != connection)</span><br><span class="line">                    connection.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable ignore) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">sendMessage</span><span class="params">(Session session, MessageProducer producer)</span></span><br><span class="line">            <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;= SEND_NUMBER; i++) &#123;</span><br><span class="line">            <span class="type">TextMessage</span> <span class="variable">message</span> <span class="operator">=</span> session</span><br><span class="line">                    .createTextMessage(<span class="string">&quot;ActiveMq å‘é€çš„æ¶ˆæ¯&quot;</span> + i);</span><br><span class="line">            <span class="comment">// å‘é€æ¶ˆæ¯åˆ°ç›®çš„åœ°æ–¹</span></span><br><span class="line">            System.out.println(<span class="string">&quot;å‘é€æ¶ˆæ¯ï¼š&quot;</span> + <span class="string">&quot;ActiveMq å‘é€çš„æ¶ˆæ¯&quot;</span> + i);</span><br><span class="line">            producer.send(message);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Receiver.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Receiver</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// ConnectionFactory ï¼šè¿æ¥å·¥å‚ï¼ŒJMS ç”¨å®ƒåˆ›å»ºè¿æ¥</span></span><br><span class="line">        ConnectionFactory connectionFactory;</span><br><span class="line">        <span class="comment">// Connection ï¼šJMS å®¢æˆ·ç«¯åˆ°JMS Provider çš„è¿æ¥</span></span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="comment">// Sessionï¼š ä¸€ä¸ªå‘é€æˆ–æ¥æ”¶æ¶ˆæ¯çš„çº¿ç¨‹</span></span><br><span class="line">        Session session;</span><br><span class="line">        <span class="comment">// Destination ï¼šæ¶ˆæ¯çš„ç›®çš„åœ°;æ¶ˆæ¯å‘é€ç»™è°.</span></span><br><span class="line">        Destination destination;</span><br><span class="line">        <span class="comment">// æ¶ˆè´¹è€…ï¼Œæ¶ˆæ¯æ¥æ”¶è€…</span></span><br><span class="line">        MessageConsumer consumer;</span><br><span class="line">        connectionFactory = <span class="keyword">new</span> <span class="title class_">ActiveMQConnectionFactory</span>(</span><br><span class="line">                ActiveMQConnection.DEFAULT_USER,</span><br><span class="line">                ActiveMQConnection.DEFAULT_PASSWORD,</span><br><span class="line">                <span class="string">&quot;tcp://localhost:61616&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// æ„é€ ä»å·¥å‚å¾—åˆ°è¿æ¥å¯¹è±¡</span></span><br><span class="line">            connection = connectionFactory.createConnection();</span><br><span class="line">            <span class="comment">// å¯åŠ¨</span></span><br><span class="line">            connection.start();</span><br><span class="line">            <span class="comment">// è·å–æ“ä½œè¿æ¥</span></span><br><span class="line">            session = connection.createSession(Boolean.FALSE,</span><br><span class="line">                    Session.AUTO_ACKNOWLEDGE);</span><br><span class="line">            <span class="comment">// è·å–sessionæ³¨æ„å‚æ•°å€¼xingbo.xu-queueæ˜¯ä¸€ä¸ªæœåŠ¡å™¨çš„queueï¼Œé¡»åœ¨åœ¨ActiveMqçš„consoleé…ç½®</span></span><br><span class="line">            destination = session.createQueue(<span class="string">&quot;FirstQueue&quot;</span>);</span><br><span class="line">            consumer = session.createConsumer(destination);</span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                <span class="comment">//è®¾ç½®æ¥æ”¶è€…æ¥æ”¶æ¶ˆæ¯çš„æ—¶é—´ï¼Œä¸ºäº†ä¾¿äºæµ‹è¯•ï¼Œè¿™é‡Œè°å®šä¸º100s</span></span><br><span class="line">                <span class="type">TextMessage</span> <span class="variable">message</span> <span class="operator">=</span> (TextMessage) consumer.receive(<span class="number">100000</span>);</span><br><span class="line">                <span class="keyword">if</span> (<span class="literal">null</span> != message) &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;æ”¶åˆ°æ¶ˆæ¯&quot;</span> + message.getText());</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="literal">null</span> != connection)</span><br><span class="line">                    connection.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable ignore) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>è¿è¡Œ</strong></p>
<p>å…ˆè¿è¡Œ Receiver.java è¿›è¡Œæ¶ˆæ¯ç›‘å¬ï¼Œå†è¿è¡Œ Send.java å‘é€æ¶ˆæ¯ã€‚</p>
<p><strong>è¾“å‡º</strong></p>
<p>Send çš„è¾“å‡ºå†…å®¹</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">å‘é€æ¶ˆæ¯ï¼šActivemq å‘é€æ¶ˆæ¯0</span><br><span class="line">å‘é€æ¶ˆæ¯ï¼šActivemq å‘é€æ¶ˆæ¯1</span><br><span class="line">å‘é€æ¶ˆæ¯ï¼šActivemq å‘é€æ¶ˆæ¯2</span><br><span class="line">å‘é€æ¶ˆæ¯ï¼šActivemq å‘é€æ¶ˆæ¯3</span><br></pre></td></tr></table></figure>

<p>Receiver çš„è¾“å‡ºå†…å®¹</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">æ”¶åˆ°æ¶ˆæ¯ActiveMQ å‘é€æ¶ˆæ¯0</span><br><span class="line">æ”¶åˆ°æ¶ˆæ¯ActiveMQ å‘é€æ¶ˆæ¯1</span><br><span class="line">æ”¶åˆ°æ¶ˆæ¯ActiveMQ å‘é€æ¶ˆæ¯2</span><br><span class="line">æ”¶åˆ°æ¶ˆæ¯ActiveMQ å‘é€æ¶ˆæ¯3</span><br></pre></td></tr></table></figure>

<h2 id="èµ„æº"><a href="#èµ„æº" class="headerlink" title="èµ„æº"></a>èµ„æº</h2><ul>
<li><a target="_blank" rel="noopener" href="http://activemq.apache.org/">ActiveMQ å®˜ç½‘</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.oracle.com/cd/E19575-01/819-3669/6n5sg7cgq/index.html">oracle å®˜æ–¹çš„ jms ä»‹ç»</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://dunwu.github.io/blog/pages/8512e688/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/uploads/avatar.gif">
      <meta itemprop="name" content="é’æ‚Ÿ â—¾ Dunwu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dunwu Blog">
      <meta itemprop="description" content="é’æ‚Ÿçš„ä¸ªäººåšå®¢">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Dunwu Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/pages/8512e688/" class="post-title-link" itemprop="url">Flink API</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2022-02-17 22:28:55" itemprop="dateCreated datePublished" datetime="2022-02-17T22:28:55+08:00">2022-02-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">æ›´æ–°äº</span>
      <time title="ä¿®æ”¹æ—¶é—´ï¼š2025-09-13 17:56:53" itemprop="dateModified" datetime="2025-09-13T17:56:53+08:00">2025-09-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/" itemprop="url" rel="index"><span itemprop="name">å¤§æ•°æ®</span></a>
        </span>
          ï¼Œ
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/flink/" itemprop="url" rel="index"><span itemprop="name">flink</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
      <span>5k</span>
    </span>
    <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
      <span>5 åˆ†é’Ÿ</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Flink-API"><a href="#Flink-API" class="headerlink" title="Flink API"></a>Flink API</h1><h2 id="Flink-API-çš„åˆ†å±‚"><a href="#Flink-API-çš„åˆ†å±‚" class="headerlink" title="Flink API çš„åˆ†å±‚"></a>Flink API çš„åˆ†å±‚</h2><p>Flink ä¸ºæµå¼&#x2F;æ‰¹å¼å¤„ç†åº”ç”¨ç¨‹åºçš„å¼€å‘æä¾›äº†ä¸åŒçº§åˆ«çš„æŠ½è±¡ã€‚</p>
<p><img src="https://nightlies.apache.org/flink/flink-docs-release-1.14/fig/levels_of_abstraction.svg" alt="Programming levels of abstraction"></p>
<ul>
<li><p>Flink API æœ€åº•å±‚çš„æŠ½è±¡ä¸º<strong>æœ‰çŠ¶æ€å®æ—¶æµå¤„ç†</strong>ã€‚å…¶æŠ½è±¡å®ç°æ˜¯ <a target="_blank" rel="noopener" href="https://nightlies.apache.org/flink/flink-docs-release-1.14/zh/docs/dev/datastream/operators/process_function/">Process Function</a>ï¼Œå¹¶ä¸” <strong>Process Function</strong> è¢« Flink æ¡†æ¶é›†æˆåˆ°äº† <a target="_blank" rel="noopener" href="https://nightlies.apache.org/flink/flink-docs-release-1.14/zh/docs/dev/datastream/overview/">DataStream API</a> ä¸­æ¥ä¸ºæˆ‘ä»¬ä½¿ç”¨ã€‚å®ƒå…è®¸ç”¨æˆ·åœ¨åº”ç”¨ç¨‹åºä¸­è‡ªç”±åœ°å¤„ç†æ¥è‡ªå•æµæˆ–å¤šæµçš„äº‹ä»¶ï¼ˆæ•°æ®ï¼‰ï¼Œå¹¶æä¾›å…·æœ‰å…¨å±€ä¸€è‡´æ€§å’Œå®¹é”™ä¿éšœçš„<em>çŠ¶æ€</em>ã€‚æ­¤å¤–ï¼Œç”¨æˆ·å¯ä»¥åœ¨æ­¤å±‚æŠ½è±¡ä¸­æ³¨å†Œäº‹ä»¶æ—¶é—´ï¼ˆevent timeï¼‰å’Œå¤„ç†æ—¶é—´ï¼ˆprocessing timeï¼‰å›è°ƒæ–¹æ³•ï¼Œä»è€Œå…è®¸ç¨‹åºå¯ä»¥å®ç°å¤æ‚è®¡ç®—ã€‚</p>
</li>
<li><p>Flink API ç¬¬äºŒå±‚æŠ½è±¡æ˜¯ <strong>Core APIs</strong>ã€‚å®é™…ä¸Šï¼Œè®¸å¤šåº”ç”¨ç¨‹åºä¸éœ€è¦ä½¿ç”¨åˆ°ä¸Šè¿°æœ€åº•å±‚æŠ½è±¡çš„ APIï¼Œè€Œæ˜¯å¯ä»¥ä½¿ç”¨ <strong>Core APIs</strong> è¿›è¡Œç¼–ç¨‹ï¼šå…¶ä¸­åŒ…å« <a target="_blank" rel="noopener" href="https://nightlies.apache.org/flink/flink-docs-release-1.14/zh/docs/dev/datastream/overview/">DataStream API</a>ï¼ˆåº”ç”¨äºæœ‰ç•Œ&#x2F;æ— ç•Œæ•°æ®æµåœºæ™¯ï¼‰å’Œ <a target="_blank" rel="noopener" href="https://nightlies.apache.org/flink/flink-docs-release-1.14/zh/docs/dev/dataset/overview/">DataSet API</a>ï¼ˆåº”ç”¨äºæœ‰ç•Œæ•°æ®é›†åœºæ™¯ï¼‰ä¸¤éƒ¨åˆ†ã€‚Core APIs æä¾›çš„æµå¼ APIï¼ˆFluent APIï¼‰ä¸ºæ•°æ®å¤„ç†æä¾›äº†é€šç”¨çš„æ¨¡å—ç»„ä»¶ï¼Œä¾‹å¦‚å„ç§å½¢å¼çš„ç”¨æˆ·è‡ªå®šä¹‰è½¬æ¢ï¼ˆtransformationsï¼‰ã€è”æ¥ï¼ˆjoinsï¼‰ã€èšåˆï¼ˆaggregationsï¼‰ã€çª—å£ï¼ˆwindowsï¼‰å’ŒçŠ¶æ€ï¼ˆstateï¼‰æ“ä½œç­‰ã€‚æ­¤å±‚ API ä¸­å¤„ç†çš„æ•°æ®ç±»å‹åœ¨æ¯ç§ç¼–ç¨‹è¯­è¨€ä¸­éƒ½æœ‰å…¶å¯¹åº”çš„ç±»ã€‚</p>
<p><em>Process Function</em> è¿™ç±»åº•å±‚æŠ½è±¡å’Œ <em>DataStream API</em> çš„ç›¸äº’é›†æˆä½¿å¾—ç”¨æˆ·å¯ä»¥é€‰æ‹©ä½¿ç”¨æ›´åº•å±‚çš„æŠ½è±¡ API æ¥å®ç°è‡ªå·±çš„éœ€æ±‚ã€‚<em>DataSet API</em> è¿˜é¢å¤–æä¾›äº†ä¸€äº›åŸè¯­ï¼Œæ¯”å¦‚å¾ªç¯&#x2F;è¿­ä»£ï¼ˆloop&#x2F;iterationï¼‰æ“ä½œã€‚</p>
</li>
<li><p>Flink API ç¬¬ä¸‰å±‚æŠ½è±¡æ˜¯ <strong>Table API</strong>ã€‚<strong>Table API</strong> æ˜¯ä»¥è¡¨ï¼ˆTableï¼‰ä¸ºä¸­å¿ƒçš„å£°æ˜å¼ç¼–ç¨‹ï¼ˆDSLï¼‰APIï¼Œä¾‹å¦‚åœ¨æµå¼æ•°æ®åœºæ™¯ä¸‹ï¼Œå®ƒå¯ä»¥è¡¨ç¤ºä¸€å¼ æ­£åœ¨åŠ¨æ€æ”¹å˜çš„è¡¨ã€‚<a target="_blank" rel="noopener" href="https://nightlies.apache.org/flink/flink-docs-release-1.14/zh/docs/dev/table/overview/">Table API</a> éµå¾ªï¼ˆæ‰©å±•ï¼‰å…³ç³»æ¨¡å‹ï¼šå³è¡¨æ‹¥æœ‰ schemaï¼ˆç±»ä¼¼äºå…³ç³»å‹æ•°æ®åº“ä¸­çš„ schemaï¼‰ï¼Œå¹¶ä¸” Table API ä¹Ÿæä¾›äº†ç±»ä¼¼äºå…³ç³»æ¨¡å‹ä¸­çš„æ“ä½œï¼Œæ¯”å¦‚ selectã€projectã€joinã€group-by å’Œ aggregate ç­‰ã€‚Table API ç¨‹åºæ˜¯ä»¥å£°æ˜çš„æ–¹å¼å®šä¹‰<em>åº”æ‰§è¡Œçš„é€»è¾‘æ“ä½œ</em>ï¼Œè€Œä¸æ˜¯ç¡®åˆ‡åœ°æŒ‡å®šç¨‹åº<em>åº”è¯¥æ‰§è¡Œçš„ä»£ç </em>ã€‚å°½ç®¡ Table API ä½¿ç”¨èµ·æ¥å¾ˆç®€æ´å¹¶ä¸”å¯ä»¥ç”±å„ç§ç±»å‹çš„ç”¨æˆ·è‡ªå®šä¹‰å‡½æ•°æ‰©å±•åŠŸèƒ½ï¼Œä½†è¿˜æ˜¯æ¯” Core API çš„è¡¨è¾¾èƒ½åŠ›å·®ã€‚æ­¤å¤–ï¼ŒTable API ç¨‹åºåœ¨æ‰§è¡Œä¹‹å‰è¿˜ä¼šä½¿ç”¨ä¼˜åŒ–å™¨ä¸­çš„ä¼˜åŒ–è§„åˆ™å¯¹ç”¨æˆ·ç¼–å†™çš„è¡¨è¾¾å¼è¿›è¡Œä¼˜åŒ–ã€‚</p>
<p>è¡¨å’Œ <em>DataStream</em>&#x2F;<em>DataSet</em> å¯ä»¥è¿›è¡Œæ— ç¼åˆ‡æ¢ï¼ŒFlink å…è®¸ç”¨æˆ·åœ¨ç¼–å†™åº”ç”¨ç¨‹åºæ—¶å°† <em>Table API</em> ä¸ <em>DataStream</em>&#x2F;<em>DataSet</em> API æ··åˆä½¿ç”¨ã€‚</p>
</li>
<li><p>Flink API æœ€é¡¶å±‚æŠ½è±¡æ˜¯ <strong>SQL</strong>ã€‚è¿™å±‚æŠ½è±¡åœ¨è¯­ä¹‰å’Œç¨‹åºè¡¨è¾¾å¼ä¸Šéƒ½ç±»ä¼¼äº _Table API_ï¼Œä½†æ˜¯å…¶ç¨‹åºå®ç°éƒ½æ˜¯ SQL æŸ¥è¯¢è¡¨è¾¾å¼ã€‚<a target="_blank" rel="noopener" href="https://nightlies.apache.org/flink/flink-docs-release-1.14/zh/docs/dev/table/overview/#sql">SQL</a> æŠ½è±¡ä¸ Table API æŠ½è±¡ä¹‹é—´çš„å…³è”æ˜¯éå¸¸ç´§å¯†çš„ï¼Œå¹¶ä¸” SQL æŸ¥è¯¢è¯­å¥å¯ä»¥åœ¨ <em>Table API</em> ä¸­å®šä¹‰çš„è¡¨ä¸Šæ‰§è¡Œã€‚</p>
</li>
</ul>
<h2 id="ProcessFunction"><a href="#ProcessFunction" class="headerlink" title="ProcessFunction"></a>ProcessFunction</h2><p><a target="_blank" rel="noopener" href="https://nightlies.apache.org/flink/flink-docs-stable/dev/stream/operators/process_function.html">ProcessFunction</a> æ˜¯ Flink æ‰€æä¾›çš„æœ€å…·è¡¨è¾¾åŠ›çš„æ¥å£ã€‚ProcessFunction å¯ä»¥å¤„ç†ä¸€æˆ–ä¸¤æ¡è¾“å…¥æ•°æ®æµä¸­çš„å•ä¸ªäº‹ä»¶æˆ–è€…å½’å…¥ä¸€ä¸ªç‰¹å®šçª—å£å†…çš„å¤šä¸ªäº‹ä»¶ã€‚å®ƒæä¾›äº†<strong>å¯¹äºæ—¶é—´å’ŒçŠ¶æ€çš„ç»†ç²’åº¦æ§åˆ¶</strong>ã€‚å¼€å‘è€…å¯ä»¥åœ¨å…¶ä¸­ä»»æ„åœ°ä¿®æ”¹çŠ¶æ€ï¼Œä¹Ÿèƒ½å¤Ÿæ³¨å†Œå®šæ—¶å™¨ç”¨ä»¥åœ¨æœªæ¥çš„æŸä¸€æ—¶åˆ»è§¦å‘å›è°ƒå‡½æ•°ã€‚å› æ­¤ï¼Œä½ å¯ä»¥åˆ©ç”¨ ProcessFunction å®ç°è®¸å¤š<a target="_blank" rel="noopener" href="https://flink.apache.org/zh/usecases.html#eventDrivenApps">æœ‰çŠ¶æ€çš„äº‹ä»¶é©±åŠ¨åº”ç”¨</a>æ‰€éœ€è¦çš„åŸºäºå•ä¸ªäº‹ä»¶çš„å¤æ‚ä¸šåŠ¡é€»è¾‘ã€‚</p>
<p>ä¸‹é¢çš„ä»£ç ç¤ºä¾‹å±•ç¤ºäº†å¦‚ä½•åœ¨ <code>KeyedStream</code> ä¸Šåˆ©ç”¨ <code>KeyedProcessFunction</code> å¯¹æ ‡è®°ä¸º <code>START</code> å’Œ <code>END</code> çš„äº‹ä»¶è¿›è¡Œå¤„ç†ã€‚å½“æ”¶åˆ° <code>START</code> äº‹ä»¶æ—¶ï¼Œå¤„ç†å‡½æ•°ä¼šè®°å½•å…¶æ—¶é—´æˆ³ï¼Œå¹¶ä¸”æ³¨å†Œä¸€ä¸ªæ—¶é•¿ 4 å°æ—¶çš„è®¡æ—¶å™¨ã€‚å¦‚æœåœ¨è®¡æ—¶å™¨ç»“æŸä¹‹å‰æ”¶åˆ° <code>END</code> äº‹ä»¶ï¼Œå¤„ç†å‡½æ•°ä¼šè®¡ç®—å…¶ä¸ä¸Šä¸€ä¸ª <code>START</code> äº‹ä»¶çš„æ—¶é—´é—´éš”ï¼Œæ¸…ç©ºçŠ¶æ€å¹¶å°†è®¡ç®—ç»“æœè¿”å›ã€‚å¦åˆ™ï¼Œè®¡æ—¶å™¨ç»“æŸï¼Œå¹¶æ¸…ç©ºçŠ¶æ€ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> * å°†ç›¸é‚»çš„ keyed START å’Œ END äº‹ä»¶ç›¸åŒ¹é…å¹¶è®¡ç®—ä¸¤è€…çš„æ—¶é—´é—´éš”</span></span><br><span class="line"><span class="comment"> * è¾“å…¥æ•°æ®ä¸º Tuple2&lt;String, String&gt; ç±»å‹ï¼Œç¬¬ä¸€ä¸ªå­—æ®µä¸º key å€¼ï¼Œ</span></span><br><span class="line"><span class="comment"> * ç¬¬äºŒä¸ªå­—æ®µæ ‡è®° START å’Œ END äº‹ä»¶ã€‚</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">StartEndDuration</span></span><br><span class="line">    <span class="keyword">extends</span> <span class="title class_">KeyedProcessFunction</span>&lt;String, Tuple2&lt;String, String&gt;, Tuple2&lt;String, Long&gt;&gt; &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> ValueState&lt;Long&gt; startTime;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">open</span><span class="params">(Configuration conf)</span> &#123;</span><br><span class="line">    <span class="comment">// obtain state handle</span></span><br><span class="line">    startTime = getRuntimeContext()</span><br><span class="line">      .getState(<span class="keyword">new</span> <span class="title class_">ValueStateDescriptor</span>&lt;Long&gt;(<span class="string">&quot;startTime&quot;</span>, Long.class));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** Called for each processed event. */</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processElement</span><span class="params">(</span></span><br><span class="line"><span class="params">      Tuple2&lt;String, String&gt; in,</span></span><br><span class="line"><span class="params">      Context ctx,</span></span><br><span class="line"><span class="params">      Collector&lt;Tuple2&lt;String, Long&gt;&gt; out)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (in.f1) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&quot;START&quot;</span>:</span><br><span class="line">        <span class="comment">// set the start time if we receive a start event.</span></span><br><span class="line">        startTime.update(ctx.timestamp());</span><br><span class="line">        <span class="comment">// register a timer in four hours from the start event.</span></span><br><span class="line">        ctx.timerService()</span><br><span class="line">          .registerEventTimeTimer(ctx.timestamp() + <span class="number">4</span> * <span class="number">60</span> * <span class="number">60</span> * <span class="number">1000</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&quot;END&quot;</span>:</span><br><span class="line">        <span class="comment">// emit the duration between start and end event</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">sTime</span> <span class="operator">=</span> startTime.value();</span><br><span class="line">        <span class="keyword">if</span> (sTime != <span class="literal">null</span>) &#123;</span><br><span class="line">          out.collect(Tuple2.of(in.f0, ctx.timestamp() - sTime));</span><br><span class="line">          <span class="comment">// clear the state</span></span><br><span class="line">          startTime.clear();</span><br><span class="line">        &#125;</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        <span class="comment">// do nothing</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** Called when a timer fires. */</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onTimer</span><span class="params">(</span></span><br><span class="line"><span class="params">      <span class="type">long</span> timestamp,</span></span><br><span class="line"><span class="params">      OnTimerContext ctx,</span></span><br><span class="line"><span class="params">      Collector&lt;Tuple2&lt;String, Long&gt;&gt; out)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Timeout interval exceeded. Cleaning up the state.</span></span><br><span class="line">    startTime.clear();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªä¾‹å­å……åˆ†å±•ç°äº† <code>KeyedProcessFunction</code> å¼ºå¤§çš„è¡¨è¾¾åŠ›ï¼Œä¹Ÿå› æ­¤æ˜¯ä¸€ä¸ªå®ç°ç›¸å½“å¤æ‚çš„æ¥å£ã€‚</p>
<h2 id="DataStream-API"><a href="#DataStream-API" class="headerlink" title="DataStream API"></a>DataStream API</h2><p><a target="_blank" rel="noopener" href="https://nightlies.apache.org/flink/flink-docs-stable/dev/datastream_api.html">DataStream API</a> ä¸ºè®¸å¤šé€šç”¨çš„æµå¤„ç†æ“ä½œæä¾›äº†å¤„ç†åŸè¯­ã€‚è¿™äº›æ“ä½œåŒ…æ‹¬çª—å£ã€é€æ¡è®°å½•çš„è½¬æ¢æ“ä½œï¼Œåœ¨å¤„ç†äº‹ä»¶æ—¶è¿›è¡Œå¤–éƒ¨æ•°æ®åº“æŸ¥è¯¢ç­‰ã€‚DataStream API æ”¯æŒ Java å’Œ Scala è¯­è¨€ï¼Œé¢„å…ˆå®šä¹‰äº†ä¾‹å¦‚<code>map()</code>ã€<code>reduce()</code>ã€<code>aggregate()</code> ç­‰å‡½æ•°ã€‚ä½ å¯ä»¥é€šè¿‡æ‰©å±•å®ç°é¢„å®šä¹‰æ¥å£æˆ–ä½¿ç”¨ Javaã€Scala çš„ lambda è¡¨è¾¾å¼å®ç°è‡ªå®šä¹‰çš„å‡½æ•°ã€‚</p>
<p>ä¸‹é¢çš„ä»£ç ç¤ºä¾‹å±•ç¤ºäº†å¦‚ä½•æ•è·ä¼šè¯æ—¶é—´èŒƒå›´å†…æ‰€æœ‰çš„ç‚¹å‡»æµäº‹ä»¶ï¼Œå¹¶å¯¹æ¯ä¸€æ¬¡ä¼šè¯çš„ç‚¹å‡»é‡è¿›è¡Œè®¡æ•°ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç½‘ç«™ç‚¹å‡» Click çš„æ•°æ®æµ</span></span><br><span class="line">DataStream&lt;Click&gt; clicks = ...</span><br><span class="line"></span><br><span class="line">DataStream&lt;Tuple2&lt;String, Long&gt;&gt; result = clicks</span><br><span class="line">  <span class="comment">// å°†ç½‘ç«™ç‚¹å‡»æ˜ å°„ä¸º (userId, 1) ä»¥ä¾¿è®¡æ•°</span></span><br><span class="line">  .map(</span><br><span class="line">    <span class="comment">// å®ç° MapFunction æ¥å£å®šä¹‰å‡½æ•°</span></span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">MapFunction</span>&lt;Click, Tuple2&lt;String, Long&gt;&gt;() &#123;</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="keyword">public</span> Tuple2&lt;String, Long&gt; <span class="title function_">map</span><span class="params">(Click click)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Tuple2.of(click.userId, <span class="number">1L</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  <span class="comment">// ä»¥ userId (field 0) ä½œä¸º key</span></span><br><span class="line">  .keyBy(<span class="number">0</span>)</span><br><span class="line">  <span class="comment">// å®šä¹‰ 30 åˆ†é’Ÿè¶…æ—¶çš„ä¼šè¯çª—å£</span></span><br><span class="line">  .window(EventTimeSessionWindows.withGap(Time.minutes(<span class="number">30L</span>)))</span><br><span class="line">  <span class="comment">// å¯¹æ¯ä¸ªä¼šè¯çª—å£çš„ç‚¹å‡»è¿›è¡Œè®¡æ•°ï¼Œä½¿ç”¨ lambda è¡¨è¾¾å¼å®šä¹‰ reduce å‡½æ•°</span></span><br><span class="line">  .reduce((a, b) -&gt; Tuple2.of(a.f0, a.f1 + b.f1));</span><br></pre></td></tr></table></figure>

<h2 id="SQL-Table-API"><a href="#SQL-Table-API" class="headerlink" title="SQL &amp; Table API"></a>SQL &amp; Table API</h2><p>Flink æ”¯æŒä¸¤ç§å…³ç³»å‹çš„ APIï¼Œ<a target="_blank" rel="noopener" href="https://nightlies.apache.org/flink/flink-docs-stable/dev/table/index.html">Table API å’Œ SQL</a>ã€‚è¿™ä¸¤ä¸ª API éƒ½æ˜¯æ‰¹å¤„ç†å’Œæµå¤„ç†ç»Ÿä¸€çš„ APIï¼Œè¿™æ„å‘³ç€åœ¨æ— è¾¹ç•Œçš„å®æ—¶æ•°æ®æµå’Œæœ‰è¾¹ç•Œçš„å†å²è®°å½•æ•°æ®æµä¸Šï¼Œå…³ç³»å‹ API ä¼šä»¥ç›¸åŒçš„è¯­ä¹‰æ‰§è¡ŒæŸ¥è¯¢ï¼Œå¹¶äº§ç”Ÿç›¸åŒçš„ç»“æœã€‚Table API å’Œ SQL å€ŸåŠ©äº† <a target="_blank" rel="noopener" href="https://calcite.apache.org/">Apache Calcite</a> æ¥è¿›è¡ŒæŸ¥è¯¢çš„è§£æï¼Œæ ¡éªŒä»¥åŠä¼˜åŒ–ã€‚å®ƒä»¬å¯ä»¥ä¸ DataStream å’Œ DataSet API æ— ç¼é›†æˆï¼Œå¹¶æ”¯æŒç”¨æˆ·è‡ªå®šä¹‰çš„æ ‡é‡å‡½æ•°ï¼Œèšåˆå‡½æ•°ä»¥åŠè¡¨å€¼å‡½æ•°ã€‚</p>
<p>Flink çš„å…³ç³»å‹ API æ—¨åœ¨ç®€åŒ–<a target="_blank" rel="noopener" href="https://flink.apache.org/zh/usecases.html#analytics">æ•°æ®åˆ†æ</a>ã€<a target="_blank" rel="noopener" href="https://flink.apache.org/zh/usecases.html#pipelines">æ•°æ®æµæ°´çº¿å’Œ ETL åº”ç”¨</a>çš„å®šä¹‰ã€‚</p>
<p>ä¸‹é¢çš„ä»£ç ç¤ºä¾‹å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨ SQL è¯­å¥æŸ¥è¯¢æ•è·ä¼šè¯æ—¶é—´èŒƒå›´å†…æ‰€æœ‰çš„ç‚¹å‡»æµäº‹ä»¶ï¼Œå¹¶å¯¹æ¯ä¸€æ¬¡ä¼šè¯çš„ç‚¹å‡»é‡è¿›è¡Œè®¡æ•°ã€‚æ­¤ç¤ºä¾‹ä¸ä¸Šè¿° DataStream API ä¸­çš„ç¤ºä¾‹æœ‰ç€ç›¸åŒçš„é€»è¾‘ã€‚</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> userId, <span class="built_in">COUNT</span>(<span class="operator">*</span>)</span><br><span class="line"><span class="keyword">FROM</span> clicks</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> SESSION(clicktime, <span class="type">INTERVAL</span> <span class="string">&#x27;30&#x27;</span> <span class="keyword">MINUTE</span>), userId</span><br></pre></td></tr></table></figure>

<h2 id="Flink-åº“"><a href="#Flink-åº“" class="headerlink" title="Flink åº“"></a>Flink åº“</h2><p>Flink å…·æœ‰æ•°ä¸ªé€‚ç”¨äºå¸¸è§æ•°æ®å¤„ç†åº”ç”¨åœºæ™¯çš„æ‰©å±•åº“ã€‚è¿™äº›åº“é€šå¸¸åµŒå…¥åœ¨ API ä¸­ï¼Œä¸”å¹¶ä¸å®Œå…¨ç‹¬ç«‹äºå…¶å®ƒ APIã€‚å®ƒä»¬ä¹Ÿå› æ­¤å¯ä»¥å—ç›Šäº API çš„æ‰€æœ‰ç‰¹æ€§ï¼Œå¹¶ä¸å…¶ä»–åº“é›†æˆã€‚</p>
<ul>
<li>**<a target="_blank" rel="noopener" href="https://nightlies.apache.org/flink/flink-docs-stable/dev/libs/cep.html">å¤æ‚äº‹ä»¶å¤„ç†(CEP)</a>**ï¼šæ¨¡å¼æ£€æµ‹æ˜¯äº‹ä»¶æµå¤„ç†ä¸­çš„ä¸€ä¸ªéå¸¸å¸¸è§çš„ç”¨ä¾‹ã€‚Flink çš„ CEP åº“æä¾›äº† APIï¼Œä½¿ç”¨æˆ·èƒ½å¤Ÿä»¥ä¾‹å¦‚æ­£åˆ™è¡¨è¾¾å¼æˆ–çŠ¶æ€æœºçš„æ–¹å¼æŒ‡å®šäº‹ä»¶æ¨¡å¼ã€‚CEP åº“ä¸ Flink çš„ DataStream API é›†æˆï¼Œä»¥ä¾¿åœ¨ DataStream ä¸Šè¯„ä¼°æ¨¡å¼ã€‚CEP åº“çš„åº”ç”¨åŒ…æ‹¬ç½‘ç»œå…¥ä¾µæ£€æµ‹ï¼Œä¸šåŠ¡æµç¨‹ç›‘æ§å’Œæ¬ºè¯ˆæ£€æµ‹ã€‚</li>
<li>**<a target="_blank" rel="noopener" href="https://nightlies.apache.org/flink/flink-docs-stable/dev/batch/index.html">DataSet API</a>*<em>ï¼šDataSet API æ˜¯ Flink ç”¨äºæ‰¹å¤„ç†åº”ç”¨ç¨‹åºçš„æ ¸å¿ƒ APIã€‚DataSet API æ‰€æä¾›çš„åŸºç¡€ç®—å­åŒ…æ‹¬</em>map<em>ã€<em>reduce_ã€</em>(outer) join_ã€_co-group_ã€</em>iterate*ç­‰ã€‚æ‰€æœ‰ç®—å­éƒ½æœ‰ç›¸åº”çš„ç®—æ³•å’Œæ•°æ®ç»“æ„æ”¯æŒï¼Œå¯¹å†…å­˜ä¸­çš„åºåˆ—åŒ–æ•°æ®è¿›è¡Œæ“ä½œã€‚å¦‚æœæ•°æ®å¤§å°è¶…è¿‡é¢„ç•™å†…å­˜ï¼Œåˆ™è¿‡é‡æ•°æ®å°†å­˜å‚¨åˆ°ç£ç›˜ã€‚Flink çš„ DataSet API çš„æ•°æ®å¤„ç†ç®—æ³•å€Ÿé‰´äº†ä¼ ç»Ÿæ•°æ®åº“ç®—æ³•çš„å®ç°ï¼Œä¾‹å¦‚æ··åˆæ•£åˆ—è¿æ¥ï¼ˆhybrid hash-joinï¼‰å’Œå¤–éƒ¨å½’å¹¶æ’åºï¼ˆexternal merge-sortï¼‰ã€‚</li>
<li><strong><a target="_blank" rel="noopener" href="https://nightlies.apache.org/flink/flink-docs-stable/dev/libs/gelly/index.html">Gelly</a></strong>: Gelly æ˜¯ä¸€ä¸ªå¯æ‰©å±•çš„å›¾å½¢å¤„ç†å’Œåˆ†æåº“ã€‚Gelly æ˜¯åœ¨ DataSet API ä¹‹ä¸Šå®ç°çš„ï¼Œå¹¶ä¸ DataSet API é›†æˆã€‚å› æ­¤ï¼Œå®ƒèƒ½å¤Ÿå—ç›Šäºå…¶å¯æ‰©å±•ä¸”å¥å£®çš„æ“ä½œç¬¦ã€‚Gelly æä¾›äº†<a target="_blank" rel="noopener" href="https://nightlies.apache.org/flink/flink-docs-stable/dev/libs/gelly/library_methods.html">å†…ç½®ç®—æ³•</a>ï¼Œå¦‚ label propagationã€triangle enumeration å’Œ page rank ç®—æ³•ï¼Œä¹Ÿæä¾›äº†ä¸€ä¸ªç®€åŒ–è‡ªå®šä¹‰å›¾ç®—æ³•å®ç°çš„ <a target="_blank" rel="noopener" href="https://nightlies.apache.org/flink/flink-docs-stable/dev/libs/gelly/graph_api.html">Graph API</a>ã€‚</li>
</ul>
<h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ul>
<li><a target="_blank" rel="noopener" href="https://nightlies.apache.org/flink/flink-docs-release-1.14/zh/">Flink å®˜æ–¹æ–‡æ¡£</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://dunwu.github.io/blog/pages/e16415d4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/uploads/avatar.gif">
      <meta itemprop="name" content="é’æ‚Ÿ â—¾ Dunwu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dunwu Blog">
      <meta itemprop="description" content="é’æ‚Ÿçš„ä¸ªäººåšå®¢">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Dunwu Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/pages/e16415d4/" class="post-title-link" itemprop="url">Flink ETL</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2022-02-17 22:28:55" itemprop="dateCreated datePublished" datetime="2022-02-17T22:28:55+08:00">2022-02-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">æ›´æ–°äº</span>
      <time title="ä¿®æ”¹æ—¶é—´ï¼š2025-09-13 17:56:53" itemprop="dateModified" datetime="2025-09-13T17:56:53+08:00">2025-09-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/" itemprop="url" rel="index"><span itemprop="name">å¤§æ•°æ®</span></a>
        </span>
          ï¼Œ
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/flink/" itemprop="url" rel="index"><span itemprop="name">flink</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
      <span>9.2k</span>
    </span>
    <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
      <span>8 åˆ†é’Ÿ</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Flink-ETL"><a href="#Flink-ETL" class="headerlink" title="Flink ETL"></a>Flink ETL</h1><p>Apache Flink çš„ä¸€ç§å¸¸è§åº”ç”¨åœºæ™¯æ˜¯ ETLï¼ˆæŠ½å–ã€è½¬æ¢ã€åŠ è½½ï¼‰ç®¡é“ä»»åŠ¡ã€‚ä»ä¸€ä¸ªæˆ–å¤šä¸ªæ•°æ®æºè·å–æ•°æ®ï¼Œè¿›è¡Œä¸€äº›è½¬æ¢æ“ä½œå’Œä¿¡æ¯è¡¥å……ï¼Œå°†ç»“æœå­˜å‚¨èµ·æ¥ã€‚åœ¨è¿™ä¸ªæ•™ç¨‹ä¸­ï¼Œæˆ‘ä»¬å°†ä»‹ç»å¦‚ä½•ä½¿ç”¨ Flink çš„ DataStream API å®ç°è¿™ç±»åº”ç”¨ã€‚</p>
<p>è¿™é‡Œæ³¨æ„ï¼ŒFlink çš„ <a target="_blank" rel="noopener" href="https://nightlies.apache.org/flink/flink-docs-release-1.14/zh/docs/dev/table/overview/">Table å’Œ SQL API</a> å®Œå…¨å¯ä»¥æ»¡è¶³å¾ˆå¤š ETL ä½¿ç”¨åœºæ™¯ã€‚ä½†æ— è®ºä½ æœ€ç»ˆæ˜¯å¦ç›´æ¥ä½¿ç”¨ DataStream APIï¼Œå¯¹è¿™é‡Œä»‹ç»çš„åŸºæœ¬çŸ¥è¯†æœ‰æ‰å®çš„ç†è§£éƒ½æ˜¯æœ‰ä»·å€¼çš„ã€‚</p>
<h2 id="æ— çŠ¶æ€çš„è½¬æ¢"><a href="#æ— çŠ¶æ€çš„è½¬æ¢" class="headerlink" title="æ— çŠ¶æ€çš„è½¬æ¢"></a>æ— çŠ¶æ€çš„è½¬æ¢</h2><p>æœ¬èŠ‚æ¶µç›–äº† <code>map()</code> å’Œ <code>flatmap()</code>ï¼Œè¿™ä¸¤ç§ç®—å­å¯ä»¥ç”¨æ¥å®ç°æ— çŠ¶æ€è½¬æ¢çš„åŸºæœ¬æ“ä½œã€‚</p>
<h3 id="map"><a href="#map" class="headerlink" title="map()"></a><code>map()</code></h3><p>åœ¨ç¬¬ä¸€ä¸ªç»ƒä¹ ä¸­ï¼Œä½ å°†è¿‡æ»¤å‡ºç§Ÿè½¦è¡Œç¨‹æ•°æ®ä¸­çš„äº‹ä»¶ã€‚åœ¨åŒä¸€ä»£ç ä»“åº“ä¸­ï¼Œæœ‰ä¸€ä¸ª <code>GeoUtils</code> ç±»ï¼Œæä¾›äº†ä¸€ä¸ªé™æ€æ–¹æ³• <code>GeoUtils.mapToGridCell(float lon, float lat)</code>ï¼Œå®ƒå¯ä»¥å°†ä½ç½®åæ ‡ï¼ˆç»åº¦ï¼Œç»´åº¦ï¼‰æ˜ å°„åˆ° 100x100 ç±³çš„å¯¹åº”ä¸åŒåŒºåŸŸçš„ç½‘æ ¼å•å…ƒã€‚</p>
<p>ç°åœ¨è®©æˆ‘ä»¬ä¸ºæ¯ä¸ªå‡ºç§Ÿè½¦è¡Œç¨‹æ—¶é—´çš„æ•°æ®å¯¹è±¡å¢åŠ  <code>startCell</code> å’Œ <code>endCell</code> å­—æ®µã€‚ä½ å¯ä»¥åˆ›å»ºä¸€ä¸ªç»§æ‰¿ <code>TaxiRide</code> çš„ <code>EnrichedRide</code> ç±»ï¼Œæ·»åŠ è¿™äº›å­—æ®µï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">EnrichedRide</span> <span class="keyword">extends</span> <span class="title class_">TaxiRide</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> startCell;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> endCell;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">EnrichedRide</span><span class="params">()</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">EnrichedRide</span><span class="params">(TaxiRide ride)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.rideId = ride.rideId;</span><br><span class="line">        <span class="built_in">this</span>.isStart = ride.isStart;</span><br><span class="line">        ...</span><br><span class="line">        <span class="built_in">this</span>.startCell = GeoUtils.mapToGridCell(ride.startLon, ride.startLat);</span><br><span class="line">        <span class="built_in">this</span>.endCell = GeoUtils.mapToGridCell(ride.endLon, ride.endLat);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.toString() + <span class="string">&quot;,&quot;</span> +</span><br><span class="line">            Integer.toString(<span class="built_in">this</span>.startCell) + <span class="string">&quot;,&quot;</span> +</span><br><span class="line">            Integer.toString(<span class="built_in">this</span>.endCell);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç„¶åä½ å¯ä»¥åˆ›å»ºä¸€ä¸ªåº”ç”¨æ¥è½¬æ¢è¿™ä¸ªæµ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">DataStream&lt;TaxiRide&gt; rides = env.addSource(<span class="keyword">new</span> <span class="title class_">TaxiRideSource</span>(...));</span><br><span class="line"></span><br><span class="line">DataStream&lt;EnrichedRide&gt; enrichedNYCRides = rides</span><br><span class="line">    .filter(<span class="keyword">new</span> <span class="title class_">RideCleansingSolution</span>.NYCFilter())</span><br><span class="line">    .map(<span class="keyword">new</span> <span class="title class_">Enrichment</span>());</span><br><span class="line"></span><br><span class="line">enrichedNYCRides.print();</span><br></pre></td></tr></table></figure>

<p>ä½¿ç”¨è¿™ä¸ª <code>MapFunction</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Enrichment</span> <span class="keyword">implements</span> <span class="title class_">MapFunction</span>&lt;TaxiRide, EnrichedRide&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> EnrichedRide <span class="title function_">map</span><span class="params">(TaxiRide taxiRide)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">EnrichedRide</span>(taxiRide);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="flatmap"><a href="#flatmap" class="headerlink" title="flatmap()"></a><code>flatmap()</code></h3><p><code>MapFunction</code> åªé€‚ç”¨äºä¸€å¯¹ä¸€çš„è½¬æ¢ï¼šå¯¹æ¯ä¸ªè¿›å…¥ç®—å­çš„æµå…ƒç´ ï¼Œ<code>map()</code> å°†ä»…è¾“å‡ºä¸€ä¸ªè½¬æ¢åçš„å…ƒç´ ã€‚å¯¹äºé™¤æ­¤ä»¥å¤–çš„åœºæ™¯ï¼Œä½ å°†è¦ä½¿ç”¨ <code>flatmap()</code>ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">DataStream&lt;TaxiRide&gt; rides = env.addSource(<span class="keyword">new</span> <span class="title class_">TaxiRideSource</span>(...));</span><br><span class="line"></span><br><span class="line">DataStream&lt;EnrichedRide&gt; enrichedNYCRides = rides</span><br><span class="line">    .flatMap(<span class="keyword">new</span> <span class="title class_">NYCEnrichment</span>());</span><br><span class="line"></span><br><span class="line">enrichedNYCRides.print();</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­ç”¨åˆ°çš„ <code>FlatMapFunction</code> :</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">NYCEnrichment</span> <span class="keyword">implements</span> <span class="title class_">FlatMapFunction</span>&lt;TaxiRide, EnrichedRide&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">flatMap</span><span class="params">(TaxiRide taxiRide, Collector&lt;EnrichedRide&gt; out)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        FilterFunction&lt;TaxiRide&gt; valid = <span class="keyword">new</span> <span class="title class_">RideCleansing</span>.NYCFilter();</span><br><span class="line">        <span class="keyword">if</span> (valid.filter(taxiRide)) &#123;</span><br><span class="line">            out.collect(<span class="keyword">new</span> <span class="title class_">EnrichedRide</span>(taxiRide));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä½¿ç”¨æ¥å£ä¸­æä¾›çš„ <code>Collector</code> ï¼Œ<code>flatmap()</code> å¯ä»¥è¾“å‡ºä½ æƒ³è¦çš„ä»»æ„æ•°é‡çš„å…ƒç´ ï¼Œä¹Ÿå¯ä»¥ä¸€ä¸ªéƒ½ä¸å‘ã€‚</p>
<h2 id="Keyed-Streams"><a href="#Keyed-Streams" class="headerlink" title="Keyed Streams"></a>Keyed Streams</h2><h3 id="keyBy"><a href="#keyBy" class="headerlink" title="keyBy()"></a><code>keyBy()</code></h3><p>å°†ä¸€ä¸ªæµæ ¹æ®å…¶ä¸­çš„ä¸€äº›å±æ€§æ¥è¿›è¡Œåˆ†åŒºæ˜¯ååˆ†æœ‰ç”¨çš„ï¼Œè¿™æ ·æˆ‘ä»¬å¯ä»¥ä½¿æ‰€æœ‰å…·æœ‰ç›¸åŒå±æ€§çš„äº‹ä»¶åˆ†åˆ°ç›¸åŒçš„ç»„é‡Œã€‚ä¾‹å¦‚ï¼Œå¦‚æœä½ æƒ³æ‰¾åˆ°ä»æ¯ä¸ªç½‘æ ¼å•å…ƒå‡ºå‘çš„æœ€è¿œçš„å‡ºç§Ÿè½¦è¡Œç¨‹ã€‚æŒ‰ SQL æŸ¥è¯¢çš„æ–¹å¼æ¥è€ƒè™‘ï¼Œè¿™æ„å‘³ç€è¦å¯¹ <code>startCell</code> è¿›è¡Œ GROUP BY å†æ’åºï¼Œåœ¨ Flink ä¸­è¿™éƒ¨åˆ†å¯ä»¥ç”¨ <code>keyBy(KeySelector)</code> å®ç°ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rides</span><br><span class="line">    .flatMap(<span class="keyword">new</span> <span class="title class_">NYCEnrichment</span>())</span><br><span class="line">    .keyBy(enrichedRide -&gt; enrichedRide.startCell)</span><br></pre></td></tr></table></figure>

<p>æ¯ä¸ª <code>keyBy</code> ä¼šé€šè¿‡ shuffle æ¥ä¸ºæ•°æ®æµè¿›è¡Œé‡æ–°åˆ†åŒºã€‚æ€»ä½“æ¥è¯´è¿™ä¸ªå¼€é”€æ˜¯å¾ˆå¤§çš„ï¼Œå®ƒæ¶‰åŠç½‘ç»œé€šä¿¡ã€åºåˆ—åŒ–å’Œååºåˆ—åŒ–ã€‚</p>
<p><img src="https://nightlies.apache.org/flink/flink-docs-release-1.14/fig/keyBy.png" alt="keyBy and network shuffle"></p>
<h3 id="é€šè¿‡è®¡ç®—å¾—åˆ°é”®"><a href="#é€šè¿‡è®¡ç®—å¾—åˆ°é”®" class="headerlink" title="é€šè¿‡è®¡ç®—å¾—åˆ°é”®"></a>é€šè¿‡è®¡ç®—å¾—åˆ°é”®</h3><p>KeySelector ä¸ä»…é™äºä»äº‹ä»¶ä¸­æŠ½å–é”®ã€‚ä½ ä¹Ÿå¯ä»¥æŒ‰æƒ³è¦çš„æ–¹å¼è®¡ç®—å¾—åˆ°é”®å€¼ï¼Œåªè¦æœ€ç»ˆç»“æœæ˜¯ç¡®å®šçš„ï¼Œå¹¶ä¸”å®ç°äº† <code>hashCode()</code> å’Œ <code>equals()</code>ã€‚è¿™äº›é™åˆ¶æ¡ä»¶ä¸åŒ…æ‹¬äº§ç”Ÿéšæœºæ•°æˆ–è€…è¿”å› Arrays æˆ– Enums çš„ KeySelectorï¼Œä½†ä½ å¯ä»¥ç”¨å…ƒç»„å’Œ POJO æ¥ç»„æˆé”®ï¼Œåªè¦ä»–ä»¬çš„å…ƒç´ éµå¾ªä¸Šè¿°æ¡ä»¶ã€‚</p>
<p>é”®å¿…é¡»æŒ‰ç¡®å®šçš„æ–¹å¼äº§ç”Ÿï¼Œå› ä¸ºå®ƒä»¬ä¼šåœ¨éœ€è¦çš„æ—¶å€™è¢«é‡æ–°è®¡ç®—ï¼Œè€Œä¸æ˜¯ä¸€ç›´è¢«å¸¦åœ¨æµè®°å½•ä¸­ã€‚</p>
<p>ä¾‹å¦‚ï¼Œæ¯”èµ·åˆ›å»ºä¸€ä¸ªæ–°çš„å¸¦æœ‰ <code>startCell</code> å­—æ®µçš„ <code>EnrichedRide</code> ç±»ï¼Œç”¨è¿™ä¸ªå­—æ®µä½œä¸º keyï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">keyBy(enrichedRide -&gt; enrichedRide.startCell)</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬æ›´å€¾å‘äºè¿™æ ·åšï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">keyBy(ride -&gt; GeoUtils.mapToGridCell(ride.startLon, ride.startLat))</span><br></pre></td></tr></table></figure>

<h3 id="Keyed-Stream-çš„èšåˆ"><a href="#Keyed-Stream-çš„èšåˆ" class="headerlink" title="Keyed Stream çš„èšåˆ"></a>Keyed Stream çš„èšåˆ</h3><p>ä»¥ä¸‹ä»£ç ä¸ºæ¯ä¸ªè¡Œç¨‹ç»“æŸäº‹ä»¶åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„åŒ…å« <code>startCell</code> å’Œæ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰çš„å…ƒç»„æµï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.joda.time.Interval;</span><br><span class="line"></span><br><span class="line">DataStream&lt;Tuple2&lt;Integer, Minutes&gt;&gt; minutesByStartCell = enrichedNYCRides</span><br><span class="line">    .flatMap(<span class="keyword">new</span> <span class="title class_">FlatMapFunction</span>&lt;EnrichedRide, Tuple2&lt;Integer, Minutes&gt;&gt;() &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">flatMap</span><span class="params">(EnrichedRide ride,</span></span><br><span class="line"><span class="params">                            Collector&lt;Tuple2&lt;Integer, Minutes&gt;&gt; out)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            <span class="keyword">if</span> (!ride.isStart) &#123;</span><br><span class="line">                <span class="type">Interval</span> <span class="variable">rideInterval</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Interval</span>(ride.startTime, ride.endTime);</span><br><span class="line">                <span class="type">Minutes</span> <span class="variable">duration</span> <span class="operator">=</span> rideInterval.toDuration().toStandardMinutes();</span><br><span class="line">                out.collect(<span class="keyword">new</span> <span class="title class_">Tuple2</span>&lt;&gt;(ride.startCell, duration));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>

<p>ç°åœ¨å°±å¯ä»¥äº§ç”Ÿä¸€ä¸ªæµï¼Œå¯¹æ¯ä¸ª <code>startCell</code> ä»…åŒ…å«é‚£äº›æœ€é•¿è¡Œç¨‹çš„æ•°æ®ã€‚</p>
<p>æœ‰å¾ˆå¤šç§æ–¹æ³•è¡¨ç¤ºä½¿ç”¨å“ªä¸ªå­—æ®µä½œä¸ºé”®ã€‚å‰é¢ä½¿ç”¨ <code>EnrichedRide</code> POJO çš„ä¾‹å­ï¼Œç”¨å­—æ®µåæ¥æŒ‡å®šé”®ã€‚è€Œè¿™ä¸ªä½¿ç”¨ <code>Tuple2</code> å¯¹è±¡çš„ä¾‹å­ä¸­ï¼Œç”¨å­—æ®µåœ¨å…ƒç»„ä¸­çš„åºå·ï¼ˆä» 0 å¼€å§‹ï¼‰æ¥æŒ‡å®šé”®ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">minutesByStartCell</span><br><span class="line">  .keyBy(value -&gt; value.f0) <span class="comment">// .keyBy(value -&gt; value.startCell)</span></span><br><span class="line">  .maxBy(<span class="number">1</span>) <span class="comment">// duration</span></span><br><span class="line">  .print();</span><br></pre></td></tr></table></figure>

<p>ç°åœ¨æ¯æ¬¡è¡Œç¨‹æ—¶é•¿è¾¾åˆ°æ–°çš„æœ€å¤§å€¼ï¼Œéƒ½ä¼šè¾“å‡ºä¸€æ¡æ–°è®°å½•ï¼Œä¾‹å¦‚ä¸‹é¢è¿™ä¸ªå¯¹åº” 50797 ç½‘æ ¼å•å…ƒçš„æ•°æ®ï¼š</p>
<figure class="highlight erlang-repl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="meta prompt_">4&gt; </span>(<span class="number">64549</span>,<span class="number">5</span>M)</span><br><span class="line"><span class="meta prompt_">4&gt; </span>(<span class="number">46298</span>,<span class="number">18</span>M)</span><br><span class="line"><span class="meta prompt_">1&gt; </span>(<span class="number">51549</span>,<span class="number">14</span>M)</span><br><span class="line"><span class="meta prompt_">1&gt; </span>(<span class="number">53043</span>,<span class="number">13</span>M)</span><br><span class="line"><span class="meta prompt_">1&gt; </span>(<span class="number">56031</span>,<span class="number">22</span>M)</span><br><span class="line"><span class="meta prompt_">1&gt; </span>(<span class="number">50797</span>,<span class="number">6</span>M)</span><br><span class="line">...</span><br><span class="line"><span class="meta prompt_">1&gt; </span>(<span class="number">50797</span>,<span class="number">8</span>M)</span><br><span class="line">...</span><br><span class="line"><span class="meta prompt_">1&gt; </span>(<span class="number">50797</span>,<span class="number">11</span>M)</span><br><span class="line">...</span><br><span class="line"><span class="meta prompt_">1&gt; </span>(<span class="number">50797</span>,<span class="number">12</span>M)</span><br></pre></td></tr></table></figure>

<h3 id="ï¼ˆéšå¼çš„ï¼‰çŠ¶æ€"><a href="#ï¼ˆéšå¼çš„ï¼‰çŠ¶æ€" class="headerlink" title="ï¼ˆéšå¼çš„ï¼‰çŠ¶æ€"></a>ï¼ˆéšå¼çš„ï¼‰çŠ¶æ€</h3><p>è¿™æ˜¯åŸ¹è®­ä¸­ç¬¬ä¸€ä¸ªæ¶‰åŠåˆ°æœ‰çŠ¶æ€æµçš„ä¾‹å­ã€‚å°½ç®¡çŠ¶æ€çš„å¤„ç†æ˜¯é€æ˜çš„ï¼ŒFlink å¿…é¡»è·Ÿè¸ªæ¯ä¸ªä¸åŒçš„é”®çš„æœ€å¤§æ—¶é•¿ã€‚</p>
<p>åªè¦åº”ç”¨ä¸­æœ‰çŠ¶æ€ï¼Œä½ å°±åº”è¯¥è€ƒè™‘çŠ¶æ€çš„å¤§å°ã€‚å¦‚æœé”®å€¼çš„æ•°é‡æ˜¯æ— é™çš„ï¼Œé‚£ Flink çš„çŠ¶æ€éœ€è¦çš„ç©ºé—´ä¹ŸåŒæ ·æ˜¯æ— é™çš„ã€‚</p>
<p>åœ¨æµå¤„ç†åœºæ™¯ä¸­ï¼Œè€ƒè™‘æœ‰é™çª—å£çš„èšåˆå¾€å¾€æ¯”æ•´ä¸ªæµèšåˆæ›´æœ‰æ„ä¹‰ã€‚</p>
<h3 id="reduce-å’Œå…¶ä»–èšåˆç®—å­"><a href="#reduce-å’Œå…¶ä»–èšåˆç®—å­" class="headerlink" title="reduce() å’Œå…¶ä»–èšåˆç®—å­"></a><code>reduce()</code> å’Œå…¶ä»–èšåˆç®—å­</h3><p>ä¸Šé¢ç”¨åˆ°çš„ <code>maxBy()</code> åªæ˜¯ Flink ä¸­ <code>KeyedStream</code> ä¸Šä¼—å¤šèšåˆå‡½æ•°ä¸­çš„ä¸€ä¸ªã€‚è¿˜æœ‰ä¸€ä¸ªæ›´é€šç”¨çš„ <code>reduce()</code> å‡½æ•°å¯ä»¥ç”¨æ¥å®ç°ä½ çš„è‡ªå®šä¹‰èšåˆã€‚</p>
<h2 id="æœ‰çŠ¶æ€çš„è½¬æ¢"><a href="#æœ‰çŠ¶æ€çš„è½¬æ¢" class="headerlink" title="æœ‰çŠ¶æ€çš„è½¬æ¢"></a>æœ‰çŠ¶æ€çš„è½¬æ¢</h2><h3 id="Flink-ä¸ºä»€ä¹ˆè¦å‚ä¸çŠ¶æ€ç®¡ç†ï¼Ÿ"><a href="#Flink-ä¸ºä»€ä¹ˆè¦å‚ä¸çŠ¶æ€ç®¡ç†ï¼Ÿ" class="headerlink" title="Flink ä¸ºä»€ä¹ˆè¦å‚ä¸çŠ¶æ€ç®¡ç†ï¼Ÿ"></a>Flink ä¸ºä»€ä¹ˆè¦å‚ä¸çŠ¶æ€ç®¡ç†ï¼Ÿ</h3><p>åœ¨ Flink ä¸å‚ä¸ç®¡ç†çŠ¶æ€çš„æƒ…å†µä¸‹ï¼Œä½ çš„åº”ç”¨ä¹Ÿå¯ä»¥ä½¿ç”¨çŠ¶æ€ï¼Œä½† Flink ä¸ºå…¶ç®¡ç†çŠ¶æ€æä¾›äº†ä¸€äº›å¼•äººæ³¨ç›®çš„ç‰¹æ€§ï¼š</p>
<ul>
<li><strong>æœ¬åœ°æ€§</strong>: Flink çŠ¶æ€æ˜¯å­˜å‚¨åœ¨ä½¿ç”¨å®ƒçš„æœºå™¨æœ¬åœ°çš„ï¼Œå¹¶ä¸”å¯ä»¥ä»¥å†…å­˜è®¿é—®é€Ÿåº¦æ¥è·å–</li>
<li><strong>æŒä¹…æ€§</strong>: Flink çŠ¶æ€æ˜¯å®¹é”™çš„ï¼Œä¾‹å¦‚ï¼Œå®ƒå¯ä»¥è‡ªåŠ¨æŒ‰ä¸€å®šçš„æ—¶é—´é—´éš”äº§ç”Ÿ checkpointï¼Œå¹¶ä¸”åœ¨ä»»åŠ¡å¤±è´¥åè¿›è¡Œæ¢å¤</li>
<li><strong>çºµå‘å¯æ‰©å±•æ€§</strong>: Flink çŠ¶æ€å¯ä»¥å­˜å‚¨åœ¨é›†æˆçš„ RocksDB å®ä¾‹ä¸­ï¼Œè¿™ç§æ–¹å¼ä¸‹å¯ä»¥é€šè¿‡å¢åŠ æœ¬åœ°ç£ç›˜æ¥æ‰©å±•ç©ºé—´</li>
<li><strong>æ¨ªå‘å¯æ‰©å±•æ€§</strong>: Flink çŠ¶æ€å¯ä»¥éšç€é›†ç¾¤çš„æ‰©ç¼©å®¹é‡æ–°åˆ†å¸ƒ</li>
<li><strong>å¯æŸ¥è¯¢æ€§</strong>: Flink çŠ¶æ€å¯ä»¥é€šè¿‡ä½¿ç”¨ <a target="_blank" rel="noopener" href="https://nightlies.apache.org/flink/flink-docs-release-1.14/zh/docs/dev/datastream/fault-tolerance/queryable_state/">çŠ¶æ€æŸ¥è¯¢ API</a> ä»å¤–éƒ¨è¿›è¡ŒæŸ¥è¯¢ã€‚</li>
</ul>
<p>åœ¨æœ¬èŠ‚ä¸­ä½ å°†å­¦ä¹ å¦‚ä½•ä½¿ç”¨ Flink çš„ API æ¥ç®¡ç† keyed stateã€‚</p>
<h3 id="Rich-Functions"><a href="#Rich-Functions" class="headerlink" title="Rich Functions"></a>Rich Functions</h3><p>è‡³æ­¤ï¼Œä½ å·²ç»çœ‹åˆ°äº† Flink çš„å‡ ç§å‡½æ•°æ¥å£ï¼ŒåŒ…æ‹¬ <code>FilterFunction</code>ï¼Œ <code>MapFunction</code>ï¼Œå’Œ <code>FlatMapFunction</code>ã€‚è¿™äº›éƒ½æ˜¯å•ä¸€æŠ½è±¡æ–¹æ³•æ¨¡å¼ã€‚</p>
<p>å¯¹å…¶ä¸­çš„æ¯ä¸€ä¸ªæ¥å£ï¼ŒFlink åŒæ ·æä¾›äº†ä¸€ä¸ªæ‰€è°“ â€œrichâ€ çš„å˜ä½“ï¼Œå¦‚ <code>RichFlatMapFunction</code>ï¼Œå…¶ä¸­å¢åŠ äº†ä»¥ä¸‹æ–¹æ³•ï¼ŒåŒ…æ‹¬ï¼š</p>
<ul>
<li><code>open(Configuration c)</code></li>
<li><code>close()</code></li>
<li><code>getRuntimeContext()</code></li>
</ul>
<p><code>open()</code> ä»…åœ¨ç®—å­åˆå§‹åŒ–æ—¶è°ƒç”¨ä¸€æ¬¡ã€‚å¯ä»¥ç”¨æ¥åŠ è½½ä¸€äº›é™æ€æ•°æ®ï¼Œæˆ–è€…å»ºç«‹å¤–éƒ¨æœåŠ¡çš„é“¾æ¥ç­‰ã€‚</p>
<p><code>getRuntimeContext()</code> ä¸ºæ•´å¥—æ½œåœ¨æœ‰è¶£çš„ä¸œè¥¿æä¾›äº†ä¸€ä¸ªè®¿é—®é€”å¾„ï¼Œæœ€æ˜æ˜¾çš„ï¼Œå®ƒæ˜¯ä½ åˆ›å»ºå’Œè®¿é—® Flink çŠ¶æ€çš„é€”å¾„ã€‚</p>
<h3 id="ä¸€ä¸ªä½¿ç”¨-Keyed-State-çš„ä¾‹å­"><a href="#ä¸€ä¸ªä½¿ç”¨-Keyed-State-çš„ä¾‹å­" class="headerlink" title="ä¸€ä¸ªä½¿ç”¨ Keyed State çš„ä¾‹å­"></a>ä¸€ä¸ªä½¿ç”¨ Keyed State çš„ä¾‹å­</h3><p>åœ¨è¿™ä¸ªä¾‹å­é‡Œï¼Œæƒ³è±¡ä½ æœ‰ä¸€ä¸ªè¦å»é‡çš„äº‹ä»¶æ•°æ®æµï¼Œå¯¹æ¯ä¸ªé”®åªä¿ç•™ç¬¬ä¸€ä¸ªäº‹ä»¶ã€‚ä¸‹é¢æ˜¯å®Œæˆè¿™ä¸ªåŠŸèƒ½çš„åº”ç”¨ï¼Œä½¿ç”¨ä¸€ä¸ªåä¸º <code>Deduplicator</code> çš„ <code>RichFlatMapFunction</code> ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Event</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> String key;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">long</span> timestamp;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">StreamExecutionEnvironment</span> <span class="variable">env</span> <span class="operator">=</span> StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line"></span><br><span class="line">    env.addSource(<span class="keyword">new</span> <span class="title class_">EventSource</span>())</span><br><span class="line">        .keyBy(e -&gt; e.key)</span><br><span class="line">        .flatMap(<span class="keyword">new</span> <span class="title class_">Deduplicator</span>())</span><br><span class="line">        .print();</span><br><span class="line"></span><br><span class="line">    env.execute();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸ºäº†å®ç°è¿™ä¸ªåŠŸèƒ½ï¼Œ<code>Deduplicator</code> éœ€è¦è®°å½•æ¯ä¸ªé”®æ˜¯å¦å·²ç»æœ‰äº†ç›¸åº”çš„è®°å½•ã€‚å®ƒå°†é€šè¿‡ä½¿ç”¨ Flink çš„ <em>keyed state</em> æ¥å£æ¥åšè¿™ä»¶äº‹ã€‚</p>
<p>å½“ä½ ä½¿ç”¨åƒè¿™æ ·çš„ keyed stream çš„æ—¶å€™ï¼ŒFlink ä¼šä¸ºæ¯ä¸ªçŠ¶æ€ä¸­ç®¡ç†çš„æ¡ç›®ç»´æŠ¤ä¸€ä¸ªé”®å€¼å­˜å‚¨ã€‚</p>
<p>Flink æ”¯æŒå‡ ç§ä¸åŒæ–¹å¼çš„ keyed stateï¼Œè¿™ä¸ªä¾‹å­ä½¿ç”¨çš„æ˜¯æœ€ç®€å•çš„ä¸€ä¸ªï¼Œå«åš <code>ValueState</code>ã€‚æ„æ€æ˜¯å¯¹äº <em>æ¯ä¸ªé”®</em> ï¼ŒFlink å°†å­˜å‚¨ä¸€ä¸ªå•ä¸€çš„å¯¹è±¡ â€”â€” åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œå­˜å‚¨çš„æ˜¯ä¸€ä¸ª <code>Boolean</code> ç±»å‹çš„å¯¹è±¡ã€‚</p>
<p>æˆ‘ä»¬çš„ <code>Deduplicator</code> ç±»æœ‰ä¸¤ä¸ªæ–¹æ³•ï¼š<code>open()</code> å’Œ <code>flatMap()</code>ã€‚<code>open()</code> æ–¹æ³•é€šè¿‡å®šä¹‰ <code>ValueStateDescriptor&lt;Boolean&gt;</code> å»ºç«‹äº†ç®¡ç†çŠ¶æ€çš„ä½¿ç”¨ã€‚æ„é€ å™¨çš„å‚æ•°å®šä¹‰äº†è¿™ä¸ªçŠ¶æ€çš„åå­—ï¼ˆâ€œkeyHasBeenSeenâ€ï¼‰ï¼Œå¹¶ä¸”ä¸ºå¦‚ä½•åºåˆ—åŒ–è¿™äº›å¯¹è±¡æä¾›äº†ä¿¡æ¯ï¼ˆåœ¨è¿™ä¸ªä¾‹å­ä¸­çš„ <code>Types.BOOLEAN</code>ï¼‰ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Deduplicator</span> <span class="keyword">extends</span> <span class="title class_">RichFlatMapFunction</span>&lt;Event, Event&gt; &#123;</span><br><span class="line">    ValueState&lt;Boolean&gt; keyHasBeenSeen;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">open</span><span class="params">(Configuration conf)</span> &#123;</span><br><span class="line">        ValueStateDescriptor&lt;Boolean&gt; desc = <span class="keyword">new</span> <span class="title class_">ValueStateDescriptor</span>&lt;&gt;(<span class="string">&quot;keyHasBeenSeen&quot;</span>, Types.BOOLEAN);</span><br><span class="line">        keyHasBeenSeen = getRuntimeContext().getState(desc);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">flatMap</span><span class="params">(Event event, Collector&lt;Event&gt; out)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">if</span> (keyHasBeenSeen.value() == <span class="literal">null</span>) &#123;</span><br><span class="line">            out.collect(event);</span><br><span class="line">            keyHasBeenSeen.update(<span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å½“ flatMap æ–¹æ³•è°ƒç”¨ <code>keyHasBeenSeen.value()</code> æ—¶ï¼ŒFlink ä¼šåœ¨ <em>å½“å‰é”®çš„ä¸Šä¸‹æ–‡</em> ä¸­æ£€ç´¢çŠ¶æ€å€¼ï¼Œåªæœ‰å½“çŠ¶æ€ä¸º <code>null</code> æ—¶ï¼Œæ‰ä¼šè¾“å‡ºå½“å‰äº‹ä»¶ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œå®ƒåŒæ—¶ä¹Ÿå°†æ›´æ–° <code>keyHasBeenSeen</code> ä¸º <code>true</code>ã€‚</p>
<p>è¿™ç§è®¿é—®å’Œæ›´æ–°æŒ‰é”®åˆ†åŒºçš„çŠ¶æ€çš„æœºåˆ¶ä¹Ÿè®¸çœ‹ä¸Šå»å¾ˆç¥å¥‡ï¼Œå› ä¸ºåœ¨ <code>Deduplicator</code> çš„å®ç°ä¸­ï¼Œé”®ä¸æ˜¯æ˜ç¡®å¯è§çš„ã€‚å½“ Flink è¿è¡Œæ—¶è°ƒç”¨ <code>RichFlatMapFunction</code> çš„ <code>open</code> æ–¹æ³•æ—¶ï¼Œ æ˜¯æ²¡æœ‰äº‹ä»¶çš„ï¼Œæ‰€ä»¥è¿™ä¸ªæ—¶å€™ä¸Šä¸‹æ–‡ä¸­ä¸å«æœ‰ä»»ä½•é”®ã€‚ä½†å½“å®ƒè°ƒç”¨ <code>flatMap</code> æ–¹æ³•ï¼Œè¢«å¤„ç†çš„äº‹ä»¶çš„é”®åœ¨è¿è¡Œæ—¶ä¸­å°±æ˜¯å¯ç”¨çš„äº†ï¼Œå¹¶ä¸”è¢«ç”¨æ¥ç¡®å®šæ“ä½œå“ªä¸ª Flink çŠ¶æ€åç«¯çš„å…¥å£ã€‚</p>
<p>éƒ¨ç½²åœ¨åˆ†å¸ƒå¼é›†ç¾¤æ—¶ï¼Œå°†ä¼šæœ‰å¾ˆå¤š <code>Deduplicator</code> çš„å®ä¾‹ï¼Œæ¯ä¸€ä¸ªå®ä¾‹å°†è´Ÿè´£æ•´ä¸ªé”®ç©ºé—´çš„äº’æ–¥å­é›†ä¸­çš„ä¸€ä¸ªã€‚æ‰€ä»¥ï¼Œå½“ä½ çœ‹åˆ°ä¸€ä¸ªå•ç‹¬çš„ <code>ValueState</code>ï¼Œæ¯”å¦‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ValueState&lt;Boolean&gt; keyHasBeenSeen;</span><br></pre></td></tr></table></figure>

<p>è¦ç†è§£è¿™ä¸ªä»£è¡¨çš„ä¸ä»…ä»…æ˜¯ä¸€ä¸ªå•ç‹¬çš„å¸ƒå°”ç±»å‹å˜é‡ï¼Œè€Œæ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼çš„å…±äº«é”®å€¼å­˜å‚¨ã€‚</p>
<h3 id="æ¸…ç†çŠ¶æ€"><a href="#æ¸…ç†çŠ¶æ€" class="headerlink" title="æ¸…ç†çŠ¶æ€"></a>æ¸…ç†çŠ¶æ€</h3><p>ä¸Šé¢ä¾‹å­æœ‰ä¸€ä¸ªæ½œåœ¨çš„é—®é¢˜ï¼šå½“é”®ç©ºé—´æ˜¯æ— ç•Œçš„æ—¶å€™å°†å‘ç”Ÿä»€ä¹ˆï¼ŸFlink ä¼šå¯¹æ¯ä¸ªä½¿ç”¨è¿‡çš„é”®éƒ½å­˜å‚¨ä¸€ä¸ª <code>Boolean</code> ç±»å‹çš„å®ä¾‹ã€‚å¦‚æœæ˜¯é”®æ˜¯æœ‰é™çš„é›†åˆè¿˜å¥½ï¼Œä½†åœ¨é”®æ— é™å¢é•¿çš„åº”ç”¨ä¸­ï¼Œæ¸…é™¤å†ä¹Ÿä¸ä¼šä½¿ç”¨çš„çŠ¶æ€æ˜¯å¾ˆå¿…è¦çš„ã€‚è¿™é€šè¿‡åœ¨çŠ¶æ€å¯¹è±¡ä¸Šè°ƒç”¨ <code>clear()</code> æ¥å®ç°ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">keyHasBeenSeen.clear()</span><br></pre></td></tr></table></figure>

<p>å¯¹ä¸€ä¸ªç»™å®šçš„é”®å€¼ï¼Œä½ ä¹Ÿè®¸æƒ³åœ¨å®ƒä¸€æ®µæ—¶é—´ä¸ä½¿ç”¨åæ¥åšè¿™ä»¶äº‹ã€‚å½“å­¦ä¹  <code>ProcessFunction</code> çš„ç›¸å…³ç« èŠ‚æ—¶ï¼Œä½ å°†çœ‹åˆ°åœ¨äº‹ä»¶é©±åŠ¨çš„åº”ç”¨ä¸­æ€ä¹ˆç”¨å®šæ—¶å™¨æ¥åšè¿™ä¸ªã€‚</p>
<p>ä¹Ÿå¯ä»¥é€‰æ‹©ä½¿ç”¨ <a target="_blank" rel="noopener" href="https://nightlies.apache.org/flink/flink-docs-release-1.14/zh/docs/dev/datastream/fault-tolerance/state/#state-time-to-live-ttl">çŠ¶æ€çš„è¿‡æœŸæ—¶é—´ï¼ˆTTLï¼‰</a>ï¼Œä¸ºçŠ¶æ€æè¿°ç¬¦é…ç½®ä½ æƒ³è¦æ—§çŠ¶æ€è‡ªåŠ¨è¢«æ¸…é™¤çš„æ—¶é—´ã€‚</p>
<h3 id="Non-keyed-State"><a href="#Non-keyed-State" class="headerlink" title="Non-keyed State"></a>Non-keyed State</h3><p>åœ¨æ²¡æœ‰é”®çš„ä¸Šä¸‹æ–‡ä¸­æˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨ Flink ç®¡ç†çš„çŠ¶æ€ã€‚è¿™ä¹Ÿè¢«ç§°ä½œ <a target="_blank" rel="noopener" href="https://nightlies.apache.org/flink/flink-docs-release-1.14/zh/docs/dev/datastream/fault-tolerance/state/#operator-state">ç®—å­çš„çŠ¶æ€</a>ã€‚å®ƒåŒ…å«çš„æ¥å£æ˜¯å¾ˆä¸ä¸€æ ·çš„ï¼Œç”±äºå¯¹ç”¨æˆ·å®šä¹‰çš„å‡½æ•°æ¥è¯´ä½¿ç”¨ non-keyed state æ˜¯ä¸å¤ªå¸¸è§çš„ï¼Œæ‰€ä»¥è¿™é‡Œå°±ä¸å¤šä»‹ç»äº†ã€‚è¿™ä¸ªç‰¹æ€§æœ€å¸¸ç”¨äº source å’Œ sink çš„å®ç°ã€‚</p>
<h2 id="Connected-Streams"><a href="#Connected-Streams" class="headerlink" title="Connected Streams"></a>Connected Streams</h2><p>ç›¸æ¯”äºä¸‹é¢è¿™ç§é¢„å…ˆå®šä¹‰çš„è½¬æ¢ï¼š</p>
<p><img src="https://nightlies.apache.org/flink/flink-docs-release-1.14/fig/transformation.svg" alt="simple transformation"></p>
<p>æœ‰æ—¶ä½ æƒ³è¦æ›´çµæ´»åœ°è°ƒæ•´è½¬æ¢çš„æŸäº›åŠŸèƒ½ï¼Œæ¯”å¦‚æ•°æ®æµçš„é˜ˆå€¼ã€è§„åˆ™æˆ–è€…å…¶ä»–å‚æ•°ã€‚Flink æ”¯æŒè¿™ç§éœ€æ±‚çš„æ¨¡å¼ç§°ä¸º <em>connected streams</em> ï¼Œä¸€ä¸ªå•ç‹¬çš„ç®—å­æœ‰ä¸¤ä¸ªè¾“å…¥æµã€‚</p>
<p><img src="https://nightlies.apache.org/flink/flink-docs-release-1.14/fig/connected-streams.svg" alt="connected streams"></p>
<p>connected stream ä¹Ÿå¯ä»¥è¢«ç”¨æ¥å®ç°æµçš„å…³è”ã€‚</p>
<h3 id="ç¤ºä¾‹"><a href="#ç¤ºä¾‹" class="headerlink" title="ç¤ºä¾‹"></a>ç¤ºä¾‹</h3><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œä¸€ä¸ªæ§åˆ¶æµæ˜¯ç”¨æ¥æŒ‡å®šå“ªäº›è¯éœ€è¦ä» <code>streamOfWords</code> é‡Œè¿‡æ»¤æ‰çš„ã€‚ ä¸€ä¸ªç§°ä¸º <code>ControlFunction</code> çš„ <code>RichCoFlatMapFunction</code> ä½œç”¨äºè¿æ¥çš„æµæ¥å®ç°è¿™ä¸ªåŠŸèƒ½ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">StreamExecutionEnvironment</span> <span class="variable">env</span> <span class="operator">=</span> StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line"></span><br><span class="line">    DataStream&lt;String&gt; control = env</span><br><span class="line">        .fromElements(<span class="string">&quot;DROP&quot;</span>, <span class="string">&quot;IGNORE&quot;</span>)</span><br><span class="line">        .keyBy(x -&gt; x);</span><br><span class="line"></span><br><span class="line">    DataStream&lt;String&gt; streamOfWords = env</span><br><span class="line">        .fromElements(<span class="string">&quot;Apache&quot;</span>, <span class="string">&quot;DROP&quot;</span>, <span class="string">&quot;Flink&quot;</span>, <span class="string">&quot;IGNORE&quot;</span>)</span><br><span class="line">        .keyBy(x -&gt; x);</span><br><span class="line"></span><br><span class="line">    control</span><br><span class="line">        .connect(streamOfWords)</span><br><span class="line">        .flatMap(<span class="keyword">new</span> <span class="title class_">ControlFunction</span>())</span><br><span class="line">        .print();</span><br><span class="line"></span><br><span class="line">    env.execute();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œæ³¨æ„ä¸¤ä¸ªæµåªæœ‰é”®ä¸€è‡´çš„æ—¶å€™æ‰èƒ½è¿æ¥ã€‚ <code>keyBy</code> çš„ä½œç”¨æ˜¯å°†æµæ•°æ®åˆ†åŒºï¼Œå½“ keyed stream è¢«è¿æ¥æ—¶ï¼Œä»–ä»¬å¿…é¡»æŒ‰ç›¸åŒçš„æ–¹å¼åˆ†åŒºã€‚è¿™æ ·ä¿è¯äº†ä¸¤ä¸ªæµä¸­æ‰€æœ‰é”®ç›¸åŒçš„äº‹ä»¶å‘åˆ°åŒä¸€ä¸ªå®ä¾‹ä¸Šã€‚è¿™æ ·ä¹Ÿä½¿æŒ‰é”®å…³è”ä¸¤ä¸ªæµæˆä¸ºå¯èƒ½ã€‚</p>
<p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œä¸¤ä¸ªæµéƒ½æ˜¯ <code>DataStream&lt;String&gt;</code> ç±»å‹çš„ï¼Œå¹¶ä¸”éƒ½å°†å­—ç¬¦ä¸²ä½œä¸ºé”®ã€‚æ­£å¦‚ä½ å°†åœ¨ä¸‹é¢çœ‹åˆ°çš„ï¼Œ<code>RichCoFlatMapFunction</code> åœ¨çŠ¶æ€ä¸­å­˜äº†ä¸€ä¸ªå¸ƒå°”ç±»å‹çš„å˜é‡ï¼Œè¿™ä¸ªå˜é‡è¢«ä¸¤ä¸ªæµå…±äº«ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">ControlFunction</span> <span class="keyword">extends</span> <span class="title class_">RichCoFlatMapFunction</span>&lt;String, String, String&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> ValueState&lt;Boolean&gt; blocked;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">open</span><span class="params">(Configuration config)</span> &#123;</span><br><span class="line">        blocked = getRuntimeContext()</span><br><span class="line">            .getState(<span class="keyword">new</span> <span class="title class_">ValueStateDescriptor</span>&lt;&gt;(<span class="string">&quot;blocked&quot;</span>, Boolean.class));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">flatMap1</span><span class="params">(String control_value, Collector&lt;String&gt; out)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        blocked.update(Boolean.TRUE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">flatMap2</span><span class="params">(String data_value, Collector&lt;String&gt; out)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">if</span> (blocked.value() == <span class="literal">null</span>) &#123;</span><br><span class="line">            out.collect(data_value);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>RichCoFlatMapFunction</code> æ˜¯ä¸€ç§å¯ä»¥è¢«ç”¨äºä¸€å¯¹è¿æ¥æµçš„ <code>FlatMapFunction</code>ï¼Œå¹¶ä¸”å®ƒå¯ä»¥è°ƒç”¨ rich function çš„æ¥å£ã€‚è¿™æ„å‘³ç€å®ƒå¯ä»¥æ˜¯æœ‰çŠ¶æ€çš„ã€‚</p>
<p>å¸ƒå°”å˜é‡ <code>blocked</code> è¢«ç”¨äºè®°å½•åœ¨æ•°æ®æµ <code>control</code> ä¸­å‡ºç°è¿‡çš„é”®ï¼ˆåœ¨è¿™ä¸ªä¾‹å­ä¸­æ˜¯å•è¯ï¼‰ï¼Œå¹¶ä¸”è¿™äº›å•è¯ä» <code>streamOfWords</code> è¿‡æ»¤æ‰ã€‚è¿™æ˜¯ <em>keyed</em> stateï¼Œå¹¶ä¸”å®ƒæ˜¯è¢«ä¸¤ä¸ªæµå…±äº«çš„ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆä¸¤ä¸ªæµå¿…é¡»æœ‰ç›¸åŒçš„é”®å€¼ç©ºé—´ã€‚</p>
<p>åœ¨ Flink è¿è¡Œæ—¶ä¸­ï¼Œ<code>flatMap1</code> å’Œ <code>flatMap2</code> åœ¨è¿æ¥æµæœ‰æ–°å…ƒç´ åˆ°æ¥æ—¶è¢«è°ƒç”¨ â€”â€” åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œ<code>control</code> æµä¸­çš„å…ƒç´ ä¼šè¿›å…¥ <code>flatMap1</code>ï¼Œ<code>streamOfWords</code> ä¸­çš„å…ƒç´ ä¼šè¿›å…¥ <code>flatMap2</code>ã€‚è¿™æ˜¯ç”±ä¸¤ä¸ªæµè¿æ¥çš„é¡ºåºå†³å®šçš„ï¼Œæœ¬ä¾‹ä¸­ä¸º <code>control.connect(streamOfWords)</code>ã€‚</p>
<p>è®¤è¯†åˆ°ä½ æ²¡æ³•æ§åˆ¶ <code>flatMap1</code> å’Œ <code>flatMap2</code> çš„è°ƒç”¨é¡ºåºæ˜¯å¾ˆé‡è¦çš„ã€‚è¿™ä¸¤ä¸ªè¾“å…¥æµæ˜¯ç›¸äº’ç«äº‰çš„å…³ç³»ï¼ŒFlink è¿è¡Œæ—¶å°†æ ¹æ®ä»ä¸€ä¸ªæµæˆ–å¦ä¸€ä¸ªæµä¸­æ¶ˆè´¹çš„äº‹ä»¶åšå®ƒè¦åšçš„ã€‚å¯¹äºéœ€è¦ä¿è¯æ—¶é—´å’Œ&#x2F;æˆ–é¡ºåºçš„åœºæ™¯ï¼Œä½ ä¼šå‘ç°åœ¨ Flink çš„ç®¡ç†çŠ¶æ€ä¸­ç¼“å­˜äº‹ä»¶ä¸€ç›´åˆ°å®ƒä»¬èƒ½å¤Ÿè¢«å¤„ç†æ˜¯å¿…é¡»çš„ã€‚ï¼ˆæ³¨æ„ï¼šå¦‚æœä½ çœŸçš„æ„Ÿåˆ°ç»æœ›ï¼Œå¯ä»¥ä½¿ç”¨è‡ªå®šä¹‰çš„ç®—å­å®ç° <code>InputSelectable</code> æ¥å£ï¼Œåœ¨ä¸¤è¾“å…¥ç®—å­æ¶ˆè´¹å®ƒçš„è¾“å…¥æµæ—¶å¢åŠ ä¸€äº›é¡ºåºä¸Šçš„é™åˆ¶ã€‚ï¼‰</p>
<h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ul>
<li><a target="_blank" rel="noopener" href="https://nightlies.apache.org/flink/flink-docs-release-1.14/zh/">Flink å®˜æ–¹æ–‡æ¡£</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="ä¸Šä¸€é¡µ" aria-label="ä¸Šä¸€é¡µ" href="/blog/page/19/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/blog/">1</a><span class="space">&hellip;</span><a class="page-number" href="/blog/page/19/">19</a><span class="page-number current">20</span><a class="page-number" href="/blog/page/21/">21</a><span class="space">&hellip;</span><a class="page-number" href="/blog/page/51/">51</a><a class="extend next" rel="next" title="ä¸‹ä¸€é¡µ" aria-label="ä¸‹ä¸€é¡µ" href="/blog/page/21/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 2015 â€“ 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">é’æ‚Ÿ â—¾ Dunwu</span>
  </div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
      <span>ç«™ç‚¹æ€»å­—æ•°ï¼š</span>
    <span title="ç«™ç‚¹æ€»å­—æ•°">4.5m</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span>ç«™ç‚¹é˜…è¯»æ—¶é•¿ &asymp;</span>
    <span title="ç«™ç‚¹é˜…è¯»æ—¶é•¿">68:08</span>
  </span>
</div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="reading-progress-bar"></div>

  <a href="https://github.com/dunwu/blog" class="github-corner" title="åœ¨ GitHub ä¸Šå…³æ³¨æˆ‘" aria-label="åœ¨ GitHub ä¸Šå…³æ³¨æˆ‘" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>
<script src="https://cdn.jsdelivr.net/npm/darkmode-js@1.5.7/lib/darkmode-js.min.js"></script>

<script>
var options = {
  bottom: '64px',
  right: 'unset',
  left: '32px',
  time: '0.5s',
  mixColor: 'transparent',
  backgroundColor: 'transparent',
  buttonColorDark: '#100f2c',
  buttonColorLight: '#fff',
  saveInCookies: true,
  label: 'ğŸŒ“',
  autoMatchOsTheme: true
}
const darkmode = new Darkmode(options);
window.darkmode = darkmode;
darkmode.showWidget();
</script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1.8.0/dist/gitalk.css" integrity="sha256-AJnUHL7dBv6PGaeyPQJcgQPDjt/Hn/PvYZde1iqfp8U=" crossorigin="anonymous">

<script class="next-config" data-name="gitalk" type="application/json">{"enable":true,"github_id":"dunwu","repo":"blog","client_id":"c45bc13ca1d3d3aa4836","client_secret":"1907a9f0c22087badad3938e1d7dcba9078f88ac","admin_user":"dunwu","distraction_free_mode":true,"proxy":"https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token","language":"zh-CN","js":{"url":"https://cdn.jsdelivr.net/npm/gitalk@1.8.0/dist/gitalk.min.js","integrity":"sha256-MVK9MGD/XJaGyIghSVrONSnoXoGh3IFxLw0zfvzpxR4="},"path_md5":"f2660250e47bd67d2657704dc6877aa6"}</script>
<script src="/blog/js/third-party/comments/gitalk.js" defer></script>

</body>
</html>

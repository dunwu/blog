<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/blog/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/blog/uploads/favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/blog/uploads/favicon.ico">
  <link rel="mask-icon" href="/blog/images/logo.svg" color="#222">

<link rel="stylesheet" href="/blog/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@7.0.0/css/all.min.css" integrity="sha256-VHqXKFhhMxcpubYf9xiWdCiojEbY9NexQ4jh8AxbvcM=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/themes/blue/pace-theme-minimal.css">
  <script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous" defer></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"dunwu.github.io","root":"/blog/","images":"/blog/images","scheme":"Pisces","darkmode":true,"version":"8.25.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"codeblock":{"theme":{"light":"atom-one-light","dark":"atom-one-dark"},"prism":{"light":"atom-one-light","dark":"atom-one-dark"},"copy_button":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"language":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"gitalk","storage":true,"lazyload":true,"nav":null,"activeClass":"gitalk"},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/blog/search.xml","localsearch":{"enable":true,"top_n_per_article":1,"unescape":false,"preload":false,"trigger":"auto"}}</script><script src="/blog/js/config.js" defer></script>

    <meta name="description" content="钝悟的个人博客">
<meta property="og:type" content="website">
<meta property="og:title" content="Dunwu Blog">
<meta property="og:url" content="https://dunwu.github.io/blog/page/21/index.html">
<meta property="og:site_name" content="Dunwu Blog">
<meta property="og:description" content="钝悟的个人博客">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="钝悟 ◾ Dunwu">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://dunwu.github.io/blog/page/21/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"page/21/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Dunwu Blog</title>
  








  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
<script src="/blog/js/utils.js" defer></script><script src="/blog/js/motion.js" defer></script><script src="/blog/js/sidebar.js" defer></script><script src="/blog/js/next-boot.js" defer></script>

  <script src="https://cdn.jsdelivr.net/npm/hexo-generator-searchdb@1.5.0/dist/search.js" integrity="sha256-xFC6PJ82SL9b3WkGjFavNiA9gm5z6UBxWPiu4CYjptg=" crossorigin="anonymous" defer></script>
<script src="/blog/js/third-party/search/local-search.js" defer></script>





  <script src="/blog/js/third-party/pace.js" defer></script>


  





  <noscript>
    <link rel="stylesheet" href="/blog/css/noscript.css">
  </noscript>
<style>.darkmode--activated{--body-bg-color:#282828;--content-bg-color:#333;--card-bg-color:#555;--text-color:#ccc;--blockquote-color:#bbb;--link-color:#ccc;--link-hover-color:#eee;--brand-color:#ddd;--brand-hover-color:#ddd;--table-row-odd-bg-color:#282828;--table-row-hover-bg-color:#363636;--menu-item-bg-color:#555;--btn-default-bg:#222;--btn-default-color:#ccc;--btn-default-border-color:#555;--btn-default-hover-bg:#666;--btn-default-hover-color:#ccc;--btn-default-hover-border-color:#666;--highlight-background:#282b2e;--highlight-foreground:#a9b7c6;--highlight-gutter-background:#34393d;--highlight-gutter-foreground:#9ca9b6}.darkmode--activated img{opacity:.75}.darkmode--activated img:hover{opacity:.9}.darkmode--activated code{color:#69dbdc;background:0 0}button.darkmode-toggle{z-index:9999}.darkmode-ignore,img{display:flex!important}.beian img{display:inline-block!important}</style></head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/blog/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Dunwu Blog</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">大道至简，知易行难</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/blog/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/blog/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/blog/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">428</span></a></li><li class="menu-item menu-item-categories"><a href="/blog/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">124</span></a></li><li class="menu-item menu-item-archives"><a href="/blog/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">508</span></a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
      <div class="search-header">
        <span class="search-icon">
          <i class="fa fa-search"></i>
        </span>
        <div class="search-input-container">
          <input autocomplete="off" autocapitalize="off" maxlength="80"
                placeholder="搜索..." spellcheck="false"
                type="search" class="search-input">
        </div>
        <span class="popup-btn-close" role="button">
          <i class="fa fa-times-circle"></i>
        </span>
      </div>
      <div class="search-result-container">
        <div class="search-result-icon">
          <i class="fa fa-spinner fa-pulse fa-5x"></i>
        </div>
      </div>
    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="钝悟 ◾ Dunwu"
      src="/blog/uploads/avatar.gif">
  <p class="site-author-name" itemprop="name">钝悟 ◾ Dunwu</p>
  <div class="site-description" itemprop="description">钝悟的个人博客</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/blog/archives/">
          <span class="site-state-item-count">508</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/blog/categories/">
        <span class="site-state-item-count">124</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/blog/tags/">
        <span class="site-state-item-count">428</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/dunwu" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;dunwu" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:forbreak@163.com" title="E-Mail → mailto:forbreak@163.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>
  <div class="cc-license animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" class="cc-opacity" rel="noopener" target="_blank"><img src="https://cdn.jsdelivr.net/npm/@creativecommons/vocabulary@2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a>
  </div>

        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="返回顶部">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://dunwu.github.io/blog/pages/d1db76c3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/uploads/avatar.gif">
      <meta itemprop="name" content="钝悟 ◾ Dunwu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dunwu Blog">
      <meta itemprop="description" content="钝悟的个人博客">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Dunwu Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/pages/d1db76c3/" class="post-title-link" itemprop="url">Flink 事件驱动</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-02-17 22:28:55" itemprop="dateCreated datePublished" datetime="2022-02-17T22:28:55+08:00">2022-02-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-09-13 17:56:53" itemprop="dateModified" datetime="2025-09-13T17:56:53+08:00">2025-09-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/" itemprop="url" rel="index"><span itemprop="name">大数据</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/flink/" itemprop="url" rel="index"><span itemprop="name">flink</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>5.7k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>5 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Flink-事件驱动"><a href="#Flink-事件驱动" class="headerlink" title="Flink 事件驱动"></a>Flink 事件驱动</h1><h2 id="处理函数（Process-Functions）"><a href="#处理函数（Process-Functions）" class="headerlink" title="处理函数（Process Functions）"></a>处理函数（Process Functions）</h2><h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p><code>ProcessFunction</code> 将事件处理与 Timer，State 结合在一起，使其成为流处理应用的强大构建模块。 这是使用 Flink 创建事件驱动应用程序的基础。它和 <code>RichFlatMapFunction</code> 十分相似， 但是增加了 Timer。</p>
<h3 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h3><p>如果你已经体验了 <a target="_blank" rel="noopener" href="https://nightlies.apache.org/flink/flink-docs-release-1.14/zh/docs/learn-flink/streaming_analytics/">流式分析训练</a> 的<a target="_blank" rel="noopener" href="https://nightlies.apache.org/flink/flink-docs-release-1.14/zh/docs/learn-flink/streaming_analytics/#hands-on">动手实践</a>， 你应该记得，它是采用 <code>TumblingEventTimeWindow</code> 来计算每个小时内每个司机的小费总和， 像下面的示例这样：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 计算每个司机每小时的小费总和</span></span><br><span class="line">DataStream&lt;Tuple3&lt;Long, Long, Float&gt;&gt; hourlyTips = fares</span><br><span class="line">        .keyBy((TaxiFare fare) -&gt; fare.driverId)</span><br><span class="line">        .window(TumblingEventTimeWindows.of(Time.hours(<span class="number">1</span>)))</span><br><span class="line">        .process(<span class="keyword">new</span> <span class="title class_">AddTips</span>());</span><br></pre></td></tr></table></figure>

<p>使用 <code>KeyedProcessFunction</code> 去实现相同的操作更加直接且更有学习意义。 让我们开始用以下代码替换上面的代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 计算每个司机每小时的小费总和</span></span><br><span class="line">DataStream&lt;Tuple3&lt;Long, Long, Float&gt;&gt; hourlyTips = fares</span><br><span class="line">        .keyBy((TaxiFare fare) -&gt; fare.driverId)</span><br><span class="line">        .process(<span class="keyword">new</span> <span class="title class_">PseudoWindow</span>(Time.hours(<span class="number">1</span>)));</span><br></pre></td></tr></table></figure>

<p>在这个代码片段中，一个名为 <code>PseudoWindow</code> 的 <code>KeyedProcessFunction</code> 被应用于 KeyedStream， 其结果是一个 <code>DataStream&lt;Tuple3&lt;Long, Long, Float&gt;&gt;</code> （与使用 Flink 内置时间窗口的实现生成的流相同）。</p>
<p><code>PseudoWindow</code> 的总体轮廓示意如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 在时长跨度为一小时的窗口中计算每个司机的小费总和。</span></span><br><span class="line"><span class="comment">// 司机ID作为 key。</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">PseudoWindow</span> <span class="keyword">extends</span></span><br><span class="line">        <span class="title class_">KeyedProcessFunction</span>&lt;Long, TaxiFare, Tuple3&lt;Long, Long, Float&gt;&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">long</span> durationMsec;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">PseudoWindow</span><span class="params">(Time duration)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.durationMsec = duration.toMilliseconds();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="comment">// 在初始化期间调用一次。</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">open</span><span class="params">(Configuration conf)</span> &#123;</span><br><span class="line">        . . .</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="comment">// 每个票价事件（TaxiFare-Event）输入（到达）时调用，以处理输入的票价事件。</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processElement</span><span class="params">(</span></span><br><span class="line"><span class="params">            TaxiFare fare,</span></span><br><span class="line"><span class="params">            Context ctx,</span></span><br><span class="line"><span class="params">            Collector&lt;Tuple3&lt;Long, Long, Float&gt;&gt; out)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        . . .</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="comment">// 当当前水印（watermark）表明窗口现在需要完成的时候调用。</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onTimer</span><span class="params">(<span class="type">long</span> timestamp,</span></span><br><span class="line"><span class="params">            OnTimerContext context,</span></span><br><span class="line"><span class="params">            Collector&lt;Tuple3&lt;Long, Long, Float&gt;&gt; out)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        . . .</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意事项：</p>
<ul>
<li>有几种类型的 ProcessFunctions – 不仅包括 <code>KeyedProcessFunction</code>，还包括 <code>CoProcessFunctions</code>、<code>BroadcastProcessFunctions</code> 等.</li>
<li><code>KeyedProcessFunction</code> 是一种 <code>RichFunction</code>。作为 <code>RichFunction</code>，它可以访问使用 Managed Keyed State 所需的 <code>open</code> 和 <code>getRuntimeContext</code> 方法。</li>
<li>有两个回调方法须要实现： <code>processElement</code> 和 <code>onTimer</code>。每个输入事件都会调用 <code>processElement</code> 方法； 当计时器触发时调用 <code>onTimer</code>。它们可以是基于事件时间（event time）的 timer，也可以是基于处理时间（processing time）的 timer。 除此之外，<code>processElement</code> 和 <code>onTimer</code> 都提供了一个上下文对象，该对象可用于与 <code>TimerService</code> 交互。 这两个回调还传递了一个可用于发出结果的 <code>Collector</code>。</li>
</ul>
<h4 id="open-方法"><a href="#open-方法" class="headerlink" title="open() 方法"></a><code>open()</code> 方法</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 每个窗口都持有托管的 Keyed state 的入口，并且根据窗口的结束时间执行 keyed 策略。</span></span><br><span class="line"><span class="comment">// 每个司机都有一个单独的MapState对象。</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> MapState&lt;Long, Float&gt; sumOfTips;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">open</span><span class="params">(Configuration conf)</span> &#123;</span><br><span class="line"></span><br><span class="line">    MapStateDescriptor&lt;Long, Float&gt; sumDesc =</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">MapStateDescriptor</span>&lt;&gt;(<span class="string">&quot;sumOfTips&quot;</span>, Long.class, Float.class);</span><br><span class="line">    sumOfTips = getRuntimeContext().getMapState(sumDesc);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由于票价事件（fare-event）可能会乱序到达，有时需要在计算输出前一个小时结果前，处理下一个小时的事件。 这样能够保证“乱序造成的延迟数据”得到正确处理（放到前一个小时中）。 实际上，如果 Watermark 延迟比窗口长度长得多，则可能有多个窗口同时打开，而不仅仅是两个。 此实现通过使用 <code>MapState</code> 来支持处理这一点，该 <code>MapState</code> 将每个窗口的结束时间戳映射到该窗口的小费总和。</p>
<h4 id="processElement-方法"><a href="#processElement-方法" class="headerlink" title="processElement() 方法"></a><code>processElement()</code> 方法</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processElement</span><span class="params">(</span></span><br><span class="line"><span class="params">        TaxiFare fare,</span></span><br><span class="line"><span class="params">        Context ctx,</span></span><br><span class="line"><span class="params">        Collector&lt;Tuple3&lt;Long, Long, Float&gt;&gt; out)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">long</span> <span class="variable">eventTime</span> <span class="operator">=</span> fare.getEventTime();</span><br><span class="line">    <span class="type">TimerService</span> <span class="variable">timerService</span> <span class="operator">=</span> ctx.timerService();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (eventTime &lt;= timerService.currentWatermark()) &#123;</span><br><span class="line">        <span class="comment">// 事件延迟；其对应的窗口已经触发。</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 将 eventTime 向上取值并将结果赋值到包含当前事件的窗口的末尾时间点。</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">endOfWindow</span> <span class="operator">=</span> (eventTime - (eventTime % durationMsec) + durationMsec - <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 在窗口完成时将启用回调</span></span><br><span class="line">        timerService.registerEventTimeTimer(endOfWindow);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将此票价的小费添加到该窗口的总计中。</span></span><br><span class="line">        <span class="type">Float</span> <span class="variable">sum</span> <span class="operator">=</span> sumOfTips.get(endOfWindow);</span><br><span class="line">        <span class="keyword">if</span> (sum == <span class="literal">null</span>) &#123;</span><br><span class="line">            sum = <span class="number">0.0F</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        sum += fare.tip;</span><br><span class="line">        sumOfTips.put(endOfWindow, sum);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>需要考虑的事项：</p>
<ul>
<li>延迟的事件怎么处理？watermark 后面的事件（即延迟的）正在被删除。 如果你想做一些比这更高级的操作，可以考虑使用旁路输出（Side outputs），这将在<a target="_blank" rel="noopener" href="https://nightlies.apache.org/flink/flink-docs-release-1.14/zh/docs/learn-flink/event_driven/#side-outputs">下一节</a>中解释。</li>
<li>本例使用一个 <code>MapState</code>，其中 keys 是时间戳（timestamp），并为同一时间戳设置一个 Timer。 这是一种常见的模式；它使得在 Timer 触发时查找相关信息变得简单高效。</li>
</ul>
<h4 id="onTimer-方法"><a href="#onTimer-方法" class="headerlink" title="onTimer() 方法"></a><code>onTimer()</code> 方法</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onTimer</span><span class="params">(</span></span><br><span class="line"><span class="params">        <span class="type">long</span> timestamp,</span></span><br><span class="line"><span class="params">        OnTimerContext context,</span></span><br><span class="line"><span class="params">        Collector&lt;Tuple3&lt;Long, Long, Float&gt;&gt; out)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">long</span> <span class="variable">driverId</span> <span class="operator">=</span> context.getCurrentKey();</span><br><span class="line">    <span class="comment">// 查找刚结束的一小时结果。</span></span><br><span class="line">    <span class="type">Float</span> <span class="variable">sumOfTips</span> <span class="operator">=</span> <span class="built_in">this</span>.sumOfTips.get(timestamp);</span><br><span class="line"></span><br><span class="line">    Tuple3&lt;Long, Long, Float&gt; result = Tuple3.of(driverId, timestamp, sumOfTips);</span><br><span class="line">    out.collect(result);</span><br><span class="line">    <span class="built_in">this</span>.sumOfTips.remove(timestamp);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意：</p>
<ul>
<li>传递给 <code>onTimer</code> 的 <code>OnTimerContext context</code> 可用于确定当前 key。</li>
<li>我们的 pseudo-windows 在当前 Watermark 到达每小时结束时触发，此时调用 <code>onTimer</code>。 这个 <code>onTimer</code> 方法从 <code>sumOfTips</code> 中删除相关的条目，这样做的效果是不可能容纳延迟的事件。 这相当于在使用 Flink 的时间窗口时将 allowedLateness 设置为零。</li>
</ul>
<h3 id="性能考虑"><a href="#性能考虑" class="headerlink" title="性能考虑"></a>性能考虑</h3><p>Flink 提供了为 RocksDB 优化的 <code>MapState</code> 和 <code>ListState</code> 类型。 相对于 <code>ValueState</code>，更建议使用 <code>MapState</code> 和 <code>ListState</code>，因为使用 RocksDBStateBackend 的情况下， <code>MapState</code> 和 <code>ListState</code> 比 <code>ValueState</code> 性能更好。 RocksDBStateBackend 可以附加到 <code>ListState</code>，而无需进行（反）序列化， 对于 <code>MapState</code>，每个 key&#x2F;value 都是一个单独的 RocksDB 对象，因此可以有效地访问和更新 <code>MapState</code>。</p>
<h2 id="旁路输出（Side-Outputs）"><a href="#旁路输出（Side-Outputs）" class="headerlink" title="旁路输出（Side Outputs）"></a>旁路输出（Side Outputs）</h2><h3 id="简介-1"><a href="#简介-1" class="headerlink" title="简介"></a>简介</h3><p>有几个很好的理由希望从 Flink 算子获得多个输出流，如下报告条目：</p>
<ul>
<li>异常情况（exceptions）</li>
<li>格式错误的事件（malformed events）</li>
<li>延迟的事件（late events）</li>
<li>operator 告警（operational alerts），如与外部服务的连接超时</li>
</ul>
<p>旁路输出（Side outputs）是一种方便的方法。除了错误报告之外，旁路输出也是实现流的 n 路分割的好方法。</p>
<h3 id="示例-1"><a href="#示例-1" class="headerlink" title="示例"></a>示例</h3><p>现在你可以对上一节中忽略的延迟事件执行某些操作。</p>
<p>Side output channel 与 <code>OutputTag&lt;T&gt;</code> 相关联。这些标记拥有自己的名称，并与对应 DataStream 类型一致。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> OutputTag&lt;TaxiFare&gt; lateFares = <span class="keyword">new</span> <span class="title class_">OutputTag</span>&lt;TaxiFare&gt;(<span class="string">&quot;lateFares&quot;</span>) &#123;&#125;;</span><br></pre></td></tr></table></figure>

<p>上面显示的是一个静态 <code>OutputTag&lt;TaxiFare&gt;</code> ，当在 <code>PseudoWindow</code> 的 <code>processElement</code> 方法中发出延迟事件时，可以引用它：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (eventTime &lt;= timerService.currentWatermark()) &#123;</span><br><span class="line">    <span class="comment">// 事件延迟，其对应的窗口已经触发。</span></span><br><span class="line">    ctx.output(lateFares, fare);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    . . .</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以及当在作业的 <code>main</code> 中从该旁路输出访问流时：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 计算每个司机每小时的小费总和</span></span><br><span class="line"><span class="type">SingleOutputStreamOperator</span> <span class="variable">hourlyTips</span> <span class="operator">=</span> fares</span><br><span class="line">        .keyBy((TaxiFare fare) -&gt; fare.driverId)</span><br><span class="line">        .process(<span class="keyword">new</span> <span class="title class_">PseudoWindow</span>(Time.hours(<span class="number">1</span>)));</span><br><span class="line"></span><br><span class="line">hourlyTips.getSideOutput(lateFares).print();</span><br></pre></td></tr></table></figure>

<p>或者，可以使用两个同名的 OutputTag 来引用同一个旁路输出，但如果这样做，它们必须具有相同的类型。</p>
<h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2><p>在本例中，你已经了解了如何使用 <code>ProcessFunction</code> 重新实现一个简单的时间窗口。 当然，如果 Flink 内置的窗口 API 能够满足你的开发需求，那么一定要优先使用它。 但如果你发现自己在考虑用 Flink 的窗口做些错综复杂的事情，不要害怕自己动手。</p>
<p>此外，<code>ProcessFunctions</code> 对于计算分析之外的许多其他用例也很有用。 下面的实践练习提供了一个完全不同的例子。</p>
<p><code>ProcessFunctions</code> 的另一个常见用例是清理过时 State。如果你回想一下 <a target="_blank" rel="noopener" href="https://github.com/apache/flink-training/blob/release-1.14//rides-and-fares">Rides and Fares Exercise </a>， 其中使用 <code>RichCoFlatMapFunction</code> 来计算简单 Join，那么示例方案假设 TaxiRides 和 TaxiFares 两个事件是严格匹配为一个有效 数据对（必须同时出现）并且每一组这样的有效数据对都和一个唯一的 <code>rideId</code> 严格对应。如果数据对中的某个 TaxiRides 事件（TaxiFares 事件） 丢失，则同一 <code>rideId</code> 对应的另一个出现的 TaxiFares 事件（TaxiRides 事件）对应的 State 则永远不会被清理掉。 所以这里可以使用 <code>KeyedCoProcessFunction</code> 的实现代替它（<code>RichCoFlatMapFunction</code>），并且可以使用计时器来检测和清除任何过时 的 State。</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a target="_blank" rel="noopener" href="https://nightlies.apache.org/flink/flink-docs-release-1.14/zh/">Flink 官方文档</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://dunwu.github.io/blog/pages/0f7773f4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/uploads/avatar.gif">
      <meta itemprop="name" content="钝悟 ◾ Dunwu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dunwu Blog">
      <meta itemprop="description" content="钝悟的个人博客">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Dunwu Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/pages/0f7773f4/" class="post-title-link" itemprop="url">Flink 架构</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-02-17 22:28:55" itemprop="dateCreated datePublished" datetime="2022-02-17T22:28:55+08:00">2022-02-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-09-13 17:56:53" itemprop="dateModified" datetime="2025-09-13T17:56:53+08:00">2025-09-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/" itemprop="url" rel="index"><span itemprop="name">大数据</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/flink/" itemprop="url" rel="index"><span itemprop="name">flink</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>5.2k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>5 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Flink-架构"><a href="#Flink-架构" class="headerlink" title="Flink 架构"></a>Flink 架构</h1><h2 id="Flink-的部署"><a href="#Flink-的部署" class="headerlink" title="Flink 的部署"></a>Flink 的部署</h2><p>Apache Flink 是一个分布式系统，它需要计算资源来执行应用程序。Flink 集成了所有常见的集群资源管理器，例如 <a target="_blank" rel="noopener" href="https://hadoop.apache.org/docs/stable/hadoop-yarn/hadoop-yarn-site/YARN.html">Hadoop YARN</a>、 <a target="_blank" rel="noopener" href="https://mesos.apache.org/">Apache Mesos</a> 和 <a target="_blank" rel="noopener" href="https://kubernetes.io/">Kubernetes</a>，但同时也可以作为独立集群运行。</p>
<p>Flink 被设计为能够很好地工作在上述每个资源管理器中，这是通过资源管理器特定(resource-manager-specific)的部署模式实现的。Flink 可以采用与当前资源管理器相适应的方式进行交互。</p>
<p>部署 Flink 应用程序时，Flink 会根据应用程序配置的并行性自动标识所需的资源，并从资源管理器请求这些资源。在发生故障的情况下，Flink 通过请求新资源来替换发生故障的容器。提交或控制应用程序的所有通信都是通过 REST 调用进行的，这可以简化 Flink 与各种环境中的集成。</p>
<h2 id="运行任意规模应用"><a href="#运行任意规模应用" class="headerlink" title="运行任意规模应用"></a>运行任意规模应用</h2><p>Flink 旨在任意规模上运行有状态流式应用。因此，应用程序被并行化为可能数千个任务，这些任务分布在集群中并发执行。所以应用程序能够充分利用无尽的 CPU、内存、磁盘和网络 IO。而且 Flink 很容易维护非常大的应用程序状态。其异步和增量的检查点算法对处理延迟产生最小的影响，同时保证精确一次状态的一致性。</p>
<p><a target="_blank" rel="noopener" href="https://flink.apache.org/zh/poweredby.html">Flink 用户报告了其生产环境中一些令人印象深刻的扩展性数字</a></p>
<ul>
<li>处理<strong>每天处理数万亿的事件</strong>,</li>
<li>应用维护<strong>几 TB 大小的状态</strong></li>
<li>应用<strong>在数千个内核上运行</strong></li>
</ul>
<h2 id="利用内存性能"><a href="#利用内存性能" class="headerlink" title="利用内存性能"></a>利用内存性能</h2><p>有状态的 Flink 程序针对本地状态访问进行了优化。任务的状态始终保留在内存中，如果状态大小超过可用内存，则会保存在能高效访问的磁盘数据结构中。任务通过访问本地（通常在内存中）状态来进行所有的计算，从而产生非常低的处理延迟。Flink 通过定期和异步地对本地状态进行持久化存储来保证故障场景下精确一次的状态一致性。</p>
<p><img src="https://flink.apache.org/img/local-state.png" alt="img"></p>
<h2 id="Flink-集群剖析"><a href="#Flink-集群剖析" class="headerlink" title="Flink 集群剖析"></a>Flink 集群剖析</h2><p>Flink 运行时由两种类型的进程组成：一个 <strong><code>JobManager</code></strong> 和一个或者多个 **<code>TaskManager</code>**。</p>
<p><img src="https://nightlies.apache.org/flink/flink-docs-release-1.14/fig/processes.svg" alt="The processes involved in executing a Flink dataflow"></p>
<p><em>Client</em> 不是运行时和程序执行的一部分，而是用于准备数据流并将其发送给 <code>JobManager</code>。之后，客户端可以断开连接（_分离模式_），或保持连接来接收进程报告（_附加模式_）。客户端可以作为触发执行 Java&#x2F;Scala 程序的一部分运行，也可以在命令行进程 <code>./bin/flink run ...</code> 中运行。</p>
<p>可以通过多种方式启动 <code>JobManager</code> 和 <code>TaskManager</code>：直接在机器上作为 <a target="_blank" rel="noopener" href="https://nightlies.apache.org/flink/flink-docs-release-1.14/zh/docs/deployment/resource-providers/standalone/overview/">standalone 集群</a>启动、在容器中启动、或者通过 <a target="_blank" rel="noopener" href="https://nightlies.apache.org/flink/flink-docs-release-1.14/zh/docs/deployment/resource-providers/yarn/">YARN</a> 等资源框架管理并启动。<code>TaskManager</code> 连接到 <code>JobManager</code>，宣布自己可用，并被分配工作。</p>
<h3 id="JobManager"><a href="#JobManager" class="headerlink" title="JobManager"></a>JobManager</h3><p><strong><code>JobManager</code></strong> 具有许多与协调 Flink 应用程序的分布式执行有关的职责，它决定</p>
<ul>
<li>何时调度下一个 task（或一组 task）</li>
<li>对完成的 task 或执行失败做出反应</li>
<li>协调 checkpoint</li>
<li>协调从失败中恢复</li>
<li>等等</li>
</ul>
<p><code>JobManager</code> 由三个不同的组件组成：</p>
<ul>
<li><p><strong>ResourceManager</strong>：负责 Flink 集群中的资源提供、回收、分配 - 它管理 <strong>task slots</strong>，这是 Flink 集群中资源调度的单位（请参考 <a href="#TaskManager">TaskManager</a>。Flink 为不同的环境和资源提供者（例如 YARN、Kubernetes 和 standalone 部署）实现了对应的 ResourceManager。在 standalone 设置中，ResourceManager 只能分配可用 TaskManager 的 slots，而不能自行启动新的 TaskManager。</p>
</li>
<li><p><strong>Dispatcher</strong>：提供了一个 REST 接口，用来提交 Flink 应用程序执行，并为每个提交的作业启动一个新的 JobMaster。它还运行 Flink WebUI 用来提供作业执行信息。</p>
</li>
<li><p><strong>JobMaster</strong>：负责管理单个 <a target="_blank" rel="noopener" href="https://nightlies.apache.org/flink/flink-docs-release-1.14/zh/docs/concepts/glossary/#logical-graph">JobGraph</a> 的执行。Flink 集群中可以同时运行多个作业，每个作业都有自己的 JobMaster。</p>
</li>
</ul>
<p>始终至少有一个 JobManager。高可用（HA）设置中可能有多个 JobManager，其中一个始终是 _leader_，其他的则是 _standby_（请参考 <a target="_blank" rel="noopener" href="https://nightlies.apache.org/flink/flink-docs-release-1.14/zh/docs/deployment/ha/overview/">高可用（HA）</a>）。</p>
<h3 id="TaskManager"><a href="#TaskManager" class="headerlink" title="TaskManager"></a>TaskManager</h3><p>_TaskManager_（也称为 _worker_）执行作业流的 task，并且缓存和交换数据流。</p>
<p>必须始终至少有一个 TaskManager。在 TaskManager 中资源调度的最小单位是 task _slot_。TaskManager 中 task slot 的数量表示并发处理 task 的数量。请注意一个 task slot 中可以执行多个算子（请参考<a target="_blank" rel="noopener" href="https://nightlies.apache.org/flink/flink-docs-release-1.14/zh/docs/concepts/flink-architecture/#tasks-and-operator-chains">Tasks 和算子链</a>）。</p>
<h2 id="Tasks-和算子链"><a href="#Tasks-和算子链" class="headerlink" title="Tasks 和算子链"></a>Tasks 和算子链</h2><p>对于分布式执行，Flink 将算子的 subtasks <em>链接</em>成 _tasks_。每个 task 由一个线程执行。将算子链接成 task 是个有用的优化：它减少线程间切换、缓冲的开销，并且减少延迟的同时增加整体吞吐量。链行为是可以配置的；请参考<a target="_blank" rel="noopener" href="https://nightlies.apache.org/flink/flink-docs-release-1.14/zh/docs/dev/datastream/operators/overview/#task-chaining-and-resource-groups">链文档</a>以获取详细信息。</p>
<p>下图中样例数据流用 5 个 subtask 执行，因此有 5 个并行线程。</p>
<p><img src="https://nightlies.apache.org/flink/flink-docs-release-1.14/fig/tasks_chains.svg" alt="Operator chaining into Tasks"></p>
<h2 id="Task-Slots-和资源"><a href="#Task-Slots-和资源" class="headerlink" title="Task Slots 和资源"></a>Task Slots 和资源</h2><p>每个 worker（TaskManager）都是一个 _JVM 进程_，可以在单独的线程中执行一个或多个 subtask。为了控制一个 TaskManager 中接受多少个 task，就有了所谓的 <strong>task slots</strong>（至少一个）。</p>
<p>每个 <em>task slot</em> 代表 TaskManager 中资源的固定子集。例如，具有 3 个 slot 的 TaskManager，会将其托管内存 1&#x2F;3 用于每个 slot。分配资源意味着 subtask 不会与其他作业的 subtask 竞争托管内存，而是具有一定数量的保留托管内存。注意此处没有 CPU 隔离；当前 slot 仅分离 task 的托管内存。</p>
<p>通过调整 task slot 的数量，用户可以定义 subtask 如何互相隔离。每个 TaskManager 有一个 slot，这意味着每个 task 组都在单独的 JVM 中运行（例如，可以在单独的容器中启动）。具有多个 slot 意味着更多 subtask 共享同一 JVM。同一 JVM 中的 task 共享 TCP 连接（通过多路复用）和心跳信息。它们还可以共享数据集和数据结构，从而减少了每个 task 的开销。</p>
<p><img src="https://nightlies.apache.org/flink/flink-docs-release-1.14/fig/tasks_slots.svg" alt="A TaskManager with Task Slots and Tasks"></p>
<p>默认情况下，Flink 允许 subtask 共享 slot，即便它们是不同的 task 的 subtask，只要是来自于同一作业即可。结果就是一个 slot 可以持有整个作业管道。允许 <em>slot 共享</em>有两个主要优点：</p>
<ul>
<li>Flink 集群所需的 task slot 和作业中使用的最大并行度恰好一样。无需计算程序总共包含多少个 task（具有不同并行度）。</li>
<li>容易获得更好的资源利用。如果没有 slot 共享，非密集 subtask（_source&#x2F;map()_）将阻塞和密集型 subtask（_window_） 一样多的资源。通过 slot 共享，我们示例中的基本并行度从 2 增加到 6，可以充分利用分配的资源，同时确保繁重的 subtask 在 TaskManager 之间公平分配。</li>
</ul>
<p><img src="https://nightlies.apache.org/flink/flink-docs-release-1.14/fig/slot_sharing.svg" alt="TaskManagers with shared Task Slots"></p>
<h2 id="Flink-应用程序执行"><a href="#Flink-应用程序执行" class="headerlink" title="Flink 应用程序执行"></a>Flink 应用程序执行</h2><p><em>Flink 应用程序</em> 是从其 <code>main()</code> 方法产生的一个或多个 Flink 作业的任何用户程序。这些作业的执行可以在本地 JVM（<code>LocalEnvironment</code>）中进行，或具有多台机器的集群的远程设置（<code>RemoteEnvironment</code>）中进行。对于每个程序，<code>ExecutionEnvironment</code> 提供了一些方法来控制作业执行（例如设置并行度）并与外界交互（请参考 <a target="_blank" rel="noopener" href="https://nightlies.apache.org/flink/flink-docs-release-1.14/zh/docs/dev/datastream/overview/#anatomy-of-a-flink-program">Flink 程序剖析</a> ）。</p>
<p>Flink 应用程序的作业可以被提交到长期运行的 <a target="_blank" rel="noopener" href="https://nightlies.apache.org/flink/flink-docs-release-1.14/zh/docs/concepts/glossary/#flink-session-cluster">Flink Session 集群</a>、专用的 <a target="_blank" rel="noopener" href="https://nightlies.apache.org/flink/flink-docs-release-1.14/zh/docs/concepts/glossary/#flink-job-cluster">Flink Job 集群</a> 或 <a target="_blank" rel="noopener" href="https://nightlies.apache.org/flink/flink-docs-release-1.14/zh/docs/concepts/glossary/#flink-application-cluster">Flink Application 集群</a>。这些选项之间的差异主要与集群的生命周期和资源隔离保证有关。</p>
<h3 id="Flink-Session-集群"><a href="#Flink-Session-集群" class="headerlink" title="Flink Session 集群 #"></a>Flink Session 集群 <a target="_blank" rel="noopener" href="https://nightlies.apache.org/flink/flink-docs-release-1.14/zh/docs/concepts/flink-architecture/#flink-session-%E9%9B%86%E7%BE%A4">#</a></h3><ul>
<li><strong>集群生命周期</strong>：在 Flink Session 集群中，客户端连接到一个预先存在的、长期运行的集群，该集群可以接受多个作业提交。即使所有作业完成后，集群（和 JobManager）仍将继续运行直到手动停止 session 为止。因此，Flink Session 集群的寿命不受任何 Flink 作业寿命的约束。</li>
<li><strong>资源隔离</strong>：TaskManager slot 由 ResourceManager 在提交作业时分配，并在作业完成时释放。由于所有作业都共享同一集群，因此在集群资源方面存在一些竞争 — 例如提交工作阶段的网络带宽。此共享设置的局限性在于，如果 TaskManager 崩溃，则在此 TaskManager 上运行 task 的所有作业都将失败；类似的，如果 JobManager 上发生一些致命错误，它将影响集群中正在运行的所有作业。</li>
<li><strong>其他注意事项</strong>：拥有一个预先存在的集群可以节省大量时间申请资源和启动 TaskManager。有种场景很重要，作业执行时间短并且启动时间长会对端到端的用户体验产生负面的影响 — 就像对简短查询的交互式分析一样，希望作业可以使用现有资源快速执行计算。</li>
</ul>
<blockquote>
<p>以前，Flink Session 集群也被称为 <em>session 模式</em>下的 Flink 集群。</p>
</blockquote>
<h3 id="Flink-Job-集群"><a href="#Flink-Job-集群" class="headerlink" title="Flink Job 集群 #"></a>Flink Job 集群 <a target="_blank" rel="noopener" href="https://nightlies.apache.org/flink/flink-docs-release-1.14/zh/docs/concepts/flink-architecture/#flink-job-%E9%9B%86%E7%BE%A4">#</a></h3><ul>
<li><strong>集群生命周期</strong>：在 Flink Job 集群中，可用的集群管理器（例如 YARN）用于为每个提交的作业启动一个集群，并且该集群仅可用于该作业。在这里，客户端首先从集群管理器请求资源启动 JobManager，然后将作业提交给在这个进程中运行的 Dispatcher。然后根据作业的资源请求惰性的分配 TaskManager。一旦作业完成，Flink Job 集群将被拆除。</li>
<li><strong>资源隔离</strong>：JobManager 中的致命错误仅影响在 Flink Job 集群中运行的一个作业。</li>
<li><strong>其他注意事项</strong>：由于 ResourceManager 必须应用并等待外部资源管理组件来启动 TaskManager 进程和分配资源，因此 Flink Job 集群更适合长期运行、具有高稳定性要求且对较长的启动时间不敏感的大型作业。</li>
</ul>
<blockquote>
<p>以前，Flink Job 集群也被称为 <em>job (or per-job) 模式</em>下的 Flink 集群。</p>
</blockquote>
<blockquote>
<p>Kubernetes 不支持 Flink Job 集群。 请参考 <a target="_blank" rel="noopener" href="https://nightlies.apache.org/flink/flink-docs-release-1.14/zh/docs/deployment/resource-providers/standalone/kubernetes/#per-job-cluster-mode">Standalone Kubernetes</a> 和 <a target="_blank" rel="noopener" href="https://nightlies.apache.org/flink/flink-docs-release-1.14/zh/docs/deployment/resource-providers/native_kubernetes/#per-job-cluster-mode">Native Kubernetes</a>。</p>
</blockquote>
<h3 id="Flink-Application-集群"><a href="#Flink-Application-集群" class="headerlink" title="Flink Application 集群 #"></a>Flink Application 集群 <a target="_blank" rel="noopener" href="https://nightlies.apache.org/flink/flink-docs-release-1.14/zh/docs/concepts/flink-architecture/#flink-application-%E9%9B%86%E7%BE%A4">#</a></h3><ul>
<li><strong>集群生命周期</strong>：Flink Application 集群是专用的 Flink 集群，仅从 Flink 应用程序执行作业，并且 <code>main()</code>方法在集群上而不是客户端上运行。提交作业是一个单步骤过程：无需先启动 Flink 集群，然后将作业提交到现有的 session 集群；相反，将应用程序逻辑和依赖打包成一个可执行的作业 JAR 中，并且集群入口（<code>ApplicationClusterEntryPoint</code>）负责调用 <code>main()</code>方法来提取 JobGraph。例如，这允许你像在 Kubernetes 上部署任何其他应用程序一样部署 Flink 应用程序。因此，Flink Application 集群的寿命与 Flink 应用程序的寿命有关。</li>
<li><strong>资源隔离</strong>：在 Flink Application 集群中，ResourceManager 和 Dispatcher 作用于单个的 Flink 应用程序，相比于 Flink Session 集群，它提供了更好的隔离。</li>
</ul>
<blockquote>
<p>Flink Job 集群可以看做是 Flink Application 集群”客户端运行“的替代方案。</p>
</blockquote>
<h2 id="Flink-高可用"><a href="#Flink-高可用" class="headerlink" title="Flink 高可用"></a>Flink 高可用</h2><p>默认情况下，每个 Flink 集群只有一个 JobManager 实例。这会导致 _单点故障（SPOF）_：如果 JobManager 崩溃，则不能提交任何新程序，运行中的程序也会失败。</p>
<p>使用 JobManager 高可用模式，你可以从 JobManager 失败中恢复，从而消除单点故障。</p>
<h3 id="如何启用集群高可用"><a href="#如何启用集群高可用" class="headerlink" title="如何启用集群高可用"></a>如何启用集群高可用</h3><p>JobManager 高可用是指，在任何时候都有一个 <strong>JobManager Leader</strong>，如果 Leader 出现故障，则有多个备用 JobManager 来接管领导。这解决了单点故障问题，只要有备用 JobManager 担任领导者，程序就可以继续运行。</p>
<p>如下是一个使用三个 JobManager 实例的例子：</p>
<p><img src="https://nightlies.apache.org/flink/flink-docs-release-1.14/fig/jobmanager_ha_overview.png" alt="img"></p>
<p>Flink 的 <a target="_blank" rel="noopener" href="https://nightlies.apache.org/flink/flink-docs-release-1.14/zh/docs/deployment/ha/overview/#high-availability-services">高可用服务</a> 封装了所需的服务，使一切可以正常工作：</p>
<ul>
<li><strong>领导者选举</strong>：从 <code>n</code> 个候选者中选出一个领导者</li>
<li><strong>服务发现</strong>：检索当前领导者的地址</li>
<li><strong>状态持久化</strong>：继承程序恢复作业所需的持久化状态（JobGraphs、用户代码 jar、已完成的检查点）</li>
</ul>
<h3 id="Flink-高可用服务"><a href="#Flink-高可用服务" class="headerlink" title="Flink 高可用服务"></a>Flink 高可用服务</h3><p>Flink 提供了两种高可用服务实现：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://nightlies.apache.org/flink/flink-docs-release-1.14/zh/docs/deployment/ha/zookeeper_ha/">ZooKeeper</a>：每个 Flink 集群部署都可以使用 ZooKeeper HA 服务。它们需要一个运行的 ZooKeeper 复制组（quorum）。</li>
<li><a target="_blank" rel="noopener" href="https://nightlies.apache.org/flink/flink-docs-release-1.14/zh/docs/deployment/ha/kubernetes_ha/">Kubernetes</a>：Kubernetes HA 服务只能运行在 Kubernetes 上。</li>
</ul>
<h3 id="高可用数据生命周期"><a href="#高可用数据生命周期" class="headerlink" title="高可用数据生命周期"></a>高可用数据生命周期</h3><p>为了恢复提交的作业，Flink 持久化元数据和 job 组件。高可用数据将一直保存，直到相应的作业执行成功、被取消或最终失败。当这些情况发生时，将删除所有高可用数据，包括存储在高可用服务中的元数据。</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a target="_blank" rel="noopener" href="https://nightlies.apache.org/flink/flink-docs-release-1.14/zh/">Flink 官方文档</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://dunwu.github.io/blog/pages/1dd47022/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/uploads/avatar.gif">
      <meta itemprop="name" content="钝悟 ◾ Dunwu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dunwu Blog">
      <meta itemprop="description" content="钝悟的个人博客">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Dunwu Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/pages/1dd47022/" class="post-title-link" itemprop="url">Flink简介</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-02-17 22:28:55" itemprop="dateCreated datePublished" datetime="2022-02-17T22:28:55+08:00">2022-02-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-09-13 17:56:53" itemprop="dateModified" datetime="2025-09-13T17:56:53+08:00">2025-09-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/" itemprop="url" rel="index"><span itemprop="name">大数据</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/flink/" itemprop="url" rel="index"><span itemprop="name">flink</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>11k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>10 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Flink-简介"><a href="#Flink-简介" class="headerlink" title="Flink 简介"></a>Flink 简介</h1><blockquote>
<p>关键概念：源源不断的流式数据处理、事件时间、有状态流处理和状态快照</p>
</blockquote>
<h2 id="流处理"><a href="#流处理" class="headerlink" title="流处理"></a>流处理</h2><p>任何类型的数据都可以形成一种事件流。信用卡交易、传感器测量、机器日志、网站或移动应用程序上的用户交互记录，所有这些数据都形成一种流。</p>
<p>数据可以被作为 <em>无界</em> 或者 <em>有界</em> 流来处理。</p>
<ol>
<li><strong>无界流</strong> 有定义流的开始，但没有定义流的结束。它们会无休止地产生数据。无界流的数据必须持续处理，即数据被摄取后需要立刻处理。我们不能等到所有数据都到达再处理，因为输入是无限的，在任何时候输入都不会完成。处理无界数据通常要求以特定顺序摄取事件，例如事件发生的顺序，以便能够推断结果的完整性。</li>
<li><strong>有界流</strong> 有定义流的开始，也有定义流的结束。有界流可以在摄取所有数据后再进行计算。有界流所有数据可以被排序，所以并不需要有序摄取。有界流处理通常被称为批处理。</li>
</ol>
<p><img src="https://nightlies.apache.org/flink/flink-docs-release-1.14/fig/bounded-unbounded.png" alt="Bounded and unbounded streams"></p>
<p><strong>Apache Flink 擅长处理无界和有界数据集</strong> 精确的时间控制和状态化使得 Flink 的运行时(runtime)能够运行任何处理无界流的应用。有界流则由一些专为固定大小数据集特殊设计的算法和数据结构进行内部处理，产生了出色的性能。</p>
<p><strong>批处理</strong>是有界数据流处理的范例。在这种模式下，你可以选择在计算结果输出之前输入整个数据集，这也就意味着你可以对整个数据集的数据进行排序、统计或汇总计算后再输出结果。</p>
<p><strong>流处理</strong>正相反，其涉及无界数据流。至少理论上来说，它的数据输入永远不会结束，因此程序必须持续不断地对到达的数据进行处理。</p>
<p>在 Flink 中，应用程序由用户自定义<strong>算子</strong>转换而来的<strong>流式 dataflows</strong> 所组成。这些流式 dataflows 形成了有向图，以一个或多个<strong>源</strong>（source）开始，并以一个或多个<strong>汇</strong>（sink）结束。</p>
<p><img src="https://nightlies.apache.org/flink/flink-docs-release-1.14/fig/program_dataflow.svg" alt="A DataStream program, and its dataflow."></p>
<p>通常，程序代码中的 transformation 和 dataflow 中的算子（operator）之间是一一对应的。但有时也会出现一个 transformation 包含多个算子的情况，如上图所示。</p>
<p>Flink 应用程序可以消费来自消息队列或分布式日志这类流式数据源（例如 Apache Kafka 或 Kinesis）的实时数据，也可以从各种的数据源中消费有界的历史数据。同样，Flink 应用程序生成的结果流也可以发送到各种数据汇中。</p>
<p><img src="https://nightlies.apache.org/flink/flink-docs-release-1.14/fig/flink-application-sources-sinks.png" alt="Flink application with sources and sinks"></p>
<h3 id="并行-Dataflows"><a href="#并行-Dataflows" class="headerlink" title="并行 Dataflows"></a>并行 Dataflows</h3><p>Flink 程序本质上是分布式并行程序。在程序执行期间，一个流有一个或多个<strong>流分区</strong>（Stream Partition），每个算子有一个或多个<strong>算子子任务</strong>（Operator Subtask）。每个子任务彼此独立，并在不同的线程中运行，或在不同的计算机或容器中运行。</p>
<p>算子子任务数就是其对应算子的<strong>并行度</strong>。在同一程序中，不同算子也可能具有不同的并行度。</p>
<p><img src="https://nightlies.apache.org/flink/flink-docs-release-1.14/fig/parallel_dataflow.svg" alt="A parallel dataflow"></p>
<p>Flink 算子之间可以通过<em>一对一</em>（_直传_）模式或<em>重新分发</em>模式传输数据：</p>
<ul>
<li><strong>一对一</strong>模式（例如上图中的 <em>Source</em> 和 <em>map()</em> 算子之间）可以保留元素的分区和顺序信息。这意味着 <em>map()</em> 算子的 subtask[1] 输入的数据以及其顺序与 <em>Source</em> 算子的 subtask[1] 输出的数据和顺序完全相同，即同一分区的数据只会进入到下游算子的同一分区。</li>
<li><strong>重新分发</strong>模式（例如上图中的 <em>map()</em> 和 <em>keyBy&#x2F;window</em> 之间，以及 <em>keyBy&#x2F;window</em> 和 <em>Sink</em> 之间）则会更改数据所在的流分区。当你在程序中选择使用不同的 _transformation_，每个<em>算子子任务</em>也会根据不同的 transformation 将数据发送到不同的目标子任务。例如以下这几种 transformation 和其对应分发数据的模式：_keyBy()_（通过散列键重新分区）、_broadcast()_（广播）或 _rebalance()<em>（随机重新分发）。在<em>重新分发</em>数据的过程中，元素只有在每对输出和输入子任务之间才能保留其之间的顺序信息（例如，_keyBy&#x2F;window</em> 的 subtask[2] 接收到的 <em>map()</em> 的 subtask[1] 中的元素都是有序的）。因此，上图所示的 <em>keyBy&#x2F;window</em> 和 <em>Sink</em> 算子之间数据的重新分发时，不同键（key）的聚合结果到达 Sink 的顺序是不确定的。</li>
</ul>
<h3 id="自定义时间流处理"><a href="#自定义时间流处理" class="headerlink" title="自定义时间流处理"></a>自定义时间流处理</h3><p>对于大多数流数据处理应用程序而言，能够使用处理实时数据的代码重新处理历史数据并产生确定并一致的结果非常有价值。</p>
<p>在处理流式数据时，我们通常更需要关注事件本身发生的顺序而不是事件被传输以及处理的顺序，因为这能够帮助我们推理出一组事件（事件集合）是何时发生以及结束的。例如电子商务交易或金融交易中涉及到的事件集合。</p>
<p>为了满足上述这类的实时流处理场景，我们通常会使用记录在数据流中的事件时间的时间戳，而不是处理数据的机器时钟的时间戳。</p>
<h3 id="有状态流处理"><a href="#有状态流处理" class="headerlink" title="有状态流处理"></a>有状态流处理</h3><p>Flink 中的算子可以是有状态的。这意味着如何处理一个事件可能取决于该事件之前所有事件数据的累积结果。Flink 中的状态不仅可以用于简单的场景（例如统计仪表板上每分钟显示的数据），也可以用于复杂的场景（例如训练作弊检测模型）。</p>
<p>Flink 应用程序可以在分布式集群上并行运行，其中每个算子的各个并行实例会在单独的线程中独立运行，并且通常情况下是会在不同的机器上运行。</p>
<p>有状态算子的并行实例组在存储其对应状态时通常是按照键（key）进行分片存储的。每个并行实例算子负责处理一组特定键的事件数据，并且这组键对应的状态会保存在本地。</p>
<p>如下图的 Flink 作业，其前三个算子的并行度为 2，最后一个 sink 算子的并行度为 1，其中第三个算子是有状态的，并且你可以看到第二个算子和第三个算子之间是全互联的（fully-connected），它们之间通过网络进行数据分发。通常情况下，实现这种类型的 Flink 程序是为了通过某些键对数据流进行分区，以便将需要一起处理的事件进行汇合，然后做统一计算处理。</p>
<p><img src="https://nightlies.apache.org/flink/flink-docs-release-1.14/fig/parallel-job.png" alt="State is sharded"></p>
<p>Flink 应用程序的状态访问都在本地进行，因为这有助于其提高吞吐量和降低延迟。通常情况下 Flink 应用程序都是将状态存储在 JVM 堆上，但如果状态太大，我们也可以选择将其以结构化数据格式存储在高速磁盘中。</p>
<p><img src="https://nightlies.apache.org/flink/flink-docs-release-1.14/fig/local-state.png" alt="State is local"></p>
<h3 id="通过状态快照实现的容错"><a href="#通过状态快照实现的容错" class="headerlink" title="通过状态快照实现的容错"></a>通过状态快照实现的容错</h3><p>通过状态快照和流重放两种方式的组合，Flink 能够提供可容错的，精确一次计算的语义。这些状态快照在执行时会获取并存储分布式 pipeline 中整体的状态，它会将数据源中消费数据的偏移量记录下来，并将整个 job graph 中算子获取到该数据（记录的偏移量对应的数据）时的状态记录并存储下来。当发生故障时，Flink 作业会恢复上次存储的状态，重置数据源从状态中记录的上次消费的偏移量开始重新进行消费处理。而且状态快照在执行时会异步获取状态并存储，并不会阻塞正在进行的数据处理逻辑。</p>
<h2 id="状态"><a href="#状态" class="headerlink" title="状态"></a>状态</h2><p>只有在每一个单独的事件上进行转换操作的应用才不需要状态，换言之，每一个具有一定复杂度的流处理应用都是有状态的。任何运行基本业务逻辑的流处理应用都需要在一定时间内存储所接收的事件或中间结果，以供后续的某个时间点（例如收到下一个事件或者经过一段特定时间）进行访问并进行后续处理。</p>
<p><img src="https://flink.apache.org/img/function-state.png" alt="img"></p>
<p>应用状态是 Flink 中的一等公民，Flink 提供了许多状态管理相关的特性支持，其中包括：</p>
<ul>
<li><strong>多种状态基础类型</strong>：Flink 为多种不同的数据结构提供了相对应的状态基础类型，例如原子值（value），列表（list）以及映射（map）。开发者可以基于处理函数对状态的访问方式，选择最高效、最适合的状态基础类型。</li>
<li><strong>插件化的 State Backend</strong>：State Backend 负责管理应用程序状态，并在需要的时候进行 checkpoint。Flink 支持多种 state backend，可以将状态存在内存或者 <a target="_blank" rel="noopener" href="https://rocksdb.org/">RocksDB</a>。RocksDB 是一种高效的嵌入式、持久化键值存储引擎。Flink 也支持插件式的自定义 state backend 进行状态存储。</li>
<li><strong>精确一次语义</strong>：Flink 的 checkpoint 和故障恢复算法保证了故障发生后应用状态的一致性。因此，Flink 能够在应用程序发生故障时，对应用程序透明，不造成正确性的影响。</li>
<li><strong>超大数据量状态</strong>：Flink 能够利用其异步以及增量式的 checkpoint 算法，存储数 TB 级别的应用状态。</li>
<li><strong>可弹性伸缩的应用</strong>：Flink 能够通过在更多或更少的工作节点上对状态进行重新分布，支持有状态应用的分布式的横向伸缩。</li>
</ul>
<h2 id="时间"><a href="#时间" class="headerlink" title="时间"></a>时间</h2><h3 id="时间语义"><a href="#时间语义" class="headerlink" title="时间语义"></a>时间语义</h3><p>Flink 支持以下三种时间语义:</p>
<ul>
<li>**事件时间(event time)**： 事件产生的时间，记录的是设备生产(或者存储)事件的时间</li>
<li>**摄取时间(ingestion time)**： Flink 读取事件时记录的时间</li>
<li>**处理时间(processing time)**： Flink pipeline 中具体算子处理事件的时间</li>
</ul>
<p>为了获得可重现的结果，例如在计算过去的特定一天里第一个小时股票的最高价格时，我们应该使用事件时间。这样的话，无论什么时间去计算都不会影响输出结果。然而如果使用处理时间的话，实时应用程序的结果是由程序运行的时间所决定。多次运行基于处理时间的实时程序，可能得到的结果都不相同，也可能会导致再次分析历史数据或者测试新代码变得异常困难。</p>
<h3 id="Event-Time"><a href="#Event-Time" class="headerlink" title="Event Time"></a>Event Time</h3><p>如果想要使用事件时间，需要额外给 Flink 提供一个时间戳提取器和 Watermark 生成器，Flink 将使用它们来跟踪事件时间的进度。</p>
<h3 id="Watermark"><a href="#Watermark" class="headerlink" title="Watermark"></a>Watermark</h3><p>让我们通过一个简单的示例来演示为什么需要 watermarks 及其工作方式。</p>
<p>在此示例中，我们将看到带有混乱时间戳的事件流，如下所示。显示的数字表达的是这些事件实际发生时间的时间戳。到达的第一个事件发生在时间 4，随后发生的事件发生在更早的时间 2，依此类推：</p>
<p>··· 23 19 22 24 21 14 17 13 12 15 9 11 7 2 4 →</p>
<p>假设我们要对数据流排序，我们想要达到的目的是：应用程序应该在数据流里的事件到达时就有一个算子（我们暂且称之为排序）开始处理事件，这个算子所输出的流是按照时间戳排序好的。</p>
<p>让我们重新审视这些数据:</p>
<p>(1) 我们的排序器看到的第一个事件的时间戳是 4，但是我们不能立即将其作为已排序的流释放。因为我们并不能确定它是有序的，并且较早的事件有可能并未到达。事实上，如果站在上帝视角，我们知道，必须要等到时间戳为 2 的元素到来时，排序器才可以有事件输出。</p>
<p><em>需要一些缓冲，需要一些时间，但这都是值得的</em></p>
<p>(2) 接下来的这一步，如果我们选择的是固执的等待，我们永远不会有结果。首先，我们看到了时间戳为 4 的事件，然后看到了时间戳为 2 的事件。可是，时间戳小于 2 的事件接下来会不会到来呢？可能会，也可能不会。再次站在上帝视角，我们知道，我们永远不会看到时间戳 1。</p>
<p><em>最终，我们必须勇于承担责任，并发出指令，把带有时间戳 2 的事件作为已排序的事件流的开始</em></p>
<p>(3) 然后，我们需要一种策略，该策略定义：对于任何给定时间戳的事件，Flink 何时停止等待较早事件的到来。</p>
<p><em>这正是 watermarks 的作用</em> — 它们定义何时停止等待较早的事件。</p>
<p>Flink 中事件时间的处理取决于 _watermark 生成器_，后者将带有时间戳的特殊元素插入流中形成 _watermarks_。事件时间 <em>t</em> 的 watermark 代表 <em>t</em> 之前（很可能）都已经到达。</p>
<p>当 watermark 以 2 或更大的时间戳到达时，事件流的排序器应停止等待，并输出 2 作为已经排序好的流。</p>
<p>(4) 我们可能会思考，如何决定 watermarks 的不同生成策略</p>
<p>每个事件都会延迟一段时间后到达，然而这些延迟有所不同，有些事件可能比其他事件延迟得更多。一种简单的方法是假定这些延迟受某个最大延迟的限制。Flink 将此策略称为 <em>最大无序边界 (bounded-out-of-orderness)</em> watermark。当然，我们可以想像出更好的生成 watermark 的方法，但是对于大多数应用而言，固定延迟策略已经足够了。</p>
<h3 id="延迟-VS-正确性"><a href="#延迟-VS-正确性" class="headerlink" title="延迟 VS 正确性"></a>延迟 VS 正确性</h3><p>watermarks 给了开发者流处理的一种选择，它们使开发人员在开发应用程序时可以控制延迟和完整性之间的权衡。与批处理不同，批处理中的奢侈之处在于可以在产生任何结果之前完全了解输入，而使用流式传输，我们不被允许等待所有的时间都产生了，才输出排序好的数据，这与流相违背。</p>
<p>我们可以把 watermarks 的边界时间配置的相对较短，从而冒着在输入了解不完全的情况下产生结果的风险-即可能会很快产生错误结果。或者，你可以等待更长的时间，并利用对输入流的更全面的了解来产生结果。</p>
<p>当然也可以实施混合解决方案，先快速产生初步结果，然后在处理其他（最新）数据时向这些结果提供更新。对于有一些对延迟的容忍程度很低，但是又对结果有很严格的要求的场景下，或许是一个福音。</p>
<h3 id="延迟"><a href="#延迟" class="headerlink" title="延迟"></a>延迟</h3><p>延迟是相对于 watermarks 定义的。<code>Watermark(t)</code> 表示事件流的时间已经到达了 <em>t</em>; watermark 之后的时间戳 ≤ <em>t</em> 的任何事件都被称之为延迟事件。</p>
<h3 id="使用-Watermarks"><a href="#使用-Watermarks" class="headerlink" title="使用 Watermarks"></a>使用 Watermarks</h3><p>如果想要使用基于带有事件时间戳的事件流，Flink 需要知道与每个事件相关的时间戳，而且流必须包含 watermark。</p>
<p>动手练习中使用的出租车数据源已经为我们处理了这些详细信息。但是，在您自己的应用程序中，您将必须自己进行处理，这通常是通过实现一个类来实现的，该类从事件中提取时间戳，并根据需要生成 watermarks。最简单的方法是使用 <code>WatermarkStrategy</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">DataStream&lt;Event&gt; stream = ...</span><br><span class="line"></span><br><span class="line">WatermarkStrategy&lt;Event&gt; strategy = WatermarkStrategy</span><br><span class="line">        .&lt;Event&gt;forBoundedOutOfOrderness(Duration.ofSeconds(<span class="number">20</span>))</span><br><span class="line">        .withTimestampAssigner((event, timestamp) -&gt; event.timestamp);</span><br><span class="line"></span><br><span class="line">DataStream&lt;Event&gt; withTimestampsAndWatermarks =</span><br><span class="line">    stream.assignTimestampsAndWatermarks(strategy);</span><br></pre></td></tr></table></figure>

<h2 id="窗口"><a href="#窗口" class="headerlink" title="窗口"></a>窗口</h2><p>我们在操作无界数据流时，经常需要应对以下问题，我们经常把无界数据流分解成有界数据流聚合分析：</p>
<ul>
<li>每分钟的浏览量</li>
<li>每位用户每周的会话数</li>
<li>每个传感器每分钟的最高温度</li>
</ul>
<p>用 Flink 计算窗口分析取决于两个主要的抽象操作：_Window Assigners_，将事件分配给窗口（根据需要创建新的窗口对象），以及 _Window Functions_，处理窗口内的数据。</p>
<p>Flink 的窗口 API 还具有 <em>Triggers</em> 和 <em>Evictors</em> 的概念，<em>Triggers</em> 确定何时调用窗口函数，而 <em>Evictors</em> 则可以删除在窗口中收集的元素。</p>
<p>举一个简单的例子，我们一般这样使用键控事件流（基于 key 分组的输入事件流）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">stream.</span><br><span class="line">    .keyBy(&lt;key selector&gt;)</span><br><span class="line">    .window(&lt;window assigner&gt;)</span><br><span class="line">    .reduce|aggregate|process(&lt;window function&gt;)</span><br></pre></td></tr></table></figure>

<p>您不是必须使用键控事件流（keyed stream），但是值得注意的是，如果不使用键控事件流，我们的程序就不能 <em>并行</em> 处理。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">stream.</span><br><span class="line">    .windowAll(&lt;window assigner&gt;)</span><br><span class="line">    .reduce|aggregate|process(&lt;window function&gt;)</span><br></pre></td></tr></table></figure>

<h3 id="窗口分配器"><a href="#窗口分配器" class="headerlink" title="窗口分配器"></a>窗口分配器</h3><p>Flink 有一些内置的窗口分配器，如下所示：</p>
<p><img src="https://nightlies.apache.org/flink/flink-docs-release-1.14/fig/window-assigners.svg" alt="Window assigners"></p>
<p>通过一些示例来展示关于这些窗口如何使用，或者如何区分它们：</p>
<ul>
<li>滚动时间窗口<ul>
<li><em>每分钟页面浏览量</em></li>
<li><code>TumblingEventTimeWindows.of(Time.minutes(1))</code></li>
</ul>
</li>
<li>滑动时间窗口<ul>
<li><em>每 10 秒钟计算前 1 分钟的页面浏览量</em></li>
<li><code>SlidingEventTimeWindows.of(Time.minutes(1), Time.seconds(10))</code></li>
</ul>
</li>
<li>会话窗口<ul>
<li><em>每个会话的网页浏览量，其中会话之间的间隔至少为 30 分钟</em></li>
<li><code>EventTimeSessionWindows.withGap(Time.minutes(30))</code></li>
</ul>
</li>
</ul>
<p>以下都是一些可以使用的间隔时间 <code>Time.milliseconds(n)</code>, <code>Time.seconds(n)</code>, <code>Time.minutes(n)</code>, <code>Time.hours(n)</code>, 和 <code>Time.days(n)</code>。</p>
<p>基于时间的窗口分配器（包括会话时间）既可以处理 <code>事件时间</code>，也可以处理 <code>处理时间</code>。这两种基于时间的处理没有哪一个更好，我们必须折衷。使用 <code>处理时间</code>，我们必须接受以下限制：</p>
<ul>
<li>无法正确处理历史数据,</li>
<li>无法正确处理超过最大无序边界的数据,</li>
<li>结果将是不确定的,</li>
</ul>
<p>但是有自己的优势，较低的延迟。</p>
<p>使用基于计数的窗口时，请记住，只有窗口内的事件数量到达窗口要求的数值时，这些窗口才会触发计算。尽管可以使用自定义触发器自己实现该行为，但无法应对超时和处理部分窗口。</p>
<p>我们可能在有些场景下，想使用全局 window assigner 将每个事件（相同的 key）都分配给某一个指定的全局窗口。 很多情况下，一个比较好的建议是使用 <code>ProcessFunction</code>，具体介绍在<a target="_blank" rel="noopener" href="https://nightlies.apache.org/flink/flink-docs-release-1.14/zh/docs/learn-flink/event_driven/#process-functions">这里</a>。</p>
<h3 id="窗口应用函数"><a href="#窗口应用函数" class="headerlink" title="窗口应用函数"></a>窗口应用函数</h3><p>我们有三种最基本的操作窗口内的事件的选项:</p>
<ol>
<li>像批量处理，<code>ProcessWindowFunction</code> 会缓存 <code>Iterable</code> 和窗口内容，供接下来全量计算；</li>
<li>或者像流处理，每一次有事件被分配到窗口时，都会调用 <code>ReduceFunction</code> 或者 <code>AggregateFunction</code> 来增量计算；</li>
<li>或者结合两者，通过 <code>ReduceFunction</code> 或者 <code>AggregateFunction</code> 预聚合的增量计算结果在触发窗口时， 提供给 <code>ProcessWindowFunction</code> 做全量计算。</li>
</ol>
<p>接下来展示一段 1 和 3 的示例，每一个实现都是计算传感器的最大值。在每一个一分钟大小的事件时间窗口内, 生成一个包含 <code>(key,end-of-window-timestamp, max_value)</code> 的一组结果。</p>
<h4 id="ProcessWindowFunction-示例"><a href="#ProcessWindowFunction-示例" class="headerlink" title="ProcessWindowFunction 示例"></a>ProcessWindowFunction 示例</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">DataStream&lt;SensorReading&gt; input = ...</span><br><span class="line"></span><br><span class="line">input</span><br><span class="line">    .keyBy(x -&gt; x.key)</span><br><span class="line">    .window(TumblingEventTimeWindows.of(Time.minutes(<span class="number">1</span>)))</span><br><span class="line">    .process(<span class="keyword">new</span> <span class="title class_">MyWastefulMax</span>());</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MyWastefulMax</span> <span class="keyword">extends</span> <span class="title class_">ProcessWindowFunction</span>&lt;</span><br><span class="line">        SensorReading,                  <span class="comment">// 输入类型</span></span><br><span class="line">        Tuple3&lt;String, Long, Integer&gt;,  <span class="comment">// 输出类型</span></span><br><span class="line">        String,                         <span class="comment">// 键类型</span></span><br><span class="line">        TimeWindow&gt; &#123;                   <span class="comment">// 窗口类型</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">process</span><span class="params">(</span></span><br><span class="line"><span class="params">            String key,</span></span><br><span class="line"><span class="params">            Context context,</span></span><br><span class="line"><span class="params">            Iterable&lt;SensorReading&gt; events,</span></span><br><span class="line"><span class="params">            Collector&lt;Tuple3&lt;String, Long, Integer&gt;&gt; out)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">max</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (SensorReading event : events) &#123;</span><br><span class="line">            max = Math.max(event.value, max);</span><br><span class="line">        &#125;</span><br><span class="line">        out.collect(Tuple3.of(key, context.window().getEnd(), max));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在当前实现中有一些值得关注的地方：</p>
<ul>
<li>Flink 会缓存所有分配给窗口的事件流，直到触发窗口为止。这个操作可能是相当昂贵的。</li>
<li>Flink 会传递给 <code>ProcessWindowFunction</code> 一个 <code>Context</code> 对象，这个对象内包含了一些窗口信息。<code>Context</code> 接口 展示大致如下:</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">Context</span> <span class="keyword">implements</span> <span class="title class_">java</span>.io.Serializable &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> W <span class="title function_">window</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="type">long</span> <span class="title function_">currentProcessingTime</span><span class="params">()</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="type">long</span> <span class="title function_">currentWatermark</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> KeyedStateStore <span class="title function_">windowState</span><span class="params">()</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> KeyedStateStore <span class="title function_">globalState</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>windowState</code> 和 <code>globalState</code> 可以用来存储当前的窗口的 key、窗口或者当前 key 的每一个窗口信息。这在一些场景下会很有用，试想，我们在处理当前窗口的时候，可能会用到上一个窗口的信息。</p>
<h4 id="增量聚合示例"><a href="#增量聚合示例" class="headerlink" title="增量聚合示例"></a>增量聚合示例</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">DataStream&lt;SensorReading&gt; input = ...</span><br><span class="line"></span><br><span class="line">input</span><br><span class="line">    .keyBy(x -&gt; x.key)</span><br><span class="line">    .window(TumblingEventTimeWindows.of(Time.minutes(<span class="number">1</span>)))</span><br><span class="line">    .reduce(<span class="keyword">new</span> <span class="title class_">MyReducingMax</span>(), <span class="keyword">new</span> <span class="title class_">MyWindowFunction</span>());</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MyReducingMax</span> <span class="keyword">implements</span> <span class="title class_">ReduceFunction</span>&lt;SensorReading&gt; &#123;</span><br><span class="line">    <span class="keyword">public</span> SensorReading <span class="title function_">reduce</span><span class="params">(SensorReading r1, SensorReading r2)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> r1.value() &gt; r2.value() ? r1 : r2;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MyWindowFunction</span> <span class="keyword">extends</span> <span class="title class_">ProcessWindowFunction</span>&lt;</span><br><span class="line">    SensorReading, Tuple3&lt;String, Long, SensorReading&gt;, String, TimeWindow&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">process</span><span class="params">(</span></span><br><span class="line"><span class="params">            String key,</span></span><br><span class="line"><span class="params">            Context context,</span></span><br><span class="line"><span class="params">            Iterable&lt;SensorReading&gt; maxReading,</span></span><br><span class="line"><span class="params">            Collector&lt;Tuple3&lt;String, Long, SensorReading&gt;&gt; out)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">SensorReading</span> <span class="variable">max</span> <span class="operator">=</span> maxReading.iterator().next();</span><br><span class="line">        out.collect(Tuple3.of(key, context.window().getEnd(), max));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>请注意 <code>Iterable&lt;SensorReading&gt;</code> 将只包含一个读数 – <code>MyReducingMax</code> 计算出的预先汇总的最大值。</p>
<h3 id="晚到的事件"><a href="#晚到的事件" class="headerlink" title="晚到的事件"></a>晚到的事件</h3><p>默认场景下，超过最大无序边界的事件会被删除，但是 Flink 给了我们两个选择去控制这些事件。</p>
<p>您可以使用一种称为<a target="_blank" rel="noopener" href="https://nightlies.apache.org/flink/flink-docs-release-1.14/zh/docs/learn-flink/event_driven/#side-outputs">旁路输出</a> 的机制来安排将要删除的事件收集到侧输出流中，这里是一个示例:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">OutputTag&lt;Event&gt; lateTag = <span class="keyword">new</span> <span class="title class_">OutputTag</span>&lt;Event&gt;(<span class="string">&quot;late&quot;</span>)&#123;&#125;;</span><br><span class="line"></span><br><span class="line">SingleOutputStreamOperator&lt;Event&gt; result = stream.</span><br><span class="line">    .keyBy(...)</span><br><span class="line">    .window(...)</span><br><span class="line">    .sideOutputLateData(lateTag)</span><br><span class="line">    .process(...);</span><br><span class="line"></span><br><span class="line">DataStream&lt;Event&gt; lateStream = result.getSideOutput(lateTag);</span><br></pre></td></tr></table></figure>

<p>我们还可以指定 <em>允许的延迟(allowed lateness)</em> 的间隔，在这个间隔时间内，延迟的事件将会继续分配给窗口（同时状态会被保留），默认状态下，每个延迟事件都会导致窗口函数被再次调用（有时也称之为 <em>late firing</em> ）。</p>
<p>默认情况下，允许的延迟为 0。换句话说，watermark 之后的元素将被丢弃（或发送到侧输出流）。</p>
<p>举例说明:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">stream.</span><br><span class="line">    .keyBy(...)</span><br><span class="line">    .window(...)</span><br><span class="line">    .allowedLateness(Time.seconds(<span class="number">10</span>))</span><br><span class="line">    .process(...);</span><br></pre></td></tr></table></figure>

<p>当允许的延迟大于零时，只有那些超过最大无序边界以至于会被丢弃的事件才会被发送到侧输出流（如果已配置）。</p>
<h3 id="深入了解窗口操作"><a href="#深入了解窗口操作" class="headerlink" title="深入了解窗口操作"></a>深入了解窗口操作</h3><p>Flink 的窗口 API 某些方面有一些奇怪的行为，可能和我们预期的行为不一致。 根据 <a target="_blank" rel="noopener" href="https://flink.apache.org/community.html#mailing-lists">Flink 用户邮件列表</a> 和其他地方一些频繁被问起的问题, 以下是一些有关 Windows 的底层事实，这些信息可能会让您感到惊讶。</p>
<h4 id="滑动窗口是通过复制来实现的"><a href="#滑动窗口是通过复制来实现的" class="headerlink" title="滑动窗口是通过复制来实现的"></a>滑动窗口是通过复制来实现的</h4><p>滑动窗口分配器可以创建许多窗口对象，并将每个事件复制到每个相关的窗口中。例如，如果您每隔 15 分钟就有 24 小时的滑动窗口，则每个事件将被复制到 4 * 24 &#x3D; 96 个窗口中。</p>
<h4 id="时间窗口会和时间对齐"><a href="#时间窗口会和时间对齐" class="headerlink" title="时间窗口会和时间对齐"></a>时间窗口会和时间对齐</h4><p>仅仅因为我们使用的是一个小时的处理时间窗口并在 12:05 开始运行您的应用程序，并不意味着第一个窗口将在 1:05 关闭。第一个窗口将长 55 分钟，并在 1:00 关闭。</p>
<p>请注意，滑动窗口和滚动窗口分配器所采用的 offset 参数可用于改变窗口的对齐方式。有关详细的信息，请参见 <a target="_blank" rel="noopener" href="https://nightlies.apache.org/flink/flink-docs-release-1.14/zh/docs/dev/datastream/operators/windows/#tumbling-windows">滚动窗口</a> 和 <a target="_blank" rel="noopener" href="https://nightlies.apache.org/flink/flink-docs-release-1.14/zh/docs/dev/datastream/operators/windows/#sliding-windows">滑动窗口</a> 。</p>
<h4 id="window-后面可以接-window"><a href="#window-后面可以接-window" class="headerlink" title="window 后面可以接 window"></a>window 后面可以接 window</h4><p>比如说:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">stream</span><br><span class="line">    .keyBy(t -&gt; t.key)</span><br><span class="line">    .window(&lt;window assigner&gt;)</span><br><span class="line">    .reduce(&lt;reduce function&gt;)</span><br><span class="line">    .windowAll(&lt;same window assigner&gt;)</span><br><span class="line">    .reduce(&lt;same reduce function&gt;)</span><br></pre></td></tr></table></figure>

<p>可能我们会猜测以 Flink 的能力，想要做到这样看起来是可行的（前提是你使用的是 ReduceFunction 或 AggregateFunction ），但不是。</p>
<p>之所以可行，是因为时间窗口产生的事件是根据窗口结束时的时间分配时间戳的。例如，一个小时小时的窗口所产生的所有事件都将带有标记一个小时结束的时间戳。后面的窗口内的数据消费和前面的流产生的数据是一致的。</p>
<h4 id="空的时间窗口不会输出结果"><a href="#空的时间窗口不会输出结果" class="headerlink" title="空的时间窗口不会输出结果"></a>空的时间窗口不会输出结果</h4><p>事件会触发窗口的创建。换句话说，如果在特定的窗口内没有事件，就不会有窗口，就不会有输出结果。</p>
<h4 id="延迟时间会导致延迟聚合"><a href="#延迟时间会导致延迟聚合" class="headerlink" title="延迟时间会导致延迟聚合"></a>延迟时间会导致延迟聚合</h4><p>会话窗口的实现是基于窗口的一个抽象能力，窗口可以 _聚合_。会话窗口中的每个数据在初始被消费时，都会被分配一个新的窗口，但是如果窗口之间的间隔足够小，多个窗口就会被聚合。延迟事件可以弥合两个先前分开的会话间隔，从而产生一个虽然有延迟但是更加准确地结果。</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a target="_blank" rel="noopener" href="https://nightlies.apache.org/flink/flink-docs-release-1.14/zh/">Flink 官方文档</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://dunwu.github.io/blog/pages/734610a7/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/uploads/avatar.gif">
      <meta itemprop="name" content="钝悟 ◾ Dunwu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dunwu Blog">
      <meta itemprop="description" content="钝悟的个人博客">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Dunwu Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/pages/734610a7/" class="post-title-link" itemprop="url">Java 基础语法特性</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-01-25 07:31:16" itemprop="dateCreated datePublished" datetime="2022-01-25T07:31:16+08:00">2022-01-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-09-13 17:56:53" itemprop="dateModified" datetime="2025-09-13T17:56:53+08:00">2025-09-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/JavaCore/" itemprop="url" rel="index"><span itemprop="name">JavaCore</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/JavaCore/%E5%9F%BA%E7%A1%80%E7%89%B9%E6%80%A7/" itemprop="url" rel="index"><span itemprop="name">基础特性</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>1.5k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>1 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Java-基础语法特性"><a href="#Java-基础语法特性" class="headerlink" title="Java 基础语法特性"></a>Java 基础语法特性</h1><h2 id="注释"><a href="#注释" class="headerlink" title="注释"></a>注释</h2><p>空白行，或者注释的内容，都会被 Java 编译器忽略掉。</p>
<p>Java 支持多种注释方式，下面的示例展示了各种注释的使用方式：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloWorld</span> &#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * JavaDoc 注释</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// 单行注释</span></span><br><span class="line">        <span class="comment">/* 多行注释：</span></span><br><span class="line"><span class="comment">           1. 注意点a</span></span><br><span class="line"><span class="comment">           2. 注意点b</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        System.out.println(<span class="string">&quot;Hello World&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="基本数据类型"><a href="#基本数据类型" class="headerlink" title="基本数据类型"></a>基本数据类型</h2><p><img src="https://raw.githubusercontent.com/dunwu/images/master/cs/java/javacore/xmind/Java%E5%9F%BA%E6%9C%AC%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B.svg" alt="img"></p>
<blockquote>
<p>👉 扩展阅读：<a href="https://dunwu.github.io/waterdrop/pages/17bf2e10/">深入理解 Java 基本数据类型</a></p>
</blockquote>
<h2 id="变量和常量"><a href="#变量和常量" class="headerlink" title="变量和常量"></a>变量和常量</h2><p>Java 支持的变量类型有：</p>
<ul>
<li><code>局部变量</code> - 类方法中的变量。</li>
<li><code>成员变量（也叫实例变量）</code> - 类方法外的变量，不过没有 <code>static</code> 修饰。</li>
<li><code>静态变量（也叫类变量）</code> - 类方法外的变量，用 <code>static</code> 修饰。</li>
</ul>
<p>特性对比：</p>
<table>
<thead>
<tr>
<th>局部变量</th>
<th>实例变量（也叫成员变量）</th>
<th>类变量（也叫静态变量）</th>
</tr>
</thead>
<tbody><tr>
<td>局部变量声明在方法、构造方法或者语句块中。</td>
<td>实例变量声明在方法、构造方法和语句块之外。</td>
<td>类变量声明在方法、构造方法和语句块之外。并且以 static 修饰。</td>
</tr>
<tr>
<td>局部变量在方法、构造方法、或者语句块被执行的时候创建，当它们执行完成后，变量将会被销毁。</td>
<td>实例变量在对象创建的时候创建，在对象被销毁的时候销毁。</td>
<td>类变量在第一次被访问时创建，在程序结束时销毁。</td>
</tr>
<tr>
<td>局部变量没有默认值，所以必须经过初始化，才可以使用。</td>
<td>实例变量具有默认值。数值型变量的默认值是 0，布尔型变量的默认值是 false，引用类型变量的默认值是 null。变量的值可以在声明时指定，也可以在构造方法中指定。</td>
<td>类变量具有默认值。数值型变量的默认值是 0，布尔型变量的默认值是 false，引用类型变量的默认值是 null。变量的值可以在声明时指定，也可以在构造方法中指定。此外，静态变量还可以在静态语句块中初始化。</td>
</tr>
<tr>
<td>对于局部变量，如果是基本类型，会把值直接存储在栈；如果是引用类型，会把其对象存储在堆，而把这个对象的引用（指针）存储在栈。</td>
<td>实例变量存储在堆。</td>
<td>类变量存储在静态存储区。</td>
</tr>
<tr>
<td>访问修饰符不能用于局部变量。</td>
<td>访问修饰符可以用于实例变量。</td>
<td>访问修饰符可以用于类变量。</td>
</tr>
<tr>
<td>局部变量只在声明它的方法、构造方法或者语句块中可见。</td>
<td>实例变量对于类中的方法、构造方法或者语句块是可见的。一般情况下应该把实例变量设为私有。通过使用访问修饰符可以使实例变量对子类可见。</td>
<td>与实例变量具有相似的可见性。但为了对类的使用者可见，大多数静态变量声明为 public 类型。</td>
</tr>
<tr>
<td></td>
<td>实例变量可以直接通过变量名访问。但在静态方法以及其他类中，就应该使用完全限定名：ObejectReference.VariableName。</td>
<td>静态变量可以通过：ClassName.VariableName 的方式访问。</td>
</tr>
<tr>
<td></td>
<td></td>
<td>无论一个类创建了多少个对象，类只拥有类变量的一份拷贝。</td>
</tr>
<tr>
<td></td>
<td></td>
<td>类变量除了被声明为常量外很少使用。</td>
</tr>
</tbody></table>
<p><strong>变量修饰符</strong></p>
<ul>
<li><strong>访问级别修饰符</strong><ul>
<li>如果变量是实例变量或类变量，可以添加访问级别修饰符（public&#x2F;protected&#x2F;private）</li>
</ul>
</li>
<li><strong>静态修饰符</strong><ul>
<li>如果变量是类变量，需要添加 static 修饰</li>
</ul>
</li>
<li><strong>final</strong><ul>
<li>如果变量使用 <code>final</code> 修饰符，就表示这是一个常量，不能被修改。</li>
</ul>
</li>
</ul>
<h2 id="数组"><a href="#数组" class="headerlink" title="数组"></a>数组</h2><p><img src="https://raw.githubusercontent.com/dunwu/images/master/cs/java/javacore/xmind/Java%E6%95%B0%E7%BB%84.svg" alt="img"></p>
<blockquote>
<p>👉 扩展阅读：<a href="https://dunwu.github.io/waterdrop/pages/ae0740ef/">深入理解 Java 数组</a></p>
</blockquote>
<h2 id="枚举"><a href="#枚举" class="headerlink" title="枚举"></a>枚举</h2><p><img src="https://raw.githubusercontent.com/dunwu/images/master/cs/java/javacore/xmind/Java%E6%9E%9A%E4%B8%BE.svg" alt="img"></p>
<blockquote>
<p>👉 扩展阅读：<a href="https://dunwu.github.io/waterdrop/pages/2f0a1ca4/">深入理解 Java 枚举</a></p>
</blockquote>
<h2 id="操作符"><a href="#操作符" class="headerlink" title="操作符"></a>操作符</h2><p>Java 中支持的操作符类型如下：</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/cs/java/javacore/xmind/Java%E6%93%8D%E4%BD%9C%E7%AC%A6.svg" alt="img"></p>
<blockquote>
<p>👉 扩展阅读：<a target="_blank" rel="noopener" href="http://www.runoob.com/java/java-operators.html">Java 操作符</a></p>
</blockquote>
<h2 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h2><p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/20220125072221.png" alt="img"></p>
<blockquote>
<p>👉 扩展阅读：<a href="https://dunwu.github.io/waterdrop/pages/e70c4bf9/">深入理解 Java 方法</a></p>
</blockquote>
<h2 id="控制语句"><a href="#控制语句" class="headerlink" title="控制语句"></a>控制语句</h2><p><img src="https://raw.githubusercontent.com/dunwu/images/master/cs/java/javacore/xmind/Java%E6%8E%A7%E5%88%B6%E8%AF%AD%E5%8F%A5.svg" alt="img"></p>
<blockquote>
<p>👉 扩展阅读：<a href="https://dunwu.github.io/waterdrop/pages/36fd1ce8/">Java 控制语句</a></p>
</blockquote>
<h2 id="异常"><a href="#异常" class="headerlink" title="异常"></a>异常</h2><p><img src="https://raw.githubusercontent.com/dunwu/images/master/cs/java/javacore/xmind/Java%E5%BC%82%E5%B8%B8%E6%A1%86%E6%9E%B6.svg" alt="img"></p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/cs/java/javacore/xmind/Java%E5%BC%82%E5%B8%B8.svg" alt="img"></p>
<blockquote>
<p>👉 扩展阅读：<a href="https://dunwu.github.io/waterdrop/pages/07ac0613/">深入理解 Java 异常</a></p>
</blockquote>
<h2 id="泛型"><a href="#泛型" class="headerlink" title="泛型"></a>泛型</h2><p><img src="https://raw.githubusercontent.com/dunwu/images/master/cs/java/javacore/xmind/Java%E6%B3%9B%E5%9E%8B.svg" alt="img"></p>
<blockquote>
<p>👉 扩展阅读：<a href="https://dunwu.github.io/waterdrop/pages/ddc68bb5/">深入理解 Java 泛型</a></p>
</blockquote>
<h2 id="反射"><a href="#反射" class="headerlink" title="反射"></a>反射</h2><p><img src="https://raw.githubusercontent.com/dunwu/images/master/cs/java/javacore/xmind/Java%E5%8F%8D%E5%B0%84.svg" alt="img"></p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/cs/java/javacore/xmind/Java%E4%BB%A3%E7%90%86.svg" alt="img"></p>
<blockquote>
<p>👉 扩展阅读：<a href="https://dunwu.github.io/waterdrop/pages/6ef470ed/">深入理解 Java 反射和动态代理</a></p>
</blockquote>
<h2 id="注解"><a href="#注解" class="headerlink" title="注解"></a>注解</h2><p><img src="https://raw.githubusercontent.com/dunwu/images/master/cs/java/javacore/xmind/%E6%B3%A8%E8%A7%A3%E7%AE%80%E4%BB%8B.svg" alt="img"></p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/cs/java/javacore/xmind/%E5%85%83%E6%B3%A8%E8%A7%A3.svg" alt="img"></p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/cs/java/javacore/xmind/%E5%86%85%E7%BD%AE%E6%B3%A8%E8%A7%A3.svg" alt="img"></p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/cs/java/javacore/xmind/%E8%87%AA%E5%AE%9A%E4%B9%89%E6%B3%A8%E8%A7%A3.svg" alt="img"></p>
<blockquote>
<p>👉 扩展阅读：<a href="https://dunwu.github.io/waterdrop/pages/56a4a49d/">深入理解 Java 注解</a></p>
</blockquote>
<h2 id="序列化"><a href="#序列化" class="headerlink" title="序列化"></a>序列化</h2><p><img src="https://raw.githubusercontent.com/dunwu/images/master/cs/java/javacore/xmind/Java%E5%BA%8F%E5%88%97%E5%8C%96.svg" alt="img"></p>
<blockquote>
<p>👉 扩展阅读：<a href="https://dunwu.github.io/waterdrop/pages/737e5233/">Java 序列化</a></p>
</blockquote>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://dunwu.github.io/blog/pages/3d7b99ac/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/uploads/avatar.gif">
      <meta itemprop="name" content="钝悟 ◾ Dunwu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dunwu Blog">
      <meta itemprop="description" content="钝悟的个人博客">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Dunwu Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/pages/3d7b99ac/" class="post-title-link" itemprop="url">Elasticsearch 优化</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-01-21 19:54:43" itemprop="dateCreated datePublished" datetime="2022-01-21T19:54:43+08:00">2022-01-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-09-13 17:56:53" itemprop="dateModified" datetime="2025-09-13T17:56:53+08:00">2025-09-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/" itemprop="url" rel="index"><span itemprop="name">数据库</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E%E6%95%B0%E6%8D%AE%E5%BA%93/" itemprop="url" rel="index"><span itemprop="name">搜索引擎数据库</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E%E6%95%B0%E6%8D%AE%E5%BA%93/elasticsearch/" itemprop="url" rel="index"><span itemprop="name">elasticsearch</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>9.5k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>9 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Elasticsearch-优化"><a href="#Elasticsearch-优化" class="headerlink" title="Elasticsearch 优化"></a>Elasticsearch 优化</h1><p>Elasticsearch 是当前流行的企业级搜索引擎，设计用于云计算中，能够达到实时搜索，稳定，可靠，快速，安装使用方便。作为一个开箱即用的产品，在生产环境上线之后，我们其实不一定能确保其的性能和稳定性。如何根据实际情况提高服务的性能，其实有很多技巧。这章我们分享从实战经验中总结出来的 elasticsearch 性能优化，主要从硬件配置优化、索引优化设置、查询方面优化、数据结构优化、集群架构优化等方面讲解。</p>
<h2 id="硬件配置优化"><a href="#硬件配置优化" class="headerlink" title="硬件配置优化"></a>硬件配置优化</h2><p>升级硬件设备配置一直都是提高服务能力最快速有效的手段，在系统层面能够影响应用性能的一般包括三个因素：CPU、内存和 IO，可以从这三方面进行 ES 的性能优化工作。</p>
<h3 id="CPU-配置"><a href="#CPU-配置" class="headerlink" title="CPU 配置"></a>CPU 配置</h3><p>一般说来，CPU 繁忙的原因有以下几个：</p>
<ol>
<li>线程中有无限空循环、无阻塞、正则匹配或者单纯的计算；</li>
<li>发生了频繁的 GC；</li>
<li>多线程的上下文切换；</li>
</ol>
<p>大多数 Elasticsearch 部署往往对 CPU 要求不高。因此，相对其它资源，具体配置多少个（CPU）不是那么关键。你应该选择具有多个内核的现代处理器，常见的集群使用 2 到 8 个核的机器。<strong>如果你要在更快的 CPUs 和更多的核数之间选择，选择更多的核数更好</strong>。多个内核提供的额外并发远胜过稍微快一点点的时钟频率。</p>
<h3 id="内存配置"><a href="#内存配置" class="headerlink" title="内存配置"></a>内存配置</h3><p>如果有一种资源是最先被耗尽的，它可能是内存。排序和聚合都很耗内存，所以有足够的堆空间来应付它们是很重要的。即使堆空间是比较小的时候，也能为操作系统文件缓存提供额外的内存。因为 Lucene 使用的许多数据结构是基于磁盘的格式，Elasticsearch 利用操作系统缓存能产生很大效果。</p>
<p><strong>64 GB 内存的机器是非常理想的</strong>，但是 32 GB 和 16 GB 机器也是很常见的。少于 8 GB 会适得其反（你最终需要很多很多的小机器），大于 64 GB 的机器也会有问题。</p>
<p>由于 ES 构建基于 lucene，而 lucene 设计强大之处在于 lucene 能够很好的利用操作系统内存来缓存索引数据，以提供快速的查询性能。lucene 的索引文件 segements 是存储在单文件中的，并且不可变，对于 OS 来说，能够很友好地将索引文件保持在 cache 中，以便快速访问；因此，我们很有必要将一半的物理内存留给 lucene；另一半的物理内存留给 ES（JVM heap）。</p>
<h4 id="内存分配"><a href="#内存分配" class="headerlink" title="内存分配"></a>内存分配</h4><p>当机器内存小于 64G 时，遵循通用的原则，50% 给 ES，50% 留给 lucene。</p>
<p>当机器内存大于 64G 时，遵循以下原则：</p>
<ul>
<li>如果主要的使用场景是全文检索，那么建议给 ES Heap 分配 4~32G 的内存即可；其它内存留给操作系统，供 lucene 使用（segments cache），以提供更快的查询性能。</li>
<li>如果主要的使用场景是聚合或排序，并且大多数是 numerics，dates，geo_points 以及 not_analyzed 的字符类型，建议分配给 ES Heap 分配 4~32G 的内存即可，其它内存留给操作系统，供 lucene 使用，提供快速的基于文档的聚类、排序性能。</li>
<li>如果使用场景是聚合或排序，并且都是基于 analyzed 字符数据，这时需要更多的 heap size，建议机器上运行多 ES 实例，每个实例保持不超过 50% 的 ES heap 设置（但不超过 32 G，堆内存设置 32 G 以下时，JVM 使用对象指标压缩技巧节省空间），50% 以上留给 lucene。</li>
</ul>
<h4 id="禁止-swap"><a href="#禁止-swap" class="headerlink" title="禁止 swap"></a>禁止 swap</h4><p>禁止 swap，一旦允许内存与磁盘的交换，会引起致命的性能问题。可以通过在 elasticsearch.yml 中 <code>bootstrap.memory_lock: true</code>，以保持 JVM 锁定内存，保证 ES 的性能。</p>
<h4 id="GC-设置"><a href="#GC-设置" class="headerlink" title="GC 设置"></a>GC 设置</h4><p>保持 GC 的现有设置，默认设置为：Concurrent-Mark and Sweep（CMS），别换成 G1 GC，因为目前 G1 还有很多 BUG。</p>
<p>保持线程池的现有设置，目前 ES 的线程池较 1.X 有了较多优化设置，保持现状即可；默认线程池大小等于 CPU 核心数。如果一定要改，按公式 ( ( CPU 核心数 * 3 ) &#x2F; 2 ) + 1 设置；不能超过 CPU 核心数的 2 倍；但是不建议修改默认配置，否则会对 CPU 造成硬伤。</p>
<h3 id="磁盘"><a href="#磁盘" class="headerlink" title="磁盘"></a>磁盘</h3><p>硬盘对所有的集群都很重要，对大量写入的集群更是加倍重要（例如那些存储日志数据的）。硬盘是服务器上最慢的子系统，这意味着那些写入量很大的集群很容易让硬盘饱和，使得它成为集群的瓶颈。</p>
<p><strong>在经济压力能承受的范围下，尽量使用固态硬盘（SSD）</strong>。固态硬盘相比于任何旋转介质（机械硬盘，磁带等），无论随机写还是顺序写，都会对 IO 有较大的提升。</p>
<blockquote>
<p>如果你正在使用 SSDs，确保你的系统 I&#x2F;O 调度程序是配置正确的。当你向硬盘写数据，I&#x2F;O 调度程序决定何时把数据实际发送到硬盘。大多数默认 *nix 发行版下的调度程序都叫做 cfq（完全公平队列）。</p>
<p>调度程序分配时间片到每个进程。并且优化这些到硬盘的众多队列的传递。但它是为旋转介质优化的：机械硬盘的固有特性意味着它写入数据到基于物理布局的硬盘会更高效。</p>
<p>这对 SSD 来说是低效的，尽管这里没有涉及到机械硬盘。但是，deadline 或者 noop 应该被使用。deadline 调度程序基于写入等待时间进行优化，noop 只是一个简单的 FIFO 队列。</p>
<p>这个简单的更改可以带来显著的影响。仅仅是使用正确的调度程序，我们看到了 500 倍的写入能力提升。</p>
</blockquote>
<p><strong>如果你使用旋转介质（如机械硬盘），尝试获取尽可能快的硬盘（高性能服务器硬盘，15k RPM 驱动器）</strong>。</p>
<p><strong>使用 RAID0 是提高硬盘速度的有效途径，对机械硬盘和 SSD 来说都是如此</strong>。没有必要使用镜像或其它 RAID 变体，因为 Elasticsearch 在自身层面通过副本，已经提供了备份的功能，所以不需要利用磁盘的备份功能，同时如果使用磁盘备份功能的话，对写入速度有较大的影响。</p>
<p><strong>最后，避免使用网络附加存储（NAS）</strong>。人们常声称他们的 NAS 解决方案比本地驱动器更快更可靠。除却这些声称，我们从没看到 NAS 能配得上它的大肆宣传。NAS 常常很慢，显露出更大的延时和更宽的平均延时方差，而且它是单点故障的。</p>
<h2 id="索引优化设置"><a href="#索引优化设置" class="headerlink" title="索引优化设置"></a>索引优化设置</h2><p>索引优化主要是在 Elasticsearch 的插入层面优化，Elasticsearch 本身索引速度其实还是蛮快的，具体数据，我们可以参考官方的 benchmark 数据。我们可以根据不同的需求，针对索引优化。</p>
<h3 id="批量提交"><a href="#批量提交" class="headerlink" title="批量提交"></a>批量提交</h3><p>当有大量数据提交的时候，建议采用批量提交（Bulk 操作）；此外使用 bulk 请求时，每个请求不超过几十 M，因为太大会导致内存使用过大。</p>
<p>比如在做 ELK 过程中，Logstash indexer 提交数据到 Elasticsearch 中，batch size 就可以作为一个优化功能点。但是优化 size 大小需要根据文档大小和服务器性能而定。</p>
<p>像 Logstash 中提交文档大小超过 20MB，Logstash 会将一个批量请求切分为多个批量请求。</p>
<p>如果在提交过程中，遇到 EsRejectedExecutionException 异常的话，则说明集群的索引性能已经达到极限了。这种情况，要么提高服务器集群的资源，要么根据业务规则，减少数据收集速度，比如只收集 Warn、Error 级别以上的日志。</p>
<h3 id="增加-Refresh-时间间隔"><a href="#增加-Refresh-时间间隔" class="headerlink" title="增加 Refresh 时间间隔"></a>增加 Refresh 时间间隔</h3><p>为了提高索引性能，Elasticsearch 在写入数据的时候，采用延迟写入的策略，即数据先写到内存中，当超过默认 1 秒（index.refresh_interval）会进行一次写入操作，就是将内存中 segment 数据刷新到磁盘中，此时我们才能将数据搜索出来，所以这就是为什么 Elasticsearch 提供的是近实时搜索功能，而不是实时搜索功能。</p>
<p>如果我们的系统对数据延迟要求不高的话，我们<strong>可以通过延长 refresh 时间间隔，可以有效地减少 segment 合并压力，提高索引速度</strong>。比如在做全链路跟踪的过程中，我们就将 <code>index.refresh_interval</code> 设置为 30s，减少 refresh 次数。再如，在进行全量索引时，可以将 refresh 次数临时关闭，即 <code>index.refresh_interval</code> 设置为-1，数据导入成功后再打开到正常模式，比如 30s。</p>
<blockquote>
<p>在加载大量数据时候可以暂时不用 refresh 和 repliccas，index.refresh_interval 设置为-1，index.number_of_replicas 设置为 0。</p>
</blockquote>
<h3 id="修改-index-buffer-size-的设置"><a href="#修改-index-buffer-size-的设置" class="headerlink" title="修改 index_buffer_size 的设置"></a>修改 index_buffer_size 的设置</h3><p>索引缓冲的设置可以控制多少内存分配给索引进程。这是一个全局配置，会应用于一个节点上所有不同的分片上。</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">indices.memory.index_buffer_size:</span> <span class="number">10</span><span class="string">%</span></span><br><span class="line"><span class="attr">indices.memory.min_index_buffer_size:</span> <span class="string">48mb</span></span><br></pre></td></tr></table></figure>

<p><code>indices.memory.index_buffer_size</code> 接受一个百分比或者一个表示字节大小的值。默认是 10%，意味着分配给节点的总内存的 10%用来做索引缓冲的大小。这个数值被分到不同的分片（shards）上。如果设置的是百分比，还可以设置 <code>min_index_buffer_size</code> （默认 48mb）和 <code>max_index_buffer_size</code>（默认没有上限）。</p>
<h3 id="修改-translog-相关的设置"><a href="#修改-translog-相关的设置" class="headerlink" title="修改 translog 相关的设置"></a>修改 translog 相关的设置</h3><p>一是控制数据从内存到硬盘的操作频率，以减少硬盘 IO。可将 sync_interval 的时间设置大一些。默认为 5s。</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">index.translog.sync_interval:</span> <span class="string">5s</span></span><br></pre></td></tr></table></figure>

<p>也可以控制 tranlog 数据块的大小，达到 threshold 大小时，才会 flush 到 lucene 索引文件。默认为 512m。</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">index.translog.flush_threshold_size:</span> <span class="string">512mb</span></span><br></pre></td></tr></table></figure>

<h3 id="注意-id-字段的使用"><a href="#注意-id-字段的使用" class="headerlink" title="注意 _id 字段的使用"></a>注意 <code>_id</code> 字段的使用</h3><p><code>_id</code> 字段的使用，应尽可能避免自定义 <code>_id</code>，以避免针对 ID 的版本管理；建议使用 ES 的默认 ID 生成策略或使用数字类型 ID 做为主键。</p>
<h3 id="注意-all-字段及-source-字段的使用"><a href="#注意-all-字段及-source-字段的使用" class="headerlink" title="注意 _all 字段及 _source 字段的使用"></a>注意 _all 字段及 _source 字段的使用</h3><p>**_**all 字段及 _source 字段的使用，应该注意场景和需要，_all 字段包含了所有的索引字段，方便做全文检索，如果无此需求，可以禁用；_source 存储了原始的 document 内容，如果没有获取原始文档数据的需求，可通过设置 includes、excludes 属性来定义放入 _source 的字段。</p>
<h3 id="合理的配置使用-index-属性"><a href="#合理的配置使用-index-属性" class="headerlink" title="合理的配置使用 index 属性"></a>合理的配置使用 index 属性</h3><p>合理的配置使用 index 属性，analyzed 和 not_analyzed，根据业务需求来控制字段是否分词或不分词。只有 groupby 需求的字段，配置时就设置成 not_analyzed，以提高查询或聚类的效率。</p>
<h3 id="减少副本数量"><a href="#减少副本数量" class="headerlink" title="减少副本数量"></a>减少副本数量</h3><p>Elasticsearch 默认副本数量为 3 个，虽然这样会提高集群的可用性，增加搜索的并发数，但是同时也会影响写入索引的效率。</p>
<p>在索引过程中，需要把更新的文档发到副本节点上，等副本节点生效后在进行返回结束。使用 Elasticsearch 做业务搜索的时候，建议副本数目还是设置为 3 个，但是像内部 ELK 日志系统、分布式跟踪系统中，完全可以将副本数目设置为 1 个。</p>
<h2 id="查询方面优化"><a href="#查询方面优化" class="headerlink" title="查询方面优化"></a>查询方面优化</h2><p>Elasticsearch 作为业务搜索的近实时查询时，查询效率的优化显得尤为重要。</p>
<h3 id="路由优化"><a href="#路由优化" class="headerlink" title="路由优化"></a>路由优化</h3><p>当我们查询文档的时候，Elasticsearch 如何知道一个文档应该存放到哪个分片中呢？它其实是通过下面这个公式来计算出来的。</p>
<figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">shard</span> <span class="operator">=</span> hash(routing) % number_of_primary_shards</span><br></pre></td></tr></table></figure>

<p>routing 默认值是文档的 id，也可以采用自定义值，比如用户 ID。</p>
<h4 id="不带-routing-查询"><a href="#不带-routing-查询" class="headerlink" title="不带 routing 查询"></a>不带 routing 查询</h4><p>在查询的时候因为不知道要查询的数据具体在哪个分片上，所以整个过程分为 2 个步骤：</p>
<ol>
<li>分发：请求到达协调节点后，协调节点将查询请求分发到每个分片上。</li>
<li>聚合：协调节点搜集到每个分片上查询结果，再将查询的结果进行排序，之后给用户返回结果。</li>
</ol>
<h4 id="带-routing-查询"><a href="#带-routing-查询" class="headerlink" title="带 routing 查询"></a>带 routing 查询</h4><p>查询的时候，可以直接根据 routing 信息定位到某个分配查询，不需要查询所有的分配，经过协调节点排序。</p>
<p>向上面自定义的用户查询，如果 routing 设置为 userid 的话，就可以直接查询出数据来，效率提升很多。</p>
<h3 id="Filter-VS-Query"><a href="#Filter-VS-Query" class="headerlink" title="Filter VS Query"></a>Filter VS Query</h3><p>尽可能使用过滤器上下文（Filter）替代查询上下文（Query）</p>
<ul>
<li>Query：此文档与此查询子句的匹配程度如何？</li>
<li>Filter：此文档和查询子句匹配吗？</li>
</ul>
<p>Elasticsearch 针对 Filter 查询只需要回答“是”或者“否”，不需要像 Query 查询一样计算相关性分数，同时 Filter 结果可以缓存。</p>
<h3 id="深度翻页"><a href="#深度翻页" class="headerlink" title="深度翻页"></a>深度翻页</h3><p>在使用 Elasticsearch 过程中，应尽量避免大翻页的出现。</p>
<p>正常翻页查询都是从 from 开始 size 条数据，这样就需要在每个分片中查询打分排名在前面的 from+size 条数据。协同节点收集每个分配的前 from+size 条数据。协同节点一共会受到 N*(from+size) 条数据，然后进行排序，再将其中 from 到 from+size 条数据返回出去。如果 from 或者 size 很大的话，导致参加排序的数量会同步扩大很多，最终会导致 CPU 资源消耗增大。</p>
<p>可以通过使用 Elasticsearch scroll 和 scroll-scan 高效滚动的方式来解决这样的问题。</p>
<p>也可以结合实际业务特点，文档 id 大小如果和文档创建时间是一致有序的，可以以文档 id 作为分页的偏移量，并将其作为分页查询的一个条件。</p>
<h3 id="脚本（script）合理使用"><a href="#脚本（script）合理使用" class="headerlink" title="脚本（script）合理使用"></a>脚本（script）合理使用</h3><p>我们知道脚本使用主要有 3 种形式，内联动态编译方式、_script 索引库中存储和文件脚本存储的形式；一般脚本的使用场景是粗排，尽量用第二种方式先将脚本存储在 _script 索引库中，起到提前编译，然后通过引用脚本 id，并结合 params 参数使用，即可以达到模型（逻辑）和数据进行了分离，同时又便于脚本模块的扩展与维护。具体 ES 脚本的深入内容请参考 <a target="_blank" rel="noopener" href="https://www.knowledgedict.com/tutorial/elasticsearch-script.html">Elasticsearch 脚本模块的详解</a>。</p>
<h2 id="数据结构优化"><a href="#数据结构优化" class="headerlink" title="数据结构优化"></a>数据结构优化</h2><p>基于 Elasticsearch 的使用场景，文档数据结构尽量和使用场景进行结合，去掉没用及不合理的数据。</p>
<h3 id="尽量减少不需要的字段"><a href="#尽量减少不需要的字段" class="headerlink" title="尽量减少不需要的字段"></a>尽量减少不需要的字段</h3><p>如果 Elasticsearch 用于业务搜索服务，一些不需要用于搜索的字段最好不存到 ES 中，这样即节省空间，同时在相同的数据量下，也能提高搜索性能。</p>
<p>避免使用动态值作字段，动态递增的 mapping，会导致集群崩溃；同样，也需要控制字段的数量，业务中不使用的字段，就不要索引。控制索引的字段数量、mapping 深度、索引字段的类型，对于 ES 的性能优化是重中之重。</p>
<p>以下是 ES 关于字段数、mapping 深度的一些默认设置：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">index.mapping.nested_objects.limit:</span> <span class="number">10000</span></span><br><span class="line"><span class="attr">index.mapping.total_fields.limit:</span> <span class="number">1000</span></span><br><span class="line"><span class="attr">index.mapping.depth.limit:</span> <span class="number">20</span></span><br></pre></td></tr></table></figure>

<h3 id="Nested-Object-vs-Parent-Child"><a href="#Nested-Object-vs-Parent-Child" class="headerlink" title="Nested Object vs Parent&#x2F;Child"></a>Nested Object vs Parent&#x2F;Child</h3><p>尽量避免使用 nested 或 parent&#x2F;child 的字段，能不用就不用；nested query 慢，parent&#x2F;child query 更慢，比 nested query 慢上百倍；因此能在 mapping 设计阶段搞定的（大宽表设计或采用比较 smart 的数据结构），就不要用父子关系的 mapping。</p>
<p>如果一定要使用 nested fields，保证 nested fields 字段不能过多，目前 ES 默认限制是 50。因为针对 1 个 document，每一个 nested field，都会生成一个独立的 document，这将使 doc 数量剧增，影响查询效率，尤其是 JOIN 的效率。</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">index.mapping.nested_fields.limit:</span> <span class="number">50</span></span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th align="left">对比</th>
<th align="left">Nested Object</th>
<th align="left">Parent&#x2F;Child</th>
</tr>
</thead>
<tbody><tr>
<td align="left">优点</td>
<td align="left">文档存储在一起，因此读取性高</td>
<td align="left">父子文档可以独立更新，互不影响</td>
</tr>
<tr>
<td align="left">缺点</td>
<td align="left">更新父文档或子文档时需要更新整个文档</td>
<td align="left">为了维护 join 关系，需要占用部分内存，读取性能较差</td>
</tr>
<tr>
<td align="left">场景</td>
<td align="left">子文档偶尔更新，查询频繁</td>
<td align="left">子文档更新频繁</td>
</tr>
</tbody></table>
<h3 id="选择静态映射，非必需时，禁止动态映射"><a href="#选择静态映射，非必需时，禁止动态映射" class="headerlink" title="选择静态映射，非必需时，禁止动态映射"></a>选择静态映射，非必需时，禁止动态映射</h3><p>尽量避免使用动态映射，这样有可能会导致集群崩溃，此外，动态映射有可能会带来不可控制的数据类型，进而有可能导致在查询端出现相关异常，影响业务。</p>
<p>此外，Elasticsearch 作为搜索引擎时，主要承载 query 的匹配和排序的功能，那数据的存储类型基于这两种功能的用途分为两类，一是需要匹配的字段，用来建立倒排索引对 query 匹配用，另一类字段是用做粗排用到的特征字段，如 ctr、点击数、评论数等等。</p>
<h2 id="集群架构设计"><a href="#集群架构设计" class="headerlink" title="集群架构设计"></a>集群架构设计</h2><p>合理的部署 Elasticsearch 有助于提高服务的整体可用性。</p>
<h3 id="主节点、数据节点和协调节点分离"><a href="#主节点、数据节点和协调节点分离" class="headerlink" title="主节点、数据节点和协调节点分离"></a>主节点、数据节点和协调节点分离</h3><p>Elasticsearch 集群在架构拓朴时，采用主节点、数据节点和负载均衡节点分离的架构，在 5.x 版本以后，又可将数据节点再细分为“Hot-Warm”的架构模式。</p>
<p>Elasticsearch 的配置文件中有 2 个参数，node.master 和 node.data。这两个参数搭配使用时，能够帮助提供服务器性能。</p>
<h4 id="主（master）节点"><a href="#主（master）节点" class="headerlink" title="主（master）节点"></a>主（master）节点</h4><p>配置 <code>node.master:true</code> 和 <code>node.data:false</code>，该 node 服务器只作为一个主节点，但不存储任何索引数据。我们推荐每个集群运行 3 个专用的 master 节点来提供最好的弹性。使用时，你还需要将 <code>discovery.zen.minimum_master_nodes setting</code> 参数设置为 2，以免出现脑裂（split-brain）的情况。用 3 个专用的 master 节点，专门负责处理集群的管理以及加强状态的整体稳定性。因为这 3 个 master 节点不包含数据也不会实际参与搜索以及索引操作，在 JVM 上它们不用做相同的事，例如繁重的索引或者耗时，资源耗费很大的搜索。因此不太可能会因为垃圾回收而导致停顿。因此，master 节点的 CPU，内存以及磁盘配置可以比 data 节点少很多的。</p>
<h4 id="数据（data）节点"><a href="#数据（data）节点" class="headerlink" title="数据（data）节点"></a>数据（data）节点</h4><p>配置 <code>node.master:false</code> 和 <code>node.data:true</code>，该 node 服务器只作为一个数据节点，只用于存储索引数据，使该 node 服务器功能单一，只用于数据存储和数据查询，降低其资源消耗率。</p>
<p>在 Elasticsearch 5.x 版本之后，data 节点又可再细分为“Hot-Warm”架构，即分为热节点（hot node）和暖节点（warm node）。</p>
<p>hot 节点：</p>
<p>hot 节点主要是索引节点（写节点），同时会保存近期的一些频繁被查询的索引。由于进行索引非常耗费 CPU 和 IO，即属于 IO 和 CPU 密集型操作，建议使用 SSD 的磁盘类型，保持良好的写性能；我们推荐部署最小化的 3 个 hot 节点来保证高可用性。根据近期需要收集以及查询的数据量，可以增加服务器数量来获得想要的性能。</p>
<p>将节点设置为 hot 类型需要 elasticsearch.yml 如下配置：</p>
<figure class="highlight elm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">node</span>.attr.box_<span class="keyword">type</span>: hot</span><br></pre></td></tr></table></figure>

<p>如果是针对指定的 index 操作，可以通过 settings 设置 <code>index.routing.allocation.require.box_type: hot</code> 将索引写入 hot 节点。</p>
<p>warm 节点：</p>
<p>这种类型的节点是为了处理大量的，而且不经常访问的只读索引而设计的。由于这些索引是只读的，warm 节点倾向于挂载大量磁盘（普通磁盘）来替代 SSD。内存、CPU 的配置跟 hot 节点保持一致即可；节点数量一般也是大于等于 3 个。</p>
<p>将节点设置为 warm 类型需要 elasticsearch.yml 如下配置：</p>
<figure class="highlight elm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">node</span>.attr.box_<span class="keyword">type</span>: warm</span><br></pre></td></tr></table></figure>

<p>同时，也可以在 elasticsearch.yml 中设置 <code>index.codec:best_compression</code> 保证 warm 节点的压缩配置。</p>
<p>当索引不再被频繁查询时，可通过 <code>index.routing.allocation.require.box_type:warm</code>，将索引标记为 warm，从而保证索引不写入 hot 节点，以便将 SSD 磁盘资源用在刀刃上。一旦设置这个属性，ES 会自动将索引合并到 warm 节点。</p>
<h4 id="协调（coordinating）节点"><a href="#协调（coordinating）节点" class="headerlink" title="协调（coordinating）节点"></a>协调（coordinating）节点</h4><p>协调节点用于做分布式里的协调，将各分片或节点返回的数据整合后返回。该节点不会被选作主节点，也不会存储任何索引数据。该服务器主要用于查询负载均衡。在查询的时候，通常会涉及到从多个 node 服务器上查询数据，并将请求分发到多个指定的 node 服务器，并对各个 node 服务器返回的结果进行一个汇总处理，最终返回给客户端。在 ES 集群中，所有的节点都有可能是协调节点，但是，可以通过设置 <code>node.master</code>、<code>node.data</code>、<code>node.ingest</code> 都为 <code>false</code> 来设置专门的协调节点。需要较好的 CPU 和较高的内存。</p>
<ul>
<li>node.master:false 和 node.data:true，该 node 服务器只作为一个数据节点，只用于存储索引数据，使该 node 服务器功能单一，只用于数据存储和数据查询，降低其资源消耗率。</li>
<li>node.master:true 和 node.data:false，该 node 服务器只作为一个主节点，但不存储任何索引数据，该 node 服务器将使用自身空闲的资源，来协调各种创建索引请求或者查询请求，并将这些请求合理分发到相关的 node 服务器上。</li>
<li>node.master:false 和 node.data:false，该 node 服务器即不会被选作主节点，也不会存储任何索引数据。该服务器主要用于查询负载均衡。在查询的时候，通常会涉及到从多个 node 服务器上查询数据，并将请求分发到多个指定的 node 服务器，并对各个 node 服务器返回的结果进行一个汇总处理，最终返回给客户端。</li>
</ul>
<h3 id="关闭-data-节点服务器中的-http-功能"><a href="#关闭-data-节点服务器中的-http-功能" class="headerlink" title="关闭 data 节点服务器中的 http 功能"></a>关闭 data 节点服务器中的 http 功能</h3><p>针对 Elasticsearch 集群中的所有数据节点，不用开启 http 服务。将其中的配置参数这样设置，<code>http.enabled:false</code>，同时也不要安装 head, bigdesk, marvel 等监控插件，这样保证 data 节点服务器只需处理创建&#x2F;更新&#x2F;删除&#x2F;查询索引数据等操作。</p>
<p>http 功能可以在非数据节点服务器上开启，上述相关的监控插件也安装到这些服务器上，用于监控 Elasticsearch 集群状态等数据信息。这样做一来出于数据安全考虑，二来出于服务性能考虑。</p>
<h3 id="一台服务器上最好只部署一个-node"><a href="#一台服务器上最好只部署一个-node" class="headerlink" title="一台服务器上最好只部署一个 node"></a>一台服务器上最好只部署一个 node</h3><p>一台物理服务器上可以启动多个 node 服务器节点（通过设置不同的启动 port），但一台服务器上的 CPU、内存、硬盘等资源毕竟有限，从服务器性能考虑，不建议一台服务器上启动多个 node 节点。</p>
<h3 id="集群分片设置"><a href="#集群分片设置" class="headerlink" title="集群分片设置"></a>集群分片设置</h3><p>ES 一旦创建好索引后，就无法调整分片的设置，而在 ES 中，一个分片实际上对应一个 lucene 索引，而 lucene 索引的读写会占用很多的系统资源，因此，分片数不能设置过大；所以，在创建索引时，合理配置分片数是非常重要的。一般来说，我们遵循一些原则：</p>
<ol>
<li>控制每个分片占用的硬盘容量不超过 ES 的最大 JVM 的堆空间设置（一般设置不超过 32 G，参考上面的 JVM 内存设置原则），因此，如果索引的总容量在 500 G 左右，那分片大小在 16 个左右即可；当然，最好同时考虑原则 2。</li>
<li>考虑一下 node 数量，一般一个节点有时候就是一台物理机，如果分片数过多，大大超过了节点数，很可能会导致一个节点上存在多个分片，一旦该节点故障，即使保持了 1 个以上的副本，同样有可能会导致数据丢失，集群无法恢复。所以，<strong>一般都设置分片数不超过节点数的 3 倍</strong>。</li>
</ol>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a target="_blank" rel="noopener" href="https://www.knowledgedict.com/tutorial/elasticsearch-intro.html">Elasticsearch 教程</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://dunwu.github.io/blog/pages/f8ea2ae7/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/uploads/avatar.gif">
      <meta itemprop="name" content="钝悟 ◾ Dunwu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dunwu Blog">
      <meta itemprop="description" content="钝悟的个人博客">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Dunwu Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/pages/f8ea2ae7/" class="post-title-link" itemprop="url">Elasticsearch 聚合</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-01-19 22:49:16" itemprop="dateCreated datePublished" datetime="2022-01-19T22:49:16+08:00">2022-01-19</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-09-13 17:56:53" itemprop="dateModified" datetime="2025-09-13T17:56:53+08:00">2025-09-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/" itemprop="url" rel="index"><span itemprop="name">数据库</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E%E6%95%B0%E6%8D%AE%E5%BA%93/" itemprop="url" rel="index"><span itemprop="name">搜索引擎数据库</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E%E6%95%B0%E6%8D%AE%E5%BA%93/elasticsearch/" itemprop="url" rel="index"><span itemprop="name">elasticsearch</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>25k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>23 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Elasticsearch-聚合"><a href="#Elasticsearch-聚合" class="headerlink" title="Elasticsearch 聚合"></a>Elasticsearch 聚合</h1><p>::: info 概述</p>
<p>在数据库中，聚合是指将数据进行分组统计，得到一个汇总的结果。例如，计算总和、平均值、最大值或最小值等操作。</p>
<p>Elasticsearch 将聚合分为三类：</p>
<table>
<thead>
<tr>
<th>类型</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations-metrics.html"><strong>Metric（指标聚合）</strong></a></td>
<td>根据字段值进行<strong>统计</strong>计算</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations-bucket.html"><strong>Bucket（桶聚合）</strong></a></td>
<td>根据字段值、范围或其他条件进行<strong>分组</strong></td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations-pipeline.html"><strong>Pipeline（管道聚合）</strong></a></td>
<td>对其他聚合输出的结果进行<strong>再次聚合</strong></td>
</tr>
</tbody></table>
<p>本文将逐一介绍这几种聚合方式的用法和特性。</p>
<p>:::</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/blog/pages/f8ea2ae7/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://dunwu.github.io/blog/pages/47b49254/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/uploads/avatar.gif">
      <meta itemprop="name" content="钝悟 ◾ Dunwu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dunwu Blog">
      <meta itemprop="description" content="钝悟的个人博客">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Dunwu Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/pages/47b49254/" class="post-title-link" itemprop="url">Elasticsearch 搜索（下）</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-01-18 08:01:08" itemprop="dateCreated datePublished" datetime="2022-01-18T08:01:08+08:00">2022-01-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-09-13 17:56:53" itemprop="dateModified" datetime="2025-09-13T17:56:53+08:00">2025-09-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/" itemprop="url" rel="index"><span itemprop="name">数据库</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E%E6%95%B0%E6%8D%AE%E5%BA%93/" itemprop="url" rel="index"><span itemprop="name">搜索引擎数据库</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E%E6%95%B0%E6%8D%AE%E5%BA%93/elasticsearch/" itemprop="url" rel="index"><span itemprop="name">elasticsearch</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>22k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>20 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Elasticsearch-搜索（下）"><a href="#Elasticsearch-搜索（下）" class="headerlink" title="Elasticsearch 搜索（下）"></a>Elasticsearch 搜索（下）</h1><p>Elasticsearch 提供了基于 JSON 的 DSL（Domain Specific Language）来定义查询。</p>
<p>可以将 DSL 视为查询的 AST（抽象语法树），由两种类型的子句组成：</p>
<ul>
<li>叶子查询 - 在指定字段中查找特定值，例如：<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-match-query.html"><code>match</code></a>、<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-term-query.html"><code>term</code></a> 和 <a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-range-query.html"><code>range</code></a>。</li>
<li>组合查询 - 组合其他叶子查询或组合查询，用于以逻辑方式组合多个查询（例如： <a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-bool-query.html"><code>bool</code></a>、<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-dis-max-query.html"><code>dis_max</code></a>），或更改它们的行为（例如：<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-constant-score-query.html"><code>constant_score</code></a>）。</li>
</ul>
<p>查询子句的行为会有所不同，具体取决于它们是在 query content 还是 filter context 中使用。</p>
<ul>
<li><code>query</code> context - <strong>有相关性计算</strong>，采用相关性算法，计算文档与查询关键词之间的相关度，并根据评分（<code>_score</code>）大小排序。</li>
<li><code>filter</code> context - <strong>无相关性计算</strong>，可以利用缓存，性能更好。</li>
</ul>
<p>从用法角度，Elasticsearch 查询分类大致分为：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/compound-queries.html">Compound（组合查询）</a></li>
<li><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/term-level-queries.html">Term-level（词项查询）</a></li>
<li><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/full-text-queries.html">Full text（全文查询）</a></li>
<li><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/joining-queries.html">Joining（联结查询）</a></li>
<li><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/specialized-queries.html">Specialized（专用查询）</a></li>
<li><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/geo-queries.html">Geo（地理位置查询）</a></li>
<li><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/span-queries.html">Span（跨度查询）</a></li>
<li><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/vector-queries.html">Vector（向量查询）</a></li>
<li><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/shape-queries.html">Shape（形状查询）</a></li>
</ul>
<h2 id="全文查询"><a href="#全文查询" class="headerlink" title="全文查询"></a>全文查询</h2><p><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/full-text-queries.html">Full Text Search（全文搜索）</a> 支持在非结构化文本数据中搜索与查询关键字最匹配的数据。</p>
<p>在 ES 中，支持以下全文搜索方式：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-intervals-query.html">intervals</a> - 根据匹配词的顺序和近似度返回文档。</li>
<li><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-match-query.html">match</a> - <strong>匹配查询</strong>，用于执行全文搜索的标准查询，包括模糊匹配和短语或邻近查询。</li>
<li><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-match-bool-prefix-query.html">match_bool_prefix</a> - 对检索文本分词，并根据这些分词构造一个布尔查询。除了最后一个分词之外的每个分词都进行 term 查询。最后一个分词用于 <code>prefix</code> 查询；其他分词都进行 <code>term</code> 查询。</li>
<li><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-match-query-phrase.html">match_phrase</a> - <strong>短语匹配查询</strong>，短语匹配会将检索内容分词，这些词语必须全部出现在被检索内容中，并且顺序必须一致，默认情况下这些词都必须连续。</li>
<li><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-match-query-phrase-prefix.html">match_phrase_prefix</a> - 与 <code>match_phrase</code> 查询类似，但对最后一个单词执行通配符搜索。</li>
<li><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-multi-match-query.html">multi_match</a> 支持多字段 match 查询</li>
<li><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-combined-fields-query.html">combined_fields</a> - 匹配多个字段，就像它们已索引到一个组合字段中一样。</li>
<li><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-query-string-query.html">query_string</a> - 支持紧凑的 Lucene <a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/8.16/query-dsl-query-string-query.html#query-string-syntax">query string（查询字符串）语法</a>，允许指定 <code>AND|OR|NOT</code> 条件和单个查询字符串中的多字段搜索。仅适用于专家用户。</li>
<li><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-simple-query-string-query.html">simple_query_string</a> - 更简单、更健壮的 <code>query_string</code> 语法版本，适合直接向用户公开。</li>
</ul>
<h3 id="match（匹配查询）"><a href="#match（匹配查询）" class="headerlink" title="match（匹配查询）"></a>match（匹配查询）</h3><p><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-match-query.html"><strong><code>match</code></strong></a> 查询用于搜索单个字段。首先，会针对检索文本进行解析（分词），分词后的任何一个词项只要被匹配，文档就会被搜到。默认情况下，相当于对分词后词项进行 or 匹配操作。</p>
<p>:::details match 示例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">GET kibana_sample_data_ecommerce/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;customer_full_name&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;query&quot;</span>: <span class="string">&quot;George Hubbard&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>响应结果：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;took&quot;</span><span class="punctuation">:</span> <span class="number">891</span><span class="punctuation">,</span> <span class="comment">// 查询使用的毫秒数</span></span><br><span class="line">  <span class="attr">&quot;timed_out&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span> <span class="comment">// 是否有分片超时，也就是说是否只返回了部分结果</span></span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="comment">// 总分片数、响应成功/失败数量信息</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;successful&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;skipped&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;failed&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;hits&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="comment">// 搜索结果</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="comment">// 匹配的总记录数</span></span><br><span class="line">      <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="number">82</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;relation&quot;</span><span class="punctuation">:</span> <span class="string">&quot;eq&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;max_score&quot;</span><span class="punctuation">:</span> <span class="number">10.018585</span><span class="punctuation">,</span> <span class="comment">// 所有匹配文档中的最大相关性分值</span></span><br><span class="line">    <span class="attr">&quot;hits&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="comment">// 匹配文档列表</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;_index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;kibana_sample_data_ecommerce&quot;</span><span class="punctuation">,</span> <span class="comment">// 文档所属索引</span></span><br><span class="line">        <span class="attr">&quot;_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;_doc&quot;</span><span class="punctuation">,</span> <span class="comment">// 文档所属 type</span></span><br><span class="line">        <span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2ZUtBX4BU8KXl1YJRBrH&quot;</span><span class="punctuation">,</span> <span class="comment">// 文档的唯一性标识</span></span><br><span class="line">        <span class="attr">&quot;_score&quot;</span><span class="punctuation">:</span> <span class="number">10.018585</span><span class="punctuation">,</span> <span class="comment">// 文档的相关性分值</span></span><br><span class="line">        <span class="attr">&quot;_source&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="comment">// 文档的原始 JSON 对象</span></span><br><span class="line">          <span class="comment">// 略</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="comment">// 省略多条记录</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>:::</p>
<p>可以通过组合 <code>&lt;field&gt;</code> 和 <code>query</code> 参数来简化匹配查询语法。下面是一个简单的示例。</p>
<p>:::details match 简写示例</p>
<p>下面的查询等价于前面的匹配查询示例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET kibana_sample_data_ecommerce/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;customer_full_name&quot;</span>: <span class="string">&quot;George Hubbard&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>:::</p>
<p>在进行全文本字段检索的时候， match API 提供了 operator 和 minimum_should_match 参数：</p>
<ul>
<li><strong>operator</strong> 参数值可以为 “or” 或者 “and” 来控制检索词项间的关系，默认值为 “or”。所以上面例子中，只要书名中含有 “linux” 或者 “architecture” 的文档都可以匹配上。</li>
<li><strong><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-minimum-should-match.html">minimum_should_match</a></strong> 可以指定词项的最少匹配个数，其值可以指定为某个具体的数字，但因为我们无法预估检索内容的词项数量，一般将其设置为一个百分比。</li>
</ul>
<p>:::details minimum_should_match 示例</p>
<p>至少有 50% 的词项匹配的文档才会被返回：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">GET kibana_sample_data_ecommerce/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;category&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;query&quot;</span>: <span class="string">&quot;Women Clothing Accessories&quot;</span>,</span><br><span class="line">        <span class="string">&quot;operator&quot;</span>: <span class="string">&quot;or&quot;</span>,</span><br><span class="line">        <span class="string">&quot;minimum_should_match&quot;</span>: <span class="string">&quot;50%&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>:::</p>
<p>match 查询提供了 fuzziness 参数，<strong>fuzziness</strong> 允许基于被查询字段的类型进行模糊匹配。请参阅 <a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/common-options.html#fuzziness">Fuzziness</a> 的配置。</p>
<p>在这种情况下可以设置 <code>prefix_length</code> 和 <code>max_expansions</code> 来控制模糊匹配。如果设置了模糊选项，查询将使用 <code>top_terms_blended_freqs_$&#123;max_expansions&#125;</code> 作为其重写方法，<code>fuzzy_rewrite</code> 参数允许控制查询将如何被重写。</p>
<p>默认情况下允许模糊倒转 (<code>ab</code> → <code>ba</code>)，但可以通过将 <code>fuzzy_transpositions</code> 设置为 <code>false</code> 来禁用。</p>
<p>:::details fuzziness 示例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET kibana_sample_data_ecommerce/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;customer_first_name&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;query&quot;</span>: <span class="string">&quot;Gearge&quot;</span>,</span><br><span class="line">        <span class="string">&quot;fuzziness&quot;</span>: <span class="string">&quot;AUTO&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>:::</p>
<p>如果使用的分析器像 stop 过滤器一样删除查询中的所有标记，则默认行为是不匹配任何文档。可以使用 <code>zero_terms_query</code> 选项来改变默认行为，它接受 <code>none</code>（默认）和 <code>all</code> （相当于 <code>match_all</code> 查询）。</p>
<p>:::details zero_terms_query 示例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">GET kibana_sample_data_logs/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;message&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;query&quot;</span>: <span class="string">&quot;Mozilla Linux&quot;</span>,</span><br><span class="line">        <span class="string">&quot;operator&quot;</span>: <span class="string">&quot;and&quot;</span>,</span><br><span class="line">        <span class="string">&quot;zero_terms_query&quot;</span>: <span class="string">&quot;all&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>:::</p>
<h3 id="match-phrase（短语匹配查询）"><a href="#match-phrase（短语匹配查询）" class="headerlink" title="match_phrase（短语匹配查询）"></a>match_phrase（短语匹配查询）</h3><p><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-match-query-phrase.html"><strong><code>match_phrase</code></strong></a> 查询首先会对检索内容进行分词，分词器可以自定义，同时文档还要满足以下两个条件才会被搜索到：</p>
<ol>
<li><strong>分词后所有词项都要出现在该字段中（相当于 and 操作）</strong>。</li>
<li><strong>字段中的词项顺序要一致</strong>。</li>
</ol>
<p>:::details match_phrase 示例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">GET kibana_sample_data_logs/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;match_phrase&quot;</span>: &#123;</span><br><span class="line">       <span class="string">&quot;agent&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;query&quot;</span>: <span class="string">&quot;Linux x86_64&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>:::</p>
<h3 id="match-phrase-prefix（短语前缀匹配查询）"><a href="#match-phrase-prefix（短语前缀匹配查询）" class="headerlink" title="match_phrase_prefix（短语前缀匹配查询）"></a>match_phrase_prefix（短语前缀匹配查询）</h3><p>查询和 <a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-match-query-phrase.html"><strong><code>match_phrase</code></strong></a> 查询类似，只不过 <a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-match-query-phrase-prefix.html"><strong><code>match_phrase_prefix</code></strong></a> 最后一个 term 会被作为前缀匹配。</p>
<p>:::details match_phrase_prefix 示例</p>
<p>匹配以 <code>https://www.elastic.co/download</code> 开头的短语</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">GET kibana_sample_data_logs/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;match_phrase_prefix&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;url&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;query&quot;</span>: <span class="string">&quot;https://www.elastic.co/download&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>:::</p>
<h3 id="multi-match（多字段匹配查询）"><a href="#multi-match（多字段匹配查询）" class="headerlink" title="multi_match（多字段匹配查询）"></a>multi_match（多字段匹配查询）</h3><p><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-multi-match-query.html"><strong><code>multi_match</code></strong></a> 查询允许对多个字段执行相同的匹配查询。</p>
<p><code>multi_match</code> 查询在内部执行的方式取决于 type 参数，可以设置为：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-multi-match-query.html#type-best-fields"><code>best_fields</code></a> -（默认）将所有与查询匹配的文档作为结果返回，但是只使用评分最高的字段的评分来作为评分结果返回。</li>
<li><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-multi-match-query.html#type-most-fields"><code>most_fields</code></a> - 将所有与查询匹配的文档作为结果返回，并将所有匹配字段的评分累加起来作为评分结果。</li>
<li><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-multi-match-query.html#type-cross-fields"><code>cross_fields</code></a> - 将具有相同分析器的字段视为一个大字段。在每个字段中查找每个单词。例如当需要查询英文人名的时候，可以将 first_name 和 last_name 两个字段组合起来当作 full_name 来查询。</li>
<li><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-multi-match-query.html#type-phrase"><code>phrase</code></a> - 对每个字段运行 <code>match_phrase</code> 查询，并将最佳匹配字段的评分作为结果返回。</li>
<li><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-multi-match-query.html#type-phrase"><code>phrase_prefix</code></a> - 对每个字段运行 <code>match_phrase_prefix</code> 查询，并将最佳匹配字段的评分作为结果返回。</li>
<li><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-multi-match-query.html#type-bool-prefix"><code>bool_prefix</code></a> - 在每个字段上创建一个 <a href="https://link.juejin.cn/?target=https://www.elastic.co/guide/en/elasticsearch/reference/7.13/query-dsl-match-bool-prefix-query.html">match_bool_prefix</a> 查询，并且合并每个字段的评分作为评分结果。</li>
</ul>
<p>:::details multi_match 示例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">GET kibana_sample_data_ecommerce/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;multi_match&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;query&quot;</span>: 34.98,</span><br><span class="line">      <span class="string">&quot;fields&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;taxful_total_price&quot;</span>,</span><br><span class="line">        <span class="string">&quot;taxless_total_*&quot;</span> <span class="comment"># 可以使用通配符</span></span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>:::</p>
<h2 id="词项级别查询"><a href="#词项级别查询" class="headerlink" title="词项级别查询"></a>词项级别查询</h2><p><strong><code>Term</code>（词项）是表达语意的最小单位</strong>。搜索和利用统计语言模型进行自然语言处理都需要处理 Term。</p>
<p>全文查询在执行查询之前会分析查询字符串。与全文查询不同，<strong>词项级别查询不会分词</strong>，而是将输入作为一个整体，在倒排索引中查找准确的词项。并且使用相关度计算公式为每个包含该词项的文档进行相关度计算。一言以概之：<strong>词项查询是对词项进行精确匹配</strong>。词项查询通常用于结构化数据，如数字、日期和枚举类型。</p>
<p>词项查询有以下类型：</p>
<ul>
<li><strong><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-exists-query.html">exists</a></strong> - 返回在指定字段上有值的文档。</li>
<li><strong><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-fuzzy-query.html">fuzzy</a></strong> - 模糊查询，返回包含与搜索词相似的词的文档。</li>
<li><strong><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-ids-query.html">ids</a></strong> - 根据 ID 返回文档。此查询使用存储在 <code>_id</code> 字段中的文档 ID。</li>
<li><strong><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-prefix-query.html">prefix</a></strong> - 前缀查询，用于查询某个字段中包含指定前缀的文档。</li>
<li><strong><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-range-query.html">range</a></strong> - 范围查询，用于匹配在某一范围内的数值型、日期类型或者字符串型字段的文档。</li>
<li><strong><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-regexp-query.html">regexp</a></strong> - 正则匹配查询，返回与正则表达式相匹配的词项所属的文档。</li>
<li><strong><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-term-query.html">term</a></strong> - 用来查找指定字段中包含给定单词的文档。</li>
<li><strong><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-terms-query.html">terms</a></strong> - 与 <a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-term-query.html"><strong><code>term</code></strong></a> 相似，但可以搜索多个值。</li>
<li><strong><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-terms-set-query.html">terms set</a></strong> - 与 <a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-term-query.html"><strong><code>term</code></strong></a> 相似，但可以定义返回文档所需的匹配词数。</li>
<li><strong><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-wildcard-query.html">wildcard</a></strong> - 通配符查询，返回与通配符模式匹配的文档。</li>
</ul>
<h3 id="exists（字段不为空查询）"><a href="#exists（字段不为空查询）" class="headerlink" title="exists（字段不为空查询）"></a>exists（字段不为空查询）</h3><p><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-exists-query.html"><strong><code>exists</code></strong></a> 返回在指定字段上有值的文档。</p>
<p>由于多种原因，文档字段可能不存在索引值：</p>
<ul>
<li>JSON 中的字段为 <code>null</code> 或 <code>[]</code></li>
<li>该字段在 mapping 中配置了 <code>&quot;index&quot; : false</code></li>
<li>字段值的长度超过了 mapping 中的 <code>ignore_above</code> 设置</li>
<li>字段值格式错误，并且在 mapping 中定义了 <code>ignore_malformed</code></li>
</ul>
<p>:::details exists 示例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET kibana_sample_data_ecommerce/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;exists&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;field&quot;</span>: <span class="string">&quot;email&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>:::</p>
<h3 id="fuzzy（模糊查询）"><a href="#fuzzy（模糊查询）" class="headerlink" title="fuzzy（模糊查询）"></a>fuzzy（模糊查询）</h3><p><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-fuzzy-query.html"><strong><code>fuzzy</code></strong></a> 返回包含与搜索词相似的词的文档。ES 使用 <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Levenshtein_distance">Levenshtein edit distance（Levenshtein 编辑距离）</a> 测量相似度或模糊度。</p>
<p>编辑距离是将一个术语转换为另一个术语所需的单个字符更改的数量。这些变化可能包括：</p>
<ul>
<li>改变一个字符：（<strong>b</strong>ox -&gt; <strong>f</strong>ox）</li>
<li>删除一个字符：（<strong>b</strong>lack -&gt; lack）</li>
<li>插入一个字符：（sic -&gt; sic<strong>k</strong>）</li>
<li>反转两个相邻字符：（<strong>ac</strong>t → <strong>ca</strong>t）</li>
</ul>
<p>为了找到相似的词条，fuzzy query 会在指定的编辑距离内创建搜索词条的所有可能变体或扩展集。然后返回完全匹配任意扩展的文档。</p>
<p>注意：如果配置了 <a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl.html#query-dsl-allow-expensive-queries"><code>search.allow_expensive_queries</code></a> ，则 fuzzy query 不能执行。</p>
<p>:::details fuzzy 示例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">GET kibana_sample_data_ecommerce/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;fuzzy&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;customer_full_name&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;value&quot;</span>: <span class="string">&quot;mary&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>:::</p>
<h3 id="prefix（前缀查询）"><a href="#prefix（前缀查询）" class="headerlink" title="prefix（前缀查询）"></a>prefix（前缀查询）</h3><p><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-prefix-query.html#prefix-query-ex-request"><strong><code>prefix</code></strong></a> 用于查询某个字段中包含指定前缀的文档。</p>
<p>比如查询 <code>user.id</code> 中含有以 <code>ki</code> 为前缀的关键词的文档，那么含有 <code>kind</code>、<code>kid</code> 等所有以 <code>ki</code> 开头关键词的文档都会被匹配。</p>
<p>:::details prefix 示例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">GET kibana_sample_data_ecommerce/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;prefix&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;customer_full_name&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;value&quot;</span>: <span class="string">&quot;mar&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>:::</p>
<h3 id="range（范围查询）"><a href="#range（范围查询）" class="headerlink" title="range（范围查询）"></a>range（范围查询）</h3><p><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-range-query.html"><strong><code>range</code></strong></a> 用于匹配在某一范围内的数值型、日期类型或者字符串型字段的文档。比如搜索哪些书籍的价格在 50 到 100 之间、哪些书籍的出版时间在 2015 年到 2019 年之间。<strong>使用 range 查询只能查询一个字段，不能作用在多个字段上</strong>。</p>
<p><code>range</code> 查询支持的参数有以下几种：</p>
<ul>
<li><strong><code>gt</code></strong> - 大于</li>
<li><strong><code>gte</code></strong> - 大于等于</li>
<li><strong><code>lt</code></strong> - 小于</li>
<li><strong><code>lte</code></strong> - 小于等于</li>
<li><strong><code>format</code></strong> - 如果字段是 Date 类型，可以设置日期格式化</li>
<li><strong><code>time_zone</code></strong> - 时区</li>
<li><strong><code>relation</code></strong> - 指示范围查询如何匹配范围字段的值。<ul>
<li><strong><code>INTERSECTS</code> (Default)</strong> - 匹配与查询字段值范围相交的文档。</li>
<li><strong><code>CONTAINS</code></strong> - 匹配完全包含查询字段值的文档。</li>
<li><strong><code>WITHIN</code></strong> - 匹配具有完全在查询范围内的范围字段值的文档。</li>
</ul>
</li>
</ul>
<p>:::details range 示例</p>
<p>数值范围查询示例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET kibana_sample_data_ecommerce/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;range&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;taxful_total_price&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;gt&quot;</span>: 10,</span><br><span class="line">        <span class="string">&quot;lte&quot;</span>: 50</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>日期范围查询示例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">GET kibana_sample_data_ecommerce/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;range&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;order_date&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;time_zone&quot;</span>: <span class="string">&quot;+00:00&quot;</span>,</span><br><span class="line">        <span class="string">&quot;gte&quot;</span>: <span class="string">&quot;2018-01-01T00:00:00&quot;</span>,</span><br><span class="line">        <span class="string">&quot;lte&quot;</span>: <span class="string">&quot;now&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>:::</p>
<h3 id="regexp（正则匹配查询）"><a href="#regexp（正则匹配查询）" class="headerlink" title="regexp（正则匹配查询）"></a>regexp（正则匹配查询）</h3><p><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-regexp-query.html"><strong><code>regexp</code></strong></a> 返回与正则表达式相匹配的词项所属的文档。<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/zh-hans/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F">正则表达式</a> 是一种使用占位符字符匹配数据模式的方法，称为运算符。</p>
<p>注意：如果配置了 <a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl.html#query-dsl-allow-expensive-queries"><code>search.allow_expensive_queries</code></a> ，则 <a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-regexp-query.html"><strong><code>regexp query</code></strong></a> 会被禁用。</p>
<p>:::details regexp 示例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET kibana_sample_data_ecommerce/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;regexp&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;email&quot;</span>: <span class="string">&quot;.*@.*-family.zzz&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>:::</p>
<h3 id="term（词项匹配查询）"><a href="#term（词项匹配查询）" class="headerlink" title="term（词项匹配查询）"></a>term（词项匹配查询）</h3><p><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-term-query.html"><strong><code>term</code></strong></a> 用来查找指定字段中包含给定单词的文档，term 查询不被解析，只有查询词和文档中的词精确匹配才会被搜索到，应用场景为查询人名、地名等需要精准匹配的需求。</p>
<blockquote>
<p>注意：<strong>应避免 term 查询对 text 字段使用查询</strong>。默认情况下，Elasticsearch 针对 text 字段的值进行解析分词，这会使查找 text 字段值的精确匹配变得困难。要搜索 text 字段值，需改用 match 查询。</p>
</blockquote>
<p>:::details term 示例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 创建一个索引</span></span><br><span class="line">DELETE my-index-000001</span><br><span class="line">PUT my-index-000001</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;full_text&quot;</span>: &#123; <span class="string">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span> &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 使用 &quot;Quick Brown Foxes!&quot; 关键字查 &quot;full_text&quot; 字段</span></span><br><span class="line">PUT my-index-000001/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;full_text&quot;</span>: <span class="string">&quot;Quick Brown Foxes!&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 使用 term 查询</span></span><br><span class="line">GET my-index-000001/_search?pretty</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;term&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;full_text&quot;</span>: <span class="string">&quot;Quick Brown Foxes!&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># 因为 full_text 字段不再包含确切的 Term —— &quot;Quick Brown Foxes!&quot;，所以 term query 搜索不到任何结果</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 使用 match 查询</span></span><br><span class="line">GET my-index-000001/_search?pretty</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;full_text&quot;</span>: <span class="string">&quot;Quick Brown Foxes!&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DELETE my-index-000001</span><br></pre></td></tr></table></figure>

<blockquote>
<p>:warning: 注意：应避免 term 查询对 text 字段使用查询。</p>
<p>默认情况下，Elasticsearch 针对 text 字段的值进行解析分词，这会使查找 text 字段值的精确匹配变得困难。</p>
<p>要搜索 text 字段值，需改用 match 查询。</p>
</blockquote>
<p>:::</p>
<h3 id="terms（多词项匹配查询）"><a href="#terms（多词项匹配查询）" class="headerlink" title="terms（多词项匹配查询）"></a>terms（多词项匹配查询）</h3><p><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-terms-query.html"><strong><code>terms</code></strong></a> 与 <a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-term-query.html"><strong><code>term</code></strong></a> 相同，但可以搜索多个值。</p>
<p>terms query 查询参数：</p>
<ul>
<li>**<code>index</code>**：索引名</li>
<li>**<code>id</code>**：文档 ID</li>
<li>**<code>path</code>**：要从中获取字段值的字段的名称，即搜索关键字</li>
<li>**<code>routing</code>**（选填）：要从中获取 term 值的文档的自定义路由值。如果在索引文档时提供了自定义路由值，则此参数是必需的。</li>
</ul>
<p>:::details terms 示例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 创建一个索引</span></span><br><span class="line">DELETE my-index-000001</span><br><span class="line">PUT my-index-000001</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;color&quot;</span>: &#123; <span class="string">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span> &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 写入一个文档</span></span><br><span class="line">PUT my-index-000001/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;color&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;blue&quot;</span>,</span><br><span class="line">    <span class="string">&quot;green&quot;</span></span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 写入另一个文档</span></span><br><span class="line">PUT my-index-000001/_doc/2</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;color&quot;</span>: <span class="string">&quot;blue&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 使用 terms query</span></span><br><span class="line">GET my-index-000001/_search?pretty</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;terms&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;color&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;index&quot;</span>: <span class="string">&quot;my-index-000001&quot;</span>,</span><br><span class="line">        <span class="string">&quot;id&quot;</span>: <span class="string">&quot;2&quot;</span>,</span><br><span class="line">        <span class="string">&quot;path&quot;</span>: <span class="string">&quot;color&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DELETE my-index-000001</span><br></pre></td></tr></table></figure>

<p>:::</p>
<h3 id="wildcard（通配符查询）"><a href="#wildcard（通配符查询）" class="headerlink" title="wildcard（通配符查询）"></a>wildcard（通配符查询）</h3><p><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-wildcard-query.html"><strong><code>wildcard</code></strong></a> 即通配符查询，返回与通配符模式匹配的文档。</p>
<p><code>?</code> 用来匹配一个任意字符，<code>*</code> 用来匹配零个或者多个字符。</p>
<p>注意：如果配置了 <a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl.html#query-dsl-allow-expensive-queries"><code>search.allow_expensive_queries</code></a> ，则 <a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-wildcard-query.html"><strong><code>wildcard query</code></strong></a> 会被禁用。</p>
<p>:::details wildcard 示例</p>
<p>示例：以下搜索返回 <code>user.id</code> 字段包含以 <code>ki</code> 开头并以 <code>y</code> 结尾的术语的文档。这些匹配项可以包括 <code>kiy</code>、<code>kity</code> 或 <code>kimchy</code>。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">GET kibana_sample_data_ecommerce/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;wildcard&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;email&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;value&quot;</span>: <span class="string">&quot;*@underwood-family.zzz&quot;</span>,</span><br><span class="line">        <span class="string">&quot;boost&quot;</span>: 1,</span><br><span class="line">        <span class="string">&quot;rewrite&quot;</span>: <span class="string">&quot;constant_score&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>:::</p>
<h2 id="复合查询"><a href="#复合查询" class="headerlink" title="复合查询"></a>复合查询</h2><p>复合查询就是把一些简单查询组合在一起实现更复杂的查询需求，除此之外，复合查询还可以控制另外一个查询的行为。</p>
<p>复合查询有以下类型：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-bool-query.html"><code>bool</code></a> - 布尔查询，可以组合多个过滤语句来过滤文档。</li>
<li><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-boosting-query.html"><code>boosting</code></a> - 提供调整相关性打分的能力，在 <code>positive</code> 块中指定匹配文档的语句，同时降低在 <code>negative</code> 块中也匹配的文档的得分。</li>
<li><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-constant-score-query.html"><code>constant_score</code></a> - 使用 <code>constant_score</code> 可以将 <code>query</code> 转化为 <code>filter</code>，filter 可以忽略相关性算分的环节，并且 filter 可以有效利用缓存，从而提高查询的性能。</li>
<li><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-dis-max-query.html"><code>dis_max</code></a> - 返回匹配了一个或者多个查询语句的文档，但只将最佳匹配的评分作为相关性算分返回。</li>
<li><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-function-score-query.html"><code>function_score</code></a> - 支持使用函数来修改查询返回的分数。</li>
</ul>
<h3 id="bool-（布尔查询）"><a href="#bool-（布尔查询）" class="headerlink" title="bool （布尔查询）"></a>bool （布尔查询）</h3><p><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-bool-query.html"><code>bool</code></a> 查询可以把任意多个简单查询组合在一起，使用 <code>must</code>、<code>should</code>、<code>must_not</code>、<code>filter</code> 选项来表示简单查询之间的逻辑，每个选项都可以出现 0 次到多次，它们的含义如下：</p>
<ul>
<li><code>must</code> - 文档必须匹配 must 选项下的查询条件，相当于逻辑运算的 AND，且参与文档相关度的评分。</li>
<li><code>should</code> - 文档可以匹配 should 选项下的查询条件也可以不匹配，相当于逻辑运算的 OR，且参与文档相关度的评分。</li>
<li><code>must_not</code> - 与 must 相反，匹配该选项下的查询条件的文档不会被返回；需要注意的是，<strong>must_not 语句不会影响评分，它的作用只是将不相关的文档排除</strong>。</li>
<li><code>filter</code> - 和 must 一样，匹配 filter 选项下的查询条件的文档才会被返回，<strong>但是 filter 不评分，只起到过滤功能，与 must_not 相反</strong>。</li>
</ul>
<p>:::details bool 示例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">GET kibana_sample_data_ecommerce/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;bool&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;filter&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;term&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;type&quot;</span>: <span class="string">&quot;order&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;must_not&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;range&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;taxful_total_price&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;gte&quot;</span>: 30</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;should&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;day_of_week&quot;</span>: <span class="string">&quot;Sunday&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;category&quot;</span>: <span class="string">&quot;Clothing&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      <span class="string">&quot;minimum_should_match&quot;</span>: 1</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>:::</p>
<h3 id="boosting"><a href="#boosting" class="headerlink" title="boosting"></a>boosting</h3><p><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-boosting-query.html">boosting</a> 提供了调整相关性打分的能力。</p>
<p>boosting 查询包括 <code>positive</code>、<code>negative</code> 和 <code>negative_boost</code> 三个部分。<code>positive</code> 中的查询评分保持不变；<code>negative</code> 中的查询会降低文档评分；相关性算分降低的程度将由 <code>negative_boost</code> 参数决定，其取值范围为：<code>[0.0, 1.0]</code>。</p>
<p>:::details boosting 示例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">GET kibana_sample_data_ecommerce/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;boosting&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;positive&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;term&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;day_of_week&quot;</span>: <span class="string">&quot;Monday&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;negative&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;range&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;taxful_total_price&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;gte&quot;</span>: <span class="string">&quot;30&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;negative_boost&quot;</span>: 0.2</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>:::</p>
<h3 id="constant-score"><a href="#constant-score" class="headerlink" title="constant_score"></a>constant_score</h3><p>使用 <a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-constant-score-query.html"><code>constant_score</code></a> 可以将 <code>query</code> 转化为 <code>filter</code>，可以忽略相关性算分的环节，并且 filter 可以有效利用缓存，从而提高查询的性能。</p>
<p>:::details constant_score 示例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">GET kibana_sample_data_ecommerce/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;constant_score&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;filter&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;term&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;day_of_week&quot;</span>: <span class="string">&quot;Monday&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;boost&quot;</span>: 1.2</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>:::</p>
<h3 id="dis-max"><a href="#dis-max" class="headerlink" title="dis_max"></a>dis_max</h3><p><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-dis-max-query.html">dis_max</a> 查询与 bool 查询有一定联系也有一定区别，<code>dis_max</code> 查询支持多并发查询，可返回与任意查询条件子句匹配的任何文档类型。与 <code>bool</code> 查询可以将所有匹配查询的分数相结合使用的方式不同，<code>dis_max</code> 查询只使用最佳匹配查询条件的分数。</p>
<p>:::details dis_max 示例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">GET kibana_sample_data_ecommerce/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;dis_max&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;queries&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;term&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;currency&quot;</span>: <span class="string">&quot;EUR&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;term&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;day_of_week&quot;</span>: <span class="string">&quot;Sunday&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      <span class="string">&quot;tie_breaker&quot;</span>: 0.7</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>:::</p>
<h3 id="function-score"><a href="#function-score" class="headerlink" title="function_score"></a>function_score</h3><p><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-function-score-query.html">function_score</a> 查询可以修改查询的文档得分，这个查询在有些情况下非常有用，比如通过评分函数计算文档得分代价较高，可以改用过滤器加自定义评分函数的方式来取代传统的评分方式。</p>
<p>使用 <code>function_score</code> 查询，用户需要定义一个查询和一至多个评分函数，评分函数会对查询到的每个文档分别计算得分。</p>
<p><code>function_score</code> 查询提供了以下几种算分函数：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-function-score-query.html#function-script-score"><strong><code>script_score</code></strong></a> - 利用自定义脚本完全控制算分逻辑。</li>
<li><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-function-score-query.html#function-weight"><strong><code>weight</code></strong></a> - 为每一个文档设置一个简单且不会被规范化的权重。</li>
<li><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-function-score-query.html#function-random"><strong><code>random_score</code></strong></a> - 为每个用户提供一个不同的随机算分，对结果进行排序。</li>
<li><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-function-score-query.html#function-field-value-factor"><strong><code>field_value_factor</code></strong></a> - 使用文档字段的值来影响算分，例如将好评数量这个字段作为考虑因数。</li>
<li><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-function-score-query.html#function-decay"><strong><code>decay functions</code></strong></a> - 衰减函数，以某个字段的值为标准，距离指定值越近，算分就越高。例如我想让书本价格越接近 10 元，算分越高排序越靠前。</li>
</ul>
<p>:::details function_score 示例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">GET kibana_sample_data_ecommerce/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;function_score&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;query&quot;</span>: &#123; <span class="string">&quot;match_all&quot;</span>: &#123;&#125; &#125;,</span><br><span class="line">      <span class="string">&quot;boost&quot;</span>: <span class="string">&quot;5&quot;</span>,</span><br><span class="line">      <span class="string">&quot;functions&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;filter&quot;</span>: &#123; <span class="string">&quot;match&quot;</span>: &#123; <span class="string">&quot;day_of_week&quot;</span>: <span class="string">&quot;Sunday&quot;</span> &#125; &#125;,</span><br><span class="line">          <span class="string">&quot;random_score&quot;</span>: &#123;&#125;,</span><br><span class="line">          <span class="string">&quot;weight&quot;</span>: 23</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;filter&quot;</span>: &#123; <span class="string">&quot;match&quot;</span>: &#123; <span class="string">&quot;day_of_week&quot;</span>: <span class="string">&quot;Monday&quot;</span> &#125; &#125;,</span><br><span class="line">          <span class="string">&quot;weight&quot;</span>: 42</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      <span class="string">&quot;max_boost&quot;</span>: 42,</span><br><span class="line">      <span class="string">&quot;score_mode&quot;</span>: <span class="string">&quot;max&quot;</span>,</span><br><span class="line">      <span class="string">&quot;boost_mode&quot;</span>: <span class="string">&quot;multiply&quot;</span>,</span><br><span class="line">      <span class="string">&quot;min_score&quot;</span>: 42</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>:::</p>
<h2 id="推荐搜索"><a href="#推荐搜索" class="headerlink" title="推荐搜索"></a>推荐搜索</h2><p>ES 通过 <a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-suggesters.html"><strong><code>Suggester</code></strong></a> 提供了推荐搜索能力，可以用于文本纠错，文本自动补全等场景。</p>
<p>根据使用场景的不同，ES 提供了以下 4 种 Suggester：</p>
<ul>
<li><strong>Term Suggester</strong> - 基于词项的纠错补全。</li>
<li><strong>Phrase Suggester</strong> - 基于短语的纠错补全。</li>
<li><strong>Completion Suggester</strong> - 自动补全单词，输入词语的前半部分，自动补全单词。</li>
<li><strong>Context Suggester</strong> - 基于上下文的补全提示，可以实现上下文感知推荐。</li>
</ul>
<h3 id="Term-Suggester"><a href="#Term-Suggester" class="headerlink" title="Term Suggester"></a>Term Suggester</h3><p>Term Suggester <strong>提供了基于单词的纠错、补全功能，其工作原理是基于编辑距离（edit distance）来运作的，编辑距离的核心思想是一个词需要改变多少个字符就可以和另一个词一致</strong>。所以如果一个词转化为原词所需要改动的字符数越少，它越有可能是最佳匹配。</p>
<p>:::details term suggester 示例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">GET kibana_sample_data_ecommerce/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;day_of_week&quot;</span>: <span class="string">&quot;Sund&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;suggest&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;my_suggest&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;text&quot;</span>: <span class="string">&quot;Sund&quot;</span>,</span><br><span class="line">      <span class="string">&quot;term&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;suggest_mode&quot;</span>: <span class="string">&quot;missing&quot;</span>,</span><br><span class="line">        <span class="string">&quot;field&quot;</span>: <span class="string">&quot;day_of_week&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>响应结果：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;took&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;timed_out&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;successful&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;skipped&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;failed&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;hits&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="comment">// 略</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;suggest&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;my_suggest&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;text&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Sund&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;offset&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;length&quot;</span><span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;options&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;text&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Sunday&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;score&quot;</span><span class="punctuation">:</span> <span class="number">0.5</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;freq&quot;</span><span class="punctuation">:</span> <span class="number">614</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>:::</p>
<p>Term Suggester API 有很多参数，比较常用的有以下几个：</p>
<ul>
<li><strong>text</strong> - 指定了需要产生建议的文本，一般是用户的输入内容。</li>
<li><strong>field</strong> - 指定从文档的哪个字段中获取建议。</li>
<li><strong>suggest_mode</strong> - 设置建议的模式。其值有以下几个选项：<ul>
<li><code>missing</code> - 如果索引中存在就不进行建议，默认的选项。</li>
<li><code>popular</code> - 推荐出现频率更高的词。</li>
<li><code>always</code> - 不管是否存在，都进行建议。</li>
</ul>
</li>
<li><strong>analyzer</strong> - 指定分词器来对输入文本进行分词，默认与 field 指定的字段设置的分词器一致。</li>
<li><strong>size</strong> - 为每个单词提供的最大建议数量。</li>
<li><strong>sort</strong> - 建议结果排序的方式，有以下两个选项 -<ul>
<li><code>score</code> - 先按相似性得分排序，然后按文档频率排序，最后按词项本身（字母顺序的等）排序。</li>
<li><code>frequency</code> - 先按文档频率排序，然后按相似性得分排序，最后按词项本身排序。</li>
</ul>
</li>
</ul>
<h3 id="Phrase-Suggester"><a href="#Phrase-Suggester" class="headerlink" title="Phrase Suggester"></a>Phrase Suggester</h3><p><strong>Phrase Suggester 在 Term Suggester 的基础上增加了一些额外的逻辑，因为是短语形式的建议，所以会考量多个 term 间的关系，比如相邻的程度、词频等</strong>。</p>
<p>:::details phrase suggester 示例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">GET kibana_sample_data_logs/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;suggest&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;text&quot;</span>: <span class="string">&quot;Firefix&quot;</span>,</span><br><span class="line">    <span class="string">&quot;simple_phrase&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;phrase&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;field&quot;</span>: <span class="string">&quot;agent&quot;</span>,</span><br><span class="line">        <span class="string">&quot;direct_generator&quot;</span>: [ &#123;</span><br><span class="line">          <span class="string">&quot;field&quot;</span>: <span class="string">&quot;agent&quot;</span>,</span><br><span class="line">          <span class="string">&quot;suggest_mode&quot;</span>: <span class="string">&quot;always&quot;</span></span><br><span class="line">        &#125; ],</span><br><span class="line">        <span class="string">&quot;highlight&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;pre_tag&quot;</span>: <span class="string">&quot;&lt;em&gt;&quot;</span>,</span><br><span class="line">          <span class="string">&quot;post_tag&quot;</span>: <span class="string">&quot;&lt;/em&gt;&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>响应结果：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;took&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;timed_out&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span> <span class="punctuation">:</span> <span class="comment">// 略</span></span><br><span class="line">  <span class="attr">&quot;hits&quot;</span> <span class="punctuation">:</span> <span class="comment">// 略</span></span><br><span class="line">  <span class="attr">&quot;suggest&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;simple_phrase&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;text&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Firefix&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;offset&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;length&quot;</span> <span class="punctuation">:</span> <span class="number">7</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;options&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;text&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;firefox&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;highlighted&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;&lt;em&gt;firefox&lt;/em&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;score&quot;</span> <span class="punctuation">:</span> <span class="number">0.2000096</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>:::</p>
<p>Phrase Suggester 可用的参数也是比较多的，下面介绍几个用得比较多的参数选项 -</p>
<ul>
<li><code>max_error</code> - 指定最多可以拼写错误的词语的个数。</li>
<li><code>confidence</code> - 其作用是用来控制返回结果条数的。如果用户输入的数据（短语）得分为 N，那么返回结果的得分需要大于 <code>N * confidence</code>。<code>confidence</code> 默认值为 1.0。</li>
<li><code>highlight</code> - 高亮被修改后的词语。</li>
</ul>
<h3 id="Completion-Suggester"><a href="#Completion-Suggester" class="headerlink" title="Completion Suggester"></a>Completion Suggester</h3><p><strong>Completion Suggester 提供了自动补全的功能</strong>。</p>
<p><strong>Completion Suggester 在实现的时候会将 analyze（将文本分词，并且去除没用的词语，例如 is、at 这样的词语） 后的数据进行编码，构建为 FST 并且和索引存放在一起</strong>。FST（**<a href="https://link.juejin.cn/?target=https://en.wikipedia.org/wiki/Finite-state_transducer">finite-state transducer</a>**）是一种高效的前缀查询索引。由于 FST 天生为前缀查询而生，所以其非常适合实现自动补全的功能。ES 会将整个 FST 加载到内存中，所以在使用 FST 进行前缀查询的时候效率是非常高效的。</p>
<p>在使用 Completion Suggester 前需要定义 Mapping，对应的字段需要使用 “completion” type。</p>
<p>:::details completion suggester 示例</p>
<p>构造用于自动补全的测试数据：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 先删除原来的索引</span></span><br><span class="line">DELETE music</span><br><span class="line"></span><br><span class="line"><span class="comment"># 新增 type 字段，类型为 completion，用于自动补全测试</span></span><br><span class="line">PUT music</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;suggest&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;completion&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加推荐</span></span><br><span class="line">PUT music/_doc/1?refresh</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;suggest&quot;</span> : &#123;</span><br><span class="line">    <span class="string">&quot;input&quot;</span>: [ <span class="string">&quot;Nevermind&quot;</span>, <span class="string">&quot;Nirvana&quot;</span> ],</span><br><span class="line">    <span class="string">&quot;weight&quot;</span> : 34</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">PUT music/_doc/1?refresh</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;suggest&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;input&quot;</span>: <span class="string">&quot;Nevermind&quot;</span>,</span><br><span class="line">      <span class="string">&quot;weight&quot;</span>: 10</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;input&quot;</span>: <span class="string">&quot;Nirvana&quot;</span>,</span><br><span class="line">      <span class="string">&quot;weight&quot;</span>: 3</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>获取推荐：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">POST music/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;suggest&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;song-suggest&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;prefix&quot;</span>: <span class="string">&quot;nir&quot;</span>,</span><br><span class="line">      <span class="string">&quot;completion&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;field&quot;</span>: <span class="string">&quot;suggest&quot;</span>,</span><br><span class="line">        <span class="string">&quot;size&quot;</span>: 5,</span><br><span class="line">        <span class="string">&quot;skip_duplicates&quot;</span>: <span class="literal">true</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>:::</p>
<h3 id="Context-Suggester"><a href="#Context-Suggester" class="headerlink" title="Context Suggester"></a>Context Suggester</h3><p><strong>Context Suggester 是 Completion Suggester 的扩展，可以实现上下文感知推荐</strong>。</p>
<p>ES 支持两种类型的上下文：</p>
<ul>
<li><strong>Category</strong>：任意字符串的分类。</li>
<li><strong>Geo</strong>：地理位置信息。</li>
</ul>
<p>在使用 Context Suggester 前需要定义 Mapping，然后在数据中加入相关的 Context 信息。</p>
<p>:::details context suggester 示例</p>
<p>构造用于 Context Suggester 的测试数据：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 删除原来的索引</span></span><br><span class="line">DELETE books_context</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建用于测试 Context Suggester 的索引</span></span><br><span class="line">PUT books_context</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">	<span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">		<span class="string">&quot;book_id&quot;</span>: &#123;</span><br><span class="line">		  <span class="string">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span></span><br><span class="line">		&#125;,</span><br><span class="line">		<span class="string">&quot;name&quot;</span>: &#123;</span><br><span class="line">		  <span class="string">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">		  <span class="string">&quot;analyzer&quot;</span>: <span class="string">&quot;standard&quot;</span></span><br><span class="line">		&#125;,</span><br><span class="line">		<span class="string">&quot;name_completion&quot;</span>: &#123;</span><br><span class="line">		  <span class="string">&quot;type&quot;</span>: <span class="string">&quot;completion&quot;</span>,</span><br><span class="line">		  <span class="string">&quot;contexts&quot;</span>: [</span><br><span class="line">			&#123;</span><br><span class="line">			  <span class="string">&quot;name&quot;</span>: <span class="string">&quot;book_type&quot;</span>,</span><br><span class="line">			  <span class="string">&quot;type&quot;</span>: <span class="string">&quot;category&quot;</span></span><br><span class="line">			&#125;</span><br><span class="line">		  ]</span><br><span class="line">		&#125;,</span><br><span class="line">		<span class="string">&quot;author&quot;</span>: &#123;</span><br><span class="line">		  <span class="string">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span></span><br><span class="line">		&#125;,</span><br><span class="line">		<span class="string">&quot;intro&quot;</span>: &#123;</span><br><span class="line">		  <span class="string">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span></span><br><span class="line">		&#125;,</span><br><span class="line">		<span class="string">&quot;price&quot;</span>: &#123;</span><br><span class="line">		  <span class="string">&quot;type&quot;</span>: <span class="string">&quot;double&quot;</span></span><br><span class="line">		&#125;,</span><br><span class="line">		<span class="string">&quot;date&quot;</span>: &#123;</span><br><span class="line">		  <span class="string">&quot;type&quot;</span>: <span class="string">&quot;date&quot;</span></span><br><span class="line">		&#125;</span><br><span class="line">	  &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;settings&quot;</span>: &#123;</span><br><span class="line">	<span class="string">&quot;number_of_shards&quot;</span>: 3,</span><br><span class="line">	<span class="string">&quot;number_of_replicas&quot;</span>: 1</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 导入测试数据</span></span><br><span class="line">PUT books_context/_doc/4</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;book_id&quot;</span>: <span class="string">&quot;4ee82465&quot;</span>,</span><br><span class="line">  <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Linux Programming&quot;</span>,</span><br><span class="line">  <span class="string">&quot;name_completion&quot;</span>: &#123;</span><br><span class="line">	<span class="string">&quot;input&quot;</span>: [<span class="string">&quot;Linux Programming&quot;</span>],</span><br><span class="line">	<span class="string">&quot;contexts&quot;</span>: &#123;</span><br><span class="line">	  <span class="string">&quot;book_type&quot;</span>: <span class="string">&quot;program&quot;</span></span><br><span class="line">	&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;author&quot;</span>: <span class="string">&quot;Richard Stones&quot;</span>,</span><br><span class="line">  <span class="string">&quot;intro&quot;</span>: <span class="string">&quot;Happy to Linux Programming&quot;</span>,</span><br><span class="line">  <span class="string">&quot;price&quot;</span>: 10.9,</span><br><span class="line">  <span class="string">&quot;date&quot;</span>: <span class="string">&quot;2022-06-01&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">PUT books_context/_doc/5</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;book_id&quot;</span>: <span class="string">&quot;4ee82466&quot;</span>,</span><br><span class="line">  <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Linus Autobiography&quot;</span>,</span><br><span class="line">  <span class="string">&quot;name_completion&quot;</span>: &#123;</span><br><span class="line">	<span class="string">&quot;input&quot;</span>: [<span class="string">&quot;Linus Autobiography&quot;</span>],</span><br><span class="line">	<span class="string">&quot;contexts&quot;</span>: &#123;</span><br><span class="line">	  <span class="string">&quot;book_type&quot;</span>: <span class="string">&quot;autobiography&quot;</span></span><br><span class="line">	&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;author&quot;</span>: <span class="string">&quot;Linus&quot;</span>,</span><br><span class="line">  <span class="string">&quot;intro&quot;</span>: <span class="string">&quot;Linus Autobiography&quot;</span>,</span><br><span class="line">  <span class="string">&quot;price&quot;</span>: 14.9,</span><br><span class="line">  <span class="string">&quot;date&quot;</span>: <span class="string">&quot;2012-06-01&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行 Context Suggester 查询：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">POST books_context/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;suggest&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;my_suggest&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;prefix&quot;</span>: <span class="string">&quot;linu&quot;</span>,</span><br><span class="line">      <span class="string">&quot;completion&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;field&quot;</span>: <span class="string">&quot;name_completion&quot;</span>,</span><br><span class="line">        <span class="string">&quot;contexts&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;book_type&quot;</span>: <span class="string">&quot;autobiography&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>:::</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a target="_blank" rel="noopener" href="https://time.geekbang.org/course/detail/100030501-102659">极客时间教程 - Elasticsearch 核心技术与实战</a></li>
<li><a target="_blank" rel="noopener" href="https://www.itshujia.com/read/elasticsearch/344.html">Elasticsearch 从入门到实践之全文搜索 API 实践</a></li>
<li><a target="_blank" rel="noopener" href="https://www.itshujia.com/read/elasticsearch/345.html">Elasticsearch 从入门到实践之 Term Query API 实践</a></li>
<li><a target="_blank" rel="noopener" href="https://www.itshujia.com/read/elasticsearch/346.html">Elasticsearch 从入门到实践之组合查询</a></li>
<li><a target="_blank" rel="noopener" href="https://www.itshujia.com/read/elasticsearch/347.html">Elasticsearch 从入门到实践之 Suggesters API</a></li>
<li><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/full-text-queries.html">Elasticsearch 官方文档之全文查询</a></li>
<li><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/term-level-queries.html">Elasticsearch 官方文档之词项查询</a></li>
<li><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/compound-queries.html">Elasticsearch 官方文档之组合查询</a></li>
<li><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-suggesters.html">Elasticsearch 官方文档之推荐查询</a></li>
<li><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-filter-context.html">Elasticsearch 官方文档之查询和过滤上下文</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://dunwu.github.io/blog/pages/90bed6fd/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/uploads/avatar.gif">
      <meta itemprop="name" content="钝悟 ◾ Dunwu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dunwu Blog">
      <meta itemprop="description" content="钝悟的个人博客">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Dunwu Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/pages/90bed6fd/" class="post-title-link" itemprop="url">Spring Bean</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-12-10 19:15:42" itemprop="dateCreated datePublished" datetime="2021-12-10T19:15:42+08:00">2021-12-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-09-13 17:56:53" itemprop="dateModified" datetime="2025-09-13T17:56:53+08:00">2025-09-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/%E6%A1%86%E6%9E%B6/" itemprop="url" rel="index"><span itemprop="name">框架</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/%E6%A1%86%E6%9E%B6/Spring/" itemprop="url" rel="index"><span itemprop="name">Spring</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/%E6%A1%86%E6%9E%B6/Spring/Spring%E6%A0%B8%E5%BF%83/" itemprop="url" rel="index"><span itemprop="name">Spring核心</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>5.7k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>5 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Spring-Bean"><a href="#Spring-Bean" class="headerlink" title="Spring Bean"></a>Spring Bean</h1><p>在 Spring 中，构成应用程序主体由 Spring IoC 容器管理的对象称为 Bean。<strong>Bean 是由 Spring IoC 容器实例化、装配和管理的对象</strong>。 Bean 以及它们之间的依赖关系反映在容器使用的配置元数据中。</p>
<h2 id="Spring-Bean-定义"><a href="#Spring-Bean-定义" class="headerlink" title="Spring Bean 定义"></a>Spring Bean 定义</h2><h3 id="BeanDefinition"><a href="#BeanDefinition" class="headerlink" title="BeanDefinition"></a>BeanDefinition</h3><p>Spring IoC 容器本身，并不能识别配置的元数据。为此，要将这些配置信息转为 Spring 能识别的格式——<code>BeanDefinition</code> 对象。</p>
<p><strong><code>BeanDefinition</code> 是 Spring 中定义 Bean 的配置元信息接口</strong>，它包含：</p>
<ul>
<li>Bean 类名</li>
<li>Bean 行为配置元素，如：作用域、自动绑定的模式、生命周期回调等</li>
<li>其他 Bean 引用，也可称为合作者（Collaborators）或依赖（Dependencies）</li>
<li>配置设置，如 Bean 属性（Properties）</li>
</ul>
<h4 id="BeanDefinition-元信息"><a href="#BeanDefinition-元信息" class="headerlink" title="BeanDefinition 元信息"></a>BeanDefinition 元信息</h4><p><code>BeanDefinition</code> 元信息如下：</p>
<table>
<thead>
<tr>
<th>属性（Property）</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-framework/docs/current/reference/html/core.html#beans-factory-class">Class</a></td>
<td>全类名，必须是具体类，不能用抽象类或接口</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-framework/docs/current/reference/html/core.html#beans-beanname">Name</a></td>
<td>Bean 的名称或者 ID</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-framework/docs/current/reference/html/core.html#beans-factory-scopes">Scope</a></td>
<td>Bean 的作用域（如：<code>singleton</code>、<code>prototype</code> 等）</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-framework/docs/current/reference/html/core.html#beans-factory-collaborators">Constructor arguments</a></td>
<td>Bean 构造器参数（用于依赖注入）</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-framework/docs/current/reference/html/core.html#beans-factory-collaborators">Properties</a></td>
<td>Bean 属性设置（用于依赖注入）</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-framework/docs/current/reference/html/core.html#beans-factory-autowire">Autowiring mode</a></td>
<td>Bean 自动绑定模式（如：通过名称 byName）</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-framework/docs/current/reference/html/core.html#beans-factory-lazy-init">Lazy initialization mode</a></td>
<td>Bean 延迟初始化模式（延迟和非延迟）</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-framework/docs/current/reference/html/core.html#beans-factory-lifecycle-initializingbean">Initialization method</a></td>
<td>Bean 初始化回调方法名称</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-framework/docs/current/reference/html/core.html#beans-factory-lifecycle-disposablebean">Destruction method</a></td>
<td>Bean 销毁回调方法名称</td>
</tr>
</tbody></table>
<h4 id="BeanDefinition-构建"><a href="#BeanDefinition-构建" class="headerlink" title="BeanDefinition 构建"></a>BeanDefinition 构建</h4><p>BeanDefinition 构建方式：</p>
<ul>
<li><p>通过 <code>BeanDefinitionBuilder</code></p>
</li>
<li><p>通过 <code>AbstractBeanDefinition</code> 以及派生类</p>
</li>
</ul>
<blockquote>
<p>💻 Spring Bean 定义示例源码：<a target="_blank" rel="noopener" href="https://github.com/dunwu/spring-tutorial/blob/master/codes/core/spring-core-ioc/src/test/java/io/github/dunwu/spring/core/bean/BeanDefinitionTests.java">BeanDefinitionTests</a></p>
</blockquote>
<h3 id="Spring-Bean-命名"><a href="#Spring-Bean-命名" class="headerlink" title="Spring Bean 命名"></a>Spring Bean 命名</h3><h4 id="Spring-Bean-命名规则"><a href="#Spring-Bean-命名规则" class="headerlink" title="Spring Bean 命名规则"></a>Spring Bean 命名规则</h4><p>每个 Bean 拥有一个或多个标识符（identifiers），这些标识符在 Bean 所在的容器必须是唯一的。通常，一个 Bean 仅有一个标识符，如果需要额外的，可考虑使用别名（Alias）来扩充。</p>
<p>在基于 XML 的配置元信息中，开发人员<strong>可以使用 <code>id</code> 属性、<code>name</code> 属性或来指定 Bean 标识符</strong>。通常，Bean 的标识符由字母组成，允许出现特殊字符。如果要想引入 Bean 的别名的话，可在 <code>name</code> 属性使用半角逗号（“,”）或分号（“;”) 来间隔。</p>
<p>Spring 中，<strong>为 Bean 指定 <code>id</code> 和 <code>name</code> 属性不是必须的</strong>。如果不指定，Spring 会自动为 Bean 分配一个唯一的名称。尽管 Bean 的命名没有限制，不过<strong>官方建议采用驼峰命名法来命名 Bean</strong>。</p>
<h4 id="Spring-Bean-命名生成器"><a href="#Spring-Bean-命名生成器" class="headerlink" title="Spring Bean 命名生成器"></a>Spring Bean 命名生成器</h4><p>Spring 提供了两种 Spring Bean 命名生成器：</p>
<ul>
<li><code>DefaultBeanNameGenerator</code>：默认通用 <code>BeanNameGenerator</code> 实现。</li>
<li><code>AnnotationBeanNameGenerator</code>：基于注解扫描的 <code>BeanNameGenerator</code> 实现。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">BeanNameGenerator</span> &#123;</span><br><span class="line">   String <span class="title function_">generateBeanName</span><span class="params">(BeanDefinition definition, BeanDefinitionRegistry registry)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Spring-Bean-别名"><a href="#Spring-Bean-别名" class="headerlink" title="Spring Bean 别名"></a>Spring Bean 别名</h4><p>Spring 支持通过 <code>&lt;alias&gt;</code> 属性为 Bean 设置别名。</p>
<p>Bean 别名（Alias）的作用：</p>
<ul>
<li>复用现有的 <code>BeanDefinition</code></li>
<li>更具有场景化的命名方法，比如：<ul>
<li><code>&lt;alias name=&quot;myApp-dataSource&quot; alias=&quot;subsystemA-dataSource&quot;/&gt;</code></li>
<li><code>&lt;alias name=&quot;myApp-dataSource&quot; alias=&quot;subsystemB-dataSource&quot;/&gt;</code></li>
</ul>
</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;user&quot;</span> <span class="attr">class</span>=<span class="string">&quot;io.github.dunwu.spring.core.bean.entity.person.User&quot;</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- 属性略 --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">&quot;user&quot;</span> <span class="attr">alias</span>=<span class="string">&quot;aliasUser&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="Spring-Bean-生命周期"><a href="#Spring-Bean-生命周期" class="headerlink" title="Spring Bean 生命周期"></a>Spring Bean 生命周期</h2><p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/20211201102734.png"></p>
<ol>
<li><p>Spring 对 Bean 进行实例化（相当于 new XXX()）</p>
</li>
<li><p>Spring 将值和引用注入到 Bean 对应的属性中</p>
</li>
<li><p>如果 Bean 实现了 <code>BeanNameAware</code> 接口，Spring 将 Bean 的 ID 传递给 <code>setBeanName</code> 方法</p>
<ul>
<li>作用是通过 Bean 的引用来获得 Bean ID，一般业务中是很少有用到 Bean 的 ID 的</li>
</ul>
</li>
<li><p>如果 Bean 实现了 <code>BeanFactoryAware</code> 接口，Spring 将调用 <code>setBeanDactory</code> 方法，并把 <code>BeanFactory</code> 容器实例作为参数传入。</p>
<ul>
<li>作用是获取 Spring 容器，如 Bean 通过 Spring 容器发布事件等</li>
</ul>
</li>
<li><p>如果 Bean 实现了 <code>ApplicationContextAware</code> 接口，Spring 容器将调用 <code>setApplicationContext</code> 方法，把应用上下文作为参数传入</p>
<ul>
<li>作用与 <code>BeanFactory</code> 类似都是为了获取 Spring 容器，不同的是 Spring 容器在调用 <code>setApplicationContext</code> 方法时会把它自己作为 <code>setApplicationContext</code> 的参数传入，而 Spring 容器在调用 <code>setBeanFactory</code> 前需要使用者自己指定（注入）<code>setBeanFactory</code> 里的参数 <code>BeanFactory</code></li>
</ul>
</li>
<li><p>如果 Bean 实现了 <code>BeanPostProcess</code> 接口，Spring 将调用 <code>postProcessBeforeInitialization</code> 方法</p>
<ul>
<li>作用是在 Bean 实例创建成功后对其进行增强处理，如对 Bean 进行修改，增加某个功能</li>
</ul>
</li>
<li><p>如果 Bean 实现了 <code>InitializingBean</code> 接口，Spring 将调用 <code>afterPropertiesSet</code> 方法，作用与在配置文件中对 Bean 使用 <code>init-method</code> 声明初始化的作用一样，都是在 Bean 的全部属性设置成功后执行的初始化方法。</p>
</li>
<li><p>如果 Bean 实现了 <code>BeanPostProcess</code> 接口，Spring 将调用 <code>postProcessAfterInitialization</code> 方法</p>
<ul>
<li><code>postProcessBeforeInitialization</code> 是在 Bean 初始化前执行的，而 <code>postProcessAfterInitialization</code> 是在 Bean 初始化后执行的</li>
</ul>
</li>
<li><p>经过以上的工作后，Bean 将一直驻留在应用上下文中给应用使用，直到应用上下文被销毁</p>
</li>
<li><p>如果 Bean 实现了 <code>DispostbleBean</code> 接口，Spring 将调用它的 <code>destory</code> 方法，作用与在配置文件中对 Bean 使用 <code>destory-method</code> 属性的作用一样，都是在 Bean 实例销毁前执行的方法。</p>
</li>
</ol>
<h2 id="Spring-Bean-注册"><a href="#Spring-Bean-注册" class="headerlink" title="Spring Bean 注册"></a>Spring Bean 注册</h2><p>注册 Spring Bean 实际上是将 <code>BeanDefinition</code> 注册到 IoC 容器中。</p>
<h3 id="XML-配置元信息"><a href="#XML-配置元信息" class="headerlink" title="XML 配置元信息"></a>XML 配置元信息</h3><p>Spring 的传统配置方式。在 <code>&lt;bean&gt;</code> 标签中配置元数据内容。</p>
<p>缺点是当 JavaBean 过多时，产生的配置文件足以让你眼花缭乱。</p>
<h3 id="注解配置元信息"><a href="#注解配置元信息" class="headerlink" title="注解配置元信息"></a>注解配置元信息</h3><p>使用 <code>@Bean</code>、<code>@Component</code>、<code>@Import</code> 注解注册 Spring Bean。</p>
<h3 id="Java-API-配置元信息"><a href="#Java-API-配置元信息" class="headerlink" title="Java API 配置元信息"></a>Java API 配置元信息</h3><ul>
<li>命名方式：<code>BeanDefinitionRegistry#registerBeanDefinition(String,BeanDefinition)</code></li>
<li>非命名方式：<code>BeanDefinitionReaderUtils#registerWithGeneratedName(AbstractBeanDefinition,BeanDefinitionRegistry)</code></li>
<li>配置类方式：<code>AnnotatedBeanDefinitionReader#register(Class...)</code></li>
</ul>
<blockquote>
<p>💻 Spring Bean 注册示例源码：<a target="_blank" rel="noopener" href="https://github.com/dunwu/spring-tutorial/blob/master/codes/core/spring-core-ioc/src/test/java/io/github/dunwu/spring/core/bean/BeanRegistryTests.java">BeanRegistryTests</a></p>
</blockquote>
<h2 id="Spring-Bean-实例化"><a href="#Spring-Bean-实例化" class="headerlink" title="Spring Bean 实例化"></a>Spring Bean 实例化</h2><p>Spring Bean 实例化方式：</p>
<ul>
<li>常规方式<ul>
<li>通过构造器（配置元信息：XML、Java 注解和 Java API）</li>
<li>通过静态方法（配置元信息：XML、Java 注解和 Java API）</li>
<li>通过 Bean 工厂方法（配置元信息：XML、Java 注解和 Java API）</li>
<li>通过 <code>FactoryBean</code>（配置元信息：XML、Java 注解和 Java API）</li>
</ul>
</li>
<li>特殊方式<ul>
<li>通过 <code>ServiceLoaderFactoryBean</code>（配置元信息：XML、Java 注解和 Java API ）</li>
<li>通过 <code>AutowireCapableBeanFactory#createBean(java.lang.Class, int, boolean)</code></li>
<li>通过 <code>BeanDefinitionRegistry#registerBeanDefinition(String,BeanDefinition)</code></li>
</ul>
</li>
</ul>
<blockquote>
<p>💻 Spring Bean 实例化示例源码：<a target="_blank" rel="noopener" href="https://github.com/dunwu/spring-tutorial/blob/master/codes/core/spring-core-ioc/src/test/java/io/github/dunwu/spring/core/bean/BeanInstantiationTests.java">BeanInstantiationTests</a>、<a target="_blank" rel="noopener" href="https://github.com/dunwu/spring-tutorial/blob/master/codes/core/spring-core-ioc/src/test/java/io/github/dunwu/spring/core/bean/BeanInstantiationSpecialTests.java">BeanInstantiationSpecialTests</a></p>
</blockquote>
<h2 id="Spring-Bean-初始化和销毁"><a href="#Spring-Bean-初始化和销毁" class="headerlink" title="Spring Bean 初始化和销毁"></a>Spring Bean 初始化和销毁</h2><p>Spring Bean 初始化和销毁的方式有以下几种：</p>
<ol>
<li><p>使用 <code>@PostConstruct</code> 和 <code>@PreDestroy</code> 注解分别指定相应的初始化方法和销毁方法。</p>
</li>
<li><p>实现 <code>InitializingBean</code> 接口的 <code>afterPropertiesSet()</code> 方法来编写初始化方法；实现 <code>DisposableBean</code> 接口的 <code>destroy()</code> 方法来编写销毁方法。</p>
<ul>
<li><code>InitializingBean</code> 接口包含一个 <code>afterPropertiesSet</code> 方法，可以通过实现该接口，然后在这个方法中编写初始化逻辑。</li>
<li><code>DisposableBean</code>接口包含一个 <code>destory</code> 方法，可以通过实现该接口，然后在这个方法中编写销毁逻辑。</li>
</ul>
</li>
<li><p>自定义初始化方法</p>
<ul>
<li>XML 配置：<code>&lt;bean init-method=&quot;init&quot; destroy=&quot;destroy&quot; ... /&gt;</code></li>
<li>Java 注解：<code>@Bean(initMethod = &quot;init&quot;, destroyMethod = &quot;destroy&quot;)</code></li>
<li>Java API：<code>AbstractBeanDefinition#setInitMethodName(String)</code> 和 <code>AbstractBeanDefinition#setDestroyMethodName(String)</code> 分别定义初始化和销毁方法</li>
</ul>
</li>
</ol>
<p>注意：如果同时存在，执行顺序会按照序列执行。</p>
<p>Bean 的延迟初始化</p>
<ul>
<li>xml 方式：<code>&lt;bean lazy-init=&quot;true&quot; ... /&gt;</code></li>
<li>注解方式：<code>@Lazy</code></li>
</ul>
<p>Spring 提供了一个 <code>BeanPostProcessor</code> 接口，提供了两个方法 <code>postProcessBeforeInitialization</code> 和 <code>postProcessAfterInitialization</code>。其中<code>postProcessBeforeInitialization</code> 在组件的初始化方法调用之前执行，<code>postProcessAfterInitialization</code> 在组件的初始化方法调用之后执行。它们都包含两个入参：</p>
<ul>
<li><code>bean</code>：当前组件对象；</li>
<li><code>beanName</code>：当前组件在容器中的名称。</li>
</ul>
<blockquote>
<p>💻 Spring Bean 初始化和销毁示例源码：<a target="_blank" rel="noopener" href="https://github.com/dunwu/spring-tutorial/blob/master/codes/core/spring-core-ioc/src/test/java/io/github/dunwu/spring/core/bean/BeanInitDestroyTests.java">BeanInitDestroyTests</a></p>
</blockquote>
<h2 id="Spring-Bean-垃圾回收"><a href="#Spring-Bean-垃圾回收" class="headerlink" title="Spring Bean 垃圾回收"></a>Spring Bean 垃圾回收</h2><p>Spring Bean 垃圾回收步骤：</p>
<ol>
<li>关闭 Spring 容器（应用上下文）</li>
<li>执行 GC</li>
<li>Spring Bean 覆盖的 <code>finalize()</code> 方法被回调</li>
</ol>
<h2 id="Spring-Bean-作用范围"><a href="#Spring-Bean-作用范围" class="headerlink" title="Spring Bean 作用范围"></a>Spring Bean 作用范围</h2><table>
<thead>
<tr>
<th align="left">Scope</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-framework/docs/current/reference/html/core.html#beans-factory-scopes-singleton">singleton</a></td>
<td align="left">(Default) Scopes a single bean definition to a single object instance for each Spring IoC container.</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-framework/docs/current/reference/html/core.html#beans-factory-scopes-prototype">prototype</a></td>
<td align="left">Scopes a single bean definition to any number of object instances.</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-framework/docs/current/reference/html/core.html#beans-factory-scopes-request">request</a></td>
<td align="left">Scopes a single bean definition to the lifecycle of a single HTTP request. That is, each HTTP request has its own instance of a bean created off the back of a single bean definition. Only valid in the context of a web-aware Spring <code>ApplicationContext</code>.</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-framework/docs/current/reference/html/core.html#beans-factory-scopes-session">session</a></td>
<td align="left">Scopes a single bean definition to the lifecycle of an HTTP <code>Session</code>. Only valid in the context of a web-aware Spring <code>ApplicationContext</code>.</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-framework/docs/current/reference/html/core.html#beans-factory-scopes-application">application</a></td>
<td align="left">Scopes a single bean definition to the lifecycle of a <code>ServletContext</code>. Only valid in the context of a web-aware Spring <code>ApplicationContext</code>.</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-framework/docs/current/reference/html/web.html#websocket-stomp-websocket-scope">websocket</a></td>
<td align="left">Scopes a single bean definition to the lifecycle of a <code>WebSocket</code>. Only valid in the context of a web-aware Spring <code>ApplicationContext</code>.</td>
</tr>
</tbody></table>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-framework/docs/current/spring-framework-reference/core.html#beans">Spring 官方文档之 Core Technologies</a></li>
<li><a target="_blank" rel="noopener" href="https://time.geekbang.org/course/intro/265">《小马哥讲 Spring 核心编程思想》</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://dunwu.github.io/blog/pages/64c58a4c/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/uploads/avatar.gif">
      <meta itemprop="name" content="钝悟 ◾ Dunwu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dunwu Blog">
      <meta itemprop="description" content="钝悟的个人博客">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Dunwu Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/pages/64c58a4c/" class="post-title-link" itemprop="url">SpringBoot 之快速入门</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-12-10 18:22:26" itemprop="dateCreated datePublished" datetime="2021-12-10T18:22:26+08:00">2021-12-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-09-13 17:56:53" itemprop="dateModified" datetime="2025-09-13T17:56:53+08:00">2025-09-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/%E6%A1%86%E6%9E%B6/" itemprop="url" rel="index"><span itemprop="name">框架</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/%E6%A1%86%E6%9E%B6/Spring/" itemprop="url" rel="index"><span itemprop="name">Spring</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/%E6%A1%86%E6%9E%B6/Spring/Spring%E6%A0%B8%E5%BF%83/" itemprop="url" rel="index"><span itemprop="name">Spring核心</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>8.8k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>8 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="SpringBoot-之快速入门"><a href="#SpringBoot-之快速入门" class="headerlink" title="SpringBoot 之快速入门"></a>SpringBoot 之快速入门</h1><h2 id="Spring-Boot-简介"><a href="#Spring-Boot-简介" class="headerlink" title="Spring Boot 简介"></a>Spring Boot 简介</h2><p>Spring Boot 可以让使用者非常方便的创建 Spring 应用。</p>
<p>Spring Boot 的目标是：</p>
<ul>
<li>为所有 Spring 开发者提供更快且可广泛访问的入门体验。</li>
<li>开箱即用</li>
<li>提供一系列通用的非功能特性（例如嵌入式服务、安全、指标、健康检查和外部化配置）</li>
<li>完全不需要代码生成，也不需要 XML 配置。</li>
</ul>
<h2 id="Spring-Boot-系统要求"><a href="#Spring-Boot-系统要求" class="headerlink" title="Spring Boot 系统要求"></a>Spring Boot 系统要求</h2><p>Spring Boot 的构建工具要求：</p>
<table>
<thead>
<tr>
<th align="left">Build Tool</th>
<th align="left">Version</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Maven</td>
<td align="left">3.5+</td>
</tr>
<tr>
<td align="left">Gradle</td>
<td align="left">6.8.x, 6.9.x, and 7.x</td>
</tr>
</tbody></table>
<p>Spring Boot 支持的 Servlet 容器：</p>
<table>
<thead>
<tr>
<th align="left">Name</th>
<th align="left">Servlet Version</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Tomcat 9.0</td>
<td align="left">4.0</td>
</tr>
<tr>
<td align="left">Jetty 9.4</td>
<td align="left">3.1</td>
</tr>
<tr>
<td align="left">Jetty 10.0</td>
<td align="left">4.0</td>
</tr>
<tr>
<td align="left">Undertow 2.0</td>
<td align="left">4.0</td>
</tr>
</tbody></table>
<h2 id="部署第一个-Spring-Boot-项目"><a href="#部署第一个-Spring-Boot-项目" class="headerlink" title="部署第一个 Spring Boot 项目"></a>部署第一个 Spring Boot 项目</h2><blockquote>
<p>本节介绍如何开发一个小的“Hello World!” web 应用示例，来展示 Spring Boot 的一些关键功能。我们使用 Maven 来构建这个项目，因为大多数 IDE 都支持它。</p>
</blockquote>
<h3 id="环境检查"><a href="#环境检查" class="headerlink" title="环境检查"></a>环境检查</h3><p>Spring Boot 项目依赖于 Java 环境和 Mave，开始项目之前需要先检查一下环境。</p>
<p>本地是否已安装 Java：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">java -version</span></span><br><span class="line">java version &quot;1.8.0_102&quot;</span><br><span class="line">Java(TM) SE Runtime Environment (build 1.8.0_102-b14)</span><br><span class="line">Java HotSpot(TM) 64-Bit Server VM (build 25.102-b14, mixed mode)</span><br></pre></td></tr></table></figure>

<p>本地是否已安装 Maven：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ mvn -v</span><br><span class="line">Apache Maven <span class="number">3.5</span><span class="number">.4</span> (1edded0938998edf8bf061f1ceb3cfdeccf443fe; <span class="number">2018</span>-<span class="number">06</span>-17T14:<span class="number">33</span>:<span class="number">14</span>-<span class="number">04</span>:<span class="number">00</span>)</span><br><span class="line">Maven home: /usr/local/Cellar/maven/<span class="number">3.3</span><span class="number">.9</span>/libexec</span><br><span class="line">Java version: <span class="number">1.8</span><span class="number">.0_102</span>, vendor: Oracle Corporation</span><br></pre></td></tr></table></figure>

<h3 id="创建-pom"><a href="#创建-pom" class="headerlink" title="创建 pom"></a>创建 pom</h3><p>我们需要从创建 Maven pom.xml 文件开始。 pom.xml 是 Maven 用于构建项目的配置文件。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>myproject<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.6.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- Additional lines to be added here... --&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>使用者可以通过运行 mvn package 来测试它</p>
<h3 id="添加依赖"><a href="#添加依赖" class="headerlink" title="添加依赖"></a>添加依赖</h3><p>Spring Boot 提供了许多启动器（Starters）以应对不同的使用场景。使用者可将 jars 添加到类路径中。我们的示例程序在 POM 的 parent 使用 spring-boot-starter-parent。 spring-boot-starter-parent 是一个特殊的启动器，提供有用的 Maven 默认值。它还提供了一个依赖项的版本管理，可以让使用者使用时不必显示指定版本。</p>
<p>其他启动器（Starters）提供了各种针对不同使用场景的功能。比如，我们需要开发一个 Web 应用程序，就可以添加了一个 spring-boot-starter-web 依赖项。在此之前，我们可以通过运行以下命令来查看我们当前拥有的 maven 依赖：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">mvn dependency:tree</span></span><br><span class="line"></span><br><span class="line">[INFO] com.example:myproject:jar:0.0.1-SNAPSHOT</span><br></pre></td></tr></table></figure>

<p>mvn dependency:tree 命令打印项目依赖项的层级结构。可以看到 spring-boot-starter-parent 本身没有提供任何依赖。要添加必要的依赖，需要编辑 pom.xml 并在 <code>&lt;dependencies&gt;</code> 部分添加 spring-boot-starter-web 依赖项：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="编写代码"><a href="#编写代码" class="headerlink" title="编写代码"></a>编写代码</h3><p>要运行应用程序，我们需要创建一个启动类。默认情况下，Maven 从 <code>src/main/java</code> 编译源代码，因此您需要创建该目录结构，然后添加一个名为 <code>src/main/java/MyApplication.java</code> 的文件以包含以下代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@EnableAutoConfiguration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyApplication</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/&quot;)</span></span><br><span class="line">    String <span class="title function_">home</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Hello World!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(MyApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>说明：</p>
<p>@RestController 注解告诉 Spring，这个类是用来处理 Rest 请求的。</p>
<p><code>@RequestMapping</code> 注解提供了“路由”信息。它告诉 Spring 任何带有 <code>/</code> 路径的 HTTP 请求都应该映射到 <code>home</code> 方法。 <code>@RestController</code> 注解告诉 Spring 将结果字符串直接呈现给调用者。</p>
<p><code>@EnableAutoConfiguration</code> 注解告诉 Spring Boot 根据你添加的 jar 依赖去自动装配 Spring。</p>
<blockquote>
<p>自动配置旨在与“Starters”配合使用，但这两个概念并没有直接联系。您可以自由选择 starters 之外的 jar 依赖项。 Spring Boot 仍然尽力自动配置您的应用程序。</p>
</blockquote>
<p>Spring Boot 的 main 方法通过调用 run 委托给 Spring Boot 的 <code>SpringApplication</code> 类。 <code>SpringApplication</code> 引导我们的应用程序，启动 Spring，进而启动自动配置的 Tomcat Web 服务器。我们需要将 <code>MyApplication.class</code> 作为参数传递给 run 方法，以告诉 <code>SpringApplication</code> 哪个是入口类。还传递 args 数组以公开任何命令行参数。</p>
<h3 id="运行示例"><a href="#运行示例" class="headerlink" title="运行示例"></a>运行示例</h3><p>此时，您的应用程序应该可以工作了。由于您使用了 spring-boot-starter-parent POM，因此您有一个有用的运行目标，可用于启动应用程序。从项目根目录键入 mvn spring-boot:run 以启动应用程序。您应该会看到类似于以下内容的输出：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">mvn spring-boot:run</span></span><br><span class="line"></span><br><span class="line">  .   ____          _            __ _ _</span><br><span class="line"> /\\ / ___&#x27;_ __ _ _(_)_ __  __ _ \ \ \ \</span><br><span class="line">( ( )\___ | &#x27;_ | &#x27;_| | &#x27;_ \/ _` | \ \ \ \</span><br><span class="line"> \\/  ___)| |_)| | | | | || (_| |  ) ) ) )</span><br><span class="line">  &#x27;  |____| .__|_| |_|_| |_\__, | / / / /</span><br><span class="line"> =========|_|==============|___/=/_/_/_/</span><br><span class="line"> :: Spring Boot ::  (v2.6.1)</span><br><span class="line">....... . . .</span><br><span class="line">....... . . . (log output here)</span><br><span class="line">....... . . .</span><br><span class="line">........ Started MyApplication in 2.222 seconds (JVM running for 6.514)</span><br></pre></td></tr></table></figure>

<p>如果您打开 Web 浏览器访问 localhost:8080，您应该会看到以下输出：</p>
<figure class="highlight erlang-repl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Hello World!</span><br></pre></td></tr></table></figure>

<p>要正常退出应用程序，请按 <code>ctrl-c</code>。</p>
<h3 id="创建可执行-jar"><a href="#创建可执行-jar" class="headerlink" title="创建可执行 jar"></a>创建可执行 jar</h3><p>要创建一个可执行的 jar，我们需要将 spring-boot-maven-plugin 添加到我们的 pom.xml 中。为此，请在依赖项部分下方插入以下行：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>保存 pom.xml 并从命令行运行 mvn package，如下所示：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">mvn package</span></span><br><span class="line"></span><br><span class="line">[INFO] Scanning for projects...</span><br><span class="line">[INFO]</span><br><span class="line">[INFO] ------------------------------------------------------------------------</span><br><span class="line">[INFO] Building myproject 0.0.1-SNAPSHOT</span><br><span class="line">[INFO] ------------------------------------------------------------------------</span><br><span class="line">[INFO] .... ..</span><br><span class="line">[INFO] --- maven-jar-plugin:2.4:jar (default-jar) @ myproject ---</span><br><span class="line">[INFO] Building jar: /Users/developer/example/spring-boot-example/target/myproject-0.0.1-SNAPSHOT.jar</span><br><span class="line">[INFO]</span><br><span class="line">[INFO] --- spring-boot-maven-plugin:2.6.1:repackage (default) @ myproject ---</span><br><span class="line">[INFO] ------------------------------------------------------------------------</span><br><span class="line">[INFO] BUILD SUCCESS</span><br><span class="line">[INFO] ------------------------------------------------------------------------</span><br></pre></td></tr></table></figure>

<p>如果您查看 target 目录，应该会看到 <code>myproject-0.0.1-SNAPSHOT.jar</code>。该文件的大小应约为 10 MB。如果想看里面，可以使用 jar tvf，如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">jar tvf target/myproject-0.0.1-SNAPSHOT.jar</span></span><br></pre></td></tr></table></figure>

<p>您还应该在目标目录中看到一个更小的名为 <code>myproject-0.0.1-SNAPSHOT.jar.original</code> 的文件。这是 Maven 在 Spring Boot 重新打包之前创建的原始 jar 文件。</p>
<p>要运行该应用程序，请使用 java -jar 命令，如下所示：</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ java -jar target/myproject-0.0.1-SNAPSHOT.jar</span><br><span class="line"></span><br><span class="line">  .   ____          _            __ _ _</span><br><span class="line"> /\\ / ___&#x27;_ __ _ _(_)_ __  __ _ \ \ \ \</span><br><span class="line">( ( )\___ |<span class="string"> &#x27;_ </span>|<span class="string"> &#x27;_</span>|<span class="string"> </span>|<span class="string"> &#x27;_ \/ _` </span>|<span class="string"> \ \ \ \</span></span><br><span class="line"><span class="string"> \\/  ___)</span>|<span class="string"> </span>|<span class="string">_)</span>|<span class="string"> </span>|<span class="string"> </span>|<span class="string"> </span>|<span class="string"> </span>|<span class="string"> </span>||<span class="string"> (_</span>|<span class="string"> </span>|<span class="string">  ) ) ) )</span></span><br><span class="line"><span class="string">  &#x27;  </span>|<span class="string">____</span>|<span class="string"> .__</span>|<span class="string">_</span>|<span class="string"> </span>|<span class="string">_</span>|<span class="string">_</span>|<span class="string"> </span>|<span class="string">_\__, </span>|<span class="string"> / / / /</span></span><br><span class="line"><span class="string"> =========</span>|<span class="string">_</span>|<span class="string">==============</span>|<span class="string">___/=/_/_/_/</span></span><br><span class="line"><span class="string"> :: Spring Boot ::  (v2.6.1)</span></span><br><span class="line"><span class="string">....... . . .</span></span><br><span class="line"><span class="string">....... . . . (log output here)</span></span><br><span class="line"><span class="string">....... . . .</span></span><br><span class="line"><span class="string">........ Started MyApplication in 2.536 seconds (JVM running for 2.864)</span></span><br></pre></td></tr></table></figure>

<p>和以前一样，要退出应用程序，请按 <code>ctrl-c</code>。</p>
<h2 id="通过-SPRING-INITIALIZR-创建-Spring-Boot-项目"><a href="#通过-SPRING-INITIALIZR-创建-Spring-Boot-项目" class="headerlink" title="通过 SPRING INITIALIZR 创建 Spring Boot 项目"></a>通过 SPRING INITIALIZR 创建 Spring Boot 项目</h2><h3 id="创建项目"><a href="#创建项目" class="headerlink" title="创建项目"></a>创建项目</h3><p>通过 <code>SPRING INITIALIZR</code> 工具产生基础项目</p>
<ol>
<li>访问：<code>http://start.spring.io/</code></li>
<li>选择构建工具<code>Maven Project</code>、Spring Boot 版本 <code>1.5.10</code> 以及一些工程基本信息，可参考下图所示：</li>
</ol>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/start.spring.io.png" alt="img"></p>
<ol start="3">
<li>点击<code>Generate Project</code>下载项目压缩包</li>
<li>解压压缩包，包中已是一个完整的项目。</li>
</ol>
<p>如果你使用 Intellij 作为 IDE，那么你可以直接使用 SPRING INITIALIZR，参考下图操作：</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/intellij-spring-initializr.gif" alt="img"></p>
<h3 id="项目说明"><a href="#项目说明" class="headerlink" title="项目说明"></a>项目说明</h3><p><strong>重要文件</strong></p>
<ul>
<li><code>src/main/java</code> 路径下的 <code>Chapter1Application</code> 类 ：程序入口</li>
<li><code>src/main/resources</code> 路径下的 <code>application.properties</code> ：项目配置文件</li>
<li><code>src/test/java</code> 路径下的 <code>Chapter01ApplicationTests</code> ：程序测试入口</li>
</ul>
<p><strong>pom.xml</strong></p>
<p>pom 中指定 parent 为以下内容，表示此项目继承了 <code>spring-boot-starter-parent</code> 的 maven 配置（主要是指定了常用依赖、插件的版本）。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.5.10.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span> <span class="comment">&lt;!-- lookup parent from repository --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>此外，pom 中默认引入两个依赖包，和一个插件。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"> <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>spring-boot-starter-web</code>：核心模块，包括自动配置支持、日志和 YAML。</li>
<li><code>spring-boot-starter-test</code>：测试模块，包括 JUnit、Hamcrest、Mockito。</li>
<li><code>spring-boot-maven-plugin</code>：spring boot 插件， 提供了一系列 spring boot 相关的 maven 操作。<ul>
<li><code>spring-boot:build-info</code>，生成 Actuator 使用的构建信息文件 build-info.properties</li>
<li><code>spring-boot:repackage</code>，默认 goal。在 mvn package 之后，再次打包可执行的 jar&#x2F;war，同时保留 mvn package 生成的 jar&#x2F;war 为.origin</li>
<li><code>spring-boot:run</code>，运行 Spring Boot 应用</li>
<li><code>spring-boot:start</code>，在 mvn integration-test 阶段，进行 Spring Boot 应用生命周期的管理</li>
<li><code>spring-boot:stop</code>，在 mvn integration-test 阶段，进行 Spring Boot 应用生命周期的管理</li>
</ul>
</li>
</ul>
<h3 id="编写-REST-服务"><a href="#编写-REST-服务" class="headerlink" title="编写 REST 服务"></a>编写 REST 服务</h3><ul>
<li>创建 <code>package</code> ，名为 <code>io.github.zp.springboot.chapter1.web</code>（根据项目情况修改）</li>
<li>创建 <code>HelloController</code> 类，内容如下：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/hello&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">index</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Hello World&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>启动主程序 <code>XXXApplication</code>，打开浏览器访问<code>http://localhost:8080/hello</code> ，可以看到页面输出<code>Hello World</code></li>
</ul>
<h3 id="编写单元测试用例"><a href="#编写单元测试用例" class="headerlink" title="编写单元测试用例"></a>编写单元测试用例</h3><p>在 <code>XXXApplicationTests</code> 类中编写一个简单的单元测试来模拟 HTTP 请求，具体如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith(SpringJUnit4ClassRunner.class)</span></span><br><span class="line"><span class="meta">@SpringApplicationConfiguration(classes = MockServletContext.class)</span></span><br><span class="line"><span class="meta">@WebAppConfiguration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringBootHelloWorldApplicationTest</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> MockMvc mvc;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Before</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setUp</span><span class="params">()</span> &#123;</span><br><span class="line">		mvc = MockMvcBuilders.standaloneSetup(<span class="keyword">new</span> <span class="title class_">HelloController</span>()).build();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Test</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">getHello</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		mvc.perform(MockMvcRequestBuilders.get(<span class="string">&quot;/hello&quot;</span>).accept(MediaType.APPLICATION_JSON))</span><br><span class="line">				.andExpect(status().isOk())</span><br><span class="line">				.andExpect(content().string(equalTo(<span class="string">&quot;Hello World&quot;</span>)));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用<code>MockServletContext</code>来构建一个空的<code>WebApplicationContext</code>，这样我们创建的<code>HelloController</code>就可以在<code>@Before</code>函数中创建并传递到<code>MockMvcBuilders.standaloneSetup（）</code>函数中。</p>
<ul>
<li>注意引入下面内容，让<code>status</code>、<code>content</code>、<code>equalTo</code>函数可用</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.hamcrest.Matchers.equalTo;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.springframework.test.web.servlet.result.MockMvcResultMatchers.content;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.springframework.test.web.servlet.result.MockMvcResultMatchers.status;</span><br></pre></td></tr></table></figure>

<p>至此已完成目标，通过 Maven 构建了一个空白 Spring Boot 项目，再通过引入 web 模块实现了一个简单的请求处理。</p>
<h3 id="示例源码"><a href="#示例源码" class="headerlink" title="示例源码"></a>示例源码</h3><blockquote>
<p>示例源码：<a target="_blank" rel="noopener" href="https://github.com/dunwu/spring-boot-tutorial/tree/master/codes/web/spring-boot-web-helloworld">spring-boot-web-helloworld</a></p>
</blockquote>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-boot/docs/current/reference/html/getting-started.html#getting-started">Spring Boot 官方文档之 Getting Started</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://dunwu.github.io/blog/pages/f718828e/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/uploads/avatar.gif">
      <meta itemprop="name" content="钝悟 ◾ Dunwu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dunwu Blog">
      <meta itemprop="description" content="钝悟的个人博客">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Dunwu Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/pages/f718828e/" class="post-title-link" itemprop="url">CAP 和 BASE</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-11-08 08:15:33" itemprop="dateCreated datePublished" datetime="2021-11-08T08:15:33+08:00">2021-11-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-09-13 17:56:53" itemprop="dateModified" datetime="2025-09-13T17:56:53+08:00">2025-09-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/%E5%88%86%E5%B8%83%E5%BC%8F/" itemprop="url" rel="index"><span itemprop="name">分布式</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/%E5%88%86%E5%B8%83%E5%BC%8F/%E5%88%86%E5%B8%83%E5%BC%8F%E7%BB%BC%E5%90%88/" itemprop="url" rel="index"><span itemprop="name">分布式综合</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>3.4k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>3 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="CAP-和-BASE"><a href="#CAP-和-BASE" class="headerlink" title="CAP 和 BASE"></a>CAP 和 BASE</h1><h2 id="一致性"><a href="#一致性" class="headerlink" title="一致性"></a>一致性</h2><p>一致性（Consistency）指的是<strong>多个数据副本是否能保持一致</strong>的特性。</p>
<p>在一致性的条件下，分布式系统在执行写操作成功后，如果所有用户都能够读取到最新的值，该系统就被认为具有强一致性。</p>
<p>数据一致性又可以分为以下几点：</p>
<ul>
<li><strong>强一致性</strong> - 数据更新操作结果和操作响应总是一致的，即操作响应通知更新失败，那么数据一定没有被更新，而不是处于不确定状态。</li>
<li><strong>弱一致性</strong> - 系统在写入数据成功后，不承诺立即能读到最新的值，也不承诺什么时候能读到，但是过一段时间之后用户可以看到更新后的值。那么用户读不到最新数据的这段时间被称为“不一致窗口时间”。</li>
<li><strong>最终一致性</strong> - 最终一致性作为弱一致性中的特例，强调的是所有数据副本，在经过一段时间的同步后，最终能够到达一致的状态，不需要实时保证系统数据的强一致性。</li>
</ul>
<h2 id="ACID"><a href="#ACID" class="headerlink" title="ACID"></a>ACID</h2><p>ACID 是数据库事务正确执行的四个基本要素的单词缩写：</p>
<ul>
<li><strong>原子性（Atomicity）</strong><ul>
<li>原子是指不可分解为更小粒度的东西。事务的原子性意味着：<strong>事务中的所有操作要么全部成功，要么全部失败</strong>。</li>
<li>回滚可以用日志来实现，日志记录着事务所执行的修改操作，在回滚时反向执行这些修改操作即可。</li>
</ul>
</li>
<li><strong>一致性（Consistency）</strong><ul>
<li>数据库在事务执行前后都保持一致性状态。</li>
<li>在一致性状态下，所有事务对一个数据的读取结果都是相同的。</li>
</ul>
</li>
<li><strong>隔离性（Isolation）</strong><ul>
<li>同时运行的事务互不干扰。换句话说，一个事务所做的修改在最终提交以前，对其它事务是不可见的。</li>
</ul>
</li>
<li><strong>持久性（Durability）</strong><ul>
<li>一旦事务提交，则其所做的修改将会永远保存到数据库中。即使系统发生崩溃，事务执行的结果也不能丢失。</li>
<li>可以通过数据库备份和恢复来实现，在系统发生奔溃时，使用备份的数据库进行数据恢复。</li>
</ul>
</li>
</ul>
<p>一个支持事务（Transaction）的数据库系统，必需要具有这四种特性，否则在事务过程（Transaction processing）当中无法保证数据的正确性。</p>
<ul>
<li>只有满足一致性，事务的执行结果才是正确的。</li>
<li>在无并发的情况下，事务串行执行，隔离性一定能够满足。此时只要能满足原子性，就一定能满足一致性。</li>
<li>在并发的情况下，多个事务并行执行，事务不仅要满足原子性，还需要满足隔离性，才能满足一致性。</li>
<li>事务满足持久化是为了能应对系统崩溃的情况。</li>
</ul>
<h2 id="CAP-定理"><a href="#CAP-定理" class="headerlink" title="CAP 定理"></a>CAP 定理</h2><h3 id="CAP-简介"><a href="#CAP-简介" class="headerlink" title="CAP 简介"></a>CAP 简介</h3><p>1998 年，Brewer 提出了分布式系统领域大名鼎鼎的 CAP 定理。</p>
<p>CAP 定理提出：分布式系统有三个指标，这三个指标不能同时做到：</p>
<ul>
<li><strong>一致性（Consistency）</strong> - 在任何给定时间，网络中的所有节点都具有完全相同（最近）的值。</li>
<li><strong>可用性（Availability）</strong> - 对网络的每个请求都会返回响应，但不能保证返回的数据是最新的。</li>
<li><strong>分区容错性（Partition Tolerance）</strong> - 即使任意数量的节点出现故障，网络仍会继续运行。</li>
</ul>
<p>CAP 就是取 Consistency、Availability、Partition Tolerance 的首字母而命名。</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/202405160639643.png"></p>
<p>在分布式系统中，分区容错性是一个既定的事实：因为分布式系统总会出现各种各样的问题，如由于网络原因而导致节点失联；发生机器故障；机器重启或升级等等。因此，<strong>CAP 定理实际上是要在可用性（A）和一致性（C）之间做权衡</strong>。</p>
<h3 id="AP-模式"><a href="#AP-模式" class="headerlink" title="AP 模式"></a>AP 模式</h3><p>对网络的每个请求都会收到响应，即使由于网络分区（故障节点）而无法保证数据一定是最新的。</p>
<p>选择 <strong>AP 模式</strong>，偏向于保证服务的高可用性。用户访问系统的时候，都能得到响应数据，不会出现响应错误；但是，当出现分区故障时，相同的读操作，访问不同的节点，得到响应数据可能不一样。</p>
<img src="https://raw.githubusercontent.com/dunwu/images/master/snap/20211102191819.png" style="width: 500px" />

<h3 id="CP-模式"><a href="#CP-模式" class="headerlink" title="CP 模式"></a>CP 模式</h3><p>如果由于网络分区（故障节点）而无法保证特定信息是最新的，则系统将返回错误或超时。</p>
<p>选择 <strong>CP 模式</strong>，一旦因为消息丢失、延迟过高发生了网络分区，就会影响用户的体验和业务的可用性。因为为了防止数据不一致，系统将拒绝新数据的写入。</p>
<img src="https://raw.githubusercontent.com/dunwu/images/master/snap/20211102191820.png" style="width: 500px" />

<h3 id="CAP-定理的应用"><a href="#CAP-定理的应用" class="headerlink" title="CAP 定理的应用"></a>CAP 定理的应用</h3><p>CAP 定理在分布式系统设计中，可以被应用与哪些方面？</p>
<p>一个最具代表性的问题是：服务注册中心应该选择 AP 还是 CP？</p>
<p>在微服务架构下，服务注册和服务发现机制中主要有三种角色：</p>
<ul>
<li><strong>服务提供者</strong>（RPC Server &#x2F; Provider）</li>
<li><strong>服务消费者</strong>（RPC Client &#x2F; Consumer）</li>
<li><strong>服务注册中心</strong>（Registry）</li>
</ul>
<p><strong>注册中心</strong>负责协调服务注册和服务发现，显然它是核心中的核心。主流的注册中心有很多，如：ZooKeeper、Nacos、Eureka、Consul、etcd 等。在针对注册中心进行技术选型时，其 CAP 设计也是一个比较的维度。</p>
<ul>
<li>CP 模型代表：ZooKeeper、etcd。系统强调数据的一致性，当数据一致性无法保证时（如：正在选举主节点），系统拒绝请求。</li>
<li>AP 模型代表：Nacos、Eureka。系统强调可用性，牺牲一定的一致性（即服务节点上的数据不保证是最新的），来保证整体服务可用。</li>
</ul>
<p>对于服务注册中心而言，即使不同节点保存的服务注册信息存在差异，也不会造成灾难性的后果，仅仅是信息滞后而已。但是，如果为了追求数据一致性，使得服务发现短时间内不可用，负面影响更严重。所以，对于服务注册中心而言，可用性比一致性更重要，一般应该选择 AP 模型。</p>
<h3 id="CAP-定理的误导"><a href="#CAP-定理的误导" class="headerlink" title="CAP 定理的误导"></a>CAP 定理的误导</h3><p>CAP 定理在分布式系统领域大名鼎鼎，以至于被很多人视为了真理。然而，CAP 定理真的正确吗？</p>
<p>网络分区是一种故障，不管喜欢还是不喜欢，它都可能发生，所以无法选择或逃避分区的问题。在网络正常的时候，系统可以同时保证一致性（线性化）和可用性。而一旦发生了网络故障，必须要么选择一致性，要么选择可用性。因此，对 CAP 更准确的理解应该是：<strong>当发生网络分区（P）的情况下，可用性（A）和一致性（C）二者只能选其一</strong>。</p>
<p>CAP 定理所描述的模型实际上局限性很大，它只考虑了一种一致性模型和一种故障（网络分区故障），而没有考虑网络延迟、节点失效等情况。因此，它对于指导一个具体的分布式系统设计来说，没有太大的实际价值。</p>
<p>值得一提的是，在 CAP 定理提出十二年之后，其提出者也发表了一篇文章 <a target="_blank" rel="noopener" href="https://www.infoq.com/articles/cap-twelve-years-later-how-the-rules-have-changed/"><strong>CAP Twelve Years Later: How the “Rules” Have Changed</strong></a>，来阐述 CAP 定理的局限性。</p>
<h2 id="BASE-定理"><a href="#BASE-定理" class="headerlink" title="BASE 定理"></a>BASE 定理</h2><p>BASE 是 <strong><code>基本可用（Basically Available）</code><strong>、</strong><code>软状态（Soft State）</code></strong> 和 <strong><code>最终一致性（Eventually Consistent）</code></strong> 三个短语的缩写。BASE 定理是对 CAP 定理中可用性（A）和一致性（C）权衡的结果。</p>
<p>BASE 定理的核心思想是：即使无法做到强一致性，但每个应用都可以根据自身业务特点，采用适当的方式来使系统达到最终一致性。</p>
<ul>
<li><strong>基本可用（Basically Available）</strong> - 分布式系统在出现故障的时候，<strong>保证核心可用，允许损失部分可用性</strong>。例如，电商在做促销时，为了保证购物系统的稳定性，部分消费者可能会被引导到一个降级的页面。</li>
<li><strong>软状态（Soft State）</strong> - 指允许系统中的数据存在中间状态，并认为该中间状态不会影响系统整体可用性，即<strong>允许系统不同节点的数据副本之间进行同步的过程存在延时</strong>。</li>
<li><strong>最终一致性（Eventually Consistent）</strong> - 强调的是所有数据副本，<strong>在经过一段时间的同步后，最终能够到达一致的状态</strong>，不需要实时保证系统数据的强一致性。</li>
</ul>
<h2 id="BASE-vs-ACID"><a href="#BASE-vs-ACID" class="headerlink" title="BASE vs. ACID"></a>BASE vs. ACID</h2><p>BASE 定理的<strong>核心思想</strong>是：即使无法做到强一致性，但每个应用都可以根据自身业务特点，采用适当的方式来使系统达到最终一致性。</p>
<p>ACID 要求强一致性，通常运用在传统的数据库系统上。而 BASE 要求最终一致性，通过<strong>牺牲强一致性来达到可用性</strong>，通常运用在大型分布式系统中。</p>
<img src="https://raw.githubusercontent.com/dunwu/images/master/snap/20211102192406.png" style="width: 640px" />

<p>在实际的分布式场景中，不同业务单元和组件对一致性的要求是不同的，因此 ACID 和 BASE 往往会结合在一起使用。</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a target="_blank" rel="noopener" href="https://www.comp.nus.edu.sg/~gilbert/pubs/BrewersConjecture-SigAct.pdf"><strong>Brewer’s Conjecture and the Feasibility of Consistent, Available, Partition-Tolerant Web Services</strong></a>，<a target="_blank" rel="noopener" href="https://juejin.cn/post/6844903936718012430"><strong>解读</strong></a> - 经典的 CAP 定理，即：在一个分布式系统中，当发生网络分区时，那么强一致性和可用性只能二选一。</li>
<li><a target="_blank" rel="noopener" href="https://www.infoq.com/articles/cap-twelve-years-later-how-the-rules-have-changed/"><strong>CAP Twelve Years Later: How the “Rules” Have Changed</strong></a>, <a target="_blank" rel="noopener" href="https://www.zhihu.com/question/64778723/answer/224266038"><strong>解读</strong></a> - CAP 定理的新解读，并阐述 CAP 定理的一些常见误区。</li>
<li><a target="_blank" rel="noopener" href="https://www.semanticscholar.org/paper/BASE%3A-An-Acid-Alternative-Pritchett/2e72e6c022dd33115304ecfcb6dad7ea609534a4"><strong>BASE: An Acid Alternative</strong></a>，<a target="_blank" rel="noopener" href="https://www.cnblogs.com/savorboard/p/base-an-acid-alternative.html"><strong>译文</strong></a> - BASE 定理是对 CAP 中一致性和可用性的权衡，提出采用适当的方式来使系统达到最终一致性。</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="上一页" aria-label="上一页" href="/blog/page/20/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/blog/">1</a><span class="space">&hellip;</span><a class="page-number" href="/blog/page/20/">20</a><span class="page-number current">21</span><a class="page-number" href="/blog/page/22/">22</a><span class="space">&hellip;</span><a class="page-number" href="/blog/page/51/">51</a><a class="extend next" rel="next" title="下一页" aria-label="下一页" href="/blog/page/22/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 2015 – 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">钝悟 ◾ Dunwu</span>
  </div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
      <span>站点总字数：</span>
    <span title="站点总字数">4.5m</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span>站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">68:08</span>
  </span>
</div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="reading-progress-bar"></div>

  <a href="https://github.com/dunwu/blog" class="github-corner" title="在 GitHub 上关注我" aria-label="在 GitHub 上关注我" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>
<script src="https://cdn.jsdelivr.net/npm/darkmode-js@1.5.7/lib/darkmode-js.min.js"></script>

<script>
var options = {
  bottom: '64px',
  right: 'unset',
  left: '32px',
  time: '0.5s',
  mixColor: 'transparent',
  backgroundColor: 'transparent',
  buttonColorDark: '#100f2c',
  buttonColorLight: '#fff',
  saveInCookies: true,
  label: '🌓',
  autoMatchOsTheme: true
}
const darkmode = new Darkmode(options);
window.darkmode = darkmode;
darkmode.showWidget();
</script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1.8.0/dist/gitalk.css" integrity="sha256-AJnUHL7dBv6PGaeyPQJcgQPDjt/Hn/PvYZde1iqfp8U=" crossorigin="anonymous">

<script class="next-config" data-name="gitalk" type="application/json">{"enable":true,"github_id":"dunwu","repo":"blog","client_id":"c45bc13ca1d3d3aa4836","client_secret":"1907a9f0c22087badad3938e1d7dcba9078f88ac","admin_user":"dunwu","distraction_free_mode":true,"proxy":"https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token","language":"zh-CN","js":{"url":"https://cdn.jsdelivr.net/npm/gitalk@1.8.0/dist/gitalk.min.js","integrity":"sha256-MVK9MGD/XJaGyIghSVrONSnoXoGh3IFxLw0zfvzpxR4="},"path_md5":"b45e099a43791779d7765acef4c61281"}</script>
<script src="/blog/js/third-party/comments/gitalk.js" defer></script>

</body>
</html>

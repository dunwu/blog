<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/blog/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/blog/uploads/favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/blog/uploads/favicon.ico">
  <link rel="mask-icon" href="/blog/images/logo.svg" color="#222">

<link rel="stylesheet" href="/blog/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@7.0.0/css/all.min.css" integrity="sha256-VHqXKFhhMxcpubYf9xiWdCiojEbY9NexQ4jh8AxbvcM=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/themes/blue/pace-theme-minimal.css">
  <script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous" defer></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"dunwu.github.io","root":"/blog/","images":"/blog/images","scheme":"Pisces","darkmode":true,"version":"8.25.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"codeblock":{"theme":{"light":"atom-one-light","dark":"atom-one-dark"},"prism":{"light":"atom-one-light","dark":"atom-one-dark"},"copy_button":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"language":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"gitalk","storage":true,"lazyload":true,"nav":null,"activeClass":"gitalk"},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/blog/search.xml","localsearch":{"enable":true,"top_n_per_article":1,"unescape":false,"preload":false,"trigger":"auto"}}</script><script src="/blog/js/config.js" defer></script>

    <meta name="description" content="钝悟的个人博客">
<meta property="og:type" content="website">
<meta property="og:title" content="Dunwu Blog">
<meta property="og:url" content="https://dunwu.github.io/blog/page/9/index.html">
<meta property="og:site_name" content="Dunwu Blog">
<meta property="og:description" content="钝悟的个人博客">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="钝悟 ◾ Dunwu">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://dunwu.github.io/blog/page/9/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"page/9/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Dunwu Blog</title>
  








  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
<script src="/blog/js/utils.js" defer></script><script src="/blog/js/motion.js" defer></script><script src="/blog/js/sidebar.js" defer></script><script src="/blog/js/next-boot.js" defer></script>

  <script src="https://cdn.jsdelivr.net/npm/hexo-generator-searchdb@1.5.0/dist/search.js" integrity="sha256-xFC6PJ82SL9b3WkGjFavNiA9gm5z6UBxWPiu4CYjptg=" crossorigin="anonymous" defer></script>
<script src="/blog/js/third-party/search/local-search.js" defer></script>





  <script src="/blog/js/third-party/pace.js" defer></script>


  





  <noscript>
    <link rel="stylesheet" href="/blog/css/noscript.css">
  </noscript>
<style>.darkmode--activated{--body-bg-color:#282828;--content-bg-color:#333;--card-bg-color:#555;--text-color:#ccc;--blockquote-color:#bbb;--link-color:#ccc;--link-hover-color:#eee;--brand-color:#ddd;--brand-hover-color:#ddd;--table-row-odd-bg-color:#282828;--table-row-hover-bg-color:#363636;--menu-item-bg-color:#555;--btn-default-bg:#222;--btn-default-color:#ccc;--btn-default-border-color:#555;--btn-default-hover-bg:#666;--btn-default-hover-color:#ccc;--btn-default-hover-border-color:#666;--highlight-background:#282b2e;--highlight-foreground:#a9b7c6;--highlight-gutter-background:#34393d;--highlight-gutter-foreground:#9ca9b6}.darkmode--activated img{opacity:.75}.darkmode--activated img:hover{opacity:.9}.darkmode--activated code{color:#69dbdc;background:0 0}button.darkmode-toggle{z-index:9999}.darkmode-ignore,img{display:flex!important}.beian img{display:inline-block!important}</style></head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/blog/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Dunwu Blog</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">大道至简，知易行难</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/blog/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/blog/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/blog/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">428</span></a></li><li class="menu-item menu-item-categories"><a href="/blog/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">124</span></a></li><li class="menu-item menu-item-archives"><a href="/blog/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">508</span></a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
      <div class="search-header">
        <span class="search-icon">
          <i class="fa fa-search"></i>
        </span>
        <div class="search-input-container">
          <input autocomplete="off" autocapitalize="off" maxlength="80"
                placeholder="搜索..." spellcheck="false"
                type="search" class="search-input">
        </div>
        <span class="popup-btn-close" role="button">
          <i class="fa fa-times-circle"></i>
        </span>
      </div>
      <div class="search-result-container">
        <div class="search-result-icon">
          <i class="fa fa-spinner fa-pulse fa-5x"></i>
        </div>
      </div>
    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="钝悟 ◾ Dunwu"
      src="/blog/uploads/avatar.gif">
  <p class="site-author-name" itemprop="name">钝悟 ◾ Dunwu</p>
  <div class="site-description" itemprop="description">钝悟的个人博客</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/blog/archives/">
          <span class="site-state-item-count">508</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/blog/categories/">
        <span class="site-state-item-count">124</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/blog/tags/">
        <span class="site-state-item-count">428</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/dunwu" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;dunwu" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:forbreak@163.com" title="E-Mail → mailto:forbreak@163.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>
  <div class="cc-license animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" class="cc-opacity" rel="noopener" target="_blank"><img src="https://cdn.jsdelivr.net/npm/@creativecommons/vocabulary@2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a>
  </div>

        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="返回顶部">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://dunwu.github.io/blog/pages/d4739660/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/uploads/avatar.gif">
      <meta itemprop="name" content="钝悟 ◾ Dunwu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dunwu Blog">
      <meta itemprop="description" content="钝悟的个人博客">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Dunwu Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/pages/d4739660/" class="post-title-link" itemprop="url">HBase 数据模型</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-03-16 15:58:10" itemprop="dateCreated datePublished" datetime="2023-03-16T15:58:10+08:00">2023-03-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-09-13 17:56:53" itemprop="dateModified" datetime="2025-09-13T17:56:53+08:00">2025-09-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/" itemprop="url" rel="index"><span itemprop="name">数据库</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%88%97%E5%BC%8F%E6%95%B0%E6%8D%AE%E5%BA%93/" itemprop="url" rel="index"><span itemprop="name">列式数据库</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%88%97%E5%BC%8F%E6%95%B0%E6%8D%AE%E5%BA%93/hbase/" itemprop="url" rel="index"><span itemprop="name">hbase</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>2.2k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>2 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="HBase-数据模型"><a href="#HBase-数据模型" class="headerlink" title="HBase 数据模型"></a>HBase 数据模型</h1><p>HBase 是一个面向 <code>列</code> 的数据库管理系统，这里更为确切的而说，HBase 是一个面向 <code>列族</code> 的数据库管理系统。表 schema 仅定义列族，表具有多个列族，每个列族可以包含任意数量的列，列由多个单元格（cell）组成，单元格可以存储多个版本的数据，多个版本数据以时间戳进行区分。</p>
<h2 id="HBase-逻辑存储结构"><a href="#HBase-逻辑存储结构" class="headerlink" title="HBase 逻辑存储结构"></a>HBase 逻辑存储结构</h2><ul>
<li>**<code>Table</code>**：Table 由 Row 和 Column 组成。</li>
<li>**<code>Row</code>**：Row 是列族（Column Family）的集合。</li>
<li><strong><code>Row Key</code><strong>：</strong><code>Row Key</code> 是用来检索记录的主键</strong>。<ul>
<li><code>Row Key</code> 是未解释的字节数组，所以理论上，任何数据都可以通过序列化表示成字符串或二进制，从而存为 HBase 的键值。</li>
<li>表中的行，是按照 <code>Row Key</code> 的字典序进行排序。这里需要注意以下两点：<ul>
<li>因为字典序对 Int 排序的结果是 1,10,100,11,12,13,14,15,16,17,18,19,2,20,21,…,9,91,92,93,94,95,96,97,98,99。如果你使用整型的字符串作为行键，那么为了保持整型的自然序，行键必须用 0 作左填充。</li>
<li>行的一次读写操作是原子性的 (不论一次读写多少列)。</li>
</ul>
</li>
<li>所有对表的访问都要通过 Row Key，有以下三种方式：<ul>
<li>通过指定的 <code>Row Key</code> 进行访问；</li>
<li>通过 <code>Row Key</code> 的 range 进行访问，即访问指定范围内的行；</li>
<li>进行全表扫描。</li>
</ul>
</li>
</ul>
</li>
<li>**<code>Column Family</code>**：即列族。HBase 表中的每个列，都归属于某个列族。列族是表的 Schema 的一部分，所以列族需要在创建表时进行定义。<ul>
<li>一个表的列族必须作为表模式定义的一部分预先给出，但是新的列族成员可以随后按需加入。</li>
<li>同一个列族的所有成员具有相同的前缀，例如 <code>info:format</code>，<code>info:geo</code> 都属于 <code>info</code> 这个列族。</li>
</ul>
</li>
<li>**<code>Column Qualifier</code>**：列限定符。可以理解为是具体的列名，例如 <code>info:format</code>，<code>info:geo</code> 都属于 <code>info</code> 这个列族，它们的列限定符分别是 <code>format</code> 和 <code>geo</code>。列族和列限定符之间始终以冒号分隔。需要注意的是列限定符不是表 Schema 的一部分，你可以在插入数据的过程中动态创建列。</li>
<li>**<code>Column</code>**：HBase 中的列由列族和列限定符组成，由 <code>:</code>(冒号) 进行分隔，即一个完整的列名应该表述为 <code>列族名 ：列限定符</code>。</li>
<li>**<code>Cell</code>**：<code>Cell</code> 是行，列族和列限定符的组合，并包含值和时间戳。HBase 中通过 <code>row key</code> 和 <code>column</code> 确定的为一个存储单元称为 <code>Cell</code>，你可以等价理解为关系型数据库中由指定行和指定列确定的一个单元格，但不同的是 HBase 中的一个单元格是由多个版本的数据组成的，每个版本的数据用时间戳进行区分。<ul>
<li><code>Cell</code> 由行和列的坐标交叉决定，是有版本的。默认情况下，版本号是自动分配的，为 HBase 插入 <code>Cell</code> 时的时间戳。<code>Cell</code> 的内容是未解释的字节数组。</li>
</ul>
</li>
<li>**<code>Timestamp</code>**：<code>Cell</code> 的版本通过时间戳来索引，时间戳的类型是 64 位整型，时间戳可以由 HBase 在数据写入时自动赋值，也可以由客户显式指定。每个 <code>Cell</code> 中，不同版本的数据按照时间戳倒序排列，即最新的数据排在最前面。</li>
</ul>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/cs/bigdata/hbase/1551164224778.png" alt="img"></p>
<h2 id="HBase-物理存储结构"><a href="#HBase-物理存储结构" class="headerlink" title="HBase 物理存储结构"></a>HBase 物理存储结构</h2><p>HBase Table 中的所有行按照 <code>Row Key</code> 的字典序排列。HBase Tables 通过行键的范围 (row key range) 被水平切分成多个 <code>Region</code>, 一个 <code>Region</code> 包含了在 start key 和 end key 之间的所有行。</p>
<p><a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/cd502001e098c6598fbec073a87e28b14e52268c48cc3b24395f252e0c801058/68747470733a2f2f67697465652e636f6d2f68656962616979696e672f426967446174612d4e6f7465732f7261772f6d61737465722f70696374757265732f48426173654172636869746563747572652d426c6f672d466967322e706e67"><img src="https://camo.githubusercontent.com/cd502001e098c6598fbec073a87e28b14e52268c48cc3b24395f252e0c801058/68747470733a2f2f67697465652e636f6d2f68656962616979696e672f426967446174612d4e6f7465732f7261772f6d61737465722f70696374757265732f48426173654172636869746563747572652d426c6f672d466967322e706e67" alt="img"></a></p>
<p>每个表一开始只有一个 <code>Region</code>，随着数据不断增加，<code>Region</code> 会不断增大，当增大到一个阀值的时候，<code>Region</code> 就会等分为两个新的 <code>Region</code>。当 Table 中的行不断增多，就会有越来越多的 <code>Region</code>。</p>
<p><a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/7a8d87d3896764c25784ea1ceaa3917dc111942e8e869801cf37c4449e7a1a4f/68747470733a2f2f67697465652e636f6d2f68656962616979696e672f426967446174612d4e6f7465732f7261772f6d61737465722f70696374757265732f68626173652d726567696f6e2d73706c6974652e706e67"><img src="https://camo.githubusercontent.com/7a8d87d3896764c25784ea1ceaa3917dc111942e8e869801cf37c4449e7a1a4f/68747470733a2f2f67697465652e636f6d2f68656962616979696e672f426967446174612d4e6f7465732f7261772f6d61737465722f70696374757265732f68626173652d726567696f6e2d73706c6974652e706e67" alt="img"></a></p>
<p><code>Region</code> 是 HBase 中<strong>分布式存储和负载均衡的最小单元</strong>。这意味着不同的 <code>Region</code> 可以分布在不同的 <code>Region Server</code> 上。但一个 <code>Region</code> 是不会拆分到多个 Server 上的。</p>
<p><a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/f0d7ef92cc299882591d6c09b465620d0ada3ab6038759d41e8243ff5bed6aa8/68747470733a2f2f67697465652e636f6d2f68656962616979696e672f426967446174612d4e6f7465732f7261772f6d61737465722f70696374757265732f68626173652d726567696f6e2d6469732e706e67"><img src="https://camo.githubusercontent.com/f0d7ef92cc299882591d6c09b465620d0ada3ab6038759d41e8243ff5bed6aa8/68747470733a2f2f67697465652e636f6d2f68656962616979696e672f426967446174612d4e6f7465732f7261772f6d61737465722f70696374757265732f68626173652d726567696f6e2d6469732e706e67" alt="img"></a></p>
<h2 id="HBase-数据模型示例"><a href="#HBase-数据模型示例" class="headerlink" title="HBase 数据模型示例"></a>HBase 数据模型示例</h2><p>下图为 HBase 中一张表的：</p>
<ul>
<li>RowKey 为行的唯一标识，所有行按照 RowKey 的字典序进行排序；</li>
<li>该表具有两个列族，分别是 personal 和 office;</li>
<li>其中列族 personal 拥有 name、city、phone 三个列，列族 office 拥有 tel、addres 两个列。</li>
</ul>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/20200601172926.png" alt="img"></p>
<blockquote>
<p><em>图片引用自 : HBase 是列式存储数据库吗</em> <em><a target="_blank" rel="noopener" href="https://www.iteblog.com/archives/2498.html">https://www.iteblog.com/archives/2498.html</a></em></p>
</blockquote>
<h2 id="HBase-表特性"><a href="#HBase-表特性" class="headerlink" title="HBase 表特性"></a>HBase 表特性</h2><p>Hbase 的表具有以下特点：</p>
<ul>
<li><strong>容量大</strong>：一个表可以有数十亿行，上百万列；</li>
<li><strong>面向列</strong>：数据是按照列存储，每一列都单独存放，数据即索引，在查询时可以只访问指定列的数据，有效地降低了系统的 I&#x2F;O 负担；</li>
<li><strong>稀疏性</strong>：空 (null) 列并不占用存储空间，表可以设计的非常稀疏 ；</li>
<li><strong>数据多版本</strong>：每个单元中的数据可以有多个版本，按照时间戳排序，新的数据在最上面；</li>
<li><strong>存储类型</strong>：所有数据的底层存储格式都是字节数组 (byte[])。</li>
</ul>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><strong>官方</strong><ul>
<li><a target="_blank" rel="noopener" href="http://hbase.apache.org/">HBase 官网</a></li>
<li><a target="_blank" rel="noopener" href="https://hbase.apache.org/book.html">HBase 官方文档</a></li>
<li><a target="_blank" rel="noopener" href="http://abloz.com/hbase/book.html">HBase 官方文档中文版</a></li>
</ul>
</li>
<li><strong>书籍</strong><ul>
<li><a target="_blank" rel="noopener" href="https://book.douban.com/subject/27600204/">Hadoop 权威指南</a></li>
</ul>
</li>
<li><strong>文章</strong><ul>
<li><a target="_blank" rel="noopener" href="https://static.googleusercontent.com/media/research.google.com/zh-CN//archive/bigtable-osdi06.pdf">Bigtable: A Distributed Storage System for Structured Data</a></li>
<li><a target="_blank" rel="noopener" href="https://mapr.com/blog/in-depth-look-hbase-architecture">An In-Depth Look at the HBase Architecture</a></li>
</ul>
</li>
<li><strong>教程</strong><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/heibaiying/BigData-Notes">https://github.com/heibaiying/BigData-Notes</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cloudduggu.com/hbase/introduction/">https://www.cloudduggu.com/hbase/introduction/</a></li>
</ul>
</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://dunwu.github.io/blog/pages/bfd041c2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/uploads/avatar.gif">
      <meta itemprop="name" content="钝悟 ◾ Dunwu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dunwu Blog">
      <meta itemprop="description" content="钝悟的个人博客">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Dunwu Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/pages/bfd041c2/" class="post-title-link" itemprop="url">HBase Java API 高级特性之协处理器</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-03-16 09:46:37" itemprop="dateCreated datePublished" datetime="2023-03-16T09:46:37+08:00">2023-03-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-09-13 17:56:53" itemprop="dateModified" datetime="2025-09-13T17:56:53+08:00">2025-09-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/" itemprop="url" rel="index"><span itemprop="name">数据库</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%88%97%E5%BC%8F%E6%95%B0%E6%8D%AE%E5%BA%93/" itemprop="url" rel="index"><span itemprop="name">列式数据库</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%88%97%E5%BC%8F%E6%95%B0%E6%8D%AE%E5%BA%93/hbase/" itemprop="url" rel="index"><span itemprop="name">hbase</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>290</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>1 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="HBase-Java-API-高级特性之协处理器"><a href="#HBase-Java-API-高级特性之协处理器" class="headerlink" title="HBase Java API 高级特性之协处理器"></a>HBase Java API 高级特性之协处理器</h1><h2 id="简述"><a href="#简述" class="headerlink" title="简述"></a>简述</h2><p>在使用 HBase 时，如果你的数据量达到了数十亿行或数百万列，此时能否在查询中返回大量数据将受制于网络的带宽，即便网络状况允许，但是客户端的计算处理也未必能够满足要求。在这种情况下，协处理器（Coprocessors）应运而生。它允许你将业务计算代码放入在 RegionServer 的协处理器中，将处理好的数据再返回给客户端，这可以极大地降低需要传输的数据量，从而获得性能上的提升。同时协处理器也允许用户扩展实现 HBase 目前所不具备的功能，如权限校验、二级索引、完整性约束等。</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a target="_blank" rel="noopener" href="https://item.jd.com/11321037.html">《HBase 权威指南》</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/larsgeorge/hbase-book">《HBase 权威指南》官方源码</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://dunwu.github.io/blog/pages/13b16de9/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/uploads/avatar.gif">
      <meta itemprop="name" content="钝悟 ◾ Dunwu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dunwu Blog">
      <meta itemprop="description" content="钝悟的个人博客">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Dunwu Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/pages/13b16de9/" class="post-title-link" itemprop="url">HBase Java API 高级特性之过滤器</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-03-16 09:45:10" itemprop="dateCreated datePublished" datetime="2023-03-16T09:45:10+08:00">2023-03-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-09-13 17:56:53" itemprop="dateModified" datetime="2025-09-13T17:56:53+08:00">2025-09-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/" itemprop="url" rel="index"><span itemprop="name">数据库</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%88%97%E5%BC%8F%E6%95%B0%E6%8D%AE%E5%BA%93/" itemprop="url" rel="index"><span itemprop="name">列式数据库</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%88%97%E5%BC%8F%E6%95%B0%E6%8D%AE%E5%BA%93/hbase/" itemprop="url" rel="index"><span itemprop="name">hbase</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>9.2k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>8 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="HBase-Java-API-高级特性之过滤器"><a href="#HBase-Java-API-高级特性之过滤器" class="headerlink" title="HBase Java API 高级特性之过滤器"></a>HBase Java API 高级特性之过滤器</h1><p>HBase 中两种主要的数据读取方法是 <code>get()</code> 和 <code>scan()</code>，它们都支持直接访问数据和通过指定起止 row key 访问数据。此外，可以指定列族、列、时间戳和版本号来进行条件查询。它们的缺点是不支持细粒度的筛选功能。为了弥补这种不足，<code>Get</code> 和 <code>Scan</code> 支持通过过滤器（<code>Filter</code>）对 row key、列或列值进行过滤。</p>
<p>HBase 提供了一些内置过滤器，也允许用户通过继承 <code>Filter</code> 类来自定义过滤器。所有的过滤器都在服务端生效，称为 <strong>谓词下推</strong>。这样可以保证被过滤掉的数据不会被传到客户端。</p>
<p><img src="https://www.oreilly.com/api/v2/epubs/9781449314682/files/httpatomoreillycomsourceoreillyimages889252.png"></p>
<p><em>图片来自 HBase 权威指南</em></p>
<p>HBase 过滤器层次结构的最底层是 <code>Filter</code> 接口和 <code>FilterBase</code> 抽象类。大部分过滤器都直接继承自 <code>FilterBase</code>。</p>
<h2 id="比较过滤器"><a href="#比较过滤器" class="headerlink" title="比较过滤器"></a>比较过滤器</h2><p>所有比较过滤器均继承自 <code>CompareFilter</code>。<code>CompareFilter</code> 比 <code>FilterBase</code> 多了一个 <code>compare()</code> 方法，它需要传入参数定义比较操作的过程：比较运算符和比较器。</p>
<p>创建一个比较过滤器需要两个参数，分别是<strong>比较运算符</strong>和<strong>比较器实例</strong>。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> CompareFilter(<span class="keyword">final</span> CompareOp compareOp,<span class="keyword">final</span> ByteArrayComparable comparator) &#123;</span><br><span class="line">   <span class="keyword">this</span>.compareOp = compareOp;</span><br><span class="line">   <span class="keyword">this</span>.comparator = comparator;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<h3 id="比较运算符"><a href="#比较运算符" class="headerlink" title="比较运算符"></a>比较运算符</h3><ul>
<li>LESS (&lt;)</li>
<li>LESS_OR_EQUAL (&lt;&#x3D;)</li>
<li>EQUAL (&#x3D;)</li>
<li>NOT_EQUAL (!&#x3D;)</li>
<li>GREATER_OR_EQUAL (&gt;&#x3D;)</li>
<li>GREATER (&gt;)</li>
<li>NO_OP (排除所有符合条件的值)</li>
</ul>
<p>比较运算符均定义在枚举类 <code>CompareOperator</code> 中</p>
<figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">@InterfaceAudience.Public</span><br><span class="line">public enum CompareOperator &#123;</span><br><span class="line"><span class="built_in">  LESS,</span></span><br><span class="line"><span class="built_in">  LESS_OR_EQUAL,</span></span><br><span class="line"><span class="built_in">  EQUAL,</span></span><br><span class="line"><span class="built_in">  NOT_EQUAL,</span></span><br><span class="line"><span class="built_in">  GREATER_OR_EQUAL,</span></span><br><span class="line"><span class="built_in">  GREATER,</span></span><br><span class="line"><span class="built_in">  NO_OP,</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意：在 1.x 版本的 HBase 中，比较运算符定义在 <code>CompareFilter.CompareOp</code> 枚举类中，但在 2.0 之后这个类就被标识为 @deprecated ，并会在 3.0 移除。所以 2.0 之后版本的 HBase 需要使用 <code>CompareOperator</code> 这个枚举类。</p>
</blockquote>
<h3 id="比较器"><a href="#比较器" class="headerlink" title="比较器"></a>比较器</h3><p>所有比较器均继承自 <code>ByteArrayComparable</code> 抽象类，常用的有以下几种：</p>
<ul>
<li><strong>BinaryComparator</strong> : 使用 <code>Bytes.compareTo(byte []，byte [])</code> 按字典序比较指定的字节数组。</li>
<li><strong>BinaryPrefixComparator</strong> : 按字典序与指定的字节数组进行比较，但只比较到这个字节数组的长度。</li>
<li><strong>RegexStringComparator</strong> : 使用给定的正则表达式与指定的字节数组进行比较。仅支持 <code>EQUAL</code> 和 <code>NOT_EQUAL</code> 操作。</li>
<li><strong>SubStringComparator</strong> : 测试给定的子字符串是否出现在指定的字节数组中，比较不区分大小写。仅支持 <code>EQUAL</code> 和 <code>NOT_EQUAL</code> 操作。</li>
<li><strong>NullComparator</strong> ：判断给定的值是否为空。</li>
<li><strong>BitComparator</strong> ：按位进行比较。</li>
</ul>
<p><code>BinaryPrefixComparator</code> 和 <code>BinaryComparator</code> 的区别不是很好理解，这里举例说明一下：</p>
<p>在进行 <code>EQUAL</code> 的比较时，如果比较器传入的是 <code>abcd</code> 的字节数组，但是待比较数据是 <code>abcdefgh</code>：</p>
<ul>
<li>如果使用的是 <code>BinaryPrefixComparator</code> 比较器，则比较以 <code>abcd</code> 字节数组的长度为准，即 <code>efgh</code> 不会参与比较，这时候认为 <code>abcd</code> 与 <code>abcdefgh</code> 是满足 <code>EQUAL</code> 条件的；</li>
<li>如果使用的是 <code>BinaryComparator</code> 比较器，则认为其是不相等的。</li>
</ul>
<h3 id="比较过滤器种类"><a href="#比较过滤器种类" class="headerlink" title="比较过滤器种类"></a>比较过滤器种类</h3><p>比较过滤器共有五个（Hbase 1.x 版本和 2.x 版本相同）：</p>
<ul>
<li><strong>RowFilter</strong> ：基于行键来过滤数据；</li>
<li><strong>FamilyFilterr</strong> ：基于列族来过滤数据；</li>
<li><strong>QualifierFilterr</strong> ：基于列限定符（列名）来过滤数据；</li>
<li><strong>ValueFilterr</strong> ：基于单元格 (cell) 的值来过滤数据；</li>
<li><strong>DependentColumnFilter</strong> ：指定一个参考列来过滤其他列的过滤器，过滤的原则是基于参考列的时间戳来进行筛选 。</li>
</ul>
<p>前四种过滤器的使用方法相同，均只要传递比较运算符和运算器实例即可构建，然后通过 <code>setFilter</code> 方法传递给 <code>scan</code>：</p>
<figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Filter</span> <span class="built_in">filter</span>  = <span class="keyword">new</span> RowFilter(CompareOperator.LESS_OR_EQUAL,</span><br><span class="line">                               <span class="keyword">new</span> BinaryComparator(Bytes.toBytes(<span class="string">&quot;xxx&quot;</span>)));</span><br><span class="line"> scan.setFilter(<span class="built_in">filter</span>);</span><br></pre></td></tr></table></figure>

<p><code>DependentColumnFilter</code> 的使用稍微复杂一点，这里单独做下说明。</p>
<h3 id="DependentColumnFilter"><a href="#DependentColumnFilter" class="headerlink" title="DependentColumnFilter"></a>DependentColumnFilter</h3><p>可以把 <code>DependentColumnFilter</code> 理解为<strong>一个 valueFilter 和一个时间戳过滤器的组合</strong>。<code>DependentColumnFilter</code> 有三个带参构造器，这里选择一个参数最全的进行说明：</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">DependentColumnFilter</span>(<span class="keyword">final</span> <span class="type">byte</span> [] family, <span class="keyword">final</span> <span class="type">byte</span>[] qualifier,</span><br><span class="line">                               <span class="keyword">final</span> <span class="type">boolean</span> dropDependentColumn, <span class="keyword">final</span> CompareOperator op,</span><br><span class="line">                               <span class="keyword">final</span> ByteArrayComparable valueComparator)</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>family</strong> ：列族</li>
<li><strong>qualifier</strong> ：列限定符（列名）</li>
<li><strong>dropDependentColumn</strong> ：决定参考列是否被包含在返回结果内，为 true 时表示参考列被返回，为 false 时表示被丢弃</li>
<li><strong>op</strong> ：比较运算符</li>
<li><strong>valueComparator</strong> ：比较器</li>
</ul>
<p>这里举例进行说明：</p>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">DependentColumnFilter dependentColumnFilter = <span class="literal">new</span> DependentColumnFilter(</span><br><span class="line">    <span class="built_in">Bytes</span>.toBytes(<span class="string">&quot;student&quot;</span>),</span><br><span class="line">    <span class="built_in">Bytes</span>.toBytes(<span class="string">&quot;name&quot;</span>),</span><br><span class="line">    <span class="literal">false</span>,</span><br><span class="line">    CompareOperator.EQUAL,</span><br><span class="line">    <span class="literal">new</span> BinaryPrefixComparator(<span class="built_in">Bytes</span>.toBytes(<span class="string">&quot;xiaolan&quot;</span>)));</span><br></pre></td></tr></table></figure>

<ul>
<li>首先会去查找 <code>student:name</code> 中值以 <code>xiaolan</code> 开头的所有数据获得 <code>参考数据集</code>，这一步等同于 valueFilter 过滤器；</li>
<li>其次再用参考数据集中所有数据的时间戳去检索其他列，获得时间戳相同的其他列的数据作为 <code>结果数据集</code>，这一步等同于时间戳过滤器；</li>
<li>最后如果 <code>dropDependentColumn</code> 为 true，则返回 <code>参考数据集</code>+<code>结果数据集</code>，若为 false，则抛弃参考数据集，只返回 <code>结果数据集</code>。</li>
</ul>
<h2 id="专用过滤器"><a href="#专用过滤器" class="headerlink" title="专用过滤器"></a>专用过滤器</h2><p>专用过滤器通常直接继承自 <code>FilterBase</code>，用于更特定的场景。</p>
<h3 id="单列列值过滤器-SingleColumnValueFilter"><a href="#单列列值过滤器-SingleColumnValueFilter" class="headerlink" title="单列列值过滤器 (SingleColumnValueFilter)"></a>单列列值过滤器 (SingleColumnValueFilter)</h3><p>基于某列（参考列）的值决定某行数据是否被过滤。其实例有以下方法：</p>
<ul>
<li><strong>setFilterIfMissing(boolean filterIfMissing)</strong> ：默认值为 false，即如果该行数据不包含参考列，其依然被包含在最后的结果中；设置为 true 时，则不包含；</li>
<li><strong>setLatestVersionOnly(boolean latestVersionOnly)</strong> ：默认为 true，即只检索参考列的最新版本数据；设置为 false，则检索所有版本数据。</li>
</ul>
<figure class="highlight vbscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">SingleColumnValueFilter singleColumnValueFilter = <span class="keyword">new</span> SingleColumnValue<span class="built_in">Filter</span>(</span><br><span class="line">                <span class="string">&quot;student&quot;</span>.getBytes(),</span><br><span class="line">                <span class="string">&quot;name&quot;</span>.getBytes(),</span><br><span class="line">                CompareOperator.EQUAL,</span><br><span class="line">                <span class="keyword">new</span> SubstringComparator(<span class="string">&quot;xiaolan&quot;</span>));</span><br><span class="line">singleColumnValueFilter.setFilterIfMissing(<span class="literal">true</span>);</span><br><span class="line">scan.<span class="keyword">set</span><span class="built_in">Filter</span>(singleColumnValueFilter);</span><br></pre></td></tr></table></figure>

<h3 id="单列列值排除器-SingleColumnValueExcludeFilter"><a href="#单列列值排除器-SingleColumnValueExcludeFilter" class="headerlink" title="单列列值排除器 (SingleColumnValueExcludeFilter)"></a>单列列值排除器 (SingleColumnValueExcludeFilter)</h3><p><code>SingleColumnValueExcludeFilter</code> 继承自上面的 <code>SingleColumnValueFilter</code>，过滤行为与其相反。</p>
<h3 id="行键前缀过滤器-PrefixFilter"><a href="#行键前缀过滤器-PrefixFilter" class="headerlink" title="行键前缀过滤器 (PrefixFilter)"></a>行键前缀过滤器 (PrefixFilter)</h3><p>基于 RowKey 值决定某行数据是否被过滤。</p>
<figure class="highlight vbscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">PrefixFilter prefixFilter = <span class="keyword">new</span> Prefix<span class="built_in">Filter</span>(Bytes.toBytes(<span class="string">&quot;xxx&quot;</span>));</span><br><span class="line">scan.<span class="keyword">set</span><span class="built_in">Filter</span>(prefixFilter);</span><br></pre></td></tr></table></figure>

<h3 id="列名前缀过滤器-ColumnPrefixFilter"><a href="#列名前缀过滤器-ColumnPrefixFilter" class="headerlink" title="列名前缀过滤器 (ColumnPrefixFilter)"></a>列名前缀过滤器 (ColumnPrefixFilter)</h3><p>基于列限定符（列名）决定某行数据是否被过滤。</p>
<figure class="highlight vbscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ColumnPrefixFilter columnPrefixFilter = <span class="keyword">new</span> ColumnPrefix<span class="built_in">Filter</span>(Bytes.toBytes(<span class="string">&quot;xxx&quot;</span>));</span><br><span class="line"> scan.<span class="keyword">set</span><span class="built_in">Filter</span>(columnPrefixFilter);</span><br></pre></td></tr></table></figure>

<h3 id="分页过滤器-PageFilter"><a href="#分页过滤器-PageFilter" class="headerlink" title="分页过滤器 (PageFilter)"></a>分页过滤器 (PageFilter)</h3><p>可以使用这个过滤器实现对结果按行进行分页，创建 PageFilter 实例的时候需要传入每页的行数。</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">PageFilter</span><span class="params">(<span class="keyword">final</span> <span class="type">long</span> pageSize)</span> </span>&#123;</span><br><span class="line">    Preconditions.<span class="built_in">checkArgument</span>(pageSize &gt;= <span class="number">0</span>, <span class="string">&quot;must be positive %s&quot;</span>, pageSize);</span><br><span class="line">    <span class="keyword">this</span>.pageSize = pageSize;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>下面的代码体现了客户端实现分页查询的主要逻辑，这里对其进行一下解释说明：</p>
<p>客户端进行分页查询，需要传递 <code>startRow</code>(起始 RowKey)，知道起始 <code>startRow</code> 后，就可以返回对应的 pageSize 行数据。这里唯一的问题就是，对于第一次查询，显然 <code>startRow</code> 就是表格的第一行数据，但是之后第二次、第三次查询我们并不知道 <code>startRow</code>，只能知道上一次查询的最后一条数据的 RowKey（简单称之为 <code>lastRow</code>）。</p>
<p>我们不能将 <code>lastRow</code> 作为新一次查询的 <code>startRow</code> 传入，因为 scan 的查询区间是[startRow，endRow) ，即前开后闭区间，这样 <code>startRow</code> 在新的查询也会被返回，这条数据就重复了。</p>
<p>同时在不使用第三方数据库存储 RowKey 的情况下，我们是无法通过知道 <code>lastRow</code> 的下一个 RowKey 的，因为 RowKey 的设计可能是连续的也有可能是不连续的。</p>
<p>由于 Hbase 的 RowKey 是按照字典序进行排序的。这种情况下，就可以在 <code>lastRow</code> 后面加上 <code>0</code> ，作为 <code>startRow</code> 传入，因为按照字典序的规则，某个值加上 <code>0</code> 后的新值，在字典序上一定是这个值的下一个值，对于 HBase 来说下一个 RowKey 在字典序上一定也是等于或者大于这个新值的。</p>
<p>所以最后传入 <code>lastRow</code>+<code>0</code>，如果等于这个值的 RowKey 存在就从这个值开始 scan,否则从字典序的下一个 RowKey 开始 scan。</p>
<blockquote>
<p>25 个字母以及数字字符，字典排序如下:</p>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;0&#x27;</span> &lt; <span class="string">&#x27;1&#x27;</span> &lt; <span class="string">&#x27;2&#x27;</span> &lt; <span class="params">...</span> &lt; <span class="string">&#x27;9&#x27;</span> &lt; <span class="string">&#x27;a&#x27;</span> &lt; <span class="string">&#x27;b&#x27;</span> &lt; <span class="params">...</span> &lt; <span class="string">&#x27;z&#x27;</span></span><br></pre></td></tr></table></figure>
</blockquote>
<p>分页查询主要实现逻辑：</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">byte[] POSTFIX = <span class="built_in">new</span> byte[] &#123; <span class="number">0x00</span> &#125;;</span><br><span class="line"><span class="keyword">Filter</span> <span class="keyword">filter</span> = <span class="built_in">new</span> PageFilter(<span class="number">15</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> totalRows = <span class="number">0</span>;</span><br><span class="line">byte[] lastRow = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">    Scan scan = <span class="built_in">new</span> Scan();</span><br><span class="line">    scan.setFilter(<span class="keyword">filter</span>);</span><br><span class="line">    <span class="keyword">if</span> (lastRow != <span class="keyword">null</span>) &#123;</span><br><span class="line">        // 如果不是首行 则 lastRow + <span class="number">0</span></span><br><span class="line">        byte[] startRow = Bytes.<span class="keyword">add</span>(lastRow, POSTFIX);</span><br><span class="line">        <span class="keyword">System</span>.<span class="keyword">out</span>.println(&quot;start row: &quot; +</span><br><span class="line">                           Bytes.toStringBinary(startRow));</span><br><span class="line">        scan.withStartRow(startRow);</span><br><span class="line">    &#125;</span><br><span class="line">    ResultScanner scanner = <span class="keyword">table</span>.getScanner(scan);</span><br><span class="line">    <span class="type">int</span> localRows = <span class="number">0</span>;</span><br><span class="line">    Result result;</span><br><span class="line">    <span class="keyword">while</span> ((result = scanner.next()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">System</span>.<span class="keyword">out</span>.println(localRows++ + &quot;: &quot; + result);</span><br><span class="line">        totalRows++;</span><br><span class="line">        lastRow = result.getRow();</span><br><span class="line">    &#125;</span><br><span class="line">    scanner.<span class="keyword">close</span>();</span><br><span class="line">    //最后一页，查询结束</span><br><span class="line">    <span class="keyword">if</span> (localRows == <span class="number">0</span>) break;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">System</span>.<span class="keyword">out</span>.println(&quot;total rows: &quot; + totalRows);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>需要注意的是在多台 Regin Services 上执行分页过滤的时候，由于并行执行的过滤器不能共享它们的状态和边界，所以有可能每个过滤器都会在完成扫描前获取了 PageCount 行的结果，这种情况下会返回比分页条数更多的数据，分页过滤器就有失效的可能。</p>
</blockquote>
<h3 id="时间戳过滤器-TimestampsFilter"><a href="#时间戳过滤器-TimestampsFilter" class="headerlink" title="时间戳过滤器 (TimestampsFilter)"></a>时间戳过滤器 (TimestampsFilter)</h3><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Long&gt; list <span class="operator">=</span> new ArrayList&lt;&gt;()<span class="comment">;</span></span><br><span class="line">list.add(<span class="number">1554975573000</span>L)<span class="comment">;</span></span><br><span class="line">TimestampsFilter timestampsFilter <span class="operator">=</span> new TimestampsFilter(list)<span class="comment">;</span></span><br><span class="line">scan.setFilter(timestampsFilter)<span class="comment">;</span></span><br></pre></td></tr></table></figure>

<h3 id="首次行键过滤器-FirstKeyOnlyFilter"><a href="#首次行键过滤器-FirstKeyOnlyFilter" class="headerlink" title="首次行键过滤器 (FirstKeyOnlyFilter)"></a>首次行键过滤器 (FirstKeyOnlyFilter)</h3><p><code>FirstKeyOnlyFilter</code> 只扫描每行的第一列，扫描完第一列后就结束对当前行的扫描，并跳转到下一行。相比于全表扫描，其性能更好，通常用于行数统计的场景，因为如果某一行存在，则行中必然至少有一列。</p>
<figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">FirstKeyOnlyFilter firstKeyOnlyFilter <span class="operator">=</span> new FirstKeyOnlyFilter()<span class="comment">;</span></span><br><span class="line">scan.set(firstKeyOnlyFilter)<span class="comment">;</span></span><br></pre></td></tr></table></figure>

<h2 id="包装过滤器"><a href="#包装过滤器" class="headerlink" title="包装过滤器"></a>包装过滤器</h2><p>包装过滤器就是通过包装其他过滤器以实现某些拓展的功能。</p>
<h3 id="SkipFilter-过滤器"><a href="#SkipFilter-过滤器" class="headerlink" title="SkipFilter 过滤器"></a>SkipFilter 过滤器</h3><p><code>SkipFilter</code> 包装一个过滤器，当被包装的过滤器遇到一个需要过滤的 KeyValue 实例时，则拓展过滤整行数据。下面是一个使用示例：</p>
<figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义 ValueFilter 过滤器</span></span><br><span class="line"><span class="built_in">Filter</span> filter1 = <span class="keyword">new</span> ValueFilter(CompareOperator.NOT_EQUAL,</span><br><span class="line">      <span class="keyword">new</span> BinaryComparator(Bytes.toBytes(<span class="string">&quot;xxx&quot;</span>)));</span><br><span class="line"><span class="comment">// 使用 SkipFilter 进行包装</span></span><br><span class="line"><span class="built_in">Filter</span> filter2 = <span class="keyword">new</span> SkipFilter(filter1);</span><br></pre></td></tr></table></figure>

<h3 id="WhileMatchFilter-过滤器"><a href="#WhileMatchFilter-过滤器" class="headerlink" title="WhileMatchFilter 过滤器"></a>WhileMatchFilter 过滤器</h3><p><code>WhileMatchFilter</code> 包装一个过滤器，当被包装的过滤器遇到一个需要过滤的 KeyValue 实例时，<code>WhileMatchFilter</code> 则结束本次扫描，返回已经扫描到的结果。下面是其使用示例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">Filter filter1 = new RowFilter(CompareOperator.NOT_EQUAL,</span><br><span class="line">                               new BinaryComparator(Bytes.toBytes(<span class="string">&quot;rowKey4&quot;</span>)));</span><br><span class="line"></span><br><span class="line">Scan scan = new Scan();</span><br><span class="line">scan.setFilter(filter1);</span><br><span class="line">ResultScanner scanner1 = table.getScanner(scan);</span><br><span class="line"><span class="keyword">for</span> (Result result : scanner1) &#123;</span><br><span class="line">    <span class="keyword">for</span> (Cell cell : result.listCells()) &#123;</span><br><span class="line">        System.out.println(cell);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">scanner1.close();</span><br><span class="line"></span><br><span class="line">System.out.println(<span class="string">&quot;--------------------&quot;</span>);</span><br><span class="line"></span><br><span class="line">// 使用 WhileMatchFilter 进行包装</span><br><span class="line">Filter filter2 = new WhileMatchFilter(filter1);</span><br><span class="line"></span><br><span class="line">scan.setFilter(filter2);</span><br><span class="line">ResultScanner scanner2 = table.getScanner(scan);</span><br><span class="line"><span class="keyword">for</span> (Result result : scanner1) &#123;</span><br><span class="line">    <span class="keyword">for</span> (Cell cell : result.listCells()) &#123;</span><br><span class="line">        System.out.println(cell);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">scanner2.close();</span><br><span class="line">rowKey0/student:name/1555035006994/Put/vlen=8/seqid=0</span><br><span class="line">rowKey1/student:name/1555035007019/Put/vlen=8/seqid=0</span><br><span class="line">rowKey2/student:name/1555035007025/Put/vlen=8/seqid=0</span><br><span class="line">rowKey3/student:name/1555035007037/Put/vlen=8/seqid=0</span><br><span class="line">rowKey5/student:name/1555035007051/Put/vlen=8/seqid=0</span><br><span class="line">rowKey6/student:name/1555035007057/Put/vlen=8/seqid=0</span><br><span class="line">rowKey7/student:name/1555035007062/Put/vlen=8/seqid=0</span><br><span class="line">rowKey8/student:name/1555035007068/Put/vlen=8/seqid=0</span><br><span class="line">rowKey9/student:name/1555035007073/Put/vlen=8/seqid=0</span><br><span class="line">--------------------</span><br><span class="line">rowKey0/student:name/1555035006994/Put/vlen=8/seqid=0</span><br><span class="line">rowKey1/student:name/1555035007019/Put/vlen=8/seqid=0</span><br><span class="line">rowKey2/student:name/1555035007025/Put/vlen=8/seqid=0</span><br><span class="line">rowKey3/student:name/1555035007037/Put/vlen=8/seqid=0</span><br></pre></td></tr></table></figure>

<p>可以看到被包装后，只返回了 <code>rowKey4</code> 之前的数据。</p>
<h2 id="FilterList"><a href="#FilterList" class="headerlink" title="FilterList"></a>FilterList</h2><p>以上都是讲解单个过滤器的作用，当需要多个过滤器共同作用于一次查询的时候，就需要使用 <code>FilterList</code>。<code>FilterList</code> 支持通过构造器或者 <code>addFilter</code> 方法传入多个过滤器。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 构造器传入</span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">FilterList</span><span class="params">(<span class="keyword">final</span> Operator operator, <span class="keyword">final</span> List&lt;Filter&gt; filters)</span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">FilterList</span><span class="params">(<span class="keyword">final</span> List&lt;Filter&gt; filters)</span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">FilterList</span><span class="params">(<span class="keyword">final</span> Filter... filters)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 方法传入</span></span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addFilter</span><span class="params">(List&lt;Filter&gt; filters)</span></span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addFilter</span><span class="params">(Filter filter)</span></span><br></pre></td></tr></table></figure>

<p>多个过滤器组合的结果由 <code>operator</code> 参数定义 ，其可选参数定义在 <code>Operator</code> 枚举类中。只有 <code>MUST_PASS_ALL</code> 和 <code>MUST_PASS_ONE</code> 两个可选的值：</p>
<ul>
<li><strong>MUST_PASS_ALL</strong> ：相当于 AND，必须所有的过滤器都通过才认为通过；</li>
<li><strong>MUST_PASS_ONE</strong> ：相当于 OR，只有要一个过滤器通过则认为通过。</li>
</ul>
<figure class="highlight d"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">@InterfaceAudience</span>.Public</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">enum</span> Operator &#123;</span><br><span class="line">    <span class="comment">/** !AND */</span></span><br><span class="line">    MUST_PASS_ALL,</span><br><span class="line">    <span class="comment">/** !OR */</span></span><br><span class="line">    MUST_PASS_ONE</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>使用示例如下：</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">List&lt;<span class="keyword">Filter</span>&gt; filters = <span class="built_in">new</span> ArrayList&lt;<span class="keyword">Filter</span>&gt;();</span><br><span class="line"></span><br><span class="line"><span class="keyword">Filter</span> filter1 = <span class="built_in">new</span> RowFilter(CompareOperator.GREATER_OR_EQUAL,</span><br><span class="line">                               <span class="built_in">new</span> BinaryComparator(Bytes.toBytes(&quot;XXX&quot;)));</span><br><span class="line">filters.<span class="keyword">add</span>(filter1);</span><br><span class="line"></span><br><span class="line"><span class="keyword">Filter</span> filter2 = <span class="built_in">new</span> RowFilter(CompareOperator.LESS_OR_EQUAL,</span><br><span class="line">                               <span class="built_in">new</span> BinaryComparator(Bytes.toBytes(&quot;YYY&quot;)));</span><br><span class="line">filters.<span class="keyword">add</span>(filter2);</span><br><span class="line"></span><br><span class="line"><span class="keyword">Filter</span> filter3 = <span class="built_in">new</span> QualifierFilter(CompareOperator.EQUAL,</span><br><span class="line">                                     <span class="built_in">new</span> RegexStringComparator(&quot;ZZZ&quot;));</span><br><span class="line">filters.<span class="keyword">add</span>(filter3);</span><br><span class="line"></span><br><span class="line">FilterList filterList = <span class="built_in">new</span> FilterList(filters);</span><br><span class="line"></span><br><span class="line">Scan scan = <span class="built_in">new</span> Scan();</span><br><span class="line">scan.setFilter(filterList);</span><br></pre></td></tr></table></figure>

<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a target="_blank" rel="noopener" href="https://item.jd.com/11321037.html">《HBase 权威指南》</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/larsgeorge/hbase-book">《HBase 权威指南》官方源码</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://dunwu.github.io/blog/pages/b292f5cf/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/uploads/avatar.gif">
      <meta itemprop="name" content="钝悟 ◾ Dunwu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dunwu Blog">
      <meta itemprop="description" content="钝悟的个人博客">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Dunwu Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/pages/b292f5cf/" class="post-title-link" itemprop="url">HBase Java API 基础特性</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-03-15 20:28:32" itemprop="dateCreated datePublished" datetime="2023-03-15T20:28:32+08:00">2023-03-15</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-09-13 17:56:53" itemprop="dateModified" datetime="2025-09-13T17:56:53+08:00">2025-09-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/" itemprop="url" rel="index"><span itemprop="name">数据库</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%88%97%E5%BC%8F%E6%95%B0%E6%8D%AE%E5%BA%93/" itemprop="url" rel="index"><span itemprop="name">列式数据库</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%88%97%E5%BC%8F%E6%95%B0%E6%8D%AE%E5%BA%93/hbase/" itemprop="url" rel="index"><span itemprop="name">hbase</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>12k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>11 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="HBase-Java-API-基础特性"><a href="#HBase-Java-API-基础特性" class="headerlink" title="HBase Java API 基础特性"></a>HBase Java API 基础特性</h1><h2 id="HBase-Client-API"><a href="#HBase-Client-API" class="headerlink" title="HBase Client API"></a>HBase Client API</h2><h3 id="HBase-Java-API-示例"><a href="#HBase-Java-API-示例" class="headerlink" title="HBase Java API 示例"></a>HBase Java API 示例</h3><p>引入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.hbase<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hbase-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>示例</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HBaseUtils</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Connection connection;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="type">Configuration</span> <span class="variable">configuration</span> <span class="operator">=</span> HBaseConfiguration.create();</span><br><span class="line">        configuration.set(<span class="string">&quot;hbase.zookeeper.property.clientPort&quot;</span>, <span class="string">&quot;2181&quot;</span>);</span><br><span class="line">        <span class="comment">// 如果是集群 则主机名用逗号分隔</span></span><br><span class="line">        configuration.set(<span class="string">&quot;hbase.zookeeper.quorum&quot;</span>, <span class="string">&quot;hadoop001&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            connection = ConnectionFactory.createConnection(configuration);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建 HBase 表</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> tableName      表名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> columnFamilies 列族的数组</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">createTable</span><span class="params">(String tableName, List&lt;String&gt; columnFamilies)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">HBaseAdmin</span> <span class="variable">admin</span> <span class="operator">=</span> (HBaseAdmin) connection.getAdmin();</span><br><span class="line">            <span class="keyword">if</span> (admin.tableExists(TableName.valueOf(tableName))) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">TableDescriptorBuilder</span> <span class="variable">tableDescriptor</span> <span class="operator">=</span> TableDescriptorBuilder.newBuilder(TableName.valueOf(tableName));</span><br><span class="line">            columnFamilies.forEach(columnFamily -&gt; &#123;</span><br><span class="line">                <span class="type">ColumnFamilyDescriptorBuilder</span> <span class="variable">cfDescriptorBuilder</span> <span class="operator">=</span> ColumnFamilyDescriptorBuilder.newBuilder(Bytes.toBytes(columnFamily));</span><br><span class="line">                cfDescriptorBuilder.setMaxVersions(<span class="number">1</span>);</span><br><span class="line">                <span class="type">ColumnFamilyDescriptor</span> <span class="variable">familyDescriptor</span> <span class="operator">=</span> cfDescriptorBuilder.build();</span><br><span class="line">                tableDescriptor.setColumnFamily(familyDescriptor);</span><br><span class="line">            &#125;);</span><br><span class="line">            admin.createTable(tableDescriptor.build());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 删除 hBase 表</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> tableName 表名</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">deleteTable</span><span class="params">(String tableName)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">HBaseAdmin</span> <span class="variable">admin</span> <span class="operator">=</span> (HBaseAdmin) connection.getAdmin();</span><br><span class="line">            <span class="comment">// 删除表前需要先禁用表</span></span><br><span class="line">            admin.disableTable(TableName.valueOf(tableName));</span><br><span class="line">            admin.deleteTable(TableName.valueOf(tableName));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 插入数据</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> tableName        表名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> rowKey           唯一标识</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> columnFamilyName 列族名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> qualifier        列标识</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> value            数据</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">putRow</span><span class="params">(String tableName, String rowKey, String columnFamilyName, String qualifier,</span></span><br><span class="line"><span class="params">                                 String value)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Table</span> <span class="variable">table</span> <span class="operator">=</span> connection.getTable(TableName.valueOf(tableName));</span><br><span class="line">            <span class="type">Put</span> <span class="variable">put</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Put</span>(Bytes.toBytes(rowKey));</span><br><span class="line">            put.addColumn(Bytes.toBytes(columnFamilyName), Bytes.toBytes(qualifier), Bytes.toBytes(value));</span><br><span class="line">            table.put(put);</span><br><span class="line">            table.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 插入数据</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> tableName        表名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> rowKey           唯一标识</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> columnFamilyName 列族名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> pairList         列标识和值的集合</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">putRow</span><span class="params">(String tableName, String rowKey, String columnFamilyName, List&lt;Pair&lt;String, String&gt;&gt; pairList)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Table</span> <span class="variable">table</span> <span class="operator">=</span> connection.getTable(TableName.valueOf(tableName));</span><br><span class="line">            <span class="type">Put</span> <span class="variable">put</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Put</span>(Bytes.toBytes(rowKey));</span><br><span class="line">            pairList.forEach(pair -&gt; put.addColumn(Bytes.toBytes(columnFamilyName), Bytes.toBytes(pair.getKey()), Bytes.toBytes(pair.getValue())));</span><br><span class="line">            table.put(put);</span><br><span class="line">            table.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据 rowKey 获取指定行的数据</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> tableName 表名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> rowKey    唯一标识</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Result <span class="title function_">getRow</span><span class="params">(String tableName, String rowKey)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Table</span> <span class="variable">table</span> <span class="operator">=</span> connection.getTable(TableName.valueOf(tableName));</span><br><span class="line">            <span class="type">Get</span> <span class="variable">get</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Get</span>(Bytes.toBytes(rowKey));</span><br><span class="line">            <span class="keyword">return</span> table.get(get);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取指定行指定列 (cell) 的最新版本的数据</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> tableName    表名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> rowKey       唯一标识</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> columnFamily 列族</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> qualifier    列标识</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getCell</span><span class="params">(String tableName, String rowKey, String columnFamily, String qualifier)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Table</span> <span class="variable">table</span> <span class="operator">=</span> connection.getTable(TableName.valueOf(tableName));</span><br><span class="line">            <span class="type">Get</span> <span class="variable">get</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Get</span>(Bytes.toBytes(rowKey));</span><br><span class="line">            <span class="keyword">if</span> (!get.isCheckExistenceOnly()) &#123;</span><br><span class="line">                get.addColumn(Bytes.toBytes(columnFamily), Bytes.toBytes(qualifier));</span><br><span class="line">                <span class="type">Result</span> <span class="variable">result</span> <span class="operator">=</span> table.get(get);</span><br><span class="line">                <span class="type">byte</span>[] resultValue = result.getValue(Bytes.toBytes(columnFamily), Bytes.toBytes(qualifier));</span><br><span class="line">                <span class="keyword">return</span> Bytes.toString(resultValue);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 检索全表</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> tableName 表名</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ResultScanner <span class="title function_">getScanner</span><span class="params">(String tableName)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Table</span> <span class="variable">table</span> <span class="operator">=</span> connection.getTable(TableName.valueOf(tableName));</span><br><span class="line">            <span class="type">Scan</span> <span class="variable">scan</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scan</span>();</span><br><span class="line">            <span class="keyword">return</span> table.getScanner(scan);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 检索表中指定数据</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> tableName  表名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> filterList 过滤器</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ResultScanner <span class="title function_">getScanner</span><span class="params">(String tableName, FilterList filterList)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Table</span> <span class="variable">table</span> <span class="operator">=</span> connection.getTable(TableName.valueOf(tableName));</span><br><span class="line">            <span class="type">Scan</span> <span class="variable">scan</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scan</span>();</span><br><span class="line">            scan.setFilter(filterList);</span><br><span class="line">            <span class="keyword">return</span> table.getScanner(scan);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 检索表中指定数据</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> tableName   表名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> startRowKey 起始 RowKey</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> endRowKey   终止 RowKey</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> filterList  过滤器</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ResultScanner <span class="title function_">getScanner</span><span class="params">(String tableName, String startRowKey, String endRowKey,</span></span><br><span class="line"><span class="params">                                           FilterList filterList)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Table</span> <span class="variable">table</span> <span class="operator">=</span> connection.getTable(TableName.valueOf(tableName));</span><br><span class="line">            <span class="type">Scan</span> <span class="variable">scan</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scan</span>();</span><br><span class="line">            scan.withStartRow(Bytes.toBytes(startRowKey));</span><br><span class="line">            scan.withStopRow(Bytes.toBytes(endRowKey));</span><br><span class="line">            scan.setFilter(filterList);</span><br><span class="line">            <span class="keyword">return</span> table.getScanner(scan);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 删除指定行记录</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> tableName 表名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> rowKey    唯一标识</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">deleteRow</span><span class="params">(String tableName, String rowKey)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Table</span> <span class="variable">table</span> <span class="operator">=</span> connection.getTable(TableName.valueOf(tableName));</span><br><span class="line">            <span class="type">Delete</span> <span class="variable">delete</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Delete</span>(Bytes.toBytes(rowKey));</span><br><span class="line">            table.delete(delete);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 删除指定行指定列</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> tableName  表名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> rowKey     唯一标识</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> familyName 列族</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> qualifier  列标识</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">deleteColumn</span><span class="params">(String tableName, String rowKey, String familyName,</span></span><br><span class="line"><span class="params">                                          String qualifier)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Table</span> <span class="variable">table</span> <span class="operator">=</span> connection.getTable(TableName.valueOf(tableName));</span><br><span class="line">            <span class="type">Delete</span> <span class="variable">delete</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Delete</span>(Bytes.toBytes(rowKey));</span><br><span class="line">            delete.addColumn(Bytes.toBytes(familyName), Bytes.toBytes(qualifier));</span><br><span class="line">            table.delete(delete);</span><br><span class="line">            table.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="数据库连接"><a href="#数据库连接" class="headerlink" title="数据库连接"></a>数据库连接</h2><p>在上面的代码中，在类加载时就初始化了 Connection 连接，并且之后的方法都是复用这个 Connection，这时我们可能会考虑是否可以使用自定义连接池来获取更好的性能表现？实际上这是没有必要的。</p>
<p>首先官方对于 <code>Connection</code> 的使用说明如下：</p>
<figure class="highlight sas"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Connection Pooling For applications which require high-<span class="keyword">end</span> multithreaded</span><br><span class="line">access (e.g., web-servers <span class="keyword">or</span>  application servers  that may serve many</span><br><span class="line">application threads <span class="keyword">in</span> a single JVM), you can pre-<span class="keyword">create</span> a Connection,</span><br><span class="line"><span class="keyword">as</span> shown <span class="keyword">in</span> the following example:</span><br><span class="line"></span><br><span class="line">对于高并发多线程访问的应用程序（例如，在单个 JVM 中存在的为多个线程服务的 Web 服务器或应用程序服务器），</span><br><span class="line">您只需要预先创建一个 Connection。例子如下：</span><br><span class="line"></span><br><span class="line">// <span class="keyword">Create</span> a connection to the cluster.</span><br><span class="line">Configuration conf = HBaseConfiguration.<span class="keyword">create</span>();</span><br><span class="line">try (Connection connection = ConnectionFactory.createConnectio<span class="meta">n</span>(conf);</span><br><span class="line">     <span class="keyword">Table</span> <span class="keyword">table</span> = connection.getTable(TableName.valueOf(tablename))) &#123;</span><br><span class="line">  // use <span class="keyword">table</span> <span class="keyword">as</span> needed, the <span class="keyword">table</span> returned is lightweight</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>之所以能这样使用，这是因为 Connection 并不是一个简单的 socket 连接，<a target="_blank" rel="noopener" href="https://hbase.apache.org/apidocs/org/apache/hadoop/hbase/client/Connection.html">接口文档</a> 中对 Connection 的表述是：</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">A <span class="keyword">cluster</span> <span class="keyword">connection</span> encapsulating lower <span class="keyword">level</span> individual connections <span class="keyword">to</span> actual servers <span class="keyword">and</span> a</span><br><span class="line"><span class="keyword">connection</span> <span class="keyword">to</span> zookeeper.  Connections are instantiated through the ConnectionFactory <span class="keyword">class</span>.</span><br><span class="line">The lifecycle <span class="keyword">of</span> the <span class="keyword">connection</span> <span class="keyword">is</span> managed <span class="keyword">by</span> the caller,  who has <span class="keyword">to</span> <span class="keyword">close</span>() the <span class="keyword">connection</span></span><br><span class="line"><span class="keyword">to</span> <span class="keyword">release</span> the resources.</span><br><span class="line"></span><br><span class="line"><span class="keyword">Connection</span> 是一个集群连接，封装了与多台服务器（Matser/Region <span class="keyword">Server</span>）的底层连接以及与 zookeeper 的连接。</span><br><span class="line">连接通过 ConnectionFactory  类实例化。连接的生命周期由调用者管理，调用者必须使用 <span class="keyword">close</span>() 关闭连接以释放资源。</span><br></pre></td></tr></table></figure>

<p>之所以封装这些连接，是因为 HBase 客户端需要连接三个不同的服务角色：</p>
<ul>
<li><strong>Zookeeper</strong> ：主要用于获取 <code>meta</code> 表的位置信息，Master 的信息；</li>
<li><strong>HBase Master</strong> ：主要用于执行 HBaseAdmin 接口的一些操作，例如建表等；</li>
<li><strong>HBase RegionServer</strong> ：用于读、写数据。</li>
</ul>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/20230315202403.png"></p>
<p>Connection 对象和实际的 Socket 连接之间的对应关系如下图：</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/20230315202426.png"></p>
<p>在 HBase 客户端代码中，真正对应 Socket 连接的是 <code>RpcConnection</code> 对象。HBase 使用 <code>PoolMap</code> 这种数据结构来存储客户端到 HBase 服务器之间的连接。<code>PoolMap</code> 的内部有一个 <code>ConcurrentHashMap</code> 实例，其 key 是 <code>ConnectionId</code>（封装了服务器地址和用户 ticket)，value 是一个 <code>RpcConnection</code> 对象的资源池。当 HBase 需要连接一个服务器时，首先会根据 <code>ConnectionId</code> 找到对应的连接池，然后从连接池中取出一个连接对象。</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">@InterfaceAudience.Private</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="symbol">PoolMap</span>&lt;<span class="symbol">K, <span class="symbol">V</span></span>&gt; <span class="symbol">implements</span> <span class="symbol">Map</span>&lt;<span class="symbol">K, <span class="symbol">V</span></span>&gt; &#123;</span><br><span class="line">  <span class="keyword">private</span> PoolType poolType;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="built_in">int</span> poolMaxSize;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> Map&lt;K, Pool&lt;V&gt;&gt; pools = new ConcurrentHashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> PoolMap(PoolType poolType) &#123;</span><br><span class="line">    <span class="keyword">this</span>.poolType = poolType;</span><br><span class="line">  &#125;</span><br><span class="line">  .....</span><br></pre></td></tr></table></figure>

<p>HBase 中提供了三种资源池的实现，分别是 <code>Reusable</code>，<code>RoundRobin</code> 和 <code>ThreadLocal</code>。具体实现可以通 <code>hbase.client.ipc.pool.type</code> 配置项指定，默认为 <code>Reusable</code>。连接池的大小也可以通过 <code>hbase.client.ipc.pool.size</code> 配置项指定，默认为 1，即每个 Server 1 个连接。也可以通过修改配置实现：</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">config</span><span class="meta">.set</span>(<span class="string">&quot;hbase.client.ipc.pool.type&quot;</span>,...);</span><br><span class="line"><span class="built_in">config</span><span class="meta">.set</span>(<span class="string">&quot;hbase.client.ipc.pool.size&quot;</span>,...);</span><br><span class="line">connection = ConnectionFactory.createConnection(<span class="built_in">config</span>);</span><br></pre></td></tr></table></figure>

<p>由此可以看出 HBase 中 Connection 类已经实现了对连接的管理功能，所以我们不必在 Connection 上在做额外的管理。</p>
<p>另外，Connection 是线程安全的，但 Table 和 Admin 却不是线程安全的，因此正确的做法是一个进程共用一个 Connection 对象，而在不同的线程中使用单独的 Table 和 Admin 对象。Table 和 Admin 的获取操作 <code>getTable()</code> 和 <code>getAdmin()</code> 都是轻量级，所以不必担心性能的消耗，同时建议在使用完成后显示的调用 <code>close()</code> 方法来关闭它们。</p>
<h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>HBase 的主要客户端操作是由 <code>org.apache.hadoop.hbase.client.HTable</code> 提供的。创建 HTable 实例非常耗时，所以，建议每个线程只创建一次 HTable 实例。</p>
<p>HBase 所有修改数据的操作都保证了行级别的原子性。要么读到最新的修改，要么等待系统允许写入改行修改</p>
<p>用户要尽量使用批处理 (batch) 更新来减少单独操作同一行数据的次数</p>
<p>写操作中设计的列的数目并不会影响该行数据的原子性，行原子性会同时保护到所有列</p>
<p>创建 HTable 实例（指的是在 java 中新建该类），每个实例都要扫描。META. 表，以检查该表是否存在，推荐用户只创建一次 HTable 实例，而且是每个线程创建一个</p>
<p>如果用户需要多个 HTable 实例，建议使用 HTablePool 类（类似连接池）</p>
<h2 id="CRUD-操作"><a href="#CRUD-操作" class="headerlink" title="CRUD 操作"></a>CRUD 操作</h2><h3 id="put"><a href="#put" class="headerlink" title="put"></a>put</h3><p><code>Table</code> 接口提供了两个 <code>put</code> 方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 写入单行 put</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">put</span><span class="params">(Put put)</span> <span class="keyword">throws</span> IOException;</span><br><span class="line"><span class="comment">// 批量写入 put</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">put</span><span class="params">(List&lt;Put&gt; puts)</span> <span class="keyword">throws</span> IOException;</span><br></pre></td></tr></table></figure>

<p>Put 类提供了多种构造器方法用来初始化实例。</p>
<p>Put 类还提供了一系列有用的方法：</p>
<p>多个 <code>add</code> 方法：用于添加指定的列数据。</p>
<p><code>has</code> 方法：用于检查是否存在特定的单元格，而不需要遍历整个集合</p>
<p><code>getFamilyMap</code> 方法：可以遍历 Put 实例中每一个可用的 KeyValue 实例</p>
<p>getRow 方法：用于获取 rowkey<br>Put.heapSize() 可以计算当前 Put 实例所需的堆大小，既包含其中的数据，也包含内部数据结构所需的空间</p>
<h4 id="KeyValue-类"><a href="#KeyValue-类" class="headerlink" title="KeyValue 类"></a>KeyValue 类</h4><p>特定单元格的数据以及坐标，坐标包括行键、列族名、列限定符以及时间戳<br><code>KeyValue(byte[] row, int roffset, int rlength, byte[] family, int foffoset, int flength, byte[] qualifier, int qoffset, int qlength, long timestamp, Type type, byte[] value, int voffset, int vlength)</code><br>每一个字节数组都有一个 offset 参数和一个 length 参数，允许用户提交一个已经存在的字节数组进行字节级别操作。<br>行目前来说指的是行键，即 Put 构造器里的 row 参数。</p>
<h4 id="客户端的写缓冲区"><a href="#客户端的写缓冲区" class="headerlink" title="客户端的写缓冲区"></a>客户端的写缓冲区</h4><p>每一个 put 操作实际上都是一个 RPC 操作，它将客户端数据传送到服务器然后返回。</p>
<p>HBase 的 API 配备了一个客户端的写缓冲区，缓冲区负责收集 put 操作，然后调用 RPC 操作一次性将 put 送往服务器。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">setAutoFlush</span><span class="params">(<span class="type">boolean</span> autoFlush)</span></span><br><span class="line"><span class="type">boolean</span> <span class="title function_">isAutoFlush</span><span class="params">()</span></span><br></pre></td></tr></table></figure>

<p>默认情况下，客户端缓冲区是禁用的。可以通过 <code>table.setAutoFlush(false)</code> 来激活缓冲区。</p>
<h4 id="Put-列表"><a href="#Put-列表" class="headerlink" title="Put 列表"></a>Put 列表</h4><p>批量提交 <code>put</code> 列表：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">put</span><span class="params">(List&lt;Put&gt; puts)</span> <span class="keyword">throws</span> IOException</span><br></pre></td></tr></table></figure>

<p>注意：批量提交可能会有部分修改失败。</p>
<h4 id="原子性操作-compare-and-set"><a href="#原子性操作-compare-and-set" class="headerlink" title="原子性操作 compare-and-set"></a>原子性操作 compare-and-set</h4><p><code>checkAndPut</code> 方法提供了 CAS 机制来保证 put 操作的原子性。</p>
<h3 id="get"><a href="#get" class="headerlink" title="get"></a>get</h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Result <span class="built_in">get</span>(<span class="built_in">Get</span> get) throws IOException</span><br></pre></td></tr></table></figure>

<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Get(<span class="built_in">byte</span>[] row)</span><br><span class="line">Get(<span class="built_in">byte</span>[] row, RowLock rowLock)</span><br><span class="line"><span class="function">Get <span class="title">addColumn</span>(<span class="params"><span class="built_in">byte</span>[] family, <span class="built_in">byte</span>[] qualifier</span>)</span></span><br><span class="line"><span class="function">Get <span class="title">addFamily</span>(<span class="params"><span class="built_in">byte</span>[] family</span>)</span></span><br></pre></td></tr></table></figure>

<h4 id="Result-类"><a href="#Result-类" class="headerlink" title="Result 类"></a>Result 类</h4><p>当用户使用 <code>get()</code> 方法获取数据，HBase 返回的结果包含所有匹配的单元格数据，这些数据被封装在一个 <code>Result</code> 实例中返回给用户。</p>
<p>Result 类提供的方法如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">byte</span>[] getValue(<span class="type">byte</span>[] family, <span class="type">byte</span>[] qualifier)</span><br><span class="line"><span class="type">byte</span>[] value()</span><br><span class="line"><span class="type">byte</span>[] getRow()</span><br><span class="line"><span class="type">int</span> <span class="title function_">size</span><span class="params">()</span></span><br><span class="line"><span class="type">boolean</span> <span class="title function_">isEmpty</span><span class="params">()</span></span><br><span class="line">KeyValue[] raw()</span><br><span class="line">List&lt;KeyValue&gt; <span class="title function_">list</span><span class="params">()</span></span><br></pre></td></tr></table></figure>

<h2 id="delete"><a href="#delete" class="headerlink" title="delete"></a>delete</h2><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="keyword">delete</span>(<span class="keyword">Delete</span> <span class="keyword">delete</span>) <span class="keyword">throws</span> IOException</span><br></pre></td></tr></table></figure>

<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Delte(<span class="built_in">byte</span>[] row)</span><br><span class="line">Delete(<span class="built_in">byte</span>[] row, <span class="built_in">long</span> timestamp, RowLock rowLock)</span><br></pre></td></tr></table></figure>

<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Delete <span class="title">deleteFamily</span>(<span class="params"><span class="built_in">byte</span>[] family</span>)</span></span><br><span class="line"><span class="function">Delete <span class="title">deleteFamily</span>(<span class="params"><span class="built_in">byte</span>[] family, <span class="built_in">long</span> timestamp</span>)</span></span><br><span class="line"><span class="function">Delete <span class="title">deleteColumns</span>(<span class="params"><span class="built_in">byte</span>[] family, <span class="built_in">byte</span>[] qualifier</span>)</span></span><br><span class="line"><span class="function">Delete <span class="title">deleteColumn</span>(<span class="params"><span class="built_in">byte</span>[] family, <span class="built_in">byte</span>[] qualifier</span>) <span class="comment">// 只删除最新版本</span></span></span><br></pre></td></tr></table></figure>

<h2 id="批处理操作"><a href="#批处理操作" class="headerlink" title="批处理操作"></a>批处理操作</h2><p>Row 是 Put、Get、Delete 的父类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">batch</span><span class="params">(List&lt;Row&gt; actions, Object[] results)</span> <span class="keyword">throws</span> IOException, InterruptedException</span><br><span class="line">Object <span class="title function_">batch</span><span class="params">(List&lt;Row&gt; actions)</span> <span class="keyword">throws</span> IOException, InterruptedException</span><br></pre></td></tr></table></figure>

<h2 id="行锁"><a href="#行锁" class="headerlink" title="行锁"></a>行锁</h2><p>region 服务器提供了行锁特性，这个特性保证了只有一个客户端能获取一行数据相应的锁，同时对该行进行修改。</p>
<p>如果不显示指定锁，服务器会隐式加锁。</p>
<h2 id="扫描"><a href="#扫描" class="headerlink" title="扫描"></a>扫描</h2><p>scan，类似数据库系统中的 cursor，利用了 HBase 提供的底层顺序存储的数据结构。</p>
<p>调用 HTable 的 getScanner 就可以返回扫描器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ResultScanner <span class="title function_">getScanner</span><span class="params">(Scan scan)</span> <span class="keyword">throws</span> IOException</span><br><span class="line">ResultScanner <span class="title function_">getScanner</span><span class="params">(<span class="type">byte</span>[] family)</span> <span class="keyword">throws</span> IOException</span><br></pre></td></tr></table></figure>

<p>Scan 类构造器可以有 startRow，区间一般为 [startRow, stopRow)</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Scan(<span class="built_in">byte</span>[] startRow, Filter filter)</span><br><span class="line">Scan(<span class="built_in">byte</span>[] startRow)</span><br></pre></td></tr></table></figure>

<h3 id="ResultScanner"><a href="#ResultScanner" class="headerlink" title="ResultScanner"></a>ResultScanner</h3><p>以行为单位进行返回</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Result <span class="title function_">next</span><span class="params">()</span> <span class="keyword">throws</span> IOException</span><br><span class="line">Result[] next(<span class="type">int</span> nbRows) <span class="keyword">throws</span> IOException</span><br><span class="line"><span class="keyword">void</span> <span class="title function_">close</span><span class="params">()</span></span><br></pre></td></tr></table></figure>

<h3 id="缓存与批量处理"><a href="#缓存与批量处理" class="headerlink" title="缓存与批量处理"></a>缓存与批量处理</h3><p>每一个 next() 调用都会为每行数据生成一个单独的 RPC 请求</p>
<p>可以设置扫描器缓存</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">setScannerCaching</span><span class="params">(itn scannerCaching)</span></span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">getScannerCaching</span><span class="params">()</span></span></span><br></pre></td></tr></table></figure>

<p>缓存是面向行一级操作，批量是面向列一级操作</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">setBatch</span><span class="params">(<span class="type">int</span> batch)</span></span></span><br><span class="line"><span class="function"><span class="type">int</span> getBatch</span></span><br></pre></td></tr></table></figure>

<p>RPC 请求的次数&#x3D;（行数、*每行列数）&#x2F;Min（每行的列数，批量大小）&#x2F;扫描器缓存</p>
<h2 id="各种特性"><a href="#各种特性" class="headerlink" title="各种特性"></a>各种特性</h2><p><code>Bytes</code> 类提供了一系列将原生 Java 类型和字节数组互转的方法。</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a target="_blank" rel="noopener" href="https://item.jd.com/11321037.html">《HBase 权威指南》</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/larsgeorge/hbase-book">《HBase 权威指南》官方源码</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://dunwu.github.io/blog/pages/df9fb916/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/uploads/avatar.gif">
      <meta itemprop="name" content="钝悟 ◾ Dunwu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dunwu Blog">
      <meta itemprop="description" content="钝悟的个人博客">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Dunwu Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/pages/df9fb916/" class="post-title-link" itemprop="url">HBase Schema 设计</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-03-15 20:28:32" itemprop="dateCreated datePublished" datetime="2023-03-15T20:28:32+08:00">2023-03-15</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-09-13 17:56:53" itemprop="dateModified" datetime="2025-09-13T17:56:53+08:00">2025-09-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/" itemprop="url" rel="index"><span itemprop="name">数据库</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%88%97%E5%BC%8F%E6%95%B0%E6%8D%AE%E5%BA%93/" itemprop="url" rel="index"><span itemprop="name">列式数据库</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%88%97%E5%BC%8F%E6%95%B0%E6%8D%AE%E5%BA%93/hbase/" itemprop="url" rel="index"><span itemprop="name">hbase</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>4.6k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>4 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="HBase-Schema-设计"><a href="#HBase-Schema-设计" class="headerlink" title="HBase Schema 设计"></a>HBase Schema 设计</h1><h2 id="HBase-Schema-设计要素"><a href="#HBase-Schema-设计要素" class="headerlink" title="HBase Schema 设计要素"></a>HBase Schema 设计要素</h2><ul>
<li>这个表应该有多少 Column Family</li>
<li>Column Family 使用什么数据</li>
<li>每个 Column Family 有有多少列</li>
<li>列名是什么，尽管列名不必在建表时定义，但读写数据是要知道的</li>
<li>单元应该存放什么数据</li>
<li>每个单元存储多少时间版本</li>
<li>行健(rowKey)结构是什么，应该包含什么信息</li>
</ul>
<h2 id="Row-Key-设计"><a href="#Row-Key-设计" class="headerlink" title="Row Key 设计"></a>Row Key 设计</h2><h3 id="Row-Key-的作用"><a href="#Row-Key-的作用" class="headerlink" title="Row Key 的作用"></a>Row Key 的作用</h3><p>在 HBase 中，所有对表的访问都要通过 Row Key，有三种访问方式：</p>
<ul>
<li>使用 <code>get</code> 命令，查询指定的 Row Key，即精确查找。</li>
<li>使用 scan 命令，根据 Row Key 进行范围查找。</li>
<li>全表扫描，即直接扫描表中所有行记录。</li>
</ul>
<p>此外，在 HBase 中，表中的行，是按照 Row Key 的字典序进行排序的。</p>
<p>由此，可见，Row Key 的良好设计对于 HBase CRUD 的性能至关重要。</p>
<h3 id="Row-Key-的设计原则"><a href="#Row-Key-的设计原则" class="headerlink" title="Row Key 的设计原则"></a>Row Key 的设计原则</h3><p><strong>长度原则</strong></p>
<p>RowKey 是一个二进制码流，可以是任意字符串，最大长度为 64kb，实际应用中一般为 10-100byte，以 byte[]形式保存，一般设计成定长。建议越短越好，不要超过 16 个字节，原因如下：</p>
<ol>
<li>数据的持久化文件 HFile 中时按照 Key-Value 存储的，如果 RowKey 过长，例如超过 100byte，那么 1000w 行的记录，仅 RowKey 就需占用近 1GB 的空间。这样会极大影响 HFile 的存储效率。</li>
<li>MemStore 会缓存部分数据到内存中，若 RowKey 字段过长，内存的有效利用率就会降低，就不能缓存更多的数据，从而降低检索效率。</li>
<li>目前操作系统都是 64 位系统，内存 8 字节对齐，控制在 16 字节，8 字节的整数倍利用了操作系统的最佳特性。</li>
</ol>
<p><strong>唯一原则</strong></p>
<p>必须在设计上保证 RowKey 的唯一性。由于在 HBase 中数据存储是 Key-Value 形式，若向 HBase 中同一张表插入相同 RowKey 的数据，则原先存在的数据会被新的数据覆盖。</p>
<p><strong>排序原则</strong></p>
<p>HBase 的 RowKey 是按照 ASCII 有序排序的，因此我们在设计 RowKey 的时候要充分利用这点。</p>
<p><strong>散列原则</strong></p>
<p>设计的 RowKey 应均匀的分布在各个 HBase 节点上。</p>
<h3 id="热点问题"><a href="#热点问题" class="headerlink" title="热点问题"></a>热点问题</h3><p>Region 是在 HBase 集群上分布数据的最小单位。每个 Region 由它所属的表的起始范围来表示（即起始 Row Key 和结束 Row Key）。</p>
<p>如果，Row Key 使用单调递增的整数或时间戳，就会产生一个问题：因为 Hbase 的 Row Key 是就近存储的，这会导致一段时间内大部分读写集中在某一个 Region 或少数 Region 上（根据二八原则，最近产生的数据，往往是读写频率最高的数据），即所谓 <strong>热点问题</strong>。</p>
<h4 id="反转（Reversing）"><a href="#反转（Reversing）" class="headerlink" title="反转（Reversing）"></a>反转（Reversing）</h4><p>第一种咱们要分析的方法是反转，顾名思义它就是把固定长度或者数字格式的 RowKey 进行反转，反转分为一般数据反转和时间戳反转，其中以时间戳反转较常见。</p>
<ul>
<li><strong>反转固定格式的数值</strong> - 以手机号为例，手机号的前缀变化比较少（如 <code>152、185</code> 等），但后半部分变化很多。如果将它反转过来，可以有效地避免热点。不过其缺点就是失去了有序性。</li>
<li><strong>反转时间</strong> - 如果数据访问以查找最近的数据为主，可以将时间戳存储为反向时间戳（例如： <code>timestamp = Long.MAX_VALUE – timestamp</code>），这样有利于扫描最近的数据。</li>
</ul>
<h4 id="加盐（Salting）"><a href="#加盐（Salting）" class="headerlink" title="加盐（Salting）"></a>加盐（Salting）</h4><p>这里的“加盐”与密码学中的“加盐”不是一回事。它是指在 RowKey 的前面增加一些前缀，加盐的前缀种类越多，RowKey 就被打得越散。</p>
<p>需要注意的是分配的随机前缀的种类数量应该和我们想把数据分散到的那些 region 的数量一致。只有这样，加盐之后的 rowkey 才会根据随机生成的前缀分散到各个 region 中，避免了热点现象。</p>
<h4 id="哈希（Hashing）"><a href="#哈希（Hashing）" class="headerlink" title="哈希（Hashing）"></a>哈希（Hashing）</h4><p>其实哈希和加盐的适用场景类似，但我们前缀不可以是随机的，因为必须要让客户端能够完整地重构 RowKey。所以一般会拿原 RowKey 或其一部分计算 Hash 值，然后再对 Hash 值做运算作为前缀。</p>
<h2 id="HBase-Schema-设计规则"><a href="#HBase-Schema-设计规则" class="headerlink" title="HBase Schema 设计规则"></a>HBase Schema 设计规则</h2><h3 id="Column-Family-设计"><a href="#Column-Family-设计" class="headerlink" title="Column Family 设计"></a>Column Family 设计</h3><p>HBase 不能很好处理 2 ~ 3 个以上的 Column Family，所以 <strong>HBase 表应尽可能减少 Column Family 数</strong>。如果可以，请只使用一个列族，只有需要经常执行 Column 范围查询时，才引入多列族。也就是说，尽量避免同时查询多个列族。</p>
<ul>
<li><strong>Column Family 数量多，会影响数据刷新</strong>。HBase 的数据刷新是在每个 Region 的基础上完成的。因此，如果一个 Column Family 携带大量导致刷新的数据，那么相邻的列族即使携带的数据量很小，也会被刷新。当存在许多 Column Family 时，刷新交互会导致一堆不必要的 IO。 此外，在表&#x2F;区域级别的压缩操作也会在每个存储中发生。</li>
<li><strong>Column Family 数量多，会影响查找效率</strong>。如：Column Family A 有 100 万行，Column Family B 有 10 亿行，那么 Column Family A 的数据可能会分布在很多很多区域（和 RegionServers）。 这会降低 Column Family A 的批量扫描效率。</li>
</ul>
<p>Column Family 名尽量简短，最好是一个字符。Column Family 会在列限定符中被频繁使用，缩短长度有利于节省空间并提升效率。</p>
<h3 id="Row-设计"><a href="#Row-设计" class="headerlink" title="Row 设计"></a>Row 设计</h3><p><strong>HBase 中的 Row 按 Row Key 的字典顺序排序</strong>。</p>
<ul>
<li><p><strong>不要将 Row Key 设计为单调递增的</strong>，例如：递增的整数或时间戳</p>
<ul>
<li><p>问题：因为 Hbase 的 Row Key 是就近存储的，这样会导致一段时间内大部分写入集中在某一个 Region 上，即所谓热点问题。</p>
</li>
<li><p>解决方法一、加盐：这里的不是指密码学的加盐，而是指将随机分配的前缀添加到行键的开头。这么做是为了避免相同前缀的 Row Key 数据被存储在相邻位置，从而导致热点问题。示例如下：</p>
<ul>
<li><pre><code>foo0001
foo0002
foo0003
foo0004

改为

a-foo0003
b-foo0001
c-foo0003
c-foo0004
d-foo0002
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">  - 解决方法二、Hash：<span class="keyword">Row</span> Key 的前缀使用 Hash</span><br><span class="line"></span><br><span class="line">- **尽量减少行和列的长度**</span><br><span class="line"></span><br><span class="line">- **反向时间戳**：反向时间戳可以极大地帮助快速找到值的最新版本。</span><br><span class="line"></span><br><span class="line">- **行健不能改变**：唯一可以改变的方式是先删除后插入。</span><br><span class="line"></span><br><span class="line">- **<span class="keyword">Row</span> Key 和 <span class="keyword">Column</span> <span class="keyword">Family</span>**：<span class="keyword">Row</span> Key 从属于 <span class="keyword">Column</span> <span class="keyword">Family</span>，因此，相同的 <span class="keyword">Row</span> Key 可以存在每一个 <span class="keyword">Column</span> <span class="keyword">Family</span> 中而不会出现冲突。</span><br><span class="line"></span><br><span class="line">### <span class="keyword">Version</span> 设计</span><br><span class="line"></span><br><span class="line">最大、最小 <span class="keyword">Row</span> 版本号：表示 HBase 会保留的版本号数的上下限。均可以通过 HColumnDescriptor 对每个列族进行配置</span><br><span class="line"></span><br><span class="line"><span class="keyword">Row</span> 版本号过大，会大大增加 StoreFile 的大小；所以，最大 <span class="keyword">Row</span> 版本号应按需设置。HBase 会在主要压缩时，删除多余的版本。</span><br><span class="line"></span><br><span class="line">### TTL 设计</span><br><span class="line"></span><br><span class="line"><span class="keyword">Column</span> <span class="keyword">Family</span> 会设置一个以秒为单位的 TTL，一旦达到 TTL 时，HBase 会自动删除行记录。</span><br><span class="line"></span><br><span class="line">仅包含过期行的存储文件在次要压缩时被删除。 将 hbase.store.<span class="keyword">delete</span>.expired.storefile 设置为 <span class="keyword">false</span> 会禁用此功能。将最小版本数设置为 <span class="number">0</span> 以外的值也会禁用此功能。</span><br><span class="line"></span><br><span class="line">在较新版本的 HBase 上，还支持在 Cell 上设置 TTL，与 <span class="keyword">Column</span> <span class="keyword">Family</span> 的 TTL 不同的是，单位是毫秒。</span><br><span class="line"></span><br><span class="line">### <span class="keyword">Column</span> <span class="keyword">Family</span> 属性配置</span><br><span class="line"></span><br><span class="line">- HFile 数据块，默认是 <span class="number">64</span>KB，数据库的大小影响数据块索引的大小。数据块大的话一次加载进内存的数据越多，扫描查询效果越好。但是数据块小的话，随机查询性能更好</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</code></pre>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<blockquote>
<p>create ‘mytable’,{NAME &#x3D;&gt; ‘cf1’, BLOCKSIZE &#x3D;&gt; ‘65536’}<br>复制代码</p>
</blockquote>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="bullet">- </span>数据块缓存，数据块缓存默认是打开的，如果一些比较少访问的数据可以选择关闭缓存</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<blockquote>
<p>create ‘mytable’,{NAME &#x3D;&gt; ‘cf1’, BLOCKCACHE &#x3D;&gt; ‘FALSE’}<br>复制代码</p>
</blockquote>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="bullet">- </span>数据压缩，压缩会提高磁盘利用率，但是会增加 CPU 的负载，看情况进行控制</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<blockquote>
<p>create ‘mytable’,{NAME &#x3D;&gt; ‘cf1’, COMPRESSION &#x3D;&gt; ‘SNAPPY’}<br>复制代码</p>
</blockquote>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">Hbase 表设计是和需求相关的，但是遵守表设计的一些硬性指标对性能的提升还是很有帮助的，这里整理了一些设计时用到的要点。</span><br><span class="line"></span><br><span class="line">## <span class="keyword">Schema</span> 设计案例</span><br><span class="line"></span><br><span class="line">### 案例：日志数据和时序数据</span><br><span class="line"></span><br><span class="line">假设采集以下数据</span><br><span class="line"></span><br><span class="line">- Hostname</span><br><span class="line">- <span class="type">Timestamp</span></span><br><span class="line">- <span class="keyword">Log</span> event</span><br><span class="line">- <span class="keyword">Value</span>/message</span><br><span class="line"></span><br><span class="line">应该如何设计 <span class="keyword">Row</span> Key？</span><br><span class="line"></span><br><span class="line">（<span class="number">1</span>）<span class="type">Timestamp</span> 在 <span class="keyword">Row</span> Key 头部</span><br><span class="line"></span><br><span class="line">如果 <span class="keyword">Row</span> Key 设计为 `[<span class="type">timestamp</span>][hostname][<span class="keyword">log</span>-event]` 形式，会出现热点问题。</span><br><span class="line"></span><br><span class="line">如果针对时间的扫描很重要，可以采用时间戳分桶策略，即</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>bucket &#x3D; timestamp % bucketNum</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">计算出桶号后，将 <span class="keyword">Row</span> Key 指定为：`[bucket][<span class="type">timestamp</span>][hostname][<span class="keyword">log</span>-event]`</span><br><span class="line"></span><br><span class="line">如上所述，要为特定时间范围选择数据，需要对每个桶执行扫描。 例如，<span class="number">100</span> 个桶将在键空间中提供广泛的分布，但需要 <span class="number">100</span> 次扫描才能获取单个时间戳的数据，因此需要权衡取舍。</span><br><span class="line"></span><br><span class="line">（<span class="number">2</span>）Hostname 在 <span class="keyword">Row</span> Key 头部</span><br><span class="line"></span><br><span class="line">如果主机样本量很大，将 <span class="keyword">Row</span> Key 设计为 `[hostname][<span class="keyword">log</span>-event][<span class="type">timestamp</span>]`，这样有利于扫描 hostname。</span><br><span class="line"></span><br><span class="line">（<span class="number">3</span>）<span class="type">Timestamp</span> 还是反向 <span class="type">Timestamp</span></span><br><span class="line"></span><br><span class="line">如果数据访问以查找最近的数据为主，可以将时间戳存储为反向时间戳（例如： `<span class="type">timestamp</span> = Long.MAX_VALUE – <span class="type">timestamp</span>`），这样有利于扫描最近的数据。</span><br><span class="line"></span><br><span class="line">（<span class="number">4</span>）<span class="keyword">Row</span> Key 是可变长度还是固定长度</span><br><span class="line"></span><br><span class="line">拼接 <span class="keyword">Row</span> Key 的关键字长度不一定是固定的，例如 hostname 有可能很长，也有可能很短。如果想要统一长度，可以参考以下做法：</span><br><span class="line"></span><br><span class="line">- 将关键字 Hash 编码：使用某种 Hash 算法计算关键字，并取固定长度的值（例如：<span class="number">8</span> 位或 <span class="number">16</span> 位）。</span><br><span class="line">- 使用数字替代关键字：例如：使用事件类型 Code 替换事件类型；hostname 如果是 IP，可以转换为 long</span><br><span class="line">- 截取关键字：截取后的关键字需要有足够的辨识度，长度大小根据具体情况权衡。</span><br><span class="line"></span><br><span class="line">（<span class="number">5</span>）时间分片</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>[hostname][log-event][timestamp1]<br>[hostname][log-event][timestamp2]<br>[hostname][log-event][timestamp3]</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">上面的例子中，每个详细事件都有单独的行键，可以重写如下，即每个时间段存储一次：</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>[hostname][log-event][timerange]</p>
<pre><code>
## 参考资料

- [HBase 官方文档之 HBase and Schema Design](https://hbase.apache.org/book.html#schema)
</code></pre>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://dunwu.github.io/blog/pages/fd8781db/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/uploads/avatar.gif">
      <meta itemprop="name" content="钝悟 ◾ Dunwu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dunwu Blog">
      <meta itemprop="description" content="钝悟的个人博客">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Dunwu Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/pages/fd8781db/" class="post-title-link" itemprop="url">《极客时间教程 - 大规模数据处理实战》笔记</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-03-15 15:15:07" itemprop="dateCreated datePublished" datetime="2023-03-15T15:15:07+08:00">2023-03-15</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-09-13 17:56:53" itemprop="dateModified" datetime="2025-09-13T17:56:53+08:00">2025-09-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">笔记</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/%E7%AC%94%E8%AE%B0/%E5%A4%A7%E6%95%B0%E6%8D%AE/" itemprop="url" rel="index"><span itemprop="name">大数据</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>2.3k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>2 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="《极客时间教程-大规模数据处理实战》笔记"><a href="#《极客时间教程-大规模数据处理实战》笔记" class="headerlink" title="《极客时间教程 - 大规模数据处理实战》笔记"></a>《极客时间教程 - 大规模数据处理实战》笔记</h1><h2 id="00-丨开篇词丨从这里开始，带你走上硅谷一线系统架构师之路"><a href="#00-丨开篇词丨从这里开始，带你走上硅谷一线系统架构师之路" class="headerlink" title="00 丨开篇词丨从这里开始，带你走上硅谷一线系统架构师之路"></a>00 丨开篇词丨从这里开始，带你走上硅谷一线系统架构师之路</h2><h2 id="01-丨为什么-MapReduce-会被硅谷一线公司淘汰？"><a href="#01-丨为什么-MapReduce-会被硅谷一线公司淘汰？" class="headerlink" title="01 丨为什么 MapReduce 会被硅谷一线公司淘汰？"></a>01 丨为什么 MapReduce 会被硅谷一线公司淘汰？</h2><p>高昂的维护成本</p>
<p>时间性能“达不到”用户的期待</p>
<h2 id="02-MapReduce-后谁主沉浮：怎样设计下一代数据处理技术？"><a href="#02-MapReduce-后谁主沉浮：怎样设计下一代数据处理技术？" class="headerlink" title="02 | MapReduce 后谁主沉浮：怎样设计下一代数据处理技术？"></a>02 | MapReduce 后谁主沉浮：怎样设计下一代数据处理技术？</h2><h2 id="03-大规模数据处理初体验：怎样实现大型电商热销榜？"><a href="#03-大规模数据处理初体验：怎样实现大型电商热销榜？" class="headerlink" title="03 | 大规模数据处理初体验：怎样实现大型电商热销榜？"></a>03 | 大规模数据处理初体验：怎样实现大型电商热销榜？</h2><p>不同量级 TOP K 算法的解决方案不同：</p>
<p>小规模：Hash 即可</p>
<p>大规模：由于单机的处理量不足以处理全量数据，势必分而治之：分片统计，然后聚合（即先 map 后 reduce）</p>
<h2 id="04-丨分布式系统（上）：学会用服务等级协议-SLA-来评估你的系统"><a href="#04-丨分布式系统（上）：学会用服务等级协议-SLA-来评估你的系统" class="headerlink" title="04 丨分布式系统（上）：学会用服务等级协议 SLA 来评估你的系统"></a>04 丨分布式系统（上）：学会用服务等级协议 SLA 来评估你的系统</h2><p>SLA（Service-Level Agreement），也就是服务等级协议，指的是系统服务提供者（Provider）对客户（Customer）的一个服务承诺。</p>
<p>可用性：大厂一般要求可用性至少达到四个 9（即 99.99%）</p>
<p>准确性：准确率&#x3D; 正确的有效请求数 &#x2F; 有效的总请求数</p>
<p>系统容量：通常通过 QPS （Queries Per Second）来衡量</p>
<p>延迟：请求和响应的时间间隔</p>
<h2 id="05-丨分布式系统（下）：架构师不得不知的三大指标"><a href="#05-丨分布式系统（下）：架构师不得不知的三大指标" class="headerlink" title="05 丨分布式系统（下）：架构师不得不知的三大指标"></a>05 丨分布式系统（下）：架构师不得不知的三大指标</h2><ul>
<li>可扩展性（Scalability）<ul>
<li>水平扩展（Horizontal Scaling）</li>
<li>垂直扩展（Vertical Scaling）</li>
</ul>
</li>
<li>一致性（Consistency）<ul>
<li>强一致性（Strong Consistency）：系统中的某个数据被成功更新后，后续任何对该数据的读取操作都将得到更新<br>后的值。所以在任意时刻，同一系统所有节点中的数据是一样的。</li>
<li>弱一致性（Weak Consistency）：系统中的某个数据被更新后，后续对该数据的读取操作可能得到更新后的值，<br>也可能是更改前的值。但经过“不一致时间窗口”这段时间后，后续对该数据的读取都是更新后的值。</li>
<li>最终一致性（Eventual Consistency）：是弱一致性的特殊形式。存储系统保证，在没有新的更新的条件下，最终所有的访问都是最后更新的值。</li>
</ul>
</li>
<li>持久性（Data Durability）：意味着数据一旦被成功存储就可以一直继续使用，即使系统中的节点下线、宕机或数据损坏也是如。</li>
</ul>
<h2 id="06-如何区分批处理还是流处理？"><a href="#06-如何区分批处理还是流处理？" class="headerlink" title="06 | 如何区分批处理还是流处理？"></a>06 | 如何区分批处理还是流处理？</h2><ul>
<li>无边界数据（Unbounded Data）：是一种不断增长，可以说是无限的数据集。</li>
<li>有边界数据（Bounded Data）：是一种有限的数据集。</li>
<li>事件时间（Event Time）：指的是一个数据实际产生的时间点。</li>
<li>处理时间（Precessing Time）：指的是处理数据的系统架构实际接收到这个数据的时间点。</li>
<li>批处理：绝大部分情况下，批处理的输入数据都是有边界数据，同样的，输出结果也一样是有边界数据。所以在批处理中，我们所关心的更多会是数据的事件时间。<ul>
<li>应用场景：<ul>
<li>日志分析：日志系统是在一定时间段（日，周或年）内收集的，而日志的数据处理分析是在不同的时间内执行，以得出有关系统的一些关键性能指标。</li>
<li>计费应用程序：计费应用程序会计算出一段时间内一项服务的使用程度，并生成计费信息，例如银行在每个月末生成的信用卡还款单。</li>
<li>数据仓库：数据仓库的主要目标是根据收集好的数据事件时间，将数据信息合并为静态快照 （static snapshot），并将它们聚合为每周、每月、每季度的报告等。</li>
</ul>
</li>
</ul>
</li>
<li>流处理：流处理的输入数据基本上都是无边界数据。<ul>
<li>应用场景<ul>
<li>实时监控：捕获和分析各种来源发布的数据，如传感器，新闻源，点击网页等。</li>
<li>实时商业智能：智能汽车，智能家居，智能病人护理等。</li>
<li>销售终端（POS）系统：像是股票价格的更新，允许用户实时完成付款的系统等。</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="07-Workflow-设计模式：让你在大规模数据世界中君临天下"><a href="#07-Workflow-设计模式：让你在大规模数据世界中君临天下" class="headerlink" title="07 | Workflow 设计模式：让你在大规模数据世界中君临天下"></a>07 | Workflow 设计模式：让你在大规模数据世界中君临天下</h2><p>略</p>
<h2 id="08-发布-订阅模式：流处理架构中的瑞士军刀"><a href="#08-发布-订阅模式：流处理架构中的瑞士军刀" class="headerlink" title="08 | 发布&#x2F;订阅模式：流处理架构中的瑞士军刀"></a>08 | 发布&#x2F;订阅模式：流处理架构中的瑞士军刀</h2><p>略</p>
<h2 id="09-丨-CAP-定理：三选二，架构师必须学会的取舍"><a href="#09-丨-CAP-定理：三选二，架构师必须学会的取舍" class="headerlink" title="09 丨 CAP 定理：三选二，架构师必须学会的取舍"></a>09 丨 CAP 定理：三选二，架构师必须学会的取舍</h2><p>略</p>
<h2 id="10-丨-Lambda-架构：Twitter-亿级实时数据分析架构背后的倚天剑"><a href="#10-丨-Lambda-架构：Twitter-亿级实时数据分析架构背后的倚天剑" class="headerlink" title="10 丨 Lambda 架构：Twitter 亿级实时数据分析架构背后的倚天剑"></a>10 丨 Lambda 架构：Twitter 亿级实时数据分析架构背后的倚天剑</h2><p>Lambda 架构总共由三层系统组成：批处理层（Batch Layer），速度处理层（Speed Layer），以及用于响应查询的服务层（Serving Layer）。</p>
<h2 id="11-丨-Kappa-架构：利用-Kafka-锻造的屠龙刀"><a href="#11-丨-Kappa-架构：利用-Kafka-锻造的屠龙刀" class="headerlink" title="11 丨 Kappa 架构：利用 Kafka 锻造的屠龙刀"></a>11 丨 Kappa 架构：利用 Kafka 锻造的屠龙刀</h2><p>略</p>
<h2 id="12-我们为什么需要-Spark？"><a href="#12-我们为什么需要-Spark？" class="headerlink" title="12 | 我们为什么需要 Spark？"></a>12 | 我们为什么需要 Spark？</h2><p>MapReduce 的缺点：</p>
<ul>
<li>高昂的维护成本</li>
<li>时间性能“达不到”用户的期待</li>
<li>MapReduce 模型的抽象层次低</li>
<li>只提供 Map 和 Reduce 两个操作</li>
<li>在 Hadoop 中，每一个 Job 的计算结果都会存储在 HDFS 文件存储系统中，所以每一步计算都要进行硬盘的读取和写入，大大增加了系统的延迟。</li>
<li>只支持批处理</li>
</ul>
<p>Spark 的优点</p>
<ul>
<li>性能比 MapReduce 高很多</li>
<li>Spark 提供了很多对 RDD 的操作，如 Map、Filter、flatMap、groupByKey 和 Union 等等，极大地提升了对各种复杂场景的支持</li>
</ul>
<h2 id="13-丨弹性分布式数据集：Spark-大厦的地基（上）"><a href="#13-丨弹性分布式数据集：Spark-大厦的地基（上）" class="headerlink" title="13 丨弹性分布式数据集：Spark 大厦的地基（上）"></a>13 丨弹性分布式数据集：Spark 大厦的地基（上）</h2><p>Spark 最基本的数据抽象是弹性分布式数据集（Resilient Distributed Dataset）</p>
<p>RDD 表示已被分区、不可变的，并能够被并行操作的数据集合。</p>
<h2 id="14-丨弹性分布式数据集：Spark-大厦的地基（下）"><a href="#14-丨弹性分布式数据集：Spark-大厦的地基（下）" class="headerlink" title="14 丨弹性分布式数据集：Spark 大厦的地基（下）"></a>14 丨弹性分布式数据集：Spark 大厦的地基（下）</h2><h2 id="15-丨-SparkSQL：Spark-数据查询的利器"><a href="#15-丨-SparkSQL：Spark-数据查询的利器" class="headerlink" title="15 丨 SparkSQL：Spark 数据查询的利器"></a>15 丨 SparkSQL：Spark 数据查询的利器</h2><h2 id="16-Spark-Streaming：Spark-的实时流计算-API"><a href="#16-Spark-Streaming：Spark-的实时流计算-API" class="headerlink" title="16 | Spark Streaming：Spark 的实时流计算 API"></a>16 | Spark Streaming：Spark 的实时流计算 API</h2><p>Spark Streaming 用时间片拆分了无限的数据流，然后对每一个数据片用类似于批处理的方法进行处理，输出的数据也是一块一块的</p>
<h2 id="17-Structured-Streaming：如何用-DataFrame-API-进行实时数据分析"><a href="#17-Structured-Streaming：如何用-DataFrame-API-进行实时数据分析" class="headerlink" title="17 | Structured Streaming：如何用 DataFrame API 进行实时数据分析?"></a>17 | Structured Streaming：如何用 DataFrame API 进行实时数据分析?</h2><h2 id="18-丨-WordCount：从零开始运行你的第一个-Spark-应用"><a href="#18-丨-WordCount：从零开始运行你的第一个-Spark-应用" class="headerlink" title="18 丨 WordCount：从零开始运行你的第一个 Spark 应用"></a>18 丨 WordCount：从零开始运行你的第一个 Spark 应用</h2><h2 id="19-丨综合案例实战：处理加州房屋信息，构建线性回归模型"><a href="#19-丨综合案例实战：处理加州房屋信息，构建线性回归模型" class="headerlink" title="19 丨综合案例实战：处理加州房屋信息，构建线性回归模型"></a>19 丨综合案例实战：处理加州房屋信息，构建线性回归模型</h2><h2 id="20-丨流处理案例实战：分析纽约市出租车载客信息"><a href="#20-丨流处理案例实战：分析纽约市出租车载客信息" class="headerlink" title="20 丨流处理案例实战：分析纽约市出租车载客信息"></a>20 丨流处理案例实战：分析纽约市出租车载客信息</h2><hr>
<p>读到此处，感觉收获甚少，暂时搁置阅读。</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a target="_blank" rel="noopener" href="https://time.geekbang.org/column/intro/100025301">极客时间教程 - 大规模数据处理实战</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://dunwu.github.io/blog/pages/8a41f7fb/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/uploads/avatar.gif">
      <meta itemprop="name" content="钝悟 ◾ Dunwu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dunwu Blog">
      <meta itemprop="description" content="钝悟的个人博客">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Dunwu Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/pages/8a41f7fb/" class="post-title-link" itemprop="url">《极客时间教程 - 从 0 开始学大数据》笔记</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-03-13 17:01:51" itemprop="dateCreated datePublished" datetime="2023-03-13T17:01:51+08:00">2023-03-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-09-13 17:56:53" itemprop="dateModified" datetime="2025-09-13T17:56:53+08:00">2025-09-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">笔记</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/%E7%AC%94%E8%AE%B0/%E5%A4%A7%E6%95%B0%E6%8D%AE/" itemprop="url" rel="index"><span itemprop="name">大数据</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>12k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>11 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="《极客时间教程-从-0-开始学大数据》笔记"><a href="#《极客时间教程-从-0-开始学大数据》笔记" class="headerlink" title="《极客时间教程 - 从 0 开始学大数据》笔记"></a>《极客时间教程 - 从 0 开始学大数据》笔记</h1><h2 id="预习模块"><a href="#预习模块" class="headerlink" title="预习模块"></a>预习模块</h2><h3 id="01-丨预习-01-丨大数据技术发展史：大数据的前世今生"><a href="#01-丨预习-01-丨大数据技术发展史：大数据的前世今生" class="headerlink" title="01 丨预习 01 丨大数据技术发展史：大数据的前世今生"></a>01 丨预习 01 丨大数据技术发展史：大数据的前世今生</h3><p>大数据技术，起源于 Google 在 2004 年前后发表的三篇论文：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://static.googleusercontent.com/media/research.google.com/zh-CN//archive/gfs-sosp2003.pdf">The Google File System</a></li>
<li><a target="_blank" rel="noopener" href="https://static.googleusercontent.com/media/research.google.com/zh-CN//archive/bigtable-osdi06.pdf">Bigtable: A Distributed Storage System for Structured Data</a></li>
<li><a target="_blank" rel="noopener" href="https://static.googleusercontent.com/media/research.google.com/zh-CN//archive/mapreduce-osdi04.pdf">MapReduce: Simplified Data Processing on Large Clusters</a></li>
</ul>
<p>Doug Cutting 根据 Google 论文开发了 Hadoop。</p>
<p>大数据处理的主要应用场景包括数据分析、数据挖掘与机器学习。</p>
<p>数据分析主要使用 Hive、Spark SQL 等 SQL 引擎完成；</p>
<p>数据挖掘与机器学习则有专门的机器学习框架 TensorFlow、Mahout 以及 MLlib 等，内置了主要的机器学习和数据挖掘算法。</p>
<p>大数据要存入分布式文件系统（HDFS），要有序调度 MapReduce 和 Spark 作业执行，并能把执行结果写入到各个应用系统的数据库中，还需要有一个大数据平台整合所有这些大数据组件和企业应用系统。</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/20230223134708.png"></p>
<h3 id="02-丨预习-02-丨大数据应用发展史：从搜索引擎到人工智能"><a href="#02-丨预习-02-丨大数据应用发展史：从搜索引擎到人工智能" class="headerlink" title="02 丨预习 02 丨大数据应用发展史：从搜索引擎到人工智能"></a>02 丨预习 02 丨大数据应用发展史：从搜索引擎到人工智能</h3><p>大数据的应用领域：</p>
<ul>
<li><strong>搜索引擎</strong>：GFS 和 MapReduce 开启了超大规模的分布式存储和分布式计算应用。</li>
<li><strong>数据仓库</strong>：Hive 实现了用更低廉的价格获得比以往多得多的数据存储与计算能力。</li>
<li><strong>数据挖掘</strong>：基于海量数据进行关联分析。应用有：关联推荐、用户画像、关系图谱</li>
<li><strong>机器学习</strong>：有了大数据，可以把全部的历史数据都收集起来，统计其规律，进而预测正在发生的事情。</li>
</ul>
<h3 id="03-丨预习-03-丨大数据应用领域：数据驱动一切"><a href="#03-丨预习-03-丨大数据应用领域：数据驱动一切" class="headerlink" title="03 丨预习 03 丨大数据应用领域：数据驱动一切"></a>03 丨预习 03 丨大数据应用领域：数据驱动一切</h3><p>大数据的行业应用：</p>
<ul>
<li>医疗健康领域<ul>
<li>医学影像智能识别</li>
<li>病历大数据智能诊疗</li>
</ul>
</li>
<li>教育领域<ul>
<li>AI 外语老师</li>
<li>智能解题</li>
</ul>
</li>
<li>社交媒体领域：舆情监控与分析</li>
<li>金融领域：大数据风控</li>
<li>新零售领域：全链路管理</li>
<li>交通领域<ul>
<li>实时采集监控数据</li>
<li>判断道路拥堵状态</li>
<li>无人驾驶技术</li>
</ul>
</li>
</ul>
<h2 id="模块一、Hadoop-大数据原理与架构"><a href="#模块一、Hadoop-大数据原理与架构" class="headerlink" title="模块一、Hadoop 大数据原理与架构"></a>模块一、Hadoop 大数据原理与架构</h2><h3 id="04-移动计算比移动数据更划算"><a href="#04-移动计算比移动数据更划算" class="headerlink" title="04 | 移动计算比移动数据更划算"></a>04 | 移动计算比移动数据更划算</h3><p>传统计算模型：输入 -&gt; 计算 -&gt; 输出，面对海量数据（TB 级甚至 PB 级），无法应对。</p>
<p>移动计算将程序分发到数据所在的地方进行计算，也就是所谓的移动计算比移动数据更划算。</p>
<p>移动计算步骤：</p>
<ol>
<li>将待处理的大规模数据存储在服务器集群的所有服务器上，主要使用 HDFS 分布式文件存储系统，将文件分成很多块（Block），以块为单位存储在集群的服务器上。</li>
<li>大数据引擎根据集群里不同服务器的计算能力，在每台服务器上启动若干分布式任务执行进程，这些进程会等待给它们分配执行任务。</li>
<li>使用大数据计算框架支持的编程模型进行编程，比如 Hadoop 的 MapReduce 编程模型，或者 Spark 的 RDD 编程模型。应用程序编写好以后，将其打包，MapReduce 和 Spark 都是在 JVM 环境中运行，所以打包出来的是一个 Java 的 JAR 包。</li>
<li>用 Hadoop 或者 Spark 的启动命令执行这个应用程序的 JAR 包，首先执行引擎会解析程序要处理的数据输入路径，根据输入数据量的大小，将数据分成若干片（Split），每一个数据片都分配给一个任务执行进程去处理。</li>
<li>任务执行进程收到分配的任务后，检查自己是否有任务对应的程序包，如果没有就去下载程序包，下载以后通过反射的方式加载程序。走到这里，最重要的一步，也就是移动计算就完成了。</li>
<li>加载程序后，任务执行进程根据分配的数据片的文件地址和数据在文件内的偏移量读取数据，并把数据输入给应用程序相应的方法</li>
</ol>
<h3 id="05-从-RAID-看垂直伸缩到水平伸缩的演化"><a href="#05-从-RAID-看垂直伸缩到水平伸缩的演化" class="headerlink" title="05 | 从 RAID 看垂直伸缩到水平伸缩的演化"></a>05 | 从 RAID 看垂直伸缩到水平伸缩的演化</h3><p>海量数据存储核心问题</p>
<ul>
<li>数据存储容量的问题。既然大数据要解决的是数以 PB 计的数据计算问题，而一般的服务器磁盘容量通常 1 ～ 2TB，那么如何存储这么大规模的数据呢？</li>
<li>数据读写速度的问题。一般磁盘的连续读写速度为几十 MB，以这样的速度，几十 PB 的数据恐怕要读写到天荒地老。</li>
<li>数据可靠性的问题。磁盘大约是计算机设备中最易损坏的硬件了，通常情况一块磁盘使用寿命大概是一年，如果磁盘损坏了，数据怎么办？</li>
</ul>
<p>解决方式是 RAID 技术：</p>
<ul>
<li>数据存储容量的问题。RAID 使用了 N 块磁盘构成一个存储阵列，如果使用 RAID 5，数据就可以存储在 N-1 块磁盘上，这样将存储空间扩大了 N-1 倍。</li>
<li>数据读写速度的问题。RAID 根据可以使用的磁盘数量，将待写入的数据分成多片，并发同时向多块磁盘进行写入，显然写入的速度可以得到明显提高；同理，读取速度也可以得到明显提高。不过，需要注意的是，由于传统机械磁盘的访问延迟主要来自于寻址时间，数据真正进行读写的时间可能只占据整个数据访问时间的一小部分，所以数据分片后对 N 块磁盘进行并发读写操作并不能将访问速度提高 N 倍。</li>
<li>数据可靠性的问题。使用 RAID 10、RAID 5 或者 RAID 6 方案的时候，由于数据有冗余存储，或者存储校验信息，所以当某块磁盘损坏的时候，可以通过其他磁盘上的数据和校验数据将丢失磁盘上的数据还原。</li>
</ul>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/20230224131454.png"></p>
<p>实现更强的计算能力和更大规模的数据存储有两种思路</p>
<ul>
<li>垂直伸缩（scaling up），即硬件升级</li>
<li>水平伸缩（scaling out），即分布式系统</li>
</ul>
<p>注：RAID 技术就是采用了垂直伸缩的方式。</p>
<h3 id="06-新技术层出不穷，HDFS-依然是存储的王者"><a href="#06-新技术层出不穷，HDFS-依然是存储的王者" class="headerlink" title="06 | 新技术层出不穷，HDFS 依然是存储的王者"></a>06 | 新技术层出不穷，HDFS 依然是存储的王者</h3><p><img src="https://raw.githubusercontent.com/dunwu/images/master/cs/bigdata/hdfs/hdfs-architecture.png" alt="img"></p>
<p>HDFS 有两个关键组件：DataNode 和 NameNode：</p>
<ul>
<li>DataNode 负责文件数据的存储和读写操作，HDFS 将文件数据分割成若干数据块（Block），每个 DataNode 存储一部分数据块，这样文件就分布存储在整个 HDFS 服务器集群中。应用程序客户端（Client）可以并行对这些数据块进行访问，从而使得 HDFS 可以在服务器集群规模上实现数据并行访问，极大地提高了访问速度。</li>
<li>NameNode 负责整个分布式文件系统的元数据（MetaData）管理，也就是文件路径名、数据块的 ID 以及存储位置等信息，相当于操作系统中文件分配表（FAT）的角色。</li>
</ul>
<p>为保证高可用，HDFS 会，会将一个数据块复制为多份（默认为 3 份），并将多份相同的数据块存储在不同的服务器上，甚至不同的机架上。</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/20200224203958.png" alt="img"></p>
<p>HDFS 故障容错：</p>
<ul>
<li><strong>数据存储故障容错</strong><ul>
<li>对于 DataNode 上的数据块进行计算并存储校验和（CheckSum）</li>
<li>读取数据的时候，重新计算读取出来的数据的校验和，校验和不正确，则抛出异常</li>
<li>发现异常后，从其他 DataNode 读取备份</li>
</ul>
</li>
<li><strong>磁盘故障容错</strong><ul>
<li>如果 DataNode 监测到本机磁盘损坏，将该磁盘的所有数据块 ID 报告给 NameNode</li>
<li>NameNode 检查这些数据块在哪些 DataNode 上有备份，复制一份到其他 DataNode 上</li>
</ul>
</li>
<li><strong>DataNode 故障容错</strong><ul>
<li>DataNode 会通过心跳和 NameNode 保持通信</li>
<li>如果 DataNode 超时未发送心跳，NameNode 视其为宕机</li>
<li>NameNode 查找这个 DataNode 存储的所有数据块，复制一份到其他 DataNode 上</li>
</ul>
</li>
<li><strong>NameNode 故障容错</strong><ul>
<li>基于 ZooKeeper 实现主从备份</li>
<li>争夺 znode 锁</li>
</ul>
</li>
</ul>
<h3 id="07-为什么说-MapReduce-既是编程模型又是计算框架？"><a href="#07-为什么说-MapReduce-既是编程模型又是计算框架？" class="headerlink" title="07 | 为什么说 MapReduce 既是编程模型又是计算框架？"></a>07 | 为什么说 MapReduce 既是编程模型又是计算框架？</h3><p><strong>MapReduce 既是编程模型，又是计算框架</strong>。</p>
<p>MapReduce 编程模型只包含 Map 和 Reduce 两个过程，map 的主要输入是一对 <code>&lt;Key, Value&gt;</code> 值，经过 map 计算后输出一对 <code>&lt;Key, Value&gt;</code> 值；然后将相同 Key 合并，形成 <code>&lt;Key, Value 集合&gt;</code>；再将这个 <code>&lt;Key, Value 集合&gt;</code> 输入 reduce，经过计算输出零个或多个 <code>&lt;Key, Value&gt;</code> 对。</p>
<h3 id="08-MapReduce-如何让数据完成一次旅行？"><a href="#08-MapReduce-如何让数据完成一次旅行？" class="headerlink" title="08 | MapReduce 如何让数据完成一次旅行？"></a>08 | MapReduce 如何让数据完成一次旅行？</h3><h4 id="MapReduce-作业启动和运行机制"><a href="#MapReduce-作业启动和运行机制" class="headerlink" title="MapReduce 作业启动和运行机制"></a>MapReduce 作业启动和运行机制</h4><p>大数据应用进程。这类进程是启动 MapReduce 程序的主入口，主要是指定 Map 和 Reduce 类、输入输出文件路径等，并提交作业给 Hadoop 集群，也就是下面提到的 JobTracker 进程。这是由用户启动的 MapReduce 程序进程，比如我们上期提到的 WordCount 程序。</p>
<p>JobTracker 进程。这类进程根据要处理的输入数据量，命令下面提到的 TaskTracker 进程启动相应数量的 Map 和 Reduce 进程任务，并管理整个作业生命周期的任务调度和监控。这是 Hadoop 集群的常驻进程，需要注意的是，JobTracker 进程在整个 Hadoop 集群全局唯一。</p>
<p>TaskTracker 进程。这个进程负责启动和管理 Map 进程以及 Reduce 进程。因为需要每个数据块都有对应的 map 函数，TaskTracker 进程通常和 HDFS 的 DataNode 进程启动在同一个服务器。也就是说，Hadoop 集群中绝大多数服务器同时运行 DataNode 进程和 TaskTracker 进程。</p>
<h4 id="MapReduce-数据合并与连接机制"><a href="#MapReduce-数据合并与连接机制" class="headerlink" title="MapReduce 数据合并与连接机制"></a>MapReduce 数据合并与连接机制</h4><p>在 map 输出与 reduce 输入之间，MapReduce 计算框架处理数据合并与连接操作，这个操作有个专门的词汇叫 shuffle。分布式计算需要将不同服务器上的相关数据合并到一起进行下一步计算，这就是 shuffle。</p>
<h3 id="09-为什么我们管-Yarn-叫作资源调度框架？"><a href="#09-为什么我们管-Yarn-叫作资源调度框架？" class="headerlink" title="09 | 为什么我们管 Yarn 叫作资源调度框架？"></a>09 | 为什么我们管 Yarn 叫作资源调度框架？</h3><p>服务器集群资源调度管理和 MapReduce 执行过程耦合在一起，如果想在当前集群中运行其他计算任务，比如 Spark 或者 Storm，就无法统一使用集群中的资源了。</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/20230227195344.png"></p>
<p>Yarn 包括两个部分：</p>
<p>ResourceManager 进程负责整个集群的资源调度管理，通常部署在独立的服务器上；</p>
<p>NodeManager 进程负责具体服务器上的资源和任务管理，在集群的每一台计算服务器上都会启动，基本上跟 HDFS 的 DataNode 进程一起出现。</p>
<p>Yarn 的工作流程</p>
<ol>
<li>我们向 Yarn 提交应用程序，包括 MapReduce ApplicationMaster、我们的 MapReduce 程序，以及 MapReduce Application 启动命令。</li>
<li>ResourceManager 进程和 NodeManager 进程通信，根据集群资源，为用户程序分配第一个容器，并将 MapReduce ApplicationMaster 分发到这个容器上面，并在容器里面启动 MapReduce ApplicationMaster。</li>
<li>MapReduce ApplicationMaster 启动后立即向 ResourceManager 进程注册，并为自己的应用程序申请容器资源。</li>
<li>MapReduce ApplicationMaster 申请到需要的容器后，立即和相应的 NodeManager 进程通信，将用户 MapReduce 程序分发到 NodeManager 进程所在服务器，并在容器中运行，运行的就是 Map 或者 Reduce 任务。</li>
<li>Map 或者 Reduce 任务在运行期和 MapReduce ApplicationMaster 通信，汇报自己的运行状态，如果运行结束，MapReduce ApplicationMaster 向 ResourceManager 进程注销并释放所有的容器资源。</li>
</ol>
<h3 id="10-模块答疑：我们能从-Hadoop-学到什么？"><a href="#10-模块答疑：我们能从-Hadoop-学到什么？" class="headerlink" title="10 | 模块答疑：我们能从 Hadoop 学到什么？"></a>10 | 模块答疑：我们能从 Hadoop 学到什么？</h3><p>Hadoop 几个主要产品的架构设计，就会发现它们都有相似性，都是一主多从的架构方案。</p>
<ul>
<li>HDFS，一个 NameNode，多个 DataNode；</li>
<li>MapReduce，一个 JobTracker，多个 TaskTracker；</li>
<li>Yarn，一个 ResourceManager，多个 NodeManager。</li>
</ul>
<p>事实上，很多大数据产品都是这样的架构方案：</p>
<p>Storm，一个 Nimbus，多个 Supervisor；</p>
<p>Spark，一个 Master，多个 Slave。</p>
<p>大数据因为要对数据和计算任务进行统一管理，所以和互联网在线应用不同，需要一个全局管理者。一言以蔽之：<strong>集中管理，分布存储与计算</strong></p>
<h2 id="模块二、大数据生态体系主要产品原理与架构"><a href="#模块二、大数据生态体系主要产品原理与架构" class="headerlink" title="模块二、大数据生态体系主要产品原理与架构"></a>模块二、大数据生态体系主要产品原理与架构</h2><h3 id="11-Hive-是如何让-MapReduce-实现-SQL-操作的？"><a href="#11-Hive-是如何让-MapReduce-实现-SQL-操作的？" class="headerlink" title="11 | Hive 是如何让 MapReduce 实现 SQL 操作的？"></a>11 | Hive 是如何让 MapReduce 实现 SQL 操作的？</h3><p>Hive 能够直接处理我们输入的 SQL 语句（Hive 的 SQL 语法和数据库标准 SQL 略有不同），调用 MapReduce 计算框架完成数据分析操作。</p>
<p>我们通过 Hive 的 Client（Hive 的命令行工具，JDBC 等）向 Hive 提交 SQL 命令。如果是创建数据表的 DDL（数据定义语言），Hive 就会通过执行引擎 Driver 将数据表的信息记录在 Metastore 元数据组件中，这个组件通常用一个关系数据库实现，记录表名、字段名、字段类型、关联 HDFS 文件路径等这些数据库的 Meta 信息（元信息）。</p>
<p>如果我们提交的是查询分析数据的 DQL（数据查询语句），Driver 就会将该语句提交给自己的编译器 Compiler 进行语法分析、语法解析、语法优化等一系列操作，最后生成一个 MapReduce 执行计划。然后根据执行计划生成一个 MapReduce 的作业，提交给 Hadoop MapReduce 计算框架处理。</p>
<h3 id="12-我们并没有觉得-MapReduce-速度慢，直到-Spark-出现"><a href="#12-我们并没有觉得-MapReduce-速度慢，直到-Spark-出现" class="headerlink" title="12 | 我们并没有觉得 MapReduce 速度慢，直到 Spark 出现"></a>12 | 我们并没有觉得 MapReduce 速度慢，直到 Spark 出现</h3><p>RDD 是 Spark 的核心概念，是弹性数据集（Resilient Distributed Datasets）的缩写。RDD 既是 Spark 面向开发者的编程模型，又是 Spark 自身架构的核心元素。</p>
<p>Spark 上编写 WordCount 程序，主要代码只需要三行</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> textFile = sc.textFile(<span class="string">&quot;hdfs://...&quot;</span>)</span><br><span class="line"><span class="keyword">val</span> counts = textFile.flatMap(line =&gt; line.split(<span class="string">&quot; &quot;</span>))</span><br><span class="line">.map(word =&gt; (word, <span class="number">1</span>))</span><br><span class="line">.reduceByKey(_ + _)</span><br><span class="line">counts.saveAsTextFile(<span class="string">&quot;hdfs://...&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>MapReduce 针对输入数据，将计算过程分为两个阶段，一个 Map 阶段，一个 Reduce 阶段，可以理解成是面向过程的大数据计算。</p>
<p>而 Spark 则直接针对数据进行编程，将大规模数据集合抽象成一个 RDD 对象，然后在这个 RDD 上进行各种计算处理，得到一个新的 RDD，继续计算处理，直到得到最后的结果数据。所以 Spark 可以理解成是面向对象的大数据计算。</p>
<p>RDD 上定义的函数分两种，一种是转换（transformation）函数，这种函数的返回值还是 RDD；另一种是执行（action）函数，这种函数不再返回 RDD。</p>
<p>RDD 定义了很多转换操作函数，比如有计算 map(func)、过滤 filter(func)、合并数据集 union(otherDataset)、根据 Key 聚合 reduceByKey(func, [numPartitions])、连接数据集 join(otherDataset, [numPartitions])、分组 groupByKey([numPartitions]) 等十几个函数。</p>
<h3 id="13-同样的本质，为何-Spark-可以更高效？"><a href="#13-同样的本质，为何-Spark-可以更高效？" class="headerlink" title="13 | 同样的本质，为何 Spark 可以更高效？"></a>13 | 同样的本质，为何 Spark 可以更高效？</h3><p>Spark 有三个主要特性：RDD 的编程模型更简单，DAG 切分的多阶段计算过程更快速，使用内存存储中间计算结果更高效。这三个特性使得 Spark 相对 Hadoop MapReduce 可以有更快的执行速度，以及更简单的编程实现。</p>
<h3 id="14-BigTable-的开源实现：HBase"><a href="#14-BigTable-的开源实现：HBase" class="headerlink" title="14 | BigTable 的开源实现：HBase"></a>14 | BigTable 的开源实现：HBase</h3><h4 id="HBase-可伸缩架构"><a href="#HBase-可伸缩架构" class="headerlink" title="HBase 可伸缩架构"></a>HBase 可伸缩架构</h4><p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/20230303145832.png"></p>
<p>HBase 的伸缩性主要依赖其可分裂的 HRegion 及可伸缩的分布式文件系统 HDFS 实现。</p>
<p>HRegion 是 HBase 负责数据存储的主要进程，应用程序对数据的读写操作都是通过和 HRegion 通信完成。上面是 HBase 架构图，我们可以看到在 HBase 中，数据以 HRegion 为单位进行管理，也就是说应用程序如果想要访问一个数据，必须先找到 HRegion，然后将数据读写操作提交给 HRegion，由 HRegion 完成存储层面的数据操作。</p>
<p>HRegionServer 是物理服务器，每个 HRegionServer 上可以启动多个 HRegion 实例。当一个 HRegion 中写入的数据太多，达到配置的阈值时，一个 HRegion 会分裂成两个 HRegion，并将 HRegion 在整个集群中进行迁移，以使 HRegionServer 的负载均衡。</p>
<p>每个 HRegion 中存储一段 Key 值区间 [key1, key2) 的数据，所有 HRegion 的信息，包括存储的 Key 值区间、所在 HRegionServer 地址、访问端口号等，都记录在 HMaster 服务器上。为了保证 HMaster 的高可用，HBase 会启动多个 HMaster，并通过 ZooKeeper 选举出一个主服务器。</p>
<p>应用程序通过 ZooKeeper 获得主 HMaster 的地址，输入 Key 值获得这个 Key 所在的 HRegionServer 地址，然后请求 HRegionServer 上的 HRegion，获得所需要的数据。</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/20230303150211.png"></p>
<p>HRegion 会把数据存储在若干个 HFile 格式的文件中，这些文件使用 HDFS 分布式文件系统存储，在整个集群内分布并高可用。当一个 HRegion 中数据量太多时，这个 HRegion 连同 HFile 会分裂成两个 HRegion，并根据集群中服务器负载进行迁移。如果集群中有新加入的服务器，也就是说有了新的 HRegionServer，由于其负载较低，也会把 HRegion 迁移过去并记录到 HMaster，从而实现 HBase 的线性伸缩。</p>
<h4 id="HBase-可扩展数据模型"><a href="#HBase-可扩展数据模型" class="headerlink" title="HBase 可扩展数据模型"></a>HBase 可扩展数据模型</h4><p>支持列族结构的 NoSQL 数据库，在创建表的时候，只需要指定列族的名字，无需指定字段（Column）。那什么时候指定字段呢？可以在数据写入时再指定。通过这种方式， 数据表可以包含数百万的字段，这样就可以随意扩展应用程序的数据结构了。并且这种数据库在查询时也很方便，可以通过指定任意字段名称和值进行查询。</p>
<p>HBase 这种列族的数据结构设计，实际上是把字段的名称和字段的值，以 Key-Value 的方式一起存储在 HBase 中。实际写入的时候，可以随意指定字段名称，即使有几百万个字段也能轻松应对。</p>
<h4 id="HBase-的高性能存储"><a href="#HBase-的高性能存储" class="headerlink" title="HBase 的高性能存储"></a>HBase 的高性能存储</h4><p>HBase 使用了一种叫作 LSM 树（Log 结构合并树）的数据结构进行数据存储。数据写入的时候以 Log 方式连续写入，然后异步对磁盘上的多个 LSM 树进行合并。</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/20230303154832.png"></p>
<p>LSM 树可以看作是一个 N 阶合并树。数据写操作（包括插入、修改、删除）都在内存中进行，并且都会创建一个新记录（修改会记录新的数据值，而删除会记录一个删除标志）。这些数据在内存中仍然还是一棵排序树，当数据量超过设定的内存阈值后，会将这棵排序树和磁盘上最新的排序树合并。当这棵排序树的数据量也超过设定阈值后，会和磁盘上下一级的排序树合并。合并过程中，会用最新更新的数据覆盖旧的数据（或者记录为不同版本）。</p>
<h3 id="15-流式计算的代表：Storm、Flink、Spark-Streaming"><a href="#15-流式计算的代表：Storm、Flink、Spark-Streaming" class="headerlink" title="15 | 流式计算的代表：Storm、Flink、Spark Streaming"></a>15 | 流式计算的代表：Storm、Flink、Spark Streaming</h3><h3 id="16-ZooKeeper-是如何保证数据一致性的？"><a href="#16-ZooKeeper-是如何保证数据一致性的？" class="headerlink" title="16 | ZooKeeper 是如何保证数据一致性的？"></a>16 | ZooKeeper 是如何保证数据一致性的？</h3><p>分布式系统中的“脑裂”是指一个系统中的节点被分隔成两个或多个独立的部分，这些部分无法互相通信，导致系统出现不一致性和数据丢失的问题。通常情况下，“脑裂”是由于网络故障、硬件故障或者软件故障等因素导致的。</p>
<p>包括 HDFS 在内的很多大数据技术都选择了使用 ZooKeeper 来解决多台服务器的状态一致性问题。</p>
<p>ZooKeeper 使用了一种叫 ZAB 算法来解决一致性问题。ZAB 可视为 Paxos 算法的一种简化方案。</p>
<h3 id="17-丨模块答疑：这么多技术，到底都能用在什么场景里？"><a href="#17-丨模块答疑：这么多技术，到底都能用在什么场景里？" class="headerlink" title="17 丨模块答疑：这么多技术，到底都能用在什么场景里？"></a>17 丨模块答疑：这么多技术，到底都能用在什么场景里？</h3><p>大数据技术在实际部署的时候，通常会部署在同一个集群中，也就是说，在由很多台服务器组成的服务器集群中，某台服务器可能运行着 HDFS 的 DataNode 进程，负责 HDFS 的数据存储；同时也运行着 Yarn 的 NodeManager，负责计算资源的调度管理；而 MapReduce、Spark、Storm、Flink 这些批处理或者流处理大数据计算引擎则通过 Yarn 的调度，运行在 NodeManager 的容器（container）里面。至于 Hive、Spark SQL 这些运行在 MapReduce 或者 Spark 基础上的大数据仓库引擎，在经过自身的执行引擎将 SQL 语句解析成 MapReduce 或者 Spark 的执行计划以后，一样提交给 Yarn 去调度执行。</p>
<h2 id="模块三、大数据开发实践"><a href="#模块三、大数据开发实践" class="headerlink" title="模块三、大数据开发实践"></a>模块三、大数据开发实践</h2><h3 id="18-如何自己开发一个大数据-SQL-引擎？"><a href="#18-如何自己开发一个大数据-SQL-引擎？" class="headerlink" title="18 | 如何自己开发一个大数据 SQL 引擎？"></a>18 | 如何自己开发一个大数据 SQL 引擎？</h3><h3 id="19-Spark-的性能优化案例分析（上）"><a href="#19-Spark-的性能优化案例分析（上）" class="headerlink" title="19 | Spark 的性能优化案例分析（上）"></a>19 | Spark 的性能优化案例分析（上）</h3><p>性能指标：</p>
<ul>
<li>响应时间：完成一次任务（请求）花费的时间。</li>
<li>并发数：同时处理的任务数（请求数）。</li>
<li>吞吐量：单位时间完成的任务数（请求数、事务数、查询数……）。</li>
<li>性能计数器：System Load，线程数，进程数，CPU、内存、磁盘、网络使用率等。</li>
</ul>
<p>Spark 性能优化可以分解为下面几步。</p>
<ol>
<li>性能测试，观察 Spark 性能特性和资源（CPU、Memory、Disk、Net）利用情况。</li>
<li>分析、寻找资源瓶颈。</li>
<li>分析系统架构、代码，发现资源利用关键所在，思考优化策略。</li>
<li>代码、架构、基础设施调优，优化、平衡资源利用。</li>
<li>性能测试，观察系统性能特性，是否达到优化目的，以及寻找下一个瓶颈点。</li>
</ol>
<h3 id="20-Spark-的性能优化案例分析（下）"><a href="#20-Spark-的性能优化案例分析（下）" class="headerlink" title="20 | Spark 的性能优化案例分析（下）"></a>20 | Spark 的性能优化案例分析（下）</h3><h3 id="21-从阿里内部产品看海量数据处理系统的设计（上）：Doris-的立项"><a href="#21-从阿里内部产品看海量数据处理系统的设计（上）：Doris-的立项" class="headerlink" title="21 | 从阿里内部产品看海量数据处理系统的设计（上）：Doris 的立项"></a>21 | 从阿里内部产品看海量数据处理系统的设计（上）：Doris 的立项</h3><h3 id="22-从阿里内部产品看海量数据处理系统的设计（下）：架构与创新"><a href="#22-从阿里内部产品看海量数据处理系统的设计（下）：架构与创新" class="headerlink" title="22 | 从阿里内部产品看海量数据处理系统的设计（下）：架构与创新"></a>22 | 从阿里内部产品看海量数据处理系统的设计（下）：架构与创新</h3><h3 id="23-大数据基准测试可以带来什么好处？"><a href="#23-大数据基准测试可以带来什么好处？" class="headerlink" title="23 | 大数据基准测试可以带来什么好处？"></a>23 | 大数据基准测试可以带来什么好处？</h3><p>大数据基准测试工具：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/Intel-bigdata/HiBench">HiBench</a></p>
<h3 id="24-丨从大数据性能测试工具-Dew-看如何快速开发大数据系统"><a href="#24-丨从大数据性能测试工具-Dew-看如何快速开发大数据系统" class="headerlink" title="24 丨从大数据性能测试工具 Dew 看如何快速开发大数据系统"></a>24 丨从大数据性能测试工具 Dew 看如何快速开发大数据系统</h3><h3 id="25-模块答疑：我能从大厂的大数据开发实践中学到什么？"><a href="#25-模块答疑：我能从大厂的大数据开发实践中学到什么？" class="headerlink" title="25 | 模块答疑：我能从大厂的大数据开发实践中学到什么？"></a>25 | 模块答疑：我能从大厂的大数据开发实践中学到什么？</h3><p>学习层次</p>
<ol>
<li>练习</li>
<li>应用</li>
<li>开发</li>
</ol>
<h2 id="模块四、大数据平台与系统集成"><a href="#模块四、大数据平台与系统集成" class="headerlink" title="模块四、大数据平台与系统集成"></a>模块四、大数据平台与系统集成</h2><h3 id="26-互联网产品-大数据产品-大数据平台"><a href="#26-互联网产品-大数据产品-大数据平台" class="headerlink" title="26 | 互联网产品 + 大数据产品 &#x3D; 大数据平台"></a>26 | 互联网产品 + 大数据产品 &#x3D; 大数据平台</h3><p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/20230313105947.png"></p>
<ul>
<li>数据采集：数据库同步通常用 Sqoop，日志同步可以选择 Flume，打点采集的数据经过格式化转换后通过 Kafka 等消息队列进行传递</li>
<li>数据处理：离线计算：MapReduce、Hive、Spark；实时计算：Storm、Spark Streaming、Flink</li>
<li>数据展示：Lambda 架构</li>
</ul>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/20230313111021.png"></p>
<h3 id="27-大数据从哪里来？"><a href="#27-大数据从哪里来？" class="headerlink" title="27 | 大数据从哪里来？"></a>27 | 大数据从哪里来？</h3><p>大数据平台的数据来源主要有数据库、日志、前端程序埋点、爬虫系统。</p>
<ul>
<li>数据库导入<ul>
<li>Sqoop：Sqoop 是一个数据库批量导入导出工具，可以将关系数据库的数据批量导入到 Hadoop，也可以将 Hadoop 的数据导出到关系数据库。</li>
<li>Canal：Canal 是阿里巴巴开源的一个 MySQL binlog 获取工具，binlog 是 MySQL 的事务日志，可用于 MySQL 数据库主从复制，Canal 将自己伪装成 MySQL 从库，从 MySQL 获取 binlog。</li>
</ul>
</li>
<li>日志文件导入<ul>
<li>Flume：Flume 是大数据日志收集常用的工具。</li>
</ul>
</li>
<li>前端程序埋点<ul>
<li>手动埋点</li>
<li>自动埋点</li>
</ul>
</li>
<li>爬虫</li>
</ul>
<h3 id="28-知名大厂如何搭建大数据平台？"><a href="#28-知名大厂如何搭建大数据平台？" class="headerlink" title="28 | 知名大厂如何搭建大数据平台？"></a>28 | 知名大厂如何搭建大数据平台？</h3><p>淘宝大数据平台</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/20230313113641.png"></p>
<p>美团大数据平台</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/20230313113700.png"></p>
<p>滴滴大数据平台</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/20230313113720.png"></p>
<h3 id="29-盘点可供中小企业参考的商业大数据平台"><a href="#29-盘点可供中小企业参考的商业大数据平台" class="headerlink" title="29 | 盘点可供中小企业参考的商业大数据平台"></a>29 | 盘点可供中小企业参考的商业大数据平台</h3><h4 id="大数据解决方案提供商"><a href="#大数据解决方案提供商" class="headerlink" title="大数据解决方案提供商"></a>大数据解决方案提供商</h4><p>CDH、TDH</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/20230313114058.png"></p>
<p>CDH 是一个大数据集成平台，将主流大数据产品都集成到这个平台中，企业可以使用 CDH 一站式部署整个大数据技术栈。从架构分层角度，CDH 可以分为 4 层：系统集成，大数据存储，统一服务，过程、分析与计算。</p>
<ol>
<li>系统集成：数据库导入导出用 Sqoop，日志导入导出用 Flume，其他实时数据导入导出用 Kafka。</li>
<li>大数据存储：文件系统用 HDFS，结构化数据用 Kudu，NoSQL 存储用 HBase，其他还有对象存储。</li>
<li>统一服务：资源管理用 Yarn，安全管理用 Sentry 和 RecordService 细粒度地管理不同用户数据的访问权限。</li>
<li>过程、分析与计算：批处理计算用 MapReduce、Spark、Hive、Pig，流计算用 SparkStreaming，快速 SQL 分析用 Impala，搜索服务用 Solr。</li>
</ol>
<h4 id="大数据云计算服务商"><a href="#大数据云计算服务商" class="headerlink" title="大数据云计算服务商"></a>大数据云计算服务商</h4><p>阿里云、亚马逊</p>
<h4 id="大数据-SaaS-服务商"><a href="#大数据-SaaS-服务商" class="headerlink" title="大数据 SaaS 服务商"></a>大数据 SaaS 服务商</h4><p>友盟、神策、百度统计</p>
<h4 id="大数据开放平台"><a href="#大数据开放平台" class="headerlink" title="大数据开放平台"></a>大数据开放平台</h4><h3 id="30-当大数据遇上物联网"><a href="#30-当大数据遇上物联网" class="headerlink" title="30 | 当大数据遇上物联网"></a>30 | 当大数据遇上物联网</h3><p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/20230313144317.png"></p>
<ol>
<li>智能网关通过消息队列将数据上传到物联网大数据平台，Storm 等流式计算引擎从消息队列获取数据，对数据的处理分三个方面。数据进行清理转换后写入到大数据存储系统。调用规则和机器学习模型，对上传数据进行计算，如果触发了某种执行规则，就将控制信息通过设备管理服务器下发给智能网关，并进一步控制终端智能设备。</li>
<li>Spark 等离线计算引擎定时对写入存储系统的数据进行批量计算处理，进行全量统计分析和机器学习，并更新机器学习模型。</li>
<li>应用程序也可以通过设备管理服务器直接发送控制指令给智能网关，控制终端智能设备。</li>
</ol>
<h3 id="31-模块答疑：为什么大数据平台至关重要？"><a href="#31-模块答疑：为什么大数据平台至关重要？" class="headerlink" title="31 | 模块答疑：为什么大数据平台至关重要？"></a>31 | 模块答疑：为什么大数据平台至关重要？</h3><h2 id="模块五、大数据分析与运营"><a href="#模块五、大数据分析与运营" class="headerlink" title="模块五、大数据分析与运营"></a>模块五、大数据分析与运营</h2><h3 id="32-互联网运营数据指标与可视化监控"><a href="#32-互联网运营数据指标与可视化监控" class="headerlink" title="32 | 互联网运营数据指标与可视化监控"></a>32 | 互联网运营数据指标与可视化监控</h3><p>运营常用数据指标</p>
<ul>
<li>新增用户数</li>
<li>用户留存率</li>
<li>活跃用户数</li>
<li>PV（Page View）</li>
<li>GMV（Gross Merchandise Volume），即成交总金额</li>
<li>转化率 &#x3D; 付费用户数 &#x2F; 总用户数</li>
</ul>
<h3 id="33-丨一个电商网站订单下降的数据分析案例"><a href="#33-丨一个电商网站订单下降的数据分析案例" class="headerlink" title="33 丨一个电商网站订单下降的数据分析案例"></a>33 丨一个电商网站订单下降的数据分析案例</h3><h3 id="34-丨-A-B-测试与灰度发布必知必会"><a href="#34-丨-A-B-测试与灰度发布必知必会" class="headerlink" title="34 丨 A-B 测试与灰度发布必知必会"></a>34 丨 A-B 测试与灰度发布必知必会</h3><h4 id="A-B-测试的过程"><a href="#A-B-测试的过程" class="headerlink" title="A&#x2F;B 测试的过程"></a>A&#x2F;B 测试的过程</h4><p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/20230313151335.png"></p>
<h4 id="A-B-测试的系统架构"><a href="#A-B-测试的系统架构" class="headerlink" title="A&#x2F;B 测试的系统架构"></a>A&#x2F;B 测试的系统架构</h4><p>A&#x2F;B 测试系统最重要的是能够根据用户 ID（或者设备 ID）将实验配置参数分发给应用程序，应用程序根据配置参数决定给用户展示的界面和执行的业务逻辑</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/20230313151508.png"></p>
<h4 id="灰度发布"><a href="#灰度发布" class="headerlink" title="灰度发布"></a>灰度发布</h4><h3 id="35-丨如何利用大数据成为“增长黑客”？"><a href="#35-丨如何利用大数据成为“增长黑客”？" class="headerlink" title="35 丨如何利用大数据成为“增长黑客”？"></a>35 丨如何利用大数据成为“增长黑客”？</h3><p>AARRR 用户增长模型：它描述了用户增长的 5 个关键环节，分别是：获取用户（Acquisition）、提高活跃度（Activation）、提高留存率（Retention）、获取收入（Revenue）和自传播（Refer）。</p>
<ul>
<li>获取用户：通过各种推广手段，使产品触达用户并吸引用户，让用户访问我们的产品。</li>
<li>提高活跃度：用户访问我们的产品后，如果发现没意思、体验差，就很难再次打开，产品的价值也就无法实现。因此需要结合产品内容、运营活动各种手段吸引用户，提升产品的活跃度。</li>
<li>提高留存率：留住一个老用户的成本远低于获取一个新用户，而真正为产品带来营收利润的通常是老用户，因此需要提高留存率。提高留存率的常用手段有：针对老用户推出各种优惠和活动；建立会员等级体系，注册时间越长等级越高；对于一段时间没有访问的疑似流失用户进行消息短信推送以实现用户挽回等。</li>
<li>获取收入：做企业不是做慈善，开发、运营互联网产品的最终目的还是为了赚钱，即获取收入。互联网产品收入主要有用户付费和广告收入，有些互联网产品看起来是用户付费，但其实主要营收是广告收入，比如淘宝。</li>
<li>自传播：让用户利用利用自己的社交网络进行产品推广就是自传播，几乎所有的互联网产品都有“分享到”这样一个功能按钮，促进用户社交传播。有些产品还会利用“帮我砍价”“帮我抢票”等产品功能推动用户进行分享，实现产品的裂变式传播、病毒式营销。</li>
</ul>
<p>增长用户的手段主要有：</p>
<p>利用用户画像定位用户群体</p>
<ul>
<li>通过用户分析挽回用户</li>
<li>A&#x2F;B 测试决定产品功能</li>
<li>大数据反欺诈、反羊毛</li>
<li>用户生命周期管理</li>
</ul>
<h3 id="36-丨模块答疑：为什么说数据驱动运营？"><a href="#36-丨模块答疑：为什么说数据驱动运营？" class="headerlink" title="36 丨模块答疑：为什么说数据驱动运营？"></a>36 丨模块答疑：为什么说数据驱动运营？</h3><p>略</p>
<h2 id="模块六、大数据算法"><a href="#模块六、大数据算法" class="headerlink" title="模块六、大数据算法"></a>模块六、大数据算法</h2><h3 id="37-丨如何对数据进行分类和预测？"><a href="#37-丨如何对数据进行分类和预测？" class="headerlink" title="37 丨如何对数据进行分类和预测？"></a>37 丨如何对数据进行分类和预测？</h3><p>KNN 算法：KNN 算法，即 K 近邻（K Nearest Neighbour）算法，是一种基本的分类算法。其主要原理是：对于一个需要分类的数据，将其和一组已经分类标注好的样本集合进行比较，得到距离最近的 K 个样本，K 个样本最多归属的类别，就是这个需要分类数据的类别。</p>
<p>数据的距离：</p>
<ul>
<li>欧氏距离：计算空间距离</li>
<li>余弦相似度：计算向量的夹角。更关注数据的相似性</li>
</ul>
<p>文本的特征值：</p>
<ul>
<li>TF-IDF 算法：TF 与 IDF 的乘积就是 TF-IDF。<ul>
<li>TF 是词频（Term Frequency），表示某个单词在文档中出现的频率，一个单词在一个文档中出现的越频繁，TF 值越高。</li>
<li>IDF 是逆文档频率（Inverse Document Frequency），表示这个单词在所有文档中的稀缺程度，越少文档出现这个词，IDF 值越高。</li>
</ul>
</li>
</ul>
<p>贝叶斯分类：贝叶斯公式是一种基于条件概率的分类算法，如果我们已经知道 A 和 B 的发生概率，并且知道了 B 发生情况下 A 发生的概率，可以用贝叶斯公式计算 A 发生的情况下 B 发生的概率。</p>
<h3 id="38-丨如何发掘数据之间的关系？"><a href="#38-丨如何发掘数据之间的关系？" class="headerlink" title="38 丨如何发掘数据之间的关系？"></a>38 丨如何发掘数据之间的关系？</h3><p>搜索排序：Google PageRank 算法</p>
<p>关联分析：</p>
<ul>
<li>Apriori 算法：Apriori 算法极大地降低了需要计算的商品组合数目，这个算法的原理是，如果一个商品组合不满足最小支持度，那么所有包含这个商品组合的其他商品组合也不满足最小支持度。所以从最小商品组合，也就是一件商品开始计算最小支持度，逐渐迭代，进而筛选出所有满足最小支持度的频繁模式。其步骤如下：<ol>
<li>设置最小支持度阈值。</li>
<li>寻找满足最小支持度的单件商品，也就是单件商品出现在所有订单中的概率不低于最小支持度。</li>
<li>从第 2 步找到的所有满足最小支持度的单件商品中，进行两两组合，寻找满足最小支持度的两件商品组合，也就是两件商品出现在同一个订单中概率不低于最小支持度。</li>
<li>从第 3 步找到的所有满足最小支持度的两件商品，以及第 2 步找到的满足最小支持度的单件商品进行组合，寻找满足最小支持度的三件商品组合。</li>
<li>以此类推，找到所有满足最小支持度的商品组合。</li>
</ol>
</li>
</ul>
<p>聚类：聚类就是对一批数据进行自动归类。</p>
<p>K-means 算法</p>
<h3 id="39-丨如何预测用户的喜好？"><a href="#39-丨如何预测用户的喜好？" class="headerlink" title="39 丨如何预测用户的喜好？"></a>39 丨如何预测用户的喜好？</h3><p>基于人口统计的推荐：基于人口统计的推荐是相对比较简单的一种推荐算法，根据用户的基本信息进行分类，然后将商品推荐给同类用户。</p>
<p>基于产品属性的推荐：基于用户的属性进行分类，然后根据同类用户的行为进行推荐。而基于商品属性的推荐则是将商品的属性进行分类，然后根据用户的历史行为进行推荐。</p>
<p>基于用户的协同过滤推荐：基于用户的协同过滤推荐是根据用户的喜好进行用户分类，常用的就是 KNN 算法，寻找和当前用户喜好最相近的 K 个用户，然后根据这些用户的喜好为当前用户进行推荐。</p>
<p>基于商品的协同过滤推荐：根据用户的喜好对商品进行分类，如果两个商品，喜欢它们的用户具有较高的重叠性，就认为它们的距离相近，划分为同类商品，然后进行推荐</p>
<h3 id="40-丨机器学习的数学原理是什么？"><a href="#40-丨机器学习的数学原理是什么？" class="headerlink" title="40 丨机器学习的数学原理是什么？"></a>40 丨机器学习的数学原理是什么？</h3><p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/20230313161656.png"></p>
<p>样本：样本就是通常我们常说的“训练数据”，包括输入和结果两部分。</p>
<p>模型：模型就是映射样本输入与样本结果的函数，可能是一个条件概率分布，也可能是一个决策函数。</p>
<p>算法：算法就是要从模型的假设空间中寻找一个最优的函数，使得样本空间的输入 X 经过该函数的映射得到的 f(X)，和真实的 Y 值之间的距离最小。这个最优的函数通常没办法直接计算得到，即没有解析解，需要用数值计算的方法不断迭代求解。因此如何寻找到 f 函数的全局最优解，以及使寻找过程尽量高效，就构成了机器学习的算法。</p>
<h3 id="41-丨从感知机到神经网络算法"><a href="#41-丨从感知机到神经网络算法" class="headerlink" title="41 丨从感知机到神经网络算法"></a>41 丨从感知机到神经网络算法</h3><h3 id="42-丨模块答疑：软件工程师如何进入人工智能领域？"><a href="#42-丨模块答疑：软件工程师如何进入人工智能领域？" class="headerlink" title="42 丨模块答疑：软件工程师如何进入人工智能领域？"></a>42 丨模块答疑：软件工程师如何进入人工智能领域？</h3><p>斯坦福大学的机器学习公开课</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a target="_blank" rel="noopener" href="https://time.geekbang.org/column/intro/100020201">极客时间教程 - 从 0 开始学大数据</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://dunwu.github.io/blog/pages/264d3a22/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/uploads/avatar.gif">
      <meta itemprop="name" content="钝悟 ◾ Dunwu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dunwu Blog">
      <meta itemprop="description" content="钝悟的个人博客">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Dunwu Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/pages/264d3a22/" class="post-title-link" itemprop="url">Spring MVC 之视图技术</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-02-17 11:21:25" itemprop="dateCreated datePublished" datetime="2023-02-17T11:21:25+08:00">2023-02-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-09-13 17:56:53" itemprop="dateModified" datetime="2025-09-13T17:56:53+08:00">2025-09-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/%E6%A1%86%E6%9E%B6/" itemprop="url" rel="index"><span itemprop="name">框架</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/%E6%A1%86%E6%9E%B6/Spring/" itemprop="url" rel="index"><span itemprop="name">Spring</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/%E6%A1%86%E6%9E%B6/Spring/SpringWeb/" itemprop="url" rel="index"><span itemprop="name">SpringWeb</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>20k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>18 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Spring-MVC-之视图技术"><a href="#Spring-MVC-之视图技术" class="headerlink" title="Spring MVC 之视图技术"></a>Spring MVC 之视图技术</h1><p>Spring MVC 中视图技术的使用是可插拔的。无论决定使用 Thymeleaf、Groovy 等模板引擎、JSP 还是其他技术，都可以通过配置来更改。</p>
<p>Spring MVC 的视图位于该应用程序的内部信任边界内。 视图可以访问应用程序上下文的所有 bean。 因此，不建议在模板可由外部源编辑的应用程序中使用 Spring MVC 的模板支持，因为这可能会产生安全隐患。</p>
<h2 id="Thymeleaf"><a href="#Thymeleaf" class="headerlink" title="Thymeleaf"></a>Thymeleaf</h2><p><a target="_blank" rel="noopener" href="https://www.thymeleaf.org/">Thymeleaf</a> 是一个现代服务器端 Java 模板引擎，它强调自然的 HTML 模板，可以通过双击在浏览器中预览，而无需运行服务器，这对于 UI 模板的独立工作（例如，由设计师）非常有帮助。</p>
<p>Thymeleaf 与 Spring MVC 的集成由 Thymeleaf 项目管理。 配置涉及一些 bean 声明，例如 <code>ServletContextTemplateResolver</code>、<code>SpringTemplateEngine</code> 和 <code>ThymeleafViewResolver</code>。 有关详细信息，请参阅 <a target="_blank" rel="noopener" href="https://www.thymeleaf.org/documentation.html">Thymeleaf+Spring</a>。</p>
<h2 id="FreeMarker"><a href="#FreeMarker" class="headerlink" title="FreeMarker"></a>FreeMarker</h2><p><a target="_blank" rel="noopener" href="https://freemarker.apache.org/">Apache FreeMarker</a> 是一个模板引擎，用于生成从 HTML 到电子邮件等任何类型的文本内容。 Spring 框架内置了 Spring MVC 与 FreeMarker 模板结合使用的集成。</p>
<h3 id="视图配置"><a href="#视图配置" class="headerlink" title="视图配置"></a>视图配置</h3><p>以下示例显示了如何将 FreeMarker 配置为视图技术：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebMvc</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebConfig</span> <span class="keyword">implements</span> <span class="title class_">WebMvcConfigurer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configureViewResolvers</span><span class="params">(ViewResolverRegistry registry)</span> &#123;</span><br><span class="line">        registry.freeMarker();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Configure FreeMarker...</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> FreeMarkerConfigurer <span class="title function_">freeMarkerConfigurer</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">FreeMarkerConfigurer</span> <span class="variable">configurer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FreeMarkerConfigurer</span>();</span><br><span class="line">        configurer.setTemplateLoaderPath(<span class="string">&quot;/WEB-INF/freemarker&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> configurer;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以下示例显示了如何在 XML 中配置相同的内容：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mvc:annotation-driven</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">mvc:view-resolvers</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mvc:freemarker</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mvc:view-resolvers</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- Configure FreeMarker... --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mvc:freemarker-configurer</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mvc:template-loader-path</span> <span class="attr">location</span>=<span class="string">&quot;/WEB-INF/freemarker&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mvc:freemarker-configurer</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>或者，您也可以声明 <code>FreeMarkerConfigurer</code> 以完全控制所有属性，如以下示例所示：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;freemarkerConfig&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.web.servlet.view.freemarker.FreeMarkerConfigurer&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;templateLoaderPath&quot;</span> <span class="attr">value</span>=<span class="string">&quot;/WEB-INF/freemarker/&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>您的模板需要存储在前面示例中所示的 <code>FreeMarkerConfigurer</code> 指定的目录中。鉴于前面的配置，如果您的控制器返回视图名称 <code>welcome</code>，解析器将查找 <code>/WEB-INF/freemarker/welcome.ftl</code> 模板。</p>
<h3 id="FreeMarker-配置"><a href="#FreeMarker-配置" class="headerlink" title="FreeMarker 配置"></a>FreeMarker 配置</h3><p>可以通过在 <code>FreeMarkerConfigurer</code> 上设置适当的 bean 属性，将 FreeMarker ‘Settings’ 和 ‘SharedVariables’ 直接传递给 FreeMarker <code>Configuration</code> 对象（由 Spring 管理）。 <code>freemarkerSettings</code> 属性需要一个 <code>java.util.Properties</code> 对象，<code>freemarkerVariables</code> 属性需要一个 <code>java.util.Map</code>。 以下示例显示了如何使用 <code>FreeMarkerConfigurer</code>：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;freemarkerConfig&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.web.servlet.view.freemarker.FreeMarkerConfigurer&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;templateLoaderPath&quot;</span> <span class="attr">value</span>=<span class="string">&quot;/WEB-INF/freemarker/&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;freemarkerVariables&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">map</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">&quot;xml_escape&quot;</span> <span class="attr">value-ref</span>=<span class="string">&quot;fmXmlEscape&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">map</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;fmXmlEscape&quot;</span> <span class="attr">class</span>=<span class="string">&quot;freemarker.template.utility.XmlEscape&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p>有关应用于 <code>Configuration</code> 对象的设置和变量的详细信息，请参阅 FreeMarker 文档。</p>
<h3 id="表单处理"><a href="#表单处理" class="headerlink" title="表单处理"></a>表单处理</h3><p>Spring 提供了一个用于 JSP 的标记库，其中包含一个 <code>&lt;spring:bind/&gt;</code> 元素。 此元素主要让表单显示来自表单支持对象的值，并显示来自 Web 或业务层中的“验证器”的验证失败的结果。 Spring 还支持 FreeMarker 中的相同功能，以及用于生成表单输入元素的额外便利宏。</p>
<h4 id="绑定宏"><a href="#绑定宏" class="headerlink" title="绑定宏"></a>绑定宏</h4><p>在 FreeMarker 的 <code>spring-webmvc.jar</code> 文件中维护了一组标准宏，因此它们始终可用于适当配置的应用程序。</p>
<p>Spring 模板库中定义的一些宏被认为是内部的（私有的），但宏定义中不存在这样的范围，这使得所有宏对调用代码和用户模板都是可见的。以下部分仅关注您需要从模板中直接调用的宏。如果您想直接查看宏代码，该文件名为 <code>spring.ftl</code> ，位于 <code>org.springframework.web.servlet.view.freemarker</code> 包中。</p>
<h4 id="简单绑定"><a href="#简单绑定" class="headerlink" title="简单绑定"></a>简单绑定</h4><p>在基于充当 Spring MVC 控制器表单视图的 FreeMarker 模板的 HTML 表单中，您可以使用类似于下一个示例的代码来绑定到字段值，并以类似于 JSP 等价物的方式为每个输入字段显示错误消息。以下示例显示了一个 personForm 视图：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- FreeMarker macros have to be imported into a namespace.</span></span><br><span class="line"><span class="comment">    We strongly recommend sticking to &#x27;spring&#x27;. --&gt;</span></span><br><span class="line">&lt;#import &quot;/spring.ftl&quot; as spring/&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;&quot;</span> <span class="attr">method</span>=<span class="string">&quot;POST&quot;</span>&gt;</span></span><br><span class="line">        Name:</span><br><span class="line">        &lt;@spring.bind &quot;personForm.name&quot;/&gt;</span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">name</span>=<span class="string">&quot;$&#123;spring.status.expression&#125;&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">value</span>=<span class="string">&quot;$&#123;spring.status.value?html&#125;&quot;</span>/&gt;</span><span class="tag">&lt;<span class="name">br</span> /&gt;</span></span><br><span class="line">        &lt;#list spring.status.errorMessages as error&gt; <span class="tag">&lt;<span class="name">b</span>&gt;</span>$&#123;error&#125;<span class="tag">&lt;/<span class="name">b</span>&gt;</span> <span class="tag">&lt;<span class="name">br</span> /&gt;</span> &lt;/#list&gt;</span><br><span class="line">        <span class="tag">&lt;<span class="name">br</span> /&gt;</span></span><br><span class="line">        ...</span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;submit&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">    ...</span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>&lt;@spring.bind&gt;</code> 需要一个 ‘path’ 参数，它由命令对象的名称（它是 ‘command’，除非您在控制器配置中更改它）组成，在您希望绑定的命令对象后跟一个句点和字段名称。 您还可以使用嵌套字段，例如 <code>command.address.street</code>。 <code>bind</code> 宏采用 <code>web.xml</code> 中的 <code>ServletContext</code> 参数 <code>defaultHtmlEscape</code> 指定的默认 HTML 转义行为。</p>
<p>称为 <code>&lt;@spring.bindEscaped&gt;</code> 的宏的另一种形式采用第二个参数，该参数明确指定是否应在状态错误消息或值中使用 HTML 转义。 您可以根据需要将其设置为 <code>true</code> 或 <code>false</code> 。 附加的表单处理宏简化了 HTML 转义的使用，您应该尽可能使用这些宏。</p>
<h4 id="输入宏"><a href="#输入宏" class="headerlink" title="输入宏"></a>输入宏</h4><p>FreeMarker 的附加便利宏简化了绑定和表单生成（包括验证错误显示）。 永远不需要使用这些宏来生成表单输入字段，您可以将它们与简单的 HTML 混合搭配，或者直接调用我们之前强调的 Spring 绑定宏。</p>
<p>下表中的可用宏显示了 FreeMarker 模板 (FTL) 定义和每个采用的参数列表：</p>
<table>
<thead>
<tr>
<th align="left">macro</th>
<th align="left">FTL definition</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><code>message</code> (output a string from a resource bundle based on the code parameter)</td>
<td align="left">&lt;@spring.message code&#x2F;&gt;</td>
</tr>
<tr>
<td align="left"><code>messageText</code> (output a string from a resource bundle based on the code parameter, falling back to the value of the default parameter)</td>
<td align="left">&lt;@spring.messageText code, text&#x2F;&gt;</td>
</tr>
<tr>
<td align="left"><code>url</code> (prefix a relative URL with the application’s context root)</td>
<td align="left">&lt;@spring.url relativeUrl&#x2F;&gt;</td>
</tr>
<tr>
<td align="left"><code>formInput</code> (standard input field for gathering user input)</td>
<td align="left">&lt;@spring.formInput path, attributes, fieldType&#x2F;&gt;</td>
</tr>
<tr>
<td align="left"><code>formHiddenInput</code> (hidden input field for submitting non-user input)</td>
<td align="left">&lt;@spring.formHiddenInput path, attributes&#x2F;&gt;</td>
</tr>
<tr>
<td align="left"><code>formPasswordInput</code> (standard input field for gathering passwords. Note that no value is ever populated in fields of this type.)</td>
<td align="left">&lt;@spring.formPasswordInput path, attributes&#x2F;&gt;</td>
</tr>
<tr>
<td align="left"><code>formTextarea</code> (large text field for gathering long, freeform text input)</td>
<td align="left">&lt;@spring.formTextarea path, attributes&#x2F;&gt;</td>
</tr>
<tr>
<td align="left"><code>formSingleSelect</code> (drop down box of options that let a single required value be selected)</td>
<td align="left">&lt;@spring.formSingleSelect path, options, attributes&#x2F;&gt;</td>
</tr>
<tr>
<td align="left"><code>formMultiSelect</code> (a list box of options that let the user select 0 or more values)</td>
<td align="left">&lt;@spring.formMultiSelect path, options, attributes&#x2F;&gt;</td>
</tr>
<tr>
<td align="left"><code>formRadioButtons</code> (a set of radio buttons that let a single selection be made from the available choices)</td>
<td align="left">&lt;@spring.formRadioButtons path, options separator, attributes&#x2F;&gt;</td>
</tr>
<tr>
<td align="left"><code>formCheckboxes</code> (a set of checkboxes that let 0 or more values be selected)</td>
<td align="left">&lt;@spring.formCheckboxes path, options, separator, attributes&#x2F;&gt;</td>
</tr>
<tr>
<td align="left"><code>formCheckbox</code> (a single checkbox)</td>
<td align="left">&lt;@spring.formCheckbox path, attributes&#x2F;&gt;</td>
</tr>
<tr>
<td align="left"><code>showErrors</code> (simplify display of validation errors for the bound field)</td>
<td align="left">&lt;@spring.showErrors separator, classOrStyle&#x2F;&gt;</td>
</tr>
</tbody></table>
<p>上述任何宏的参数具有一致的含义：</p>
<ul>
<li><code>path</code>: 要绑定到的字段的名称（例如，“command.name”）</li>
<li><code>options</code>: 可在输入字段中选择的所有可用值的 <code>Map</code>。映射的键表示从表单回传并绑定到命令对象的值。针对键存储的 map 对象是在表单上显示给用户的标签，可能与表单回传的相应值不同。通常，这样的地图由控制器提供作为参考数据。您可以使用任何 <code>Map</code> 实现，具体取决于所需的行为。对于严格排序的映射，您可以使用带有合适的“比较器”的 <code>SortedMap</code>（例如 <code>TreeMap</code>），对于应按插入顺序返回值的任意映射，使用“LinkedHashMap”或“LinkedMap” <code>公共收藏</code>。</li>
<li><code>separator</code>: 在多个选项可用作离散元素（单选按钮或复选框）的情况下，用于分隔列表中每个选项的字符序列（例如 <code>&lt;br&gt;</code>）。</li>
<li><code>attributes</code>: 要包含在 HTML 标记本身中的任意标记或文本的附加字符串。该字符串按字面意思由宏回显。例如，在 <code>textarea</code> 字段中，您可以提供属性（例如“rows&#x3D;”5” cols&#x3D;”60”‘），或者您可以传递样式信息，例如 ‘style&#x3D;”border:1px solid silver”‘。</li>
<li><code>classOrStyle</code>: 对于 <code>showErrors</code> 宏，包装每个错误的 <code>span</code> 元素使用的 CSS 类的名称。如果未提供任何信息（或值为空），错误将包含在 <code>&lt;b&gt;&lt;/b&gt;</code> 标签中。</li>
</ul>
<p>以下部分概述了宏的示例。</p>
<p>输入字段</p>
<p><code>formInput</code> 宏采用 <code>path</code> 参数 (<code>command.name</code>) 和一个额外的 <code>attributes</code> 参数（在接下来的示例中为空）。该宏与所有其他表单生成宏一起对路径参数执行隐式 Spring 绑定。绑定在新绑定发生之前一直有效，因此 <code>showErrors</code> 宏不需要再次传递路径参数——它对上次创建绑定的字段进行操作。</p>
<p><code>showErrors</code> 宏接受一个分隔符参数（用于分隔给定字段上的多个错误的字符），还接受第二个参数——这次是类名或样式属性。请注意，FreeMarker 可以为 attributes 参数指定默认值。以下示例显示了如何使用 <code>formInput</code> 和 <code>showErrors</code> 宏：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;@spring.formInput &quot;command.name&quot;/&gt;</span><br><span class="line">&lt;@spring.showErrors &quot;<span class="tag">&lt;<span class="name">br</span>&gt;</span>&quot;/&gt;</span><br></pre></td></tr></table></figure>

<p>下一个示例显示表单片段的输出，生成名称字段并在表单提交后显示验证错误，该字段中没有任何值。验证通过 Spring 的验证框架进行。</p>
<p>生成的 HTML 类似于以下示例：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Name:</span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">b</span>&gt;</span>required<span class="tag">&lt;/<span class="name">b</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>formTextarea</code> 宏的工作方式与 <code>formInput</code> 宏相同，并且接受相同的参数列表。通常，第二个参数 (<code>attributes</code>) 用于传递样式信息或 <code>textarea</code> 的 <code>rows</code> 和 <code>cols</code> 属性。</p>
<p>选中字段</p>
<p>您可以使用四个选择字段宏在 HTML 表单中生成常见的 UI 值选择输入：</p>
<ul>
<li><code>formSingleSelect</code></li>
<li><code>formMultiSelect</code></li>
<li><code>formRadioButtons</code></li>
<li><code>formCheckboxes</code></li>
</ul>
<p>四个宏中的每一个都接受一个“Map”选项，其中包含表单字段的值和与该值对应的标签。值和标签可以相同。</p>
<p>下一个例子是 FTL 中的单选按钮。表单支持对象为此字段指定默认值“伦敦”，因此无需验证。渲染表单时，整个可供选择的城市列表作为参考数据提供在模型中，名称为 <code>cityMap</code>。以下清单显示了示例：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">Town:</span><br><span class="line">&lt;@spring.formRadioButtons &quot;command.address.town&quot;, cityMap, &quot;&quot;/&gt;<span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>前面的清单呈现一行单选按钮，一个用于 <code>cityMap</code> 中的每个值，并使用分隔符 <code>&quot;&quot;</code>。没有提供额外的属性（缺少宏的最后一个参数）。 <code>cityMap</code> 对地图中的每个键值对使用相同的 <code>String</code>。地图的键是表单实际作为 POST 请求参数提交的内容。地图值是用户看到的标签。在前面的示例中，给定三个知名城市的列表和表单支持对象中的默认值，HTML 类似于以下内容：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Town:</span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;radio&quot;</span> <span class="attr">name</span>=<span class="string">&quot;address.town&quot;</span> <span class="attr">value</span>=<span class="string">&quot;London&quot;</span>&gt;</span>London<span class="tag">&lt;/<span class="name">input</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;radio&quot;</span> <span class="attr">name</span>=<span class="string">&quot;address.town&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Paris&quot;</span> <span class="attr">checked</span>=<span class="string">&quot;checked&quot;</span>&gt;</span>Paris<span class="tag">&lt;/<span class="name">input</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;radio&quot;</span> <span class="attr">name</span>=<span class="string">&quot;address.town&quot;</span> <span class="attr">value</span>=<span class="string">&quot;New York&quot;</span>&gt;</span>New York<span class="tag">&lt;/<span class="name">input</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>如果您的应用程序希望通过内部代码处理城市（例如），您可以使用合适的键创建代码映射，如以下示例所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> Map&lt;String, ?&gt; referenceData(HttpServletRequest request) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    Map&lt;String, String&gt; cityMap = <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>&lt;&gt;();</span><br><span class="line">    cityMap.put(<span class="string">&quot;LDN&quot;</span>, <span class="string">&quot;London&quot;</span>);</span><br><span class="line">    cityMap.put(<span class="string">&quot;PRS&quot;</span>, <span class="string">&quot;Paris&quot;</span>);</span><br><span class="line">    cityMap.put(<span class="string">&quot;NYC&quot;</span>, <span class="string">&quot;New York&quot;</span>);</span><br><span class="line"></span><br><span class="line">    Map&lt;String, Object&gt; model = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    model.put(<span class="string">&quot;cityMap&quot;</span>, cityMap);</span><br><span class="line">    <span class="keyword">return</span> model;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>代码现在生成输出，其中无线电值是相关代码，但用户仍然看到更用户友好的城市名称，如下所示：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Town:</span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;radio&quot;</span> <span class="attr">name</span>=<span class="string">&quot;address.town&quot;</span> <span class="attr">value</span>=<span class="string">&quot;LDN&quot;</span>&gt;</span>London<span class="tag">&lt;/<span class="name">input</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;radio&quot;</span> <span class="attr">name</span>=<span class="string">&quot;address.town&quot;</span> <span class="attr">value</span>=<span class="string">&quot;PRS&quot;</span> <span class="attr">checked</span>=<span class="string">&quot;checked&quot;</span>&gt;</span>Paris<span class="tag">&lt;/<span class="name">input</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;radio&quot;</span> <span class="attr">name</span>=<span class="string">&quot;address.town&quot;</span> <span class="attr">value</span>=<span class="string">&quot;NYC&quot;</span>&gt;</span>New York<span class="tag">&lt;/<span class="name">input</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="HTML-转义"><a href="#HTML-转义" class="headerlink" title="HTML 转义"></a>HTML 转义</h4><p>前面描述的表单宏的默认使用导致 HTML 元素符合 HTML 4.01，并且使用 <code>web.xml</code> 文件中定义的 HTML 转义的默认值，如 Spring 的绑定支持所使用的那样。 要使元素符合 XHTML 或覆盖默认的 HTML 转义值，您可以在模板中指定两个变量（或在模型中，它们对模板可见）。 在模板中指定它们的好处是它们可以在稍后的模板处理中更改为不同的值，以便为表单中的不同字段提供不同的行为。</p>
<p>要为您的标签切换到 XHTML 合规性，请为名为 <code>xhtmlCompliant</code> 的模型或上下文变量指定 <code>true</code> 值，如以下示例所示：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;#-- for FreeMarker --&gt;</span><br><span class="line">&lt;#assign xhtmlCompliant = true&gt;</span><br></pre></td></tr></table></figure>

<p>处理此指令后，Spring 宏生成的任何元素现在都符合 XHTML。</p>
<p>以类似的方式，您可以为每个字段指定 HTML 转义，如以下示例所示：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;#-- until this point, default HTML escaping is used --&gt;</span><br><span class="line"></span><br><span class="line">&lt;#assign htmlEscape = true&gt;</span><br><span class="line">&lt;#-- next field will use HTML escaping --&gt;</span><br><span class="line">&lt;@spring.formInput &quot;command.name&quot;/&gt;</span><br><span class="line"></span><br><span class="line">&lt;#assign htmlEscape = false in spring&gt;</span><br><span class="line">&lt;#-- all future fields will be bound with HTML escaping off --&gt;</span><br></pre></td></tr></table></figure>

<h2 id="Groovy"><a href="#Groovy" class="headerlink" title="Groovy"></a>Groovy</h2><p><a target="_blank" rel="noopener" href="https://groovy-lang.org/templating.html#_the_markuptemplateengine">Groovy 标记模板引擎</a> 主要用于生成类似 XML 的标记（XML、XHTML、HTML5 等），但可以使用它来生成任何基于文本的内容。 Spring Framework 具有将 Spring MVC 与 Groovy 标记结合使用的内置集成。</p>
<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><p>以下示例显示如何配置 Groovy 标记模板引擎：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebMvc</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebConfig</span> <span class="keyword">implements</span> <span class="title class_">WebMvcConfigurer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configureViewResolvers</span><span class="params">(ViewResolverRegistry registry)</span> &#123;</span><br><span class="line">        registry.groovy();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Configure the Groovy Markup Template Engine...</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> GroovyMarkupConfigurer <span class="title function_">groovyMarkupConfigurer</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">GroovyMarkupConfigurer</span> <span class="variable">configurer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GroovyMarkupConfigurer</span>();</span><br><span class="line">        configurer.setResourceLoaderPath(<span class="string">&quot;/WEB-INF/&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> configurer;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以下示例显示了如何在 XML 中配置相同的内容：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mvc:annotation-driven</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">mvc:view-resolvers</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mvc:groovy</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mvc:view-resolvers</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- Configure the Groovy Markup Template Engine... --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mvc:groovy-configurer</span> <span class="attr">resource-loader-path</span>=<span class="string">&quot;/WEB-INF/&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h3><p>与传统的模板引擎不同，Groovy 标记依赖于使用构建器语法的 DSL。以下示例显示了 HTML 页面的示例模板：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">yieldUnescaped <span class="string">&#x27;&lt;!DOCTYPE html&gt;&#x27;</span></span><br><span class="line">html(<span class="attr">lang:</span><span class="string">&#x27;en&#x27;</span>) &#123;</span><br><span class="line">    head &#123;</span><br><span class="line">        meta(<span class="string">&#x27;http-equiv&#x27;</span>:<span class="string">&#x27;&quot;Content-Type&quot; content=&quot;text/html; charset=utf-8&quot;&#x27;</span>)</span><br><span class="line">        title(<span class="string">&#x27;My page&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    body &#123;</span><br><span class="line">        p(<span class="string">&#x27;This is an example of HTML contents&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="脚本视图"><a href="#脚本视图" class="headerlink" title="脚本视图"></a>脚本视图</h2><p>Spring 有一个内置的集成，可以将 Spring MVC 与任何可以在 <a target="_blank" rel="noopener" href="https://www.jcp.org/en/jsr/detail?id=223">JSR-223</a> 之上运行的模板库一起使用 Java 脚本引擎。 我们在不同的脚本引擎上测试了以下模板库：</p>
<table>
<thead>
<tr>
<th align="left">脚本库</th>
<th align="left">脚本引擎</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><a target="_blank" rel="noopener" href="https://handlebarsjs.com/">Handlebars</a></td>
<td align="left"><a target="_blank" rel="noopener" href="https://openjdk.java.net/projects/nashorn/">Nashorn</a></td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="https://mustache.github.io/">Mustache</a></td>
<td align="left"><a target="_blank" rel="noopener" href="https://openjdk.java.net/projects/nashorn/">Nashorn</a></td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="https://facebook.github.io/react/">React</a></td>
<td align="left"><a target="_blank" rel="noopener" href="https://openjdk.java.net/projects/nashorn/">Nashorn</a></td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="https://www.embeddedjs.com/">EJS</a></td>
<td align="left"><a target="_blank" rel="noopener" href="https://openjdk.java.net/projects/nashorn/">Nashorn</a></td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="https://www.stuartellis.name/articles/erb/">ERB</a></td>
<td align="left"><a target="_blank" rel="noopener" href="https://www.jruby.org/">JRuby</a></td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="https://docs.python.org/2/library/string.html#template-strings">String templates</a></td>
<td align="left"><a target="_blank" rel="noopener" href="https://www.jython.org/">Jython</a></td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="https://github.com/sdeleuze/kotlin-script-templating">Kotlin Script templating</a></td>
<td align="left"><a target="_blank" rel="noopener" href="https://kotlinlang.org/">Kotlin</a></td>
</tr>
</tbody></table>
<h3 id="要求"><a href="#要求" class="headerlink" title="要求"></a>要求</h3><p>需要在类路径中包含脚本引擎，具体细节因脚本引擎而异：</p>
<ul>
<li>The <a target="_blank" rel="noopener" href="https://openjdk.java.net/projects/nashorn/">Nashorn</a> Java 8+ 提供了 JavaScript 引擎。强烈建议使用可用的最新更新版本。</li>
<li><a target="_blank" rel="noopener" href="https://www.jruby.org/">JRuby</a> 应该作为 Ruby 支持的依赖项添加。</li>
<li><a target="_blank" rel="noopener" href="https://www.jython.org/">Jython</a> 应该作为 Python 支持的依赖项添加。</li>
<li><code>org.jetbrains.kotlin:kotlin-script-util</code> 依赖项和包含 <code>org.jetbrains.kotlin.script.jsr223.KotlinJsr223JvmLocalScriptEngineFactory</code> 行的 <code>META-INF/services/javax.script.ScriptEngineFactory</code> 文件应该被添加 Kotlin 脚本支持。 有关详细信息，请参阅<a target="_blank" rel="noopener" href="https://github.com/sdeleuze/kotlin-script-templating">此示例</a>。</li>
</ul>
<p>您需要有脚本模板库。 为 JavaScript 做到这一点的一种方法是通过 <a target="_blank" rel="noopener" href="https://www.webjars.org/">WebJars</a>。</p>
<h3 id="脚本模板"><a href="#脚本模板" class="headerlink" title="脚本模板"></a>脚本模板</h3><p>可以声明一个 <code>ScriptTemplateConfigurer</code> 来指定要使用的脚本引擎、要加载的脚本文件、调用什么函数来渲染模板等等。 以下示例使用 Mustache 模板和 Nashorn JavaScript 引擎：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebMvc</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebConfig</span> <span class="keyword">implements</span> <span class="title class_">WebMvcConfigurer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configureViewResolvers</span><span class="params">(ViewResolverRegistry registry)</span> &#123;</span><br><span class="line">        registry.scriptTemplate();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ScriptTemplateConfigurer <span class="title function_">configurer</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">ScriptTemplateConfigurer</span> <span class="variable">configurer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ScriptTemplateConfigurer</span>();</span><br><span class="line">        configurer.setEngineName(<span class="string">&quot;nashorn&quot;</span>);</span><br><span class="line">        configurer.setScripts(<span class="string">&quot;mustache.js&quot;</span>);</span><br><span class="line">        configurer.setRenderObject(<span class="string">&quot;Mustache&quot;</span>);</span><br><span class="line">        configurer.setRenderFunction(<span class="string">&quot;render&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> configurer;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以下示例显示了 XML 中的相同配置：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mvc:annotation-driven</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">mvc:view-resolvers</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mvc:script-template</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mvc:view-resolvers</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">mvc:script-template-configurer</span> <span class="attr">engine-name</span>=<span class="string">&quot;nashorn&quot;</span> <span class="attr">render-object</span>=<span class="string">&quot;Mustache&quot;</span> <span class="attr">render-function</span>=<span class="string">&quot;render&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mvc:script</span> <span class="attr">location</span>=<span class="string">&quot;mustache.js&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mvc:script-template-configurer</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>对于 Java 和 XML 配置，controller 看起来没有什么不同，如以下示例所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SampleController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/sample&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">test</span><span class="params">(Model model)</span> &#123;</span><br><span class="line">        model.addAttribute(<span class="string">&quot;title&quot;</span>, <span class="string">&quot;Sample title&quot;</span>);</span><br><span class="line">        model.addAttribute(<span class="string">&quot;body&quot;</span>, <span class="string">&quot;Sample body&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;template&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以下示例显示了 Mustache 模板：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>&#123;&#123;title&#125;&#125;<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>&#123;&#123;body&#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>使用以下参数调用渲染函数：</p>
<ul>
<li><code>String template</code>: 模板内容</li>
<li><code>地图模型</code>：视图模型</li>
<li><code>RenderingContext renderingContext</code>： <a target="_blank" rel="noopener" href="https://docs.spring.io/spring-framework/docs/6.0.5/javadoc-api/org/springframework/web/servlet/view/script/RenderingContext.html"><code>RenderingContext</code></a> 允许访问应用上下文、语言环境、模板加载器和 URL（自 5.0 起）</li>
</ul>
<p>如果您的模板技术需要一些自定义，您可以提供一个实现自定义渲染功能的脚本。 例如，<a target="_blank" rel="noopener" href="https://handlebarsjs.com/">Handlerbars</a> 需要在使用之前编译模板，并且需要一个 <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Polyfill">polyfill</a> 来模拟一些浏览器工具，但在服务器端脚本引擎中不可用。</p>
<p>以下示例显示了如何执行此操作：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebMvc</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebConfig</span> <span class="keyword">implements</span> <span class="title class_">WebMvcConfigurer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configureViewResolvers</span><span class="params">(ViewResolverRegistry registry)</span> &#123;</span><br><span class="line">        registry.scriptTemplate();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ScriptTemplateConfigurer <span class="title function_">configurer</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">ScriptTemplateConfigurer</span> <span class="variable">configurer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ScriptTemplateConfigurer</span>();</span><br><span class="line">        configurer.setEngineName(<span class="string">&quot;nashorn&quot;</span>);</span><br><span class="line">        configurer.setScripts(<span class="string">&quot;polyfill.js&quot;</span>, <span class="string">&quot;handlebars.js&quot;</span>, <span class="string">&quot;render.js&quot;</span>);</span><br><span class="line">        configurer.setRenderFunction(<span class="string">&quot;render&quot;</span>);</span><br><span class="line">        configurer.setSharedEngine(<span class="literal">false</span>);</span><br><span class="line">        <span class="keyword">return</span> configurer;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>polyfill.js</code> 只定义了 Handlebars 正常运行所需的 <code>window</code> 对象，如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> <span class="variable language_">window</span> = &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>这个基本的 <code>render.js</code> 实现在使用之前编译模板。 生产就绪的实现还应该存储任何重复使用的缓存模板或预编译模板。 您可以在脚本端这样做（并处理您需要的任何定制——管理模板引擎配置，例如）。 以下示例显示了如何执行此操作：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">render</span>(<span class="params">template, model</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> compiledTemplate = <span class="title class_">Handlebars</span>.<span class="title function_">compile</span>(template)</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">compiledTemplate</span>(model)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>查看 Spring Framework 单元测试，<a target="_blank" rel="noopener" href="https://github.com/spring-projects/spring-framework/tree/main/spring-webmvc/src/test/java/org/springframework/web/servlet/view/script">Java</a> 和<a target="_blank" rel="noopener" href="https://github.com/spring-projects/spring-framework/tree/main/spring-webmvc/src/test/resources/org/springframework/web/servlet/view/script">资源</a>，以获取更多配置示例。</p>
<h2 id="JSP-和-JSTL"><a href="#JSP-和-JSTL" class="headerlink" title="JSP 和 JSTL"></a>JSP 和 JSTL</h2><p>Spring Framework 具有将 Spring MVC 与 JSP 和 JSTL 结合使用的内置集成。</p>
<blockquote>
<p>更多内容详见：<a target="_blank" rel="noopener" href="https://docs.spring.io/spring-framework/docs/current/reference/html/web.html#mvc-view-jsp">Spring 官方文档之 JSP and JSTL</a></p>
</blockquote>
<h2 id="RSS-and-Atom"><a href="#RSS-and-Atom" class="headerlink" title="RSS and Atom"></a>RSS and Atom</h2><p><code>AbstractAtomFeedView</code> 和 <code>AbstractRssFeedView</code> 都继承自 <code>AbstractFeedView</code> 基类，分别用于提供 Atom 和 RSS Feed 视图。 它们基于 <a target="_blank" rel="noopener" href="https://rometools.github.io/rome/">ROME</a> 项目，位于 org.springframework.web.servlet.view.feed 包中。</p>
<p><code>AbstractAtomFeedView</code> 要求您实现 <code>buildFeedEntries()</code> 方法并可选择覆盖 <code>buildFeedMetadata()</code> 方法（默认实现为空）。 以下示例显示了如何执行此操作：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SampleContentAtomView</span> <span class="keyword">extends</span> <span class="title class_">AbstractAtomFeedView</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">buildFeedMetadata</span><span class="params">(Map&lt;String, Object&gt; model,</span></span><br><span class="line"><span class="params">            Feed feed, HttpServletRequest request)</span> &#123;</span><br><span class="line">        <span class="comment">// implementation omitted</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> List&lt;Entry&gt; <span class="title function_">buildFeedEntries</span><span class="params">(Map&lt;String, Object&gt; model,</span></span><br><span class="line"><span class="params">            HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// implementation omitted</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>类似的要求适用于实现 <code>AbstractRssFeedView</code>，如以下示例所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SampleContentRssView</span> <span class="keyword">extends</span> <span class="title class_">AbstractRssFeedView</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">buildFeedMetadata</span><span class="params">(Map&lt;String, Object&gt; model,</span></span><br><span class="line"><span class="params">            Channel feed, HttpServletRequest request)</span> &#123;</span><br><span class="line">        <span class="comment">// implementation omitted</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> List&lt;Item&gt; <span class="title function_">buildFeedItems</span><span class="params">(Map&lt;String, Object&gt; model,</span></span><br><span class="line"><span class="params">            HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// implementation omitted</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>buildFeedItems()</code> 和 <code>buildFeedEntries()</code> 方法传入 HTTP 请求，以防您需要访问 Locale。 传入 HTTP 响应仅用于设置 cookie 或其他 HTTP 标头。 方法返回后，提要会自动写入响应对象。</p>
<p>有关创建 Atom 视图的示例，请参阅 Alef Arendsen 的 Spring Team 博客 <a target="_blank" rel="noopener" href="https://spring.io/blog/2009/03/16/adding-an-atom-view-to-an-application-using-spring-s-rest-support">entry</a>。</p>
<h2 id="PDF-and-Excel"><a href="#PDF-and-Excel" class="headerlink" title="PDF and Excel"></a>PDF and Excel</h2><p>Spring 提供了返回 HTML 以外的输出的方法，包括 PDF 和 Excel 电子表格。</p>
<h3 id="文档视图简介"><a href="#文档视图简介" class="headerlink" title="文档视图简介"></a>文档视图简介</h3><p>HTML 页面并不总是用户查看模型输出的最佳方式，Spring 使从模型数据动态生成 PDF 文档或 Excel 电子表格变得简单。 该文档是视图，从服务器流出正确的内容类型，（希望）使客户端 PC 能够运行他们的电子表格或 PDF 查看器应用程序作为响应。</p>
<p>为了使用 Excel 视图，您需要将 Apache POI 库添加到类路径中。 对于 PDF 生成，您需要添加（最好）OpenPDF 库。</p>
<h3 id="PDF-视图"><a href="#PDF-视图" class="headerlink" title="PDF 视图"></a>PDF 视图</h3><p>单词列表的简单 PDF 视图可以扩展 <code>org.springframework.web.servlet.view.document.AbstractPdfView</code> 并实现 <code>buildPdfDocument()</code> 方法，如以下示例所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PdfWordList</span> <span class="keyword">extends</span> <span class="title class_">AbstractPdfView</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">buildPdfDocument</span><span class="params">(Map&lt;String, Object&gt; model, Document doc, PdfWriter writer,</span></span><br><span class="line"><span class="params">            HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        List&lt;String&gt; words = (List&lt;String&gt;) model.get(<span class="string">&quot;wordList&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (String word : words) &#123;</span><br><span class="line">            doc.add(<span class="keyword">new</span> <span class="title class_">Paragraph</span>(word));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>控制器可以从外部视图定义（按名称引用它）或作为处理程序方法的 <code>View</code> 实例返回此类视图。</p>
<h3 id="Excel-视图"><a href="#Excel-视图" class="headerlink" title="Excel 视图"></a>Excel 视图</h3><p>从 Spring Framework 4.2 开始，<code>org.springframework.web.servlet.view.document.AbstractXlsView</code> 作为 Excel 视图的基类提供。 它基于 Apache POI，具有专门的子类（<code>AbstractXlsxView</code> 和 <code>AbstractXlsxStreamingView</code>），取代了过时的 <code>AbstractExcelView</code> 类。</p>
<p>编程模型类似于 <code>AbstractPdfView</code>，以 <code>buildExcelDocument()</code> 作为核心模板方法，控制器能够从外部定义（按名称）或作为处理程序方法的 <code>View</code> 实例返回此类视图。</p>
<h2 id="Jackson"><a href="#Jackson" class="headerlink" title="Jackson"></a>Jackson</h2><p>Spring 提供对 Jackson JSON 库的支持。</p>
<h3 id="基于-Jackson-的-JSON-MVC-视图"><a href="#基于-Jackson-的-JSON-MVC-视图" class="headerlink" title="基于 Jackson 的 JSON MVC 视图"></a>基于 Jackson 的 JSON MVC 视图</h3><p><code>MappingJackson2JsonView</code> 使用 Jackson 库的 <code>ObjectMapper</code> 将响应内容渲染为 JSON。 默认情况下，模型映射的全部内容（特定于框架的类除外）都编码为 JSON。 对于需要过滤 map 内容的情况，您可以使用 <code>modelKeys</code> 属性指定一组特定的模型属性进行编码。 您还可以使用 <code>extractValueFromSingleKeyModel</code> 属性直接提取和序列化单键模型中的值，而不是作为模型属性的映射。</p>
<p>您可以根据需要使用 Jackson 提供的注释自定义 JSON 映射。 当您需要进一步控制时，您可以通过 <code>ObjectMapper</code> 属性注入自定义 <code>ObjectMapper</code>，适用于需要为特定类型提供自定义 JSON 序列化器和反序列化器的情况。</p>
<h3 id="基于-Jackson-的-XML-视图"><a href="#基于-Jackson-的-XML-视图" class="headerlink" title="基于 Jackson 的 XML 视图"></a>基于 Jackson 的 XML 视图</h3><p><code>MappingJackson2XmlView</code> 使用 <a target="_blank" rel="noopener" href="https://github.com/FasterXML/jackson-dataformat-xml">Jackson XML 扩展</a> <code>XmlMapper</code> 将响应内容渲染为 XML。 如果模型包含多个条目，您应该使用 <code>modelKey</code> bean 属性显式设置要序列化的对象。 如果模型包含单个条目，它会自动序列化。</p>
<p>您可以根据需要使用 JAXB 或 Jackson 提供的注释自定义 XML 映射。当您需要进一步控制时，您可以通过 <code>ObjectMapper</code> 属性注入自定义 <code>XmlMapper</code>，对于需要为特定类型提供序列化器和反序列化器的自定义 XML 的情况</p>
<h2 id="XML"><a href="#XML" class="headerlink" title="XML"></a>XML</h2><p><code>MarshallingView</code> 使用 XML <code>Marshaller</code>（在 <code>org.springframework.oxm</code> 包中定义）将响应内容渲染为 XML。 您可以使用 <code>MarshallingView</code> 实例的 <code>modelKey</code> 属性显式设置要编组的对象。 或者，视图遍历所有模型属性并编组 <code>Marshaller</code> 支持的第一个类型。 有关 <code>org.springframework.oxm</code> 包中功能的更多信息，请参阅 <a target="_blank" rel="noopener" href="https://docs.spring.io/spring-framework/docs/current/reference/html/data-access.html#oxm">Marshalling XML using O&#x2F;X Mappers</a>。</p>
<h2 id="XSLT"><a href="#XSLT" class="headerlink" title="XSLT"></a>XSLT</h2><p>XSLT 是 XML 的一种转换语言，作为 Web 应用程序中的一种视图技术很受欢迎。 如果您的应用程序自然地处理 XML，或者如果您的模型可以很容易地转换为 XML，那么 XSLT 作为一种视图技术是一个不错的选择。 以下部分展示了如何生成 XML 文档作为模型数据，并在 Spring Web MVC 应用程序中使用 XSLT 对其进行转换。</p>
<p>此示例是一个简单的 Spring 应用程序，它在 <code>Controller</code> 中创建关键字列表并将它们添加到模型映射中。 返回映射以及我们的 XSLT 视图的视图名称。 有关 Spring Web MVC 的 <code>Controller</code> 接口的详细信息，请参阅 <a target="_blank" rel="noopener" href="https://docs.spring.io/spring-framework/docs/current/reference/html/web.html#mvc-controller">Annotated Controllers</a>。 XSLT 控制器将单词列表转换为准备转换的简单 XML 文档。</p>
<h3 id="Beans"><a href="#Beans" class="headerlink" title="Beans"></a>Beans</h3><p>配置是一个简单的 Spring Web 应用程序的标准配置：MVC 配置必须定义一个 <code>XsltViewResolver</code> 和常规 MVC 注释配置。以下示例显示了如何执行此操作：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableWebMvc</span></span><br><span class="line"><span class="meta">@ComponentScan</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebConfig</span> <span class="keyword">implements</span> <span class="title class_">WebMvcConfigurer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> XsltViewResolver <span class="title function_">xsltViewResolver</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">XsltViewResolver</span> <span class="variable">viewResolver</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XsltViewResolver</span>();</span><br><span class="line">        viewResolver.setPrefix(<span class="string">&quot;/WEB-INF/xsl/&quot;</span>);</span><br><span class="line">        viewResolver.setSuffix(<span class="string">&quot;.xslt&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> viewResolver;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Controller"><a href="#Controller" class="headerlink" title="Controller"></a>Controller</h3><p>我们还需要一个控制器来封装我们的单词生成逻辑。</p>
<p>控制器逻辑封装在一个 <code>@Controller</code> 类中，处理方法定义如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">XsltController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">home</span><span class="params">(Model model)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Document</span> <span class="variable">document</span> <span class="operator">=</span> DocumentBuilderFactory.newInstance().newDocumentBuilder().newDocument();</span><br><span class="line">        <span class="type">Element</span> <span class="variable">root</span> <span class="operator">=</span> document.createElement(<span class="string">&quot;wordList&quot;</span>);</span><br><span class="line"></span><br><span class="line">        List&lt;String&gt; words = Arrays.asList(<span class="string">&quot;Hello&quot;</span>, <span class="string">&quot;Spring&quot;</span>, <span class="string">&quot;Framework&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (String word : words) &#123;</span><br><span class="line">            <span class="type">Element</span> <span class="variable">wordNode</span> <span class="operator">=</span> document.createElement(<span class="string">&quot;word&quot;</span>);</span><br><span class="line">            <span class="type">Text</span> <span class="variable">textNode</span> <span class="operator">=</span> document.createTextNode(word);</span><br><span class="line">            wordNode.appendChild(textNode);</span><br><span class="line">            root.appendChild(wordNode);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        model.addAttribute(<span class="string">&quot;wordList&quot;</span>, root);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;home&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>到目前为止，我们只创建了一个 DOM 文档并将其添加到模型映射中。请注意，您还可以将 XML 文件作为 <code>Resource</code> 加载并使用它来代替自定义 DOM 文档。</p>
<p>有可用的软件包可以自动 ‘domify’ 一个对象图，但是在 Spring 中，您可以完全灵活地以您选择的任何方式从您的模型创建 DOM。这可以防止 XML 的转换在模型数据的结构中发挥太大作用，这在使用工具管理 DOMification 过程时是一种危险。</p>
<h3 id="Transformation"><a href="#Transformation" class="headerlink" title="Transformation"></a>Transformation</h3><p>最后，<code>XsltViewResolver</code> 解析 “home” XSLT 模板文件并将 DOM 文档合并到其中以生成我们的视图。如 <code>XsltViewResolver</code> 配置所示，XSLT 模板位于 <code>WEB-INF/xsl</code> 目录下的 <code>war</code> 文件中，并以 <code>xslt</code> 文件扩展名结尾。</p>
<p>以下示例显示了 XSLT 转换：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">xsl:stylesheet</span> <span class="attr">version</span>=<span class="string">&quot;1.0&quot;</span> <span class="attr">xmlns:xsl</span>=<span class="string">&quot;http://www.w3.org/1999/XSL/Transform&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">xsl:output</span> <span class="attr">method</span>=<span class="string">&quot;html&quot;</span> <span class="attr">omit-xml-declaration</span>=<span class="string">&quot;yes&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">xsl:template</span> <span class="attr">match</span>=<span class="string">&quot;/&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">head</span>&gt;</span><span class="tag">&lt;<span class="name">title</span>&gt;</span>Hello!<span class="tag">&lt;/<span class="name">title</span>&gt;</span><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">h1</span>&gt;</span>My First Words<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">xsl:apply-templates</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">xsl:template</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">xsl:template</span> <span class="attr">match</span>=<span class="string">&quot;word&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">xsl:value-of</span> <span class="attr">select</span>=<span class="string">&quot;.&quot;</span>/&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">xsl:template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">xsl:stylesheet</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>前面的转换渲染为以下 HTML：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;Content-Type&quot;</span> <span class="attr">content</span>=<span class="string">&quot;text/html; charset=UTF-8&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Hello!<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>My First Words<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">li</span>&gt;</span>Hello<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">li</span>&gt;</span>Spring<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">li</span>&gt;</span>Framework<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-framework/docs/current/spring-framework-reference/index.html">Spring Framework 官方文档</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-framework/docs/current/reference/html/web.html">Spring Framework 官方文档之 Web</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://dunwu.github.io/blog/pages/a7b9b8e7/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/uploads/avatar.gif">
      <meta itemprop="name" content="钝悟 ◾ Dunwu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dunwu Blog">
      <meta itemprop="description" content="钝悟的个人博客">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Dunwu Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/pages/a7b9b8e7/" class="post-title-link" itemprop="url">Spring MVC 之跨域</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-02-16 20:33:26" itemprop="dateCreated datePublished" datetime="2023-02-16T20:33:26+08:00">2023-02-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-09-13 17:56:53" itemprop="dateModified" datetime="2025-09-13T17:56:53+08:00">2025-09-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/%E6%A1%86%E6%9E%B6/" itemprop="url" rel="index"><span itemprop="name">框架</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/%E6%A1%86%E6%9E%B6/Spring/" itemprop="url" rel="index"><span itemprop="name">Spring</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/%E6%A1%86%E6%9E%B6/Spring/SpringWeb/" itemprop="url" rel="index"><span itemprop="name">SpringWeb</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>4.7k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>4 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Spring-MVC-之跨域"><a href="#Spring-MVC-之跨域" class="headerlink" title="Spring MVC 之跨域"></a>Spring MVC 之跨域</h1><p>Spring MVC 支持跨域处理（CORS）。</p>
<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>出于安全原因，浏览器禁止对当前源之外的资源进行 AJAX 调用。例如，可以在一个选项卡中使用您的银行帐户，而在另一个选项卡中使用 evil.com。来自 evil.com 的脚本不应该能够使用您的凭据向您的银行 API 发出 AJAX 请求——例如从您的账户中取款！</p>
<p>跨域（CORS）是由 <a target="_blank" rel="noopener" href="https://caniuse.com/#feat=cors">大多数浏览器</a> 实施的 <a target="_blank" rel="noopener" href="https://www.w3.org/TR/cors/">W3C 规范</a>，可让您指定哪种跨域请求是授权，而不是使用基于 IFRAME 或 JSONP 的不太安全和不太强大的解决方法。</p>
<h2 id="处理"><a href="#处理" class="headerlink" title="处理"></a>处理</h2><p>CORS 规范分为预检请求、简单请求和实际请求。要了解 CORS 的工作原理，可以阅读 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS">Cross-Origin Resource Sharing (CORS)</a> 等，或者查看规范了解更多详细信息。</p>
<p>Spring MVC <code>HandlerMapping</code> 实现提供了对 CORS 的内置支持。成功将请求映射到处理程序后，<code>HandlerMapping</code> 实现检查给定请求和处理程序的 CORS 配置并采取进一步的操作。预检请求被直接处理，而简单和实际的 CORS 请求被拦截、验证，并设置了所需的 CORS 响应标头。</p>
<p>为了启用跨源请求（即存在 <code>Origin</code> 标头并且与请求的主机不同），您需要有一些明确声明的 CORS 配置。如果未找到匹配的 CORS 配置，预检请求将被拒绝。没有 CORS 标头添加到简单和实际 CORS 请求的响应中，因此浏览器会拒绝它们。</p>
<p>每个 <code>HandlerMapping</code> 都可以[配置](<a target="_blank" rel="noopener" href="https://docs.spring.io/spring-framework/docs/6.0.4/javadoc-api/org/springframework/web/servlet/handler/AbstractHandlerMapping.html#setCorsConfigurations-">https://docs.spring.io/spring-framework/docs/6.0.4/javadoc-api/org/springframework/web/servlet/handler/AbstractHandlerMapping.html#setCorsConfigurations-</a> java.util.Map-) 单独使用基于 URL 模式的 <code>CorsConfiguration</code> 映射。 在大多数情况下，应用程序使用 MVC Java 配置或 XML 命名空间来声明此类映射，这会导致将单个全局映射传递给所有 <code>HandlerMapping</code> 实例。</p>
<p>可以将 <code>HandlerMapping</code> 级别的全局 CORS 配置与更细粒度的处理程序级别的 CORS 配置相结合。 例如，带注释的控制器可以使用类级或方法级的 <code>@CrossOrigin</code> 注释（其他处理程序可以实现 <code>CorsConfigurationSource</code>）。</p>
<p>The rules for combining global and local configuration are generally additive — for example, all global and all local origins. For those attributes where only a single value can be accepted, e.g. <code>allowCredentials</code> and <code>maxAge</code>, the local overrides the global value.</p>
<p>结合全局和局部配置的规则通常是附加的⟩——例如，所有全局和所有局部起源。 对于那些只能接受单个值的属性，例如 <code>allowCredentials</code> 和 <code>maxAge</code>，局部覆盖全局值。</p>
<h2 id="CrossOrigin"><a href="#CrossOrigin" class="headerlink" title="@CrossOrigin"></a><code>@CrossOrigin</code></h2><p><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-framework/docs/6.0.4/javadoc-api/org/springframework/web/bind/annotation/CrossOrigin.html"><code>@CrossOrigin</code></a> 注解在带注解的 Controller 方法上启用跨源请求，如以下示例所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/account&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AccountController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@CrossOrigin</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Account <span class="title function_">retrieve</span><span class="params">(<span class="meta">@PathVariable</span> Long id)</span> &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@DeleteMapping(&quot;/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">remove</span><span class="params">(<span class="meta">@PathVariable</span> Long id)</span> &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>默认，<code>@CrossOrigin</code> 允许访问：</p>
<ul>
<li>所以 origin</li>
<li>所以 header</li>
<li>所以 Controller 方法映射到的 HTTP 方法</li>
</ul>
<p><code>allowCredentials</code> 默认情况下不启用，因为它建立了一个信任级别，可以公开敏感的用户特定信息（例如 cookie 和 CSRF 令牌），并且只应在适当的情况下使用。启用时，必须将 <code>allowOrigins</code> 设置为一个或多个特定域（但不是特殊值 <code>&quot;*&quot;</code>），或者 <code>allowOriginPatterns</code> 属性可用于匹配一组动态来源。</p>
<p><code>maxAge</code> 单位为分钟</p>
<p><code>@CrossOrigin</code> 也支持类级别，并且被所有方继承，如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@CrossOrigin(origins = &quot;https://domain2.com&quot;, maxAge = 3600)</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/account&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AccountController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Account <span class="title function_">retrieve</span><span class="params">(<span class="meta">@PathVariable</span> Long id)</span> &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@DeleteMapping(&quot;/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">remove</span><span class="params">(<span class="meta">@PathVariable</span> Long id)</span> &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以同时在类级别和方法级别上使用 <code>@CrossOrigin</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@CrossOrigin(maxAge = 3600)</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/account&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AccountController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@CrossOrigin(&quot;https://domain2.com&quot;)</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Account <span class="title function_">retrieve</span><span class="params">(<span class="meta">@PathVariable</span> Long id)</span> &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@DeleteMapping(&quot;/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">remove</span><span class="params">(<span class="meta">@PathVariable</span> Long id)</span> &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="全局配置"><a href="#全局配置" class="headerlink" title="全局配置"></a>全局配置</h2><p>除了细粒度的控制器方法级别配置之外，您可能还想定义一些全局 CORS 配置。您可以在任何 <code>HandlerMapping</code> 上单独设置基于 URL 的 <code>CorsConfiguration</code> 映射。但是，大多数应用程序使用 MVC Java 配置或 MVC XML 命名空间来执行此操作。</p>
<p>默认情况下，全局配置启用以下功能：</p>
<ul>
<li>所以 origin</li>
<li>所以 header</li>
<li><code>GET</code>、<code>HEAD</code> 和 <code>POST</code> 方法</li>
</ul>
<p><code>allowCredentials</code> 默认情况下不启用，因为它建立了一个信任级别，可以公开敏感的用户特定信息（例如 cookie 和 CSRF 令牌），并且只应在适当的情况下使用。启用时，必须将 <code>allowOrigins</code> 设置为一个或多个特定域（但不是特殊值 <code>&quot;*&quot;</code>），或者 <code>allowOriginPatterns</code> 属性可用于匹配一组动态来源。</p>
<p><code>maxAge</code> 单位为分钟</p>
<h3 id="Java-配置"><a href="#Java-配置" class="headerlink" title="Java 配置"></a>Java 配置</h3><p>要在 MVC Java 配置中启用 CORS，您可以使用 <code>CorsRegistry</code> 回调，如以下示例所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebMvc</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebConfig</span> <span class="keyword">implements</span> <span class="title class_">WebMvcConfigurer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addCorsMappings</span><span class="params">(CorsRegistry registry)</span> &#123;</span><br><span class="line"></span><br><span class="line">        registry.addMapping(<span class="string">&quot;/api/**&quot;</span>)</span><br><span class="line">            .allowedOrigins(<span class="string">&quot;https://domain2.com&quot;</span>)</span><br><span class="line">            .allowedMethods(<span class="string">&quot;PUT&quot;</span>, <span class="string">&quot;DELETE&quot;</span>)</span><br><span class="line">            .allowedHeaders(<span class="string">&quot;header1&quot;</span>, <span class="string">&quot;header2&quot;</span>, <span class="string">&quot;header3&quot;</span>)</span><br><span class="line">            .exposedHeaders(<span class="string">&quot;header1&quot;</span>, <span class="string">&quot;header2&quot;</span>)</span><br><span class="line">            .allowCredentials(<span class="literal">true</span>).maxAge(<span class="number">3600</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Add more mappings...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="XML-配置"><a href="#XML-配置" class="headerlink" title="XML 配置"></a>XML 配置</h3><p>要在 XML 命名空间中启用 CORS，可以使用 <code>&lt;mvc:cors&gt;</code> 元素，如以下示例所示：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mvc:cors</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">mvc:mapping</span> <span class="attr">path</span>=<span class="string">&quot;/api/**&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">allowed-origins</span>=<span class="string">&quot;https://domain1.com, https://domain2.com&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">allowed-methods</span>=<span class="string">&quot;GET, PUT&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">allowed-headers</span>=<span class="string">&quot;header1, header2, header3&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">exposed-headers</span>=<span class="string">&quot;header1, header2&quot;</span> <span class="attr">allow-credentials</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">max-age</span>=<span class="string">&quot;123&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">mvc:mapping</span> <span class="attr">path</span>=<span class="string">&quot;/resources/**&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">allowed-origins</span>=<span class="string">&quot;https://domain1.com&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">mvc:cors</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="CORS-过滤器"><a href="#CORS-过滤器" class="headerlink" title="CORS 过滤器"></a>CORS 过滤器</h2><p>可以通过 Spring 内置的 <a target="_blank" rel="noopener" href="https://docs.spring.io/spring-framework/docs/6.0.4/javadoc-api/org/springframework/web/filter/CorsFilter.html"><code>CorsFilter</code></a> 支持 CORS。</p>
<p>要配置过滤器，请将 <code>CorsConfigurationSource</code> 传递给它的构造函数，如以下示例所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">CorsConfiguration</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CorsConfiguration</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Possibly...</span></span><br><span class="line"><span class="comment">// config.applyPermitDefaultValues()</span></span><br><span class="line"></span><br><span class="line">config.setAllowCredentials(<span class="literal">true</span>);</span><br><span class="line">config.addAllowedOrigin(<span class="string">&quot;https://domain1.com&quot;</span>);</span><br><span class="line">config.addAllowedHeader(<span class="string">&quot;*&quot;</span>);</span><br><span class="line">config.addAllowedMethod(<span class="string">&quot;*&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">UrlBasedCorsConfigurationSource</span> <span class="variable">source</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UrlBasedCorsConfigurationSource</span>();</span><br><span class="line">source.registerCorsConfiguration(<span class="string">&quot;/**&quot;</span>, config);</span><br><span class="line"></span><br><span class="line"><span class="type">CorsFilter</span> <span class="variable">filter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CorsFilter</span>(source);</span><br></pre></td></tr></table></figure>

<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-framework/docs/current/spring-framework-reference/index.html">Spring Framework 官方文档</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-framework/docs/current/reference/html/web.html">Spring Framework 官方文档之 Web</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://dunwu.github.io/blog/pages/1e6e3d1d/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/uploads/avatar.gif">
      <meta itemprop="name" content="钝悟 ◾ Dunwu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dunwu Blog">
      <meta itemprop="description" content="钝悟的个人博客">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Dunwu Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/pages/1e6e3d1d/" class="post-title-link" itemprop="url">Spring Web 应用</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-02-14 19:21:22" itemprop="dateCreated datePublished" datetime="2023-02-14T19:21:22+08:00">2023-02-14</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-09-13 17:56:53" itemprop="dateModified" datetime="2025-09-13T17:56:53+08:00">2025-09-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/%E6%A1%86%E6%9E%B6/" itemprop="url" rel="index"><span itemprop="name">框架</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/%E6%A1%86%E6%9E%B6/Spring/" itemprop="url" rel="index"><span itemprop="name">Spring</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/%E6%A1%86%E6%9E%B6/Spring/SpringWeb/" itemprop="url" rel="index"><span itemprop="name">SpringWeb</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>25k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>23 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Spring-Web-应用"><a href="#Spring-Web-应用" class="headerlink" title="Spring Web 应用"></a>Spring Web 应用</h1><p>Spring MVC 提供了一种基于注解的编程模型，<code>@Controller</code> 和 <code>@RestController</code> 组件使用注解来表达请求映射、请求输入、异常处理等。注解控制器具有灵活的方法签名，并且不必扩展基类或实现特定接口。以下示例显示了一个由注解定义的控制器：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/hello&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">handle</span><span class="params">(Model model)</span> &#123;</span><br><span class="line">        model.addAttribute(<span class="string">&quot;message&quot;</span>, <span class="string">&quot;Hello World!&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;index&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在前面的示例中，该方法接受一个 <code>Model</code> 并以 <code>String</code> 形式返回一个视图名称，但还存在许多其他选项。</p>
<h2 id="快速入门"><a href="#快速入门" class="headerlink" title="快速入门"></a>快速入门</h2><p>下面，通过一个简单的示例来展示如何通过 Spring 创建一个 Hello World Web 服务。</p>
<p>（1）<code>pom.xml</code> 中引入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>（2）定义 Controller</p>
<p>Spring 构建 RESTful 服务的方法，HTTP 请求由 <code>Controller</code> 处理。 这些组件由 <code>@RestController</code> 注解标识。</p>
<p>【示例】下面的示例定义了一个处理 <code>/greeting</code> 的 GET 请求</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ui.Model;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GreetingController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/greeting&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">greeting</span><span class="params">(<span class="meta">@RequestParam(name = &quot;name&quot;, required = false, defaultValue = &quot;World&quot;)</span> String name,</span></span><br><span class="line"><span class="params">        Model model)</span> &#123;</span><br><span class="line">        model.addAttribute(<span class="string">&quot;name&quot;</span>, name);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;greeting&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>（3）创建启动类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloWorldApplication</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(HelloWorldApplication.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>（4）启动服务：执行 <code>HelloWorldApplication.main</code> 方法启动 web 服务</p>
<p>（5）测试</p>
<p>打开浏览器，访问 <a target="_blank" rel="noopener" href="http://localhost:8080/greeting%EF%BC%8C%E9%A1%B5%E9%9D%A2%E4%BC%9A%E6%98%BE%E7%A4%BA%E5%A6%82%E4%B8%8B%E5%86%85%E5%AE%B9%EF%BC%9A">http://localhost:8080/greeting，页面会显示如下内容：</a></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Hello<span class="punctuation">,</span> World!</span><br></pre></td></tr></table></figure>

<p>打开浏览器，访问 <a target="_blank" rel="noopener" href="http://localhost:8080/greeting?name=dunwu%EF%BC%8C%E9%A1%B5%E9%9D%A2%E4%BC%9A%E6%98%BE%E7%A4%BA%E5%A6%82%E4%B8%8B%E5%86%85%E5%AE%B9%EF%BC%9A">http://localhost:8080/greeting?name=dunwu，页面会显示如下内容：</a></p>
<figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Hello,</span> dunwu!</span><br></pre></td></tr></table></figure>

<h2 id="Spring-Web-组件"><a href="#Spring-Web-组件" class="headerlink" title="Spring Web 组件"></a>Spring Web 组件</h2><h3 id="组件扫描"><a href="#组件扫描" class="headerlink" title="组件扫描"></a>组件扫描</h3><p>可以使用 Servlet 的 <code>WebApplicationContext</code> 中的标准 Spring bean 定义来定义控制器。<code>@Controller</code> 构造型允许自动检测，与 Spring 对检测类路径中的 <code>@Component</code> 类并为它们自动注册 bean 定义的一般支持保持一致。它还充当带注解类的构造型，表明其作为 Web 组件的角色。</p>
<p>要启用此类 <code>@Controller</code> 的自动检测，可以将组件扫描添加到您的 Java 配置中，如以下示例所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan(&quot;org.example.web&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以下示例显示了与上述示例等效的 XML 配置：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:p</span>=<span class="string">&quot;http://www.springframework.org/schema/p&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:context</span>=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;</span></span></span><br><span class="line"><span class="string"><span class="tag">        http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="string"><span class="tag">        https://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">        http://www.springframework.org/schema/context</span></span></span><br><span class="line"><span class="string"><span class="tag">        https://www.springframework.org/schema/context/spring-context.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">&quot;org.example.web&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- ... --&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="AOP-代理"><a href="#AOP-代理" class="headerlink" title="AOP 代理"></a>AOP 代理</h3><p>在某些情况下，可能需要在运行时使用 AOP 代理装饰控制器。一个例子是，如果选择直接在控制器上使用 <code>@Transactional</code> 注解。在这种情况下，特别是对于控制器，建议使用基于类的代理。直接在控制器上使用此类注解会自动出现这种情况。</p>
<p>如果控制器实现了一个接口，并且需要 AOP 代理，您可能需要显式配置基于类的代理。例如，对于 <code>@EnableTransactionManagement</code> ，可以更改为 <code>@EnableTransactionManagement(proxyTargetClass = true)</code>，对于 <code>&lt;tx:annotation-driven/&gt;</code> ，您可以更改为 <code>&lt;tx:annotation-driven proxy-target-class=&quot;true&quot;/&gt;</code>。</p>
<h3 id="Controller"><a href="#Controller" class="headerlink" title="@Controller"></a>@Controller</h3><p><code>@RestController</code> 是一个<a target="_blank" rel="noopener" href="https://docs.spring.io/spring-framework/docs/current/reference/html/core.html#beans-meta-annotations">组合注解</a>，它本身使用 <code>@Controller</code> 和 <code>@ResponseBody</code> 元注解进行标记，以指示控制器的每个方法继承了类型级别的 <code>@ResponseBody</code> 注解，因此直接写入响应主体，而不是使用 HTML 模板进行视图解析和渲染。</p>
<h3 id="RequestMapping"><a href="#RequestMapping" class="headerlink" title="@RequestMapping"></a>@RequestMapping</h3><p>可以使用 <code>@RequestMapping</code> 注解将请求映射到控制器方法。它具有各种属性，可以通过 URL、HTTP 方法、请求参数、标头和媒体类型进行匹配。可以在类级别使用它来表达共享映射，或者在方法级别使用它来缩小到特定端点的映射。</p>
<p><code>@RequestMapping</code> 的主要参数：</p>
<ul>
<li>path &#x2F; method 指定映射路径与方法</li>
<li>params &#x2F; headers 限定映射范围</li>
<li>consumes &#x2F; produces 限定请求与响应格式</li>
</ul>
<p>Spring 还提供了以下 <code>@RequestMapping</code> 的变体：</p>
<ul>
<li><code>@GetMapping</code></li>
<li><code>@PostMapping</code></li>
<li><code>@PutMapping</code></li>
<li><code>@DeleteMapping</code></li>
<li><code>@PatchMapping</code></li>
</ul>
<p>快捷方式是提供的<a target="_blank" rel="noopener" href="https://docs.spring.io/spring-framework/docs/current/reference/html/web.html#mvc-ann-requestmapping-composed">自定义注解</a>，因为可以说，大多数控制器方法应该映射到特定的 HTTP 方法，而不是使用 <code>@RequestMapping</code>，默认情况下，它与所有 HTTP 方法匹配。在类级别仍然需要 <code>@RequestMapping</code> 来表达共享映射。</p>
<p>以下示例具有类型和方法级别的映射：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/persons&quot;)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PersonController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Person <span class="title function_">getPerson</span><span class="params">(<span class="meta">@PathVariable</span> Long id)</span> &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping</span></span><br><span class="line">    <span class="meta">@ResponseStatus(HttpStatus.CREATED)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">add</span><span class="params">(<span class="meta">@RequestBody</span> Person person)</span> &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="URI-模式"><a href="#URI-模式" class="headerlink" title="URI 模式"></a>URI 模式</h4><p><code>@RequestMapping</code> 方法可以使用 URL 模式进行映射。有两种选择：</p>
<ul>
<li><code>PathPattern</code> - 与 URL 路径匹配的预解析模式也预解析为 <code>PathContainer</code>。该解决方案专为网络使用而设计，可有效处理编码和路径参数，并高效匹配。</li>
<li><code>AntPathMatcher</code> - 根据字符串路径匹配字符串模式。这是在 Spring 配置中也使用的原始解决方案，用于在类路径、文件系统和其他位置选择资源。它的效率较低，并且字符串路径输入对于有效处理 URL 的编码和其他问题是一个挑战。</li>
</ul>
<p><code>PathPattern</code> 是 Web 应用程序的推荐解决方案，它是 Spring WebFlux 中的唯一选择。它从 5.3 版开始在 Spring MVC 中使用，从 6.0 版开始默认启用。请参阅 <a target="_blank" rel="noopener" href="https://docs.spring.io/spring-framework/docs/current/reference/html/web.html#mvc-config-path-matching">MVC 配置</a> 以自定义路径匹配选项。</p>
<p><code>PathPattern</code> 支持与 <code>AntPathMatcher</code> 相同的模式语法。此外，它还支持捕获模式，例如 <code>&#123;spring&#125;</code>，用于匹配路径末尾的 0 个或多个路径段。<code>PathPattern</code> 还限制使用 <code>**</code> 来匹配多个路径段，这样它只允许出现在模式的末尾。这消除了在为给定请求选择最佳匹配模式时出现的许多歧义。有关完整模式语法，请参阅 <a target="_blank" rel="noopener" href="https://docs.spring.io/spring-framework/docs/6.0.4/javadoc-api/org/springframework/web/util/pattern/PathPattern.html">PathPattern</a> 和 <a target="_blank" rel="noopener" href="https://docs.spring.io/spring-framework/docs/6.0.4/javadoc-api/org/springframework/util/AntPathMatcher.html">AntPathMatcher</a>。</p>
<p>一些示例模式：</p>
<ul>
<li><code>&quot;/resources/ima?e.png&quot;</code> -匹配一个字符</li>
<li><code>&quot;/resources/*.png&quot;</code> - 匹配零个或多个字符</li>
<li><code>&quot;/resources/**&quot;</code> - 匹配多个字符</li>
<li><code>&quot;/projects/&#123;project&#125;/versions&quot;</code> - 匹配路径段并将其捕获为变量</li>
<li><code>&quot;/projects/&#123;project:[a-z]+&#125;/versions&quot;</code> - 使用正则表达式匹配并捕获变量</li>
</ul>
<p>可以使用 <code>@PathVariable</code> 访问捕获的 URI 变量。例如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/owners/&#123;ownerId&#125;/pets/&#123;petId&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Pet <span class="title function_">findPet</span><span class="params">(<span class="meta">@PathVariable</span> Long ownerId, <span class="meta">@PathVariable</span> Long petId)</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以在类和方法级别声明 URI 变量，如以下示例所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/owners/&#123;ownerId&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OwnerController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/pets/&#123;petId&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Pet <span class="title function_">findPet</span><span class="params">(<span class="meta">@PathVariable</span> Long ownerId, <span class="meta">@PathVariable</span> Long petId)</span> &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>URI 变量会自动转换为适当的类型，否则会引发 <code>TypeMismatchException</code>。默认支持简单类型（<code>int</code>、<code>long</code>、<code>Date</code> 等），可以注册对任何其他数据类型的支持。请参见<a target="_blank" rel="noopener" href="https://docs.spring.io/spring-framework/docs/current/reference/html/web.html#mvc-ann-typeconversion">类型转换</a>和 <a target="_blank" rel="noopener" href="https://docs.spring.io/spring-framework/docs/current/reference/html/web.html#mvc-ann-initbinder"><code>DataBinder</code></a>。</p>
<p>可以显式命名 URI 变量（例如，<code>@PathVariable(&quot;customId&quot;)</code>），但如果名称相同并且代码是使用 <code>-parameters</code> 编译器标志编译的，则可以省略该细节。</p>
<p>语法 <code>&#123;varName:regex&#125;</code> 使用正则表达式声明一个 URI 变量。例如，给定 URL <code>&quot;/spring-web-3.0.5.jar&quot;</code>，以下方法提取名称、版本和文件扩展名：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/&#123;name:[a-z-]+&#125;-&#123;version:\\d\\.\\d\\.\\d&#125;&#123;ext:\\.[a-z]+&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(<span class="meta">@PathVariable</span> String name, <span class="meta">@PathVariable</span> String version, <span class="meta">@PathVariable</span> String ext)</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>URI 路径模式还可以嵌入 <code>$&#123;…&#125;</code> 占位符，这些占位符在启动时通过使用 <code>PropertySourcesPlaceholderConfigurer</code> 针对本地、系统、环境和其他属性源进行解析。例如，可以使用它来根据某些外部配置参数化基本 URL。</p>
<h4 id="模式比较"><a href="#模式比较" class="headerlink" title="模式比较"></a>模式比较</h4><p>当多个模式匹配一个 URL 时，必须选择最佳匹配。这是通过以下方式之一完成的，具体取决于是否启用了已解析的 <code>PathPattern</code> 以供使用：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-framework/docs/6.0.4/javadoc-api/org/springframework/web/util/pattern/PathPattern.html#SPECIFICITY_COMPARATOR"><code>PathPattern.SPECIFICITY_COMPARATOR</code></a></li>
<li><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-framework/docs/6.0.4/javadoc-api/org/springframework/util/AntPathMatcher.html#getPatternComparator-java.lang.String-"><code>AntPathMatcher.getPatternComparator(String path)</code></a></li>
</ul>
<p>两者都有助于对模式进行排序，更具体的模式位于顶部。如果模式具有较少的 URI 变量（计为 1）、单通配符（计为 1）和双通配符（计为 2），则模式不太具体。如果得分相同，则选择较长的模式。给定相同的分数和长度，选择 URI 变量多于通配符的模式。</p>
<p>默认映射模式 (<code>/**</code>) 被排除在评分之外并始终排在最后。此外，前缀模式（例如 <code>/public/**</code>）被认为不如其他没有双通配符的模式具体。</p>
<h4 id="后缀匹配"><a href="#后缀匹配" class="headerlink" title="后缀匹配"></a>后缀匹配</h4><p>从 5.3 开始，默认情况下 Spring MVC 不再执行 <code>.*</code> 后缀模式匹配，其中映射到 <code>person</code> 的控制器也隐式映射到 <code>/person.*</code>。因此，路径扩展不再用于解释请求的响应内容类型⟩——例如，<code>/person.pdf</code>、<code>/person.xml</code> 等。</p>
<p>当浏览器过去发送难以一致解释的 <code>Accept</code> 请求头时，以这种方式使用文件扩展名是必要的。现在，这不再是必需的，使用 <code>Accept</code> 请求头应该是首选。</p>
<p>随着时间的推移，文件扩展名的使用在很多方面都被证明是有问题的。当使用 URI 变量、路径参数和 URI 编码覆盖时，它可能会导致歧义。关于基于 URL 的授权和安全性的推理也变得更加困难。</p>
<p>要在 5.3 之前的版本中完全禁用路径扩展，请设置以下内容：</p>
<ul>
<li><code>useSuffixPatternMatching(false)</code> - 参考：<a target="_blank" rel="noopener" href="https://docs.spring.io/spring-framework/docs/current/reference/html/web.html#mvc-config-path-matching">PathMatchConfigurer</a></li>
<li><code>favorPathExtension(false)</code> - 参考：<a target="_blank" rel="noopener" href="https://docs.spring.io/spring-framework/docs/current/reference/html/web.html#mvc-config-content-negotiation">ContentNegotiationConfigurer</a></li>
</ul>
<p>除了通过 <code>Accept</code> 请求头之外，还有一种请求内容类型的方法仍然有用，例如在浏览器中键入 URL 时。路径扩展的一种安全替代方法是使用查询参数策略。如果您必须使用文件扩展名，请考虑通过 <a target="_blank" rel="noopener" href="https://docs.spring.io/spring-framework/docs/current/reference/html/web.html#mvc-config-content-negotiation">ContentNegotiationConfigurer</a> 的 <code>mediaTypes</code> 属性将它们限制为明确注册的扩展名列表。</p>
<h4 id="后缀匹配和-RFD"><a href="#后缀匹配和-RFD" class="headerlink" title="后缀匹配和 RFD"></a>后缀匹配和 RFD</h4><p>反射文件下载 (RFD) 攻击与 XSS 类似，因为它依赖于响应中反映的请求输入（例如，查询参数和 URI 变量）。然而，RFD 攻击不是将 JavaScript 插入 HTML，而是依赖于浏览器切换来执行下载，并在稍后双击时将响应视为可执行脚本。</p>
<p>在 Spring MVC 中，<code>@ResponseBody</code> 和 <code>ResponseEntity</code> 方法存在风险，因为它们可以渲染不同的内容类型，客户端可以通过 URL 路径扩展请求这些内容类型。禁用后缀模式匹配并使用路径扩展进行内容协商可以降低风险，但不足以防止 RFD 攻击。</p>
<p>为了防止 RFD 攻击，在渲染响应主体之前，Spring MVC 添加了一个 <code>Content-Disposition:inline;filename=f.txt</code> 头以建议一个固定且安全的下载文件。仅当 URL 路径包含的文件扩展名既不安全也不明确注册用于内容协商时，才会执行此操作。但是，当 URL 直接输入浏览器时，它可能会产生副作用。</p>
<p>默认情况下，允许许多常见的路径扩展是安全的。具有自定义 <code>HttpMessageConverter</code> 实现的应用程序可以显式注册文件扩展名以进行内容协商，以避免为这些扩展名添加 <code>Content-Disposition</code> 头。请参阅 <a target="_blank" rel="noopener" href="https://docs.spring.io/spring-framework/docs/current/reference/html/web.html#mvc-config-content-negotiation">内容类型</a>。</p>
<p>关于 RFD 更多细节推荐参考 <a target="_blank" rel="noopener" href="https://pivotal.io/security/cve-2015-5211">CVE-2015-5211</a></p>
<h4 id="限定数据类型"><a href="#限定数据类型" class="headerlink" title="限定数据类型"></a>限定数据类型</h4><p>您可以根据请求的 <code>Content-Type</code> 缩小请求映射，如以下示例所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(path = &quot;/pets&quot;, consumes = &quot;application/json&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addPet</span><span class="params">(<span class="meta">@RequestBody</span> Pet pet)</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>consumes</code> 属性还支持否定表达式 - 例如，<code>!textplain</code> 表示除 <code>textplain</code> 之外的任何内容类型。</p>
<p>您可以在类级别声明一个共享的 <code>consumes</code> 属性。然而，与大多数其他请求映射属性不同的是，当在类级别使用时，方法级别的 <code>consumes</code> 属性会覆盖而不是扩展类级别的声明。</p>
<h4 id="Producible-Media-Types"><a href="#Producible-Media-Types" class="headerlink" title="Producible Media Types"></a>Producible Media Types</h4><p>可以根据 <code>Accept</code> 请求头和控制器方法生成的内容类型列表来缩小请求映射，如以下示例所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(path = &quot;/pets/&#123;petId&#125;&quot;, produces = &quot;application/json&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> Pet <span class="title function_">getPet</span><span class="params">(<span class="meta">@PathVariable</span> String petId)</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>媒体类型可以指定一个字符集。支持否定表达式——例如，<code>!textplain</code> 表示除 “text&#x2F;plain” 之外的任何内容类型。</p>
<p>可以在类级别声明一个共享的 <code>produces</code> 属性。然而，与大多数其他请求映射属性不同，当在类级别使用时，方法级别的 <code>produces</code> 属性会覆盖而不是扩展类级别的声明。</p>
<h4 id="参数、请求头"><a href="#参数、请求头" class="headerlink" title="参数、请求头"></a>参数、请求头</h4><p>可以根据请求参数条件缩小请求映射范围。可以测试是否存在请求参数 (<code>myParam</code>)、是否缺少请求参数 (<code>!myParam</code>) 或特定值 (<code>myParam=myValue</code>)。以下示例显示如何测试特定值：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(path = &quot;/pets/&#123;petId&#125;&quot;, params = &quot;myParam=myValue&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">findPet</span><span class="params">(<span class="meta">@PathVariable</span> String petId)</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>还可以使用相同的请求头条件，如以下示例所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(path = &quot;/pets&quot;, headers = &quot;myHeader=myValue&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">findPet</span><span class="params">(<span class="meta">@PathVariable</span> String petId)</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="HTTP-HEAD-OPTIONS"><a href="#HTTP-HEAD-OPTIONS" class="headerlink" title="HTTP HEAD, OPTIONS"></a>HTTP HEAD, OPTIONS</h4><p><code>@GetMapping</code>（和 <code>@RequestMapping(method=HttpMethod.GET)</code>）透明地支持 HTTP HEAD 以进行请求映射。控制器方法不需要改变。在 <code>jakarta.servlet.http.HttpServlet</code> 中应用的响应包装器确保将 <code>Content-Length</code> 头设置为写入的字节数（实际上没有写入响应）。</p>
<p><code>@GetMapping</code>（和<code>@RequestMapping(method=HttpMethod.GET)</code>）被隐式映射并支持 HTTP HEAD。HTTP HEAD 请求的处理方式就好像它是 HTTP GET 一样，除了不写入正文，而是计算字节数并设置 <code>Content-Length</code> 头。</p>
<p>默认情况下，通过将 <code>Allow</code> 响应头设置为所有具有匹配 URL 模式的 <code>@RequestMapping</code> 方法中列出的 HTTP 方法列表来处理 HTTP OPTIONS。</p>
<p>对于没有 HTTP 方法声明的 <code>@RequestMapping</code> ，<code>Allow</code> 头设置为 <code>GET,HEAD,POST,PUT,PATCH,DELETE,OPTIONS</code>。控制器方法应始终声明支持的 HTTP 方法（例如，通过使用 HTTP 方法特定变体：<code>@GetMapping</code>、<code>@PostMapping</code> 等）。</p>
<p>You can explicitly map the <code>@RequestMapping</code> method to HTTP HEAD and HTTP OPTIONS, but that is not necessary in the common case.</p>
<p>可以显式地将 <code>@RequestMapping</code> 方法映射到 HTTP HEAD 和 HTTP OPTIONS，但在常见情况下这不是必需的。</p>
<h4 id="自定义注解"><a href="#自定义注解" class="headerlink" title="自定义注解"></a>自定义注解</h4><p>Spring MVC 支持使用<a target="_blank" rel="noopener" href="https://docs.spring.io/spring-framework/docs/current/reference/html/core.html#beans-meta-annotations">组合注解</a> 进行请求映射。这些注解本身是用 <code>@RequestMapping</code> 进行元注解的，并且组合起来重新声明 <code>@RequestMapping</code> 属性的一个子集（或全部），具有更明确的目的。</p>
<p><code>@GetMapping</code>、<code>@PostMapping</code>、<code>@PutMapping</code>、<code>@DeleteMapping</code> 和 <code>@PatchMapping</code> 是组合注解的示例。提供它们是因为，可以说，大多数控制器方法应该映射到特定的 HTTP 方法，而不是使用 <code>@RequestMapping</code>，默认情况下，它与所有 HTTP 方法匹配。如果您需要组合注解的示例，请查看这些注解的声明方式。</p>
<p>Spring MVC 还支持具有自定义请求匹配逻辑的自定义请求映射属性。这是一个更高级的选项，需要继承 <code>RequestMappingHandlerMapping</code> 并覆盖 <code>getCustomMethodCondition</code> 方法，您可以在其中检查自定义属性并返回您自己的 <code>RequestCondition</code>。</p>
<h4 id="显示注册"><a href="#显示注册" class="headerlink" title="显示注册"></a>显示注册</h4><p>您可以以编程方式注册处理程序方法，您可以将其用于动态注册或高级情况，例如不同 URL 下的同一处理程序的不同实例。以下示例注册了一个处理程序方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setHandlerMapping</span><span class="params">(RequestMappingHandlerMapping mapping, UserHandler handler)</span></span><br><span class="line">            <span class="keyword">throws</span> NoSuchMethodException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">RequestMappingInfo</span> <span class="variable">info</span> <span class="operator">=</span> RequestMappingInfo</span><br><span class="line">                .paths(<span class="string">&quot;/user/&#123;id&#125;&quot;</span>).methods(RequestMethod.GET).build();</span><br><span class="line"></span><br><span class="line">        <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> UserHandler.class.getMethod(<span class="string">&quot;getUser&quot;</span>, Long.class);</span><br><span class="line"></span><br><span class="line">        mapping.registerMapping(info, handler, method);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li><p>为控制器注入目标处理程序和处理程序映射。</p>
</li>
<li><p>准备请求映射元数据。</p>
</li>
<li><p>获取处理程序方法。</p>
</li>
<li><p>添加注册。</p>
</li>
</ol>
<h2 id="处理方法"><a href="#处理方法" class="headerlink" title="处理方法"></a>处理方法</h2><h3 id="请求数据"><a href="#请求数据" class="headerlink" title="请求数据"></a>请求数据</h3><ul>
<li><p><code>@RequestParam</code></p>
</li>
<li><p><code>@RequestBody</code></p>
</li>
<li><p><code>@PathVariable</code></p>
</li>
<li><p><code>@RequestHeader</code></p>
</li>
</ul>
<blockquote>
<p>更多 Spring Web 方法参数可以参考： <a target="_blank" rel="noopener" href="https://docs.spring.io/spring-framework/docs/current/reference/html/web.html#mvc-ann-arguments">Method Arguments</a></p>
</blockquote>
<h3 id="响应数据"><a href="#响应数据" class="headerlink" title="响应数据"></a>响应数据</h3><ul>
<li><p><code>@ResponseBody</code></p>
</li>
<li><p><code>@ResponseStatus</code></p>
</li>
<li><p>ResponseEntity</p>
</li>
<li><p>HttpEntity</p>
</li>
</ul>
<blockquote>
<p>更多 Spring Web 方法返回值可以参考：<a target="_blank" rel="noopener" href="https://docs.spring.io/spring-framework/docs/current/reference/html/web.html#mvc-ann-return-types">Return Values</a></p>
</blockquote>
<h2 id="ModelAttribute"><a href="#ModelAttribute" class="headerlink" title="@ModelAttribute"></a>@ModelAttribute</h2><p>可以使用 <code>@ModelAttribute</code> 注解：</p>
<ul>
<li>在 <code>@RequestMapping</code> 方法中的方法参数上，用于模型创建或访问对象，并通过 <code>WebDataBinder</code> 将其绑定到请求。</li>
<li>作为 <code>@Controller</code> 或 <code>@ControllerAdvice</code> 类中的方法级注解，有助于在任何 <code>@RequestMapping</code> 方法调用之前初始化模型。</li>
<li>在 <code>@RequestMapping</code> 方法上标记它的返回值是一个模型属性。</li>
</ul>
<p>本节讨论 <code>@ModelAttribute</code> 方法——前面列表中的第二项。一个控制器可以有任意数量的 <code>@ModelAttribute</code> 方法。所有这些方法都在同一控制器中的 <code>@RequestMapping</code> 方法之前被调用。<code>@ModelAttribute</code> 方法也可以通过 <code>@ControllerAdvice</code> 在控制器之间共享。</p>
<p><code>@ModelAttribute</code> 方法具有灵活的方法签名。它们支持许多与 <code>@RequestMapping</code> 方法相同的参数，除了 <code>@ModelAttribute</code> 本身或与请求主体相关的任何内容。</p>
<p>以下示例显示了 <code>@ModelAttribute</code> 方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ModelAttribute</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">populateModel</span><span class="params">(<span class="meta">@RequestParam</span> String number, Model model)</span> &#123;</span><br><span class="line">    model.addAttribute(accountRepository.findAccount(number));</span><br><span class="line">    <span class="comment">// add more ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以下示例仅添加一个属性：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ModelAttribute</span></span><br><span class="line"><span class="keyword">public</span> Account <span class="title function_">addAccount</span><span class="params">(<span class="meta">@RequestParam</span> String number)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> accountRepository.findAccount(number);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>还可以将 <code>@ModelAttribute</code> 用作 <code>@RequestMapping</code> 方法上的方法级注解，在这种情况下，<code>@RequestMapping</code> 方法的返回值被解释为模型属性。这通常不是必需的，因为它是 HTML 控制器中的默认行为，除非返回值是一个 String 否则将被解释为视图名称。 <code>@ModelAttribute</code> 还可以自定义模型属性名称，如下例所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/accounts/&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="meta">@ModelAttribute(&quot;myAccount&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Account <span class="title function_">handle</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">return</span> account;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="InitBinder"><a href="#InitBinder" class="headerlink" title="@InitBinder"></a>@InitBinder</h2><p><code>@Controller</code> 或 <code>@ControllerAdvice</code> 类可以用 <code>@InitBinder</code> 方法来初始化 <code>WebDataBinder</code> 的实例，而这些方法又可以：</p>
<ul>
<li>将请求参数（即表单或查询数据）绑定到模型对象。</li>
<li>将基于字符串的请求值（例如请求参数、路径变量、标头、cookie 等）转换为控制器方法参数的目标类型。</li>
<li>在渲染 HTML 表单时将模型对象值格式化为 <code>String</code> 值。</li>
</ul>
<p><code>@InitBinder</code> 方法可以注册指定控制器 <code>java.beans.PropertyEditor</code> 或 Spring <code>Converter</code> 和 <code>Formatter</code> 组件。此外，您可以使用 <a target="_blank" rel="noopener" href="https://docs.spring.io/spring-framework/docs/current/reference/html/web.html#mvc-config-conversion">MVC 配置</a> 在全局共享的 <code>FormattingConversionService</code> 中注册 <code>Converter</code> 和 <code>Formatter</code> 类型。</p>
<p><code>@InitBinder</code> 方法支持许多与 <code>@RequestMapping</code> 方法相同的参数，除了 <code>@ModelAttribute</code>（命令对象）参数。通常，它们使用 <code>WebDataBinder</code> 参数（用于注册）和 <code>void</code> 返回值声明。下面展示了一个示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FormController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@InitBinder</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">initBinder</span><span class="params">(WebDataBinder binder)</span> &#123;</span><br><span class="line">        <span class="type">SimpleDateFormat</span> <span class="variable">dateFormat</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(<span class="string">&quot;yyyy-MM-dd&quot;</span>);</span><br><span class="line">        dateFormat.setLenient(<span class="literal">false</span>);</span><br><span class="line">        binder.registerCustomEditor(Date.class, <span class="keyword">new</span> <span class="title class_">CustomDateEditor</span>(dateFormat, <span class="literal">false</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>或者，当您通过共享的 <code>FormattingConversionService</code> 使用基于 <code>Formatter</code> 的设置时，您可以重复使用相同的方法并注册指定控制器的 <code>Formatter</code> 实现，如以下示例所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FormController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@InitBinder</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initBinder</span><span class="params">(WebDataBinder binder)</span> &#123;</span><br><span class="line">        binder.addCustomFormatter(<span class="keyword">new</span> <span class="title class_">DateFormatter</span>(<span class="string">&quot;yyyy-MM-dd&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 Web 应用程序的上下文中，<em>数据绑定</em>涉及将 HTTP 请求参数（即表单数据或查询参数）绑定到模型对象及其嵌套对象中的属性。</p>
<p>仅公开遵循 <a target="_blank" rel="noopener" href="https://www.oracle.com/java/technologies/javase/javabeans-spec.html">JavaBeans 命名约定</a> 的 <code>public</code> 属性用于数据绑定——例如，<code>firstName</code> 属性的 get&#x2F;set 方法：<code>public String getFirstName()</code> 和 <code>public void setFirstName(String)</code>。</p>
<p>默认情况下，Spring 允许绑定到模型对象图中的所有公共属性。这意味着您需要仔细考虑模型具有哪些公共属性，因为客户端可以将任何公共属性路径作为目标，甚至是一些预计不会针对给定用例的公共属性路径。</p>
<p>例如，给定一个 HTTP 表单数据端点，恶意客户端可以为存在于模型对象图中但不属于浏览器中显示的 HTML 表单的属性提供值。这可能导致在模型对象及其任何嵌套对象上设置数据，这些数据预计不会更新。</p>
<p>荐的方法是使用一个<em>专用模型对象</em>，它只公开与表单提交相关的属性。例如，在用于更改用户电子邮件地址的表单上，模型对象应声明最少的一组属性，例如以下 <code>ChangeEmailForm</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ChangeEmailForm</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String oldEmailAddress;</span><br><span class="line">    <span class="keyword">private</span> String newEmailAddress;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setOldEmailAddress</span><span class="params">(String oldEmailAddress)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.oldEmailAddress = oldEmailAddress;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getOldEmailAddress</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.oldEmailAddress;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setNewEmailAddress</span><span class="params">(String newEmailAddress)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.newEmailAddress = newEmailAddress;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getNewEmailAddress</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.newEmailAddress;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果您不能或不想为每个数据绑定用例使用<em>专用模型对象</em>，则必须限制允许用于数据绑定的属性。理想情况下，可以通过 <code>WebDataBinder</code> 上的 <code>setAllowedFields()</code> 方法注册<em>允许的字段模式</em> 来实现这一点。</p>
<p>例如，要在您的应用程序中注册允许的字段模式，您可以在 <code>@Controller</code> 或 <code>@ControllerAdvice</code> 组件中实现 <code>@InitBinder</code> 方法，如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ChangeEmailController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@InitBinder</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">initBinder</span><span class="params">(WebDataBinder binder)</span> &#123;</span><br><span class="line">        binder.setAllowedFields(<span class="string">&quot;oldEmailAddress&quot;</span>, <span class="string">&quot;newEmailAddress&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// @RequestMapping methods, etc.</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>除了注册允许的模式外，还可以通过 <code>DataBinder</code>及其子类中的 <code>setDisallowedFields()</code> 方法注册 _允许的字段模式_。但是请注意，“允许列表”比“拒绝列表”更安全。因此，<code>setAllowedFields()</code> 应该优于 <code>setDisallowedFields()</code>。</p>
<p>请注意，匹配允许的字段模式是区分大小写的；然而，与不允许的字段模式匹配是不区分大小写的。此外，匹配不允许的模式的字段将不会被接受，即使它也恰好匹配允许列表中的模式。</p>
<h2 id="表单处理"><a href="#表单处理" class="headerlink" title="表单处理"></a>表单处理</h2><h3 id="创建处理表单的-Controller"><a href="#创建处理表单的-Controller" class="headerlink" title="创建处理表单的 Controller"></a>创建处理表单的 Controller</h3><p><code>GreetingController</code> 通过返回视图的名称处理 <code>/greeting</code> 的 GET 请求，这意味着返回的内容是名为 <code>greeting.html</code> 的视图内容。</p>
<p><code>greetingForm()</code> 方法是通过使用 <code>@GetMapping</code> 专门映射到 GET 请求的，而 <code>greetingSubmit()</code> 是通过 <code>@PostMapping</code> 映射到 POST  请求的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ui.Model;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ModelAttribute;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GreetingController</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@GetMapping(&quot;/greeting&quot;)</span></span><br><span class="line">  <span class="keyword">public</span> String <span class="title function_">greetingForm</span><span class="params">(Model model)</span> &#123;</span><br><span class="line">    model.addAttribute(<span class="string">&quot;greeting&quot;</span>, <span class="keyword">new</span> <span class="title class_">Greeting</span>());</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;greeting&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@PostMapping(&quot;/greeting&quot;)</span></span><br><span class="line">  <span class="keyword">public</span> String <span class="title function_">greetingSubmit</span><span class="params">(<span class="meta">@ModelAttribute</span> Greeting greeting, Model model)</span> &#123;</span><br><span class="line">    model.addAttribute(<span class="string">&quot;greeting&quot;</span>, greeting);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;result&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="定义需要提交的表单实体"><a href="#定义需要提交的表单实体" class="headerlink" title="定义需要提交的表单实体"></a>定义需要提交的表单实体</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Greeting</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> id;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String content;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="提交表单前端代码"><a href="#提交表单前端代码" class="headerlink" title="提交表单前端代码"></a>提交表单前端代码</h3><p>提交实体的页面必须依赖某种视图技术，通过将视图名称转换为模板进行渲染，从而对HTML进行服务端渲染。在下面的例子中，使用了 Thymeleaf 模板引擎作为视图，它解析 <code>greeting.html</code> 的各种模板表达式以渲染表单。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">xmlns:th</span>=<span class="string">&quot;https://www.thymeleaf.org&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Getting Started: Handling Form Submission<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;Content-Type&quot;</span> <span class="attr">content</span>=<span class="string">&quot;text/html; charset=UTF-8&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>Form<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;#&quot;</span> <span class="attr">th:action</span>=<span class="string">&quot;@&#123;/greeting&#125;&quot;</span> <span class="attr">th:object</span>=<span class="string">&quot;$&#123;greeting&#125;&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">p</span>&gt;</span>Id: <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">th:field</span>=<span class="string">&quot;*&#123;id&#125;&quot;</span> /&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">p</span>&gt;</span>Message: <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">th:field</span>=<span class="string">&quot;*&#123;content&#125;&quot;</span> /&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Submit&quot;</span> /&gt;</span> <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;reset&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Reset&quot;</span> /&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="文件上传"><a href="#文件上传" class="headerlink" title="文件上传"></a>文件上传</h2><h3 id="创建文件上传处理-Controller"><a href="#创建文件上传处理-Controller" class="headerlink" title="创建文件上传处理 Controller"></a>创建文件上传处理 Controller</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.stream.Collectors;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.io.Resource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpHeaders;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.ResponseEntity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ui.Model;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ExceptionHandler;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PathVariable;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.multipart.MultipartFile;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.mvc.method.annotation.MvcUriComponentsBuilder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.mvc.support.RedirectAttributes;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.uploadingfiles.storage.StorageFileNotFoundException;</span><br><span class="line"><span class="keyword">import</span> com.example.uploadingfiles.storage.StorageService;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileUploadController</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> StorageService storageService;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_">FileUploadController</span><span class="params">(StorageService storageService)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.storageService = storageService;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@GetMapping(&quot;/&quot;)</span></span><br><span class="line">	<span class="keyword">public</span> String <span class="title function_">listUploadedFiles</span><span class="params">(Model model)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line"></span><br><span class="line">		model.addAttribute(<span class="string">&quot;files&quot;</span>, storageService.loadAll().map(</span><br><span class="line">				path -&gt; MvcUriComponentsBuilder.fromMethodName(FileUploadController.class,</span><br><span class="line">						<span class="string">&quot;serveFile&quot;</span>, path.getFileName().toString()).build().toUri().toString())</span><br><span class="line">				.collect(Collectors.toList()));</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;uploadForm&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@GetMapping(&quot;/files/&#123;filename:.+&#125;&quot;)</span></span><br><span class="line">	<span class="meta">@ResponseBody</span></span><br><span class="line">	<span class="keyword">public</span> ResponseEntity&lt;Resource&gt; <span class="title function_">serveFile</span><span class="params">(<span class="meta">@PathVariable</span> String filename)</span> &#123;</span><br><span class="line"></span><br><span class="line">		<span class="type">Resource</span> <span class="variable">file</span> <span class="operator">=</span> storageService.loadAsResource(filename);</span><br><span class="line">		<span class="keyword">return</span> ResponseEntity.ok().header(HttpHeaders.CONTENT_DISPOSITION,</span><br><span class="line">				<span class="string">&quot;attachment; filename=\&quot;&quot;</span> + file.getFilename() + <span class="string">&quot;\&quot;&quot;</span>).body(file);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@PostMapping(&quot;/&quot;)</span></span><br><span class="line">	<span class="keyword">public</span> String <span class="title function_">handleFileUpload</span><span class="params">(<span class="meta">@RequestParam(&quot;file&quot;)</span> MultipartFile file,</span></span><br><span class="line"><span class="params">			RedirectAttributes redirectAttributes)</span> &#123;</span><br><span class="line"></span><br><span class="line">		storageService.store(file);</span><br><span class="line">		redirectAttributes.addFlashAttribute(<span class="string">&quot;message&quot;</span>,</span><br><span class="line">				<span class="string">&quot;You successfully uploaded &quot;</span> + file.getOriginalFilename() + <span class="string">&quot;!&quot;</span>);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;redirect:/&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@ExceptionHandler(StorageFileNotFoundException.class)</span></span><br><span class="line">	<span class="keyword">public</span> ResponseEntity&lt;?&gt; handleStorageFileNotFound(StorageFileNotFoundException exc) &#123;</span><br><span class="line">		<span class="keyword">return</span> ResponseEntity.notFound().build();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>FileUploadController</code> 类使用 <code>@Controller</code> 注解，以便 Spring 可以扫描并注册它。 每个方法都标有 <code>@GetMapping</code> 或 <code>@PostMapping</code> ，将路径和 HTTP 操作映射到指定的控制器。</p>
<p>在这种情况下：</p>
<ul>
<li><p>GET <code>/</code>：从 <code>StorageService</code> 中查找当前上传文件的列表，并将其加载到 Thymeleaf 模板中。 它使用 <code>MvcUriComponentsBuilder</code> 计算指向实际资源的链接。</p>
</li>
<li><p>GET <code>/files/&#123;filename&#125;</code>：加载资源（如果存在）并使用 Content-Disposition 响应标头将其发送到浏览器进行下载。</p>
</li>
<li><p>POST <code>/</code>：处理一个多部分的消息文件，并将其交给 <code>StorageService</code> 进行保存。</p>
</li>
</ul>
<h3 id="定义存储文件的-Service"><a href="#定义存储文件的-Service" class="headerlink" title="定义存储文件的 Service"></a>定义存储文件的 Service</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.core.io.Resource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.multipart.MultipartFile;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.nio.file.Path;</span><br><span class="line"><span class="keyword">import</span> java.util.stream.Stream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">StorageService</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">void</span> <span class="title function_">store</span><span class="params">(MultipartFile file)</span>;</span><br><span class="line"></span><br><span class="line">	Stream&lt;Path&gt; <span class="title function_">loadAll</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">	Path <span class="title function_">load</span><span class="params">(String filename)</span>;</span><br><span class="line"></span><br><span class="line">	Resource <span class="title function_">loadAsResource</span><span class="params">(String filename)</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">void</span> <span class="title function_">deleteAll</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>一个加单的 <code>StorageService</code> 实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.io.Resource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.io.UrlResource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.FileSystemUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.StringUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.multipart.MultipartFile;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.net.MalformedURLException;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Path;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.StandardCopyOption;</span><br><span class="line"><span class="keyword">import</span> java.util.stream.Stream;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileSystemStorageServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">StorageService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Path rootLocation;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">FileSystemStorageServiceImpl</span><span class="params">(StorageProperties properties)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.rootLocation = Paths.get(properties.getLocation());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deleteAll</span><span class="params">()</span> &#123;</span><br><span class="line">        FileSystemUtils.deleteRecursively(rootLocation.toFile());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Files.createDirectories(rootLocation);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">StorageException</span>(<span class="string">&quot;Could not initialize storage&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Path <span class="title function_">load</span><span class="params">(String filename)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> rootLocation.resolve(filename);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Stream&lt;Path&gt; <span class="title function_">loadAll</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> Files.walk(<span class="built_in">this</span>.rootLocation, <span class="number">1</span>).filter(path -&gt; !path.equals(<span class="built_in">this</span>.rootLocation))</span><br><span class="line">                .map(<span class="built_in">this</span>.rootLocation::relativize);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">StorageException</span>(<span class="string">&quot;Failed to read stored files&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Resource <span class="title function_">loadAsResource</span><span class="params">(String filename)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Path</span> <span class="variable">file</span> <span class="operator">=</span> load(filename);</span><br><span class="line">            <span class="type">Resource</span> <span class="variable">resource</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UrlResource</span>(file.toUri());</span><br><span class="line">            <span class="keyword">if</span> (resource.exists() || resource.isReadable()) &#123;</span><br><span class="line">                <span class="keyword">return</span> resource;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">StorageFileNotFoundException</span>(<span class="string">&quot;Could not read file: &quot;</span> + filename);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (MalformedURLException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">StorageFileNotFoundException</span>(<span class="string">&quot;Could not read file: &quot;</span> + filename, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">store</span><span class="params">(MultipartFile file)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">filename</span> <span class="operator">=</span> StringUtils.cleanPath(file.getOriginalFilename());</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (file.isEmpty()) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">StorageException</span>(<span class="string">&quot;Failed to store empty file &quot;</span> + filename);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (filename.contains(<span class="string">&quot;..&quot;</span>)) &#123;</span><br><span class="line">                <span class="comment">// This is a security check</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">StorageException</span>(</span><br><span class="line">                    <span class="string">&quot;Cannot store file with relative path outside current directory &quot;</span> + filename);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> (<span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> file.getInputStream()) &#123;</span><br><span class="line">                Files.copy(inputStream, <span class="built_in">this</span>.rootLocation.resolve(filename), StandardCopyOption.REPLACE_EXISTING);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">StorageException</span>(<span class="string">&quot;Failed to store file &quot;</span> + filename, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="创建文件上传表单"><a href="#创建文件上传表单" class="headerlink" title="创建文件上传表单"></a>创建文件上传表单</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">xmlns:th</span>=<span class="string">&quot;https://www.thymeleaf.org&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">div</span> <span class="attr">th:if</span>=<span class="string">&quot;$&#123;message&#125;&quot;</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">h2</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;message&#125;&quot;</span>/&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">&quot;POST&quot;</span> <span class="attr">enctype</span>=<span class="string">&quot;multipart/form-data&quot;</span> <span class="attr">action</span>=<span class="string">&quot;/&quot;</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">table</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">tr</span>&gt;</span><span class="tag">&lt;<span class="name">td</span>&gt;</span>File to upload:<span class="tag">&lt;/<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">name</span>=<span class="string">&quot;file&quot;</span> /&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span><span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">tr</span>&gt;</span><span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Upload&quot;</span> /&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span><span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">li</span> <span class="attr">th:each</span>=<span class="string">&quot;file : $&#123;files&#125;&quot;</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">a</span> <span class="attr">th:href</span>=<span class="string">&quot;$&#123;file&#125;&quot;</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;file&#125;&quot;</span> /&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="文件上传限制"><a href="#文件上传限制" class="headerlink" title="文件上传限制"></a>文件上传限制</h3><p>如果使用 Spring Boot，可以使用一些属性设置来调整其自动配置的 <code>MultipartConfigElement</code>。</p>
<p>将以下属性添加到现有属性设置中（在 <code>src/main/resources/application.properties</code> 中）：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring.servlet.multipart.max-file-size</span>=<span class="string">128KB</span></span><br><span class="line"><span class="attr">spring.servlet.multipart.max-request-size</span>=<span class="string">128KB</span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>spring.servlet.multipart.max-file-size</code> 设置为 128KB，表示总文件大小不能超过 128KB。</li>
<li><code>spring.servlet.multipart.max-request-size</code> 设置为 128KB，这意味着 <code>multipart/form-data</code> 的总请求大小不能超过 128KB。</li>
</ul>
<h2 id="异常处理"><a href="#异常处理" class="headerlink" title="异常处理"></a>异常处理</h2><h3 id="ExceptionHandler"><a href="#ExceptionHandler" class="headerlink" title="@ExceptionHandler"></a>@ExceptionHandler</h3><p><code>@Controller</code> 和 <a target="_blank" rel="noopener" href="https://docs.spring.io/spring-framework/docs/current/reference/html/web.html#mvc-ann-controller-advice">@ControllerAdvice</a> 类可以用 <code>@ExceptionHandler</code> 方法来处理来自控制器方法的异常，如以下示例所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SimpleController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@ExceptionHandler</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;String&gt; <span class="title function_">handle</span><span class="params">(IOException ex)</span> &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>异常可能与正在传播的顶级异常（例如，抛出直接的 <code>IOException</code>）或包装器异常中的嵌套原因（例如，包装在 <code>IllegalStateException</code> 中的 <code>IOException</code>）相匹配。从 5.3 开始，这可以匹配任意原因级别，而以前只考虑直接原因。</p>
<p>对于匹配的异常类型，最好将目标异常声明为方法参数，如前面的示例所示。当多个异常方法匹配时，根异常匹配通常优先于原因异常匹配。更具体地说，<code>ExceptionDepthComparator</code> 用于根据抛出的异常类型的深度对异常进行排序。</p>
<p>或者，注解声明可以缩小要匹配的异常类型，如以下示例所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ExceptionHandler(&#123;FileSystemException.class, RemoteException.class&#125;)</span></span><br><span class="line"><span class="keyword">public</span> ResponseEntity&lt;String&gt; <span class="title function_">handle</span><span class="params">(IOException ex)</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>您甚至可以使用具有非常通用的参数签名的特定异常类型列表，如以下示例所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ExceptionHandler(&#123;FileSystemException.class, RemoteException.class&#125;)</span></span><br><span class="line"><span class="keyword">public</span> ResponseEntity&lt;String&gt; <span class="title function_">handle</span><span class="params">(Exception ex)</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通常建议您在参数签名中尽可能具体，以减少根本和原因异常类型之间不匹配的可能性。考虑将一个多重匹配方法分解为单独的 <code>@ExceptionHandler</code> 方法，每个方法通过其签名匹配一个特定的异常类型。</p>
<p>在多 <code>@ControllerAdvice</code> 安排中，建议在具有相应顺序优先级的 <code>@ControllerAdvice</code> 上声明您的主要根异常映射。虽然根异常匹配优于原因，但这是在给定控制器或 <code>@ControllerAdvice</code> 类的方法中定义的。这意味着优先级较高的 <code>@ControllerAdvice</code> 上的原因匹配优于优先级较低的 <code>@ControllerAdvice</code> 上的任何匹配（例如，root）。</p>
<p>最后但同样重要的是， <code>@ExceptionHandler</code> 方法实现可以选择通过以原始形式重新抛出给定异常实例来退出处理。这在您只对根级匹配或无法静态确定的特定上下文中的匹配感兴趣的情况下很有用。重新抛出的异常通过剩余的解析链传播，就好像给定的 <code>@ExceptionHandler</code> 方法一开始就不会匹配一样。</p>
<p>Spring MVC 中对 <code>@ExceptionHandler</code> 方法的支持建立在 <code>DispatcherServlet</code> 级别 <a target="_blank" rel="noopener" href="https://docs.spring.io/spring-framework/docs/current/reference/html/web.html#mvc-exceptionhandlers">HandlerExceptionResolver</a> 机制上。</p>
<blockquote>
<p>附录：</p>
<p><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-framework/docs/current/reference/html/web.html#mvc-ann-exceptionhandler-args"><code>@ExceptionHandler</code> 支持的参数</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-framework/docs/current/reference/html/web.html#mvc-ann-exceptionhandler-return-values"><code>@ExceptionHandler</code> 支持返回值</a></p>
</blockquote>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-framework/docs/current/spring-framework-reference/index.html">Spring Framework 官方文档</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-framework/docs/current/reference/html/web.html">Spring Framework 官方文档之 Web</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="上一页" aria-label="上一页" href="/blog/page/8/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/blog/">1</a><span class="space">&hellip;</span><a class="page-number" href="/blog/page/8/">8</a><span class="page-number current">9</span><a class="page-number" href="/blog/page/10/">10</a><span class="space">&hellip;</span><a class="page-number" href="/blog/page/51/">51</a><a class="extend next" rel="next" title="下一页" aria-label="下一页" href="/blog/page/10/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 2015 – 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">钝悟 ◾ Dunwu</span>
  </div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
      <span>站点总字数：</span>
    <span title="站点总字数">4.5m</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span>站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">68:08</span>
  </span>
</div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="reading-progress-bar"></div>

  <a href="https://github.com/dunwu/blog" class="github-corner" title="在 GitHub 上关注我" aria-label="在 GitHub 上关注我" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>
<script src="https://cdn.jsdelivr.net/npm/darkmode-js@1.5.7/lib/darkmode-js.min.js"></script>

<script>
var options = {
  bottom: '64px',
  right: 'unset',
  left: '32px',
  time: '0.5s',
  mixColor: 'transparent',
  backgroundColor: 'transparent',
  buttonColorDark: '#100f2c',
  buttonColorLight: '#fff',
  saveInCookies: true,
  label: '🌓',
  autoMatchOsTheme: true
}
const darkmode = new Darkmode(options);
window.darkmode = darkmode;
darkmode.showWidget();
</script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1.8.0/dist/gitalk.css" integrity="sha256-AJnUHL7dBv6PGaeyPQJcgQPDjt/Hn/PvYZde1iqfp8U=" crossorigin="anonymous">

<script class="next-config" data-name="gitalk" type="application/json">{"enable":true,"github_id":"dunwu","repo":"blog","client_id":"c45bc13ca1d3d3aa4836","client_secret":"1907a9f0c22087badad3938e1d7dcba9078f88ac","admin_user":"dunwu","distraction_free_mode":true,"proxy":"https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token","language":"zh-CN","js":{"url":"https://cdn.jsdelivr.net/npm/gitalk@1.8.0/dist/gitalk.min.js","integrity":"sha256-MVK9MGD/XJaGyIghSVrONSnoXoGh3IFxLw0zfvzpxR4="},"path_md5":"5b739edd025c000fc1e7f835933a0e7d"}</script>
<script src="/blog/js/third-party/comments/gitalk.js" defer></script>

</body>
</html>

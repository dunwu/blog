<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/blog/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/blog/uploads/favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/blog/uploads/favicon.ico">
  <link rel="mask-icon" href="/blog/images/logo.svg" color="#222">

<link rel="stylesheet" href="/blog/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@7.0.0/css/all.min.css" integrity="sha256-VHqXKFhhMxcpubYf9xiWdCiojEbY9NexQ4jh8AxbvcM=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/themes/blue/pace-theme-minimal.css">
  <script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous" defer></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"dunwu.github.io","root":"/blog/","images":"/blog/images","scheme":"Pisces","darkmode":true,"version":"8.25.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"codeblock":{"theme":{"light":"atom-one-light","dark":"atom-one-dark"},"prism":{"light":"atom-one-light","dark":"atom-one-dark"},"copy_button":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"language":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"gitalk","storage":true,"lazyload":true,"nav":null,"activeClass":"gitalk"},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"æœç´¢...","empty":"æ²¡æœ‰æ‰¾åˆ°ä»»ä½•æœç´¢ç»“æœï¼š${query}","hits_time":"æ‰¾åˆ° ${hits} ä¸ªæœç´¢ç»“æœï¼ˆç”¨æ—¶ ${time} æ¯«ç§’ï¼‰","hits":"æ‰¾åˆ° ${hits} ä¸ªæœç´¢ç»“æœ"},"path":"/blog/search.xml","localsearch":{"enable":true,"top_n_per_article":1,"unescape":false,"preload":false,"trigger":"auto"}}</script><script src="/blog/js/config.js" defer></script>

    <meta name="description" content="é’æ‚Ÿçš„ä¸ªäººåšå®¢">
<meta property="og:type" content="website">
<meta property="og:title" content="Dunwu Blog">
<meta property="og:url" content="https://dunwu.github.io/blog/page/36/index.html">
<meta property="og:site_name" content="Dunwu Blog">
<meta property="og:description" content="é’æ‚Ÿçš„ä¸ªäººåšå®¢">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="é’æ‚Ÿ â—¾ Dunwu">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://dunwu.github.io/blog/page/36/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"page/36/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Dunwu Blog</title>
  








  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
<script src="/blog/js/utils.js" defer></script><script src="/blog/js/motion.js" defer></script><script src="/blog/js/sidebar.js" defer></script><script src="/blog/js/next-boot.js" defer></script>

  <script src="https://cdn.jsdelivr.net/npm/hexo-generator-searchdb@1.5.0/dist/search.js" integrity="sha256-xFC6PJ82SL9b3WkGjFavNiA9gm5z6UBxWPiu4CYjptg=" crossorigin="anonymous" defer></script>
<script src="/blog/js/third-party/search/local-search.js" defer></script>





  <script src="/blog/js/third-party/pace.js" defer></script>


  





  <noscript>
    <link rel="stylesheet" href="/blog/css/noscript.css">
  </noscript>
<style>.darkmode--activated{--body-bg-color:#282828;--content-bg-color:#333;--card-bg-color:#555;--text-color:#ccc;--blockquote-color:#bbb;--link-color:#ccc;--link-hover-color:#eee;--brand-color:#ddd;--brand-hover-color:#ddd;--table-row-odd-bg-color:#282828;--table-row-hover-bg-color:#363636;--menu-item-bg-color:#555;--btn-default-bg:#222;--btn-default-color:#ccc;--btn-default-border-color:#555;--btn-default-hover-bg:#666;--btn-default-hover-color:#ccc;--btn-default-hover-border-color:#666;--highlight-background:#282b2e;--highlight-foreground:#a9b7c6;--highlight-gutter-background:#34393d;--highlight-gutter-foreground:#9ca9b6}.darkmode--activated img{opacity:.75}.darkmode--activated img:hover{opacity:.9}.darkmode--activated code{color:#69dbdc;background:0 0}button.darkmode-toggle{z-index:9999}.darkmode-ignore,img{display:flex!important}.beian img{display:inline-block!important}</style></head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ " role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/blog/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Dunwu Blog</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">å¤§é“è‡³ç®€ï¼ŒçŸ¥æ˜“è¡Œéš¾</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="æœç´¢" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/blog/" rel="section"><i class="fa fa-home fa-fw"></i>é¦–é¡µ</a></li><li class="menu-item menu-item-about"><a href="/blog/about/" rel="section"><i class="fa fa-user fa-fw"></i>å…³äº</a></li><li class="menu-item menu-item-tags"><a href="/blog/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>æ ‡ç­¾<span class="badge">428</span></a></li><li class="menu-item menu-item-categories"><a href="/blog/categories/" rel="section"><i class="fa fa-th fa-fw"></i>åˆ†ç±»<span class="badge">124</span></a></li><li class="menu-item menu-item-archives"><a href="/blog/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>å½’æ¡£<span class="badge">508</span></a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>æœç´¢
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
      <div class="search-header">
        <span class="search-icon">
          <i class="fa fa-search"></i>
        </span>
        <div class="search-input-container">
          <input autocomplete="off" autocapitalize="off" maxlength="80"
                placeholder="æœç´¢..." spellcheck="false"
                type="search" class="search-input">
        </div>
        <span class="popup-btn-close" role="button">
          <i class="fa fa-times-circle"></i>
        </span>
      </div>
      <div class="search-result-container">
        <div class="search-result-icon">
          <i class="fa fa-spinner fa-pulse fa-5x"></i>
        </div>
      </div>
    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="é’æ‚Ÿ â—¾ Dunwu"
      src="/blog/uploads/avatar.gif">
  <p class="site-author-name" itemprop="name">é’æ‚Ÿ â—¾ Dunwu</p>
  <div class="site-description" itemprop="description">é’æ‚Ÿçš„ä¸ªäººåšå®¢</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/blog/archives/">
          <span class="site-state-item-count">508</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/blog/categories/">
        <span class="site-state-item-count">124</span>
        <span class="site-state-item-name">åˆ†ç±»</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/blog/tags/">
        <span class="site-state-item-count">428</span>
        <span class="site-state-item-name">æ ‡ç­¾</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/dunwu" title="GitHub â†’ https:&#x2F;&#x2F;github.com&#x2F;dunwu" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:forbreak@163.com" title="E-Mail â†’ mailto:forbreak@163.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>
  <div class="cc-license animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" class="cc-opacity" rel="noopener" target="_blank"><img src="https://cdn.jsdelivr.net/npm/@creativecommons/vocabulary@2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a>
  </div>

        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="è¿”å›é¡¶éƒ¨">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://dunwu.github.io/blog/pages/e524b647/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/uploads/avatar.gif">
      <meta itemprop="name" content="é’æ‚Ÿ â—¾ Dunwu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dunwu Blog">
      <meta itemprop="description" content="é’æ‚Ÿçš„ä¸ªäººåšå®¢">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Dunwu Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/pages/e524b647/" class="post-title-link" itemprop="url">Redis è„šæœ¬</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2020-01-30 21:48:57" itemprop="dateCreated datePublished" datetime="2020-01-30T21:48:57+08:00">2020-01-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">æ›´æ–°äº</span>
      <time title="ä¿®æ”¹æ—¶é—´ï¼š2025-09-13 17:56:53" itemprop="dateModified" datetime="2025-09-13T17:56:53+08:00">2025-09-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/" itemprop="url" rel="index"><span itemprop="name">æ•°æ®åº“</span></a>
        </span>
          ï¼Œ
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/KV%E6%95%B0%E6%8D%AE%E5%BA%93/" itemprop="url" rel="index"><span itemprop="name">KVæ•°æ®åº“</span></a>
        </span>
          ï¼Œ
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/KV%E6%95%B0%E6%8D%AE%E5%BA%93/redis/" itemprop="url" rel="index"><span itemprop="name">redis</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
      <span>1.7k</span>
    </span>
    <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
      <span>2 åˆ†é’Ÿ</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Redis-è„šæœ¬"><a href="#Redis-è„šæœ¬" class="headerlink" title="Redis è„šæœ¬"></a>Redis è„šæœ¬</h1><blockquote>
<p>Redis è„šæœ¬ä½¿ç”¨ Lua è§£é‡Šå™¨æ¥æ‰§è¡Œè„šæœ¬ã€‚ Redis 2.6 ç‰ˆæœ¬é€šè¿‡å†…åµŒæ”¯æŒ Lua ç¯å¢ƒã€‚</p>
<p>å…³é”®è¯ï¼š<code>Lua</code></p>
</blockquote>
<h2 id="ä¸ºä»€ä¹ˆä½¿ç”¨-Lua"><a href="#ä¸ºä»€ä¹ˆä½¿ç”¨-Lua" class="headerlink" title="ä¸ºä»€ä¹ˆä½¿ç”¨ Lua"></a>ä¸ºä»€ä¹ˆä½¿ç”¨ Lua</h2><p>Lua æ˜¯ä¸€ç§è½»é‡å°å·§çš„è„šæœ¬è¯­è¨€ï¼Œç”¨æ ‡å‡† C è¯­è¨€ç¼–å†™å¹¶ä»¥æºä»£ç å½¢å¼å¼€æ”¾ï¼Œ å…¶è®¾è®¡ç›®çš„æ˜¯ä¸ºäº†åµŒå…¥åº”ç”¨ç¨‹åºä¸­ï¼Œä»è€Œä¸ºåº”ç”¨ç¨‹åºæä¾›çµæ´»çš„æ‰©å±•å’Œå®šåˆ¶åŠŸèƒ½ã€‚</p>
<p>åœ¨ Redis ä¸­ï¼Œæ‰§è¡Œå•ä¸€å‘½ä»¤æ˜¯åŸå­æ€§æ“ä½œï¼Œæ‰€ä»¥ä¸ä¼šå‡ºç°å¹¶å‘é—®é¢˜ã€‚ä½†æœ‰çš„ä¸šåŠ¡åœºæ™¯ä¸‹ï¼Œéœ€è¦æ‰§è¡Œå¤šä¸ªå‘½ä»¤ï¼ŒåŒæ—¶ç¡®ä¿ä¸å‡ºç°å¹¶å‘é—®é¢˜ï¼Œè¿™å°±éœ€è¦ç”¨åˆ° Lua è„šæœ¬äº†ã€‚</p>
<p><strong>Redis æ‰§è¡Œ Lua æ˜¯åŸå­æ“ä½œ</strong>ã€‚å› ä¸º Redis ä½¿ç”¨ä¸²è¡ŒåŒ–çš„æ–¹å¼æ¥æ‰§è¡Œ Redis å‘½ä»¤ï¼Œ æ‰€ä»¥åœ¨ä»»ä½•ç‰¹å®šæ—¶é—´é‡Œï¼Œ æœ€å¤šéƒ½åªä¼šæœ‰ä¸€ä¸ªè„šæœ¬èƒ½å¤Ÿè¢«æ”¾è¿› Lua ç¯å¢ƒé‡Œé¢è¿è¡Œï¼Œ å› æ­¤ï¼Œ æ•´ä¸ª Redis æœåŠ¡å™¨åªéœ€è¦åˆ›å»ºä¸€ä¸ª Lua ç¯å¢ƒå³å¯ã€‚</p>
<p>ç”±äºï¼ŒRedis æ‰§è¡Œ Lua å…·æœ‰åŸå­æ€§ï¼Œæ‰€ä»¥å¸¸è¢«ç”¨äºéœ€è¦åŸå­æ€§æ‰§è¡Œå¤šå‘½ä»¤çš„åœºæ™¯ã€‚</p>
<h2 id="Redis-è„šæœ¬å‘½ä»¤"><a href="#Redis-è„šæœ¬å‘½ä»¤" class="headerlink" title="Redis è„šæœ¬å‘½ä»¤"></a>Redis è„šæœ¬å‘½ä»¤</h2><table>
<thead>
<tr>
<th>å‘½ä»¤</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td><code>EVAL</code></td>
<td><code>EVAL</code> å‘½ä»¤ä¸ºå®¢æˆ·ç«¯è¾“å…¥çš„è„šæœ¬åœ¨ Lua ç¯å¢ƒä¸­å®šä¹‰ä¸€ä¸ªå‡½æ•°ï¼Œ å¹¶é€šè¿‡è°ƒç”¨è¿™ä¸ªå‡½æ•°æ¥æ‰§è¡Œè„šæœ¬ã€‚</td>
</tr>
<tr>
<td><code>EVALSHA</code></td>
<td><code>EVALSHA</code> å‘½ä»¤é€šè¿‡ç›´æ¥è°ƒç”¨ Lua ç¯å¢ƒä¸­å·²å®šä¹‰çš„å‡½æ•°æ¥æ‰§è¡Œè„šæœ¬ã€‚</td>
</tr>
<tr>
<td><code>SCRIPT_FLUSH</code></td>
<td><code>SCRIPT_FLUSH</code> å‘½ä»¤ä¼šæ¸…ç©ºæœåŠ¡å™¨ <code>lua_scripts</code> å­—å…¸ä¸­ä¿å­˜çš„è„šæœ¬ï¼Œ å¹¶é‡ç½® Lua ç¯å¢ƒã€‚</td>
</tr>
<tr>
<td><code>SCRIPT_EXISTS</code></td>
<td><code>SCRIPT_EXISTS</code> å‘½ä»¤æ¥å—ä¸€ä¸ªæˆ–å¤šä¸ª SHA1 æ ¡éªŒå’Œä¸ºå‚æ•°ï¼Œ å¹¶é€šè¿‡æ£€æŸ¥ <code>lua_scripts</code> å­—å…¸æ¥ç¡®è®¤æ ¡éªŒå’Œå¯¹åº”çš„è„šæœ¬æ˜¯å¦å­˜åœ¨ã€‚</td>
</tr>
<tr>
<td><code>SCRIPT_LOAD</code></td>
<td><code>SCRIPT_LOAD</code> å‘½ä»¤æ¥å—ä¸€ä¸ª Lua è„šæœ¬ä¸ºå‚æ•°ï¼Œ ä¸ºè¯¥è„šæœ¬åœ¨ Lua ç¯å¢ƒä¸­åˆ›å»ºå‡½æ•°ï¼Œ å¹¶å°†è„šæœ¬ä¿å­˜åˆ° <code>lua_scripts</code> å­—å…¸ä¸­ã€‚</td>
</tr>
<tr>
<td><code>SCRIPT_KILL</code></td>
<td><code>SCRIPT_KILL</code> å‘½ä»¤ç”¨äºåœæ­¢æ­£åœ¨æ‰§è¡Œçš„è„šæœ¬ã€‚</td>
</tr>
</tbody></table>
<h2 id="Redis-æ‰§è¡Œ-Lua-çš„å·¥ä½œæµç¨‹"><a href="#Redis-æ‰§è¡Œ-Lua-çš„å·¥ä½œæµç¨‹" class="headerlink" title="Redis æ‰§è¡Œ Lua çš„å·¥ä½œæµç¨‹"></a>Redis æ‰§è¡Œ Lua çš„å·¥ä½œæµç¨‹</h2><p>ä¸ºäº†åœ¨ Redis æœåŠ¡å™¨ä¸­æ‰§è¡Œ Lua è„šæœ¬ï¼Œ Redis åœ¨æœåŠ¡å™¨å†…åµŒäº†ä¸€ä¸ª Lua ç¯å¢ƒï¼ˆenvironmentï¼‰ï¼Œ å¹¶å¯¹è¿™ä¸ª Lua ç¯å¢ƒè¿›è¡Œäº†ä¸€ç³»åˆ—ä¿®æ”¹ï¼Œ ä»è€Œç¡®ä¿è¿™ä¸ª Lua ç¯å¢ƒå¯ä»¥æ»¡è¶³ Redis æœåŠ¡å™¨çš„éœ€è¦ã€‚</p>
<p>Redis æœåŠ¡å™¨åˆ›å»ºå¹¶ä¿®æ”¹ Lua ç¯å¢ƒçš„æ•´ä¸ªè¿‡ç¨‹ç”±ä»¥ä¸‹æ­¥éª¤ç»„æˆï¼š</p>
<ol>
<li>åˆ›å»ºä¸€ä¸ªåŸºç¡€çš„ Lua ç¯å¢ƒï¼Œ ä¹‹åçš„æ‰€æœ‰ä¿®æ”¹éƒ½æ˜¯é’ˆå¯¹è¿™ä¸ªç¯å¢ƒè¿›è¡Œçš„ã€‚</li>
<li>è½½å…¥å¤šä¸ªå‡½æ•°åº“åˆ° Lua ç¯å¢ƒé‡Œé¢ï¼Œ è®© Lua è„šæœ¬å¯ä»¥ä½¿ç”¨è¿™äº›å‡½æ•°åº“æ¥è¿›è¡Œæ•°æ®æ“ä½œã€‚</li>
<li>åˆ›å»ºå…¨å±€è¡¨æ ¼ <code>redis</code> ï¼Œ è¿™ä¸ªè¡¨æ ¼åŒ…å«äº†å¯¹ Redis è¿›è¡Œæ“ä½œçš„å‡½æ•°ï¼Œ æ¯”å¦‚ç”¨äºåœ¨ Lua è„šæœ¬ä¸­æ‰§è¡Œ Redis å‘½ä»¤çš„ <code>redis.call</code> å‡½æ•°ã€‚</li>
<li>ä½¿ç”¨ Redis è‡ªåˆ¶çš„éšæœºå‡½æ•°æ¥æ›¿æ¢ Lua åŸæœ‰çš„å¸¦æœ‰å‰¯ä½œç”¨çš„éšæœºå‡½æ•°ï¼Œ ä»è€Œé¿å…åœ¨è„šæœ¬ä¸­å¼•å…¥å‰¯ä½œç”¨ã€‚</li>
<li>åˆ›å»ºæ’åºè¾…åŠ©å‡½æ•°ï¼Œ Lua ç¯å¢ƒä½¿ç”¨è¿™ä¸ªè¾…ä½å‡½æ•°æ¥å¯¹ä¸€éƒ¨åˆ† Redis å‘½ä»¤çš„ç»“æœè¿›è¡Œæ’åºï¼Œ ä»è€Œæ¶ˆé™¤è¿™äº›å‘½ä»¤çš„ä¸ç¡®å®šæ€§ã€‚</li>
<li>åˆ›å»º <code>redis.pcall</code> å‡½æ•°çš„é”™è¯¯æŠ¥å‘Šè¾…åŠ©å‡½æ•°ï¼Œ è¿™ä¸ªå‡½æ•°å¯ä»¥æä¾›æ›´è¯¦ç»†çš„å‡ºé”™ä¿¡æ¯ã€‚</li>
<li>å¯¹ Lua ç¯å¢ƒé‡Œé¢çš„å…¨å±€ç¯å¢ƒè¿›è¡Œä¿æŠ¤ï¼Œ é˜²æ­¢ç”¨æˆ·åœ¨æ‰§è¡Œ Lua è„šæœ¬çš„è¿‡ç¨‹ä¸­ï¼Œ å°†é¢å¤–çš„å…¨å±€å˜é‡æ·»åŠ åˆ°äº† Lua ç¯å¢ƒé‡Œé¢ã€‚</li>
<li>å°†å®Œæˆä¿®æ”¹çš„ Lua ç¯å¢ƒä¿å­˜åˆ°æœåŠ¡å™¨çŠ¶æ€çš„ <code>lua</code> å±æ€§é‡Œé¢ï¼Œ ç­‰å¾…æ‰§è¡ŒæœåŠ¡å™¨ä¼ æ¥çš„ Lua è„šæœ¬ã€‚</li>
</ol>
<h2 id="Redis-æ‰§è¡Œ-Lua-çš„è¦ç‚¹"><a href="#Redis-æ‰§è¡Œ-Lua-çš„è¦ç‚¹" class="headerlink" title="Redis æ‰§è¡Œ Lua çš„è¦ç‚¹"></a>Redis æ‰§è¡Œ Lua çš„è¦ç‚¹</h2><ul>
<li>Redis æœåŠ¡å™¨ä¸“é—¨ä½¿ç”¨ä¸€ä¸ªä¼ªå®¢æˆ·ç«¯æ¥æ‰§è¡Œ Lua è„šæœ¬ä¸­åŒ…å«çš„ Redis å‘½ä»¤ã€‚</li>
<li>Redis ä½¿ç”¨è„šæœ¬å­—å…¸æ¥ä¿å­˜æ‰€æœ‰è¢« <code>EVAL</code> å‘½ä»¤æ‰§è¡Œè¿‡ï¼Œ æˆ–è€…è¢« <code>SCRIPT_LOAD</code> å‘½ä»¤è½½å…¥è¿‡çš„ Lua è„šæœ¬ï¼Œ è¿™äº›è„šæœ¬å¯ä»¥ç”¨äºå®ç° <code>SCRIPT_EXISTS</code> å‘½ä»¤ï¼Œ ä»¥åŠå®ç°è„šæœ¬å¤åˆ¶åŠŸèƒ½ã€‚</li>
<li>æœåŠ¡å™¨åœ¨æ‰§è¡Œè„šæœ¬ä¹‹å‰ï¼Œ ä¼šä¸º Lua ç¯å¢ƒè®¾ç½®ä¸€ä¸ªè¶…æ—¶å¤„ç†é’©å­ï¼Œ å½“è„šæœ¬å‡ºç°è¶…æ—¶è¿è¡Œæƒ…å†µæ—¶ï¼Œ å®¢æˆ·ç«¯å¯ä»¥é€šè¿‡å‘æœåŠ¡å™¨å‘é€ <code>SCRIPT_KILL</code> å‘½ä»¤æ¥è®©é’©å­åœæ­¢æ­£åœ¨æ‰§è¡Œçš„è„šæœ¬ï¼Œ æˆ–è€…å‘é€ <code>SHUTDOWN nosave</code> å‘½ä»¤æ¥è®©é’©å­å…³é—­æ•´ä¸ªæœåŠ¡å™¨ã€‚</li>
<li>ä¸»æœåŠ¡å™¨å¤åˆ¶ <code>EVAL</code> ã€ <code>SCRIPT_FLUSH</code> ã€ <code>SCRIPT_LOAD</code> ä¸‰ä¸ªå‘½ä»¤çš„æ–¹æ³•å’Œå¤åˆ¶æ™®é€š Redis å‘½ä»¤ä¸€æ · â€”â€” åªè¦å°†ç›¸åŒçš„å‘½ä»¤ä¼ æ’­ç»™ä»æœåŠ¡å™¨å°±å¯ä»¥äº†ã€‚</li>
<li>ä¸»æœåŠ¡å™¨åœ¨å¤åˆ¶ <code>EVALSHA</code> å‘½ä»¤æ—¶ï¼Œ å¿…é¡»ç¡®ä¿æ‰€æœ‰ä»æœåŠ¡å™¨éƒ½å·²ç»è½½å…¥äº† <code>EVALSHA</code> å‘½ä»¤æŒ‡å®šçš„ SHA1 æ ¡éªŒå’Œæ‰€å¯¹åº”çš„ Lua è„šæœ¬ï¼Œ å¦‚æœä¸èƒ½ç¡®ä¿è¿™ä¸€ç‚¹çš„è¯ï¼Œ ä¸»æœåŠ¡å™¨ä¼šå°† <code>EVALSHA</code> å‘½ä»¤è½¬æ¢æˆç­‰æ•ˆçš„ <code>EVAL</code> å‘½ä»¤ï¼Œ å¹¶é€šè¿‡ä¼ æ’­ <code>EVAL</code> å‘½ä»¤æ¥è·å¾—ç›¸åŒçš„è„šæœ¬æ‰§è¡Œæ•ˆæœã€‚</li>
</ul>
<h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ul>
<li><a target="_blank" rel="noopener" href="https://item.jd.com/11486101.html">ã€ŠRedis è®¾è®¡ä¸å®ç°ã€‹</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://dunwu.github.io/blog/pages/832412cc/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/uploads/avatar.gif">
      <meta itemprop="name" content="é’æ‚Ÿ â—¾ Dunwu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dunwu Blog">
      <meta itemprop="description" content="é’æ‚Ÿçš„ä¸ªäººåšå®¢">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Dunwu Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/pages/832412cc/" class="post-title-link" itemprop="url">Markdown</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2020-01-27 23:41:00" itemprop="dateCreated datePublished" datetime="2020-01-27T23:41:00+08:00">2020-01-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">æ›´æ–°äº</span>
      <time title="ä¿®æ”¹æ—¶é—´ï¼š2025-09-13 17:56:53" itemprop="dateModified" datetime="2025-09-13T17:56:53+08:00">2025-09-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/%E5%B7%A5%E4%BD%9C/" itemprop="url" rel="index"><span itemprop="name">å·¥ä½œ</span></a>
        </span>
          ï¼Œ
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/%E5%B7%A5%E4%BD%9C/%E6%95%88%E8%83%BD/" itemprop="url" rel="index"><span itemprop="name">æ•ˆèƒ½</span></a>
        </span>
          ï¼Œ
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/%E5%B7%A5%E4%BD%9C/%E6%95%88%E8%83%BD/%E5%B7%A5%E5%85%B7/" itemprop="url" rel="index"><span itemprop="name">å·¥å…·</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
      <span>4.2k</span>
    </span>
    <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
      <span>4 åˆ†é’Ÿ</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Markdown-æç®€æ•™ç¨‹"><a href="#Markdown-æç®€æ•™ç¨‹" class="headerlink" title="Markdown æç®€æ•™ç¨‹"></a>Markdown æç®€æ•™ç¨‹</h1><h2 id="ç›®å½•"><a href="#ç›®å½•" class="headerlink" title="ç›®å½•"></a>ç›®å½•</h2><h2 id="æ ‡é¢˜"><a href="#æ ‡é¢˜" class="headerlink" title="æ ‡é¢˜"></a>æ ‡é¢˜</h2><p>Markdown æ”¯æŒå…­ä¸ªçº§åˆ«çš„æ ‡é¢˜ã€‚</p>
<figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">è¯­æ³•ï¼š</span><br><span class="line"># ä¸€çº§æ ‡é¢˜</span><br><span class="line">## äºŒçº§æ ‡é¢˜</span><br><span class="line">### ä¸‰çº§æ ‡é¢˜</span><br><span class="line">#### å››çº§æ ‡é¢˜</span><br><span class="line">##### äº”çº§æ ‡é¢˜</span><br><span class="line">###### å…­çº§æ ‡é¢˜</span><br></pre></td></tr></table></figure>

<h2 id="æ–‡æœ¬æ ·å¼"><a href="#æ–‡æœ¬æ ·å¼" class="headerlink" title="æ–‡æœ¬æ ·å¼"></a>æ–‡æœ¬æ ·å¼</h2><blockquote>
<p>:bulb: ç²—ä½“ã€æ–œä½“ã€åˆ é™¤çº¿å¯ä»¥æ··åˆä½¿ç”¨ã€‚</p>
<p>åœ¨ Markdown ä¸­ï¼Œç²—ä½“æ–‡æœ¬ã€æ–œä½“æ–‡æœ¬å¯ä»¥ä½¿ç”¨ <code>*</code> æˆ– <code>_</code> ç¬¦å·æ ‡è®°ã€‚å»ºè®®ç»Ÿä¸€é£æ ¼ï¼Œå§‹ç»ˆåªç”¨ä¸€ç§ç¬¦å·ã€‚</p>
</blockquote>
<table>
<thead>
<tr>
<th>è¯­æ³•</th>
<th>æ•ˆæœ</th>
</tr>
</thead>
<tbody><tr>
<td>æ™®é€šæ–‡æœ¬</td>
<td>æ™®é€šæ–‡æœ¬</td>
</tr>
<tr>
<td><code>*æ–œä½“æ–‡æœ¬*</code> <code>_æ–œä½“æ–‡æœ¬_</code></td>
<td><em>æ–œä½“æ–‡æœ¬</em> <em>æ–œä½“æ–‡æœ¬</em></td>
</tr>
<tr>
<td><code>**ç²—ä½“æ–‡æœ¬**</code> <code>__ç²—ä½“æ–‡æœ¬__</code></td>
<td><strong>ç²—ä½“æ–‡æœ¬</strong> <strong>ç²—ä½“æ–‡æœ¬</strong></td>
</tr>
<tr>
<td><code>~~åˆ é™¤æ–‡æœ¬~~</code></td>
<td><del>åˆ é™¤æ–‡æœ¬</del></td>
</tr>
<tr>
<td><code>***ç²—æ–œä½“æ–‡æœ¬***</code> <code>___ç²—æ–œä½“æ–‡æœ¬___</code></td>
<td><strong><em>ç²—æ–œä½“æ–‡æœ¬</em></strong> <strong><em>ç²—æ–œä½“æ–‡æœ¬</em></strong></td>
</tr>
</tbody></table>
<h2 id="åˆ—è¡¨"><a href="#åˆ—è¡¨" class="headerlink" title="åˆ—è¡¨"></a>åˆ—è¡¨</h2><h3 id="æ— åºåˆ—è¡¨"><a href="#æ— åºåˆ—è¡¨" class="headerlink" title="æ— åºåˆ—è¡¨"></a>æ— åºåˆ—è¡¨</h3><ul>
<li>RED</li>
<li>YELLOW</li>
<li>BLUE</li>
</ul>
<h3 id="æœ‰åºåˆ—è¡¨"><a href="#æœ‰åºåˆ—è¡¨" class="headerlink" title="æœ‰åºåˆ—è¡¨"></a>æœ‰åºåˆ—è¡¨</h3><ol>
<li>ç¬¬ä¸€æ­¥</li>
<li>ç¬¬äºŒæ­¥</li>
<li>ç¬¬ä¸‰æ­¥</li>
</ol>
<h3 id="ä»»åŠ¡åˆ—è¡¨"><a href="#ä»»åŠ¡åˆ—è¡¨" class="headerlink" title="ä»»åŠ¡åˆ—è¡¨"></a>ä»»åŠ¡åˆ—è¡¨</h3><ul>
<li><input checked="" disabled="" type="checkbox"> å®Œæˆä»»åŠ¡</li>
<li><input disabled="" type="checkbox"> è®¡åˆ’ä»»åŠ¡</li>
</ul>
<h3 id="å¤šçº§åˆ—è¡¨"><a href="#å¤šçº§åˆ—è¡¨" class="headerlink" title="å¤šçº§åˆ—è¡¨"></a>å¤šçº§åˆ—è¡¨</h3><ul>
<li>æ•°æ®ç»“æ„<ul>
<li>çº¿æ€§è¡¨<ul>
<li>é¡ºåºè¡¨</li>
<li>é“¾è¡¨<ul>
<li>å•é“¾è¡¨</li>
<li>åŒé“¾è¡¨</li>
</ul>
</li>
</ul>
</li>
<li>æ ‘<ul>
<li>äºŒå‰æ ‘<ul>
<li>äºŒå‰å¹³è¡¡æ ‘</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="åˆ†å‰²çº¿"><a href="#åˆ†å‰²çº¿" class="headerlink" title="åˆ†å‰²çº¿"></a>åˆ†å‰²çº¿</h2><p><code>***</code>ã€<code>---</code>ã€<code>___</code> éƒ½å¯ä»¥ä½œä¸ºåˆ†å‰²çº¿ã€‚</p>
<hr>
<hr>
<hr>
<h2 id="é“¾æ¥"><a href="#é“¾æ¥" class="headerlink" title="é“¾æ¥"></a>é“¾æ¥</h2><h3 id="æ™®é€šé“¾æ¥"><a href="#æ™®é€šé“¾æ¥" class="headerlink" title="æ™®é€šé“¾æ¥"></a>æ™®é€šé“¾æ¥</h3><p>è¯­æ³•ï¼š</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[é’æ‚Ÿçš„åšå®¢]</span>(<span class="attribute">https</span>:<span class="comment">//dunwu.github.io/waterdrop/)</span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>[]</code> ä¸­æ ‡è®°é“¾æ¥åã€‚ç±»ä¼¼ HTML ä¸­ <code>&lt;a&gt;</code> å…ƒç´ çš„ <code>title</code> å±æ€§ã€‚</li>
<li><code>()</code> ä¸­æ ‡è®°é“¾æ¥çš„ urlï¼Œä¹Ÿæ”¯æŒç›¸å¯¹è·¯å¾„ï¼ˆå‰ææ˜¯èµ„æºå¯ä»¥è®¿é—®ï¼‰ã€‚ç±»ä¼¼ HTML ä¸­ <code>&lt;a&gt;</code> å…ƒç´ çš„ <code>href</code> å±æ€§ã€‚</li>
</ul>
<p>æ•ˆæœï¼š</p>
<ul>
<li><a href="https://dunwu.github.io/waterdrop/" title="blog">é’æ‚Ÿçš„åšå®¢</a></li>
</ul>
<h3 id="å›¾ç‰‡"><a href="#å›¾ç‰‡" class="headerlink" title="å›¾ç‰‡"></a>å›¾ç‰‡</h3><p>Markdown å¼•ç”¨å›¾ç‰‡çš„è¯­æ³•ï¼š</p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">!<span class="selector-attr">[alt]</span>(url title)</span><br></pre></td></tr></table></figure>

<p>alt å’Œ title å³å¯¹åº” HTML ä¸­ img å…ƒç´ çš„ alt å’Œ title å±æ€§ï¼ˆéƒ½å¯çœç•¥ï¼‰ï¼š</p>
<ul>
<li><p>alt - è¡¨ç¤ºå›¾ç‰‡æ˜¾ç¤ºå¤±è´¥æ—¶çš„æ›¿æ¢æ–‡æœ¬ã€‚</p>
</li>
<li><p>title - è¡¨ç¤ºé¼ æ ‡æ‚¬åœåœ¨å›¾ç‰‡æ—¶çš„æ˜¾ç¤ºæ–‡æœ¬ï¼ˆæ³¨æ„è¿™é‡Œè¦åŠ å¼•å·ï¼‰</p>
</li>
<li><p>url - å³å›¾ç‰‡çš„ url åœ°å€</p>
</li>
</ul>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/common/dunwu-logo.png" alt="logo" title="logo"></p>
<h3 id="å›¾ç‰‡é“¾æ¥"><a href="#å›¾ç‰‡é“¾æ¥" class="headerlink" title="å›¾ç‰‡é“¾æ¥"></a>å›¾ç‰‡é“¾æ¥</h3><p>å¯ä»¥å°†å›¾ç‰‡å’Œé“¾æ¥æ··åˆä½¿ç”¨ã€‚</p>
<p><a href="https://dunwu.github.io/waterdrop/"><img src="https://raw.githubusercontent.com/dunwu/images/master/common/dunwu-logo.png" alt="logo" title="logo"></a></p>
<h3 id="é”šç‚¹"><a href="#é”šç‚¹" class="headerlink" title="é”šç‚¹"></a>é”šç‚¹</h3><p>å…¶å®å‘¢ï¼Œæ¯ä¸€ä¸ªæ ‡é¢˜éƒ½æ˜¯ä¸€ä¸ªé”šç‚¹ï¼Œå’Œ HTML çš„é”šç‚¹ï¼ˆ<code>#</code>ï¼‰ç±»ä¼¼ï¼Œæ¯”å¦‚ï¼š<a href="#Markdown-%E5%BA%94%E7%94%A8%E6%8C%87%E5%8D%97">å›åˆ°é¡¶éƒ¨</a></p>
<h2 id="å¼•ç”¨"><a href="#å¼•ç”¨" class="headerlink" title="å¼•ç”¨"></a>å¼•ç”¨</h2><p>æ™®é€šå¼•ç”¨ï¼š</p>
<blockquote>
<p>:question: ä»€ä¹ˆæ˜¯ <code>Markdown</code></p>
<p><strong>Markdown</strong>æ˜¯ä¸€ç§<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E8%BD%BB%E9%87%8F%E7%BA%A7%E6%A0%87%E8%AE%B0%E8%AF%AD%E8%A8%80">è½»é‡çº§æ ‡è®°è¯­è¨€</a>ï¼Œåˆ›å§‹äººä¸º<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E7%B4%84%E7%BF%B0%C2%B7%E6%A0%BC%E9%AD%AF%E4%BC%AF">çº¦ç¿°Â·æ ¼é²ä¼¯</a>ï¼ˆè‹±è¯­ï¼šJohn Gruberï¼‰ã€‚å®ƒå…è®¸äººä»¬â€œä½¿ç”¨æ˜“è¯»æ˜“å†™çš„çº¯æ–‡æœ¬æ ¼å¼ç¼–å†™æ–‡æ¡£ï¼Œç„¶åè½¬æ¢æˆæœ‰æ•ˆçš„<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/XHTML">XHTML</a>ï¼ˆæˆ–è€…<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/HTML">HTML</a>ï¼‰æ–‡æ¡£â€ã€‚[<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Markdown#cite_note-md-4">4]</a>è¿™ç§è¯­è¨€å¸æ”¶äº†å¾ˆå¤šåœ¨<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E7%94%B5%E5%AD%90%E9%82%AE%E4%BB%B6">ç”µå­é‚®ä»¶</a>ä¸­å·²æœ‰çš„çº¯æ–‡æœ¬æ ‡è®°çš„ç‰¹æ€§ã€‚ â€”â€” æ‘˜è‡ª Wiki</p>
</blockquote>
<p>åµŒå¥—å¼•ç”¨ï¼š</p>
<blockquote>
<p>æ•°æ®ç»“æ„</p>
<blockquote>
<p>æ ‘</p>
<blockquote>
<p>äºŒå‰æ ‘</p>
<blockquote>
<p>å¹³è¡¡äºŒå‰æ ‘</p>
<blockquote>
<p>æ»¡äºŒå‰æ ‘</p>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
<h2 id="ä»£ç é«˜äº®"><a href="#ä»£ç é«˜äº®" class="headerlink" title="ä»£ç é«˜äº®"></a>ä»£ç é«˜äº®</h2><h3 id="æ ‡ç­¾"><a href="#æ ‡ç­¾" class="headerlink" title="æ ‡ç­¾"></a>æ ‡ç­¾</h3><p>è¯­æ³•ï¼š</p>
<figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">`Markdown` `Doc`</span><br></pre></td></tr></table></figure>

<p>æ•ˆæœï¼š</p>
<p><code>Markdown</code>, <code>Doc</code></p>
<h3 id="ä»£ç å—"><a href="#ä»£ç å—" class="headerlink" title="ä»£ç å—"></a>ä»£ç å—</h3><p>è¯­æ³•ä¸€ï¼šåœ¨æ–‡æœ¬å‰åéƒ½ä½¿ç”¨ä¸‰ä¸ªåå¼•å·è¿›è¡Œæ ‡è®°ã€‚ã€âœ”ï¸ï¸ï¸ï¸ æ¨èã€‘</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">è¿™æ˜¯ä¸€ä¸ªæ–‡æœ¬å—ã€‚</span><br><span class="line">è¿™æ˜¯ä¸€ä¸ªæ–‡æœ¬å—ã€‚</span><br><span class="line">è¿™æ˜¯ä¸€ä¸ªæ–‡æœ¬å—ã€‚</span><br></pre></td></tr></table></figure>

<p>è¯­æ³•äºŒï¼šåœ¨è¿ç»­å‡ è¡Œçš„æ–‡æœ¬å¼€å¤´åŠ å…¥ 1 ä¸ª Tab æˆ–è€… 4 ä¸ªç©ºæ ¼ã€‚ã€âŒ ä¸æ¨èã€‘</p>
<pre><code>è¿™æ˜¯ä¸€ä¸ªæ–‡æœ¬å—ã€‚
è¿™æ˜¯ä¸€ä¸ªæ–‡æœ¬å—ã€‚
è¿™æ˜¯ä¸€ä¸ªæ–‡æœ¬å—ã€‚
</code></pre>
<h3 id="è¯­æ³•"><a href="#è¯­æ³•" class="headerlink" title="è¯­æ³•"></a>è¯­æ³•</h3><p>åœ¨ä¸‰ä¸ªåå¼•å·åé¢åŠ ä¸Šç¼–ç¨‹è¯­è¨€çš„åå­—ï¼Œå¦èµ·ä¸€è¡Œå¼€å§‹å†™ä»£ç ï¼Œæœ€åä¸€è¡Œå†åŠ ä¸Šä¸‰ä¸ªåå¼•å·ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[]args)</span>&#123;&#125; <span class="comment">//Java</span></span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span> <span class="comment">//C</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;hello GitHub&quot;</span> <span class="comment">#Bash</span></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;myH1&#x27;</span>).<span class="property">innerHTML</span> = <span class="string">&#x27;Welcome to my Homepage&#x27;</span> <span class="comment">//javascipt</span></span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">string &amp;<span class="keyword">operator</span>+(<span class="type">const</span> string&amp; A,<span class="type">const</span> string&amp; B) <span class="comment">//cpp</span></span><br></pre></td></tr></table></figure>

<h2 id="è¡¨æ ¼"><a href="#è¡¨æ ¼" class="headerlink" title="è¡¨æ ¼"></a>è¡¨æ ¼</h2><p>ä¸€èˆ¬è¡¨æ ¼ï¼š</p>
<table>
<thead>
<tr>
<th>è¡¨å¤´ 1</th>
<th>è¡¨å¤´ 2</th>
</tr>
</thead>
<tbody><tr>
<td>è¡¨æ ¼å•å…ƒ</td>
<td>è¡¨æ ¼å•å…ƒ</td>
</tr>
<tr>
<td>è¡¨æ ¼å•å…ƒ</td>
<td>è¡¨æ ¼å•å…ƒ</td>
</tr>
</tbody></table>
<p>è¡¨æ ¼å¯ä»¥æŒ‡å®šå¯¹é½æ–¹å¼ï¼š</p>
<table>
<thead>
<tr>
<th align="center">åºå·</th>
<th align="left">å•†å“</th>
<th align="right">ä»·æ ¼</th>
</tr>
</thead>
<tbody><tr>
<td align="center">1</td>
<td align="left">ç”µè„‘</td>
<td align="right">6000.0</td>
</tr>
<tr>
<td align="center">2</td>
<td align="left">é¼ æ ‡</td>
<td align="right">100.0</td>
</tr>
<tr>
<td align="center">3</td>
<td align="left">é”®ç›˜</td>
<td align="right">200.0</td>
</tr>
</tbody></table>
<h2 id="Emoji-è¡¨æƒ…"><a href="#Emoji-è¡¨æƒ…" class="headerlink" title="Emoji è¡¨æƒ…"></a>Emoji è¡¨æƒ…</h2><blockquote>
<p>:bulb: æ³¨æ„ï¼šéƒ¨åˆ† Markdown å¼•æ“æ”¯æŒ Emojiã€‚</p>
</blockquote>
<p>åˆç†ä½¿ç”¨ Emoji è¡¨æƒ…ï¼Œå¾€å¾€å¯ä»¥ä½¿å¾—æ–‡ç« å†…å®¹æ›´åŠ ä¸°å¯Œç”ŸåŠ¨ã€‚ä¾‹å¦‚ï¼š:heavy_check_mark: :x: :bulb: :bell: :heavy_exclamation_mark: :question:</p>
<blockquote>
<p>æ›´å¤š Emoji è¡¨æƒ…è¯·å‚è€ƒï¼š</p>
<ul>
<li><a target="_blank" rel="noopener" href="http://emojihomepage.com/">http://emojihomepage.com/</a></li>
<li><a target="_blank" rel="noopener" href="http://www.emoji-cheat-sheet.com/">http://www.emoji-cheat-sheet.com</a></li>
</ul>
</blockquote>
<h2 id="æ³¨è„š"><a href="#æ³¨è„š" class="headerlink" title="æ³¨è„š"></a>æ³¨è„š</h2><blockquote>
<p>:bulb: æ³¨æ„ï¼šéƒ¨åˆ† Markdown å¼•æ“æ”¯æŒæ³¨è„šã€‚</p>
</blockquote>
<p>ä¸€ä¸ªå…·æœ‰æ³¨è„šçš„æ–‡æœ¬ã€‚<a href="%E6%B3%A8%E8%84%9A%E7%9A%84%E8%A7%A3%E9%87%8A">^1</a></p>
<h2 id="æ•°å­¦å…¬å¼"><a href="#æ•°å­¦å…¬å¼" class="headerlink" title="æ•°å­¦å…¬å¼"></a>æ•°å­¦å…¬å¼</h2><blockquote>
<p>:bulb: æ³¨æ„ï¼šéƒ¨åˆ† Markdown å¼•æ“æ”¯æŒ Latexã€‚</p>
</blockquote>
<p>å¾ˆå¤šæ–‡æ¡£ä¸­ï¼Œéœ€è¦å¼•å…¥ä¸€äº›æ•°å­¦ç¬¦å·ã€ç‰¹æ®Šç¬¦å·ï¼Œå…¶æ’ç‰ˆé—®é¢˜æ¯”è¾ƒå¤´ç–¼ã€‚è¿™ç§é—®é¢˜ï¼Œå¯ä»¥ç”¨ Latex æ¥è§£å†³ï¼Œå¤§éƒ¨åˆ† Markdown å¼•æ“éƒ½æ”¯æŒ Latexã€‚</p>
<p>Latex å¯ä»¥ä½¿ç”¨ <code>$</code> ç¬¦å·æ¥æ ‡è®° Latex è¡¨è¾¾å¼ï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªæ•°å­¦å…¬å¼ç¤ºä¾‹ï¼š</p>
<p>$$<br>\Gamma(z) &#x3D; \int_0^\infty t^{z-1}e^{-t}dt,.<br>$$</p>
<p>åˆ—ä¸¾ä¸€äº›å¸¸ç”¨æ•°å­¦ç¬¦å·ï¼š</p>
<table>
<thead>
<tr>
<th align="center">ç¬¦å·</th>
<th>è¯­æ³•</th>
<th>æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td align="center">$\leq$</td>
<td><code>$\leq$</code></td>
<td>å°äºç­‰äº</td>
</tr>
<tr>
<td align="center">$\geq$</td>
<td><code>$\geq$</code></td>
<td>å¤§äºç­‰äº</td>
</tr>
<tr>
<td align="center">$\neq$</td>
<td><code>$\neq$</code></td>
<td>ä¸ç­‰äº</td>
</tr>
<tr>
<td align="center">$\approx$</td>
<td><code>$\approx$</code></td>
<td>çº¦ç­‰äº</td>
</tr>
<tr>
<td align="center">$\infty$</td>
<td><code>$\infty$</code></td>
<td>æ— ç©·</td>
</tr>
<tr>
<td align="center">$\prod_{x}^{y}$</td>
<td><code>$\prod_&#123;x&#125;^&#123;y&#125;$</code></td>
<td>ç´¯ä¹˜</td>
</tr>
<tr>
<td align="center">$\sum_{i&#x3D;0}^n$</td>
<td><code>$\sum_&#123;i=0&#125;^n$</code></td>
<td>æ±‚å’Œ</td>
</tr>
<tr>
<td align="center">$\int$</td>
<td><code>$\int$</code></td>
<td>ç§¯åˆ†</td>
</tr>
<tr>
<td align="center">$\iint$</td>
<td><code>$\iint$</code></td>
<td>åŒé‡ç§¯åˆ†</td>
</tr>
<tr>
<td align="center">$\log_x{y}$</td>
<td><code>$\log_x&#123;y&#125;$</code></td>
<td>å¯¹æ•°</td>
</tr>
<tr>
<td align="center">$x^{y+1}$</td>
<td><code>$x^&#123;y+1&#125;$</code></td>
<td>ä¸Šæ ‡</td>
</tr>
<tr>
<td align="center">$x_{y+1}$</td>
<td><code>$x_&#123;y+1&#125;$</code></td>
<td>ä¸‹æ ‡</td>
</tr>
<tr>
<td align="center">$\frac{x}{y}$</td>
<td><code>$\frac&#123;x&#125;&#123;y&#125;$</code></td>
<td>åˆ†æ•°</td>
</tr>
<tr>
<td align="center">$\sqrt[y]{x}$</td>
<td><code>$\sqrt[y]&#123;x&#125;$</code></td>
<td>å¼€æ–¹</td>
</tr>
<tr>
<td align="center">$\sin$</td>
<td><code>$\sin$</code></td>
<td>æ­£å¼¦</td>
</tr>
<tr>
<td align="center">$\cos$</td>
<td><code>$\cos$</code></td>
<td>ä½™å¼¦</td>
</tr>
<tr>
<td align="center">$\tan$</td>
<td><code>$\tan$</code></td>
<td>æ­£åˆ‡</td>
</tr>
</tbody></table>
<blockquote>
<p>æ›´å¤šæ•°å­¦ç¬¦å·æ”¯æŒè¯·å‚è€ƒï¼š</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/luong-komorebi/Begin-Latex-in-minutes">Begin-Latex-in-minutes</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/Katherine_hsr/article/details/79179622">Markdown æ•°å­¦ç¬¦å·&amp;å…¬å¼</a></li>
</ul>
</blockquote>
<h2 id="Diff"><a href="#Diff" class="headerlink" title="Diff"></a>Diff</h2><blockquote>
<p>:bulb: æ³¨æ„ï¼šéƒ¨åˆ† Markdown å¼•æ“æ”¯æŒ Diffã€‚</p>
</blockquote>
<p>ç‰ˆæœ¬æ§åˆ¶çš„ç³»ç»Ÿä¸­éƒ½å°‘ä¸äº† diff çš„åŠŸèƒ½ï¼Œå³å±•ç¤ºä¸€ä¸ªæ–‡ä»¶å†…å®¹çš„å¢åŠ ä¸åˆ é™¤ã€‚<br>GFM ä¸­å¯ä»¥æ˜¾ç¤ºçš„å±•ç¤º diff æ•ˆæœã€‚å¯ä»¥ç”¨ <code>+</code> å¼€å¤´è¡¨ç¤ºæ–°å¢ï¼Œ<code>-</code> å¼€å¤´è¡¨ç¤ºåˆ é™¤ã€‚</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+ æ–°å¢å†…å®¹</span></span><br><span class="line"><span class="deletion">- åˆ é™¤å†…å®¹</span></span><br></pre></td></tr></table></figure>

<h2 id="UML-å›¾"><a href="#UML-å›¾" class="headerlink" title="UML å›¾"></a>UML å›¾</h2><blockquote>
<p>ğŸ’¡ æ³¨æ„ï¼šéƒ¨åˆ† Markdown å¼•æ“æ”¯æŒ <a target="_blank" rel="noopener" href="https://mermaid-js.github.io/mermaid/">mermaid</a>ã€‚</p>
<p><a target="_blank" rel="noopener" href="https://mermaid-js.github.io/mermaid/">mermaid</a> æä¾›äº†å¤šç§ UML å›¾ã€‚è¯¦æƒ…è¯·å‚è€ƒï¼š<a target="_blank" rel="noopener" href="https://mermaidjs.github.io/">mermaid æ–‡æ¡£</a></p>
</blockquote>
<h3 id="æµç¨‹å›¾"><a href="#æµç¨‹å›¾" class="headerlink" title="æµç¨‹å›¾"></a>æµç¨‹å›¾</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">graph LR</span><br><span class="line">    A[Hard edge] --&gt;|Link text| B(Round edge)</span><br><span class="line">    B --&gt; C&#123;Decision&#125;</span><br><span class="line">    C --&gt;|One| D[Result one]</span><br><span class="line">    C --&gt;|Two| E[Result two]</span><br></pre></td></tr></table></figure>

<h3 id="æ—¶åºå›¾"><a href="#æ—¶åºå›¾" class="headerlink" title="æ—¶åºå›¾"></a>æ—¶åºå›¾</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">sequenceDiagram</span><br><span class="line">    Alice-&gt;&gt;Bob: Hello Bob, how are you?</span><br><span class="line">    alt is sick</span><br><span class="line">        Bob-&gt;&gt;Alice: Not so good :(</span><br><span class="line">    else is well</span><br><span class="line">        Bob-&gt;&gt;Alice: Feeling fresh like a daisy</span><br><span class="line">    end</span><br><span class="line">    opt Extra response</span><br><span class="line">        Bob-&gt;&gt;Alice: Thanks for asking</span><br><span class="line">    end</span><br></pre></td></tr></table></figure>

<h3 id="ç”˜ç‰¹å›¾"><a href="#ç”˜ç‰¹å›¾" class="headerlink" title="ç”˜ç‰¹å›¾"></a>ç”˜ç‰¹å›¾</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">gantt</span><br><span class="line">       dateFormat  YYYY-MM-DD</span><br><span class="line">       title Adding GANTT diagram functionality to mermaid</span><br><span class="line"></span><br><span class="line">       section A section</span><br><span class="line">       Completed task            :done,    des1, 2014-01-06,2014-01-08</span><br><span class="line">       Active task               :active,  des2, 2014-01-09, 3d</span><br><span class="line">       Future task               :         des3, after des2, 5d</span><br><span class="line">       Future task2              :         des4, after des3, 5d</span><br><span class="line"></span><br><span class="line">       section Critical tasks</span><br><span class="line">       Completed task in the critical line :crit, done, 2014-01-06,24h</span><br><span class="line">       Implement parser and jison          :crit, done, after des1, 2d</span><br><span class="line">       Create tests for parser             :crit, active, 3d</span><br><span class="line">       Future task in critical line        :crit, 5d</span><br><span class="line">       Create tests for renderer           :2d</span><br><span class="line">       Add to mermaid                      :1d</span><br><span class="line"></span><br><span class="line">       section Documentation</span><br><span class="line">       Describe gantt syntax               :active, a1, after des1, 3d</span><br><span class="line">       Add gantt diagram to demo page      :after a1  , 20h</span><br><span class="line">       Add another diagram to demo page    :doc1, after a1  , 48h</span><br><span class="line"></span><br><span class="line">       section Last section</span><br><span class="line">       Describe gantt syntax               :after doc1, 3d</span><br><span class="line">       Add gantt diagram to demo page      :20h</span><br><span class="line">       Add another diagram to demo page    :48h</span><br></pre></td></tr></table></figure>

<h2 id="HTML"><a href="#HTML" class="headerlink" title="HTML"></a>HTML</h2><p>æœ‰äº› Markdown å¼•æ“æ”¯æŒåœ¨æ–‡æ¡£ä¸­åµŒå…¥çš„ html å…ƒç´ ã€‚</p>
<p>æœ‰äº› Markdown è¯­æ³•æ‰€ä¸æ”¯æŒçš„ç‰¹æ€§ï¼Œå¯ä»¥ä½¿ç”¨ html å…ƒç´ æ¥æ”¯æŒã€‚</p>
<h3 id="æŠ˜å "><a href="#æŠ˜å " class="headerlink" title="æŠ˜å "></a>æŠ˜å </h3><details>
  <summary>æŠ˜å å†…å®¹ä¸€</summary>
  <p>å±•å¼€æ‰èƒ½çœ‹åˆ°çš„å†…å®¹</p>
</details>
<details>
  <summary>æŠ˜å å†…å®¹äºŒ</summary>
  <p>å±•å¼€æ‰èƒ½çœ‹åˆ°çš„å†…å®¹</p>
</details>

<h3 id="å±…ä¸­"><a href="#å±…ä¸­" class="headerlink" title="å±…ä¸­"></a>å±…ä¸­</h3><div align="center"><p>å±…ä¸­æ˜¾ç¤ºçš„æ–‡æœ¬</p></div>

<h3 id="å›¾ç‰‡å°ºå¯¸"><a href="#å›¾ç‰‡å°ºå¯¸" class="headerlink" title="å›¾ç‰‡å°ºå¯¸"></a>å›¾ç‰‡å°ºå¯¸</h3><div align="center"><img width="100px" src="https://raw.githubusercontent.com/dunwu/images/master/common/dunwu-logo.png" /></div>

<h2 id="ç¼–è¾‘å™¨"><a href="#ç¼–è¾‘å™¨" class="headerlink" title="ç¼–è¾‘å™¨"></a>ç¼–è¾‘å™¨</h2><p>æ¨è Markdown ç¼–è¾‘å™¨</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.typora.io/">Typora</a> - ä¸ªäººè®¤ä¸ºæ˜¯åŠŸèƒ½æœ€å¼ºçš„ Markdown ç¼–è¾‘å™¨ã€‚</li>
<li><a target="_blank" rel="noopener" href="https://github.com/microsoft/vscode">Visual Studio Code</a> - å¯ä»¥é€šè¿‡å®‰è£…æ’ä»¶ï¼Œé‡èº«æ‰“é€  Markdown ç¼–è¾‘å™¨ã€‚</li>
<li><a target="_blank" rel="noopener" href="https://github.com/marktext/marktext">marktext</a> - ä¸€æ¬¾ç®€å•ä¼˜é›…çš„ Markdown ç¼–è¾‘å™¨ã€‚</li>
<li><a target="_blank" rel="noopener" href="https://stackedit.io/">StackEdit</a> - åœ¨çº¿ Markdown ç¼–è¾‘å™¨ã€‚</li>
<li><a target="_blank" rel="noopener" href="https://pandao.github.io/editor.md/">Editor.md</a> - åœ¨çº¿ Markdown ç¼–è¾‘å™¨ã€‚</li>
<li><a target="_blank" rel="noopener" href="https://maxiang.io/">Marxico</a> - ä¸€æ¬¾ä¸“ä¸ºå°è±¡ç¬”è®°ï¼ˆEvernoteï¼‰æ‰“é€ çš„ Markdown ç¼–è¾‘å™¨ã€‚</li>
</ul>
<blockquote>
<p>æƒ³äº†è§£æ›´å¤š Markdown ç¼–è¾‘å™¨å¯ä»¥å‚è€ƒï¼š<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/69210764">ä¸»æµ Markdown ç¼–è¾‘å™¨æ¨è</a></p>
</blockquote>
<h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ul>
<li><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Markdown">https://zh.wikipedia.org/wiki/Markdown</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/guodongxiaren/README">https://github.com/guodongxiaren/README</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/tchapi/markdown-cheatsheet">markdown-cheatsheet</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/luong-komorebi/Begin-Latex-in-minutes">Begin-Latex-in-minutes</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/mermaid-js/mermaid">https://github.com/mermaid-js/mermaid</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://dunwu.github.io/blog/pages/af27858e/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/uploads/avatar.gif">
      <meta itemprop="name" content="é’æ‚Ÿ â—¾ Dunwu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dunwu Blog">
      <meta itemprop="description" content="é’æ‚Ÿçš„ä¸ªäººåšå®¢">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Dunwu Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/pages/af27858e/" class="post-title-link" itemprop="url">æµé‡æ§åˆ¶</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2020-01-20 11:06:00" itemprop="dateCreated datePublished" datetime="2020-01-20T11:06:00+08:00">2020-01-20</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">æ›´æ–°äº</span>
      <time title="ä¿®æ”¹æ—¶é—´ï¼š2025-09-13 17:56:53" itemprop="dateModified" datetime="2025-09-13T17:56:53+08:00">2025-09-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/%E5%88%86%E5%B8%83%E5%BC%8F/" itemprop="url" rel="index"><span itemprop="name">åˆ†å¸ƒå¼</span></a>
        </span>
          ï¼Œ
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/%E5%88%86%E5%B8%83%E5%BC%8F/%E5%88%86%E5%B8%83%E5%BC%8F%E8%B0%83%E5%BA%A6/" itemprop="url" rel="index"><span itemprop="name">åˆ†å¸ƒå¼è°ƒåº¦</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
      <span>25k</span>
    </span>
    <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
      <span>23 åˆ†é’Ÿ</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="æµé‡æ§åˆ¶"><a href="#æµé‡æ§åˆ¶" class="headerlink" title="æµé‡æ§åˆ¶"></a>æµé‡æ§åˆ¶</h1><blockquote>
<p>åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œä¸ºäº†åº”å¯¹ç¬æ—¶æµ·é‡è¯·æ±‚çš„å‹åŠ›ï¼Œä¿éšœç³»ç»Ÿçš„å¹³ç¨³è¿è¡Œï¼Œå¿…é¡»é¢„ä¼°ç³»ç»Ÿçš„æµé‡é˜ˆå€¼ï¼Œé€šè¿‡é™æµè§„åˆ™é˜»æ–­å¤„ç†ä¸è¿‡æ¥çš„è¯·æ±‚ã€‚</p>
</blockquote>
<h2 id="æµé‡æ§åˆ¶ç®€ä»‹"><a href="#æµé‡æ§åˆ¶ç®€ä»‹" class="headerlink" title="æµé‡æ§åˆ¶ç®€ä»‹"></a>æµé‡æ§åˆ¶ç®€ä»‹</h2><h3 id="ä»€ä¹ˆæ˜¯æµé‡æ§åˆ¶"><a href="#ä»€ä¹ˆæ˜¯æµé‡æ§åˆ¶" class="headerlink" title="ä»€ä¹ˆæ˜¯æµé‡æ§åˆ¶"></a>ä»€ä¹ˆæ˜¯æµé‡æ§åˆ¶</h3><p>æµé‡æ§åˆ¶ï¼ˆFlow Controlï¼‰ï¼Œæ ¹æ®æµé‡ã€å¹¶å‘çº¿ç¨‹æ•°ã€å“åº”æ—¶é—´ç­‰æŒ‡æ ‡ï¼ŒæŠŠéšæœºåˆ°æ¥çš„æµé‡è°ƒæ•´æˆåˆé€‚çš„å½¢çŠ¶ï¼Œå³æµé‡å¡‘å½¢ã€‚é¿å…åº”ç”¨è¢«ç¬æ—¶çš„æµé‡é«˜å³°å†²å®ï¼Œä»è€Œä¿éšœåº”ç”¨çš„é«˜å¯ç”¨æ€§ã€‚</p>
<h3 id="ä¸ºä»€ä¹ˆéœ€è¦æµé‡æ§åˆ¶"><a href="#ä¸ºä»€ä¹ˆéœ€è¦æµé‡æ§åˆ¶" class="headerlink" title="ä¸ºä»€ä¹ˆéœ€è¦æµé‡æ§åˆ¶"></a>ä¸ºä»€ä¹ˆéœ€è¦æµé‡æ§åˆ¶</h3><p>å¤æ‚çš„åˆ†å¸ƒå¼ç³»ç»Ÿæ¶æ„ä¸­çš„åº”ç”¨ç¨‹åºå¾€å¾€å…·æœ‰æ•°åä¸ªä¾èµ–é¡¹ï¼Œæ¯ä¸ªä¾èµ–é¡¹éƒ½ä¼šä¸å¯é¿å…åœ°åœ¨æŸä¸ªæ—¶åˆ»å¤±è´¥ã€‚ å¦‚æœä¸»æœºåº”ç”¨ç¨‹åºæœªä¸è¿™äº›å¤–éƒ¨æ•…éšœéš”ç¦»å¼€æ¥ï¼Œåˆ™å¯èƒ½ä¼šè¢«æ³¢åŠã€‚</p>
<p>ä¾‹å¦‚ï¼Œå¯¹äºä¾èµ–äº 30 ä¸ªæœåŠ¡çš„åº”ç”¨ç¨‹åºï¼Œå‡è®¾æ¯ä¸ªæœåŠ¡çš„æ­£å¸¸è¿è¡Œæ—¶é—´ä¸º 99.99ï¼…ï¼Œåˆ™å¯ä»¥æœŸæœ›ï¼š</p>
<blockquote>
<p>99.99<sup>30</sup> &#x3D; 99.7ï¼… çš„æ­£å¸¸è¿è¡Œæ—¶é—´</p>
<p>10 äº¿ä¸ªè¯·æ±‚ä¸­çš„ 0.3ï¼…&#x3D; 3,000,000 ä¸ªå¤±è´¥</p>
<p>å³ä½¿æ‰€æœ‰ä¾èµ–é¡¹éƒ½å…·æœ‰å‡ºè‰²çš„æ­£å¸¸è¿è¡Œæ—¶é—´ï¼Œæ¯æœˆä¹Ÿä¼šæœ‰ 2 ä¸ªå°æ—¶ä»¥ä¸Šçš„åœæœºæ—¶é—´ã€‚</p>
<p>ç„¶è€Œï¼Œç°å®æƒ…å†µä¸€èˆ¬æ¯”è¿™ç§ä¼°é‡æƒ…å†µæ›´ç³Ÿç³•ã€‚</p>
</blockquote>
<hr>
<p>å½“ä¸€åˆ‡æ­£å¸¸æ—¶ï¼Œæ•´ä½“ç³»ç»Ÿå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/202401280931974.png" alt="img"></p>
<p>å›¾ç‰‡æ¥è‡ª <a target="_blank" rel="noopener" href="https://github.com/Netflix/Hystrix/wiki">Hystrix Wiki</a></p>
<p>åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿæ¶æ„ä¸‹ï¼Œè¿™äº›å¼ºä¾èµ–çš„å­æœåŠ¡ç¨³å®šä¸å¦å¯¹ç³»ç»Ÿçš„å½±å“éå¸¸å¤§ã€‚ä½†æ˜¯ï¼Œä¾èµ–çš„å­æœåŠ¡å¯èƒ½æœ‰å¾ˆå¤šä¸å¯æ§é—®é¢˜ï¼šå¦‚ç½‘ç»œè¿æ¥ã€èµ„æºç¹å¿™ã€æœåŠ¡å®•æœºç­‰ã€‚ä¾‹å¦‚ï¼šä¸‹å›¾ä¸­æœ‰ä¸€ä¸ª QPS ä¸º 50 çš„ä¾èµ–æœåŠ¡ I å‡ºç°ä¸å¯ç”¨ï¼Œä½†æ˜¯å…¶ä»–ä¾èµ–æœåŠ¡æ˜¯å¯ç”¨çš„ã€‚</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/202401280931939.png" alt="img"></p>
<p>å›¾ç‰‡æ¥è‡ª <a target="_blank" rel="noopener" href="https://github.com/Netflix/Hystrix/wiki">Hystrix Wiki</a></p>
<p>å½“æµé‡å¾ˆå¤§çš„æƒ…å†µä¸‹ï¼ŒæŸä¸ªä¾èµ–çš„é˜»å¡ï¼Œä¼šå¯¼è‡´ä¸Šæ¸¸æœåŠ¡è¯·æ±‚è¢«é˜»å¡ã€‚å½“è¿™ç§çº§è”æ•…éšœæ„ˆæ¼”æ„ˆçƒˆï¼Œå°±å¯èƒ½é€ æˆæ•´ä¸ªçº¿ä¸ŠæœåŠ¡ä¸å¯ç”¨çš„é›ªå´©æ•ˆåº”ï¼Œå¦‚ä¸‹å›¾ã€‚è¿™ç§æƒ…å†µè‹¥æŒç»­æ¶åŒ–ï¼Œå¦‚æœä¸Šæ¸¸æœåŠ¡æœ¬èº«è¿˜è¢«å…¶ä»–æœåŠ¡æ‰€ä¾èµ–ï¼Œå°±å¯èƒ½å‡ºç°å¤šç±³æ´›éª¨ç‰Œæ•ˆåº”ï¼Œå¯¼è‡´å¤šä¸ªæœåŠ¡éƒ½æ— æ³•æ­£å¸¸å·¥ä½œã€‚</p>
<p><img src="https://github.com/Netflix/Hystrix/wiki/images/soa-3-640.png" alt="img"></p>
<p>å›¾ç‰‡æ¥è‡ª <a target="_blank" rel="noopener" href="https://github.com/Netflix/Hystrix/wiki">Hystrix Wiki</a></p>
<h3 id="æµé‡æ§åˆ¶æœ‰å“ªäº›ä¿æŠ¤æœºåˆ¶"><a href="#æµé‡æ§åˆ¶æœ‰å“ªäº›ä¿æŠ¤æœºåˆ¶" class="headerlink" title="æµé‡æ§åˆ¶æœ‰å“ªäº›ä¿æŠ¤æœºåˆ¶"></a>æµé‡æ§åˆ¶æœ‰å“ªäº›ä¿æŠ¤æœºåˆ¶</h3><p>æµé‡æ§åˆ¶å¸¸è§çš„æ‰‹æ®µå°±æ˜¯é™æµã€ç†”æ–­ã€é™çº§ã€‚</p>
<h4 id="ä»€ä¹ˆæ˜¯é™çº§ï¼Ÿ"><a href="#ä»€ä¹ˆæ˜¯é™çº§ï¼Ÿ" class="headerlink" title="ä»€ä¹ˆæ˜¯é™çº§ï¼Ÿ"></a>ä»€ä¹ˆæ˜¯é™çº§ï¼Ÿ</h4><p><strong>é™çº§</strong>æ˜¯ä¿éšœæœåŠ¡èƒ½å¤Ÿç¨³å®šè¿è¡Œçš„ä¸€ç§ä¿æŠ¤æ–¹å¼ï¼šé¢å¯¹çªå¢çš„æµé‡ï¼Œç‰ºç‰²ä¸€äº›ååé‡ä»¥æ¢å–ç³»ç»Ÿçš„ç¨³å®šã€‚å¸¸è§çš„é™çº§å®ç°æ–¹å¼æœ‰ï¼šå¼€å…³é™çº§ã€é™æµé™çº§ã€ç†”æ–­é™çº§ã€‚</p>
<h4 id="ä»€ä¹ˆæ˜¯é™æµï¼Ÿ"><a href="#ä»€ä¹ˆæ˜¯é™æµï¼Ÿ" class="headerlink" title="ä»€ä¹ˆæ˜¯é™æµï¼Ÿ"></a>ä»€ä¹ˆæ˜¯é™æµï¼Ÿ</h4><p>é™æµä¸€èˆ¬é’ˆå¯¹ä¸‹æ¸¸æœåŠ¡ï¼Œå½“ä¸Šæ¸¸æµé‡è¾ƒå¤§æ—¶ï¼Œé¿å…è¢«ä¸Šæ¸¸æœåŠ¡çš„è¯·æ±‚æ’‘çˆ†ã€‚</p>
<p><strong>é™æµ</strong>å°±æ˜¯é™åˆ¶ç³»ç»Ÿçš„è¾“å…¥å’Œè¾“å‡ºæµé‡ï¼Œä»¥è¾¾åˆ°ä¿æŠ¤ç³»ç»Ÿçš„ç›®çš„ã€‚ä¸€èˆ¬æ¥è¯´ç³»ç»Ÿçš„ååé‡æ˜¯å¯ä»¥è¢«æµ‹ç®—çš„ï¼Œä¸ºäº†ä¿è¯ç³»ç»Ÿçš„ç¨³å®šè¿è¡Œï¼Œä¸€æ—¦è¾¾åˆ°çš„éœ€è¦é™åˆ¶çš„é˜ˆå€¼ï¼Œå°±éœ€è¦é™åˆ¶æµé‡å¹¶é‡‡å–ä¸€äº›æªæ–½ä»¥å®Œæˆé™åˆ¶æµé‡çš„ç›®çš„ã€‚æ¯”å¦‚ï¼šå»¶è¿Ÿå¤„ç†ï¼Œæ‹’ç»å¤„ç†ï¼Œæˆ–è€…éƒ¨åˆ†æ‹’ç»å¤„ç†ç­‰ç­‰ã€‚</p>
<p>é™æµè§„åˆ™åŒ…å«ä¸‰ä¸ªéƒ¨åˆ†ï¼šæ—¶é—´ç²’åº¦ï¼Œæ¥å£ç²’åº¦ï¼Œæœ€å¤§é™æµå€¼ã€‚é™æµè§„åˆ™è®¾ç½®æ˜¯å¦åˆç†ç›´æ¥å½±å“åˆ°é™æµæ˜¯å¦åˆç†æœ‰æ•ˆã€‚</p>
<h4 id="ä»€ä¹ˆæ˜¯ç†”æ–­ï¼Ÿ"><a href="#ä»€ä¹ˆæ˜¯ç†”æ–­ï¼Ÿ" class="headerlink" title="ä»€ä¹ˆæ˜¯ç†”æ–­ï¼Ÿ"></a>ä»€ä¹ˆæ˜¯ç†”æ–­ï¼Ÿ</h4><p>ç†”æ–­ä¸€èˆ¬é’ˆå¯¹ä¸Šæ¸¸æœåŠ¡ï¼Œå½“ä¸‹æ¸¸æœåŠ¡è¶…æ—¶&#x2F;å¼‚å¸¸è¾ƒå¤šæ—¶ï¼Œé¿å…è¢«ä¸‹æ¸¸æœåŠ¡æ‹–å®ã€‚</p>
<p>å½“è°ƒç”¨é“¾è·¯ä¸­æŸä¸ªèµ„æºå‡ºç°ä¸ç¨³å®šï¼Œä¾‹å¦‚ï¼Œè¶…æ—¶å¼‚å¸¸æ¯”ä¾‹å‡é«˜çš„æ—¶å€™ï¼Œåˆ™å¯¹è¿™ä¸ªèµ„æºçš„è°ƒç”¨è¿›è¡Œé™åˆ¶ï¼Œå¹¶è®©è¯·æ±‚å¿«é€Ÿå¤±è´¥ï¼Œé¿å…å½±å“åˆ°å…¶å®ƒçš„èµ„æºï¼Œæœ€ç»ˆäº§ç”Ÿé›ªå´©çš„æ•ˆæœã€‚</p>
<p>ç†”æ–­å°½æœ€å¤§çš„å¯èƒ½å»å®Œæˆæ‰€æœ‰çš„è¯·æ±‚ï¼Œå®¹å¿ä¸€äº›å¤±è´¥ï¼Œç†”æ–­ä¹Ÿèƒ½è‡ªåŠ¨æ¢å¤ã€‚ç†”æ–­çš„å¸¸è§ç­–ç•¥æœ‰ï¼š</p>
<ul>
<li>åœ¨æ¯ç§’è¯·æ±‚å¼‚å¸¸æ•°è¶…è¿‡å¤šå°‘æ—¶è§¦å‘ç†”æ–­é™çº§</li>
<li>åœ¨æ¯ç§’è¯·æ±‚å¼‚å¸¸é”™è¯¯ç‡è¶…è¿‡å¤šå°‘æ—¶è§¦å‘ç†”æ–­é™çº§</li>
<li>åœ¨æ¯ç§’è¯·æ±‚å¹³å‡è€—æ—¶è¶…è¿‡å¤šå°‘æ—¶è§¦å‘ç†”æ–­é™çº§</li>
</ul>
<h3 id="æµé‡æ§åˆ¶æœ‰å“ªäº›è¡¡é‡æŒ‡æ ‡"><a href="#æµé‡æ§åˆ¶æœ‰å“ªäº›è¡¡é‡æŒ‡æ ‡" class="headerlink" title="æµé‡æ§åˆ¶æœ‰å“ªäº›è¡¡é‡æŒ‡æ ‡"></a>æµé‡æ§åˆ¶æœ‰å“ªäº›è¡¡é‡æŒ‡æ ‡</h3><p>æµé‡æ§åˆ¶æœ‰ä»¥ä¸‹å‡ ä¸ªè§’åº¦ï¼š</p>
<ul>
<li>æµé‡æŒ‡æ ‡ï¼Œä¾‹å¦‚ QPSã€å¹¶å‘çº¿ç¨‹æ•°ç­‰ã€‚</li>
<li>èµ„æºçš„è°ƒç”¨å…³ç³»ï¼Œä¾‹å¦‚èµ„æºçš„è°ƒç”¨é“¾è·¯ï¼Œèµ„æºå’Œèµ„æºä¹‹é—´çš„å…³ç³»ï¼Œè°ƒç”¨æ¥æºç­‰ã€‚</li>
<li>æ§åˆ¶æ•ˆæœï¼Œä¾‹å¦‚æ’é˜Ÿç­‰å¾…ã€ç›´æ¥æ‹’ç»ã€Warm Upï¼ˆé¢„çƒ­ï¼‰ç­‰ã€‚</li>
</ul>
<h2 id="é™æµç®—æ³•"><a href="#é™æµç®—æ³•" class="headerlink" title="é™æµç®—æ³•"></a>é™æµç®—æ³•</h2><p>é™æµçš„æœ¬è´¨æ˜¯ï¼šåœ¨ä¸€å®šçš„æ—¶é—´èŒƒå›´å†…ï¼Œé™åˆ¶æŸä¸€ä¸ªèµ„æºè¢«è®¿é—®çš„é¢‘ç‡ã€‚å¦‚ä½•å»é™åˆ¶æµé‡ï¼Œå°±éœ€è¦é‡‡ç”¨ä¸€å®šçš„ç­–ç•¥ï¼Œå³é™æµç®—æ³•ã€‚å¸¸è§çš„é™æµç®—æ³•æœ‰ï¼šå›ºå®šçª—å£é™æµç®—æ³•ã€æ»‘åŠ¨çª—å£é™æµç®—æ³•ã€æ¼æ¡¶é™æµç®—æ³•ã€ä»¤ç‰Œæ¡¶é™æµç®—æ³•ã€‚</p>
<p>ä¸‹é¢ï¼Œå°†å¯¹è¿™å‡ ç§ç®—æ³•è¿›è¡Œä¸€ä¸€ä»‹ç»ã€‚</p>
<h3 id="å›ºå®šçª—å£é™æµç®—æ³•"><a href="#å›ºå®šçª—å£é™æµç®—æ³•" class="headerlink" title="å›ºå®šçª—å£é™æµç®—æ³•"></a>å›ºå®šçª—å£é™æµç®—æ³•</h3><h4 id="å›ºå®šçª—å£é™æµç®—æ³•çš„åŸç†"><a href="#å›ºå®šçª—å£é™æµç®—æ³•çš„åŸç†" class="headerlink" title="å›ºå®šçª—å£é™æµç®—æ³•çš„åŸç†"></a>å›ºå®šçª—å£é™æµç®—æ³•çš„åŸç†</h4><p>å›ºå®šçª—å£é™æµç®—æ³•çš„<strong>åŸºæœ¬ç­–ç•¥</strong>æ˜¯ï¼š</p>
<ol>
<li>è®¾ç½®ä¸€ä¸ªå›ºå®šæ—¶é—´çª—å£ï¼Œä»¥åŠè¿™ä¸ªå›ºå®šæ—¶é—´çª—å£å†…çš„æœ€å¤§è¯·æ±‚æ•°ï¼›</li>
<li>ä¸ºæ¯ä¸ªå›ºå®šæ—¶é—´çª—å£è®¾ç½®ä¸€ä¸ªè®¡æ•°å™¨ï¼Œç”¨äºç»Ÿè®¡è¯·æ±‚æ•°ï¼›</li>
<li>ä¸€æ—¦è¯·æ±‚æ•°è¶…è¿‡æœ€å¤§è¯·æ±‚æ•°ï¼Œåˆ™è¯·æ±‚ä¼šè¢«æ‹¦æˆªã€‚</li>
</ol>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/202401230748006.png" alt="img"></p>
<h4 id="å›ºå®šçª—å£é™æµç®—æ³•çš„åˆ©å¼Š"><a href="#å›ºå®šçª—å£é™æµç®—æ³•çš„åˆ©å¼Š" class="headerlink" title="å›ºå®šçª—å£é™æµç®—æ³•çš„åˆ©å¼Š"></a>å›ºå®šçª—å£é™æµç®—æ³•çš„åˆ©å¼Š</h4><p>å›ºå®šçª—å£é™æµç®—æ³•çš„<strong>ä¼˜ç‚¹</strong>æ˜¯ï¼šå®ç°ç®€å•ã€‚</p>
<p>å›ºå®šçª—å£é™æµç®—æ³•çš„<strong>ç¼ºç‚¹</strong>æ˜¯ï¼šå­˜åœ¨<strong>ä¸´ç•Œé—®é¢˜</strong>ã€‚æ‰€è°“ä¸´ç•Œé—®é¢˜ï¼Œæ˜¯æŒ‡ï¼šæµé‡åˆ†åˆ«é›†ä¸­åœ¨ä¸€ä¸ªå›ºå®šæ—¶é—´çª—å£çš„å°¾éƒ¨å’Œä¸€ä¸ªå›ºå®šæ—¶é—´çª—å£çš„å¤´éƒ¨ã€‚ä¸¾ä¾‹æ¥è¯´ï¼Œå‡è®¾é™æµè§„åˆ™ä¸ºæ¯åˆ†é’Ÿä¸è¶…è¿‡ 100 æ¬¡è¯·æ±‚ã€‚åœ¨ç¬¬ä¸€ä¸ªæ—¶é—´çª—å£ä¸­ï¼Œèµ·åˆæ²¡æœ‰ä»»ä½•è¯·æ±‚ï¼Œåœ¨æœ€å 1 sï¼Œæ”¶åˆ° 100 æ¬¡è¯·æ±‚ï¼Œç”±äºæ²¡æœ‰è¾¾åˆ°é˜ˆå€¼ï¼Œæ‰€æœ‰è¯·æ±‚éƒ½é€šè¿‡ï¼›åœ¨ç¬¬äºŒä¸ªæ—¶é—´çª—å£ä¸­ï¼Œç¬¬ 1 ç§’å°±æ”¶åˆ° 100 æ¬¡è¯·æ±‚ï¼Œè€Œåç»­æ²¡æœ‰ä»»ä½•è¯·æ±‚ã€‚è™½ç„¶ï¼Œè¿™ä¸¤ä¸ªæ—¶é—´çª—å£å†…çš„æµé‡éƒ½ç¬¦åˆé™æµè¦æ±‚ï¼Œä½†æ˜¯åœ¨ä¸¤ä¸ªæ—¶é—´çª—å£ä¸´ç•Œçš„è¿™ 2s å†…ï¼Œå®é™…ä¸Šæœ‰ 200 æ¬¡è¯·æ±‚ï¼Œæ˜¾ç„¶æ˜¯è¶…è¿‡é¢„æœŸååé‡çš„ï¼Œå­˜åœ¨å‹å®ç³»ç»Ÿçš„å¯èƒ½ã€‚</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/202401230748769.png" alt="img"></p>
<h4 id="å›ºå®šçª—å£é™æµç®—æ³•çš„å®ç°"><a href="#å›ºå®šçª—å£é™æµç®—æ³•çš„å®ç°" class="headerlink" title="å›ºå®šçª—å£é™æµç®—æ³•çš„å®ç°"></a>å›ºå®šçª—å£é™æµç®—æ³•çš„å®ç°</h4><p>:::details Java ç‰ˆæœ¬çš„å›ºå®šçª—å£é™æµç®—æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicLong;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SlidingWindowRateLimiter</span> <span class="keyword">implements</span> <span class="title class_">RateLimiter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å…è®¸çš„æœ€å¤§è¯·æ±‚æ•°</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">long</span> maxPermits;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * çª—å£æœŸæ—¶é•¿</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> periodMillis;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åˆ†ç‰‡çª—å£æœŸæ—¶é•¿</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">long</span> shardPeriodMillis;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * çª—å£æœŸæˆªæ­¢æ—¶é—´</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> lastPeriodMillis;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åˆ†ç‰‡çª—å£æ•°</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> shardNum;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è¯·æ±‚æ€»è®¡æ•°</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">AtomicLong</span> <span class="variable">totalCount</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicLong</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åˆ†ç‰‡çª—å£è®¡æ•°åˆ—è¡¨</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;AtomicLong&gt; countList = <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SlidingWindowRateLimiter</span><span class="params">(<span class="type">long</span> qps, <span class="type">int</span> shardNum)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>(qps, <span class="number">1000</span>, TimeUnit.MILLISECONDS, shardNum);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SlidingWindowRateLimiter</span><span class="params">(<span class="type">long</span> maxPermits, <span class="type">long</span> period, TimeUnit timeUnit, <span class="type">int</span> shardNum)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.maxPermits = maxPermits;</span><br><span class="line">        <span class="built_in">this</span>.periodMillis = timeUnit.toMillis(period);</span><br><span class="line">        <span class="built_in">this</span>.lastPeriodMillis = System.currentTimeMillis();</span><br><span class="line">        <span class="built_in">this</span>.shardPeriodMillis = timeUnit.toMillis(period) / shardNum;</span><br><span class="line">        <span class="built_in">this</span>.shardNum = shardNum;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; shardNum; i++) &#123;</span><br><span class="line">            countList.add(<span class="keyword">new</span> <span class="title class_">AtomicLong</span>(<span class="number">0</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="type">boolean</span> <span class="title function_">tryAcquire</span><span class="params">(<span class="type">int</span> <span class="keyword">permits</span>)</span> &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">now</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="keyword">if</span> (now &gt; lastPeriodMillis) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">shardId</span> <span class="operator">=</span> <span class="number">0</span>; shardId &lt; shardNum; shardId++) &#123;</span><br><span class="line">                <span class="type">long</span> <span class="variable">shardCount</span> <span class="operator">=</span> countList.get(shardId).get();</span><br><span class="line">                totalCount.addAndGet(-shardCount);</span><br><span class="line">                countList.set(shardId, <span class="keyword">new</span> <span class="title class_">AtomicLong</span>(<span class="number">0</span>));</span><br><span class="line">                lastPeriodMillis += shardPeriodMillis;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">int</span> <span class="variable">shardId</span> <span class="operator">=</span> (<span class="type">int</span>) (now % periodMillis / shardPeriodMillis);</span><br><span class="line">        <span class="keyword">if</span> (totalCount.get() + <span class="keyword">permits</span> &lt;= maxPermits) &#123;</span><br><span class="line">            countList.get(shardId).addAndGet(<span class="keyword">permits</span>);</span><br><span class="line">            totalCount.addAndGet(<span class="keyword">permits</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>:::</p>
<h3 id="æ»‘åŠ¨çª—å£é™æµç®—æ³•"><a href="#æ»‘åŠ¨çª—å£é™æµç®—æ³•" class="headerlink" title="æ»‘åŠ¨çª—å£é™æµç®—æ³•"></a>æ»‘åŠ¨çª—å£é™æµç®—æ³•</h3><h4 id="æ»‘åŠ¨çª—å£é™æµç®—æ³•çš„åŸç†"><a href="#æ»‘åŠ¨çª—å£é™æµç®—æ³•çš„åŸç†" class="headerlink" title="æ»‘åŠ¨çª—å£é™æµç®—æ³•çš„åŸç†"></a>æ»‘åŠ¨çª—å£é™æµç®—æ³•çš„åŸç†</h4><p>æ»‘åŠ¨çª—å£é™æµç®—æ³•æ˜¯å¯¹å›ºå®šçª—å£é™æµç®—æ³•çš„æ”¹è¿›ï¼Œè§£å†³äº†ä¸´ç•Œé—®é¢˜ã€‚</p>
<p>æ»‘åŠ¨çª—å£é™æµç®—æ³•çš„<strong>åŸºæœ¬ç­–ç•¥</strong>æ˜¯ï¼š</p>
<ul>
<li>å°†å›ºå®šæ—¶é—´çª—å£åˆ†ç‰‡ä¸ºå¤šä¸ªå­çª—å£ï¼Œæ¯ä¸ªå­çª—å£çš„è®¿é—®æ¬¡æ•°ç‹¬ç«‹ç»Ÿè®¡ï¼›</li>
<li>å½“è¯·æ±‚æ—¶é—´å¤§äºå½“å‰å­çª—å£çš„æœ€å¤§æ—¶é—´æ—¶ï¼Œåˆ™å°†å½“å‰å­çª—å£åºŸå¼ƒï¼Œå¹¶å°†è®¡æ—¶çª—å£å‘å‰æ»‘åŠ¨ï¼Œå¹¶å°†ä¸‹ä¸€ä¸ªå­çª—å£ç½®ä¸ºå½“å‰çª—å£ã€‚</li>
<li>è¦ä¿è¯æ‰€æœ‰å­çª—å£çš„ç»Ÿè®¡æ•°ä¹‹å’Œä¸èƒ½è¶…è¿‡é˜ˆå€¼ã€‚</li>
</ul>
<p>æ»‘åŠ¨çª—å£é™æµç®—æ³•å°±æ˜¯é’ˆå¯¹å›ºå®šçª—å£é™æµç®—æ³•çš„æ›´ç»†ç²’åº¦çš„æ§åˆ¶ï¼Œåˆ†ç‰‡è¶Šå¤šï¼Œåˆ™é™æµè¶Šç²¾å‡†ã€‚</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/202401230748277.png" alt="img"></p>
<h4 id="æ»‘åŠ¨çª—å£é™æµç®—æ³•çš„åˆ©å¼Š"><a href="#æ»‘åŠ¨çª—å£é™æµç®—æ³•çš„åˆ©å¼Š" class="headerlink" title="æ»‘åŠ¨çª—å£é™æµç®—æ³•çš„åˆ©å¼Š"></a>æ»‘åŠ¨çª—å£é™æµç®—æ³•çš„åˆ©å¼Š</h4><p>æ»‘åŠ¨çª—å£é™æµç®—æ³•çš„<strong>ä¼˜ç‚¹</strong>æ˜¯ï¼šåœ¨æ»‘åŠ¨çª—å£é™æµç®—æ³•ä¸­ï¼Œä¸´ç•Œä½ç½®çš„çªå‘è¯·æ±‚éƒ½ä¼šè¢«ç®—åˆ°æ—¶é—´çª—å£å†…ï¼Œå› æ­¤å¯ä»¥è§£å†³è®¡æ•°å™¨ç®—æ³•çš„ä¸´ç•Œé—®é¢˜ã€‚</p>
<p>æ»‘åŠ¨çª—å£é™æµç®—æ³•çš„<strong>ç¼ºç‚¹</strong>æ˜¯ï¼š</p>
<ul>
<li><strong>é¢å¤–çš„å†…å­˜å¼€é”€</strong> - æ»‘åŠ¨æ—¶é—´çª—å£é™æµç®—æ³•çš„æ—¶é—´çª—å£æ˜¯æŒç»­æ»‘åŠ¨çš„ï¼Œå¹¶ä¸”é™¤äº†éœ€è¦ä¸€ä¸ªè®¡æ•°å™¨æ¥è®°å½•æ—¶é—´çª—å£å†…æ¥å£è¯·æ±‚æ¬¡æ•°ä¹‹å¤–ï¼Œè¿˜éœ€è¦è®°å½•åœ¨æ—¶é—´çª—å£å†…æ¯ä¸ªæ¥å£è¯·æ±‚åˆ°è¾¾çš„æ—¶é—´ç‚¹ï¼Œæ‰€ä»¥å­˜åœ¨é¢å¤–çš„å†…å­˜å¼€é”€ã€‚</li>
<li><strong>é™æµçš„æ§åˆ¶ç²’åº¦å—é™äºçª—å£åˆ†ç‰‡ç²’åº¦</strong> - æ»‘åŠ¨çª—å£é™æµç®—æ³•ï¼Œ<strong>åªèƒ½åœ¨é€‰å®šçš„æ—¶é—´ç²’åº¦ä¸Šé™æµï¼Œå¯¹é€‰å®šæ—¶é—´ç²’åº¦å†…çš„æ›´åŠ ç»†ç²’åº¦çš„è®¿é—®é¢‘ç‡ä¸åšé™åˆ¶</strong>ã€‚ä½†æ˜¯ï¼Œç”±äºæ¯ä¸ªåˆ†ç‰‡çª—å£éƒ½æœ‰é¢å¤–çš„å†…å­˜å¼€é”€ï¼Œæ‰€ä»¥ä¹Ÿå¹¶ä¸æ˜¯åˆ†ç‰‡æ•°è¶Šå¤šè¶Šå¥½çš„ã€‚</li>
</ul>
<h4 id="æ»‘åŠ¨çª—å£é™æµç®—æ³•çš„å®ç°"><a href="#æ»‘åŠ¨çª—å£é™æµç®—æ³•çš„å®ç°" class="headerlink" title="æ»‘åŠ¨çª—å£é™æµç®—æ³•çš„å®ç°"></a>æ»‘åŠ¨çª—å£é™æµç®—æ³•çš„å®ç°</h4><p>:::details Java ç‰ˆæœ¬çš„æ»‘åŠ¨çª—å£é™æµç®—æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.LinkedList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicLong;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SlidingWindowRateLimiter</span> <span class="keyword">implements</span> <span class="title class_">RateLimiter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å…è®¸çš„æœ€å¤§è¯·æ±‚æ•°</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">long</span> maxPermits;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * çª—å£æœŸæ—¶é•¿</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">long</span> periodMillis;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åˆ†ç‰‡çª—å£æœŸæ—¶é•¿</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">long</span> shardPeriodMillis;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * çª—å£æœŸæˆªæ­¢æ—¶é—´</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> lastPeriodMillis;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åˆ†ç‰‡çª—å£æ•°</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> shardNum;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è¯·æ±‚æ€»è®¡æ•°</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">AtomicLong</span> <span class="variable">totalCount</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicLong</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åˆ†ç‰‡çª—å£è®¡æ•°åˆ—è¡¨</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;AtomicLong&gt; countList = <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SlidingWindowRateLimiter</span><span class="params">(<span class="type">long</span> qps, <span class="type">int</span> shardNum)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>(qps, <span class="number">1000</span>, TimeUnit.MILLISECONDS, shardNum);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SlidingWindowRateLimiter</span><span class="params">(<span class="type">long</span> maxPermits, <span class="type">long</span> period, TimeUnit timeUnit, <span class="type">int</span> shardNum)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.maxPermits = maxPermits;</span><br><span class="line">        <span class="built_in">this</span>.periodMillis = timeUnit.toMillis(period);</span><br><span class="line">        <span class="built_in">this</span>.lastPeriodMillis = System.currentTimeMillis();</span><br><span class="line">        <span class="built_in">this</span>.shardPeriodMillis = timeUnit.toMillis(period) / shardNum;</span><br><span class="line">        <span class="built_in">this</span>.shardNum = shardNum;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; shardNum; i++) &#123;</span><br><span class="line">            countList.add(<span class="keyword">new</span> <span class="title class_">AtomicLong</span>(<span class="number">0</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="type">boolean</span> <span class="title function_">tryAcquire</span><span class="params">(<span class="type">int</span> <span class="keyword">permits</span>)</span> &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">now</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="keyword">if</span> (now &gt; lastPeriodMillis) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">shardId</span> <span class="operator">=</span> <span class="number">0</span>; shardId &lt; shardNum; shardId++) &#123;</span><br><span class="line">                <span class="type">long</span> <span class="variable">shardCount</span> <span class="operator">=</span> countList.get(shardId).get();</span><br><span class="line">                totalCount.addAndGet(-shardCount);</span><br><span class="line">                countList.set(shardId, <span class="keyword">new</span> <span class="title class_">AtomicLong</span>(<span class="number">0</span>));</span><br><span class="line">                lastPeriodMillis += shardPeriodMillis;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">int</span> <span class="variable">shardId</span> <span class="operator">=</span> (<span class="type">int</span>) (now % periodMillis / shardPeriodMillis);</span><br><span class="line">        <span class="keyword">if</span> (totalCount.get() + <span class="keyword">permits</span> &lt;= maxPermits) &#123;</span><br><span class="line">            countList.get(shardId).addAndGet(<span class="keyword">permits</span>);</span><br><span class="line">            totalCount.addAndGet(<span class="keyword">permits</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>:::</p>
<h3 id="æ¼æ¡¶é™æµç®—æ³•"><a href="#æ¼æ¡¶é™æµç®—æ³•" class="headerlink" title="æ¼æ¡¶é™æµç®—æ³•"></a>æ¼æ¡¶é™æµç®—æ³•</h3><h4 id="æ¼æ¡¶é™æµç®—æ³•çš„åŸç†"><a href="#æ¼æ¡¶é™æµç®—æ³•çš„åŸç†" class="headerlink" title="æ¼æ¡¶é™æµç®—æ³•çš„åŸç†"></a>æ¼æ¡¶é™æµç®—æ³•çš„åŸç†</h4><p>æ¼æ¡¶é™æµç®—æ³•çš„<strong>åŸºæœ¬ç­–ç•¥</strong>æ˜¯ï¼š</p>
<ul>
<li>æ°´ï¼ˆè¯·æ±‚ï¼‰ä»¥ä»»æ„é€Ÿç‡ç”±å…¥å£è¿›å…¥åˆ°æ¼æ¡¶ä¸­ï¼›</li>
<li>æ°´ä»¥å›ºå®šçš„é€Ÿç‡ç”±å‡ºå£å‡ºæ°´ï¼ˆè¯·æ±‚é€šè¿‡ï¼‰ï¼›</li>
<li>æ¼æ¡¶çš„å®¹é‡æ˜¯å›ºå®šçš„ï¼Œå¦‚æœæ°´çš„æµå…¥é€Ÿç‡å¤§äºæµå‡ºé€Ÿç‡ï¼Œæœ€ç»ˆä¼šå¯¼è‡´æ¼æ¡¶ä¸­çš„æ°´æº¢å‡ºï¼ˆè¿™æ„å‘³ç€è¯·æ±‚æ‹’ç»ï¼‰ã€‚</li>
</ul>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/202401230749486.png" alt="img"></p>
<h4 id="æ¼æ¡¶é™æµç®—æ³•çš„åˆ©å¼Š"><a href="#æ¼æ¡¶é™æµç®—æ³•çš„åˆ©å¼Š" class="headerlink" title="æ¼æ¡¶é™æµç®—æ³•çš„åˆ©å¼Š"></a>æ¼æ¡¶é™æµç®—æ³•çš„åˆ©å¼Š</h4><p>æ¼æ¡¶é™æµç®—æ³•çš„<strong>ä¼˜ç‚¹</strong>æ˜¯ï¼š<strong>æµé‡é€Ÿç‡å›ºå®š</strong>â€”â€”å³æ— è®ºæµé‡å¤šå¤§ï¼Œå³ä¾¿æ˜¯çªå‘çš„å¤§æµé‡ï¼Œå¤„ç†è¯·æ±‚çš„é€Ÿåº¦å§‹ç»ˆæ˜¯å›ºå®šçš„ã€‚</p>
<p>æ¼æ¡¶é™æµç®—æ³•çš„<strong>ç¼ºç‚¹</strong>æ˜¯ï¼šä¸èƒ½çµæ´»çš„è°ƒæ•´æµé‡ã€‚ä¾‹å¦‚ï¼šä¸€ä¸ªé›†ç¾¤é€šè¿‡å¢å‡èŠ‚ç‚¹çš„æ–¹å¼ï¼Œå¼¹æ€§ä¼¸ç¼©äº†å…¶ååèƒ½åŠ›ï¼Œæ¼æ¡¶é™æµç®—æ³•æ— æ³•éšä¹‹è°ƒæ•´ã€‚</p>
<p><strong>æ¼æ¡¶ç­–ç•¥é€‚ç”¨äºé—´éš”æ€§çªå‘æµé‡ä¸”æµé‡ä¸ç”¨å³æ—¶å¤„ç†çš„åœºæ™¯</strong>ã€‚</p>
<h4 id="æ¼æ¡¶é™æµç®—æ³•çš„å®ç°"><a href="#æ¼æ¡¶é™æµç®—æ³•çš„å®ç°" class="headerlink" title="æ¼æ¡¶é™æµç®—æ³•çš„å®ç°"></a>æ¼æ¡¶é™æµç®—æ³•çš„å®ç°</h4><p>:::details Java ç‰ˆæœ¬çš„æ¼æ¡¶é™æµç®—æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicLong;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LeakyBucketRateLimiter</span> <span class="keyword">implements</span> <span class="title class_">RateLimiter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * QPS</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> qps;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ¡¶çš„å®¹é‡</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">long</span> capacity;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è®¡ç®—çš„èµ·å§‹æ—¶é—´</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> beginTimeMillis;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ¡¶ä¸­å½“å‰çš„æ°´é‡</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">AtomicLong</span> <span class="variable">waterNum</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicLong</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">LeakyBucketRateLimiter</span><span class="params">(<span class="type">int</span> qps, <span class="type">int</span> capacity)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.qps = qps;</span><br><span class="line">        <span class="built_in">this</span>.capacity = capacity;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="type">boolean</span> <span class="title function_">tryAcquire</span><span class="params">(<span class="type">int</span> <span class="keyword">permits</span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¦‚æœæ¡¶ä¸­æ²¡æœ‰æ°´ï¼Œç›´æ¥é€šè¿‡</span></span><br><span class="line">        <span class="keyword">if</span> (waterNum.get() == <span class="number">0</span>) &#123;</span><br><span class="line">            beginTimeMillis = System.currentTimeMillis();</span><br><span class="line">            waterNum.addAndGet(<span class="keyword">permits</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è®¡ç®—æ°´é‡</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">leakedWaterNum</span> <span class="operator">=</span> ((System.currentTimeMillis() - beginTimeMillis) / <span class="number">1000</span>) * qps;</span><br><span class="line">        <span class="type">long</span> <span class="variable">currentWaterNum</span> <span class="operator">=</span> waterNum.get() - leakedWaterNum;</span><br><span class="line">        waterNum.set(Math.max(<span class="number">0</span>, currentWaterNum));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// é‡ç½®æ—¶é—´</span></span><br><span class="line">        beginTimeMillis = System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (waterNum.get() + <span class="keyword">permits</span> &lt; capacity) &#123;</span><br><span class="line">            waterNum.addAndGet(<span class="keyword">permits</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>:::</p>
<h3 id="ä»¤ç‰Œæ¡¶é™æµç®—æ³•"><a href="#ä»¤ç‰Œæ¡¶é™æµç®—æ³•" class="headerlink" title="ä»¤ç‰Œæ¡¶é™æµç®—æ³•"></a>ä»¤ç‰Œæ¡¶é™æµç®—æ³•</h3><h4 id="ä»¤ç‰Œæ¡¶é™æµç®—æ³•çš„åŸç†"><a href="#ä»¤ç‰Œæ¡¶é™æµç®—æ³•çš„åŸç†" class="headerlink" title="ä»¤ç‰Œæ¡¶é™æµç®—æ³•çš„åŸç†"></a>ä»¤ç‰Œæ¡¶é™æµç®—æ³•çš„åŸç†</h4><p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/202401230750231.png" alt="img"></p>
<p>ä»¤ç‰Œæ¡¶ç®—æ³•çš„<strong>åŸç†</strong>ï¼š</p>
<ol>
<li>æ¥å£é™åˆ¶ T ç§’å†…æœ€å¤§è®¿é—®æ¬¡æ•°ä¸º Nï¼Œåˆ™æ¯éš” T&#x2F;N ç§’ä¼šæ”¾ä¸€ä¸ª token åˆ°æ¡¶ä¸­</li>
<li>æ¡¶å†…æœ€å¤šå­˜æ”¾ M ä¸ª tokenï¼Œå¦‚æœ token åˆ°è¾¾æ—¶ä»¤ç‰Œæ¡¶å·²ç»æ»¡äº†ï¼Œé‚£ä¹ˆè¿™ä¸ª token å°±ä¼šè¢«ä¸¢å¼ƒ</li>
<li>æ¥å£è¯·æ±‚ä¼šå…ˆä»ä»¤ç‰Œæ¡¶ä¸­å– tokenï¼Œæ‹¿åˆ° token åˆ™å¤„ç†æ¥å£è¯·æ±‚ï¼Œæ‹¿ä¸åˆ° token åˆ™è¿›è¡Œé™æµå¤„ç†</li>
</ol>
<h4 id="ä»¤ç‰Œæ¡¶é™æµç®—æ³•çš„åˆ©å¼Š"><a href="#ä»¤ç‰Œæ¡¶é™æµç®—æ³•çš„åˆ©å¼Š" class="headerlink" title="ä»¤ç‰Œæ¡¶é™æµç®—æ³•çš„åˆ©å¼Š"></a>ä»¤ç‰Œæ¡¶é™æµç®—æ³•çš„åˆ©å¼Š</h4><p>å› ä¸ºä»¤ç‰Œæ¡¶å­˜æ”¾äº†å¾ˆå¤šä»¤ç‰Œï¼Œé‚£ä¹ˆå¤§é‡çš„çªå‘è¯·æ±‚ä¼šè¢«æ‰§è¡Œï¼Œä½†æ˜¯å®ƒä¸ä¼šå‡ºç°ä¸´ç•Œé—®é¢˜ï¼Œåœ¨ä»¤ç‰Œç”¨å®Œä¹‹åï¼Œä»¤ç‰Œæ˜¯ä»¥ä¸€ä¸ªæ’å®šçš„é€Ÿç‡æ·»åŠ åˆ°ä»¤ç‰Œæ¡¶ä¸­çš„ï¼Œå› æ­¤ä¸èƒ½å†æ¬¡å‘é€å¤§é‡çªå‘è¯·æ±‚ã€‚</p>
<p>è§„å®šå›ºå®šå®¹é‡çš„æ¡¶ï¼Œtoken ä»¥å›ºå®šé€Ÿåº¦å¾€æ¡¶å†…å¡«å……ï¼Œå½“æ¡¶æ»¡æ—¶ token ä¸ä¼šè¢«ç»§ç»­æ”¾å…¥ï¼Œæ¯è¿‡æ¥ä¸€ä¸ªè¯·æ±‚æŠŠ token ä»æ¡¶ä¸­ç§»é™¤ï¼Œå¦‚æœæ¡¶ä¸­æ²¡æœ‰ token ä¸èƒ½è¯·æ±‚ã€‚</p>
<p><strong>ä»¤ç‰Œæ¡¶ç®—æ³•é€‚ç”¨äºæœ‰çªå‘ç‰¹æ€§çš„æµé‡ï¼Œä¸”æµé‡éœ€è¦å³æ—¶å¤„ç†çš„åœºæ™¯</strong>ã€‚</p>
<h4 id="ä»¤ç‰Œæ¡¶é™æµç®—æ³•çš„å®ç°"><a href="#ä»¤ç‰Œæ¡¶é™æµç®—æ³•çš„å®ç°" class="headerlink" title="ä»¤ç‰Œæ¡¶é™æµç®—æ³•çš„å®ç°"></a>ä»¤ç‰Œæ¡¶é™æµç®—æ³•çš„å®ç°</h4><p>:::details Java å®ç°ä»¤ç‰Œæ¡¶ç®—æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicLong;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ä»¤ç‰Œæ¡¶é™æµç®—æ³•</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> &lt;a href=&quot;mailto:forbreak@163.com&quot;&gt;Zhang Peng&lt;/a&gt;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2024-01-18</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TokenBucketRateLimiter</span> <span class="keyword">implements</span> <span class="title class_">RateLimiter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * QPS</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">long</span> qps;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ¡¶çš„å®¹é‡</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">long</span> capacity;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ä¸Šä¸€æ¬¡ä»¤ç‰Œå‘æ”¾æ—¶é—´</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> endTimeMillis;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ¡¶ä¸­å½“å‰çš„ä»¤ç‰Œæ•°é‡</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">AtomicLong</span> <span class="variable">tokenNum</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicLong</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">TokenBucketRateLimiter</span><span class="params">(<span class="type">long</span> qps, <span class="type">long</span> capacity)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.qps = qps;</span><br><span class="line">        <span class="built_in">this</span>.capacity = capacity;</span><br><span class="line">        <span class="built_in">this</span>.endTimeMillis = System.currentTimeMillis();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="type">boolean</span> <span class="title function_">tryAcquire</span><span class="params">(<span class="type">int</span> <span class="keyword">permits</span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">long</span> <span class="variable">now</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="type">long</span> <span class="variable">gap</span> <span class="operator">=</span> now - endTimeMillis;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è®¡ç®—ä»¤ç‰Œæ•°</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">newTokenNum</span> <span class="operator">=</span> (gap * qps / <span class="number">1000</span>);</span><br><span class="line">        <span class="type">long</span> <span class="variable">currentTokenNum</span> <span class="operator">=</span> tokenNum.get() + newTokenNum;</span><br><span class="line">        tokenNum.set(Math.min(capacity, currentTokenNum));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (tokenNum.get() &lt; <span class="keyword">permits</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            tokenNum.addAndGet(-<span class="keyword">permits</span>);</span><br><span class="line">            endTimeMillis = now;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>:::</p>
<blockquote>
<p><strong>æ‰©å±•</strong></p>
<p>Guava çš„ RateLimiter å·¥å…·ç±»å°±æ˜¯åŸºäºä»¤ç‰Œæ¡¶ç®—æ³•å®ç°ï¼Œå…¶æºç åˆ†æå¯ä»¥å‚è€ƒï¼š<a target="_blank" rel="noopener" href="https://blog.csdn.net/forezp/article/details/100060686">RateLimiter åŸºäºæ¼æ¡¶ç®—æ³•ï¼Œä½†å®ƒå‚è€ƒäº†ä»¤ç‰Œæ¡¶ç®—æ³•</a></p>
</blockquote>
<h3 id="é™æµç®—æ³•æµ‹è¯•"><a href="#é™æµç®—æ³•æµ‹è¯•" class="headerlink" title="é™æµç®—æ³•æµ‹è¯•"></a>é™æµç®—æ³•æµ‹è¯•</h3><p>:::details é™æµç®—æ³•æµ‹è¯•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> cn.hutool.core.thread.ThreadUtil;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.util.RandomUtil;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.CountDownLatch;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutorService;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicInteger;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RateLimiterDemo</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ============================================================================</span></span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">qps</span> <span class="operator">=</span> <span class="number">20</span>;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;======================= å›ºå®šæ—¶é—´çª—å£é™æµç®—æ³• =======================&quot;</span>);</span><br><span class="line">        <span class="type">FixedWindowRateLimiter</span> <span class="variable">fixedWindowRateLimiter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FixedWindowRateLimiter</span>(qps);</span><br><span class="line">        testRateLimit(fixedWindowRateLimiter, qps);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;======================= æ»‘åŠ¨æ—¶é—´çª—å£é™æµç®—æ³• =======================&quot;</span>);</span><br><span class="line">        <span class="type">SlidingWindowRateLimiter</span> <span class="variable">slidingWindowRateLimiter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SlidingWindowRateLimiter</span>(qps, <span class="number">10</span>);</span><br><span class="line">        testRateLimit(slidingWindowRateLimiter, qps);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;======================= æ¼æ¡¶é™æµç®—æ³• =======================&quot;</span>);</span><br><span class="line">        <span class="type">LeakyBucketRateLimiter</span> <span class="variable">leakyBucketRateLimiter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LeakyBucketRateLimiter</span>(qps, <span class="number">100</span>);</span><br><span class="line">        testRateLimit(leakyBucketRateLimiter, qps);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;======================= ä»¤ç‰Œæ¡¶é™æµç®—æ³• =======================&quot;</span>);</span><br><span class="line">        <span class="type">TokenBucketRateLimiter</span> <span class="variable">tokenBucketRateLimiter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TokenBucketRateLimiter</span>(qps, <span class="number">100</span>);</span><br><span class="line">        testRateLimit(tokenBucketRateLimiter, qps);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">testRateLimit</span><span class="params">(RateLimiter rateLimiter, <span class="type">int</span> qps)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">AtomicInteger</span> <span class="variable">okNum</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>(<span class="number">0</span>);</span><br><span class="line">        <span class="type">AtomicInteger</span> <span class="variable">limitNum</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>(<span class="number">0</span>);</span><br><span class="line">        <span class="type">ExecutorService</span> <span class="variable">executorService</span> <span class="operator">=</span> ThreadUtil.newFixedExecutor(<span class="number">10</span>, <span class="string">&quot;é™æµæµ‹è¯•&quot;</span>, <span class="literal">true</span>);</span><br><span class="line">        <span class="type">long</span> <span class="variable">beginTime</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">threadNum</span> <span class="operator">=</span> <span class="number">4</span>;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">CountDownLatch</span> <span class="variable">latch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(threadNum);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; threadNum; i++) &#123;</span><br><span class="line">            executorService.submit(() -&gt; &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    batchRequest(rateLimiter, okNum, limitNum, <span class="number">1000</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    log.error(<span class="string">&quot;å‘ç”Ÿå¼‚å¸¸ï¼&quot;</span>, e);</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    latch.countDown();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            latch.await(<span class="number">10</span>, TimeUnit.SECONDS);</span><br><span class="line">            <span class="type">long</span> <span class="variable">endTime</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">            <span class="type">long</span> <span class="variable">gap</span> <span class="operator">=</span> endTime - beginTime;</span><br><span class="line">            log.info(<span class="string">&quot;é™æµ QPS: &#123;&#125; -&gt; å®é™…ç»“æœï¼šè€—æ—¶ &#123;&#125; msï¼Œ&#123;&#125; æ¬¡è¯·æ±‚æˆåŠŸï¼Œ&#123;&#125; æ¬¡è¯·æ±‚è¢«é™æµï¼Œå®é™… QPS: &#123;&#125;&quot;</span>,</span><br><span class="line">                qps, gap, okNum.get(), limitNum.get(), okNum.get() * <span class="number">1000</span> / gap);</span><br><span class="line">            <span class="keyword">if</span> (okNum.get() == qps) &#123;</span><br><span class="line">                log.info(<span class="string">&quot;é™æµç¬¦åˆé¢„æœŸ&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;å‘ç”Ÿå¼‚å¸¸ï¼&quot;</span>, e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            executorService.shutdown();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">batchRequest</span><span class="params">(RateLimiter rateLimiter, AtomicInteger okNum, AtomicInteger limitNum, <span class="type">int</span> num)</span></span><br><span class="line">        <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; num; j++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (rateLimiter.tryAcquire(<span class="number">1</span>)) &#123;</span><br><span class="line">                log.info(<span class="string">&quot;è¯·æ±‚æˆåŠŸ&quot;</span>);</span><br><span class="line">                okNum.getAndIncrement();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                log.info(<span class="string">&quot;è¯·æ±‚é™æµ&quot;</span>);</span><br><span class="line">                limitNum.getAndIncrement();</span><br><span class="line">            &#125;</span><br><span class="line">            TimeUnit.MILLISECONDS.sleep(RandomUtil.randomInt(<span class="number">0</span>, <span class="number">10</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>:::</p>
<h2 id="é™æµæ¡†æ¶-Hystrix"><a href="#é™æµæ¡†æ¶-Hystrix" class="headerlink" title="é™æµæ¡†æ¶ - Hystrix"></a>é™æµæ¡†æ¶ - Hystrix</h2><p>Hystrix æ˜¯ç”± Netflix å¼€æºï¼Œç”¨äºå¤„ç†åˆ†å¸ƒå¼ç³»ç»Ÿçš„å»¶è¿Ÿå’Œå®¹é”™çš„ä¸€ä¸ªå¼€æºç»„ä»¶ã€‚åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿé‡Œï¼Œè®¸å¤šä¾èµ–ä¸å¯é¿å…çš„ä¼šè°ƒç”¨å¤±è´¥ï¼Œæ¯”å¦‚è¶…æ—¶ã€å¼‚å¸¸ç­‰ã€‚Hystrix é‡‡ç”¨<strong>æ–­è·¯å™¨æ¨¡å¼</strong>æ¥å®ç°æœåŠ¡é—´çš„å½¼æ­¤éš”ç¦»ï¼Œä»è€Œé¿å…çº§è”æ•…éšœï¼Œä»¥æé«˜åˆ†å¸ƒå¼ç³»ç»Ÿæ•´ä½“çš„å¼¹æ€§ã€‚</p>
<p>â€œæ–­è·¯å™¨â€æœ¬èº«æ˜¯ä¸€ç§å¼€å…³è£…ç½®ï¼Œå½“æŸä¸ªæœåŠ¡å•å…ƒå‘ç”Ÿæ•…éšœä¹‹åï¼Œé€šè¿‡æ–­è·¯å™¨çš„æ•…éšœç›‘æ§ï¼ˆç±»ä¼¼ç†”æ–­ä¿é™©ä¸ï¼‰ï¼Œ<strong>å‘è°ƒç”¨æ–¹è¿”å›ä¸€ä¸ªç¬¦åˆé¢„æœŸçš„ã€å¯å¤„ç†çš„å¤‡é€‰å“åº”ï¼ˆFallBackï¼‰ï¼Œè€Œä¸æ˜¯é•¿æ—¶é—´çš„ç­‰å¾…æˆ–è€…æŠ›å‡ºè°ƒç”¨æ–¹æ— æ³•å¤„ç†çš„å¼‚å¸¸</strong>ï¼Œè¿™æ ·å°±ä¿è¯äº†æœåŠ¡è°ƒç”¨æ–¹çš„çº¿ç¨‹ä¸ä¼šè¢«é•¿æ—¶é—´ã€ä¸å¿…è¦åœ°å ç”¨ï¼Œä»è€Œé¿å…äº†æ•…éšœåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„è”“å»¶ï¼Œä¹ƒè‡³é›ªå´©ã€‚</p>
<p>Hystrix å®˜æ–¹å·²å®£å¸ƒ<strong>ä¸å†å‘å¸ƒæ–°ç‰ˆæœ¬</strong>ã€‚ä½†æ˜¯ï¼ŒHystrix çš„æ–­è·¯å™¨è®¾è®¡ç†å¿µï¼Œæœ‰éå¸¸é«˜çš„å­¦ä¹ ä»·å€¼ã€‚</p>
<p>å¦‚æœä½¿ç”¨ Hystrix å¯¹æ¯ä¸ªåŸºç¡€ä¾èµ–æœåŠ¡è¿›è¡Œè¿‡è½½ä¿æŠ¤ï¼Œåˆ™æ•´ä¸ªç³»ç»Ÿæ¶æ„å°†ä¼šç±»ä¼¼ä¸‹å›¾æ‰€ç¤ºï¼Œæ¯ä¸ªä¾èµ–é¡¹å½¼æ­¤éš”ç¦»ï¼Œå—åˆ°å»¶è¿Ÿæ—¶å‘ç”Ÿé¥±å’Œçš„èµ„æºçš„è¢«é™åˆ¶è®¿é—®ï¼Œå¹¶åŒ…å« fallback é€»è¾‘ï¼ˆç”¨äºé™çº§å¤„ç†ï¼‰ï¼Œè¯¥é€»è¾‘å†³å®šäº†åœ¨ä¾èµ–é¡¹ä¸­å‘ç”Ÿä»»ä½•ç±»å‹çš„æ•…éšœæ—¶åšå‡ºå¯¹åº”çš„å¤„ç†ã€‚</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/20200717142842.png" alt="img"></p>
<h3 id="Hystrix-åŸç†"><a href="#Hystrix-åŸç†" class="headerlink" title="Hystrix åŸç†"></a>Hystrix åŸç†</h3><p>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼ŒHystrix çš„å·¥ä½œæµç¨‹å¤§è‡´å¯ä»¥åˆ†ä¸º 9 ä¸ªæ­¥éª¤ã€‚</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/20200717143247.png" alt="img"></p>
<p><strong>ï¼ˆä¸€ï¼‰æ„å»ºä¸€ä¸ª HystrixCommand æˆ– HystrixObservableCommand å¯¹è±¡</strong></p>
<p>Hystrix è¿›è¡Œèµ„æºéš”ç¦»ï¼Œå…¶å®æ˜¯æä¾›äº†ä¸€ä¸ªæŠ½è±¡ï¼Œå«åš<strong>å‘½ä»¤æ¨¡å¼</strong>ã€‚è¿™ä¹Ÿæ˜¯ Hystrix æœ€åŸºæœ¬çš„<strong>èµ„æºéš”ç¦»æŠ€æœ¯</strong>ã€‚</p>
<p>åœ¨ä½¿ç”¨ Hystrix çš„è¿‡ç¨‹ä¸­ï¼Œä¼šå¯¹ä¾èµ–æœåŠ¡çš„è°ƒç”¨è¯·æ±‚å°è£…æˆå‘½ä»¤å¯¹è±¡ï¼ŒHystrix å¯¹ å‘½ä»¤å¯¹è±¡æŠ½è±¡äº†ä¸¤ä¸ªæŠ½è±¡ç±»ï¼š<code>HystrixCommand</code> å’Œ <code>HystrixObservableCommand</code> ã€‚</p>
<ul>
<li><code>HystrixCommand</code> è¡¨ç¤ºçš„å‘½ä»¤å¯¹è±¡ä¼šè¿”å›ä¸€ä¸ªå”¯ä¸€è¿”å›å€¼ã€‚</li>
<li><code>HystrixObservableCommand</code> è¡¨ç¤ºçš„å‘½ä»¤å¯¹è±¡ä¼šè¿”å›å¤šä¸ªè¿”å›å€¼ã€‚</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">HystrixCommand</span> <span class="variable">command</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HystrixCommand</span>(arg1, arg2);</span><br><span class="line"><span class="type">HystrixObservableCommand</span> <span class="variable">command</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HystrixObservableCommand</span>(arg1, arg2);</span><br></pre></td></tr></table></figure>

<p><strong>ï¼ˆäºŒï¼‰æ‰§è¡Œå‘½ä»¤</strong></p>
<p>Hystrix ä¸­å…±æœ‰ 4 ç§æ–¹å¼æ‰§è¡Œå‘½ä»¤ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<table>
<thead>
<tr>
<th align="left">æ‰§è¡Œæ–¹å¼</th>
<th align="left">è¯´æ˜</th>
<th align="left">å¯ç”¨å¯¹è±¡</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><a target="_blank" rel="noopener" href="http://netflix.github.io/Hystrix/javadoc/com/netflix/hystrix/HystrixCommand.html#execute()"><code>execute()</code></a></td>
<td align="left">é˜»å¡å¼åŒæ­¥æ‰§è¡Œï¼Œè¿”å›ä¾èµ–æœåŠ¡çš„å•ä¸€è¿”å›ç»“æœï¼ˆæˆ–è€…æŠ›å‡ºå¼‚å¸¸ï¼‰</td>
<td align="left"><code>HystrixCommand</code></td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="http://netflix.github.io/Hystrix/javadoc/com/netflix/hystrix/HystrixCommand.html#queue()"><code>queue()</code></a></td>
<td align="left">å¼‚æ­¥æ‰§è¡Œï¼Œé€šè¿‡ <code>Future</code> è¿”å›ä¾èµ–æœåŠ¡çš„å•ä¸€è¿”å›ç»“æœï¼ˆæˆ–è€…æŠ›å‡ºå¼‚å¸¸ï¼‰</td>
<td align="left"><code>HystrixCommand</code></td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="http://netflix.github.io/Hystrix/javadoc/com/netflix/hystrix/HystrixObservableCommand.html#observe()"><code>observe()</code></a></td>
<td align="left">åŸºäº Rxjava çš„ Observable æ–¹å¼ï¼Œè¿”å›é€šè¿‡ Observable è¡¨ç¤ºçš„ä¾èµ–æœåŠ¡è¿”å›ç»“æœã€‚ä»£è°ƒç”¨ä»£ç å…ˆæ‰§è¡Œ (Hot Obserable)</td>
<td align="left"><code>HystrixObservableCommand</code></td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="http://netflix.github.io/Hystrix/javadoc/com/netflix/hystrix/HystrixObservableCommand.html#toObservable()"><code>toObservable()</code></a></td>
<td align="left">åŸºäº Rxjava çš„ Observable æ–¹å¼ï¼Œè¿”å›é€šè¿‡ Observable è¡¨ç¤ºçš„ä¾èµ–æœåŠ¡è¿”å›ç»“æœã€‚æ‰§è¡Œä»£ç ç­‰åˆ°çœŸæ­£è®¢é˜…çš„æ—¶å€™æ‰ä¼šæ‰§è¡Œ (cold observable)</td>
<td align="left"><code>HystrixObservableCommand</code></td>
</tr>
</tbody></table>
<p>è¿™å››ç§å‘½ä»¤ä¸­ï¼Œ<code>exeucte()</code>ã€<code>queue()</code>ã€<code>observe()</code> çš„è¡¨ç¤ºå…¶å®æ˜¯é€šè¿‡ <code>toObservable()</code> å®ç°çš„ï¼Œå…¶è½¬æ¢å…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="https://upload-images.jianshu.io/upload_images/14126519-60964d9fa41614c1.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/563/format/webp" alt="img"></p>
<p><code>HystrixCommand</code> æ‰§è¡Œæ–¹å¼</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">K</span> <span class="variable">value</span>   <span class="operator">=</span> command.execute();</span><br><span class="line"><span class="comment">// ç­‰ä»·è¯­å¥ï¼š</span></span><br><span class="line"><span class="type">K</span> <span class="variable">value</span> <span class="operator">=</span> command.execute().queue().get();</span><br><span class="line"></span><br><span class="line">Future&lt;K&gt; fValue  = command.queue();</span><br><span class="line"><span class="comment">//ç­‰ä»·è¯­å¥ï¼š</span></span><br><span class="line">Future&lt;K&gt; fValue = command.toObservable().toBlocking().toFuture();</span><br><span class="line"></span><br><span class="line">Observable&lt;K&gt; ohValue = command.observe(); <span class="comment">//hot observableï¼Œç«‹åˆ»è®¢é˜…ï¼Œå‘½ä»¤ç«‹åˆ»æ‰§è¡Œ</span></span><br><span class="line"><span class="comment">//ç­‰ä»·è¯­å¥ï¼š</span></span><br><span class="line">Observable&lt;K&gt; ohValue = command.toObservable().subscribe(subject);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¸Šè¿°æ‰§è¡Œæœ€ç»ˆå®ç°è¿˜æ˜¯åŸºäº toObservable()</span></span><br><span class="line">Observable&lt;K&gt; ocValue = command.toObservable(); <span class="comment">//cold observableï¼Œå»¶åè®¢é˜…ï¼Œè®¢é˜…å‘ç”Ÿåï¼Œæ‰§è¡Œæ‰çœŸæ­£æ‰§è¡Œ</span></span><br></pre></td></tr></table></figure>

<p><strong>ï¼ˆä¸‰ï¼‰æ˜¯å¦ç¼“å­˜</strong></p>
<p>å¦‚æœå½“å‰å‘½ä»¤å¯¹è±¡å¯ç”¨äº†è¯·æ±‚ç¼“å­˜ï¼Œå¹¶ä¸”è¯·æ±‚çš„å“åº”å­˜åœ¨äºç¼“å­˜ä¸­ï¼Œåˆ™ç¼“å­˜çš„å“åº”ä¼šç«‹åˆ»ä»¥ <code>Observable</code> çš„å½¢å¼è¿”å›ã€‚</p>
<p><strong>ï¼ˆå››ï¼‰æ˜¯å¦å¼€å¯æ–­è·¯å™¨</strong></p>
<p>å¦‚æœç¬¬ä¸‰æ­¥æ²¡æœ‰ç¼“å­˜æ²¡æœ‰å‘½ä¸­ï¼Œåˆ™åˆ¤æ–­ä¸€ä¸‹å½“å‰æ–­è·¯å™¨çš„æ–­è·¯çŠ¶æ€æ˜¯å¦æ‰“å¼€ã€‚å¦‚æœæ–­è·¯å™¨çŠ¶æ€ä¸ºæ‰“å¼€çŠ¶æ€ï¼Œåˆ™ Hystrix å°†ä¸ä¼šæ‰§è¡Œæ­¤ Command å‘½ä»¤ï¼Œç›´æ¥æ‰§è¡Œæ­¥éª¤ 8 è°ƒç”¨ Fallbackï¼›</p>
<p>å¦‚æœæ–­è·¯å™¨çŠ¶æ€æ˜¯å…³é—­ï¼Œåˆ™æ‰§è¡Œæ­¥éª¤ 5 æ£€æŸ¥æ˜¯å¦æœ‰è¶³å¤Ÿçš„èµ„æºè¿è¡Œ Command å‘½ä»¤</p>
<p><strong>ï¼ˆäº”ï¼‰ä¿¡å·é‡ã€çº¿ç¨‹æ± æ˜¯å¦æ‹’ç»</strong></p>
<p>å½“æ‚¨æ‰§è¡Œè¯¥å‘½ä»¤æ—¶ï¼ŒHystrix ä¼šæ£€æŸ¥æ–­è·¯å™¨ä»¥æŸ¥çœ‹ç”µè·¯æ˜¯å¦æ‰“å¼€ã€‚</p>
<p>å¦‚æœç”µè·¯å¼€è·¯ï¼ˆæˆ–â€œè·³é—¸â€ï¼‰ï¼Œåˆ™ Hystrix å°†ä¸ä¼šæ‰§è¡Œè¯¥å‘½ä»¤ï¼Œè€Œæ˜¯å°†æµç¨‹è·¯ç”±åˆ° (8) è·å–å›é€€ã€‚</p>
<p>å¦‚æœç”µè·¯é—­åˆï¼Œåˆ™æµç¨‹å‰è¿›è‡³ (5) ä»¥æ£€æŸ¥æ˜¯å¦æœ‰å¯ç”¨å®¹é‡æ¥è¿è¡Œå‘½ä»¤ã€‚</p>
<p>å¦‚æœå½“å‰è¦æ‰§è¡Œçš„ Command å‘½ä»¤ å…ˆå…³è¿çš„çº¿ç¨‹æ±  å’Œé˜Ÿåˆ—ï¼ˆæˆ–è€…ä¿¡å·é‡ï¼‰èµ„æºå·²ç»æ»¡äº†ï¼ŒHystrix å°†ä¸ä¼šè¿è¡Œ Command å‘½ä»¤ï¼Œç›´æ¥æ‰§è¡Œ <strong>æ­¥éª¤ 8 <strong>çš„ Fallback é™çº§å¤„ç†ï¼›å¦‚æœæœªæ»¡ï¼Œè¡¨ç¤ºæœ‰å‰©ä½™çš„èµ„æºæ‰§è¡Œ Command å‘½ä»¤ï¼Œåˆ™æ‰§è¡Œ</strong>æ­¥éª¤ 6</strong></p>
<p><strong>ï¼ˆå…­ï¼‰<code>construct()</code> æˆ– <code>run()</code></strong></p>
<p>å½“ç»è¿‡<strong>æ­¥éª¤ 5</strong> åˆ¤æ–­ï¼Œæœ‰è¶³å¤Ÿçš„èµ„æºæ‰§è¡Œ Command å‘½ä»¤æ—¶ï¼Œæœ¬æ­¥éª¤å°†è°ƒç”¨ Command å‘½ä»¤è¿è¡Œæ–¹æ³•ï¼ŒåŸºäºä¸åŒç±»å‹çš„ Commandï¼Œæœ‰å¦‚ä¸‹ä¸¤ç§ä¸¤ç§è¿è¡Œæ–¹å¼ï¼š</p>
<table>
<thead>
<tr>
<th align="left">è¿è¡Œæ–¹å¼</th>
<th align="left">è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><code>HystrixCommand.run()</code></td>
<td align="left">è¿”å›ä¸€ä¸ªå¤„ç†ç»“æœæˆ–è€…æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸</td>
</tr>
<tr>
<td align="left"><code>HystrixObservableCommand.construct()</code></td>
<td align="left">è¿”å›ä¸€ä¸ª Observable è¡¨ç¤ºçš„ç»“æœï¼ˆå¯èƒ½å¤šä¸ªï¼‰ï¼Œæˆ–è€… åŸºäº<code>onError</code>çš„é”™è¯¯é€šçŸ¥</td>
</tr>
</tbody></table>
<p>å¦‚æœ<code>run()</code> æˆ–è€…<code>construct()</code>æ–¹æ³• çš„<code>çœŸå®æ‰§è¡Œæ—¶é—´</code>è¶…è¿‡äº† Command è®¾ç½®çš„<code>è¶…æ—¶æ—¶é—´é˜ˆå€¼</code>, åˆ™<strong>å½“å‰åˆ™æ‰§è¡Œçº¿ç¨‹</strong>ï¼ˆæˆ–è€…æ˜¯ç‹¬ç«‹çš„å®šæ—¶å™¨çº¿ç¨‹ï¼‰å°†ä¼šæŠ›å‡º<code>TimeoutException</code>ã€‚æŠ›å‡ºè¶…æ—¶å¼‚å¸¸ TimeoutExceptionï¼Œåï¼Œå°†æ‰§è¡Œ**æ­¥éª¤ 8 **çš„ Fallback é™çº§å¤„ç†ã€‚å³ä½¿<code>run()</code>æˆ–è€…<code>construct()</code>æ‰§è¡Œæ²¡æœ‰è¢«å–æ¶ˆæˆ–ä¸­æ–­ï¼Œæœ€ç»ˆèƒ½å¤Ÿå¤„ç†è¿”å›ç»“æœï¼Œä½†åœ¨é™çº§å¤„ç†é€»è¾‘ä¸­ï¼Œå°†ä¼šæŠ›å¼ƒ<code>run()</code>æˆ–<code>construct()</code>æ–¹æ³•çš„è¿”å›ç»“æœï¼Œè€Œè¿”å› Fallback é™çº§å¤„ç†ç»“æœã€‚</p>
<blockquote>
<p><strong>æ³¨æ„äº‹é¡¹</strong><br>éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒHystrix æ— æ³•å¼ºåˆ¶ å°†æ­£åœ¨è¿è¡Œçš„çº¿ç¨‹åœæ­¢æ‰â€“Hystrix èƒ½å¤Ÿåšçš„æœ€å¥½çš„æ–¹å¼å°±æ˜¯åœ¨ JVM ä¸­æŠ›å‡ºä¸€ä¸ª<code>InterruptedException</code>ã€‚å¦‚æœ Hystrix åŒ…è£…çš„å·¥ä½œä¸æŠ›å‡ºä¸­æ–­å¼‚å¸¸<code>InterruptedException</code>, åˆ™åœ¨ Hystrix çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹å°†ä¼šç»§ç»­æ‰§è¡Œï¼Œå°½ç®¡<code>è°ƒç”¨çš„å®¢æˆ·ç«¯</code>å·²ç»æ¥æ”¶åˆ°äº†<code>TimeoutException</code>ã€‚è¿™ç§æ–¹å¼ä¼šä½¿ Hystrix çš„çº¿ç¨‹æ± å¤„äºé¥±å’ŒçŠ¶æ€ã€‚å¤§éƒ¨åˆ†çš„ Java Http Client å¼€æºåº“å¹¶ä¸ä¼šè§£æ <code>InterruptedException</code>ã€‚æ‰€ä»¥ç¡®è®¤ HTTP client ç›¸å…³çš„è¿æ¥å’Œè¯»&#x2F;å†™ç›¸å…³çš„è¶…æ—¶æ—¶é—´è®¾ç½®ã€‚<br>å¦‚æœ Command å‘½ä»¤æ²¡æœ‰æŠ›å‡ºä»»ä½•å¼‚å¸¸ï¼Œå¹¶ä¸”æœ‰è¿”å›ç»“æœï¼Œåˆ™ Hystrix å°†ä¼šåœ¨åšå®Œæ—¥å¿—è®°å½•å’Œç»Ÿè®¡ä¹‹åä¼šå°†ç»“æœè¿”å›ã€‚ å¦‚æœæ˜¯é€šè¿‡<code>run()</code>æ–¹å¼è¿è¡Œï¼Œåˆ™è¿”å›ä¸€ä¸ª<code>Obserable</code>å¯¹è±¡ï¼ŒåŒ…å«ä¸€ä¸ªå”¯ä¸€å€¼ï¼Œå¹¶ä¸”å‘é€ä¸€ä¸ª<code>onCompleted</code>é€šçŸ¥ï¼›å¦‚æœæ˜¯é€šè¿‡<code>consturct()</code>æ–¹å¼è¿è¡Œ ï¼Œåˆ™è¿”å›ä¸€ä¸ª<code>Observable å¯¹è±¡</code>ã€‚</p>
</blockquote>
<p><strong>ï¼ˆä¸ƒï¼‰å¥åº·æ£€æŸ¥</strong></p>
<p>Hystrix ä¼šç»Ÿè®¡ Command å‘½ä»¤æ‰§è¡Œæ‰§è¡Œè¿‡ç¨‹ä¸­çš„<strong>æˆåŠŸæ•°</strong>ã€<strong>å¤±è´¥æ•°</strong>ã€<strong>æ‹’ç»æ•°</strong>å’Œ<strong>è¶…æ—¶æ•°</strong>, å°†è¿™äº›ä¿¡æ¯è®°å½•åˆ°<strong>æ–­è·¯å™¨ (Circuit Breaker) <strong>ä¸­ã€‚æ–­è·¯å™¨å°†ä¸Šè¿°ç»Ÿè®¡æŒ‰ç…§</strong>æ—¶é—´çª—</strong>çš„å½¢å¼è®°å½•åˆ°ä¸€ä¸ªå®šé•¿æ•°ç»„ä¸­ã€‚æ–­è·¯å™¨æ ¹æ®æ—¶é—´çª—å†…çš„ç»Ÿè®¡æ•°æ®å»åˆ¤å®šè¯·æ±‚ä»€ä¹ˆæ—¶å€™å¯ä»¥è¢«ç†”æ–­ï¼Œç†”æ–­åï¼Œåœ¨æ¥ä¸‹æ¥ä¸€æ®µæ¢å¤å‘¨æœŸå†…ï¼Œç›¸åŒçš„è¯·æ±‚è¿‡æ¥åä¼šç›´æ¥è¢«ç†”æ–­ã€‚å½“å†æ¬¡æ ¡éªŒï¼Œå¦‚æœå¥åº·ç›‘æµ‹é€šè¿‡åï¼Œç†”æ–­å¼€å…³å°†ä¼šè¢«å…³é—­ã€‚</p>
<p><strong>ï¼ˆå…«ï¼‰è·å– Fallback</strong></p>
<p>å½“ä»¥ä¸‹åœºæ™¯å‡ºç°åï¼ŒHystrix å°†ä¼šå°è¯•è§¦å‘ <code>Fallback</code>:</p>
<blockquote>
<ul>
<li>æ­¥éª¤ 6 Command æ‰§è¡Œæ—¶æŠ›å‡ºäº†ä»»ä½•å¼‚å¸¸ï¼›</li>
<li>æ­¥éª¤ 4 æ–­è·¯å™¨å·²ç»è¢«æ‰“å¼€</li>
<li>æ­¥éª¤ 5 æ‰§è¡Œå‘½ä»¤çš„çº¿ç¨‹æ± ã€é˜Ÿåˆ—æˆ–è€…ä¿¡å·é‡èµ„æºå·²æ»¡</li>
<li>å‘½ä»¤æ‰§è¡Œçš„æ—¶é—´è¶…è¿‡é˜ˆå€¼</li>
</ul>
</blockquote>
<p><strong>ï¼ˆä¹ï¼‰è¿”å›ç»“æœ</strong></p>
<p>å¦‚æœ Hystrix å‘½ä»¤å¯¹è±¡æ‰§è¡ŒæˆåŠŸï¼Œå°†ä¼šè¿”å›ç»“æœï¼Œæˆ–è€…ä»¥<code>Observable</code>å½¢å¼åŒ…è£…çš„ç»“æœã€‚æ ¹æ®**æ­¥éª¤ 2 **çš„ command è°ƒç”¨æ–¹å¼ï¼Œè¿”å›çš„<code>Observable</code> ä¼šæŒ‰ç…§å¦‚ä¸‹å›¾è¯´æ˜¯çš„è½¬æ¢å…³ç³»è¿›è¡Œè¿”å›ï¼š</p>
<p><img src="https://upload-images.jianshu.io/upload_images/14126519-8790f97df332d9a2.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/640/format/webp" alt="img"></p>
<ul>
<li><code>execute()</code> â€” ç”¨å’Œ <code>.queue()</code> ç›¸åŒçš„æ–¹å¼è·å– <code>Future</code>ï¼Œç„¶åè°ƒç”¨ <code>Future</code> çš„ <code>get()</code> ä»¥è·å– <code>Observable</code> çš„å•ä¸ªå€¼ã€‚</li>
<li><code>queue()</code> â€”å°† <code>Observable</code> è½¬æ¢ä¸º <code>BlockingObservable</code>ï¼Œä»¥ä¾¿å¯ä»¥å°†å…¶è½¬æ¢ä¸º <code>Future</code> å¹¶è¿”å›ã€‚</li>
<li><code>watch()</code> â€”è®¢é˜… <code>Observable</code> å¹¶å¼€å§‹æ‰§è¡Œå‘½ä»¤çš„æµç¨‹ï¼› è¿”å›ä¸€ä¸ª <code>Observable</code>ï¼Œå½“è®¢é˜…è¯¥ <code>Observable</code> æ—¶ï¼Œå®ƒä¼šé‡æ–°é€šçŸ¥ã€‚</li>
<li><code>toObservable()</code> â€”è¿”å›ä¸å˜çš„ <code>Observable</code>ï¼› å¿…é¡»è®¢é˜…å®ƒæ‰èƒ½çœŸæ­£å¼€å§‹æ‰§è¡Œå‘½ä»¤çš„æµç¨‹ã€‚</li>
</ul>
<h3 id="æ–­è·¯å™¨å·¥ä½œåŸç†"><a href="#æ–­è·¯å™¨å·¥ä½œåŸç†" class="headerlink" title="æ–­è·¯å™¨å·¥ä½œåŸç†"></a>æ–­è·¯å™¨å·¥ä½œåŸç†</h3><p><img src="https://upload-images.jianshu.io/upload_images/14126519-dce007513bf90794.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/640/format/webp" alt="img"></p>
<ol>
<li>æ–­è·¯å™¨æ—¶é—´çª—å†…çš„è¯·æ±‚æ•°æ˜¯å¦è¶…è¿‡äº†<strong>è¯·æ±‚æ•°æ–­è·¯å™¨ç”Ÿæ•ˆé˜ˆå€¼</strong><code>circuitBreaker.requestVolumeThreshold</code>ï¼Œå¦‚æœè¶…è¿‡äº†é˜ˆå€¼ï¼Œåˆ™å°†ä¼šè§¦å‘æ–­è·¯ï¼Œæ–­è·¯çŠ¶æ€ä¸º<strong>å¼€å¯</strong><br>ä¾‹å¦‚ï¼Œå¦‚æœå½“å‰é˜ˆå€¼è®¾ç½®çš„æ˜¯<code>20</code>ï¼Œåˆ™å½“æ—¶é—´çª—å†…ç»Ÿè®¡çš„è¯·æ±‚æ•°å…±è®¡ 19 ä¸ªï¼Œå³ä½¿ 19 ä¸ªå…¨éƒ¨å¤±è´¥äº†ï¼Œéƒ½ä¸ä¼šè§¦å‘æ–­è·¯å™¨ã€‚</li>
<li>å¹¶ä¸”è¯·æ±‚é”™è¯¯ç‡è¶…è¿‡äº†<strong>è¯·æ±‚é”™è¯¯ç‡é˜ˆå€¼</strong><code>errorThresholdPercentage</code></li>
<li>å¦‚æœä¸¤ä¸ªéƒ½æ»¡è¶³ï¼Œåˆ™å°†æ–­è·¯å™¨ç”±<strong>å…³é—­</strong>è¿ç§»åˆ°<strong>å¼€å¯</strong></li>
<li>å¦‚æœæ–­è·¯å™¨å¼€å¯ï¼Œåˆ™åç»­çš„æ‰€æœ‰ç›¸åŒè¯·æ±‚å°†ä¼šè¢«æ–­è·¯æ‰ï¼›</li>
<li>ç›´åˆ°è¿‡äº†<strong>æ²‰ç¡æ—¶é—´çª—</strong><code>sleepWindowInMilliseconds</code>åï¼Œå†å‘èµ·è¯·æ±‚æ—¶ï¼Œå…è®¸å…¶é€šè¿‡ï¼ˆæ­¤æ—¶çš„çŠ¶æ€ä¸º<strong>åŠå¼€èµ·çŠ¶æ€</strong>ï¼‰ã€‚å¦‚æœè¯·æ±‚å¤±è´¥äº†ï¼Œåˆ™ä¿æŒæ–­è·¯å™¨çŠ¶æ€ä¸º<strong>å¼€å¯</strong>çŠ¶æ€ï¼Œå¹¶æ›´æ–°<strong>æ²‰ç¡æ—¶é—´çª—</strong>ã€‚å¦‚æœè¯·æ±‚æˆåŠŸäº†ï¼Œåˆ™å°†æ–­è·¯å™¨çŠ¶æ€æ”¹ä¸º<strong>å…³é—­</strong>çŠ¶æ€ï¼›</li>
</ol>
<p>æ ¸å¿ƒçš„é€»è¾‘å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onNext</span><span class="params">(HealthCounts hc)</span> &#123;</span><br><span class="line">    <span class="comment">// check if we are past the statisticalWindowVolumeThreshold</span></span><br><span class="line">    <span class="keyword">if</span> (hc.getTotalRequests() &lt; properties.circuitBreakerRequestVolumeThreshold().get()) &#123;</span><br><span class="line">        <span class="comment">// we are not past the minimum volume threshold for the stat window,</span></span><br><span class="line">        <span class="comment">// so no change to circuit status.</span></span><br><span class="line">        <span class="comment">// if it was CLOSED, it stays CLOSED</span></span><br><span class="line">        <span class="comment">// if it was half-open, we need to wait for a successful command execution</span></span><br><span class="line">        <span class="comment">// if it was open, we need to wait for sleep window to elapse</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (hc.getErrorPercentage() &lt; properties.circuitBreakerErrorThresholdPercentage().get()) &#123;</span><br><span class="line">            <span class="comment">//we are not past the minimum error threshold for the stat window,</span></span><br><span class="line">            <span class="comment">// so no change to circuit status.</span></span><br><span class="line">            <span class="comment">// if it was CLOSED, it stays CLOSED</span></span><br><span class="line">            <span class="comment">// if it was half-open, we need to wait for a successful command execution</span></span><br><span class="line">            <span class="comment">// if it was open, we need to wait for sleep window to elapse</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// our failure rate is too high, we need to set the state to OPEN</span></span><br><span class="line">            <span class="keyword">if</span> (status.compareAndSet(Status.CLOSED, Status.OPEN)) &#123;</span><br><span class="line">                circuitOpened.set(System.currentTimeMillis());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="é™æµæ¡†æ¶-Sentinel"><a href="#é™æµæ¡†æ¶-Sentinel" class="headerlink" title="é™æµæ¡†æ¶ - Sentinel"></a>é™æµæ¡†æ¶ - Sentinel</h2><h2 id="å…¶ä»–é™æµè§£å†³æ–¹æ¡ˆ"><a href="#å…¶ä»–é™æµè§£å†³æ–¹æ¡ˆ" class="headerlink" title="å…¶ä»–é™æµè§£å†³æ–¹æ¡ˆ"></a>å…¶ä»–é™æµè§£å†³æ–¹æ¡ˆ</h2><h3 id="Guava-RateLimiter"><a href="#Guava-RateLimiter" class="headerlink" title="Guava RateLimiter"></a>Guava RateLimiter</h3><p>Guava æ˜¯ Google å¼€æºçš„ Java ç±»åº“ï¼Œæä¾›äº†ä¸€ä¸ªå·¥å…·ç±» <code>RateLimiter</code>ï¼Œå®ƒåŸºäºä»¤ç‰Œæ¡¶ç®—æ³•å®ç°äº†æœ¬åœ°é™æµå™¨ã€‚</p>
<p>:::details RateLimiter é™æµç¤ºä¾‹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é™æµå™¨æµé€Ÿï¼š2 ä¸ªè¯·æ±‚/ç§’</span></span><br><span class="line"><span class="type">RateLimiter</span> <span class="variable">limiter</span> <span class="operator">=</span> RateLimiter.create(<span class="number">2.0</span>);</span><br><span class="line"><span class="comment">// æ‰§è¡Œä»»åŠ¡çš„çº¿ç¨‹æ± </span></span><br><span class="line"><span class="type">ExecutorService</span> <span class="variable">es</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">1</span>);</span><br><span class="line"><span class="comment">// è®°å½•ä¸Šä¸€æ¬¡æ‰§è¡Œæ—¶é—´</span></span><br><span class="line">prev = System.nanoTime();</span><br><span class="line"><span class="comment">// æµ‹è¯•æ‰§è¡Œ 20 æ¬¡</span></span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">20</span>; i++) &#123;</span><br><span class="line">    <span class="comment">// é™æµå™¨é™æµ</span></span><br><span class="line">    limiter.acquire();</span><br><span class="line">    <span class="comment">// æäº¤ä»»åŠ¡å¼‚æ­¥æ‰§è¡Œ</span></span><br><span class="line">    es.execute(() -&gt; &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">cur</span> <span class="operator">=</span> System.nanoTime();</span><br><span class="line">        <span class="comment">// æ‰“å°æ—¶é—´é—´éš”ï¼šæ¯«ç§’</span></span><br><span class="line">        System.out.println((cur - prev) / <span class="number">1000000</span>);</span><br><span class="line">        prev = cur;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¾“å‡ºç»“æœï¼š</span></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="comment">// 500</span></span><br><span class="line"><span class="comment">// 499</span></span><br><span class="line"><span class="comment">// 500</span></span><br><span class="line"><span class="comment">// 499</span></span><br></pre></td></tr></table></figure>

<p>:::</p>
<h3 id="Redis-Lua"><a href="#Redis-Lua" class="headerlink" title="Redis + Lua"></a>Redis + Lua</h3><p>å¦‚æœæƒ³è¦é’ˆå¯¹åˆ†å¸ƒå¼ç³»ç»Ÿèµ„æºè¿›è¡Œé™æµï¼Œåˆ™å¿…é¡»å…·å¤‡ä¸¤ä¸ªè¦ç´ ï¼š</p>
<ol>
<li>å¯¹äºèµ„æºçš„è®¿é—®ç»Ÿè®¡ï¼Œå¿…é¡»æ˜¯æ‰€æœ‰åˆ†å¸ƒå¼èŠ‚ç‚¹éƒ½å¯ä»¥å…±äº«è®¿é—®çš„æ•°æ®å­˜å‚¨ï¼›å¹¶ä¸”ï¼Œç”±äºåœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œè¯»å†™è®¿é—®ç»Ÿè®¡æ•°æ®ä¼šå¾ˆé¢‘ç¹ï¼Œè¯¥æ•°æ®å­˜å‚¨å¿…é¡»æœ‰å¾ˆé«˜çš„è¯»å†™æ€§èƒ½ã€‚</li>
<li>è®¿é—®ç»Ÿè®¡ã€é™æµè®¡ç®—éƒ½ä»¥åŸå­æ“ä½œæ–¹å¼è¿›è¡Œã€‚</li>
</ol>
<p>æ»¡è¶³ä»¥ä¸Šè¦ç´ çš„ä¸€ç§ç®€å•è§£å†³æ–¹æ¡ˆæ˜¯ï¼Œé‡‡ç”¨ Redis + Lua æ¥å®ç°ï¼ŒåŸå› åœ¨äºï¼š</p>
<ul>
<li>Redis æ•°æ®åº“çš„è¯»å†™æ€§èƒ½æé«˜ï¼›</li>
<li>Redis æ”¯æŒä»¥åŸå­æ“ä½œçš„æ–¹å¼æ‰§è¡Œ Lua è„šæœ¬ã€‚</li>
</ul>
<h4 id="Redis-Lua-å®ç°çš„å›ºå®šçª—å£é™æµç®—æ³•"><a href="#Redis-Lua-å®ç°çš„å›ºå®šçª—å£é™æµç®—æ³•" class="headerlink" title="Redis + Lua å®ç°çš„å›ºå®šçª—å£é™æµç®—æ³•"></a>Redis + Lua å®ç°çš„å›ºå®šçª—å£é™æµç®—æ³•</h4><p>Redis + Lua å®ç°çš„å›ºå®šçª—å£é™æµç®—æ³•å®ç°æ€è·¯ï¼š</p>
<ul>
<li>æ ¹æ®å®é™…éœ€è¦ï¼Œå°†å½“å‰æ—¶é—´æ ¼å¼åŒ–ä¸ºå¤©ï¼ˆ<code>yyyyMMdd</code>ï¼‰ã€æ—¶ï¼ˆ<code>yyyyMMddHH</code>ï¼‰ã€åˆ†ï¼ˆ<code>yyyyMMddHHmm</code>ï¼‰ã€ç§’ï¼ˆ<code>yyyyMMddHHmmss</code>ï¼‰ï¼Œå¹¶ä½œä¸º Redis çš„ String ç±»å‹ Keyã€‚è¯¥ Key å¯ä»¥è§†ä¸ºä¸€ä¸ªå›ºå®šæ—¶é—´çª—å£ï¼Œå…¶ä¸­çš„ value ç”¨äºç»Ÿè®¡è®¿é—®é‡ï¼›</li>
<li>ç”¨äºä»£è¡¨ä¸åŒç²’åº¦çš„æ—¶é—´çª—å£æŒ‰éœ€è®¾ç½®è¿‡æœŸæ—¶é—´ï¼›</li>
<li>ä¸€æ—¦è¾¾åˆ°çª—å£çš„é™æµé˜ˆå€¼æ—¶ï¼Œè¯·æ±‚è¢«é™æµï¼›å¦åˆ™è¯·æ±‚é€šè¿‡ã€‚</li>
</ul>
<p>:::details Redis + Lua å®ç°çš„å›ºå®šçª—å£é™æµç®—æ³•</p>
<p>ä¸‹é¢çš„ä»£ç ç‰‡æ®µæ¨¡æ‹Ÿé€šè¿‡ä¸€ä¸ªå¤§å°ä¸º 1 åˆ†é’Ÿçš„å›ºå®šæ—¶é—´çª—å£è¿›è¡Œé™æµï¼Œé˜ˆå€¼ä¸º 100ï¼Œè¿‡æœŸæ—¶é—´ 60sã€‚</p>
<p>é™æµè„šæœ¬ <code>fixed_window_rate_limit.lua</code> ä»£ç ï¼š</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- ç¼“å­˜ Key</span></span><br><span class="line"><span class="keyword">local</span> key = KEYS[<span class="number">1</span>]</span><br><span class="line"><span class="comment">-- è®¿é—®è¯·æ±‚æ•°</span></span><br><span class="line"><span class="keyword">local</span> permits = <span class="built_in">tonumber</span>(ARGV[<span class="number">1</span>])</span><br><span class="line"><span class="comment">-- è¿‡æœŸæ—¶é—´</span></span><br><span class="line"><span class="keyword">local</span> seconds = <span class="built_in">tonumber</span>(ARGV[<span class="number">2</span>])</span><br><span class="line"><span class="comment">-- é™æµé˜ˆå€¼</span></span><br><span class="line"><span class="keyword">local</span> limit = <span class="built_in">tonumber</span>(ARGV[<span class="number">3</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment">-- è·å–ç»Ÿè®¡å€¼</span></span><br><span class="line"><span class="keyword">local</span> count = <span class="built_in">tonumber</span>(redis.call(<span class="string">&#x27;GET&#x27;</span>, key) <span class="keyword">or</span> <span class="string">&quot;0&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> count + permits &gt; limit <span class="keyword">then</span></span><br><span class="line">    <span class="comment">-- è§¦å‘é™æµ</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    redis.call(<span class="string">&#x27;INCRBY&#x27;</span>, key, permits)</span><br><span class="line">    redis.call(<span class="string">&#x27;EXPIRE&#x27;</span>, key, seconds)</span><br><span class="line">    <span class="keyword">return</span> count + permits</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>è°ƒç”¨ lua çš„å®é™…é™æµä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> cn.hutool.core.collection.CollectionUtil;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.io.FileUtil;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.io.resource.ResourceUtil;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.util.RandomUtil;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.util.StrUtil;</span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.Jedis;</span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.exceptions.JedisConnectionException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.nio.charset.StandardCharsets;</span><br><span class="line"><span class="keyword">import</span> java.util.Collections;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisFixedWindowRateLimiter</span> <span class="keyword">implements</span> <span class="title class_">RateLimiter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">REDIS_HOST</span> <span class="operator">=</span> <span class="string">&quot;localhost&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">REDIS_PORT</span> <span class="operator">=</span> <span class="number">6379</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Jedis JEDIS;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String SCRIPT;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="comment">// Jedis æœ‰å¤šç§æ„é€ æ–¹æ³•ï¼Œè¿™é‡Œé€‰ç”¨æœ€ç®€å•çš„ä¸€ç§æƒ…å†µ</span></span><br><span class="line">        JEDIS = <span class="keyword">new</span> <span class="title class_">Jedis</span>(REDIS_HOST, REDIS_PORT);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è§¦å‘ ping å‘½ä»¤</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            JEDIS.ping();</span><br><span class="line">            System.out.println(<span class="string">&quot;jedis è¿æ¥æˆåŠŸ&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (JedisConnectionException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        SCRIPT = FileUtil.readString(ResourceUtil.getResource(<span class="string">&quot;scripts/fixed_window_rate_limit.lua&quot;</span>),</span><br><span class="line">            StandardCharsets.UTF_8);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">long</span> maxPermits;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">long</span> periodSeconds;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String key;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RedisFixedWindowRateLimiter</span><span class="params">(<span class="type">long</span> qps, String key)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>(qps * <span class="number">60</span>, <span class="number">60</span>, TimeUnit.SECONDS, key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RedisFixedWindowRateLimiter</span><span class="params">(<span class="type">long</span> maxPermits, <span class="type">long</span> period, TimeUnit timeUnit, String key)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.maxPermits = maxPermits;</span><br><span class="line">        <span class="built_in">this</span>.periodSeconds = timeUnit.toSeconds(period);</span><br><span class="line">        <span class="built_in">this</span>.key = key;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">tryAcquire</span><span class="params">(<span class="type">int</span> <span class="keyword">permits</span>)</span> &#123;</span><br><span class="line">        List&lt;String&gt; keys = Collections.singletonList(key);</span><br><span class="line">        List&lt;String&gt; args = CollectionUtil.newLinkedList(String.valueOf(<span class="keyword">permits</span>), String.valueOf(periodSeconds),</span><br><span class="line">            String.valueOf(maxPermits));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">eval</span> <span class="operator">=</span> JEDIS.eval(SCRIPT, keys, args);</span><br><span class="line">        <span class="type">long</span> <span class="variable">value</span> <span class="operator">=</span> (<span class="type">long</span>) eval;</span><br><span class="line">        <span class="keyword">return</span> value != -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">qps</span> <span class="operator">=</span> <span class="number">20</span>;</span><br><span class="line">        <span class="type">RateLimiter</span> <span class="variable">jedisFixedWindowRateLimiter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RedisFixedWindowRateLimiter</span>(qps, <span class="string">&quot;rate:limit:20240122210000&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ¨¡æ‹Ÿåœ¨ä¸€åˆ†é’Ÿå†…ï¼Œä¸æ–­æ”¶åˆ°è¯·æ±‚ï¼Œé™æµæ˜¯å¦æœ‰æ•ˆ</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">seconds</span> <span class="operator">=</span> <span class="number">60</span>;</span><br><span class="line">        <span class="type">long</span> <span class="variable">okNum</span> <span class="operator">=</span> <span class="number">0L</span>;</span><br><span class="line">        <span class="type">long</span> <span class="variable">total</span> <span class="operator">=</span> <span class="number">0L</span>;</span><br><span class="line">        <span class="type">long</span> <span class="variable">beginTime</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="type">int</span> <span class="variable">num</span> <span class="operator">=</span> RandomUtil.randomInt(qps, <span class="number">100</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">second</span> <span class="operator">=</span> <span class="number">0</span>; second &lt; seconds; second++) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; num; i++) &#123;</span><br><span class="line">                total++;</span><br><span class="line">                <span class="keyword">if</span> (jedisFixedWindowRateLimiter.tryAcquire(<span class="number">1</span>)) &#123;</span><br><span class="line">                    okNum++;</span><br><span class="line">                    System.out.println(<span class="string">&quot;è¯·æ±‚æˆåŠŸ&quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;è¯·æ±‚é™æµ&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">long</span> <span class="variable">endTime</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="type">long</span> <span class="variable">time</span> <span class="operator">=</span> (endTime - beginTime) / <span class="number">1000</span>;</span><br><span class="line">        System.out.println(StrUtil.format(<span class="string">&quot;è¯·æ±‚é€šè¿‡æ•°ï¼š&#123;&#125;ï¼Œæ€»è¯·æ±‚æ•°ï¼š&#123;&#125;ï¼Œå®é™… QPSï¼š&#123;&#125;&quot;</span>, okNum, total, okNum / time));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>:::</p>
<h4 id="Redis-Lua-å®ç°çš„ä»¤ç‰Œæ¡¶é™æµç®—æ³•"><a href="#Redis-Lua-å®ç°çš„ä»¤ç‰Œæ¡¶é™æµç®—æ³•" class="headerlink" title="Redis + Lua å®ç°çš„ä»¤ç‰Œæ¡¶é™æµç®—æ³•"></a>Redis + Lua å®ç°çš„ä»¤ç‰Œæ¡¶é™æµç®—æ³•</h4><p>:::details Redis + Lua å®ç°çš„ä»¤ç‰Œæ¡¶é™æµç®—æ³•</p>
<p>é™æµè„šæœ¬ <code>token_bucket_rate_limit.lua</code> ä»£ç ï¼š</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> tokenKey = KEYS[<span class="number">1</span>]</span><br><span class="line"><span class="keyword">local</span> timeKey = KEYS[<span class="number">2</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ç”³è¯·ä»¤ç‰Œæ•°</span></span><br><span class="line"><span class="keyword">local</span> permits = <span class="built_in">tonumber</span>(ARGV[<span class="number">1</span>])</span><br><span class="line"><span class="comment">-- QPS</span></span><br><span class="line"><span class="keyword">local</span> qps = <span class="built_in">tonumber</span>(ARGV[<span class="number">2</span>])</span><br><span class="line"><span class="comment">-- æ¡¶çš„å®¹é‡</span></span><br><span class="line"><span class="keyword">local</span> capacity = <span class="built_in">tonumber</span>(ARGV[<span class="number">3</span>])</span><br><span class="line"><span class="comment">-- å½“å‰æ—¶é—´ï¼ˆå•ä½ï¼šæ¯«ç§’ï¼‰</span></span><br><span class="line"><span class="keyword">local</span> nowMillis = <span class="built_in">tonumber</span>(ARGV[<span class="number">4</span>])</span><br><span class="line"><span class="comment">-- å¡«æ»¡ä»¤ç‰Œæ¡¶æ‰€éœ€è¦çš„æ—¶é—´</span></span><br><span class="line"><span class="keyword">local</span> fillTime = capacity / qps</span><br><span class="line"><span class="keyword">local</span> ttl = <span class="built_in">math</span>.<span class="built_in">min</span>(capacity, <span class="built_in">math</span>.<span class="built_in">floor</span>(fillTime * <span class="number">2</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> currentTokenNum = <span class="built_in">tonumber</span>(redis.call(<span class="string">&quot;GET&quot;</span>, tokenKey))</span><br><span class="line"><span class="keyword">if</span> currentTokenNum == <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line">    currentTokenNum = capacity</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> endTimeMillis = <span class="built_in">tonumber</span>(redis.call(<span class="string">&quot;GET&quot;</span>, timeKey))</span><br><span class="line"><span class="keyword">if</span> endTimeMillis == <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line">    endTimeMillis = <span class="number">0</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> gap = nowMillis - endTimeMillis</span><br><span class="line"><span class="keyword">local</span> newTokenNum = <span class="built_in">math</span>.<span class="built_in">max</span>(<span class="number">0</span>, gap * qps / <span class="number">1000</span>)</span><br><span class="line"><span class="keyword">local</span> currentTokenNum = <span class="built_in">math</span>.<span class="built_in">min</span>(capacity, currentTokenNum + newTokenNum)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> currentTokenNum &lt; permits <span class="keyword">then</span></span><br><span class="line">    <span class="comment">-- è¯·æ±‚æ‹’ç»</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="comment">-- è¯·æ±‚é€šè¿‡</span></span><br><span class="line">    <span class="keyword">local</span> finalTokenNum = currentTokenNum - permits</span><br><span class="line">    redis.call(<span class="string">&quot;SETEX&quot;</span>, tokenKey, ttl, finalTokenNum)</span><br><span class="line">    redis.call(<span class="string">&quot;SETEX&quot;</span>, timeKey, ttl, nowMillis)</span><br><span class="line">    <span class="keyword">return</span> finalTokenNum</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>è°ƒç”¨ lua çš„å®é™…é™æµä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> io.github.dunwu.distributed.ratelimit;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.collection.CollectionUtil;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.io.FileUtil;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.io.resource.ResourceUtil;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.util.RandomUtil;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.util.StrUtil;</span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.Jedis;</span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.exceptions.JedisConnectionException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.nio.charset.StandardCharsets;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * åŸºäº Redis + Lua å®ç°çš„ä»¤ç‰Œæ¡¶é™æµç®—æ³•</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> &lt;a href=&quot;mailto:forbreak@163.com&quot;&gt;Zhang Peng&lt;/a&gt;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2024-01-23</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisTokenBucketRateLimiter</span> <span class="keyword">implements</span> <span class="title class_">RateLimiter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">REDIS_HOST</span> <span class="operator">=</span> <span class="string">&quot;localhost&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">REDIS_PORT</span> <span class="operator">=</span> <span class="number">6379</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Jedis JEDIS;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String SCRIPT;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="comment">// Jedis æœ‰å¤šç§æ„é€ æ–¹æ³•ï¼Œè¿™é‡Œé€‰ç”¨æœ€ç®€å•çš„ä¸€ç§æƒ…å†µ</span></span><br><span class="line">        JEDIS = <span class="keyword">new</span> <span class="title class_">Jedis</span>(REDIS_HOST, REDIS_PORT);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è§¦å‘ ping å‘½ä»¤</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            JEDIS.ping();</span><br><span class="line">            System.out.println(<span class="string">&quot;jedis è¿æ¥æˆåŠŸ&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (JedisConnectionException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        SCRIPT = FileUtil.readString(ResourceUtil.getResource(<span class="string">&quot;scripts/token_bucket_rate_limit.lua&quot;</span>),</span><br><span class="line">            StandardCharsets.UTF_8);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">long</span> qps;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">long</span> capacity;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String tokenKey;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String timeKey;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RedisTokenBucketRateLimiter</span><span class="params">(<span class="type">long</span> qps, <span class="type">long</span> capacity, String tokenKey, String timeKey)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.qps = qps;</span><br><span class="line">        <span class="built_in">this</span>.capacity = capacity;</span><br><span class="line">        <span class="built_in">this</span>.tokenKey = tokenKey;</span><br><span class="line">        <span class="built_in">this</span>.timeKey = timeKey;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">tryAcquire</span><span class="params">(<span class="type">int</span> <span class="keyword">permits</span>)</span> &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">now</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        List&lt;String&gt; keys = CollectionUtil.newLinkedList(tokenKey, timeKey);</span><br><span class="line">        List&lt;String&gt; args = CollectionUtil.newLinkedList(String.valueOf(<span class="keyword">permits</span>), String.valueOf(qps),</span><br><span class="line">            String.valueOf(capacity), String.valueOf(now));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">eval</span> <span class="operator">=</span> JEDIS.eval(SCRIPT, keys, args);</span><br><span class="line">        <span class="type">long</span> <span class="variable">value</span> <span class="operator">=</span> (<span class="type">long</span>) eval;</span><br><span class="line">        <span class="keyword">return</span> value != -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">qps</span> <span class="operator">=</span> <span class="number">20</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">bucket</span> <span class="operator">=</span> <span class="number">100</span>;</span><br><span class="line">        <span class="type">RedisTokenBucketRateLimiter</span> <span class="variable">redisTokenBucketRateLimiter</span> <span class="operator">=</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">RedisTokenBucketRateLimiter</span>(qps, bucket, <span class="string">&quot;token:rate:limit&quot;</span>, <span class="string">&quot;token:rate:limit:time&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å…ˆå°†ä»¤ç‰Œæ¡¶é¢„çƒ­ä»¤ç‰Œç”³è¯·å®Œï¼Œåç»­æ‰èƒ½çœŸå®åæ˜ é™æµ QPS</span></span><br><span class="line">        redisTokenBucketRateLimiter.tryAcquire(bucket);</span><br><span class="line">        TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ¨¡æ‹Ÿåœ¨ä¸€åˆ†é’Ÿå†…ï¼Œä¸æ–­æ”¶åˆ°è¯·æ±‚ï¼Œé™æµæ˜¯å¦æœ‰æ•ˆ</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">seconds</span> <span class="operator">=</span> <span class="number">60</span>;</span><br><span class="line">        <span class="type">long</span> <span class="variable">okNum</span> <span class="operator">=</span> <span class="number">0L</span>;</span><br><span class="line">        <span class="type">long</span> <span class="variable">total</span> <span class="operator">=</span> <span class="number">0L</span>;</span><br><span class="line">        <span class="type">long</span> <span class="variable">beginTime</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">second</span> <span class="operator">=</span> <span class="number">0</span>; second &lt; seconds; second++) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">num</span> <span class="operator">=</span> RandomUtil.randomInt(qps, <span class="number">100</span>);</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; num; i++) &#123;</span><br><span class="line">                total++;</span><br><span class="line">                <span class="keyword">if</span> (redisTokenBucketRateLimiter.tryAcquire(<span class="number">1</span>)) &#123;</span><br><span class="line">                    okNum++;</span><br><span class="line">                    System.out.println(<span class="string">&quot;è¯·æ±‚æˆåŠŸ&quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;è¯·æ±‚é™æµ&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">long</span> <span class="variable">endTime</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="type">long</span> <span class="variable">time</span> <span class="operator">=</span> (endTime - beginTime) / <span class="number">1000</span>;</span><br><span class="line">        System.out.println(StrUtil.format(<span class="string">&quot;è¯·æ±‚é€šè¿‡æ•°ï¼š&#123;&#125;ï¼Œæ€»è¯·æ±‚æ•°ï¼š&#123;&#125;ï¼Œå®é™… QPSï¼š&#123;&#125;&quot;</span>, okNum, total, okNum / time));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>:::</p>
<h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/Netflix/Hystrix/wiki">Hystrix Wiki</a></li>
<li><a target="_blank" rel="noopener" href="https://item.jd.com/11322972.html">ã€Šå¤§å‹ç½‘ç«™æŠ€æœ¯æ¶æ„ï¼šæ ¸å¿ƒåŸç†ä¸æ¡ˆä¾‹åˆ†æã€‹</a></li>
<li><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/76cc8ba5ca91">è°ˆè°ˆé™æµç®—æ³•çš„å‡ ç§å®ç°</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/doocs/advanced-java/blob/master/docs/high-concurrency/huifer-how-to-limit-current.md">å¦‚ä½•é™æµï¼Ÿåœ¨å·¥ä½œä¸­æ˜¯æ€ä¹ˆåšçš„ï¼Ÿè¯´ä¸€ä¸‹å…·ä½“çš„å®ç°ï¼Ÿ</a></li>
<li><a target="_blank" rel="noopener" href="https://gongfukangee.github.io/2019/04/04/Limit/">æµ…æé™æµç®—æ³•</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/forezp/article/details/100060686">RateLimiter åŸºäºæ¼æ¡¶ç®—æ³•ï¼Œä½†å®ƒå‚è€ƒäº†ä»¤ç‰Œæ¡¶ç®—æ³•</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://dunwu.github.io/blog/pages/8d5643ca/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/uploads/avatar.gif">
      <meta itemprop="name" content="é’æ‚Ÿ â—¾ Dunwu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dunwu Blog">
      <meta itemprop="description" content="é’æ‚Ÿçš„ä¸ªäººåšå®¢">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Dunwu Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/pages/8d5643ca/" class="post-title-link" itemprop="url">Java å®¹å™¨ä¹‹ Map</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2019-12-29 21:49:58" itemprop="dateCreated datePublished" datetime="2019-12-29T21:49:58+08:00">2019-12-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">æ›´æ–°äº</span>
      <time title="ä¿®æ”¹æ—¶é—´ï¼š2025-09-13 17:56:53" itemprop="dateModified" datetime="2025-09-13T17:56:53+08:00">2025-09-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
        </span>
          ï¼Œ
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/JavaCore/" itemprop="url" rel="index"><span itemprop="name">JavaCore</span></a>
        </span>
          ï¼Œ
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/JavaCore/%E5%AE%B9%E5%99%A8/" itemprop="url" rel="index"><span itemprop="name">å®¹å™¨</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
      <span>18k</span>
    </span>
    <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
      <span>16 åˆ†é’Ÿ</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Java-å®¹å™¨ä¹‹-Map"><a href="#Java-å®¹å™¨ä¹‹-Map" class="headerlink" title="Java å®¹å™¨ä¹‹ Map"></a>Java å®¹å™¨ä¹‹ Map</h1><h2 id="Map-ç®€ä»‹"><a href="#Map-ç®€ä»‹" class="headerlink" title="Map ç®€ä»‹"></a>Map ç®€ä»‹</h2><h3 id="Map-æ¶æ„"><a href="#Map-æ¶æ„" class="headerlink" title="Map æ¶æ„"></a>Map æ¶æ„</h3><div align="center">
<img src="https://raw.githubusercontent.com/dunwu/images/master/cs/java/javacore/container/Map-diagrams.png" />
</div>

<p>Map å®¶æ—ä¸»è¦æˆå‘˜åŠŸèƒ½å¦‚ä¸‹ï¼š</p>
<ul>
<li><code>Map</code> æ˜¯ Map å®¹å™¨å®¶æ—çš„ç¥–å…ˆï¼ŒMap æ˜¯ä¸€ä¸ªç”¨äºä¿å­˜é”®å€¼å¯¹(key-value)çš„æ¥å£ã€‚<strong>Map ä¸­ä¸èƒ½åŒ…å«é‡å¤çš„é”®ï¼›æ¯ä¸ªé”®æœ€å¤šåªèƒ½æ˜ å°„åˆ°ä¸€ä¸ªå€¼ã€‚</strong></li>
<li><code>AbstractMap</code> ç»§æ‰¿äº† <code>Map</code> çš„æŠ½è±¡ç±»ï¼Œå®ƒå®ç°äº† <code>Map</code> ä¸­çš„æ ¸å¿ƒ APIã€‚å…¶å®ƒ <code>Map</code> çš„å®ç°ç±»å¯ä»¥é€šè¿‡ç»§æ‰¿ <code>AbstractMap</code> æ¥å‡å°‘é‡å¤ç¼–ç ã€‚</li>
<li><code>SortedMap</code> ç»§æ‰¿äº† <code>Map</code> çš„æ¥å£ã€‚<code>SortedMap</code> ä¸­çš„å†…å®¹æ˜¯æ’åºçš„é”®å€¼å¯¹ï¼Œæ’åºçš„æ–¹æ³•æ˜¯é€šè¿‡å®ç°æ¯”è¾ƒå™¨(<code>Comparator</code>)å®Œæˆçš„ã€‚</li>
<li><code>NavigableMap</code> ç»§æ‰¿äº† <code>SortedMap</code> çš„æ¥å£ã€‚ç›¸æ¯”äº <code>SortedMap</code>ï¼Œ<code>NavigableMap</code> æœ‰ä¸€ç³»åˆ—çš„â€œå¯¼èˆªâ€æ–¹æ³•ï¼›å¦‚â€è·å–å¤§äº&#x2F;ç­‰äºæŸå¯¹è±¡çš„é”®å€¼å¯¹â€ã€â€œè·å–å°äº&#x2F;ç­‰äºæŸå¯¹è±¡çš„é”®å€¼å¯¹â€ç­‰ç­‰ã€‚</li>
<li><code>HashMap</code> ç»§æ‰¿äº† <code>AbstractMap</code>ï¼Œä½†æ²¡å®ç° <code>NavigableMap</code> æ¥å£ã€‚<code>HashMap</code> çš„ä¸»è¦ä½œç”¨æ˜¯å‚¨å­˜æ— åºçš„é”®å€¼å¯¹ï¼Œè€Œ <code>Hash</code> ä¹Ÿä½“ç°äº†å®ƒçš„æŸ¥æ‰¾æ•ˆç‡å¾ˆé«˜ã€‚<code>HashMap</code> æ˜¯ä½¿ç”¨æœ€å¹¿æ³›çš„ <code>Map</code>ã€‚</li>
<li><code>Hashtable</code> è™½ç„¶æ²¡æœ‰ç»§æ‰¿ <code>AbstractMap</code>ï¼Œä½†å®ƒç»§æ‰¿äº† <code>Dictionary</code>ï¼ˆ<code>Dictionary</code> ä¹Ÿæ˜¯é”®å€¼å¯¹çš„æ¥å£ï¼‰ï¼Œè€Œä¸”ä¹Ÿå®ç° <code>Map</code> æ¥å£ã€‚å› æ­¤ï¼Œ<code>Hashtable</code> çš„ä¸»è¦ä½œç”¨æ˜¯å‚¨å­˜æ— åºçš„é”®å€¼å¯¹ã€‚å’Œ HashMap ç›¸æ¯”ï¼Œ<code>Hashtable</code> åœ¨å®ƒçš„ä¸»è¦æ–¹æ³•ä¸­ä½¿ç”¨ <code>synchronized</code> å…³é”®å­—ä¿®é¥°ï¼Œæ¥ä¿è¯çº¿ç¨‹å®‰å…¨ã€‚ä½†æ˜¯ï¼Œç”±äºå®ƒçš„é”ç²’åº¦å¤ªå¤§ï¼Œéå¸¸å½±å“è¯»å†™é€Ÿåº¦ï¼Œæ‰€ä»¥ï¼Œç°ä»£ Java ç¨‹åºå‡ ä¹ä¸ä¼šä½¿ç”¨ <code>Hashtable</code> ï¼Œå¦‚æœéœ€è¦ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œä¸€èˆ¬ä¼šç”¨ <code>ConcurrentHashMap</code> æ¥æ›¿ä»£ã€‚</li>
<li><code>TreeMap</code> ç»§æ‰¿äº† <code>AbstractMap</code>ï¼Œä¸”å®ç°äº† <code>NavigableMap</code> æ¥å£ã€‚<code>TreeMap</code> çš„ä¸»è¦ä½œç”¨æ˜¯å‚¨å­˜æœ‰åºçš„é”®å€¼å¯¹ï¼Œæ’åºä¾æ®æ ¹æ®å…ƒç´ ç±»å‹çš„ <code>Comparator</code> è€Œå®šã€‚</li>
<li><code>WeakHashMap</code> ç»§æ‰¿äº† <code>AbstractMap</code>ã€‚<code>WeakHashMap</code> çš„é”®æ˜¯<strong>å¼±å¼•ç”¨</strong> ï¼ˆå³ <code>WeakReference</code>ï¼‰ï¼Œå®ƒçš„ä¸»è¦ä½œç”¨æ˜¯å½“ GC å†…å­˜ä¸è¶³æ—¶ï¼Œä¼šè‡ªåŠ¨å°† <code>WeakHashMap</code> ä¸­çš„ key å›æ”¶ï¼Œè¿™é¿å…äº† <code>WeakHashMap</code> çš„å†…å­˜ç©ºé—´æ— é™è†¨èƒ€ã€‚å¾ˆæ˜æ˜¾ï¼Œ<code>WeakHashMap</code> é€‚ç”¨äºä½œä¸ºç¼“å­˜ã€‚</li>
</ul>
<h3 id="Map-æ¥å£"><a href="#Map-æ¥å£" class="headerlink" title="Map æ¥å£"></a>Map æ¥å£</h3><p>Map çš„å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Map</span>&lt;K,V&gt; &#123; &#125;</span><br></pre></td></tr></table></figure>

<p>Map æ˜¯ä¸€ä¸ªç”¨äºä¿å­˜é”®å€¼å¯¹(key-value)çš„æ¥å£ã€‚<strong>Map ä¸­ä¸èƒ½åŒ…å«é‡å¤çš„é”®ï¼›æ¯ä¸ªé”®æœ€å¤šåªèƒ½æ˜ å°„åˆ°ä¸€ä¸ªå€¼ã€‚</strong></p>
<p>Map æ¥å£æä¾›ä¸‰ç§ <code>Collection</code> è§†å›¾ï¼Œå…è®¸ä»¥<strong>é”®é›†</strong>ã€<strong>å€¼é›†</strong>æˆ–<strong>é”®-å€¼æ˜ å°„å…³ç³»é›†</strong>çš„å½¢å¼è®¿é—®æ•°æ®ã€‚</p>
<p>Map æœ‰äº›å®ç°ç±»ï¼Œå¯ä»¥æœ‰åºçš„ä¿å­˜å…ƒç´ ï¼Œå¦‚ <code>TreeMap</code>ï¼›å¦ä¸€äº›å®ç°ç±»åˆ™ä¸ä¿è¯é¡ºåºï¼Œå¦‚ <code>HashMap</code> ç±»ã€‚</p>
<p>Map çš„å®ç°ç±»åº”è¯¥æä¾› 2 ä¸ªâ€œæ ‡å‡†çš„â€æ„é€ æ–¹æ³•ï¼š</p>
<ul>
<li>voidï¼ˆæ— å‚æ•°ï¼‰æ„é€ æ–¹æ³•ï¼Œç”¨äºåˆ›å»ºç©º Mapï¼›</li>
<li>å¸¦æœ‰å•ä¸ª Map ç±»å‹å‚æ•°çš„æ„é€ æ–¹æ³•ï¼Œç”¨äºåˆ›å»ºä¸€ä¸ªä¸å…¶å‚æ•°å…·æœ‰ç›¸åŒé”®-å€¼æ˜ å°„å…³ç³»çš„æ–° Mapã€‚</li>
</ul>
<p>å®é™…ä¸Šï¼Œåä¸€ä¸ªæ„é€ æ–¹æ³•å…è®¸ç”¨æˆ·å¤åˆ¶ä»»æ„ Mapï¼Œç”Ÿæˆæ‰€éœ€ç±»çš„ä¸€ä¸ªç­‰ä»· Mapã€‚å°½ç®¡æ— æ³•å¼ºåˆ¶æ‰§è¡Œæ­¤å»ºè®®ï¼ˆå› ä¸ºæ¥å£ä¸èƒ½åŒ…å«æ„é€ æ–¹æ³•ï¼‰ï¼Œä½†æ˜¯ JDK ä¸­æ‰€æœ‰é€šç”¨çš„ Map å®ç°éƒ½éµä»å®ƒã€‚</p>
<h3 id="Map-Entry-æ¥å£"><a href="#Map-Entry-æ¥å£" class="headerlink" title="Map.Entry æ¥å£"></a>Map.Entry æ¥å£</h3><p><code>Map.Entry</code> ä¸€èˆ¬ç”¨äºé€šè¿‡è¿­ä»£å™¨ï¼ˆ<code>Iterator</code>ï¼‰è®¿é—®é—® <code>Map</code>ã€‚</p>
<p><code>Map.Entry</code> æ˜¯ Map ä¸­å†…éƒ¨çš„ä¸€ä¸ªæ¥å£ï¼Œ<code>Map.Entry</code> ä»£è¡¨äº† <strong>é”®å€¼å¯¹</strong> å®ä½“ï¼ŒMap é€šè¿‡ <code>entrySet()</code> è·å– <code>Map.Entry</code> é›†åˆï¼Œä»è€Œé€šè¿‡è¯¥é›†åˆå®ç°å¯¹é”®å€¼å¯¹çš„æ“ä½œã€‚</p>
<h3 id="AbstractMap-æŠ½è±¡ç±»"><a href="#AbstractMap-æŠ½è±¡ç±»" class="headerlink" title="AbstractMap æŠ½è±¡ç±»"></a>AbstractMap æŠ½è±¡ç±»</h3><p><code>AbstractMap</code> çš„å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">AbstractMap</span>&lt;K,V&gt; <span class="keyword">implements</span> <span class="title class_">Map</span>&lt;K,V&gt; &#123;&#125;</span><br></pre></td></tr></table></figure>

<p><code>AbstractMap</code> æŠ½è±¡ç±»æä¾›äº† <code>Map</code> æ¥å£çš„æ ¸å¿ƒå®ç°ï¼Œä»¥æœ€å¤§é™åº¦åœ°å‡å°‘å®ç° <code>Map</code> æ¥å£æ‰€éœ€çš„å·¥ä½œã€‚</p>
<p>è¦å®ç°ä¸å¯ä¿®æ”¹çš„ Mapï¼Œç¼–ç¨‹äººå‘˜åªéœ€æ‰©å±•æ­¤ç±»å¹¶æä¾› <code>entrySet()</code> æ–¹æ³•çš„å®ç°å³å¯ï¼Œè¯¥æ–¹æ³•å°†è¿”å› <code>Map</code> çš„æ˜ å°„å…³ç³» Set è§†å›¾ã€‚é€šå¸¸ï¼Œè¿”å›çš„ set å°†ä¾æ¬¡åœ¨ <code>AbstractSet</code> ä¸Šå®ç°ã€‚æ­¤ Set ä¸æ”¯æŒ <code>add()</code> æˆ– <code>remove()</code> æ–¹æ³•ï¼Œå…¶è¿­ä»£å™¨ä¹Ÿä¸æ”¯æŒ <code>remove()</code> æ–¹æ³•ã€‚</p>
<p>è¦å®ç°å¯ä¿®æ”¹çš„ <code>Map</code>ï¼Œç¼–ç¨‹äººå‘˜å¿…é¡»å¦å¤–é‡å†™æ­¤ç±»çš„ <code>put</code> æ–¹æ³•ï¼ˆå¦åˆ™å°†æŠ›å‡º <code>UnsupportedOperationException</code>ï¼‰ï¼Œ<code>entrySet().iterator()</code> è¿”å›çš„è¿­ä»£å™¨ä¹Ÿå¿…é¡»å¦å¤–å®ç°å…¶ <code>remove()</code> æ–¹æ³•ã€‚</p>
<h3 id="SortedMap-æ¥å£"><a href="#SortedMap-æ¥å£" class="headerlink" title="SortedMap æ¥å£"></a>SortedMap æ¥å£</h3><p><code>SortedMap</code> çš„å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">SortedMap</span>&lt;K,V&gt; <span class="keyword">extends</span> <span class="title class_">Map</span>&lt;K,V&gt; &#123; &#125;</span><br></pre></td></tr></table></figure>

<p><code>SortedMap</code> ç»§æ‰¿äº† <code>Map</code> ï¼Œå®ƒæ˜¯ä¸€ä¸ªæœ‰åºçš„ <code>Map</code>ã€‚</p>
<p><code>SortedMap</code> çš„æ’åºæ–¹å¼æœ‰ä¸¤ç§ï¼š<strong>è‡ªç„¶æ’åº</strong>æˆ–è€…<strong>ç”¨æˆ·æŒ‡å®šæ¯”è¾ƒå™¨</strong>ã€‚<strong>æ’å…¥æœ‰åº <code>SortedMap</code> çš„æ‰€æœ‰å…ƒç´ éƒ½å¿…é¡»å®ç° <code>Comparable</code> æ¥å£ï¼ˆæˆ–è€…è¢«æŒ‡å®šçš„æ¯”è¾ƒå™¨æ‰€æ¥å—ï¼‰</strong>ã€‚</p>
<p>å¦å¤–ï¼Œæ‰€æœ‰ <code>SortedMap</code> å®ç°ç±»éƒ½åº”è¯¥æä¾› 4 ä¸ªâ€œæ ‡å‡†â€æ„é€ æ–¹æ³•ï¼š</p>
<ol>
<li><code>void</code>ï¼ˆæ— å‚æ•°ï¼‰æ„é€ æ–¹æ³•ï¼Œå®ƒåˆ›å»ºä¸€ä¸ªç©ºçš„æœ‰åº <code>Map</code>ï¼ŒæŒ‰ç…§é”®çš„è‡ªç„¶é¡ºåºè¿›è¡Œæ’åºã€‚</li>
<li>å¸¦æœ‰ä¸€ä¸ª <code>Comparator</code> ç±»å‹å‚æ•°çš„æ„é€ æ–¹æ³•ï¼Œå®ƒåˆ›å»ºä¸€ä¸ªç©ºçš„æœ‰åº <code>Map</code>ï¼Œæ ¹æ®æŒ‡å®šçš„æ¯”è¾ƒå™¨è¿›è¡Œæ’åºã€‚</li>
<li>å¸¦æœ‰ä¸€ä¸ª <code>Map</code> ç±»å‹å‚æ•°çš„æ„é€ æ–¹æ³•ï¼Œå®ƒåˆ›å»ºä¸€ä¸ªæ–°çš„æœ‰åº <code>Map</code>ï¼Œå…¶é”®-å€¼æ˜ å°„å…³ç³»ä¸å‚æ•°ç›¸åŒï¼ŒæŒ‰ç…§é”®çš„è‡ªç„¶é¡ºåºè¿›è¡Œæ’åºã€‚</li>
<li>å¸¦æœ‰ä¸€ä¸ª <code>SortedMap</code> ç±»å‹å‚æ•°çš„æ„é€ æ–¹æ³•ï¼Œå®ƒåˆ›å»ºä¸€ä¸ªæ–°çš„æœ‰åº <code>Map</code>ï¼Œå…¶é”®-å€¼æ˜ å°„å…³ç³»å’Œæ’åºæ–¹æ³•ä¸è¾“å…¥çš„æœ‰åº Map ç›¸åŒã€‚æ— æ³•ä¿è¯å¼ºåˆ¶å®æ–½æ­¤å»ºè®®ï¼Œå› ä¸ºæ¥å£ä¸èƒ½åŒ…å«æ„é€ æ–¹æ³•ã€‚</li>
</ol>
<h3 id="NavigableMap-æ¥å£"><a href="#NavigableMap-æ¥å£" class="headerlink" title="NavigableMap æ¥å£"></a>NavigableMap æ¥å£</h3><p><code>NavigableMap</code> çš„å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="symbol">NavigableMap</span>&lt;<span class="symbol">K</span>,<span class="symbol">V</span>&gt; <span class="symbol">extends</span> <span class="symbol">SortedMap</span>&lt;<span class="symbol">K</span>,<span class="symbol">V</span>&gt; &#123; &#125;</span><br></pre></td></tr></table></figure>

<p><code>NavigableMap</code> ç»§æ‰¿äº† <code>SortedMap</code> ï¼Œå®ƒæä¾›äº†ä¸°å¯Œçš„æŸ¥æ‰¾æ–¹æ³•ã€‚</p>
<p>NavigableMap åˆ†åˆ«æä¾›äº†è·å–â€œé”®â€ã€â€œé”®-å€¼å¯¹â€ã€â€œé”®é›†â€ã€â€œé”®-å€¼å¯¹é›†â€çš„ç›¸å…³æ–¹æ³•ã€‚</p>
<p><code>NavigableMap</code> æä¾›çš„åŠŸèƒ½å¯ä»¥åˆ†ä¸º 4 ç±»ï¼š</p>
<ul>
<li><strong>è·å–é”®-å€¼å¯¹</strong><ul>
<li><code>lowerEntry</code>ã€<code>floorEntry</code>ã€<code>ceilingEntry</code> å’Œ <code>higherEntry</code> æ–¹æ³•ï¼Œå®ƒä»¬åˆ†åˆ«è¿”å›ä¸å°äºã€å°äºç­‰äºã€å¤§äºç­‰äºã€å¤§äºç»™å®šé”®çš„é”®å…³è”çš„ Map.Entry å¯¹è±¡ã€‚</li>
<li><code>firstEntry</code>ã€<code>pollFirstEntry</code>ã€<code>lastEntry</code> å’Œ <code>pollLastEntry</code> æ–¹æ³•ï¼Œå®ƒä»¬è¿”å›å’Œ&#x2F;æˆ–ç§»é™¤æœ€å°å’Œæœ€å¤§çš„æ˜ å°„å…³ç³»ï¼ˆå¦‚æœå­˜åœ¨ï¼‰ï¼Œå¦åˆ™è¿”å› nullã€‚</li>
</ul>
</li>
<li><strong>è·å–é”®</strong>ã€‚è¿™ä¸ªå’Œç¬¬ 1 ç±»æ¯”è¾ƒç±»ä¼¼ã€‚<ul>
<li><code>lowerKey</code>ã€<code>floorKey</code>ã€<code>ceilingKey</code> å’Œ <code>higherKey</code> æ–¹æ³•ï¼Œå®ƒä»¬åˆ†åˆ«è¿”å›ä¸å°äºã€å°äºç­‰äºã€å¤§äºç­‰äºã€å¤§äºç»™å®šé”®çš„é”®ã€‚</li>
</ul>
</li>
<li><strong>è·å–é”®çš„é›†åˆ</strong><ul>
<li><code>navigableKeySet</code>ã€<code>descendingKeySet</code> åˆ†åˆ«è·å–æ­£åº&#x2F;ååºçš„é”®é›†ã€‚</li>
</ul>
</li>
<li><strong>è·å–é”®-å€¼å¯¹çš„å­é›†</strong></li>
</ul>
<h3 id="Dictionary-æŠ½è±¡ç±»"><a href="#Dictionary-æŠ½è±¡ç±»" class="headerlink" title="Dictionary æŠ½è±¡ç±»"></a>Dictionary æŠ½è±¡ç±»</h3><p><code>Dictionary</code> çš„å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">Dictionary</span>&lt;K,V&gt; &#123;&#125;</span><br></pre></td></tr></table></figure>

<p><code>Dictionary</code> æ˜¯ JDK 1.0 å®šä¹‰çš„æ“ä½œé”®å€¼å¯¹çš„æŠ½è±¡ç±»ï¼Œå®ƒåŒ…æ‹¬äº†æ“ä½œé”®å€¼å¯¹çš„åŸºæœ¬æ–¹æ³•ã€‚</p>
<h2 id="HashMap-ç±»"><a href="#HashMap-ç±»" class="headerlink" title="HashMap ç±»"></a>HashMap ç±»</h2><p>ä» <code>HashMap</code> çš„å‘½åï¼Œä¹Ÿå¯ä»¥çœ‹å‡ºï¼š**<code>HashMap</code> ä»¥æ•£åˆ—æ–¹å¼å­˜å‚¨é”®å€¼å¯¹**ã€‚<code>HashMap</code> æ˜¯éçº¿ç¨‹å®‰å…¨çš„ã€‚</p>
<p><strong><code>HashMap</code> å…è®¸ä½¿ç”¨ç©ºå€¼å’Œç©ºé”®</strong>ï¼Œä½† null ä½œä¸ºé”®åªèƒ½æœ‰ä¸€ä¸ªï¼Œnull ä½œä¸ºå€¼å¯ä»¥æœ‰å¤šä¸ªã€‚</p>
<p>ï¼ˆ<code>HashMap</code> ç±»å¤§è‡´ç­‰åŒäº <code>Hashtable</code>ï¼Œé™¤äº†å®ƒæ˜¯ä¸åŒæ­¥çš„å¹¶ä¸”å…è®¸ä¸ºç©ºå€¼ã€‚ï¼‰è¿™ä¸ªç±»ä¸ä¿åºï¼›ç‰¹åˆ«æ˜¯ï¼Œå®ƒçš„å…ƒç´ é¡ºåºå¯èƒ½ä¼šéšç€æ—¶é—´çš„æ¨ç§»å˜åŒ–ã€‚</p>
<p>JDK1.8 ä¹‹å‰ HashMap ç”± æ•°ç»„+é“¾è¡¨ ç»„æˆçš„ï¼Œæ•°ç»„æ˜¯ HashMap çš„ä¸»ä½“ï¼Œé“¾è¡¨åˆ™æ˜¯ä¸»è¦ä¸ºäº†è§£å†³å“ˆå¸Œå†²çªè€Œå­˜åœ¨çš„ï¼ˆâ€œæ‹‰é“¾æ³•â€è§£å†³å†²çªï¼‰ã€‚ JDK1.8 ä»¥åçš„ <code>HashMap</code> åœ¨è§£å†³å“ˆå¸Œå†²çªæ—¶æœ‰äº†è¾ƒå¤§çš„å˜åŒ–ï¼Œå½“é“¾è¡¨é•¿åº¦å¤§äºç­‰äºé˜ˆå€¼ï¼ˆé»˜è®¤ä¸º 8ï¼‰ï¼ˆå°†é“¾è¡¨è½¬æ¢æˆçº¢é»‘æ ‘å‰ä¼šåˆ¤æ–­ï¼Œå¦‚æœå½“å‰æ•°ç»„çš„é•¿åº¦å°äº 64ï¼Œé‚£ä¹ˆä¼šé€‰æ‹©å…ˆè¿›è¡Œæ•°ç»„æ‰©å®¹ï¼Œè€Œä¸æ˜¯è½¬æ¢ä¸ºçº¢é»‘æ ‘ï¼‰æ—¶ï¼Œå°†é“¾è¡¨è½¬åŒ–ä¸ºçº¢é»‘æ ‘ï¼Œä»¥å‡å°‘æœç´¢æ—¶é—´ã€‚</p>
<p><code>HashMap</code> é»˜è®¤çš„åˆå§‹åŒ–å¤§å°ä¸º 16ã€‚ä¹‹åæ¯æ¬¡æ‰©å……ï¼Œå®¹é‡å˜ä¸ºåŸæ¥çš„ 2 å€ã€‚å¹¶ä¸”ï¼Œ <code>HashMap</code> æ€»æ˜¯ä½¿ç”¨ 2 çš„å¹‚ä½œä¸ºå“ˆå¸Œè¡¨çš„å¤§å°ã€‚</p>
<h3 id="JDK8-ä¹‹å‰-HashMap-æ•°æ®ç»“æ„"><a href="#JDK8-ä¹‹å‰-HashMap-æ•°æ®ç»“æ„" class="headerlink" title="JDK8 ä¹‹å‰ HashMap æ•°æ®ç»“æ„"></a>JDK8 ä¹‹å‰ HashMap æ•°æ®ç»“æ„</h3><p>ä¹‹å‰ HashMap åº•å±‚æ˜¯ <strong>æ•°ç»„å’Œé“¾è¡¨</strong> ç»“åˆåœ¨ä¸€èµ·ä½¿ç”¨ä¹Ÿå°±æ˜¯ <strong>é“¾è¡¨æ•£åˆ—</strong>ã€‚</p>
<p>HashMap é€šè¿‡ key çš„ hashCode ç»è¿‡æ‰°åŠ¨å‡½æ•°å¤„ç†è¿‡åå¾—åˆ° hash å€¼ï¼Œç„¶åé€šè¿‡ <code>(n - 1) &amp; hash</code> åˆ¤æ–­å½“å‰å…ƒç´ å­˜æ”¾çš„ä½ç½®ï¼ˆè¿™é‡Œçš„ n æŒ‡çš„æ˜¯æ•°ç»„çš„é•¿åº¦ï¼‰ï¼Œå¦‚æœå½“å‰ä½ç½®å­˜åœ¨å…ƒç´ çš„è¯ï¼Œå°±åˆ¤æ–­è¯¥å…ƒç´ ä¸è¦å­˜å…¥çš„å…ƒç´ çš„ hash å€¼ä»¥åŠ key æ˜¯å¦ç›¸åŒï¼Œå¦‚æœç›¸åŒçš„è¯ï¼Œç›´æ¥è¦†ç›–ï¼Œä¸ç›¸åŒå°±é€šè¿‡æ‹‰é“¾æ³•è§£å†³å†²çªã€‚</p>
<p>æ‰€è°“æ‰°åŠ¨å‡½æ•°æŒ‡çš„å°±æ˜¯ HashMap çš„ hash æ–¹æ³•ã€‚ä½¿ç”¨ hash æ–¹æ³•ä¹Ÿå°±æ˜¯æ‰°åŠ¨å‡½æ•°æ˜¯ä¸ºäº†é˜²æ­¢ä¸€äº›å®ç°æ¯”è¾ƒå·®çš„ hashCode() æ–¹æ³• æ¢å¥è¯è¯´ä½¿ç”¨æ‰°åŠ¨å‡½æ•°ä¹‹åå¯ä»¥å‡å°‘ç¢°æ’ã€‚</p>
<p>JDK7 çš„ HashMap çš„ hash æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="type">int</span> <span class="title function_">hash</span><span class="params">(<span class="type">int</span> h)</span> &#123;</span><br><span class="line">    h ^= (h &gt;&gt;&gt; <span class="number">20</span>) ^ (h &gt;&gt;&gt; <span class="number">12</span>);</span><br><span class="line">    <span class="keyword">return</span> h ^ (h &gt;&gt;&gt; <span class="number">7</span>) ^ (h &gt;&gt;&gt; <span class="number">4</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="JDK8-ä¹‹å-HashMap-æ•°æ®ç»“æ„"><a href="#JDK8-ä¹‹å-HashMap-æ•°æ®ç»“æ„" class="headerlink" title="JDK8 ä¹‹å HashMap æ•°æ®ç»“æ„"></a>JDK8 ä¹‹å HashMap æ•°æ®ç»“æ„</h3><p><code>HashMap</code> çš„ä¸»è¦å­—æ®µå®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HashMap</span>&lt;K,V&gt; <span class="keyword">extends</span> <span class="title class_">AbstractMap</span>&lt;K,V&gt;</span><br><span class="line">    <span class="keyword">implements</span> <span class="title class_">Map</span>&lt;K,V&gt;, Cloneable, Serializable &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¯¥è¡¨åœ¨åˆæ¬¡ä½¿ç”¨æ—¶åˆå§‹åŒ–ï¼Œå¹¶æ ¹æ®éœ€è¦è°ƒæ•´å¤§å°ã€‚åˆ†é…æ—¶ï¼Œé•¿åº¦æ€»æ˜¯2çš„å¹‚ã€‚</span></span><br><span class="line">    <span class="keyword">transient</span> Node&lt;K,V&gt;[] table;</span><br><span class="line">    <span class="comment">// ä¿å­˜ç¼“å­˜çš„ entrySet()ã€‚è¯·æ³¨æ„ï¼ŒAbstractMap å­—æ®µç”¨äº keySet() å’Œ values()ã€‚</span></span><br><span class="line">    <span class="keyword">transient</span> Set&lt;Map.Entry&lt;K,V&gt;&gt; entrySet;</span><br><span class="line">    <span class="comment">// map ä¸­çš„é”®å€¼å¯¹æ•°</span></span><br><span class="line">    <span class="keyword">transient</span> <span class="type">int</span> size;</span><br><span class="line">    <span class="comment">// è¿™ä¸ªHashMapè¢«ç»“æ„ä¿®æ”¹çš„æ¬¡æ•°ç»“æ„ä¿®æ”¹æ˜¯é‚£äº›æ”¹å˜HashMapä¸­çš„æ˜ å°„æ•°é‡æˆ–è€…ä¿®æ”¹å…¶å†…éƒ¨ç»“æ„ï¼ˆä¾‹å¦‚ï¼Œé‡æ–°æ•£åˆ—ï¼‰çš„ä¿®æ”¹ã€‚</span></span><br><span class="line">    <span class="keyword">transient</span> <span class="type">int</span> modCount;</span><br><span class="line">    <span class="comment">// ä¸‹ä¸€ä¸ªè°ƒæ•´å¤§å°çš„å€¼ï¼ˆå®¹é‡*è´Ÿè½½å› å­ï¼‰ã€‚</span></span><br><span class="line">    <span class="type">int</span> threshold;</span><br><span class="line">    <span class="comment">// æ•£åˆ—è¡¨çš„è´Ÿè½½å› å­</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">float</span> loadFactor;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong><code>HashMap</code> æœ‰ä¸¤ä¸ªå½±å“å…¶æ€§èƒ½çš„å‚æ•°ï¼šåˆå§‹å®¹é‡å’Œè´Ÿè½½å› å­</strong>ã€‚</p>
<ul>
<li><code>size</code> - åˆå§‹å®¹é‡ã€‚é»˜è®¤ä¸º 16ï¼Œæ¯æ¬¡å®¹é‡ä¸å¤Ÿè‡ªåŠ¨æ‰©å®¹ã€‚å®¹é‡æ˜¯å“ˆå¸Œè¡¨ä¸­æ¡¶çš„æ•°é‡ï¼Œåˆå§‹å®¹é‡å°±æ˜¯å“ˆå¸Œè¡¨åˆ›å»ºæ—¶çš„å®¹é‡ã€‚</li>
<li><code>loadFactor</code> - è´Ÿè½½å› å­ã€‚è‡ªåŠ¨æ‰©å®¹ä¹‹å‰è¢«å…è®¸çš„æœ€å¤§é¥±å’Œé‡ï¼Œé»˜è®¤ 0.75ã€‚è´Ÿè½½å› å­æ˜¯æ•£åˆ—è¡¨åœ¨å…¶å®¹é‡è‡ªåŠ¨æ‰©å®¹ä¹‹å‰è¢«å…è®¸çš„æœ€å¤§é¥±å’Œé‡ã€‚å½“å“ˆå¸Œè¡¨ä¸­çš„ entry æ•°é‡è¶…è¿‡è´Ÿè½½å› å­å’Œå½“å‰å®¹é‡çš„ä¹˜ç§¯æ—¶ï¼Œæ•£åˆ—è¡¨å°±ä¼šè¢«é‡æ–°æ˜ å°„ï¼ˆå³é‡å»ºå†…éƒ¨æ•°æ®ç»“æ„ï¼‰ï¼Œä¸€èˆ¬æ•£åˆ—è¡¨å¤§çº¦æ˜¯å­˜å‚¨æ¡¶æ•°é‡çš„ä¸¤å€ã€‚</li>
</ul>
<p>é€šå¸¸ï¼Œé»˜è®¤è´Ÿè½½å› å­ï¼ˆ0.75ï¼‰åœ¨æ—¶é—´å’Œç©ºé—´æˆæœ¬ä¹‹é—´æä¾›äº†è‰¯å¥½çš„å¹³è¡¡ã€‚è¾ƒé«˜çš„å€¼ä¼šå‡å°‘ç©ºé—´å¼€é”€ï¼Œä½†ä¼šå¢åŠ æŸ¥æ‰¾æˆæœ¬ï¼ˆåæ˜ åœ¨å¤§éƒ¨åˆ† <code>HashMap</code> ç±»çš„æ“ä½œä¸­ï¼ŒåŒ…æ‹¬ <code>get</code> å’Œ <code>put</code>ï¼‰ã€‚åœ¨è®¾ç½®åˆå§‹å®¹é‡æ—¶ï¼Œåº”è€ƒè™‘æ˜ å°„ä¸­çš„æ¡ç›®æ•°é‡åŠå…¶è´Ÿè½½å› å­ï¼Œä»¥å°½é‡å‡å°‘é‡æ–°è¿è¡Œæ“ä½œçš„æ¬¡æ•°ã€‚å¦‚æœåˆå§‹å®¹é‡å¤§äºæœ€å¤§å…¥å£æ•°é™¤ä»¥è´Ÿè½½å› å­ï¼Œåˆ™ä¸ä¼šå‘ç”Ÿé‡æ–°åˆ·æ–°æ“ä½œã€‚</p>
<p>å¦‚æœè®¸å¤šæ˜ å°„è¦å­˜å‚¨åœ¨ <code>HashMap</code> å®ä¾‹ä¸­ï¼Œä½¿ç”¨è¶³å¤Ÿå¤§çš„å®¹é‡åˆ›å»ºæ˜ å°„å°†å…è®¸æ˜ å°„å­˜å‚¨çš„æ•ˆç‡é«˜äºæ ¹æ®éœ€è¦æ‰§è¡Œè‡ªåŠ¨é‡æ–°æ•£åˆ—ä»¥å¢é•¿è¡¨ã€‚è¯·æ³¨æ„ï¼Œä½¿ç”¨å¤šä¸ªå…·æœ‰ç›¸åŒ <code>hashCode()</code> çš„å¯†é’¥æ˜¯é™ä½ä»»ä½•æ•£åˆ—è¡¨æ€§èƒ½çš„ä¸€ä¸ªå¯é æ–¹æ³•ã€‚ä¸ºäº†æ”¹å–„å½±å“ï¼Œå½“é”®æ˜¯ <code>Comparable</code> æ—¶ï¼Œè¯¥ç±»å¯ä»¥ä½¿ç”¨é”®ä¹‹é—´çš„æ¯”è¾ƒé¡ºåºæ¥å¸®åŠ©æ–­å¼€å…³ç³»ã€‚</p>
<p>JDK8 çš„ HashMap çš„ hash æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">hash</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">      <span class="type">int</span> h;</span><br><span class="line">      <span class="comment">// key.hashCode()ï¼šè¿”å›æ•£åˆ—å€¼ä¹Ÿå°±æ˜¯hashcode</span></span><br><span class="line">      <span class="comment">// ^ï¼šæŒ‰ä½å¼‚æˆ–</span></span><br><span class="line">      <span class="comment">// &gt;&gt;&gt;:æ— ç¬¦å·å³ç§»ï¼Œå¿½ç•¥ç¬¦å·ä½ï¼Œç©ºä½éƒ½ä»¥0è¡¥é½</span></span><br><span class="line">      <span class="keyword">return</span> (key == <span class="literal">null</span>) ? <span class="number">0</span> : (h = key.hashCode()) ^ (h &gt;&gt;&gt; <span class="number">16</span>);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨ <code>get</code> å’Œ <code>put</code> çš„è¿‡ç¨‹ä¸­ï¼Œè®¡ç®—ä¸‹æ ‡æ—¶ï¼Œå…ˆå¯¹ <code>hashCode</code> è¿›è¡Œ <code>hash</code> æ“ä½œï¼Œç„¶åå†é€šè¿‡ <code>hash</code> å€¼è¿›ä¸€æ­¥è®¡ç®—ä¸‹æ ‡ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<div align="center">
<img src="https://raw.githubusercontent.com/dunwu/images/master/cs/java/javacore/container/HashMap-hash.png" />
</div>

<p>åœ¨å¯¹ <code>hashCode()</code> è®¡ç®— hash æ—¶å…·ä½“å®ç°æ˜¯è¿™æ ·çš„ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">hash</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">    <span class="type">int</span> h;</span><br><span class="line">    <span class="keyword">return</span> (key == <span class="literal">null</span>) ? <span class="number">0</span> : (h = key.hashCode()) ^ (h &gt;&gt;&gt; <span class="number">16</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°è¿™ä¸ªæ–¹æ³•å¤§æ¦‚çš„ä½œç”¨å°±æ˜¯ï¼šé«˜ 16bit ä¸å˜ï¼Œä½ 16bit å’Œé«˜ 16bit åšäº†ä¸€ä¸ªå¼‚æˆ–ã€‚</p>
<p>åœ¨è®¾è®¡ hash æ–¹æ³•æ—¶ï¼Œå› ä¸ºç›®å‰çš„ table é•¿åº¦ n ä¸º 2 çš„å¹‚ï¼Œè€Œè®¡ç®—ä¸‹æ ‡çš„æ—¶å€™ï¼Œæ˜¯è¿™æ ·å®ç°çš„(ä½¿ç”¨ <code>&amp;</code> ä½æ“ä½œï¼Œè€Œé <code>%</code> æ±‚ä½™)ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(n - <span class="number">1</span>) &amp; hash</span><br></pre></td></tr></table></figure>

<p>è®¾è®¡è€…è®¤ä¸ºè¿™æ–¹æ³•å¾ˆå®¹æ˜“å‘ç”Ÿç¢°æ’ã€‚ä¸ºä»€ä¹ˆè¿™ä¹ˆè¯´å‘¢ï¼Ÿä¸å¦¨æ€è€ƒä¸€ä¸‹ï¼Œåœ¨ n - 1 ä¸º 15(0x1111) æ—¶ï¼Œå…¶å®æ•£åˆ—çœŸæ­£ç”Ÿæ•ˆçš„åªæ˜¯ä½ 4bit çš„æœ‰æ•ˆä½ï¼Œå½“ç„¶å®¹æ˜“ç¢°æ’äº†ã€‚</p>
<p>å› æ­¤ï¼Œè®¾è®¡è€…æƒ³äº†ä¸€ä¸ªé¡¾å…¨å¤§å±€çš„æ–¹æ³•(ç»¼åˆè€ƒè™‘äº†é€Ÿåº¦ã€ä½œç”¨ã€è´¨é‡)ï¼Œå°±æ˜¯æŠŠé«˜ 16bit å’Œä½ 16bit å¼‚æˆ–äº†ä¸€ä¸‹ã€‚è®¾è®¡è€…è¿˜è§£é‡Šåˆ°å› ä¸ºç°åœ¨å¤§å¤šæ•°çš„ hashCode çš„åˆ†å¸ƒå·²ç»å¾ˆä¸é”™äº†ï¼Œå°±ç®—æ˜¯å‘ç”Ÿäº†ç¢°æ’ä¹Ÿç”¨ O(logn)çš„ tree å»åšäº†ã€‚ä»…ä»…å¼‚æˆ–ä¸€ä¸‹ï¼Œæ—¢å‡å°‘äº†ç³»ç»Ÿçš„å¼€é”€ï¼Œä¹Ÿä¸ä¼šé€ æˆçš„å› ä¸ºé«˜ä½æ²¡æœ‰å‚ä¸ä¸‹æ ‡çš„è®¡ç®—(table é•¿åº¦æ¯”è¾ƒå°æ—¶)ï¼Œä»è€Œå¼•èµ·çš„ç¢°æ’ã€‚</p>
<p>å¦‚æœè¿˜æ˜¯äº§ç”Ÿäº†é¢‘ç¹çš„ç¢°æ’ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿä½œè€…æ³¨é‡Šè¯´ï¼Œä»–ä»¬ä½¿ç”¨æ ‘æ¥å¤„ç†é¢‘ç¹çš„ç¢°æ’(we use trees to handle large sets of collisions in bins)ï¼Œåœ¨ <a target="_blank" rel="noopener" href="http://openjdk.java.net/jeps/180">JEP-180</a> ä¸­ï¼Œæè¿°äº†è¿™ä¸ªé—®é¢˜ï¼š</p>
<blockquote>
<p>Improve the performance of java.util.HashMap under high hash-collision conditions by using balanced trees rather than linked lists to store map entries. Implement the same improvement in the LinkedHashMap class.</p>
</blockquote>
<p>ä¹‹å‰å·²ç»æè¿‡ï¼Œåœ¨è·å– HashMap çš„å…ƒç´ æ—¶ï¼ŒåŸºæœ¬åˆ†ä¸¤æ­¥ï¼š</p>
<ol>
<li><p>é¦–å…ˆæ ¹æ® hashCode() åš hashï¼Œç„¶åç¡®å®š bucket çš„ indexï¼›</p>
</li>
<li><p>å¦‚æœ bucket çš„èŠ‚ç‚¹çš„ key ä¸æ˜¯æˆ‘ä»¬éœ€è¦çš„ï¼Œåˆ™é€šè¿‡ keys.equals()åœ¨é“¾ä¸­æ‰¾ã€‚</p>
</li>
</ol>
<p>åœ¨ JDK8 ä¹‹å‰çš„å®ç°ä¸­æ˜¯ç”¨é“¾è¡¨è§£å†³å†²çªçš„ï¼Œåœ¨äº§ç”Ÿç¢°æ’çš„æƒ…å†µä¸‹ï¼Œè¿›è¡Œ get æ—¶ï¼Œä¸¤æ­¥çš„æ—¶é—´å¤æ‚åº¦æ˜¯ O(1)+O(n)ã€‚å› æ­¤ï¼Œå½“ç¢°æ’å¾ˆå‰å®³çš„æ—¶å€™ n å¾ˆå¤§ï¼ŒO(n)çš„é€Ÿåº¦æ˜¾ç„¶æ˜¯å½±å“é€Ÿåº¦çš„ã€‚</p>
<p>å› æ­¤åœ¨ JDK8 ä¸­ï¼Œåˆ©ç”¨çº¢é»‘æ ‘æ›¿æ¢é“¾è¡¨ï¼Œè¿™æ ·å¤æ‚åº¦å°±å˜æˆäº† O(1)+O(logn)äº†ï¼Œè¿™æ ·åœ¨ n å¾ˆå¤§çš„æ—¶å€™ï¼Œèƒ½å¤Ÿæ¯”è¾ƒç†æƒ³çš„è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œåœ¨ JDK8ï¼šHashMap çš„æ€§èƒ½æå‡ä¸€æ–‡ä¸­æœ‰æ€§èƒ½æµ‹è¯•çš„ç»“æœã€‚</p>
<h3 id="HashMap-æ„é€ æ–¹æ³•"><a href="#HashMap-æ„é€ æ–¹æ³•" class="headerlink" title="HashMap æ„é€ æ–¹æ³•"></a>HashMap æ„é€ æ–¹æ³•</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">HashMap</span><span class="params">()</span>; <span class="comment">// é»˜è®¤è´Ÿè½½å› å­0.75</span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">HashMap</span><span class="params">(<span class="type">int</span> initialCapacity)</span>; <span class="comment">// é»˜è®¤è´Ÿè½½å› å­0.75ï¼›ä»¥ initialCapacity åˆå§‹åŒ–å®¹é‡</span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">HashMap</span><span class="params">(<span class="type">int</span> initialCapacity, <span class="type">float</span> loadFactor)</span>; <span class="comment">// ä»¥ initialCapacity åˆå§‹åŒ–å®¹é‡ï¼›ä»¥ loadFactor åˆå§‹åŒ–è´Ÿè½½å› å­</span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">HashMap</span><span class="params">(Map&lt;? extends K, ? extends V&gt; m)</span> <span class="comment">// é»˜è®¤è´Ÿè½½å› å­0.75</span></span><br></pre></td></tr></table></figure>

<h3 id="put-æ–¹æ³•çš„å®ç°"><a href="#put-æ–¹æ³•çš„å®ç°" class="headerlink" title="put æ–¹æ³•çš„å®ç°"></a>put æ–¹æ³•çš„å®ç°</h3><p>put æ–¹æ³•å¤§è‡´çš„æ€è·¯ä¸ºï¼š</p>
<ul>
<li>å¯¹ key çš„ <code>hashCode()</code> åš hash è®¡ç®—ï¼Œç„¶åæ ¹æ® hash å€¼å†è®¡ç®— Node çš„å­˜å‚¨ä½ç½®;</li>
<li>å¦‚æœæ²¡æœ‰å“ˆå¸Œç¢°æ’ï¼Œç›´æ¥æ”¾åˆ°æ¡¶é‡Œï¼›å¦‚æœæœ‰å“ˆå¸Œç¢°æ’ï¼Œä»¥é“¾è¡¨çš„å½¢å¼å­˜åœ¨æ¡¶åã€‚</li>
<li>å¦‚æœå“ˆå¸Œç¢°æ’å¯¼è‡´é“¾è¡¨è¿‡é•¿(å¤§äºç­‰äº <code>TREEIFY_THRESHOLD</code>ï¼Œæ•°å€¼ä¸º 8)ï¼Œå°±æŠŠé“¾è¡¨è½¬æ¢æˆçº¢é»‘æ ‘ï¼›</li>
<li>å¦‚æœèŠ‚ç‚¹å·²ç»å­˜åœ¨å°±æ›¿æ¢æ—§å€¼</li>
<li>æ¡¶æ•°é‡è¶…è¿‡å®¹é‡*è´Ÿè½½å› å­ï¼ˆå³ load factor * current capacityï¼‰ï¼ŒHashMap è°ƒç”¨ <code>resize</code> è‡ªåŠ¨æ‰©å®¹ä¸€å€</li>
</ul>
<p>å…·ä½“ä»£ç çš„å®ç°å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> V <span class="title function_">put</span><span class="params">(K key, V value)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> putVal(hash(key), key, value, <span class="literal">false</span>, <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// hashcode æ— ç¬¦å·ä½ç§» 16 ä½</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">hash</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">    <span class="type">int</span> h;</span><br><span class="line">    <span class="keyword">return</span> (key == <span class="literal">null</span>) ? <span class="number">0</span> : (h = key.hashCode()) ^ (h &gt;&gt;&gt; <span class="number">16</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> V <span class="title function_">putVal</span><span class="params">(<span class="type">int</span> hash, K key, V value, <span class="type">boolean</span> onlyIfAbsent,</span></span><br><span class="line"><span class="params">                   <span class="type">boolean</span> evict)</span> &#123;</span><br><span class="line">    Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; p; <span class="type">int</span> n, i;</span><br><span class="line">    <span class="comment">// tab ä¸ºç©ºåˆ™åˆ›å»º</span></span><br><span class="line">    <span class="keyword">if</span> ((tab = table) == <span class="literal">null</span> || (n = tab.length) == <span class="number">0</span>)</span><br><span class="line">        n = (tab = resize()).length;</span><br><span class="line">    <span class="comment">// è®¡ç®— indexï¼Œå¹¶å¯¹ null åšå¤„ç†</span></span><br><span class="line">    <span class="keyword">if</span> ((p = tab[i = (n - <span class="number">1</span>) &amp; hash]) == <span class="literal">null</span>)</span><br><span class="line">        tab[i] = newNode(hash, key, value, <span class="literal">null</span>);</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        Node&lt;K,V&gt; e; K k;</span><br><span class="line">        <span class="comment">// èŠ‚ç‚¹å­˜åœ¨</span></span><br><span class="line">        <span class="keyword">if</span> (p.hash == hash &amp;&amp;</span><br><span class="line">            ((k = p.key) == key || (key != <span class="literal">null</span> &amp;&amp; key.equals(k))))</span><br><span class="line">            e = p;</span><br><span class="line">        <span class="comment">// è¯¥é“¾ä¸ºæ ‘</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (p <span class="keyword">instanceof</span> TreeNode)</span><br><span class="line">            e = ((TreeNode&lt;K,V&gt;)p).putTreeVal(<span class="built_in">this</span>, tab, hash, key, value);</span><br><span class="line">        <span class="comment">// è¯¥é“¾ä¸ºé“¾è¡¨</span></span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">binCount</span> <span class="operator">=</span> <span class="number">0</span>; ; ++binCount) &#123;</span><br><span class="line">                <span class="keyword">if</span> ((e = p.next) == <span class="literal">null</span>) &#123;</span><br><span class="line">                    p.next = newNode(hash, key, value, <span class="literal">null</span>);</span><br><span class="line">                    <span class="keyword">if</span> (binCount &gt;= TREEIFY_THRESHOLD - <span class="number">1</span>) <span class="comment">// -1 for 1st</span></span><br><span class="line">                        treeifyBin(tab, hash);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (e.hash == hash &amp;&amp;</span><br><span class="line">                    ((k = e.key) == key || (key != <span class="literal">null</span> &amp;&amp; key.equals(k))))</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                p = e;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å†™å…¥</span></span><br><span class="line">        <span class="keyword">if</span> (e != <span class="literal">null</span>) &#123; <span class="comment">// existing mapping for key</span></span><br><span class="line">            <span class="type">V</span> <span class="variable">oldValue</span> <span class="operator">=</span> e.value;</span><br><span class="line">            <span class="keyword">if</span> (!onlyIfAbsent || oldValue == <span class="literal">null</span>)</span><br><span class="line">                e.value = value;</span><br><span class="line">            afterNodeAccess(e);</span><br><span class="line">            <span class="keyword">return</span> oldValue;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ++modCount;</span><br><span class="line">    <span class="keyword">if</span> (++size &gt; threshold)</span><br><span class="line">        resize();</span><br><span class="line">    afterNodeInsertion(evict);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸ºä»€ä¹ˆè®¡ç®— hash ä½¿ç”¨ hashcode æ— ç¬¦å·ä½ç§» 16 ä½ã€‚</p>
<p>å‡è®¾è¦æ·»åŠ ä¸¤ä¸ªå¯¹è±¡ a å’Œ bï¼Œå¦‚æœæ•°ç»„é•¿åº¦æ˜¯ 16ï¼Œè¿™æ—¶å¯¹è±¡ a å’Œ b é€šè¿‡å…¬å¼ (n - 1) &amp; hash è¿ç®—ï¼Œä¹Ÿå°±æ˜¯ (16-1)ï¼†a.hashCode å’Œ (16-1)ï¼†b.hashCodeï¼Œ15 çš„äºŒè¿›åˆ¶ä¸º 0000000000000000000000000001111ï¼Œå‡è®¾å¯¹è±¡ A çš„ hashCode ä¸º 1000010001110001000001111000000ï¼Œå¯¹è±¡ B çš„ hashCode ä¸º 0111011100111000101000010100000ï¼Œä½ ä¼šå‘ç°ä¸Šè¿°ä¸è¿ç®—ç»“æœéƒ½æ˜¯ 0ã€‚è¿™æ ·çš„å“ˆå¸Œç»“æœå°±å¤ªè®©äººå¤±æœ›äº†ï¼Œå¾ˆæ˜æ˜¾ä¸æ˜¯ä¸€ä¸ªå¥½çš„å“ˆå¸Œç®—æ³•ã€‚</p>
<p>ä½†å¦‚æœæˆ‘ä»¬å°† hashCode å€¼å³ç§» 16 ä½ï¼ˆh &gt;&gt;&gt; 16 ä»£è¡¨æ— ç¬¦å·å³ç§» 16 ä½ï¼‰ï¼Œä¹Ÿå°±æ˜¯å– int ç±»å‹çš„ä¸€åŠï¼Œåˆšå¥½å¯ä»¥å°†è¯¥äºŒè¿›åˆ¶æ•°å¯¹åŠåˆ‡å¼€ï¼Œå¹¶ä¸”ä½¿ç”¨ä½å¼‚æˆ–è¿ç®—ï¼ˆå¦‚æœä¸¤ä¸ªæ•°å¯¹åº”çš„ä½ç½®ç›¸åï¼Œåˆ™ç»“æœä¸º 1ï¼Œåä¹‹ä¸º 0ï¼‰ï¼Œè¿™æ ·çš„è¯ï¼Œå°±èƒ½é¿å…ä¸Šé¢çš„æƒ…å†µå‘ç”Ÿã€‚è¿™å°±æ˜¯ hash() æ–¹æ³•çš„å…·ä½“å®ç°æ–¹å¼ã€‚<strong>ç®€è€Œè¨€ä¹‹ï¼Œå°±æ˜¯å°½é‡æ‰“ä¹± hashCode çœŸæ­£å‚ä¸è¿ç®—çš„ä½ 16 ä½ã€‚</strong></p>
<h3 id="get-æ–¹æ³•çš„å®ç°"><a href="#get-æ–¹æ³•çš„å®ç°" class="headerlink" title="get æ–¹æ³•çš„å®ç°"></a>get æ–¹æ³•çš„å®ç°</h3><p>åœ¨ç†è§£äº† put ä¹‹åï¼Œget å°±å¾ˆç®€å•äº†ã€‚å¤§è‡´æ€è·¯å¦‚ä¸‹ï¼š</p>
<ul>
<li><p>å¯¹ key çš„ hashCode() åš hash è®¡ç®—ï¼Œç„¶åæ ¹æ® hash å€¼å†è®¡ç®—æ¡¶çš„ index</p>
</li>
<li><p>å¦‚æœæ¡¶ä¸­çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹å‘½ä¸­ï¼Œç›´æ¥è¿”å›ï¼›</p>
</li>
<li><p>å¦‚æœæœ‰å†²çªï¼Œåˆ™é€šè¿‡ <code>key.equals(k)</code> å»æŸ¥æ‰¾å¯¹åº”çš„ entry</p>
<ul>
<li><p>è‹¥ä¸ºæ ‘ï¼Œåˆ™åœ¨çº¢é»‘æ ‘ä¸­é€šè¿‡ key.equals(k) æŸ¥æ‰¾ï¼ŒO(logn)ï¼›</p>
</li>
<li><p>è‹¥ä¸ºé“¾è¡¨ï¼Œåˆ™åœ¨é“¾è¡¨ä¸­é€šè¿‡ key.equals(k) æŸ¥æ‰¾ï¼ŒO(n)ã€‚</p>
</li>
</ul>
</li>
</ul>
<p>å…·ä½“ä»£ç çš„å®ç°å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> V <span class="title function_">get</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">    Node&lt;K,V&gt; e;</span><br><span class="line">    <span class="keyword">return</span> (e = getNode(hash(key), key)) == <span class="literal">null</span> ? <span class="literal">null</span> : e.value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> Node&lt;K,V&gt; <span class="title function_">getNode</span><span class="params">(<span class="type">int</span> hash, Object key)</span> &#123;</span><br><span class="line">        Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; first, e; <span class="type">int</span> n; K k;</span><br><span class="line">    <span class="keyword">if</span> ((tab = table) != <span class="literal">null</span> &amp;&amp; (n = tab.length) &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">        (first = tab[(n - <span class="number">1</span>) &amp; hash]) != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// ç›´æ¥å‘½ä¸­</span></span><br><span class="line">        <span class="keyword">if</span> (first.hash == hash &amp;&amp; <span class="comment">// always check first node</span></span><br><span class="line">            ((k = first.key) == key || (key != <span class="literal">null</span> &amp;&amp; key.equals(k))))</span><br><span class="line">            <span class="keyword">return</span> first;</span><br><span class="line">        <span class="comment">// æœªå‘½ä¸­</span></span><br><span class="line">        <span class="keyword">if</span> ((e = first.next) != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// åœ¨æ ‘ä¸­ get</span></span><br><span class="line">            <span class="keyword">if</span> (first <span class="keyword">instanceof</span> TreeNode)</span><br><span class="line">                <span class="keyword">return</span> ((TreeNode&lt;K,V&gt;)first).getTreeNode(hash, key);</span><br><span class="line">            <span class="comment">// åœ¨é“¾è¡¨ä¸­ get</span></span><br><span class="line">            <span class="keyword">do</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (e.hash == hash &amp;&amp;</span><br><span class="line">                    ((k = e.key) == key || (key != <span class="literal">null</span> &amp;&amp; key.equals(k))))</span><br><span class="line">                    <span class="keyword">return</span> e;</span><br><span class="line">            &#125; <span class="keyword">while</span> ((e = e.next) != <span class="literal">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="resize-çš„å®ç°"><a href="#resize-çš„å®ç°" class="headerlink" title="resize çš„å®ç°"></a>resize çš„å®ç°</h3><p>å½“ <code>put</code> æ—¶ï¼Œå¦‚æœå‘ç°ç›®å‰çš„ bucket å ç”¨ç¨‹åº¦å·²ç»è¶…è¿‡äº† Load Factor æ‰€å¸Œæœ›çš„æ¯”ä¾‹ï¼Œé‚£ä¹ˆå°±ä¼šå‘ç”Ÿ resizeã€‚åœ¨ resize çš„è¿‡ç¨‹ï¼Œç®€å•çš„è¯´å°±æ˜¯æŠŠ bucket æ‰©å……ä¸º 2 å€ï¼Œä¹‹åé‡æ–°è®¡ç®— indexï¼ŒæŠŠèŠ‚ç‚¹å†æ”¾åˆ°æ–°çš„ bucket ä¸­ã€‚</p>
<p>å½“è¶…è¿‡é™åˆ¶çš„æ—¶å€™ä¼š resizeï¼Œç„¶è€Œåˆå› ä¸ºæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ 2 æ¬¡å¹‚çš„æ‰©å±•(æŒ‡é•¿åº¦æ‰©ä¸ºåŸæ¥ 2 å€)ï¼Œæ‰€ä»¥ï¼Œå…ƒç´ çš„ä½ç½®è¦ä¹ˆæ˜¯åœ¨åŸä½ç½®ï¼Œè¦ä¹ˆæ˜¯åœ¨åŸä½ç½®å†ç§»åŠ¨ 2 æ¬¡å¹‚çš„ä½ç½®ã€‚</p>
<p>æ€ä¹ˆç†è§£å‘¢ï¼Ÿä¾‹å¦‚æˆ‘ä»¬ä» 16 æ‰©å±•ä¸º 32 æ—¶ï¼Œå…·ä½“çš„å˜åŒ–å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<div align="center">
<img src="https://raw.githubusercontent.com/dunwu/images/master/cs/java/javacore/container/HashMap-resize-01.png" />
</div>

<p>å› æ­¤å…ƒç´ åœ¨é‡æ–°è®¡ç®— hash ä¹‹åï¼Œå› ä¸º n å˜ä¸º 2 å€ï¼Œé‚£ä¹ˆ n-1 çš„ mask èŒƒå›´åœ¨é«˜ä½å¤š 1bit(çº¢è‰²)ï¼Œå› æ­¤æ–°çš„ index å°±ä¼šå‘ç”Ÿè¿™æ ·çš„å˜åŒ–ï¼š</p>
<div align="center">
<img src="https://raw.githubusercontent.com/dunwu/images/master/cs/java/javacore/container/HashMap-resize-02.png" />
</div>

<p>å› æ­¤ï¼Œæˆ‘ä»¬åœ¨æ‰©å…… HashMap çš„æ—¶å€™ï¼Œä¸éœ€è¦é‡æ–°è®¡ç®— hashï¼Œåªéœ€è¦çœ‹çœ‹åŸæ¥çš„ hash å€¼æ–°å¢çš„é‚£ä¸ª bit æ˜¯ 1 è¿˜æ˜¯ 0 å°±å¥½äº†ï¼Œæ˜¯ 0 çš„è¯ç´¢å¼•æ²¡å˜ï¼Œæ˜¯ 1 çš„è¯ç´¢å¼•å˜æˆâ€œåŸç´¢å¼•+oldCapâ€ã€‚å¯ä»¥çœ‹çœ‹ä¸‹å›¾ä¸º 16 æ‰©å……ä¸º 32 çš„ resize ç¤ºæ„å›¾ï¼š</p>
<div align="center">
<img src="https://raw.githubusercontent.com/dunwu/images/master/cs/java/javacore/container/HashMap-resize-03.png" />
</div>

<p>è¿™ä¸ªè®¾è®¡ç¡®å®éå¸¸çš„å·§å¦™ï¼Œæ—¢çœå»äº†é‡æ–°è®¡ç®— hash å€¼çš„æ—¶é—´ï¼Œè€Œä¸”åŒæ—¶ï¼Œç”±äºæ–°å¢çš„ 1bit æ˜¯ 0 è¿˜æ˜¯ 1 å¯ä»¥è®¤ä¸ºæ˜¯éšæœºçš„ï¼Œå› æ­¤ resize çš„è¿‡ç¨‹ï¼Œå‡åŒ€çš„æŠŠä¹‹å‰çš„å†²çªçš„èŠ‚ç‚¹åˆ†æ•£åˆ°æ–°çš„ bucket äº†ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> Node&lt;K,V&gt;[] resize() &#123;</span><br><span class="line">    Node&lt;K,V&gt;[] oldTab = table;</span><br><span class="line">    <span class="type">int</span> <span class="variable">oldCap</span> <span class="operator">=</span> (oldTab == <span class="literal">null</span>) ? <span class="number">0</span> : oldTab.length;</span><br><span class="line">    <span class="type">int</span> <span class="variable">oldThr</span> <span class="operator">=</span> threshold;</span><br><span class="line">    <span class="type">int</span> newCap, newThr = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (oldCap &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// è¶…è¿‡æœ€å¤§å€¼å°±ä¸å†æ‰©å……äº†ï¼Œå°±åªå¥½éšä½ ç¢°æ’å»å§</span></span><br><span class="line">        <span class="keyword">if</span> (oldCap &gt;= MAXIMUM_CAPACITY) &#123;</span><br><span class="line">            threshold = Integer.MAX_VALUE;</span><br><span class="line">            <span class="keyword">return</span> oldTab;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æ²¡è¶…è¿‡æœ€å¤§å€¼ï¼Œå°±æ‰©å……ä¸ºåŸæ¥çš„ 2 å€</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((newCap = oldCap &lt;&lt; <span class="number">1</span>) &lt; MAXIMUM_CAPACITY &amp;&amp;</span><br><span class="line">                    oldCap &gt;= DEFAULT_INITIAL_CAPACITY)</span><br><span class="line">            newThr = oldThr &lt;&lt; <span class="number">1</span>; <span class="comment">// double threshold</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (oldThr &gt; <span class="number">0</span>) <span class="comment">// initial capacity was placed in threshold</span></span><br><span class="line">        newCap = oldThr;</span><br><span class="line">    <span class="keyword">else</span> &#123;               <span class="comment">// zero initial threshold signifies using defaults</span></span><br><span class="line">        newCap = DEFAULT_INITIAL_CAPACITY;</span><br><span class="line">        newThr = (<span class="type">int</span>)(DEFAULT_LOAD_FACTOR * DEFAULT_INITIAL_CAPACITY);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¡ç®—æ–°çš„ resize ä¸Šé™</span></span><br><span class="line">    <span class="keyword">if</span> (newThr == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="type">float</span> <span class="variable">ft</span> <span class="operator">=</span> (<span class="type">float</span>)newCap * loadFactor;</span><br><span class="line">        newThr = (newCap &lt; MAXIMUM_CAPACITY &amp;&amp; ft &lt; (<span class="type">float</span>)MAXIMUM_CAPACITY ?</span><br><span class="line">                    (<span class="type">int</span>)ft : Integer.MAX_VALUE);</span><br><span class="line">    &#125;</span><br><span class="line">    threshold = newThr;</span><br><span class="line">    <span class="meta">@SuppressWarnings(&#123;&quot;rawtypes&quot;,&quot;unchecked&quot;&#125;)</span></span><br><span class="line">        Node&lt;K,V&gt;[] newTab = (Node&lt;K,V&gt;[])<span class="keyword">new</span> <span class="title class_">Node</span>[newCap];</span><br><span class="line">    table = newTab;</span><br><span class="line">    <span class="keyword">if</span> (oldTab != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// æŠŠæ¯ä¸ª bucket éƒ½ç§»åŠ¨åˆ°æ–°çš„ buckets ä¸­</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; oldCap; ++j) &#123;</span><br><span class="line">            Node&lt;K,V&gt; e;</span><br><span class="line">            <span class="keyword">if</span> ((e = oldTab[j]) != <span class="literal">null</span>) &#123;</span><br><span class="line">                oldTab[j] = <span class="literal">null</span>;</span><br><span class="line">                <span class="keyword">if</span> (e.next == <span class="literal">null</span>)</span><br><span class="line">                    newTab[e.hash &amp; (newCap - <span class="number">1</span>)] = e;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (e <span class="keyword">instanceof</span> TreeNode)</span><br><span class="line">                    ((TreeNode&lt;K,V&gt;)e).split(<span class="built_in">this</span>, newTab, j, oldCap);</span><br><span class="line">                <span class="keyword">else</span> &#123; <span class="comment">// preserve order</span></span><br><span class="line">                    Node&lt;K,V&gt; loHead = <span class="literal">null</span>, loTail = <span class="literal">null</span>;</span><br><span class="line">                    Node&lt;K,V&gt; hiHead = <span class="literal">null</span>, hiTail = <span class="literal">null</span>;</span><br><span class="line">                    Node&lt;K,V&gt; next;</span><br><span class="line">                    <span class="keyword">do</span> &#123;</span><br><span class="line">                        next = e.next;</span><br><span class="line">                        <span class="comment">// åŸç´¢å¼•</span></span><br><span class="line">                        <span class="keyword">if</span> ((e.hash &amp; oldCap) == <span class="number">0</span>) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (loTail == <span class="literal">null</span>)</span><br><span class="line">                                loHead = e;</span><br><span class="line">                            <span class="keyword">else</span></span><br><span class="line">                                loTail.next = e;</span><br><span class="line">                            loTail = e;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">// åŸç´¢å¼•+oldCap</span></span><br><span class="line">                        <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="keyword">if</span> (hiTail == <span class="literal">null</span>)</span><br><span class="line">                                hiHead = e;</span><br><span class="line">                            <span class="keyword">else</span></span><br><span class="line">                                hiTail.next = e;</span><br><span class="line">                            hiTail = e;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">while</span> ((e = next) != <span class="literal">null</span>);</span><br><span class="line">                    <span class="comment">// åŸç´¢å¼•æ”¾åˆ°bucketé‡Œ</span></span><br><span class="line">                    <span class="keyword">if</span> (loTail != <span class="literal">null</span>) &#123;</span><br><span class="line">                        loTail.next = <span class="literal">null</span>;</span><br><span class="line">                        newTab[j] = loHead;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// åŸç´¢å¼•+oldCapæ”¾åˆ°bucketé‡Œ</span></span><br><span class="line">                    <span class="keyword">if</span> (hiTail != <span class="literal">null</span>) &#123;</span><br><span class="line">                        hiTail.next = <span class="literal">null</span>;</span><br><span class="line">                        newTab[j + oldCap] = hiHead;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> newTab;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="LinkedHashMap-ç±»"><a href="#LinkedHashMap-ç±»" class="headerlink" title="LinkedHashMap ç±»"></a>LinkedHashMap ç±»</h2><h3 id="LinkedHashMap-è¦ç‚¹"><a href="#LinkedHashMap-è¦ç‚¹" class="headerlink" title="LinkedHashMap è¦ç‚¹"></a>LinkedHashMap è¦ç‚¹</h3><p><strong><code>LinkedHashMap</code> é€šè¿‡ç»´æŠ¤ä¸€ä¸ªä¿å­˜æ‰€æœ‰æ¡ç›®ï¼ˆEntryï¼‰çš„åŒå‘é“¾è¡¨ï¼Œä¿è¯äº†å…ƒç´ è¿­ä»£çš„é¡ºåºï¼ˆå³æ’å…¥é¡ºåºï¼‰</strong>ã€‚</p>
<table>
<thead>
<tr>
<th>å…³æ³¨ç‚¹</th>
<th>ç»“è®º</th>
</tr>
</thead>
<tbody><tr>
<td>æ˜¯å¦å…è®¸é”®å€¼å¯¹ä¸º null</td>
<td>Key å’Œ Value éƒ½å…è®¸ null</td>
</tr>
<tr>
<td>æ˜¯å¦å…è®¸é‡å¤æ•°æ®</td>
<td>Key é‡å¤ä¼šè¦†ç›–ã€Value å…è®¸é‡å¤</td>
</tr>
<tr>
<td>æ˜¯å¦æœ‰åº</td>
<td>æŒ‰ç…§å…ƒç´ æ’å…¥é¡ºåºå­˜å‚¨</td>
</tr>
<tr>
<td>æ˜¯å¦çº¿ç¨‹å®‰å…¨</td>
<td>éçº¿ç¨‹å®‰å…¨</td>
</tr>
</tbody></table>
<h3 id="LinkedHashMap-æ•°æ®ç»“æ„"><a href="#LinkedHashMap-æ•°æ®ç»“æ„" class="headerlink" title="LinkedHashMap æ•°æ®ç»“æ„"></a>LinkedHashMap æ•°æ®ç»“æ„</h3><p><strong><code>LinkedHashMap</code> é€šè¿‡ç»´æŠ¤ä¸€å¯¹ <code>LinkedHashMap.Entry&lt;K,V&gt;</code> ç±»å‹çš„å¤´å°¾æŒ‡é’ˆï¼Œä»¥åŒé“¾è¡¨å½¢å¼ï¼Œä¿å­˜æ‰€æœ‰æ•°æ®</strong>ã€‚</p>
<p>å­¦ä¹ è¿‡æ•°æ®ç»“æ„çš„åŒé“¾è¡¨ï¼Œå°±èƒ½ç†è§£å…¶å…ƒç´ å­˜å‚¨ä»¥åŠè®¿é—®å¿…ç„¶æ˜¯æœ‰åºçš„ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LinkedHashMap</span>&lt;K,V&gt;</span><br><span class="line">    <span class="keyword">extends</span> <span class="title class_">HashMap</span>&lt;K,V&gt;</span><br><span class="line">    <span class="keyword">implements</span> <span class="title class_">Map</span>&lt;K,V&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åŒé“¾è¡¨çš„å¤´æŒ‡é’ˆ</span></span><br><span class="line">    <span class="keyword">transient</span> LinkedHashMap.Entry&lt;K,V&gt; head;</span><br><span class="line">    <span class="comment">// åŒé“¾è¡¨çš„å°¾æŒ‡é’ˆ</span></span><br><span class="line">    <span class="keyword">transient</span> LinkedHashMap.Entry&lt;K,V&gt; tail;</span><br><span class="line">    <span class="comment">// è¿­ä»£æ’åºæ–¹æ³•ï¼štrue è¡¨ç¤ºè®¿é—®é¡ºåºï¼›false è¡¨ç¤ºæ’å…¥é¡ºåº</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">boolean</span> accessOrder;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>LinkedHashMap</code> ç»§æ‰¿äº† <code>HashMap</code> çš„ <code>put</code> æ–¹æ³•ï¼Œæœ¬èº«æ²¡æœ‰å®ç° <code>put</code> æ–¹æ³•ã€‚</p>
<h2 id="TreeMap-ç±»"><a href="#TreeMap-ç±»" class="headerlink" title="TreeMap ç±»"></a>TreeMap ç±»</h2><h3 id="TreeMap-è¦ç‚¹"><a href="#TreeMap-è¦ç‚¹" class="headerlink" title="TreeMap è¦ç‚¹"></a>TreeMap è¦ç‚¹</h3><p><code>TreeMap</code> åŸºäºçº¢é»‘æ ‘å®ç°ã€‚</p>
<p><code>TreeMap</code> æ˜¯æœ‰åºçš„ã€‚å®ƒçš„æ’åºè§„åˆ™æ˜¯ï¼šæ ¹æ® map ä¸­çš„ key çš„è‡ªç„¶è¯­ä¹‰é¡ºåºæˆ–æä¾›çš„æ¯”è¾ƒå™¨ï¼ˆ<code>Comparator</code>ï¼‰çš„è‡ªå®šä¹‰æ¯”è¾ƒé¡ºåºã€‚</p>
<p>TreeMap ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚</p>
<h3 id="TreeMap-åŸç†"><a href="#TreeMap-åŸç†" class="headerlink" title="TreeMap åŸç†"></a>TreeMap åŸç†</h3><h4 id="put-æ–¹æ³•"><a href="#put-æ–¹æ³•" class="headerlink" title="put æ–¹æ³•"></a>put æ–¹æ³•</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> V <span class="title function_">put</span><span class="params">(K key, V value)</span> &#123;</span><br><span class="line">    Entry&lt;K,V&gt; t = root;</span><br><span class="line">    <span class="comment">// å¦‚æœæ ¹èŠ‚ç‚¹ä¸º nullï¼Œæ’å…¥ç¬¬ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">if</span> (t == <span class="literal">null</span>) &#123;</span><br><span class="line">        compare(key, key); <span class="comment">// type (and possibly null) check</span></span><br><span class="line"></span><br><span class="line">        root = <span class="keyword">new</span> <span class="title class_">Entry</span>&lt;&gt;(key, value, <span class="literal">null</span>);</span><br><span class="line">        size = <span class="number">1</span>;</span><br><span class="line">        modCount++;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">int</span> cmp;</span><br><span class="line">    Entry&lt;K,V&gt; parent;</span><br><span class="line">    <span class="comment">// split comparator and comparable paths</span></span><br><span class="line">    Comparator&lt;? <span class="built_in">super</span> K&gt; cpr = comparator;</span><br><span class="line">    <span class="comment">// æ¯ä¸ªèŠ‚ç‚¹çš„å·¦å­©å­èŠ‚ç‚¹çš„å€¼å°äºå®ƒï¼›å³å­©å­èŠ‚ç‚¹çš„å€¼å¤§äºå®ƒ</span></span><br><span class="line">    <span class="comment">// å¦‚æœæœ‰æ¯”è¾ƒå™¨ï¼Œä½¿ç”¨æ¯”è¾ƒå™¨è¿›è¡Œæ¯”è¾ƒ</span></span><br><span class="line">    <span class="keyword">if</span> (cpr != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            parent = t;</span><br><span class="line">            cmp = cpr.compare(key, t.key);</span><br><span class="line">            <span class="keyword">if</span> (cmp &lt; <span class="number">0</span>)</span><br><span class="line">                t = t.left;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (cmp &gt; <span class="number">0</span>)</span><br><span class="line">                t = t.right;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="keyword">return</span> t.setValue(value);</span><br><span class="line">        &#125; <span class="keyword">while</span> (t != <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æ²¡æœ‰æ¯”è¾ƒå™¨ï¼Œä½¿ç”¨ key çš„è‡ªç„¶é¡ºåºè¿›è¡Œæ¯”è¾ƒ</span></span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (key == <span class="literal">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>();</span><br><span class="line">        <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">            Comparable&lt;? <span class="built_in">super</span> K&gt; k = (Comparable&lt;? <span class="built_in">super</span> K&gt;) key;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            parent = t;</span><br><span class="line">            cmp = k.compareTo(t.key);</span><br><span class="line">            <span class="keyword">if</span> (cmp &lt; <span class="number">0</span>)</span><br><span class="line">                t = t.left;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (cmp &gt; <span class="number">0</span>)</span><br><span class="line">                t = t.right;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="keyword">return</span> t.setValue(value);</span><br><span class="line">        &#125; <span class="keyword">while</span> (t != <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// é€šè¿‡ä¸Šé¢çš„éå†æœªæ‰¾åˆ° key å€¼ï¼Œåˆ™æ–°æ’å…¥èŠ‚ç‚¹</span></span><br><span class="line">    Entry&lt;K,V&gt; e = <span class="keyword">new</span> <span class="title class_">Entry</span>&lt;&gt;(key, value, parent);</span><br><span class="line">    <span class="keyword">if</span> (cmp &lt; <span class="number">0</span>)</span><br><span class="line">        parent.left = e;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        parent.right = e;</span><br><span class="line">    <span class="comment">// æ’å…¥åï¼Œä¸ºäº†ç»´æŒçº¢é»‘æ ‘çš„å¹³è¡¡éœ€è¦è°ƒæ•´</span></span><br><span class="line">    fixAfterInsertion(e);</span><br><span class="line">    size++;</span><br><span class="line">    modCount++;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="get-æ–¹æ³•"><a href="#get-æ–¹æ³•" class="headerlink" title="get æ–¹æ³•"></a>get æ–¹æ³•</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> V <span class="title function_">get</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">    Entry&lt;K,V&gt; p = getEntry(key);</span><br><span class="line">    <span class="keyword">return</span> (p==<span class="literal">null</span> ? <span class="literal">null</span> : p.value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> Entry&lt;K,V&gt; <span class="title function_">getEntry</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">    <span class="comment">// Offload comparator-based version for sake of performance</span></span><br><span class="line">    <span class="keyword">if</span> (comparator != <span class="literal">null</span>)</span><br><span class="line">        <span class="keyword">return</span> getEntryUsingComparator(key);</span><br><span class="line">    <span class="keyword">if</span> (key == <span class="literal">null</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>();</span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">        Comparable&lt;? <span class="built_in">super</span> K&gt; k = (Comparable&lt;? <span class="built_in">super</span> K&gt;) key;</span><br><span class="line">    Entry&lt;K,V&gt; p = root;</span><br><span class="line">    <span class="comment">// æŒ‰ç…§äºŒå‰æ ‘æœç´¢çš„æ–¹å¼è¿›è¡Œæœç´¢ï¼Œæœåˆ°è¿”å›</span></span><br><span class="line">    <span class="keyword">while</span> (p != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">cmp</span> <span class="operator">=</span> k.compareTo(p.key);</span><br><span class="line">        <span class="keyword">if</span> (cmp &lt; <span class="number">0</span>)</span><br><span class="line">            p = p.left;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (cmp &gt; <span class="number">0</span>)</span><br><span class="line">            p = p.right;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">return</span> p;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="remove-æ–¹æ³•"><a href="#remove-æ–¹æ³•" class="headerlink" title="remove æ–¹æ³•"></a>remove æ–¹æ³•</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> V <span class="title function_">remove</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">    Entry&lt;K,V&gt; p = getEntry(key);</span><br><span class="line">    <span class="keyword">if</span> (p == <span class="literal">null</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">V</span> <span class="variable">oldValue</span> <span class="operator">=</span> p.value;</span><br><span class="line">    deleteEntry(p);</span><br><span class="line">    <span class="keyword">return</span> oldValue;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">deleteEntry</span><span class="params">(Entry&lt;K,V&gt; p)</span> &#123;</span><br><span class="line">    modCount++;</span><br><span class="line">    size--;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœå½“å‰èŠ‚ç‚¹æœ‰å·¦å³å­©å­èŠ‚ç‚¹ï¼Œä½¿ç”¨åç»§èŠ‚ç‚¹æ›¿æ¢è¦åˆ é™¤çš„èŠ‚ç‚¹</span></span><br><span class="line">    <span class="comment">// If strictly internal, copy successor&#x27;s element to p and then make p</span></span><br><span class="line">    <span class="comment">// point to successor.</span></span><br><span class="line">    <span class="keyword">if</span> (p.left != <span class="literal">null</span> &amp;&amp; p.right != <span class="literal">null</span>) &#123;</span><br><span class="line">        Entry&lt;K,V&gt; s = successor(p);</span><br><span class="line">        p.key = s.key;</span><br><span class="line">        p.value = s.value;</span><br><span class="line">        p = s;</span><br><span class="line">    &#125; <span class="comment">// p has 2 children</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Start fixup at replacement node, if it exists.</span></span><br><span class="line">    Entry&lt;K,V&gt; replacement = (p.left != <span class="literal">null</span> ? p.left : p.right);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (replacement != <span class="literal">null</span>) &#123; <span class="comment">// è¦åˆ é™¤çš„èŠ‚ç‚¹æœ‰ä¸€ä¸ªå­©å­èŠ‚ç‚¹</span></span><br><span class="line">        <span class="comment">// Link replacement to parent</span></span><br><span class="line">        replacement.parent = p.parent;</span><br><span class="line">        <span class="keyword">if</span> (p.parent == <span class="literal">null</span>)</span><br><span class="line">            root = replacement;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (p == p.parent.left)</span><br><span class="line">            p.parent.left  = replacement;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            p.parent.right = replacement;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Null out links so they are OK to use by fixAfterDeletion.</span></span><br><span class="line">        p.left = p.right = p.parent = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Fix replacement</span></span><br><span class="line">        <span class="keyword">if</span> (p.color == BLACK)</span><br><span class="line">            fixAfterDeletion(replacement);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (p.parent == <span class="literal">null</span>) &#123; <span class="comment">// return if we are the only node.</span></span><br><span class="line">        root = <span class="literal">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123; <span class="comment">//  No children. Use self as phantom replacement and unlink.</span></span><br><span class="line">        <span class="keyword">if</span> (p.color == BLACK)</span><br><span class="line">            fixAfterDeletion(p);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (p.parent != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (p == p.parent.left)</span><br><span class="line">                p.parent.left = <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (p == p.parent.right)</span><br><span class="line">                p.parent.right = <span class="literal">null</span>;</span><br><span class="line">            p.parent = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="TreeMap-ç¤ºä¾‹"><a href="#TreeMap-ç¤ºä¾‹" class="headerlink" title="TreeMap ç¤ºä¾‹"></a>TreeMap ç¤ºä¾‹</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TreeMapDemo</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String[] chars = <span class="string">&quot;A B C D E F G H I J K L M N O P Q R S T U V W X Y Z&quot;</span>.split(<span class="string">&quot; &quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        TreeMap&lt;Integer, String&gt; treeMap = <span class="keyword">new</span> <span class="title class_">TreeMap</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; chars.length; i++) &#123;</span><br><span class="line">            treeMap.put(i, chars[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(treeMap);</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">low</span> <span class="operator">=</span> treeMap.firstKey();</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">high</span> <span class="operator">=</span> treeMap.lastKey();</span><br><span class="line">        System.out.println(low);</span><br><span class="line">        System.out.println(high);</span><br><span class="line">        Iterator&lt;Integer&gt; it = treeMap.keySet().iterator();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt;= <span class="number">6</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (i == <span class="number">3</span>) &#123; low = it.next(); &#125;</span><br><span class="line">            <span class="keyword">if</span> (i == <span class="number">6</span>) &#123; high = it.next(); &#125; <span class="keyword">else</span> &#123; it.next(); &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(low);</span><br><span class="line">        System.out.println(high);</span><br><span class="line">        System.out.println(treeMap.subMap(low, high));</span><br><span class="line">        System.out.println(treeMap.headMap(high));</span><br><span class="line">        System.out.println(treeMap.tailMap(low));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="WeakHashMap"><a href="#WeakHashMap" class="headerlink" title="WeakHashMap"></a>WeakHashMap</h2><p>WeakHashMap çš„å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WeakHashMap</span>&lt;K,V&gt;</span><br><span class="line">    <span class="keyword">extends</span> <span class="title class_">AbstractMap</span>&lt;K,V&gt;</span><br><span class="line">    <span class="keyword">implements</span> <span class="title class_">Map</span>&lt;K,V&gt; &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>WeakHashMap ç»§æ‰¿äº† AbstractMapï¼Œå®ç°äº† Map æ¥å£ã€‚</p>
<p>å’Œ HashMap ä¸€æ ·ï¼ŒWeakHashMap ä¹Ÿæ˜¯ä¸€ä¸ªæ•£åˆ—è¡¨ï¼Œå®ƒå­˜å‚¨çš„å†…å®¹ä¹Ÿæ˜¯é”®å€¼å¯¹(key-value)æ˜ å°„ï¼Œè€Œä¸”é”®å’Œå€¼éƒ½å¯ä»¥æ˜¯ nullã€‚</p>
<p>ä¸è¿‡ WeakHashMap çš„é”®æ˜¯<strong>å¼±é”®</strong>ã€‚åœ¨ WeakHashMap ä¸­ï¼Œå½“æŸä¸ªé”®ä¸å†è¢«å…¶å®ƒå¯¹è±¡å¼•ç”¨ï¼Œä¼šè¢«ä» WeakHashMap ä¸­è¢«è‡ªåŠ¨ç§»é™¤ã€‚æ›´ç²¾ç¡®åœ°è¯´ï¼Œå¯¹äºä¸€ä¸ªç»™å®šçš„é”®ï¼Œå…¶æ˜ å°„çš„å­˜åœ¨å¹¶ä¸é˜»æ­¢åƒåœ¾å›æ”¶å™¨å¯¹è¯¥é”®çš„ä¸¢å¼ƒï¼Œè¿™å°±ä½¿è¯¥é”®æˆä¸ºå¯ç»ˆæ­¢çš„ï¼Œè¢«ç»ˆæ­¢ï¼Œç„¶åè¢«å›æ”¶ã€‚æŸä¸ªé”®è¢«ç»ˆæ­¢æ—¶ï¼Œå®ƒå¯¹åº”çš„é”®å€¼å¯¹ä¹Ÿå°±ä»æ˜ å°„ä¸­æœ‰æ•ˆåœ°ç§»é™¤äº†ã€‚</p>
<p>è¿™ä¸ª<strong>å¼±é”®</strong>çš„åŸç†å‘¢ï¼Ÿå¤§è‡´ä¸Šå°±æ˜¯ï¼Œé€šè¿‡ WeakReference å’Œ ReferenceQueue å®ç°çš„ã€‚</p>
<p>WeakHashMap çš„ key æ˜¯<strong>å¼±é”®</strong>ï¼Œå³æ˜¯ WeakReference ç±»å‹çš„ï¼›ReferenceQueue æ˜¯ä¸€ä¸ªé˜Ÿåˆ—ï¼Œå®ƒä¼šä¿å­˜è¢« GC å›æ”¶çš„<strong>å¼±é”®</strong>ã€‚å®ç°æ­¥éª¤æ˜¯ï¼š</p>
<ol>
<li>æ–°å»º WeakHashMapï¼Œå°†<strong>é”®å€¼å¯¹</strong>æ·»åŠ åˆ° WeakHashMap ä¸­ã€‚å®é™…ä¸Šï¼ŒWeakHashMap æ˜¯é€šè¿‡æ•°ç»„ table ä¿å­˜ Entry(é”®å€¼å¯¹)ï¼›æ¯ä¸€ä¸ª Entry å®é™…ä¸Šæ˜¯ä¸€ä¸ªå•å‘é“¾è¡¨ï¼Œå³ Entry æ˜¯é”®å€¼å¯¹é“¾è¡¨ã€‚</li>
<li>å½“æŸ<strong>å¼±é”®</strong>ä¸å†è¢«å…¶å®ƒå¯¹è±¡å¼•ç”¨ï¼Œå¹¶è¢« GC å›æ”¶æ—¶ã€‚åœ¨ GC å›æ”¶è¯¥<strong>å¼±é”®</strong>æ—¶ï¼Œè¿™ä¸ª<strong>å¼±é”®</strong>ä¹ŸåŒæ—¶ä¼šè¢«æ·»åŠ åˆ° ReferenceQueue(queue)é˜Ÿåˆ—ä¸­ã€‚</li>
<li>å½“ä¸‹ä¸€æ¬¡æˆ‘ä»¬éœ€è¦æ“ä½œ WeakHashMap æ—¶ï¼Œä¼šå…ˆåŒæ­¥ table å’Œ queueã€‚table ä¸­ä¿å­˜äº†å…¨éƒ¨çš„é”®å€¼å¯¹ï¼Œè€Œ queue ä¸­ä¿å­˜è¢« GC å›æ”¶çš„é”®å€¼å¯¹ï¼›åŒæ­¥å®ƒä»¬ï¼Œå°±æ˜¯åˆ é™¤ table ä¸­è¢« GC å›æ”¶çš„é”®å€¼å¯¹ã€‚</li>
</ol>
<p>è¿™å°±æ˜¯<strong>å¼±é”®</strong>å¦‚ä½•è¢«è‡ªåŠ¨ä» WeakHashMap ä¸­åˆ é™¤çš„æ­¥éª¤äº†ã€‚</p>
<p>å’Œ HashMap ä¸€æ ·ï¼ŒWeakHashMap æ˜¯ä¸åŒæ­¥çš„ã€‚å¯ä»¥ä½¿ç”¨ Collections.synchronizedMap æ–¹æ³•æ¥æ„é€ åŒæ­¥çš„ WeakHashMapã€‚</p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><h3 id="Map-ç®€ä»‹-1"><a href="#Map-ç®€ä»‹-1" class="headerlink" title="Map ç®€ä»‹"></a>Map ç®€ä»‹</h3><p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/20200221162002.png" alt="img"></p>
<h3 id="HashMap"><a href="#HashMap" class="headerlink" title="HashMap"></a>HashMap</h3><p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/20200221162111.png" alt="img"></p>
<h3 id="å…¶ä»–-Map"><a href="#å…¶ä»–-Map" class="headerlink" title="å…¶ä»– Map"></a>å…¶ä»– Map</h3><p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/20200221161913.png" alt="img"></p>
<h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ul>
<li><a target="_blank" rel="noopener" href="https://yikun.github.io/2015/04/01/Java-HashMap%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86%E5%8F%8A%E5%AE%9E%E7%8E%B0">Java-HashMap å·¥ä½œåŸç†åŠå®ç°</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/justloveyou_/article/details/71713781">Map ç»¼è¿°ï¼ˆäºŒï¼‰ï¼šå½»å¤´å½»å°¾ç†è§£ LinkedHashMap</a></li>
<li><a target="_blank" rel="noopener" href="http://www.cnblogs.com/skywang12345/p/3308931.html">Java é›†åˆç³»åˆ— 09 ä¹‹ Map æ¶æ„</a></li>
<li><a target="_blank" rel="noopener" href="http://www.cnblogs.com/skywang12345/p/3311092.html">Java é›†åˆç³»åˆ— 13 ä¹‹ WeakHashMap è¯¦ç»†ä»‹ç»(æºç è§£æ)å’Œä½¿ç”¨ç¤ºä¾‹</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://dunwu.github.io/blog/pages/af44fa8f/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/uploads/avatar.gif">
      <meta itemprop="name" content="é’æ‚Ÿ â—¾ Dunwu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dunwu Blog">
      <meta itemprop="description" content="é’æ‚Ÿçš„ä¸ªäººåšå®¢">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Dunwu Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/pages/af44fa8f/" class="post-title-link" itemprop="url">Java å®¹å™¨ä¹‹ Set</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2019-12-29 21:49:58" itemprop="dateCreated datePublished" datetime="2019-12-29T21:49:58+08:00">2019-12-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">æ›´æ–°äº</span>
      <time title="ä¿®æ”¹æ—¶é—´ï¼š2025-09-13 17:56:53" itemprop="dateModified" datetime="2025-09-13T17:56:53+08:00">2025-09-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
        </span>
          ï¼Œ
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/JavaCore/" itemprop="url" rel="index"><span itemprop="name">JavaCore</span></a>
        </span>
          ï¼Œ
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/JavaCore/%E5%AE%B9%E5%99%A8/" itemprop="url" rel="index"><span itemprop="name">å®¹å™¨</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
      <span>4.9k</span>
    </span>
    <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
      <span>4 åˆ†é’Ÿ</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Java-å®¹å™¨ä¹‹-Set"><a href="#Java-å®¹å™¨ä¹‹-Set" class="headerlink" title="Java å®¹å™¨ä¹‹ Set"></a>Java å®¹å™¨ä¹‹ Set</h1><h2 id="Set-ç®€ä»‹"><a href="#Set-ç®€ä»‹" class="headerlink" title="Set ç®€ä»‹"></a>Set ç®€ä»‹</h2><p><img src="https://raw.githubusercontent.com/dunwu/images/master/cs/java/javacore/container/Set-diagrams.png"></p>
<p>Set å®¶æ—æˆå‘˜ç®€ä»‹ï¼š</p>
<ul>
<li><code>Set</code> ç»§æ‰¿äº† <code>Collection</code> çš„æ¥å£ã€‚å®é™…ä¸Š <code>Set</code> å°±æ˜¯ <code>Collection</code>ï¼Œåªæ˜¯è¡Œä¸ºç•¥æœ‰ä¸åŒï¼š<code>Set</code> é›†åˆä¸å…è®¸æœ‰é‡å¤å…ƒç´ ã€‚</li>
<li><code>SortedSet</code> ç»§æ‰¿äº† <code>Set</code> çš„æ¥å£ã€‚<code>SortedSet</code> ä¸­çš„å†…å®¹æ˜¯æ’åºçš„å”¯ä¸€å€¼ï¼Œæ’åºçš„æ–¹æ³•æ˜¯é€šè¿‡æ¯”è¾ƒå™¨(Comparator)ã€‚</li>
<li><code>NavigableSet</code> ç»§æ‰¿äº† <code>SortedSet</code> çš„æ¥å£ã€‚å®ƒæä¾›äº†ä¸°å¯Œçš„æŸ¥æ‰¾æ–¹æ³•ï¼šå¦‚â€è·å–å¤§äº&#x2F;ç­‰äºæŸå€¼çš„å…ƒç´ â€ã€â€œè·å–å°äº&#x2F;ç­‰äºæŸå€¼çš„å…ƒç´ â€ç­‰ç­‰ã€‚</li>
<li><code>AbstractSet</code> æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œå®ƒç»§æ‰¿äº <code>AbstractCollection</code>ï¼Œ<code>AbstractCollection</code> å®ç°äº† Set ä¸­çš„ç»å¤§éƒ¨åˆ†æ–¹æ³•ï¼Œä¸ºå®ç° <code>Set</code> çš„å®ä¾‹ç±»æä¾›äº†ä¾¿åˆ©ã€‚</li>
<li><code>HashSet</code> ç±»ä¾èµ–äº <code>HashMap</code>ï¼Œå®ƒå®é™…ä¸Šæ˜¯é€šè¿‡ <code>HashMap</code> å®ç°çš„ã€‚<code>HashSet</code> ä¸­çš„å…ƒç´ æ˜¯æ— åºçš„ã€æ•£åˆ—çš„ã€‚</li>
<li><code>TreeSet</code> ç±»ä¾èµ–äº <code>TreeMap</code>ï¼Œå®ƒå®é™…ä¸Šæ˜¯é€šè¿‡ <code>TreeMap</code> å®ç°çš„ã€‚<code>TreeSet</code> ä¸­çš„å…ƒç´ æ˜¯æœ‰åºçš„ï¼Œå®ƒæ˜¯æŒ‰è‡ªç„¶æ’åºæˆ–è€…ç”¨æˆ·æŒ‡å®šæ¯”è¾ƒå™¨æ’åºçš„ Setã€‚</li>
<li><code>LinkedHashSet</code> æ˜¯æŒ‰æ’å…¥é¡ºåºæ’åºçš„ Setã€‚</li>
<li><code>EnumSet</code> æ˜¯åªèƒ½å­˜æ”¾ Emum æšä¸¾ç±»å‹çš„ Setã€‚</li>
</ul>
<h3 id="Set-æ¥å£"><a href="#Set-æ¥å£" class="headerlink" title="Set æ¥å£"></a>Set æ¥å£</h3><p><code>Set</code> ç»§æ‰¿äº† <code>Collection</code> çš„æ¥å£ã€‚å®é™…ä¸Šï¼Œ<code>Set</code> å°±æ˜¯ <code>Collection</code>ï¼ŒäºŒè€…æä¾›çš„æ–¹æ³•å®Œå…¨ç›¸åŒã€‚</p>
<p><code>Set</code> æ¥å£å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Set</span>&lt;E&gt; <span class="keyword">extends</span> <span class="title class_">Collection</span>&lt;E&gt; &#123;&#125;</span><br></pre></td></tr></table></figure>

<h3 id="SortedSet-æ¥å£"><a href="#SortedSet-æ¥å£" class="headerlink" title="SortedSet æ¥å£"></a>SortedSet æ¥å£</h3><p>ç»§æ‰¿äº† <code>Set</code> çš„æ¥å£ã€‚<code>SortedSet</code> ä¸­çš„å†…å®¹æ˜¯æ’åºçš„å”¯ä¸€å€¼ï¼Œæ’åºçš„æ–¹æ³•æ˜¯é€šè¿‡æ¯”è¾ƒå™¨(Comparator)ã€‚</p>
<p><code>SortedSet</code> æ¥å£å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">SortedSet</span>&lt;E&gt; <span class="keyword">extends</span> <span class="title class_">Set</span>&lt;E&gt; &#123;&#125;</span><br></pre></td></tr></table></figure>

<p><code>SortedSet</code> æ¥å£æ–°æ‰©å±•çš„æ–¹æ³•ï¼š</p>
<ul>
<li><code>comparator</code> - è¿”å› Comparator</li>
<li><code>subSet</code> - è¿”å›æŒ‡å®šåŒºé—´çš„å­é›†</li>
<li><code>headSet</code> - è¿”å›å°äºæŒ‡å®šå…ƒç´ çš„å­é›†</li>
<li><code>tailSet</code> - è¿”å›å¤§äºæŒ‡å®šå…ƒç´ çš„å­é›†</li>
<li><code>first</code> - è¿”å›ç¬¬ä¸€ä¸ªå…ƒç´ </li>
<li><code>last</code> - è¿”å›æœ€åä¸€ä¸ªå…ƒç´ </li>
<li>spliterator</li>
</ul>
<h3 id="NavigableSet-æ¥å£"><a href="#NavigableSet-æ¥å£" class="headerlink" title="NavigableSet æ¥å£"></a>NavigableSet æ¥å£</h3><p><code>NavigableSet</code> ç»§æ‰¿äº† <code>SortedSet</code>ã€‚å®ƒæä¾›äº†ä¸°å¯Œçš„æŸ¥æ‰¾æ–¹æ³•ã€‚</p>
<p><code>NavigableSet</code> æ¥å£å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">NavigableSet</span>&lt;E&gt; <span class="keyword">extends</span> <span class="title class_">SortedSet</span>&lt;E&gt; &#123;&#125;</span><br></pre></td></tr></table></figure>

<p><code>NavigableSet</code> æ¥å£æ–°æ‰©å±•çš„æ–¹æ³•ï¼š</p>
<ul>
<li>lower - è¿”å›å°äºæŒ‡å®šå€¼çš„å…ƒç´ ä¸­æœ€æ¥è¿‘çš„å…ƒç´ </li>
<li>higher - è¿”å›å¤§äºæŒ‡å®šå€¼çš„å…ƒç´ ä¸­æœ€æ¥è¿‘çš„å…ƒç´ </li>
<li>floor - è¿”å›å°äºæˆ–ç­‰äºæŒ‡å®šå€¼çš„å…ƒç´ ä¸­æœ€æ¥è¿‘çš„å…ƒç´ </li>
<li>ceiling - è¿”å›å¤§äºæˆ–ç­‰äºæŒ‡å®šå€¼çš„å…ƒç´ ä¸­æœ€æ¥è¿‘çš„å…ƒç´ </li>
<li>pollFirst - æ£€ç´¢å¹¶ç§»é™¤ç¬¬ä¸€ä¸ªï¼ˆæœ€å°çš„ï¼‰å…ƒç´ </li>
<li>pollLast - æ£€ç´¢å¹¶ç§»é™¤æœ€åä¸€ä¸ªï¼ˆæœ€å¤§çš„ï¼‰å…ƒç´ </li>
<li>descendingSet - è¿”å›ååºæ’åˆ—çš„ Set</li>
<li>descendingIterator - è¿”å›ååºæ’åˆ—çš„ Set çš„è¿­ä»£å™¨</li>
<li>subSet - è¿”å›æŒ‡å®šåŒºé—´çš„å­é›†</li>
<li>headSet - è¿”å›å°äºæŒ‡å®šå…ƒç´ çš„å­é›†</li>
<li>tailSet - è¿”å›å¤§äºæŒ‡å®šå…ƒç´ çš„å­é›†</li>
</ul>
<h3 id="AbstractSet-æŠ½è±¡ç±»"><a href="#AbstractSet-æŠ½è±¡ç±»" class="headerlink" title="AbstractSet æŠ½è±¡ç±»"></a>AbstractSet æŠ½è±¡ç±»</h3><p><code>AbstractSet</code> ç±»æä¾› <code>Set</code> æ¥å£çš„æ ¸å¿ƒå®ç°ï¼Œä»¥æœ€å¤§é™åº¦åœ°å‡å°‘å®ç° <code>Set</code> æ¥å£æ‰€éœ€çš„å·¥ä½œã€‚</p>
<p><code>AbstractSet</code> æŠ½è±¡ç±»å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">AbstractSet</span>&lt;E&gt; <span class="keyword">extends</span> <span class="title class_">AbstractCollection</span>&lt;E&gt; <span class="keyword">implements</span> <span class="title class_">Set</span>&lt;E&gt; &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>äº‹å®ä¸Šï¼Œä¸»è¦çš„å®ç°å·²ç»åœ¨ <code>AbstractCollection</code> ä¸­å®Œæˆã€‚</p>
<h2 id="HashSet-ç±»"><a href="#HashSet-ç±»" class="headerlink" title="HashSet ç±»"></a>HashSet ç±»</h2><p><code>HashSet</code> ç±»ä¾èµ–äº <code>HashMap</code>ï¼Œå®ƒå®é™…ä¸Šæ˜¯é€šè¿‡ <code>HashMap</code> å®ç°çš„ã€‚<code>HashSet</code> ä¸­çš„å…ƒç´ æ˜¯æ— åºçš„ã€æ•£åˆ—çš„ã€‚</p>
<p><code>HashSet</code> ç±»å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HashSet</span>&lt;E&gt;</span><br><span class="line">    <span class="keyword">extends</span> <span class="title class_">AbstractSet</span>&lt;E&gt;</span><br><span class="line">    <span class="keyword">implements</span> <span class="title class_">Set</span>&lt;E&gt;, Cloneable, java.io.Serializable &#123;&#125;</span><br></pre></td></tr></table></figure>

<h3 id="HashSet-è¦ç‚¹"><a href="#HashSet-è¦ç‚¹" class="headerlink" title="HashSet è¦ç‚¹"></a>HashSet è¦ç‚¹</h3><ul>
<li><code>HashSet</code> é€šè¿‡ç»§æ‰¿ <code>AbstractSet</code> å®ç°äº† <code>Set</code> æ¥å£ä¸­çš„éª¨å¹²æ–¹æ³•ã€‚</li>
<li><code>HashSet</code> å®ç°äº† <code>Cloneable</code>ï¼Œæ‰€ä»¥æ”¯æŒå…‹éš†ã€‚</li>
<li><code>HashSet</code> å®ç°äº† <code>Serializable</code>ï¼Œæ‰€ä»¥æ”¯æŒåºåˆ—åŒ–ã€‚</li>
<li><code>HashSet</code> ä¸­å­˜å‚¨çš„å…ƒç´ æ˜¯æ— åºçš„ã€‚</li>
<li><code>HashSet</code> å…è®¸ null å€¼çš„å…ƒç´ ã€‚</li>
<li><code>HashSet</code> ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚</li>
</ul>
<h3 id="HashSet-åŸç†"><a href="#HashSet-åŸç†" class="headerlink" title="HashSet åŸç†"></a>HashSet åŸç†</h3><p><strong><code>HashSet</code> æ˜¯åŸºäº <code>HashMap</code> å®ç°çš„ã€‚</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// HashSet çš„æ ¸å¿ƒï¼Œé€šè¿‡ç»´æŠ¤ä¸€ä¸ª HashMap å®ä½“æ¥å®ç° HashSet æ–¹æ³•</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> HashMap&lt;E,Object&gt; map;</span><br><span class="line"></span><br><span class="line"><span class="comment">// PRESENT æ˜¯ç”¨äºå…³è” map ä¸­å½“å‰æ“ä½œå…ƒç´ çš„ä¸€ä¸ªè™šæ‹Ÿå€¼</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">PRESENT</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>HashSet</code> ä¸­ç»´æŠ¤äº†ä¸€ä¸ª <code>HashMap</code> å¯¹è±¡ mapï¼Œ<code>HashSet</code> çš„é‡è¦æ–¹æ³•ï¼Œå¦‚ <code>add</code>ã€<code>remove</code>ã€<code>iterator</code>ã€<code>clear</code>ã€<code>size</code> ç­‰éƒ½æ˜¯å›´ç»• map å®ç°çš„ã€‚<ul>
<li><code>HashSet</code> ç±»ä¸­é€šè¿‡å®šä¹‰ <code>writeObject()</code> å’Œ <code>readObject()</code> æ–¹æ³•ç¡®å®šäº†å…¶åºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„æœºåˆ¶ã€‚</li>
</ul>
</li>
<li>PRESENT æ˜¯ç”¨äºå…³è” map ä¸­å½“å‰æ“ä½œå…ƒç´ çš„ä¸€ä¸ªè™šæ‹Ÿå€¼ã€‚</li>
</ul>
<h2 id="TreeSet-ç±»"><a href="#TreeSet-ç±»" class="headerlink" title="TreeSet ç±»"></a>TreeSet ç±»</h2><p><code>TreeSet</code> ç±»ä¾èµ–äº <code>TreeMap</code>ï¼Œå®ƒå®é™…ä¸Šæ˜¯é€šè¿‡ <code>TreeMap</code> å®ç°çš„ã€‚<code>TreeSet</code> ä¸­çš„å…ƒç´ æ˜¯æœ‰åºçš„ï¼Œå®ƒæ˜¯æŒ‰è‡ªç„¶æ’åºæˆ–è€…ç”¨æˆ·æŒ‡å®šæ¯”è¾ƒå™¨æ’åºçš„ Setã€‚</p>
<p><code>TreeSet</code> ç±»å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TreeSet</span>&lt;E&gt; <span class="keyword">extends</span> <span class="title class_">AbstractSet</span>&lt;E&gt;</span><br><span class="line">    <span class="keyword">implements</span> <span class="title class_">NavigableSet</span>&lt;E&gt;, Cloneable, java.io.Serializable &#123;&#125;</span><br></pre></td></tr></table></figure>

<h3 id="TreeSet-è¦ç‚¹"><a href="#TreeSet-è¦ç‚¹" class="headerlink" title="TreeSet è¦ç‚¹"></a>TreeSet è¦ç‚¹</h3><ul>
<li><code>TreeSet</code> é€šè¿‡ç»§æ‰¿ <code>AbstractSet</code> å®ç°äº† <code>NavigableSet</code> æ¥å£ä¸­çš„éª¨å¹²æ–¹æ³•ã€‚</li>
<li><code>TreeSet</code> å®ç°äº† <code>Cloneable</code>ï¼Œæ‰€ä»¥æ”¯æŒå…‹éš†ã€‚</li>
<li><code>TreeSet</code> å®ç°äº† <code>Serializable</code>ï¼Œæ‰€ä»¥æ”¯æŒåºåˆ—åŒ–ã€‚</li>
<li><code>TreeSet</code> ä¸­å­˜å‚¨çš„å…ƒç´ æ˜¯æœ‰åºçš„ã€‚æ’åºè§„åˆ™æ˜¯è‡ªç„¶é¡ºåºæˆ–æ¯”è¾ƒå™¨ï¼ˆ<code>Comparator</code>ï¼‰ä¸­æä¾›çš„é¡ºåºè§„åˆ™ã€‚</li>
<li><code>TreeSet</code> ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚</li>
</ul>
<h3 id="TreeSet-æºç "><a href="#TreeSet-æºç " class="headerlink" title="TreeSet æºç "></a>TreeSet æºç </h3><p><strong>TreeSet æ˜¯åŸºäº TreeMap å®ç°çš„ã€‚</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// TreeSet çš„æ ¸å¿ƒï¼Œé€šè¿‡ç»´æŠ¤ä¸€ä¸ª NavigableMap å®ä½“æ¥å®ç° TreeSet æ–¹æ³•</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> NavigableMap&lt;E,Object&gt; m;</span><br><span class="line"></span><br><span class="line"><span class="comment">// PRESENT æ˜¯ç”¨äºå…³è” map ä¸­å½“å‰æ“ä½œå…ƒç´ çš„ä¸€ä¸ªè™šæ‹Ÿå€¼</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">PRESENT</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br></pre></td></tr></table></figure>

<ul>
<li><code>TreeSet</code> ä¸­ç»´æŠ¤äº†ä¸€ä¸ª <code>NavigableMap</code> å¯¹è±¡ mapï¼ˆå®é™…ä¸Šæ˜¯ä¸€ä¸ª TreeMap å®ä¾‹ï¼‰ï¼Œ<code>TreeSet</code> çš„é‡è¦æ–¹æ³•ï¼Œå¦‚ <code>add</code>ã€<code>remove</code>ã€<code>iterator</code>ã€<code>clear</code>ã€<code>size</code> ç­‰éƒ½æ˜¯å›´ç»• map å®ç°çš„ã€‚</li>
<li><code>PRESENT</code> æ˜¯ç”¨äºå…³è” <code>map</code> ä¸­å½“å‰æ“ä½œå…ƒç´ çš„ä¸€ä¸ªè™šæ‹Ÿå€¼ã€‚<code>TreeSet</code> ä¸­çš„å…ƒç´ éƒ½è¢«å½“æˆ <code>TreeMap</code> çš„ key å­˜å‚¨ï¼Œè€Œ value éƒ½å¡«çš„æ˜¯ <code>PRESENT</code>ã€‚</li>
</ul>
<h2 id="LinkedHashSet-ç±»"><a href="#LinkedHashSet-ç±»" class="headerlink" title="LinkedHashSet ç±»"></a>LinkedHashSet ç±»</h2><p><code>LinkedHashSet</code> æ˜¯æŒ‰æ’å…¥é¡ºåºæ’åºçš„ Setã€‚</p>
<p><code>LinkedHashSet</code> ç±»å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LinkedHashSet</span>&lt;E&gt;</span><br><span class="line">    <span class="keyword">extends</span> <span class="title class_">HashSet</span>&lt;E&gt;</span><br><span class="line">    <span class="keyword">implements</span> <span class="title class_">Set</span>&lt;E&gt;, Cloneable, java.io.Serializable &#123;&#125;</span><br></pre></td></tr></table></figure>

<h3 id="LinkedHashSet-è¦ç‚¹"><a href="#LinkedHashSet-è¦ç‚¹" class="headerlink" title="LinkedHashSet è¦ç‚¹"></a>LinkedHashSet è¦ç‚¹</h3><ul>
<li><code>LinkedHashSet</code> é€šè¿‡ç»§æ‰¿ <code>HashSet</code> å®ç°äº† <code>Set</code> æ¥å£ä¸­çš„éª¨å¹²æ–¹æ³•ã€‚</li>
<li><code>LinkedHashSet</code> å®ç°äº† <code>Cloneable</code>ï¼Œæ‰€ä»¥æ”¯æŒå…‹éš†ã€‚</li>
<li><code>LinkedHashSet</code> å®ç°äº† <code>Serializable</code>ï¼Œæ‰€ä»¥æ”¯æŒåºåˆ—åŒ–ã€‚</li>
<li><code>LinkedHashSet</code> ä¸­å­˜å‚¨çš„å…ƒç´ æ˜¯æŒ‰ç…§æ’å…¥é¡ºåºä¿å­˜çš„ã€‚</li>
<li><code>LinkedHashSet</code> ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚</li>
</ul>
<h3 id="LinkedHashSet-åŸç†"><a href="#LinkedHashSet-åŸç†" class="headerlink" title="LinkedHashSet åŸç†"></a>LinkedHashSet åŸç†</h3><p><code>LinkedHashSet</code> æœ‰ä¸‰ä¸ªæ„é€ æ–¹æ³•ï¼Œæ— ä¸€ä¾‹å¤–ï¼Œéƒ½æ˜¯è°ƒç”¨çˆ¶ç±» <code>HashSet</code> çš„æ„é€ æ–¹æ³•ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">LinkedHashSet</span><span class="params">(<span class="type">int</span> initialCapacity, <span class="type">float</span> loadFactor)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(initialCapacity, loadFactor, <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="title function_">LinkedHashSet</span><span class="params">(<span class="type">int</span> initialCapacity)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(initialCapacity, <span class="number">.75f</span>, <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="title function_">LinkedHashSet</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(<span class="number">16</span>, <span class="number">.75f</span>, <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>éœ€è¦å¼ºè°ƒçš„æ˜¯ï¼š<strong>LinkedHashSet æ„é€ æ–¹æ³•å®é™…ä¸Šè°ƒç”¨çš„æ˜¯çˆ¶ç±» HashSet çš„é public æ„é€ æ–¹æ³•ã€‚</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">HashSet(<span class="type">int</span> initialCapacity, <span class="type">float</span> loadFactor, <span class="type">boolean</span> dummy) &#123;</span><br><span class="line">    map = <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>&lt;&gt;(initialCapacity, loadFactor);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸åŒäº <code>HashSet</code> <code>public</code> æ„é€ æ–¹æ³•ä¸­åˆå§‹åŒ–çš„ <code>HashMap</code> å®ä¾‹ï¼Œè¿™ä¸ªæ„é€ æ–¹æ³•ä¸­ï¼Œåˆå§‹åŒ–äº† <code>LinkedHashMap</code> å®ä¾‹ã€‚</p>
<p>ä¹Ÿå°±æ˜¯è¯´ï¼Œå®é™…ä¸Šï¼Œ<code>LinkedHashSet</code> ç»´æŠ¤äº†ä¸€ä¸ªåŒé“¾è¡¨ã€‚ç”±åŒé“¾è¡¨çš„ç‰¹æ€§å¯ä»¥çŸ¥é“ï¼Œå®ƒæ˜¯æŒ‰ç…§å…ƒç´ çš„æ’å…¥é¡ºåºä¿å­˜çš„ã€‚æ‰€ä»¥ï¼Œè¿™å°±æ˜¯ <code>LinkedHashSet</code> ä¸­å­˜å‚¨çš„å…ƒç´ æ˜¯æŒ‰ç…§æ’å…¥é¡ºåºä¿å­˜çš„åŸç†ã€‚</p>
<h2 id="EnumSet-ç±»"><a href="#EnumSet-ç±»" class="headerlink" title="EnumSet ç±»"></a>EnumSet ç±»</h2><p><code>EnumSet</code> ç±»å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">EnumSet</span>&lt;E <span class="keyword">extends</span> <span class="title class_">Enum</span>&lt;E&gt;&gt; <span class="keyword">extends</span> <span class="title class_">AbstractSet</span>&lt;E&gt;</span><br><span class="line">    <span class="keyword">implements</span> <span class="title class_">Cloneable</span>, java.io.Serializable &#123;&#125;</span><br></pre></td></tr></table></figure>

<h3 id="EnumSet-è¦ç‚¹"><a href="#EnumSet-è¦ç‚¹" class="headerlink" title="EnumSet è¦ç‚¹"></a>EnumSet è¦ç‚¹</h3><ul>
<li><code>EnumSet</code> ç»§æ‰¿äº† <code>AbstractSet</code>ï¼Œæ‰€ä»¥æœ‰ <code>Set</code> æ¥å£ä¸­çš„éª¨å¹²æ–¹æ³•ã€‚</li>
<li><code>EnumSet</code> å®ç°äº† <code>Cloneable</code>ï¼Œæ‰€ä»¥æ”¯æŒå…‹éš†ã€‚</li>
<li><code>EnumSet</code> å®ç°äº† <code>Serializable</code>ï¼Œæ‰€ä»¥æ”¯æŒåºåˆ—åŒ–ã€‚</li>
<li><code>EnumSet</code> é€šè¿‡ <code>&lt;E extends Enum&lt;E&gt;&gt;</code> é™å®šäº†å­˜å‚¨å…ƒç´ å¿…é¡»æ˜¯æšä¸¾å€¼ã€‚</li>
<li><code>EnumSet</code> æ²¡æœ‰æ„é€ æ–¹æ³•ï¼Œåªèƒ½é€šè¿‡ç±»ä¸­çš„ <code>static</code> æ–¹æ³•æ¥åˆ›å»º <code>EnumSet</code> å¯¹è±¡ã€‚</li>
<li><code>EnumSet</code> æ˜¯æœ‰åºçš„ã€‚ä»¥æšä¸¾å€¼åœ¨ <code>EnumSet</code> ç±»ä¸­çš„å®šä¹‰é¡ºåºæ¥å†³å®šé›†åˆå…ƒç´ çš„é¡ºåºã€‚</li>
<li><code>EnumSet</code> ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚</li>
</ul>
<h2 id="HashSet-vs-LinkedHashSet-vs-TreeSet"><a href="#HashSet-vs-LinkedHashSet-vs-TreeSet" class="headerlink" title="HashSet vs. LinkedHashSet vs. TreeSet"></a>HashSet vs. LinkedHashSet vs. TreeSet</h2><p><code>HashSet</code>ã€<code>LinkedHashSet</code> å’Œ <code>TreeSet</code> éƒ½æ˜¯ <code>Set</code> æ¥å£çš„å®ç°ç±»ï¼Œéƒ½èƒ½ä¿è¯å…ƒç´ å”¯ä¸€ï¼Œå¹¶ä¸”éƒ½ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚</p>
<p><code>HashSet</code>ã€<code>LinkedHashSet</code> å’Œ <code>TreeSet</code> çš„ä¸»è¦åŒºåˆ«åœ¨äºåº•å±‚æ•°æ®ç»“æ„ä¸åŒã€‚<code>HashSet</code> çš„åº•å±‚æ•°æ®ç»“æ„æ˜¯å“ˆå¸Œè¡¨ï¼ˆåŸºäº <code>HashMap</code> å®ç°ï¼‰ã€‚<code>LinkedHashSet</code> çš„åº•å±‚æ•°æ®ç»“æ„æ˜¯é“¾è¡¨å’Œå“ˆå¸Œè¡¨ï¼Œå…ƒç´ çš„æ’å…¥å’Œå–å‡ºé¡ºåºæ»¡è¶³ FIFOã€‚<code>TreeSet</code> åº•å±‚æ•°æ®ç»“æ„æ˜¯çº¢é»‘æ ‘ï¼Œå…ƒç´ æ˜¯æœ‰åºçš„ï¼Œæ’åºçš„æ–¹å¼æœ‰è‡ªç„¶æ’åºå’Œå®šåˆ¶æ’åºã€‚</p>
<p>åº•å±‚æ•°æ®ç»“æ„ä¸åŒåˆå¯¼è‡´è¿™ä¸‰è€…çš„åº”ç”¨åœºæ™¯ä¸åŒã€‚<code>HashSet</code> ç”¨äºä¸éœ€è¦ä¿è¯å…ƒç´ æ’å…¥å’Œå–å‡ºé¡ºåºçš„åœºæ™¯ï¼Œ<code>LinkedHashSet</code> ç”¨äºä¿è¯å…ƒç´ çš„æ’å…¥å’Œå–å‡ºé¡ºåºæ»¡è¶³ FIFO çš„åœºæ™¯ï¼Œ<code>TreeSet</code> ç”¨äºæ”¯æŒå¯¹å…ƒç´ è‡ªå®šä¹‰æ’åºè§„åˆ™çš„åœºæ™¯ã€‚</p>
<h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ul>
<li><a target="_blank" rel="noopener" href="https://item.jd.com/10058164.html">Java ç¼–ç¨‹æ€æƒ³ï¼ˆThinking in javaï¼‰</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://dunwu.github.io/blog/pages/0aab260c/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/uploads/avatar.gif">
      <meta itemprop="name" content="é’æ‚Ÿ â—¾ Dunwu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dunwu Blog">
      <meta itemprop="description" content="é’æ‚Ÿçš„ä¸ªäººåšå®¢">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Dunwu Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/pages/0aab260c/" class="post-title-link" itemprop="url">Java å®¹å™¨ç®€ä»‹</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2019-12-29 21:49:58" itemprop="dateCreated datePublished" datetime="2019-12-29T21:49:58+08:00">2019-12-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">æ›´æ–°äº</span>
      <time title="ä¿®æ”¹æ—¶é—´ï¼š2025-09-13 17:56:53" itemprop="dateModified" datetime="2025-09-13T17:56:53+08:00">2025-09-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
        </span>
          ï¼Œ
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/JavaCore/" itemprop="url" rel="index"><span itemprop="name">JavaCore</span></a>
        </span>
          ï¼Œ
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/JavaCore/%E5%AE%B9%E5%99%A8/" itemprop="url" rel="index"><span itemprop="name">å®¹å™¨</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
      <span>9.1k</span>
    </span>
    <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
      <span>8 åˆ†é’Ÿ</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Java-å®¹å™¨ç®€ä»‹"><a href="#Java-å®¹å™¨ç®€ä»‹" class="headerlink" title="Java å®¹å™¨ç®€ä»‹"></a>Java å®¹å™¨ç®€ä»‹</h1><h2 id="å®¹å™¨ç®€ä»‹"><a href="#å®¹å™¨ç®€ä»‹" class="headerlink" title="å®¹å™¨ç®€ä»‹"></a>å®¹å™¨ç®€ä»‹</h2><h3 id="æ•°ç»„ä¸å®¹å™¨"><a href="#æ•°ç»„ä¸å®¹å™¨" class="headerlink" title="æ•°ç»„ä¸å®¹å™¨"></a>æ•°ç»„ä¸å®¹å™¨</h3><p>Java ä¸­å¸¸ç”¨çš„å­˜å‚¨å®¹å™¨å°±æ˜¯æ•°ç»„å’Œå®¹å™¨ï¼ŒäºŒè€…æœ‰ä»¥ä¸‹åŒºåˆ«ï¼š</p>
<ul>
<li>å­˜å‚¨å¤§å°æ˜¯å¦å›ºå®š<ul>
<li>æ•°ç»„çš„<strong>é•¿åº¦å›ºå®š</strong>ï¼›</li>
<li>å®¹å™¨çš„<strong>é•¿åº¦å¯å˜</strong>ã€‚</li>
</ul>
</li>
<li>æ•°æ®ç±»å‹<ul>
<li><strong>æ•°ç»„å¯ä»¥å­˜å‚¨åŸºæœ¬æ•°æ®ç±»å‹ï¼Œä¹Ÿå¯ä»¥å­˜å‚¨å¼•ç”¨æ•°æ®ç±»å‹</strong>ï¼›</li>
<li><strong>å®¹å™¨åªèƒ½å­˜å‚¨å¼•ç”¨æ•°æ®ç±»å‹</strong>ï¼ŒåŸºæœ¬æ•°æ®ç±»å‹çš„å˜é‡è¦è½¬æ¢æˆå¯¹åº”çš„åŒ…è£…ç±»æ‰èƒ½æ”¾å…¥å®¹å™¨ç±»ä¸­ã€‚</li>
</ul>
</li>
</ul>
<blockquote>
<p>:bulb: ä¸äº†è§£ä»€ä¹ˆæ˜¯åŸºæœ¬æ•°æ®ç±»å‹ã€å¼•ç”¨æ•°æ®ç±»å‹ã€åŒ…è£…ç±»è¿™äº›æ¦‚å¿µï¼Œå¯ä»¥å‚è€ƒï¼š<a href="https://dunwu.github.io/waterdrop/pages/17bf2e10/">Java åŸºæœ¬æ•°æ®ç±»å‹</a></p>
</blockquote>
<h3 id="å®¹å™¨æ¡†æ¶"><a href="#å®¹å™¨æ¡†æ¶" class="headerlink" title="å®¹å™¨æ¡†æ¶"></a>å®¹å™¨æ¡†æ¶</h3><p><img src="https://raw.githubusercontent.com/dunwu/images/master/cs/java/javacore/container/java-container-structure.png" alt="img"></p>
<p>Java å®¹å™¨æ¡†æ¶ä¸»è¦åˆ†ä¸º <code>Collection</code> å’Œ <code>Map</code> ä¸¤ç§ã€‚å…¶ä¸­ï¼Œ<code>Collection</code> åˆåˆ†ä¸º <code>List</code>ã€<code>Set</code> ä»¥åŠ <code>Queue</code>ã€‚</p>
<ul>
<li><code>Collection</code> - ä¸€ä¸ªç‹¬ç«‹å…ƒç´ çš„åºåˆ—ï¼Œè¿™äº›å…ƒç´ éƒ½æœä»ä¸€æ¡æˆ–è€…å¤šæ¡è§„åˆ™ã€‚<ul>
<li><code>List</code> - å¿…é¡»æŒ‰ç…§æ’å…¥çš„é¡ºåºä¿å­˜å…ƒç´ ã€‚å¸¸è§ <code>List</code> å®¹å™¨æœ‰ï¼š<ul>
<li><code>ArrayList</code> - <code>Object[]</code> æ•°ç»„ã€‚</li>
<li><code>LinkedList</code> - åŒé“¾è¡¨ (JDK1.6 ä¹‹å‰ä¸ºå¾ªç¯é“¾è¡¨ï¼ŒJDK1.7 å–æ¶ˆäº†å¾ªç¯ï¼‰ã€‚</li>
<li><code>Vector</code> - é€šè¿‡ <code>synchronized</code> ä¿®é¥°è¯»å†™æ–¹æ³•æ¥ä¿è¯å¹¶å‘å®‰å…¨ã€‚</li>
<li><code>Vector</code> - <code>Object[]</code> æ•°ç»„ï¼Œé€šè¿‡ <code>synchronized</code> ä¿®é¥°è¯»å†™æ–¹æ³•æ¥ä¿è¯å¹¶å‘å®‰å…¨ã€‚</li>
</ul>
</li>
<li><code>Set</code> - ä¸èƒ½æœ‰é‡å¤çš„å…ƒç´ ã€‚å¸¸è§ <code>Set</code> å®¹å™¨æœ‰ï¼š<ul>
<li><code>HashSet</code> - æ— åºï¼Œå†…éƒ¨åŸºäº <code>HashMap</code> æ¥å®ç°çš„ã€‚</li>
<li><code>LinkedHashSet</code> - ä¿è¯æ’å…¥é¡ºåºï¼Œå†…éƒ¨åŸºäº <code>LinkedHashMap</code> æ¥å®ç°çš„ã€‚</li>
<li><code>TreeSet</code> - ä¿è¯è‡ªç„¶åºæˆ–ç”¨æˆ·æŒ‡å®šçš„æ¯”è¾ƒå™¨é¡ºåºï¼Œå†…éƒ¨åŸºäºçº¢é»‘æ ‘å®ç°ã€‚</li>
</ul>
</li>
<li><code>Queue</code> - æŒ‰ç…§æ’é˜Ÿè§„åˆ™æ¥ç¡®å®šå¯¹è±¡äº§ç”Ÿçš„é¡ºåºã€‚<ul>
<li><code>PriorityQueue</code> - åŸºäº <code>Object[]</code> æ•°ç»„æ¥å®ç°å°é¡¶å †</li>
<li><code>DelayQueue</code> - å»¶è¿Ÿé˜Ÿåˆ—ã€‚</li>
<li><code>ArrayQueue</code> - <code>ArrayDeque</code> æ˜¯ <code>Deque</code> çš„é¡ºåºè¡¨å®ç°ã€‚åŸºäºåŠ¨æ€æ•°ç»„å®ç°äº†æ ˆå’Œé˜Ÿåˆ—æ‰€éœ€çš„æ‰€æœ‰æ“ä½œã€‚</li>
<li><code>LinkedList</code> - <code>LinkedList</code> æ˜¯ <code>Deque</code> çš„é“¾è¡¨å®ç°ã€‚</li>
</ul>
</li>
</ul>
</li>
<li><code>Map</code> - ä¸€ç»„æˆå¯¹çš„â€œé”®å€¼å¯¹â€å¯¹è±¡ï¼Œå…è®¸ä½ ä½¿ç”¨é”®æ¥æŸ¥æ‰¾å€¼ã€‚å¸¸è§çš„ Map å®¹å™¨æœ‰ï¼š<ul>
<li><code>HashMap</code>ï¼šJDK1.8 ä¹‹å‰ <code>HashMap</code> ç”±æ•°ç»„+é“¾è¡¨ç»„æˆçš„ï¼Œæ•°ç»„æ˜¯ <code>HashMap</code> çš„ä¸»ä½“ï¼Œé“¾è¡¨åˆ™æ˜¯ä¸»è¦ä¸ºäº†è§£å†³å“ˆå¸Œå†²çªè€Œå­˜åœ¨çš„ï¼ˆâ€œæ‹‰é“¾æ³•â€è§£å†³å†²çªï¼‰ã€‚JDK1.8 ä»¥ååœ¨è§£å†³å“ˆå¸Œå†²çªæ—¶æœ‰äº†è¾ƒå¤§çš„å˜åŒ–ï¼Œå½“é“¾è¡¨é•¿åº¦å¤§äºé˜ˆå€¼ï¼ˆé»˜è®¤ä¸º 8ï¼‰ï¼ˆå°†é“¾è¡¨è½¬æ¢æˆçº¢é»‘æ ‘å‰ä¼šåˆ¤æ–­ï¼Œå¦‚æœå½“å‰æ•°ç»„çš„é•¿åº¦å°äº 64ï¼Œé‚£ä¹ˆä¼šé€‰æ‹©å…ˆè¿›è¡Œæ•°ç»„æ‰©å®¹ï¼Œè€Œä¸æ˜¯è½¬æ¢ä¸ºçº¢é»‘æ ‘ï¼‰æ—¶ï¼Œå°†é“¾è¡¨è½¬åŒ–ä¸ºçº¢é»‘æ ‘ï¼Œä»¥å‡å°‘æœç´¢æ—¶é—´ã€‚</li>
<li><code>LinkedHashMap</code>ï¼š<code>LinkedHashMap</code> ç»§æ‰¿è‡ª <code>HashMap</code>ï¼Œæ‰€ä»¥å®ƒçš„åº•å±‚ä»ç„¶æ˜¯åŸºäºæ‹‰é“¾å¼æ•£åˆ—ç»“æ„å³ç”±æ•°ç»„å’Œé“¾è¡¨æˆ–çº¢é»‘æ ‘ç»„æˆã€‚å¦å¤–ï¼Œ<code>LinkedHashMap</code> åœ¨ä¸Šé¢ç»“æ„çš„åŸºç¡€ä¸Šï¼Œå¢åŠ äº†ä¸€æ¡åŒå‘é“¾è¡¨ï¼Œä½¿å¾—ä¸Šé¢çš„ç»“æ„å¯ä»¥ä¿æŒé”®å€¼å¯¹çš„æ’å…¥é¡ºåºã€‚åŒæ—¶é€šè¿‡å¯¹é“¾è¡¨è¿›è¡Œç›¸åº”çš„æ“ä½œï¼Œå®ç°äº†è®¿é—®é¡ºåºç›¸å…³é€»è¾‘ã€‚</li>
<li><code>Hashtable</code>ï¼šæ•°ç»„+é“¾è¡¨ç»„æˆçš„ï¼Œæ•°ç»„æ˜¯ <code>Hashtable</code> çš„ä¸»ä½“ï¼Œé“¾è¡¨åˆ™æ˜¯ä¸»è¦ä¸ºäº†è§£å†³å“ˆå¸Œå†²çªè€Œå­˜åœ¨çš„ã€‚</li>
<li><code>TreeMap</code>ï¼šçº¢é»‘æ ‘ï¼ˆè‡ªå¹³è¡¡çš„æ’åºäºŒå‰æ ‘ï¼‰ã€‚</li>
</ul>
</li>
</ul>
<h2 id="å®¹å™¨çš„åŸºæœ¬æœºåˆ¶"><a href="#å®¹å™¨çš„åŸºæœ¬æœºåˆ¶" class="headerlink" title="å®¹å™¨çš„åŸºæœ¬æœºåˆ¶"></a>å®¹å™¨çš„åŸºæœ¬æœºåˆ¶</h2><blockquote>
<p>Java çš„å®¹å™¨å…·æœ‰ä¸€å®šçš„å…±æ€§ï¼Œå®ƒä»¬æˆ–å…¨éƒ¨æˆ–éƒ¨åˆ†ä¾èµ–ä»¥ä¸‹æŠ€æœ¯ã€‚æ‰€ä»¥ï¼Œå­¦ä¹ ä»¥ä¸‹æŠ€æœ¯ç‚¹ï¼Œå¯¹äºç†è§£ Java å®¹å™¨çš„ç‰¹æ€§å’ŒåŸç†æœ‰å¾ˆå¤§çš„å¸®åŠ©ã€‚</p>
</blockquote>
<h3 id="æ³›å‹"><a href="#æ³›å‹" class="headerlink" title="æ³›å‹"></a>æ³›å‹</h3><p>Java 1.5 å¼•å…¥äº†æ³›å‹æŠ€æœ¯ã€‚</p>
<p>Java <strong>å®¹å™¨é€šè¿‡æ³›å‹æŠ€æœ¯æ¥ä¿è¯å…¶æ•°æ®çš„ç±»å‹å®‰å…¨</strong>ã€‚ä»€ä¹ˆæ˜¯ç±»å‹å®‰å…¨å‘¢ï¼Ÿ</p>
<p>ä¸¾ä¾‹æ¥è¯´ï¼šå¦‚æœæœ‰ä¸€ä¸ª <code>List&lt;Object&gt;</code> å®¹å™¨ï¼ŒJava <strong>ç¼–è¯‘å™¨åœ¨ç¼–è¯‘æ—¶ä¸ä¼šå¯¹åŸå§‹ç±»å‹è¿›è¡Œç±»å‹å®‰å…¨æ£€æŸ¥</strong>ï¼Œå´ä¼šå¯¹å¸¦å‚æ•°çš„ç±»å‹è¿›è¡Œæ£€æŸ¥ï¼Œé€šè¿‡ä½¿ç”¨ Object ä½œä¸ºç±»å‹ï¼Œå¯ä»¥å‘ŠçŸ¥ç¼–è¯‘å™¨è¯¥æ–¹æ³•å¯ä»¥æ¥å—ä»»ä½•ç±»å‹çš„å¯¹è±¡ï¼Œæ¯”å¦‚ String æˆ– Integerã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Object&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;Object&gt;();</span><br><span class="line">list.add(<span class="string">&quot;123&quot;</span>);</span><br><span class="line">list.add(<span class="number">123</span>);</span><br></pre></td></tr></table></figure>

<p>å¦‚æœæ²¡æœ‰æ³›å‹æŠ€æœ¯ï¼Œå¦‚ç¤ºä¾‹ä¸­çš„ä»£ç é‚£æ ·ï¼Œå®¹å™¨ä¸­å°±å¯èƒ½å­˜å‚¨ä»»æ„æ•°æ®ç±»å‹ï¼Œè¿™æ˜¯å¾ˆå±é™©çš„è¡Œä¸ºã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">List&lt;String&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;String&gt;();</span><br><span class="line">list.add(<span class="string">&quot;123&quot;</span>);</span><br><span class="line">list.add(<span class="number">123</span>);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>:bulb: æƒ³æ·±å…¥äº†è§£ Java æ³›å‹æŠ€æœ¯çš„ç”¨æ³•å’ŒåŸç†å¯ä»¥å‚è€ƒï¼š<a href="https://dunwu.github.io/waterdrop/pages/ff687d6e/">æ·±å…¥ç†è§£ Java æ³›å‹</a></p>
</blockquote>
<h3 id="Iterable-å’Œ-Iterator"><a href="#Iterable-å’Œ-Iterator" class="headerlink" title="Iterable å’Œ Iterator"></a>Iterable å’Œ Iterator</h3><blockquote>
<p>Iterable å’Œ Iterator ç›®çš„åœ¨äºéå†è®¿é—®å®¹å™¨ä¸­çš„å…ƒç´ ã€‚</p>
</blockquote>
<p><code>Iterator</code> æ¥å£å®šä¹‰ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Iterator</span>&lt;E&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">hasNext</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    E <span class="title function_">next</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">default</span> <span class="keyword">void</span> <span class="title function_">remove</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnsupportedOperationException</span>(<span class="string">&quot;remove&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">default</span> <span class="keyword">void</span> <span class="title function_">forEachRemaining</span><span class="params">(Consumer&lt;? <span class="built_in">super</span> E&gt; action)</span> &#123;</span><br><span class="line">        Objects.requireNonNull(action);</span><br><span class="line">        <span class="keyword">while</span> (hasNext())</span><br><span class="line">            action.accept(next());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>Iterable</code> æ¥å£å®šä¹‰ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Iterable</span>&lt;T&gt; &#123;</span><br><span class="line"></span><br><span class="line">    Iterator&lt;T&gt; <span class="title function_">iterator</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">default</span> <span class="keyword">void</span> <span class="title function_">forEach</span><span class="params">(Consumer&lt;? <span class="built_in">super</span> T&gt; action)</span> &#123;</span><br><span class="line">        Objects.requireNonNull(action);</span><br><span class="line">        <span class="keyword">for</span> (T t : <span class="built_in">this</span>) &#123;</span><br><span class="line">            action.accept(t);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">default</span> Spliterator&lt;T&gt; <span class="title function_">spliterator</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Spliterators.spliteratorUnknownSize(iterator(), <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>Collection</code> æ¥å£æ‰©å±•äº† <code>Iterable</code> æ¥å£ã€‚</p>
<p>è¿­ä»£å…¶å®æˆ‘ä»¬å¯ä»¥ç®€å•åœ°ç†è§£ä¸ºéå†ï¼Œæ˜¯ä¸€ä¸ªæ ‡å‡†åŒ–éå†å„ç±»å®¹å™¨é‡Œé¢çš„æ‰€æœ‰å¯¹è±¡çš„æ¥å£ã€‚å®ƒæ˜¯ä¸€ä¸ªç»å…¸çš„è®¾è®¡æ¨¡å¼â€”â€”è¿­ä»£å™¨æ¨¡å¼ï¼ˆIteratorï¼‰ã€‚</p>
<p><strong>è¿­ä»£å™¨æ¨¡å¼</strong> - <strong>æä¾›ä¸€ç§æ–¹æ³•é¡ºåºè®¿é—®ä¸€ä¸ªèšåˆå¯¹è±¡ä¸­å„ä¸ªå…ƒç´ ï¼Œè€Œåˆæ— é¡»æš´éœ²è¯¥å¯¹è±¡çš„å†…éƒ¨è¡¨ç¤º</strong>ã€‚</p>
<div align="center">
<img src="https://raw.githubusercontent.com/dunwu/images/master/cs/java/oop/design-patterns/iterator-pattern.png" width="500"/>
</div>

<p>ç¤ºä¾‹ï¼šè¿­ä»£å™¨éå†</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">IteratorDemo</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        List&lt;Integer&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        list.add(<span class="number">1</span>);</span><br><span class="line">        list.add(<span class="number">2</span>);</span><br><span class="line">        list.add(<span class="number">3</span>);</span><br><span class="line">        <span class="type">Iterator</span> <span class="variable">it</span> <span class="operator">=</span> list.iterator();</span><br><span class="line">        <span class="keyword">while</span> (it.hasNext()) &#123;</span><br><span class="line">            System.out.println(it.next());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ã€Šé˜¿é‡Œå·´å·´ Java å¼€å‘æ‰‹å†Œã€‹çš„æè¿°å¦‚ä¸‹ï¼š</p>
<blockquote>
<p><strong>ä¸è¦åœ¨ foreach å¾ªç¯é‡Œè¿›è¡Œå…ƒç´ çš„ <code>remove/add</code> æ“ä½œã€‚remove å…ƒç´ è¯·ä½¿ç”¨ <code>Iterator</code> æ–¹å¼ï¼Œå¦‚æœå¹¶å‘æ“ä½œï¼Œéœ€è¦å¯¹ <code>Iterator</code> å¯¹è±¡åŠ é”ã€‚</strong></p>
</blockquote>
<p>é€šè¿‡åç¼–è¯‘ä½ ä¼šå‘ç° foreach è¯­æ³•åº•å±‚å…¶å®è¿˜æ˜¯ä¾èµ– <code>Iterator</code> ã€‚ä¸è¿‡ï¼Œ <code>remove/add</code> æ“ä½œç›´æ¥è°ƒç”¨çš„æ˜¯é›†åˆè‡ªå·±çš„æ–¹æ³•ï¼Œè€Œä¸æ˜¯ <code>Iterator</code> çš„ <code>remove/add</code>æ–¹æ³•</p>
<p>è¿™å°±å¯¼è‡´ <code>Iterator</code> è«åå…¶å¦™åœ°å‘ç°è‡ªå·±æœ‰å…ƒç´ è¢« <code>remove/add</code> ï¼Œç„¶åï¼Œå®ƒå°±ä¼šæŠ›å‡ºä¸€ä¸ª <code>ConcurrentModificationException</code> æ¥æç¤ºç”¨æˆ·å‘ç”Ÿäº†å¹¶å‘ä¿®æ”¹å¼‚å¸¸ã€‚è¿™å°±æ˜¯å•çº¿ç¨‹çŠ¶æ€ä¸‹äº§ç”Ÿçš„ <strong>fail-fast æœºåˆ¶</strong>ã€‚</p>
<blockquote>
<p><strong>fail-fast æœºåˆ¶</strong>ï¼šå¤šä¸ªçº¿ç¨‹å¯¹ fail-fast é›†åˆè¿›è¡Œä¿®æ”¹çš„æ—¶å€™ï¼Œå¯èƒ½ä¼šæŠ›å‡º<code>ConcurrentModificationException</code>ã€‚ å³ä½¿æ˜¯å•çº¿ç¨‹ä¸‹ä¹Ÿæœ‰å¯èƒ½ä¼šå‡ºç°è¿™ç§æƒ…å†µï¼Œä¸Šé¢å·²ç»æåˆ°è¿‡ã€‚</p>
<p>ç›¸å…³é˜…è¯»ï¼š<a target="_blank" rel="noopener" href="https://www.cnblogs.com/54chensongxia/p/12470446.html">ä»€ä¹ˆæ˜¯ fail-fastopen in new window</a> ã€‚</p>
</blockquote>
<p>Java8 å¼€å§‹ï¼Œå¯ä»¥ä½¿ç”¨ <code>Collection#removeIf()</code>æ–¹æ³•åˆ é™¤æ»¡è¶³ç‰¹å®šæ¡ä»¶çš„å…ƒç´ ï¼Œå¦‚ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Integer&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;= <span class="number">10</span>; ++i) &#123;</span><br><span class="line">    list.add(i);</span><br><span class="line">&#125;</span><br><span class="line">list.removeIf(filter -&gt; filter % <span class="number">2</span> == <span class="number">0</span>); <span class="comment">/* åˆ é™¤listä¸­çš„æ‰€æœ‰å¶æ•° */</span></span><br><span class="line">System.out.println(list); <span class="comment">/* [1, 3, 5, 7, 9] */</span></span><br></pre></td></tr></table></figure>

<p>é™¤äº†ä¸Šé¢ä»‹ç»çš„ç›´æ¥ä½¿ç”¨ <code>Iterator</code> è¿›è¡Œéå†æ“ä½œä¹‹å¤–ï¼Œä½ è¿˜å¯ä»¥ï¼š</p>
<ul>
<li>ä½¿ç”¨æ™®é€šçš„ for å¾ªç¯</li>
<li>ä½¿ç”¨ fail-safe çš„é›†åˆç±»ã€‚<code>java.util</code>åŒ…ä¸‹é¢çš„æ‰€æœ‰çš„é›†åˆç±»éƒ½æ˜¯ fail-fast çš„ï¼Œè€Œ<code>java.util.concurrent</code>åŒ…ä¸‹é¢çš„æ‰€æœ‰çš„ç±»éƒ½æ˜¯ fail-safe çš„ã€‚</li>
<li>â€¦ â€¦</li>
</ul>
<h3 id="Comparable-å’Œ-Comparator"><a href="#Comparable-å’Œ-Comparator" class="headerlink" title="Comparable å’Œ Comparator"></a>Comparable å’Œ Comparator</h3><p><code>Comparable</code> æ¥å£å’Œ <code>Comparator</code> æ¥å£ä¸€èˆ¬ç”¨äºå®ç°å®¹å™¨ä¸­å…ƒç´ çš„æ¯”è¾ƒåŠæ’åºï¼š</p>
<ul>
<li><code>Comparable</code> æ¥å£å®é™…ä¸Šæ˜¯å‡ºè‡ª <code>java.lang</code> åŒ… å®ƒæœ‰ä¸€ä¸ª <code>compareTo(Object obj) </code>æ–¹æ³•ç”¨æ¥æ’åº</li>
<li><code>Comparator  </code> æ¥å£å®é™…ä¸Šæ˜¯å‡ºè‡ª <code>java.util</code> åŒ…å®ƒæœ‰ä¸€ä¸ª <code>compare(Object obj1, Object obj2)</code> æ–¹æ³•ç”¨æ¥æ’åº</li>
</ul>
<p>::: tabs#Comparableå’ŒComparatoræ¥å£å®šä¹‰</p>
<p>@tab <code>Comparable</code> æ¥å£å®šä¹‰</p>
<p><code>Comparable</code> æ¥å£å®šä¹‰</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Comparable</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">compareTo</span><span class="params">(T o)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>@tab <code>Comparator</code> æ¥å£å®šä¹‰</p>
<p><code>Comparator</code> æ¥å£å®šä¹‰</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FunctionalInterface</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Comparator</span>&lt;T&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="title function_">compare</span><span class="params">(T o1, T o2)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">equals</span><span class="params">(Object obj)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åè½¬</span></span><br><span class="line">    <span class="keyword">default</span> Comparator&lt;T&gt; <span class="title function_">reversed</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Collections.reverseOrder(<span class="built_in">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">default</span> Comparator&lt;T&gt; <span class="title function_">thenComparing</span><span class="params">(Comparator&lt;? <span class="built_in">super</span> T&gt; other)</span> &#123;</span><br><span class="line">        Objects.requireNonNull(other);</span><br><span class="line">        <span class="keyword">return</span> (Comparator&lt;T&gt; &amp; Serializable) (c1, c2) -&gt; &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">res</span> <span class="operator">=</span> compare(c1, c2);</span><br><span class="line">            <span class="keyword">return</span> (res != <span class="number">0</span>) ? res : other.compare(c1, c2);</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// thenComparingXXX æ–¹æ³•ç•¥</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// é™æ€æ–¹æ³•ç•¥</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>:::</p>
<p>å‡è®¾ï¼Œæœ‰ä¸€ä¸ª <code>List</code> å®¹å™¨ï¼Œå­˜å‚¨çš„æ˜¯ <code>User</code> ç±»å‹å¯¹è±¡ã€‚ç°åœ¨è¦æ ¹æ® <code>User</code> ä¸­çš„ <code>age</code> å±æ€§è¿›è¡Œæ’åºã€‚</p>
<p>User å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">User</span><span class="params">(String name, <span class="type">int</span> age)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// getterã€setter ç•¥</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬åˆ†åˆ«é€šè¿‡ <code>Comparable</code> å’Œ <code>Comparator</code> æ¥å®ç°æ¯”è¾ƒã€æ’åºï¼Œä½“ä¼šä¸€ä¸‹æœ‰ä½•å·®å¼‚ã€‚</p>
<p>::: tabs#Comparableå’ŒComparatorä½¿ç”¨ç¤ºä¾‹</p>
<p>@tab <code>Comparable</code> æ¥å£ä½¿ç”¨ç¤ºä¾‹</p>
<p><code>Comparable</code> æ¥å£ä½¿ç”¨ç¤ºä¾‹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ComparableDemo</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">User</span> <span class="variable">a</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">&quot;A&quot;</span>, <span class="number">18</span>);</span><br><span class="line">        <span class="type">User</span> <span class="variable">b</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">&quot;B&quot;</span>, <span class="number">17</span>);</span><br><span class="line">        <span class="type">User</span> <span class="variable">c</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">&quot;C&quot;</span>, <span class="number">20</span>);</span><br><span class="line">        List&lt;User&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(Arrays.asList(a, b, c));</span><br><span class="line">        Collections.sort(list);</span><br><span class="line">        list.forEach(System.out::println);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è¾“å‡ºï¼š</span></span><br><span class="line">    <span class="comment">// User&#123;age=17, name=&#x27;B&#x27;&#125;</span></span><br><span class="line">    <span class="comment">// User&#123;age=18, name=&#x27;A&#x27;&#125;</span></span><br><span class="line">    <span class="comment">// User&#123;age=20, name=&#x27;C&#x27;&#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// éœ€è¦å¯¹è¢«æ¯”è¾ƒã€æ’åºçš„ç±»è¿›è¡Œæ”¹é€ ï¼Œå®ç° Comparable æ¥å£</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">User</span> <span class="keyword">implements</span> <span class="title class_">Comparable</span>&lt;User&gt; &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> String name;</span><br><span class="line">        <span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">User</span><span class="params">(String name, <span class="type">int</span> age)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.age = age;</span><br><span class="line">            <span class="built_in">this</span>.name = name;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// getterã€setter ç•¥</span></span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">compareTo</span><span class="params">(User o)</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.age - o.age;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;User&#123;&quot;</span> + <span class="string">&quot;age=&quot;</span> + age + <span class="string">&quot;, name=&#x27;&quot;</span> + name + <span class="string">&#x27;\&#x27;&#x27;</span> + <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä»ä¸Šä¾‹å¯ä»¥çœ‹å‡ºï¼Œä½¿ç”¨ <code>Comparable</code> æ¥å£ï¼Œè¢«æ’åºå¯¹è±¡ç±»å¿…é¡»å®ç° <code>Comparable</code> æ¥å£ï¼›å¹¶åœ¨ç±»ä¸­å®šä¹‰ <code>compareTo</code> æ–¹æ³•çš„å®ç°ï¼Œå³æ’åºé€»è¾‘å¿…é¡»ç½®äºè¢«æ’åºå¯¹è±¡ç±»ä¸­ã€‚</p>
<p>@tab <code>Comparator</code> æ¥å£ä½¿ç”¨ç¤ºä¾‹</p>
<p><code>Comparator</code> æ¥å£ä½¿ç”¨ç¤ºä¾‹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ComparatorDemo</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">User</span> <span class="variable">a</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">&quot;A&quot;</span>, <span class="number">18</span>);</span><br><span class="line">        <span class="type">User</span> <span class="variable">b</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">&quot;B&quot;</span>, <span class="number">17</span>);</span><br><span class="line">        <span class="type">User</span> <span class="variable">c</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">&quot;C&quot;</span>, <span class="number">20</span>);</span><br><span class="line">        List&lt;User&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(Arrays.asList(a, b, c));</span><br><span class="line">        Collections.sort(list, <span class="keyword">new</span> <span class="title class_">Comparator</span>&lt;User&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">compare</span><span class="params">(User o1, User o2)</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> o1.age - o2.age;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        list.forEach(System.out::println);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è¾“å‡ºï¼š</span></span><br><span class="line">    <span class="comment">// User&#123;age=17, name=&#x27;B&#x27;&#125;</span></span><br><span class="line">    <span class="comment">// User&#123;age=18, name=&#x27;A&#x27;&#125;</span></span><br><span class="line">    <span class="comment">// User&#123;age=20, name=&#x27;C&#x27;&#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> String name;</span><br><span class="line">        <span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">User</span><span class="params">(String name, <span class="type">int</span> age)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.age = age;</span><br><span class="line">            <span class="built_in">this</span>.name = name;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// getterã€setter ç•¥</span></span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;User&#123;&quot;</span> + <span class="string">&quot;age=&quot;</span> + age + <span class="string">&quot;, name=&#x27;&quot;</span> + name + <span class="string">&#x27;\&#x27;&#x27;</span> + <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä»ä¸Šä¾‹å¯ä»¥çœ‹å‡ºï¼Œä½¿ç”¨ <code>Comparator</code> æ¥å£å’Œ  <code>Comparable</code> æ¥å£çš„ä¸åŒç‚¹åœ¨äºï¼šè¢«æ’åºçš„å¯¹è±¡ç±»æ— éœ€å®ç° <code>Comparator</code> æ¥å£ï¼Œæ’åºé€»è¾‘ç½®äºè¢«æ’åºå¯¹è±¡ç±»çš„å¤–éƒ¨ã€‚</p>
<p>:::</p>
<h3 id="Cloneable"><a href="#Cloneable" class="headerlink" title="Cloneable"></a>Cloneable</h3><p>Java ä¸­ ä¸€ä¸ªç±»è¦å®ç° <code>clone</code> åŠŸèƒ½ å¿…é¡»å®ç° <code>Cloneable</code> æ¥å£ï¼Œå¦åˆ™åœ¨è°ƒç”¨ <code>clone()</code> æ—¶ä¼šæŠ¥ <code>CloneNotSupportedException</code> å¼‚å¸¸ã€‚</p>
<p>Java ä¸­æ‰€æœ‰ç±»éƒ½é»˜è®¤ç»§æ‰¿ <code>java.lang.Object</code> ç±»ï¼Œåœ¨ <code>java.lang.Object</code> ç±»ä¸­æœ‰ä¸€ä¸ªæ–¹æ³• <code>clone()</code>ï¼Œè¿™ä¸ªæ–¹æ³•å°†è¿”å› <code>Object</code> å¯¹è±¡çš„ä¸€ä¸ªæ‹·è´ã€‚<code>Object</code> ç±»é‡Œçš„ <code>clone()</code> æ–¹æ³•ä»…ä»…ç”¨äºæµ…æ‹·è´ï¼ˆæ‹·è´åŸºæœ¬æˆå‘˜å±æ€§ï¼Œå¯¹äºå¼•ç”¨ç±»å‹ä»…è¿”å›æŒ‡å‘æ”¹åœ°å€çš„å¼•ç”¨ï¼‰ã€‚</p>
<p>å¦‚æœ Java ç±»éœ€è¦æ·±æ‹·è´ï¼Œéœ€è¦è¦†å†™ <code>clone()</code> æ–¹æ³•ã€‚</p>
<h3 id="fail-fast"><a href="#fail-fast" class="headerlink" title="fail-fast"></a>fail-fast</h3><h4 id="fail-fast-çš„è¦ç‚¹"><a href="#fail-fast-çš„è¦ç‚¹" class="headerlink" title="fail-fast çš„è¦ç‚¹"></a>fail-fast çš„è¦ç‚¹</h4><p>Java å®¹å™¨ï¼ˆå¦‚ï¼šArrayListã€HashMapã€TreeSet ç­‰å¾…ï¼‰çš„ javadoc ä¸­å¸¸å¸¸æåˆ°ç±»ä¼¼çš„æè¿°ï¼š</p>
<blockquote>
<p>æ³¨æ„ï¼Œè¿­ä»£å™¨çš„å¿«é€Ÿå¤±è´¥è¡Œä¸ºæ— æ³•å¾—åˆ°ä¿è¯ï¼Œå› ä¸ºä¸€èˆ¬æ¥è¯´ï¼Œä¸å¯èƒ½å¯¹æ˜¯å¦å‡ºç°ä¸åŒæ­¥å¹¶å‘ä¿®æ”¹åšå‡ºä»»ä½•ç¡¬æ€§ä¿è¯ã€‚å¿«é€Ÿå¤±è´¥ï¼ˆfail-fastï¼‰è¿­ä»£å™¨ä¼šå°½æœ€å¤§åŠªåŠ›æŠ›å‡º <code>ConcurrentModificationException</code>ã€‚å› æ­¤ï¼Œä¸ºæé«˜è¿™ç±»è¿­ä»£å™¨çš„æ­£ç¡®æ€§è€Œç¼–å†™ä¸€ä¸ªä¾èµ–äºæ­¤å¼‚å¸¸çš„ç¨‹åºæ˜¯é”™è¯¯çš„åšæ³•ï¼šè¿­ä»£å™¨çš„å¿«é€Ÿå¤±è´¥è¡Œä¸ºåº”è¯¥ä»…ç”¨äºæ£€æµ‹ bugã€‚</p>
</blockquote>
<p>é‚£ä¹ˆï¼Œæˆ‘ä»¬ä¸ç¦è¦é—®ï¼Œä»€ä¹ˆæ˜¯ fail-fastï¼Œä¸ºä»€ä¹ˆè¦æœ‰ fail-fast æœºåˆ¶ï¼Ÿ</p>
<p><strong>fail-fast æ˜¯ Java å®¹å™¨çš„ä¸€ç§é”™è¯¯æ£€æµ‹æœºåˆ¶</strong>ã€‚å½“å¤šä¸ªçº¿ç¨‹å¯¹å®¹å™¨è¿›è¡Œç»“æ„ä¸Šçš„æ”¹å˜çš„æ“ä½œæ—¶ï¼Œå°±å¯èƒ½è§¦å‘ fail-fast æœºåˆ¶ã€‚è®°ä½æ˜¯æœ‰å¯èƒ½ï¼Œè€Œä¸æ˜¯ä¸€å®šã€‚</p>
<p>ä¾‹å¦‚ï¼šå‡è®¾å­˜åœ¨ä¸¤ä¸ªçº¿ç¨‹ï¼ˆçº¿ç¨‹ 1ã€çº¿ç¨‹ 2ï¼‰ï¼Œçº¿ç¨‹ 1 é€šè¿‡ <code>Iterator</code> åœ¨éå†å®¹å™¨ A ä¸­çš„å…ƒç´ ï¼Œåœ¨æŸä¸ªæ—¶å€™çº¿ç¨‹ 2 ä¿®æ”¹äº†å®¹å™¨ A çš„ç»“æ„ï¼ˆæ˜¯ç»“æ„ä¸Šé¢çš„ä¿®æ”¹ï¼Œè€Œä¸æ˜¯ç®€å•çš„ä¿®æ”¹å®¹å™¨å…ƒç´ çš„å†…å®¹ï¼‰ï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶å€™ç¨‹åºå°±ä¼šæŠ›å‡º <code>ConcurrentModificationException</code> å¼‚å¸¸ï¼Œä»è€Œäº§ç”Ÿ fail-fast æœºåˆ¶ã€‚</p>
<p><strong>å®¹å™¨åœ¨è¿­ä»£æ“ä½œä¸­æ”¹å˜å…ƒç´ ä¸ªæ•°ï¼ˆæ·»åŠ ã€åˆ é™¤å…ƒç´ ï¼‰éƒ½å¯èƒ½ä¼šå¯¼è‡´ fail-fast</strong>ã€‚</p>
<p>ç¤ºä¾‹ï¼šfail-fast ç¤ºä¾‹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FailFastDemo</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">MAX</span> <span class="operator">=</span> <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> List&lt;Integer&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; MAX; i++) &#123;</span><br><span class="line">            list.add(i);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">MyThreadA</span>()).start();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">MyThreadB</span>()).start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** è¿­ä»£éå†å®¹å™¨æ‰€æœ‰å…ƒç´  */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MyThreadA</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            Iterator&lt;Integer&gt; iterator = list.iterator();</span><br><span class="line">            <span class="keyword">while</span> (iterator.hasNext()) &#123;</span><br><span class="line">                <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> iterator.next();</span><br><span class="line">                System.out.println(<span class="string">&quot;MyThreadA è®¿é—®å…ƒç´ ï¼š&quot;</span> + i);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    TimeUnit.MILLISECONDS.sleep(<span class="number">100</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** éå†åˆ é™¤æŒ‡å®šèŒƒå›´å†…çš„æ‰€æœ‰å¶æ•° */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MyThreadB</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">while</span> (i &lt; MAX) &#123;</span><br><span class="line">                <span class="keyword">if</span> (i % <span class="number">2</span> == <span class="number">0</span>) &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;MyThreadB åˆ é™¤å…ƒç´ &quot;</span> + i);</span><br><span class="line">                    list.remove(i);</span><br><span class="line">                &#125;</span><br><span class="line">                i++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ‰§è¡Œåï¼Œä¼šæŠ›å‡º <code>java.util.ConcurrentModificationException</code> å¼‚å¸¸ã€‚</p>
<h4 id="è§£å†³-fail-fast"><a href="#è§£å†³-fail-fast" class="headerlink" title="è§£å†³ fail-fast"></a>è§£å†³ fail-fast</h4><p>fail-fast æœ‰ä¸¤ç§è§£å†³æ–¹æ¡ˆï¼š</p>
<ul>
<li>åœ¨éå†è¿‡ç¨‹ä¸­æ‰€æœ‰æ¶‰åŠåˆ°æ”¹å˜å®¹å™¨ä¸ªæ•°çš„åœ°æ–¹å…¨éƒ¨åŠ ä¸Š <code>synchronized</code> æˆ–è€…ç›´æ¥ä½¿ç”¨ <code>Collections.synchronizedXXX</code> å®¹å™¨ï¼Œè¿™æ ·å°±å¯ä»¥è§£å†³ã€‚ä½†æ˜¯ä¸æ¨èï¼Œå› ä¸ºå¢åˆ é€ æˆçš„åŒæ­¥é”å¯èƒ½ä¼šé˜»å¡éå†æ“ä½œï¼Œå½±å“ååã€‚</li>
<li>ä½¿ç”¨å¹¶å‘å®¹å™¨ï¼Œå¦‚ï¼š<code>CopyOnWriterArrayList</code>ã€‚</li>
</ul>
<h2 id="å®¹å™¨å’Œçº¿ç¨‹å®‰å…¨"><a href="#å®¹å™¨å’Œçº¿ç¨‹å®‰å…¨" class="headerlink" title="å®¹å™¨å’Œçº¿ç¨‹å®‰å…¨"></a>å®¹å™¨å’Œçº¿ç¨‹å®‰å…¨</h2><p>ä¸ºäº†åœ¨å¹¶å‘ç¯å¢ƒä¸‹å®‰å…¨åœ°ä½¿ç”¨å®¹å™¨ï¼ŒJava æä¾›äº†åŒæ­¥å®¹å™¨å’Œå¹¶å‘å®¹å™¨ã€‚</p>
<blockquote>
<p>åŒæ­¥å®¹å™¨å’Œå¹¶å‘å®¹å™¨è¯¦æƒ…è¯·å‚è€ƒï¼š<a href="https://dunwu.github.io/waterdrop/pages/5d509ca6/">Java å¹¶å‘ä¹‹å®¹å™¨</a></p>
</blockquote>
<h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ul>
<li><a target="_blank" rel="noopener" href="https://item.jd.com/10058164.html">Java ç¼–ç¨‹æ€æƒ³ï¼ˆç¬¬ 4 ç‰ˆï¼‰</a></li>
<li><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/589d58033841">ç”±æµ…å…¥æ·±ç†è§£ java é›†åˆï¼ˆä¸€ï¼‰â€”â€”é›†åˆæ¡†æ¶ Collectionã€Map</a></li>
<li><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/9081017a2d67">ç”±æµ…å…¥æ·±ç†è§£ java é›†åˆï¼ˆäºŒï¼‰â€”â€”é›†åˆ Set</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/chenssy/p/3821328.html">Java æé«˜ç¯‡ï¼ˆä¸‰åï¼‰â€”â€“Iterator</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/chenssy/article/details/38151189">Java æé«˜ç¯‡ï¼ˆä¸‰å››ï¼‰â€”â€“fail-fast æœºåˆ¶</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://dunwu.github.io/blog/pages/521e1ee3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/uploads/avatar.gif">
      <meta itemprop="name" content="é’æ‚Ÿ â—¾ Dunwu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dunwu Blog">
      <meta itemprop="description" content="é’æ‚Ÿçš„ä¸ªäººåšå®¢">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Dunwu Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/pages/521e1ee3/" class="post-title-link" itemprop="url">Java å¹¶å‘ä¹‹ AQS</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2019-12-26 23:11:52" itemprop="dateCreated datePublished" datetime="2019-12-26T23:11:52+08:00">2019-12-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">æ›´æ–°äº</span>
      <time title="ä¿®æ”¹æ—¶é—´ï¼š2025-09-13 17:56:53" itemprop="dateModified" datetime="2025-09-13T17:56:53+08:00">2025-09-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
        </span>
          ï¼Œ
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/JavaCore/" itemprop="url" rel="index"><span itemprop="name">JavaCore</span></a>
        </span>
          ï¼Œ
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/JavaCore/%E5%B9%B6%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">å¹¶å‘</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
      <span>6.4k</span>
    </span>
    <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
      <span>6 åˆ†é’Ÿ</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Java-å¹¶å‘ä¹‹-AQS"><a href="#Java-å¹¶å‘ä¹‹-AQS" class="headerlink" title="Java å¹¶å‘ä¹‹ AQS"></a>Java å¹¶å‘ä¹‹ AQS</h1><h2 id="AQS-ç®€ä»‹"><a href="#AQS-ç®€ä»‹" class="headerlink" title="AQS ç®€ä»‹"></a>AQS ç®€ä»‹</h2><p><strong>AQS</strong> æ˜¯ <code>AbstractQueuedSynchronizer</code> çš„ç¼©å†™ï¼Œå³ <strong>é˜Ÿåˆ—åŒæ­¥å™¨</strong>ï¼Œé¡¾åæ€ä¹‰ï¼Œå…¶ä¸»è¦ä½œç”¨æ˜¯å¤„ç†åŒæ­¥ã€‚å®ƒæ˜¯å¹¶å‘é”å’Œå¾ˆå¤šåŒæ­¥å·¥å…·ç±»çš„å®ç°åŸºçŸ³ï¼ˆå¦‚ <code>ReentrantLock</code>ã€<code>ReentrantReadWriteLock</code>ã€<code>CountDownLatch</code>ã€<code>Semaphore</code>ã€<code>FutureTask</code> ç­‰ï¼‰ã€‚</p>
<p>**AQS æä¾›äº†å¯¹é”å’ŒåŒæ­¥å™¨çš„é€šç”¨èƒ½åŠ›æ”¯æŒ **ã€‚åœ¨ <code>java.util.concurrent.locks</code> åŒ…ä¸­çš„ç›¸å…³é”ï¼ˆå¸¸ç”¨çš„æœ‰ <code>ReentrantLock</code>ã€ <code>ThreadPoolExecutor</code>ï¼‰éƒ½æ˜¯åŸºäº AQS æ¥å®ç°ã€‚è¿™äº›é”éƒ½æ²¡æœ‰ç›´æ¥ç»§æ‰¿ AQSï¼Œè€Œæ˜¯å®šä¹‰äº†ä¸€ä¸ª <code>Sync</code> ç±»å»ç»§æ‰¿ AQSã€‚ä¸ºä»€ä¹ˆè¦è¿™æ ·å‘¢ï¼Ÿå› ä¸ºé”é¢å‘çš„æ˜¯ä½¿ç”¨ç”¨æˆ·ï¼Œè€ŒåŒæ­¥å™¨é¢å‘çš„åˆ™æ˜¯çº¿ç¨‹æ§åˆ¶ï¼Œé‚£ä¹ˆåœ¨é”çš„å®ç°ä¸­èšåˆåŒæ­¥å™¨è€Œä¸æ˜¯ç›´æ¥ç»§æ‰¿ AQS å°±å¯ä»¥å¾ˆå¥½çš„éš”ç¦»äºŒè€…æ‰€å…³æ³¨çš„äº‹æƒ…ã€‚</p>
<h2 id="AQS-çš„åº”ç”¨"><a href="#AQS-çš„åº”ç”¨" class="headerlink" title="AQS çš„åº”ç”¨"></a>AQS çš„åº”ç”¨</h2><p>AQS å®šä¹‰ä¸¤ç§èµ„æºå…±äº«æ–¹å¼ï¼š<code>Exclusive</code>ï¼ˆç‹¬å ï¼Œåªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½æ‰§è¡Œï¼Œå¦‚ <code>ReentrantLock</code>ï¼‰å’Œ <code>Share</code>ï¼ˆå…±äº«ï¼Œå¤šä¸ªçº¿ç¨‹å¯åŒæ—¶æ‰§è¡Œï¼Œå¦‚ <code>Semaphore</code> &#x2F; <code>CountDownLatch</code>ï¼‰ã€‚</p>
<h3 id="ç‹¬å é”-API"><a href="#ç‹¬å é”-API" class="headerlink" title="ç‹¬å é” API"></a>ç‹¬å é” API</h3><p>è·å–ã€é‡Šæ”¾ç‹¬å é”çš„ä¸»è¦ API å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">acquire</span><span class="params">(<span class="type">int</span> arg)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">acquireInterruptibly</span><span class="params">(<span class="type">int</span> arg)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">tryAcquireNanos</span><span class="params">(<span class="type">int</span> arg, <span class="type">long</span> nanosTimeout)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">release</span><span class="params">(<span class="type">int</span> arg)</span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>acquire</code> - è·å–ç‹¬å é”ã€‚</li>
<li><code>acquireInterruptibly</code> - è·å–å¯ä¸­æ–­çš„ç‹¬å é”ã€‚</li>
<li><code>tryAcquireNanos</code> - å°è¯•åœ¨æŒ‡å®šæ—¶é—´å†…è·å–å¯ä¸­æ–­çš„ç‹¬å é”ã€‚åœ¨ä»¥ä¸‹ä¸‰ç§æƒ…å†µä¸‹å›è¿”å›ï¼š<ul>
<li>åœ¨è¶…æ—¶æ—¶é—´å†…ï¼Œå½“å‰çº¿ç¨‹æˆåŠŸè·å–äº†é”ï¼›</li>
<li>å½“å‰çº¿ç¨‹åœ¨è¶…æ—¶æ—¶é—´å†…è¢«ä¸­æ–­ï¼›</li>
<li>è¶…æ—¶æ—¶é—´ç»“æŸï¼Œä»æœªè·å¾—é”è¿”å› falseã€‚</li>
</ul>
</li>
<li><code>release</code> - é‡Šæ”¾ç‹¬å é”ã€‚</li>
</ul>
<h3 id="å…±äº«é”-API"><a href="#å…±äº«é”-API" class="headerlink" title="å…±äº«é” API"></a>å…±äº«é” API</h3><p>è·å–ã€é‡Šæ”¾å…±äº«é”çš„ä¸»è¦ API å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">acquireShared</span><span class="params">(<span class="type">int</span> arg)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">acquireSharedInterruptibly</span><span class="params">(<span class="type">int</span> arg)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">tryAcquireSharedNanos</span><span class="params">(<span class="type">int</span> arg, <span class="type">long</span> nanosTimeout)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">releaseShared</span><span class="params">(<span class="type">int</span> arg)</span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>acquireShared</code> - è·å–å…±äº«é”ã€‚</li>
<li><code>acquireSharedInterruptibly</code> - è·å–å¯ä¸­æ–­çš„å…±äº«é”ã€‚</li>
<li><code>tryAcquireSharedNanos</code> - å°è¯•åœ¨æŒ‡å®šæ—¶é—´å†…è·å–å¯ä¸­æ–­çš„å…±äº«é”ã€‚</li>
<li><code>release</code> - é‡Šæ”¾å…±äº«é”ã€‚</li>
</ul>
<h2 id="AQS-çš„åŸç†"><a href="#AQS-çš„åŸç†" class="headerlink" title="AQS çš„åŸç†"></a>AQS çš„åŸç†</h2><p>AQS æ ¸å¿ƒæ€æƒ³æ˜¯ï¼Œå¦‚æœè¢«è¯·æ±‚çš„å…±äº«èµ„æºç©ºé—²ï¼Œåˆ™å°†å½“å‰è¯·æ±‚èµ„æºçš„çº¿ç¨‹è®¾ç½®ä¸ºæœ‰æ•ˆçš„å·¥ä½œçº¿ç¨‹ï¼Œå¹¶ä¸”å°†å…±äº«èµ„æºè®¾ç½®ä¸ºé”å®šçŠ¶æ€ï¼›å¦‚æœè¢«è¯·æ±‚çš„å…±äº«èµ„æºè¢«å ç”¨ï¼Œé‚£ä¹ˆå°±éœ€è¦ä¸€å¥—çº¿ç¨‹é˜»å¡ç­‰å¾…ä»¥åŠè¢«å”¤é†’æ—¶é”åˆ†é…çš„æœºåˆ¶ã€‚è¿™ä¸ªæœºåˆ¶æ˜¯åŸºäº <strong>CLH é”</strong> ï¼ˆCraig, Landin, and Hagersten locksï¼‰ çš„å˜ä½“å®ç°çš„ï¼Œå°†æš‚æ—¶è·å–ä¸åˆ°é”çš„çº¿ç¨‹åŠ å…¥åˆ°é˜Ÿåˆ—ä¸­ã€‚</p>
<p>CLH æœ¬æ˜¯ä¸€ä¸ªå•å‘é˜Ÿåˆ—ï¼ŒAQS ä¸­çš„é˜Ÿåˆ—é‡‡ç”¨äº† CLH çš„å˜ä½“ï¼Œæ˜¯ä¸€ä¸ªè™šæ‹Ÿçš„ FIFO åŒå‘é˜Ÿåˆ—ï¼ˆè™šæ‹Ÿçš„åŒå‘é˜Ÿåˆ—ï¼Œæ˜¯æŒ‡ä¸å­˜åœ¨ç»“ç‚¹å®ä¾‹ï¼Œä»…å­˜åœ¨ç»“ç‚¹ä¹‹é—´çš„å…³è”å…³ç³»ï¼‰ï¼Œæš‚æ—¶è·å–ä¸åˆ°é”çš„çº¿ç¨‹å°†è¢«åŠ å…¥åˆ°è¯¥é˜Ÿåˆ—ä¸­ã€‚AQS å°†æ¯æ¡è¯·æ±‚å…±äº«èµ„æºçš„çº¿ç¨‹å°è£…æˆä¸€ä¸ª CLH é˜Ÿåˆ—é”çš„ä¸€ä¸ªç»“ç‚¹ï¼ˆNodeï¼‰æ¥å®ç°é”çš„åˆ†é…ã€‚åœ¨ CLH é˜Ÿåˆ—é”ä¸­ï¼Œä¸€ä¸ªèŠ‚ç‚¹è¡¨ç¤ºä¸€ä¸ªçº¿ç¨‹ï¼Œå®ƒä¿å­˜ç€çº¿ç¨‹çš„å¼•ç”¨ï¼ˆthreadï¼‰ã€ å½“å‰èŠ‚ç‚¹åœ¨é˜Ÿåˆ—ä¸­çš„çŠ¶æ€ï¼ˆwaitStatusï¼‰ã€å‰é©±èŠ‚ç‚¹ï¼ˆprevï¼‰ã€åç»§èŠ‚ç‚¹ï¼ˆnextï¼‰ã€‚</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/202409120729373.png"></p>
<p>AQS çš„æ ¸å¿ƒåŸç†å›¾ï¼š</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/202409120729594.png"></p>
<h3 id="AQS-çš„æ•°æ®ç»“æ„"><a href="#AQS-çš„æ•°æ®ç»“æ„" class="headerlink" title="AQS çš„æ•°æ®ç»“æ„"></a>AQS çš„æ•°æ®ç»“æ„</h3><p>å…ˆçœ‹ä¸€ä¸‹ <code>AbstractQueuedSynchronizer</code> çš„å®šä¹‰ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">AbstractQueuedSynchronizer</span></span><br><span class="line">    <span class="keyword">extends</span> <span class="title class_">AbstractOwnableSynchronizer</span></span><br><span class="line">    <span class="keyword">implements</span> <span class="title class_">java</span>.io.Serializable &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** ç­‰å¾…é˜Ÿåˆ—çš„é˜Ÿå¤´ï¼Œæ‡’åŠ è½½ã€‚åªèƒ½é€šè¿‡ setHead æ–¹æ³•ä¿®æ”¹ã€‚ */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> Node head;</span><br><span class="line">    <span class="comment">/** ç­‰å¾…é˜Ÿåˆ—çš„é˜Ÿå°¾ï¼Œæ‡’åŠ è½½ã€‚åªèƒ½é€šè¿‡ enq æ–¹æ³•æ·»åŠ æ–°çš„ç­‰å¾…èŠ‚ç‚¹ã€‚*/</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> Node tail;</span><br><span class="line">    <span class="comment">/** åŒæ­¥çŠ¶æ€ */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">int</span> state;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é˜…è¯» AQS çš„æºç ï¼Œå¯ä»¥å‘ç°ï¼šAQS ç»§æ‰¿è‡ª <code>AbstractOwnableSynchronize</code>ï¼Œå®ƒæœ‰ä»¥ä¸‹æ ¸å¿ƒå±æ€§ï¼š</p>
<ul>
<li><code>state</code> - AQS ä½¿ç”¨ä¸€ä¸ªæ•´å‹çš„ <code>volatile</code> å˜é‡æ¥ <strong>ç»´æŠ¤åŒæ­¥çŠ¶æ€</strong>ã€‚è¿™ä¸ªæ•´æ•°çŠ¶æ€çš„æ„ä¹‰ç”±å­ç±»æ¥èµ‹äºˆï¼Œå¦‚ <code>ReentrantLock</code> ä¸­è¯¥çŠ¶æ€å€¼è¡¨ç¤ºæ‰€æœ‰è€…çº¿ç¨‹å·²ç»é‡å¤è·å–è¯¥é”çš„æ¬¡æ•°ï¼›<code>Semaphore</code> ä¸­è¯¥çŠ¶æ€å€¼è¡¨ç¤ºå‰©ä½™çš„è®¸å¯æ•°é‡ã€‚</li>
<li><code>head</code> å’Œ <code>tail</code> - AQS **ç»´æŠ¤äº†ä¸€ä¸ª <code>Node</code> ç±»å‹ï¼ˆAQS çš„å†…éƒ¨ç±»ï¼‰çš„åŒå‘é˜Ÿåˆ—æ¥å®ŒæˆåŒæ­¥çŠ¶æ€çš„ç®¡ç† **ã€‚è¿™ä¸ªåŒå‘é˜Ÿåˆ—æ˜¯ä¸€ä¸ªåŒå‘çš„ FIFO é˜Ÿåˆ—ï¼Œé€šè¿‡ <code>head</code> å’Œ <code>tail</code> æŒ‡é’ˆè¿›è¡Œè®¿é—®ã€‚å½“ **æœ‰çº¿ç¨‹è·å–é”å¤±è´¥åï¼Œå°±è¢«æ·»åŠ åˆ°é˜Ÿåˆ—æœ«å°¾ **ã€‚</li>
</ul>
<p>å†æ¥çœ‹ä¸€ä¸‹ <code>Node</code> çš„æºç ï¼Œå¾ˆæ˜¾ç„¶ï¼ŒNode æ˜¯ä¸€ä¸ªåŒå‘é˜Ÿåˆ—ç»“æ„ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Node</span> &#123;</span><br><span class="line">    <span class="comment">/** è¯¥ç­‰å¾…åŒæ­¥çš„èŠ‚ç‚¹å¤„äºå…±äº«æ¨¡å¼ */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Node</span> <span class="variable">SHARED</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Node</span>();</span><br><span class="line">    <span class="comment">/** è¯¥ç­‰å¾…åŒæ­¥çš„èŠ‚ç‚¹å¤„äºç‹¬å æ¨¡å¼ */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Node</span> <span class="variable">EXCLUSIVE</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** çº¿ç¨‹ç­‰å¾…çŠ¶æ€ï¼ŒçŠ¶æ€å€¼æœ‰ï¼š0ã€1ã€-1ã€-2ã€-3 */</span></span><br><span class="line">    <span class="keyword">volatile</span> <span class="type">int</span> waitStatus;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">CANCELLED</span> <span class="operator">=</span>  <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">SIGNAL</span>    <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">CONDITION</span> <span class="operator">=</span> -<span class="number">2</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">PROPAGATE</span> <span class="operator">=</span> -<span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** å‰é©±èŠ‚ç‚¹ */</span></span><br><span class="line">    <span class="keyword">volatile</span> Node prev;</span><br><span class="line">    <span class="comment">/** åç»§èŠ‚ç‚¹ */</span></span><br><span class="line">    <span class="keyword">volatile</span> Node next;</span><br><span class="line">    <span class="comment">/** ç­‰å¾…é”çš„çº¿ç¨‹ */</span></span><br><span class="line">    <span class="keyword">volatile</span> Thread thread;</span><br><span class="line"></span><br><span class="line">  	<span class="comment">/** å’ŒèŠ‚ç‚¹æ˜¯å¦å…±äº«æœ‰å…³ */</span></span><br><span class="line">    Node nextWaiter;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å±æ€§è¯´æ˜ï¼š</p>
<table>
<thead>
<tr>
<th align="left">æ–¹æ³•å’Œå±æ€§å€¼</th>
<th align="left">å«ä¹‰</th>
</tr>
</thead>
<tbody><tr>
<td align="left">waitStatus</td>
<td align="left">å½“å‰èŠ‚ç‚¹åœ¨é˜Ÿåˆ—ä¸­çš„çŠ¶æ€</td>
</tr>
<tr>
<td align="left">thread</td>
<td align="left">è¡¨ç¤ºå¤„äºè¯¥èŠ‚ç‚¹çš„çº¿ç¨‹</td>
</tr>
<tr>
<td align="left">prev</td>
<td align="left">å‰é©±æŒ‡é’ˆ</td>
</tr>
<tr>
<td align="left">next</td>
<td align="left">åç»§æŒ‡é’ˆ</td>
</tr>
</tbody></table>
<p><code>waitStatus</code> æ˜¯ä¸€ä¸ªæ•´å‹çš„ <code>volatile</code> å˜é‡ï¼Œç”¨æ¥ç»´æŠ¤ AQS åŒæ­¥é˜Ÿåˆ—ä¸­çº¿ç¨‹èŠ‚ç‚¹çš„çŠ¶æ€ã€‚<code>waitStatus</code> æœ‰äº”ä¸ªçŠ¶æ€å€¼ï¼š</p>
<ul>
<li>0 - ä¸€ä¸ª Node è¢«åˆå§‹åŒ–çš„æ—¶å€™çš„é»˜è®¤å€¼</li>
<li><code>CANCELLED(1)</code> - è¡¨ç¤ºçº¿ç¨‹è·å–é”çš„è¯·æ±‚å·²ç»å–æ¶ˆäº†</li>
<li><code>SIGNAL(-1)</code> - è¡¨ç¤ºçº¿ç¨‹å·²ç»å‡†å¤‡å¥½äº†ï¼Œå°±ç­‰èµ„æºé‡Šæ”¾äº†</li>
<li><code>CONDITION(-2)</code> - è¡¨ç¤ºèŠ‚ç‚¹åœ¨ç­‰å¾…é˜Ÿåˆ—ä¸­ï¼ŒèŠ‚ç‚¹çº¿ç¨‹ç­‰å¾…å”¤é†’</li>
<li><code>PROPAGATE(-3)</code> - å½“å‰çº¿ç¨‹å¤„åœ¨ SHARED æƒ…å†µä¸‹ï¼Œè¯¥å­—æ®µæ‰ä¼šä½¿ç”¨</li>
</ul>
<h3 id="ç‹¬å é”çš„è·å–å’Œé‡Šæ”¾"><a href="#ç‹¬å é”çš„è·å–å’Œé‡Šæ”¾" class="headerlink" title="ç‹¬å é”çš„è·å–å’Œé‡Šæ”¾"></a>ç‹¬å é”çš„è·å–å’Œé‡Šæ”¾</h3><p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/202409120730774.png"></p>
<h4 id="è·å–ç‹¬å é”"><a href="#è·å–ç‹¬å é”" class="headerlink" title="è·å–ç‹¬å é”"></a>è·å–ç‹¬å é”</h4><p>AQS ä¸­ä½¿ç”¨ <code>acquire(int arg)</code> æ–¹æ³•è·å–ç‹¬å é”çš„ç›¸å…³æºç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">acquire</span><span class="params">(<span class="type">int</span> arg)</span> &#123;</span><br><span class="line">	<span class="keyword">if</span> (!tryAcquire(arg) &amp;&amp;</span><br><span class="line">		acquireQueued(addWaiter(Node.EXCLUSIVE), arg))</span><br><span class="line">		selfInterrupt();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ©ç”¨ CAS æ“ä½œå°†å½“å‰çº¿ç¨‹åŠ å…¥ç­‰å¾…é˜Ÿåˆ—é˜Ÿå°¾</span></span><br><span class="line"><span class="keyword">private</span> Node <span class="title function_">addWaiter</span><span class="params">(Node mode)</span> &#123;</span><br><span class="line">	<span class="type">Node</span> <span class="variable">node</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Node</span>(Thread.currentThread(), mode);</span><br><span class="line">	<span class="type">Node</span> <span class="variable">pred</span> <span class="operator">=</span> tail;</span><br><span class="line">	<span class="keyword">if</span> (pred != <span class="literal">null</span>) &#123;</span><br><span class="line">		node.prev = pred;</span><br><span class="line">		<span class="keyword">if</span> (compareAndSetTail(pred, node)) &#123;</span><br><span class="line">			pred.next = node;</span><br><span class="line">			<span class="keyword">return</span> node;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	enq(node);</span><br><span class="line">	<span class="keyword">return</span> node;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è‡ªæ—‹å°è¯•ä¸ºç­‰å¾…é˜Ÿåˆ—ä¸­çš„çº¿ç¨‹èŠ‚ç‚¹è·å–ç‹¬å é”</span></span><br><span class="line"><span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">acquireQueued</span><span class="params">(<span class="keyword">final</span> Node node, <span class="type">int</span> arg)</span> &#123;</span><br><span class="line">	<span class="type">boolean</span> <span class="variable">failed</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		<span class="type">boolean</span> <span class="variable">interrupted</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">		<span class="keyword">for</span> (;;) &#123;</span><br><span class="line">			<span class="keyword">final</span> <span class="type">Node</span> <span class="variable">p</span> <span class="operator">=</span> node.predecessor();</span><br><span class="line">            <span class="comment">// è·å–é”æˆåŠŸï¼Œé€€å‡º</span></span><br><span class="line">			<span class="keyword">if</span> (p == head &amp;&amp; tryAcquire(arg)) &#123;</span><br><span class="line">				setHead(node);</span><br><span class="line">				p.next = <span class="literal">null</span>; <span class="comment">// help GC</span></span><br><span class="line">				failed = <span class="literal">false</span>;</span><br><span class="line">				<span class="keyword">return</span> interrupted;</span><br><span class="line">			&#125;</span><br><span class="line">            <span class="comment">// çº¿ç¨‹ä¸­æ–­</span></span><br><span class="line">			<span class="keyword">if</span> (shouldParkAfterFailedAcquire(p, node) &amp;&amp;</span><br><span class="line">				parkAndCheckInterrupt())</span><br><span class="line">				interrupted = <span class="literal">true</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (failed)</span><br><span class="line">			cancelAcquire(node);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…¶å¤§è‡´æµç¨‹å¦‚ä¸‹ï¼š</p>
<ol>
<li>å…ˆé€šè¿‡ <code>tryAcquire</code> å°è¯•è·å–åŒæ­¥çŠ¶æ€ï¼Œå¦‚æœè·å–åŒæ­¥çŠ¶æ€æˆåŠŸï¼Œåˆ™ç»“æŸæ–¹æ³•ï¼Œç›´æ¥è¿”å›ã€‚</li>
<li>è‹¥ä¸æˆåŠŸï¼Œè°ƒç”¨ <code>addWaiter</code> æ–¹æ³•ï¼Œåˆ©ç”¨ CAS æ“ä½œå°†å½“å‰çº¿ç¨‹åŠ å…¥ç­‰å¾…é˜Ÿåˆ—é˜Ÿå°¾ã€‚</li>
<li>æ¥ç€ï¼Œè‡ªæ—‹å°è¯•ä¸ºç­‰å¾…é˜Ÿåˆ—ä¸­çš„çº¿ç¨‹èŠ‚ç‚¹è·å–ç‹¬å é”ï¼Œç›´åˆ°è·å–æˆåŠŸæˆ–çº¿ç¨‹ä¸­æ–­ã€‚</li>
</ol>
<h4 id="é‡Šæ”¾ç‹¬å é”"><a href="#é‡Šæ”¾ç‹¬å é”" class="headerlink" title="é‡Šæ”¾ç‹¬å é”"></a>é‡Šæ”¾ç‹¬å é”</h4><p>AQS ä¸­ä½¿ç”¨ <code>acquire(int arg)</code> æ–¹æ³•è·å–ç‹¬å é”çš„ç›¸å…³æºç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">release</span><span class="params">(<span class="type">int</span> arg)</span> &#123;</span><br><span class="line">    <span class="comment">// å°è¯•é‡Šæ”¾é”</span></span><br><span class="line">	<span class="keyword">if</span> (tryRelease(arg)) &#123;</span><br><span class="line">		<span class="type">Node</span> <span class="variable">h</span> <span class="operator">=</span> head;</span><br><span class="line">        <span class="comment">// å¦‚æœé˜Ÿåˆ—ä¸ä¸ºç©ºï¼Œå”¤é†’ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ä¸­çš„çº¿ç¨‹</span></span><br><span class="line">		<span class="keyword">if</span> (h != <span class="literal">null</span> &amp;&amp; h.waitStatus != <span class="number">0</span>)</span><br><span class="line">			unparkSuccessor(h);</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">unparkSuccessor</span><span class="params">(Node node)</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="type">int</span> <span class="variable">ws</span> <span class="operator">=</span> node.waitStatus;</span><br><span class="line">	<span class="keyword">if</span> (ws &lt; <span class="number">0</span>)</span><br><span class="line">		compareAndSetWaitStatus(node, ws, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">	<span class="type">Node</span> <span class="variable">s</span> <span class="operator">=</span> node.next;</span><br><span class="line">	<span class="keyword">if</span> (s == <span class="literal">null</span> || s.waitStatus &gt; <span class="number">0</span>) &#123;</span><br><span class="line">		s = <span class="literal">null</span>;</span><br><span class="line">		<span class="keyword">for</span> (<span class="type">Node</span> <span class="variable">t</span> <span class="operator">=</span> tail; t != <span class="literal">null</span> &amp;&amp; t != node; t = t.prev)</span><br><span class="line">			<span class="keyword">if</span> (t.waitStatus &lt;= <span class="number">0</span>)</span><br><span class="line">				s = t;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (s != <span class="literal">null</span>)</span><br><span class="line">		LockSupport.unpark(s.thread);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>å…ˆå°è¯•è·å–è§£é”çº¿ç¨‹çš„åŒæ­¥çŠ¶æ€ï¼Œå¦‚æœè·å–åŒæ­¥çŠ¶æ€ä¸æˆåŠŸï¼Œåˆ™ç»“æŸæ–¹æ³•ï¼Œç›´æ¥è¿”å›ã€‚</li>
<li>å¦‚æœè·å–åŒæ­¥çŠ¶æ€æˆåŠŸä¸”é˜Ÿåˆ—ä¸ä¸ºç©ºï¼ŒAQS ä¼šå°è¯•å”¤é†’ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ä¸­çš„çº¿ç¨‹ã€‚</li>
</ol>
<h4 id="è·å–å¯ä¸­æ–­çš„ç‹¬å é”"><a href="#è·å–å¯ä¸­æ–­çš„ç‹¬å é”" class="headerlink" title="è·å–å¯ä¸­æ–­çš„ç‹¬å é”"></a>è·å–å¯ä¸­æ–­çš„ç‹¬å é”</h4><p>AQS ä¸­ä½¿ç”¨ <code>acquireInterruptibly(int arg)</code> æ–¹æ³•è·å–å¯ä¸­æ–­çš„ç‹¬å é”ã€‚</p>
<p><code>acquireInterruptibly(int arg)</code> å®ç°æ–¹å¼ <strong>ç›¸è¾ƒäºè·å–ç‹¬å é”æ–¹æ³•ï¼ˆ <code>acquire</code>ï¼‰éå¸¸ç›¸ä¼¼</strong>ï¼ŒåŒºåˆ«ä»…åœ¨äºå®ƒä¼š <strong>é€šè¿‡ <code>Thread.interrupted</code> æ£€æµ‹å½“å‰çº¿ç¨‹æ˜¯å¦è¢«ä¸­æ–­</strong>ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™ç«‹å³æŠ›å‡ºä¸­æ–­å¼‚å¸¸ï¼ˆ<code>InterruptedException</code>ï¼‰ã€‚</p>
<h4 id="é™æ—¶è·å–ç‹¬å é”"><a href="#é™æ—¶è·å–ç‹¬å é”" class="headerlink" title="é™æ—¶è·å–ç‹¬å é”"></a>é™æ—¶è·å–ç‹¬å é”</h4><p>AQS ä¸­ä½¿ç”¨ <code>tryAcquireNanos(int arg)</code> æ–¹æ³•è·å–è¶…æ—¶ç­‰å¾…çš„ç‹¬å é”ã€‚</p>
<p>doAcquireNanos çš„å®ç°æ–¹å¼ <strong>ç›¸è¾ƒäºè·å–ç‹¬å é”æ–¹æ³•ï¼ˆ <code>acquire</code>ï¼‰éå¸¸ç›¸ä¼¼</strong>ï¼ŒåŒºåˆ«åœ¨äºå®ƒä¼šæ ¹æ®è¶…æ—¶æ—¶é—´å’Œå½“å‰æ—¶é—´è®¡ç®—å‡ºæˆªæ­¢æ—¶é—´ã€‚åœ¨è·å–é”çš„æµç¨‹ä¸­ï¼Œä¼šä¸æ–­åˆ¤æ–­æ˜¯å¦è¶…æ—¶ï¼Œå¦‚æœè¶…æ—¶ï¼Œç›´æ¥è¿”å› falseï¼›å¦‚æœæ²¡è¶…æ—¶ï¼Œåˆ™ç”¨ <code>LockSupport.parkNanos</code> æ¥é˜»å¡å½“å‰çº¿ç¨‹ã€‚</p>
<h3 id="å…±äº«é”çš„è·å–å’Œé‡Šæ”¾"><a href="#å…±äº«é”çš„è·å–å’Œé‡Šæ”¾" class="headerlink" title="å…±äº«é”çš„è·å–å’Œé‡Šæ”¾"></a>å…±äº«é”çš„è·å–å’Œé‡Šæ”¾</h3><p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/202409120732865.png"></p>
<h4 id="è·å–å…±äº«é”"><a href="#è·å–å…±äº«é”" class="headerlink" title="è·å–å…±äº«é”"></a>è·å–å…±äº«é”</h4><p>AQS ä¸­ä½¿ç”¨ <code>acquireShared(int arg)</code> æ–¹æ³•è·å–å…±äº«é”ã€‚</p>
<p><code>acquireShared</code> æ–¹æ³•å’Œ <code>acquire</code> æ–¹æ³•çš„é€»è¾‘å¾ˆç›¸ä¼¼ï¼ŒåŒºåˆ«ä»…åœ¨äºè‡ªæ—‹çš„æ¡ä»¶ä»¥åŠèŠ‚ç‚¹å‡ºé˜Ÿçš„æ“ä½œæœ‰æ‰€ä¸åŒã€‚</p>
<p>æˆåŠŸè·å¾—å…±äº«é”çš„æ¡ä»¶å¦‚ä¸‹ï¼š</p>
<ul>
<li><code>tryAcquireShared(arg)</code> è¿”å›å€¼å¤§äºç­‰äº 0 ï¼ˆè¿™æ„å‘³ç€å…±äº«é”çš„ permit è¿˜æ²¡æœ‰ç”¨å®Œï¼‰ã€‚</li>
<li>å½“å‰èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹æ˜¯å¤´ç»“ç‚¹ã€‚</li>
</ul>
<h4 id="é‡Šæ”¾å…±äº«é”"><a href="#é‡Šæ”¾å…±äº«é”" class="headerlink" title="é‡Šæ”¾å…±äº«é”"></a>é‡Šæ”¾å…±äº«é”</h4><p>AQS ä¸­ä½¿ç”¨ <code>releaseShared(int arg)</code> æ–¹æ³•é‡Šæ”¾å…±äº«é”ã€‚</p>
<p><code>releaseShared</code> é¦–å…ˆä¼šå°è¯•é‡Šæ”¾åŒæ­¥çŠ¶æ€ï¼Œå¦‚æœæˆåŠŸï¼Œåˆ™è§£é”ä¸€ä¸ªæˆ–å¤šä¸ªåç»§çº¿ç¨‹èŠ‚ç‚¹ã€‚é‡Šæ”¾å…±äº«é”å’Œé‡Šæ”¾ç‹¬å é”æµç¨‹å¤§ä½“ç›¸ä¼¼ï¼ŒåŒºåˆ«åœ¨äºï¼š</p>
<p>å¯¹äºç‹¬å æ¨¡å¼ï¼Œå¦‚æœéœ€è¦ SIGNALï¼Œé‡Šæ”¾ä»…ç›¸å½“äºè°ƒç”¨å¤´èŠ‚ç‚¹çš„ <code>unparkSuccessor</code>ã€‚</p>
<h4 id="è·å–å¯ä¸­æ–­çš„å…±äº«é”"><a href="#è·å–å¯ä¸­æ–­çš„å…±äº«é”" class="headerlink" title="è·å–å¯ä¸­æ–­çš„å…±äº«é”"></a>è·å–å¯ä¸­æ–­çš„å…±äº«é”</h4><p>AQS ä¸­ä½¿ç”¨ <code>acquireSharedInterruptibly(int arg)</code> æ–¹æ³•è·å–å¯ä¸­æ–­çš„å…±äº«é”ã€‚</p>
<p><code>acquireSharedInterruptibly</code> æ–¹æ³•ä¸ <code>acquireInterruptibly</code> å‡ ä¹ä¸€è‡´ï¼Œä¸å†èµ˜è¿°ã€‚</p>
<h4 id="é™æ—¶è·å–å…±äº«é”"><a href="#é™æ—¶è·å–å…±äº«é”" class="headerlink" title="é™æ—¶è·å–å…±äº«é”"></a>é™æ—¶è·å–å…±äº«é”</h4><p>AQS ä¸­ä½¿ç”¨ <code>tryAcquireSharedNanos(int arg)</code> æ–¹æ³•è·å–è¶…æ—¶ç­‰å¾…å¼çš„å…±äº«é”ã€‚</p>
<p><code>tryAcquireSharedNanos</code> æ–¹æ³•ä¸ <code>tryAcquireNanos</code> å‡ ä¹ä¸€è‡´ï¼Œä¸å†èµ˜è¿°ã€‚</p>
<h2 id="è‡ªå®šä¹‰åŒæ­¥å™¨"><a href="#è‡ªå®šä¹‰åŒæ­¥å™¨" class="headerlink" title="è‡ªå®šä¹‰åŒæ­¥å™¨"></a>è‡ªå®šä¹‰åŒæ­¥å™¨</h2><p>åŒæ­¥å™¨çš„è®¾è®¡æ˜¯åŸºäºæ¨¡æ¿æ–¹æ³•æ¨¡å¼çš„ï¼Œå¦‚æœéœ€è¦è‡ªå®šä¹‰åŒæ­¥å™¨ä¸€èˆ¬çš„æ–¹å¼æ˜¯è¿™æ ·ï¼ˆæ¨¡æ¿æ–¹æ³•æ¨¡å¼å¾ˆç»å…¸çš„ä¸€ä¸ªåº”ç”¨ï¼‰ï¼š</p>
<ol>
<li>ä½¿ç”¨è€…ç»§æ‰¿ <code>AbstractQueuedSynchronizer</code> å¹¶é‡å†™æŒ‡å®šçš„æ–¹æ³•ã€‚</li>
<li>å°† AQS ç»„åˆåœ¨è‡ªå®šä¹‰åŒæ­¥ç»„ä»¶çš„å®ç°ä¸­ï¼Œå¹¶è°ƒç”¨å…¶æ¨¡æ¿æ–¹æ³•ï¼Œè€Œè¿™äº›æ¨¡æ¿æ–¹æ³•ä¼šè°ƒç”¨ä½¿ç”¨è€…é‡å†™çš„æ–¹æ³•ã€‚</li>
</ol>
<p>è¿™å’Œæˆ‘ä»¬ä»¥å¾€é€šè¿‡å®ç°æ¥å£çš„æ–¹å¼æœ‰å¾ˆå¤§åŒºåˆ«ï¼Œè¿™æ˜¯æ¨¡æ¿æ–¹æ³•æ¨¡å¼å¾ˆç»å…¸çš„ä¸€ä¸ªè¿ç”¨ã€‚</p>
<p><strong>AQS ä½¿ç”¨äº†æ¨¡æ¿æ–¹æ³•æ¨¡å¼ï¼Œè‡ªå®šä¹‰åŒæ­¥å™¨æ—¶éœ€è¦é‡å†™ä¸‹é¢å‡ ä¸ª AQS æä¾›çš„é’©å­æ–¹æ³•ï¼š</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç‹¬å æ–¹å¼ã€‚å°è¯•è·å–èµ„æºï¼ŒæˆåŠŸåˆ™è¿”å› trueï¼Œå¤±è´¥åˆ™è¿”å› falseã€‚</span></span><br><span class="line"><span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">tryAcquire</span><span class="params">(<span class="type">int</span>)</span></span><br><span class="line"><span class="comment">// ç‹¬å æ–¹å¼ã€‚å°è¯•é‡Šæ”¾èµ„æºï¼ŒæˆåŠŸåˆ™è¿”å› trueï¼Œå¤±è´¥åˆ™è¿”å› falseã€‚</span></span><br><span class="line"><span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">tryRelease</span><span class="params">(<span class="type">int</span>)</span></span><br><span class="line"><span class="comment">// å…±äº«æ–¹å¼ã€‚å°è¯•è·å–èµ„æºã€‚è´Ÿæ•°è¡¨ç¤ºå¤±è´¥ï¼›0 è¡¨ç¤ºæˆåŠŸï¼Œä½†æ²¡æœ‰å‰©ä½™å¯ç”¨èµ„æºï¼›æ­£æ•°è¡¨ç¤ºæˆåŠŸï¼Œä¸”æœ‰å‰©ä½™èµ„æºã€‚</span></span><br><span class="line"><span class="keyword">protected</span> <span class="type">int</span> <span class="title function_">tryAcquireShared</span><span class="params">(<span class="type">int</span>)</span></span><br><span class="line"><span class="comment">// å…±äº«æ–¹å¼ã€‚å°è¯•é‡Šæ”¾èµ„æºï¼ŒæˆåŠŸåˆ™è¿”å› trueï¼Œå¤±è´¥åˆ™è¿”å› falseã€‚</span></span><br><span class="line"><span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">tryReleaseShared</span><span class="params">(<span class="type">int</span>)</span></span><br><span class="line"><span class="comment">// è¯¥çº¿ç¨‹æ˜¯å¦æ­£åœ¨ç‹¬å èµ„æºã€‚åªæœ‰ç”¨åˆ° condition æ‰éœ€è¦å»å®ç°å®ƒã€‚</span></span><br><span class="line"><span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">isHeldExclusively</span><span class="params">()</span></span><br></pre></td></tr></table></figure>

<p><strong>ä»€ä¹ˆæ˜¯é’©å­æ–¹æ³•å‘¢ï¼Ÿ</strong> é’©å­æ–¹æ³•æ˜¯ä¸€ç§è¢«å£°æ˜åœ¨æŠ½è±¡ç±»ä¸­çš„æ–¹æ³•ï¼Œä¸€èˆ¬ä½¿ç”¨ <code>protected</code> å…³é”®å­—ä¿®é¥°ï¼Œå®ƒå¯ä»¥æ˜¯ç©ºæ–¹æ³•ï¼ˆç”±å­ç±»å®ç°ï¼‰ï¼Œä¹Ÿå¯ä»¥æ˜¯é»˜è®¤å®ç°çš„æ–¹æ³•ã€‚æ¨¡æ¿è®¾è®¡æ¨¡å¼é€šè¿‡é’©å­æ–¹æ³•æ§åˆ¶å›ºå®šæ­¥éª¤çš„å®ç°ã€‚</p>
<h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ul>
<li><a target="_blank" rel="noopener" href="https://book.douban.com/subject/10484692/">ã€ŠJava å¹¶å‘ç¼–ç¨‹å®æˆ˜ã€‹</a></li>
<li><a target="_blank" rel="noopener" href="https://book.douban.com/subject/26591326/">ã€ŠJava å¹¶å‘ç¼–ç¨‹çš„è‰ºæœ¯ã€‹</a></li>
<li><a target="_blank" rel="noopener" href="https://time.geekbang.org/column/intro/100023901">æå®¢æ—¶é—´æ•™ç¨‹ - Java å¹¶å‘ç¼–ç¨‹å®æˆ˜</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/dolphin0520/p/3923167.html">Java å¹¶å‘ç¼–ç¨‹ï¼šLock</a></li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/27134110">æ·±å…¥å­¦ä¹  java åŒæ­¥å™¨ AQS</a></li>
<li><a target="_blank" rel="noopener" href="https://t.hao0.me/java/2016/04/01/aqs.html">AbstractQueuedSynchronizer æ¡†æ¶</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/qifengshi/p/6831055.html">Java ä¸­çš„é”åˆ†ç±»</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://dunwu.github.io/blog/pages/2eb6fa01/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/uploads/avatar.gif">
      <meta itemprop="name" content="é’æ‚Ÿ â—¾ Dunwu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dunwu Blog">
      <meta itemprop="description" content="é’æ‚Ÿçš„ä¸ªäººåšå®¢">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Dunwu Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/pages/2eb6fa01/" class="post-title-link" itemprop="url">Java å¹¶å‘ä¹‹é”</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2019-12-26 23:11:52" itemprop="dateCreated datePublished" datetime="2019-12-26T23:11:52+08:00">2019-12-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">æ›´æ–°äº</span>
      <time title="ä¿®æ”¹æ—¶é—´ï¼š2025-09-13 17:56:53" itemprop="dateModified" datetime="2025-09-13T17:56:53+08:00">2025-09-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
        </span>
          ï¼Œ
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/JavaCore/" itemprop="url" rel="index"><span itemprop="name">JavaCore</span></a>
        </span>
          ï¼Œ
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/JavaCore/%E5%B9%B6%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">å¹¶å‘</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
      <span>25k</span>
    </span>
    <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
      <span>22 åˆ†é’Ÿ</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Java-å¹¶å‘ä¹‹é”"><a href="#Java-å¹¶å‘ä¹‹é”" class="headerlink" title="Java å¹¶å‘ä¹‹é”"></a>Java å¹¶å‘ä¹‹é”</h1><blockquote>
<p>æœ¬æ–‡å…ˆé˜è¿° Java ä¸­å„ç§é”çš„æ¦‚å¿µã€‚</p>
<p>ç„¶åï¼Œé‡ç‚¹ä»‹ç» Lock å’Œ Condition ä¸¤ä¸ªæ¥å£åŠå…¶å®ç°ã€‚å¹¶å‘ç¼–ç¨‹æœ‰ä¸¤ä¸ªæ ¸å¿ƒé—®é¢˜ï¼šåŒæ­¥å’Œäº’æ–¥ã€‚</p>
<p><strong>äº’æ–¥</strong>ï¼Œå³åŒä¸€æ—¶åˆ»åªå…è®¸ä¸€ä¸ªçº¿ç¨‹è®¿é—®å…±äº«èµ„æºï¼›</p>
<p><strong>åŒæ­¥</strong>ï¼Œå³çº¿ç¨‹ä¹‹é—´å¦‚ä½•é€šä¿¡ã€åä½œã€‚</p>
<p>è¿™ä¸¤å¤§é—®é¢˜ï¼Œç®¡ç¨‹ï¼ˆ<code>sychronized</code>ï¼‰éƒ½æ˜¯èƒ½å¤Ÿè§£å†³çš„ã€‚<strong>J.U.C åŒ…è¿˜æä¾›äº† Lock å’Œ Condition ä¸¤ä¸ªæ¥å£æ¥å®ç°ç®¡ç¨‹ï¼Œå…¶ä¸­ Lock ç”¨äºè§£å†³äº’æ–¥é—®é¢˜ï¼ŒCondition ç”¨äºè§£å†³åŒæ­¥é—®é¢˜</strong>ã€‚</p>
</blockquote>
<h2 id="å¹¶å‘é”ç®€ä»‹"><a href="#å¹¶å‘é”ç®€ä»‹" class="headerlink" title="å¹¶å‘é”ç®€ä»‹"></a>å¹¶å‘é”ç®€ä»‹</h2><p>ç¡®ä¿çº¿ç¨‹å®‰å…¨æœ€å¸¸è§çš„åšæ³•æ˜¯åˆ©ç”¨é”æœºåˆ¶ï¼ˆ<code>Lock</code>ã€<code>sychronized</code>ï¼‰æ¥å¯¹å…±äº«æ•°æ®åšäº’æ–¥åŒæ­¥ï¼Œè¿™æ ·åœ¨åŒä¸€ä¸ªæ—¶åˆ»ï¼Œåªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥æ‰§è¡ŒæŸä¸ªæ–¹æ³•æˆ–è€…æŸä¸ªä»£ç å—ï¼Œé‚£ä¹ˆæ“ä½œå¿…ç„¶æ˜¯åŸå­æ€§çš„ï¼Œçº¿ç¨‹å®‰å…¨çš„ã€‚</p>
<p>åœ¨å·¥ä½œã€é¢è¯•ä¸­ï¼Œç»å¸¸ä¼šå¬åˆ°å„ç§äº”èŠ±å…«é—¨çš„é”ï¼Œå¬çš„äººäº‘é‡Œé›¾é‡Œã€‚é”çš„æ¦‚å¿µæœ¯è¯­å¾ˆå¤šï¼Œå®ƒä»¬æ˜¯é’ˆå¯¹ä¸åŒçš„é—®é¢˜æ‰€æå‡ºçš„ï¼Œé€šè¿‡ç®€å•çš„æ¢³ç†ï¼Œä¹Ÿä¸éš¾ç†è§£ã€‚</p>
<h3 id="å¯é‡å…¥é”"><a href="#å¯é‡å…¥é”" class="headerlink" title="å¯é‡å…¥é”"></a>å¯é‡å…¥é”</h3><p><strong>å¯é‡å…¥é”ï¼Œé¡¾åæ€ä¹‰ï¼ŒæŒ‡çš„æ˜¯çº¿ç¨‹å¯ä»¥é‡å¤è·å–åŒä¸€æŠŠé”</strong>ã€‚å³åŒä¸€ä¸ªçº¿ç¨‹åœ¨å¤–å±‚æ–¹æ³•è·å–äº†é”ï¼Œåœ¨è¿›å…¥å†…å±‚æ–¹æ³•ä¼šè‡ªåŠ¨è·å–é”ã€‚</p>
<p><strong>å¯é‡å…¥é”å¯ä»¥åœ¨ä¸€å®šç¨‹åº¦ä¸Šé¿å…æ­»é”</strong>ã€‚</p>
<ul>
<li><strong><code>ReentrantLock</code> ã€<code>ReentrantReadWriteLock</code> æ˜¯å¯é‡å…¥é”</strong>ã€‚è¿™ç‚¹ï¼Œä»å…¶å‘½åä¹Ÿä¸éš¾çœ‹å‡ºã€‚</li>
<li><strong><code>synchronized</code> ä¹Ÿæ˜¯ä¸€ä¸ªå¯é‡å…¥é”</strong>ã€‚</li>
</ul>
<p>ã€ç¤ºä¾‹ã€‘<code>synchronized</code> çš„å¯é‡å…¥ç¤ºä¾‹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">setA</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">    Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">    setB();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">setB</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">    Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸Šé¢çš„ä»£ç å°±æ˜¯ä¸€ä¸ªå…¸å‹åœºæ™¯ï¼šå¦‚æœä½¿ç”¨çš„é”ä¸æ˜¯å¯é‡å…¥é”çš„è¯ï¼Œ<code>setB</code> å¯èƒ½ä¸ä¼šè¢«å½“å‰çº¿ç¨‹æ‰§è¡Œï¼Œä»è€Œé€ æˆæ­»é”ã€‚</p>
<p>ã€ç¤ºä¾‹ã€‘<code>ReentrantLock</code> çš„å¯é‡å…¥ç¤ºä¾‹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Task</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> value;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Lock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Task</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.value = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">get</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// è·å–é”</span></span><br><span class="line">        lock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> value;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// ä¿è¯é”èƒ½é‡Šæ”¾</span></span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addOne</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// è·å–é”</span></span><br><span class="line">        lock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// æ³¨æ„ï¼šæ­¤å¤„å·²ç»æˆåŠŸè·å–é”ï¼Œè¿›å…¥ get æ–¹æ³•åï¼Œåˆå°è¯•è·å–é”ï¼Œ</span></span><br><span class="line">            <span class="comment">// å¦‚æœé”ä¸æ˜¯å¯é‡å…¥çš„ï¼Œä¼šå¯¼è‡´æ­»é”</span></span><br><span class="line">            value = <span class="number">1</span> + get();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// ä¿è¯é”èƒ½é‡Šæ”¾</span></span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="å…¬å¹³é”ä¸éå…¬å¹³é”"><a href="#å…¬å¹³é”ä¸éå…¬å¹³é”" class="headerlink" title="å…¬å¹³é”ä¸éå…¬å¹³é”"></a>å…¬å¹³é”ä¸éå…¬å¹³é”</h3><ul>
<li><strong>å…¬å¹³é”</strong> - å…¬å¹³é”æ˜¯æŒ‡ <strong>å¤šçº¿ç¨‹æŒ‰ç…§ç”³è¯·é”çš„é¡ºåºæ¥è·å–é”</strong>ã€‚</li>
<li><strong>éå…¬å¹³é”</strong> - éå…¬å¹³é”æ˜¯æŒ‡ <strong>å¤šçº¿ç¨‹ä¸æŒ‰ç…§ç”³è¯·é”çš„é¡ºåºæ¥è·å–é”</strong> ã€‚è¿™å°±å¯èƒ½ä¼šå‡ºç°ä¼˜å…ˆçº§åè½¬ï¼ˆåæ¥è€…å±…ä¸Šï¼‰æˆ–è€…é¥¥é¥¿ç°è±¡ï¼ˆæŸçº¿ç¨‹æ€»æ˜¯æŠ¢ä¸è¿‡åˆ«çš„çº¿ç¨‹ï¼Œå¯¼è‡´å§‹ç»ˆæ— æ³•æ‰§è¡Œï¼‰ã€‚</li>
</ul>
<p>å…¬å¹³é”ä¸ºäº†ä¿è¯çº¿ç¨‹ç”³è¯·é¡ºåºï¼ŒåŠ¿å¿…è¦ä»˜å‡ºä¸€å®šçš„æ€§èƒ½ä»£ä»·ï¼Œå› æ­¤å…¶ååé‡ä¸€èˆ¬ä½äºéå…¬å¹³é”ã€‚</p>
<p>å…¬å¹³é”ä¸éå…¬å¹³é” åœ¨ Java ä¸­çš„å…¸å‹å®ç°ï¼š</p>
<ul>
<li><strong><code>synchronized</code> åªæ”¯æŒéå…¬å¹³é”</strong>ã€‚</li>
<li><strong><code>ReentrantLock</code> ã€<code>ReentrantReadWriteLock</code>ï¼Œé»˜è®¤æ˜¯éå…¬å¹³é”ï¼Œä½†æ”¯æŒå…¬å¹³é”</strong>ã€‚</li>
</ul>
<h3 id="ç‹¬å é”ä¸å…±äº«é”"><a href="#ç‹¬å é”ä¸å…±äº«é”" class="headerlink" title="ç‹¬å é”ä¸å…±äº«é”"></a>ç‹¬å é”ä¸å…±äº«é”</h3><p>ç‹¬å é”ä¸å…±äº«é”æ˜¯ä¸€ç§å¹¿ä¹‰ä¸Šçš„è¯´æ³•ï¼Œä»å®é™…ç”¨é€”ä¸Šæ¥çœ‹ï¼Œä¹Ÿå¸¸è¢«ç§°ä¸ºäº’æ–¥é”ä¸è¯»å†™é”ã€‚</p>
<ul>
<li><strong>ç‹¬å é”</strong> - ç‹¬å é”æ˜¯æŒ‡ <strong>é”ä¸€æ¬¡åªèƒ½è¢«ä¸€ä¸ªçº¿ç¨‹æ‰€æŒæœ‰</strong>ã€‚</li>
<li><strong>å…±äº«é”</strong> - å…±äº«é”æ˜¯æŒ‡ <strong>é”å¯è¢«å¤šä¸ªçº¿ç¨‹æ‰€æŒæœ‰</strong>ã€‚</li>
</ul>
<p>ç‹¬å é”ä¸å…±äº«é”åœ¨ Java ä¸­çš„å…¸å‹å®ç°ï¼š</p>
<ul>
<li><strong><code>synchronized</code> ã€<code>ReentrantLock</code> åªæ”¯æŒç‹¬å é”</strong>ã€‚</li>
<li><strong><code>ReentrantReadWriteLock</code> å…¶å†™é”æ˜¯ç‹¬å é”ï¼Œå…¶è¯»é”æ˜¯å…±äº«é”</strong>ã€‚è¯»é”æ˜¯å…±äº«é”ä½¿å¾—å¹¶å‘è¯»æ˜¯éå¸¸é«˜æ•ˆçš„ï¼Œè¯»å†™ï¼Œå†™è¯» ï¼Œå†™å†™çš„è¿‡ç¨‹æ˜¯äº’æ–¥çš„ã€‚</li>
</ul>
<h3 id="æ‚²è§‚é”ä¸ä¹è§‚é”"><a href="#æ‚²è§‚é”ä¸ä¹è§‚é”" class="headerlink" title="æ‚²è§‚é”ä¸ä¹è§‚é”"></a>æ‚²è§‚é”ä¸ä¹è§‚é”</h3><p>ä¹è§‚é”ä¸æ‚²è§‚é”ä¸æ˜¯æŒ‡å…·ä½“çš„ä»€ä¹ˆç±»å‹çš„é”ï¼Œè€Œæ˜¯<strong>å¤„ç†å¹¶å‘åŒæ­¥çš„ç­–ç•¥</strong>ã€‚</p>
<h4 id="æ‚²è§‚é”ï¼ˆPessimistic-Lockï¼‰"><a href="#æ‚²è§‚é”ï¼ˆPessimistic-Lockï¼‰" class="headerlink" title="æ‚²è§‚é”ï¼ˆPessimistic Lockï¼‰"></a>æ‚²è§‚é”ï¼ˆPessimistic Lockï¼‰</h4><ul>
<li>æ€»æ˜¯å‡è®¾æœ€åçš„æƒ…å†µï¼Œè®¤ä¸ºï¼š<strong>ä¸åŠ é”çš„å¹¶å‘æ“ä½œä¸€å®šä¼šå‡ºé—®é¢˜</strong>ã€‚</li>
<li>æ‚²è§‚é”åœ¨ Java ä¸­çš„åº”ç”¨å°±æ˜¯é€šè¿‡ä½¿ç”¨ <code>synchronized</code> å’Œ <code>Lock</code> æ˜¾ç¤ºåŠ é”æ¥è¿›è¡Œäº’æ–¥åŒæ­¥ï¼Œè¿™æ˜¯ä¸€ç§é˜»å¡åŒæ­¥ã€‚</li>
<li><strong>æ‚²è§‚é”é€‚åˆå†™æ“ä½œé¢‘ç¹çš„åœºæ™¯</strong>ã€‚é«˜å¹¶å‘çš„åœºæ™¯ä¸‹ï¼Œæ¿€çƒˆçš„é”ç«äº‰ä¼šé€ æˆçº¿ç¨‹é˜»å¡ï¼Œå¤§é‡é˜»å¡çº¿ç¨‹ä¼šå¯¼è‡´ç³»ç»Ÿçš„ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œå¢åŠ ç³»ç»Ÿçš„æ€§èƒ½å¼€é”€ã€‚å¹¶ä¸”ï¼Œæ‚²è§‚é”è¿˜å¯èƒ½ä¼šå­˜åœ¨æ­»é”é—®é¢˜ï¼Œå½±å“ä»£ç çš„æ­£å¸¸è¿è¡Œã€‚</li>
</ul>
<p>ã€ç¤ºä¾‹ã€‘æ‚²è§‚é”ç¤ºä¾‹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">syncTask</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">        <span class="comment">// éœ€è¦åŒæ­¥çš„æ“ä½œ</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="type">Lock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();</span><br><span class="line">lock.lock();</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">   <span class="comment">// éœ€è¦åŒæ­¥çš„æ“ä½œ</span></span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    lock.unlock();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="ä¹è§‚é”ï¼ˆOptimisticLockï¼‰"><a href="#ä¹è§‚é”ï¼ˆOptimisticLockï¼‰" class="headerlink" title="ä¹è§‚é”ï¼ˆOptimisticLockï¼‰"></a>ä¹è§‚é”ï¼ˆOptimisticLockï¼‰</h4><ul>
<li>ä¹è§‚é”æ€»æ˜¯å‡è®¾æœ€å¥½çš„æƒ…å†µï¼Œè®¤ä¸ºï¼š<strong>ä¸åŠ é”çš„å¹¶å‘æ“ä½œä¹Ÿæ²¡ä»€ä¹ˆé—®é¢˜</strong>ã€‚æ¯æ¬¡è®¿é—®æ•°æ®æ—¶ï¼Œéƒ½å‡è®¾æ•°æ®ä¸ä¼šè¢«å…¶ä»–çº¿ç¨‹ä¿®æ”¹ï¼Œä¸å¿…åŠ é”ã€‚è™½ç„¶ä¸åŠ é”ï¼Œä½†ä¸æ„å‘³ç€ä»€ä¹ˆéƒ½ä¸åšï¼Œè€Œæ˜¯åœ¨æ›´æ–°çš„æ—¶å€™ï¼Œåˆ¤æ–­ä¸€ä¸‹åœ¨æ­¤æœŸé—´æ˜¯å¦æœ‰å…¶ä»–çº¿ç¨‹æ›´æ–°è¯¥æ•°æ®ã€‚</li>
<li>ä¹è§‚é”æœ€å¸¸è§çš„å®ç°æ–¹å¼ï¼Œæ˜¯ä½¿ç”¨ç‰ˆæœ¬å·æœºåˆ¶æˆ– CAS ç®—æ³•ï¼ˆCompare And Swapï¼‰å»å®ç°ã€‚Java ä¸­çš„åŸå­ç±»å°±æ˜¯åŸºäº CAS å®ç°çš„ã€‚</li>
<li>ä¹è§‚é”çš„<strong>ä¼˜ç‚¹</strong>æ˜¯ï¼šå‡å°‘é”ç«äº‰ï¼Œæé«˜å¹¶å‘åº¦ã€‚</li>
<li>ä¹è§‚é”çš„<strong>ç¼ºç‚¹</strong>æ˜¯ï¼š<ul>
<li><strong>å­˜åœ¨ ABA é—®é¢˜</strong>ã€‚æ‰€è°“çš„ ABA é—®é¢˜æ˜¯æŒ‡åœ¨å¹¶å‘ç¼–ç¨‹ä¸­ï¼Œå¦‚æœä¸€ä¸ªå˜é‡åˆæ¬¡è¯»å–çš„æ—¶å€™æ˜¯ A å€¼ï¼Œå®ƒçš„å€¼è¢«æ”¹æˆäº† Bï¼Œç„¶ååˆå…¶ä»–çº¿ç¨‹æŠŠ B å€¼æ”¹æˆäº† Aï¼Œè€Œå¦ä¸€ä¸ªæ—©æœŸçº¿ç¨‹åœ¨å¯¹æ¯”å€¼æ—¶ä¼šè¯¯ä»¥ä¸ºæ­¤å€¼æ²¡æœ‰å‘ç”Ÿæ”¹å˜ï¼Œä½†å…¶å®å·²ç»å‘ç”Ÿå˜åŒ–äº†</li>
<li>å¦‚æœä¹è§‚é”æ‰€æ£€æŸ¥çš„æ•°æ®å­˜åœ¨å¤§é‡é”ç«äº‰ï¼Œä¼šç”±äº<strong>ä¸æ–­å¾ªç¯é‡è¯•ï¼Œäº§ç”Ÿå¤§é‡çš„ CPU å¼€é”€</strong>ã€‚</li>
</ul>
</li>
<li><strong>ä¹è§‚é”é€‚åˆè¯»å¤šå†™å°‘çš„åœºæ™¯</strong>ã€‚é«˜å¹¶å‘çš„åœºæ™¯ä¸‹ï¼Œä¹è§‚é”ç›¸æ¯”æ‚²è§‚é”æ¥è¯´ï¼Œä¸å­˜åœ¨é”ç«äº‰é€ æˆçº¿ç¨‹é˜»å¡ï¼Œä¹Ÿä¸ä¼šæœ‰æ­»é”çš„é—®é¢˜ï¼Œåœ¨æ€§èƒ½ä¸Šå¾€å¾€ä¼šæ›´èƒœä¸€ç­¹ã€‚ä½†æ˜¯ï¼Œå¦‚æœå†²çªé¢‘ç¹å‘ç”Ÿï¼ˆå†™å æ¯”éå¸¸å¤šçš„æƒ…å†µï¼‰ï¼Œä¼šé¢‘ç¹å¤±è´¥å’Œé‡è¯•ï¼Œè¿™æ ·åŒæ ·ä¼šéå¸¸å½±å“æ€§èƒ½ï¼Œå¯¼è‡´ CPU é£™å‡ã€‚</li>
</ul>
<p>ã€ç¤ºä¾‹ã€‘ä¹è§‚é”ç¤ºä¾‹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AtomicInteger çš„ getAndAccumulate æ–¹æ³•é‡‡ç”¨äº†è‡ªæ—‹ + CAS çš„ä¹è§‚é”æ¨¡å¼</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">getAndAccumulate</span><span class="params">(<span class="type">int</span> x,</span></span><br><span class="line"><span class="params">	IntBinaryOperator accumulatorFunction)</span> &#123;</span><br><span class="line">	<span class="type">int</span> prev, next;</span><br><span class="line">	<span class="keyword">do</span> &#123;</span><br><span class="line">		prev = get();</span><br><span class="line">		next = accumulatorFunction.applyAsInt(prev, x);</span><br><span class="line">	&#125; <span class="keyword">while</span> (!compareAndSet(prev, next));</span><br><span class="line">	<span class="keyword">return</span> prev;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¹è§‚é”ä¹Ÿæ˜¯ä¸€ç§é€šç”¨çš„é”æœºåˆ¶ï¼Œä¸ä»…åœ¨ Java ä¸­ï¼Œåœ¨å…¶ä»–å¾ˆå¤šè½¯ä»¶é¢†åŸŸï¼Œä¹Ÿå­˜åœ¨ä¹è§‚é”æœºåˆ¶ã€‚æ¯”å¦‚ä¸‹é¢çš„ç¤ºä¾‹æ˜¯ MySQL ä¸­çš„ä¹è§‚é”ç¤ºä¾‹ã€‚</p>
<p>å‡è®¾ï¼Œorder è¡¨ä¸­æœ‰ä¸€ä¸ªå­—æ®µ statusï¼Œè¡¨ç¤ºè®¢å•çŠ¶æ€ï¼šstatus ä¸º 1 ä»£è¡¨è®¢å•æœªæ”¯ä»˜ï¼›status ä¸º 2 ä»£è¡¨è®¢å•å·²æ”¯ä»˜ã€‚ç°åœ¨ï¼Œè¦å°† id ä¸º 1 çš„è®¢å•çŠ¶æ€ç½®ä¸ºå·²æ”¯ä»˜ï¼Œåˆ™æ“ä½œå¦‚ä¸‹ï¼š</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> status, version <span class="keyword">from</span> <span class="keyword">order</span> <span class="keyword">where</span> id<span class="operator">=</span>#&#123;id&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">update</span> <span class="keyword">order</span></span><br><span class="line"><span class="keyword">set</span> status<span class="operator">=</span><span class="number">2</span>, version<span class="operator">=</span>version<span class="operator">+</span><span class="number">1</span></span><br><span class="line"><span class="keyword">where</span> id<span class="operator">=</span>#&#123;id&#125; <span class="keyword">and</span> version<span class="operator">=</span>#&#123;version&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="åå‘é”ã€è½»é‡çº§é”ã€é‡é‡çº§é”"><a href="#åå‘é”ã€è½»é‡çº§é”ã€é‡é‡çº§é”" class="headerlink" title="åå‘é”ã€è½»é‡çº§é”ã€é‡é‡çº§é”"></a>åå‘é”ã€è½»é‡çº§é”ã€é‡é‡çº§é”</h3><p>æ‰€è°“è½»é‡çº§é”ä¸é‡é‡çº§é”ï¼ŒæŒ‡çš„æ˜¯é”æ§åˆ¶ç²’åº¦çš„ç²—ç»†ã€‚æ˜¾ç„¶ï¼Œæ§åˆ¶ç²’åº¦è¶Šç»†ï¼Œé˜»å¡å¼€é”€è¶Šå°ï¼Œå¹¶å‘æ€§ä¹Ÿå°±è¶Šé«˜ã€‚</p>
<p>Java 1.6 ä»¥å‰ï¼Œé‡é‡çº§é”ä¸€èˆ¬æŒ‡çš„æ˜¯ <code>synchronized</code> ï¼Œè€Œè½»é‡çº§é”æŒ‡çš„æ˜¯ <code>volatile</code>ã€‚</p>
<p>Java 1.6 ä»¥åï¼Œé’ˆå¯¹ <code>synchronized</code> åšäº†å¤§é‡ä¼˜åŒ–ï¼Œå¼•å…¥ 4 ç§é”çŠ¶æ€ï¼š æ— é”çŠ¶æ€ã€åå‘é”ã€è½»é‡çº§é”å’Œé‡é‡çº§é”ã€‚é”å¯ä»¥å•å‘çš„ä»åå‘é”å‡çº§åˆ°è½»é‡çº§é”ï¼Œå†ä»è½»é‡çº§é”å‡çº§åˆ°é‡é‡çº§é” ã€‚</p>
<ul>
<li><strong>åå‘é”</strong> - åå‘é”æ˜¯æŒ‡ä¸€æ®µåŒæ­¥ä»£ç ä¸€ç›´è¢«ä¸€ä¸ªçº¿ç¨‹æ‰€è®¿é—®ï¼Œé‚£ä¹ˆè¯¥çº¿ç¨‹ä¼šè‡ªåŠ¨è·å–é”ã€‚é™ä½è·å–é”çš„ä»£ä»·ã€‚</li>
<li><strong>è½»é‡çº§é”</strong> - æ˜¯æŒ‡å½“é”æ˜¯åå‘é”çš„æ—¶å€™ï¼Œè¢«å¦ä¸€ä¸ªçº¿ç¨‹æ‰€è®¿é—®ï¼Œåå‘é”å°±ä¼šå‡çº§ä¸ºè½»é‡çº§é”ï¼Œå…¶ä»–çº¿ç¨‹ä¼šé€šè¿‡è‡ªæ—‹çš„å½¢å¼å°è¯•è·å–é”ï¼Œä¸ä¼šé˜»å¡ï¼Œæé«˜æ€§èƒ½ã€‚</li>
<li><strong>é‡é‡çº§é”</strong> - æ˜¯æŒ‡å½“é”ä¸ºè½»é‡çº§é”çš„æ—¶å€™ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹è™½ç„¶æ˜¯è‡ªæ—‹ï¼Œä½†è‡ªæ—‹ä¸ä¼šä¸€ç›´æŒç»­ä¸‹å»ï¼Œå½“è‡ªæ—‹ä¸€å®šæ¬¡æ•°çš„æ—¶å€™ï¼Œè¿˜æ²¡æœ‰è·å–åˆ°é”ï¼Œå°±ä¼šè¿›å…¥é˜»å¡ï¼Œè¯¥é”è†¨èƒ€ä¸ºé‡é‡çº§é”ã€‚é‡é‡çº§é”ä¼šè®©å…¶ä»–ç”³è¯·çš„çº¿ç¨‹è¿›å…¥é˜»å¡ï¼Œæ€§èƒ½é™ä½ã€‚</li>
</ul>
<h3 id="åˆ†æ®µé”"><a href="#åˆ†æ®µé”" class="headerlink" title="åˆ†æ®µé”"></a>åˆ†æ®µé”</h3><p>åˆ†æ®µé”å…¶å®æ˜¯ä¸€ç§é”çš„è®¾è®¡ï¼Œå¹¶ä¸æ˜¯å…·ä½“çš„ä¸€ç§é”ã€‚æ‰€è°“<strong>åˆ†æ®µé”ï¼Œå°±æ˜¯æŠŠé”çš„å¯¹è±¡åˆ†æˆå¤šæ®µï¼Œæ¯æ®µç‹¬ç«‹æ§åˆ¶ï¼Œä½¿å¾—é”ç²’åº¦æ›´ç»†ï¼Œå‡å°‘é˜»å¡å¼€é”€ï¼Œä»è€Œæé«˜å¹¶å‘æ€§</strong>ã€‚è¿™å…¶å®å¾ˆå¥½ç†è§£ï¼Œå°±åƒé«˜é€Ÿå…¬è·¯ä¸Šçš„æ”¶è´¹ç«™ï¼Œå¦‚æœåªæœ‰ä¸€ä¸ªæ”¶è´¹å£ï¼Œé‚£æ‰€æœ‰çš„è½¦åªèƒ½æ’æˆä¸€æ¡é˜Ÿç¼´è´¹ï¼›å¦‚æœæœ‰å¤šä¸ªæ”¶è´¹å£ï¼Œå°±å¯ä»¥åˆ†æµäº†ã€‚</p>
<p><code>Hashtable</code> ä½¿ç”¨ <code>synchronized</code> ä¿®é¥°æ–¹æ³•æ¥ä¿è¯çº¿ç¨‹å®‰å…¨æ€§ï¼Œé‚£ä¹ˆé¢å¯¹çº¿ç¨‹çš„è®¿é—®ï¼ŒHashtable å°±ä¼šé”ä½æ•´ä¸ªå¯¹è±¡ï¼Œæ‰€æœ‰çš„å…¶å®ƒçº¿ç¨‹åªèƒ½ç­‰å¾…ï¼Œè¿™ç§é˜»å¡æ–¹å¼çš„ååé‡æ˜¾ç„¶å¾ˆä½ã€‚</p>
<p>Java 1.7 ä»¥å‰çš„ <code>ConcurrentHashMap</code> å°±æ˜¯åˆ†æ®µé”çš„å…¸å‹æ¡ˆä¾‹ã€‚<code>ConcurrentHashMap</code> ç»´æŠ¤äº†ä¸€ä¸ª <code>Segment</code> æ•°ç»„ï¼Œä¸€èˆ¬ç§°ä¸ºåˆ†æ®µæ¡¶ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> Segment&lt;K,V&gt;[] segments;</span><br></pre></td></tr></table></figure>

<p>å½“æœ‰çº¿ç¨‹è®¿é—® <code>ConcurrentHashMap</code> çš„æ•°æ®æ—¶ï¼Œ<code>ConcurrentHashMap</code> ä¼šå…ˆæ ¹æ® hashCode è®¡ç®—å‡ºæ•°æ®åœ¨å“ªä¸ªæ¡¶ï¼ˆå³å“ªä¸ª Segmentï¼‰ï¼Œç„¶åé”ä½è¿™ä¸ª <code>Segment</code>ã€‚</p>
<h3 id="å†…ç½®é”å’Œæ˜¾ç¤ºé”"><a href="#å†…ç½®é”å’Œæ˜¾ç¤ºé”" class="headerlink" title="å†…ç½®é”å’Œæ˜¾ç¤ºé”"></a>å†…ç½®é”å’Œæ˜¾ç¤ºé”</h3><p>Java 1.5 ä¹‹å‰ï¼Œåè°ƒå¯¹å…±äº«å¯¹è±¡çš„è®¿é—®æ—¶å¯ä»¥ä½¿ç”¨çš„æœºåˆ¶åªæœ‰ <code>synchronized</code> å’Œ <code>volatile</code>ã€‚è¿™ä¸¤ä¸ªéƒ½å±äºå†…ç½®é”ï¼Œå³é”çš„ç”³è¯·å’Œé‡Šæ”¾éƒ½æ˜¯ç”± JVM æ‰€æ§åˆ¶ã€‚</p>
<p>Java 1.5 ä¹‹åï¼Œå¢åŠ äº†æ–°çš„æœºåˆ¶ï¼š<code>ReentrantLock</code>ã€<code>ReentrantReadWriteLock</code> ï¼Œè¿™ç±»é”çš„ç”³è¯·å’Œé‡Šæ”¾éƒ½å¯ä»¥ç”±ç¨‹åºæ‰€æ§åˆ¶ï¼Œæ‰€ä»¥å¸¸è¢«ç§°ä¸ºæ˜¾ç¤ºé”ã€‚</p>
<blockquote>
<p>ğŸ’¡ <code>synchronized</code> çš„ç”¨æ³•å’ŒåŸç†å¯ä»¥å‚è€ƒï¼š<a href="https://dunwu.github.io/waterdrop/pages/e98ae9d2/">Java å¹¶å‘ä¹‹å†…å­˜æ¨¡å‹</a> ã€‚</p>
<p>:bell: æ³¨æ„ï¼šå¦‚æœä¸éœ€è¦ <code>ReentrantLock</code>ã€<code>ReentrantReadWriteLock</code> æ‰€æä¾›çš„é«˜çº§åŒæ­¥ç‰¹æ€§ï¼Œ**åº”è¯¥ä¼˜å…ˆè€ƒè™‘ä½¿ç”¨ <code>synchronized</code>**ã€‚ç†ç”±å¦‚ä¸‹ï¼š</p>
<ul>
<li>Java 1.6 ä»¥åï¼Œ<code>synchronized</code> åšäº†å¤§é‡çš„ä¼˜åŒ–ï¼Œå…¶æ€§èƒ½å·²ç»ä¸ <code>ReentrantLock</code>ã€<code>ReentrantReadWriteLock</code> åŸºæœ¬ä¸ŠæŒå¹³ã€‚</li>
<li>ä»è¶‹åŠ¿æ¥çœ‹ï¼ŒJava æœªæ¥æ›´å¯èƒ½ä¼šä¼˜åŒ– <code>synchronized</code> ï¼Œè€Œä¸æ˜¯ <code>ReentrantLock</code>ã€<code>ReentrantReadWriteLock</code> ï¼Œå› ä¸º <code>synchronized</code> æ˜¯ JVM å†…ç½®å±æ€§ï¼Œå®ƒèƒ½æ‰§è¡Œä¸€äº›ä¼˜åŒ–ã€‚</li>
<li><code>ReentrantLock</code>ã€<code>ReentrantReadWriteLock</code> ç”³è¯·å’Œé‡Šæ”¾é”éƒ½æ˜¯ç”±ç¨‹åºæ§åˆ¶ï¼Œå¦‚æœä½¿ç”¨ä¸å½“ï¼Œå¯èƒ½é€ æˆæ­»é”ï¼Œè¿™æ˜¯å¾ˆå±é™©çš„ã€‚</li>
</ul>
</blockquote>
<p>ä»¥ä¸‹å¯¹æ¯”ä¸€ä¸‹æ˜¾ç¤ºé”å’Œå†…ç½®é”çš„å·®å¼‚ï¼š</p>
<ul>
<li><strong>ä¸»åŠ¨è·å–é”å’Œé‡Šæ”¾é”</strong><ul>
<li><code>synchronized</code> ä¸èƒ½ä¸»åŠ¨è·å–é”å’Œé‡Šæ”¾é”ã€‚è·å–é”å’Œé‡Šæ”¾é”éƒ½æ˜¯ JVM æ§åˆ¶çš„ã€‚</li>
<li><code>ReentrantLock</code> å¯ä»¥ä¸»åŠ¨è·å–é”å’Œé‡Šæ”¾é”ã€‚ï¼ˆå¦‚æœå¿˜è®°é‡Šæ”¾é”ï¼Œå°±å¯èƒ½äº§ç”Ÿæ­»é”ï¼‰ã€‚</li>
</ul>
</li>
<li><strong>å“åº”ä¸­æ–­</strong><ul>
<li><code>synchronized</code> ä¸èƒ½å“åº”ä¸­æ–­ã€‚</li>
<li><code>ReentrantLock</code> å¯ä»¥å“åº”ä¸­æ–­ã€‚</li>
</ul>
</li>
<li><strong>è¶…æ—¶æœºåˆ¶</strong><ul>
<li><code>synchronized</code> æ²¡æœ‰è¶…æ—¶æœºåˆ¶ã€‚</li>
<li><code>ReentrantLock</code> æœ‰è¶…æ—¶æœºåˆ¶ã€‚<code>ReentrantLock</code> å¯ä»¥è®¾ç½®è¶…æ—¶æ—¶é—´ï¼Œè¶…æ—¶åè‡ªåŠ¨é‡Šæ”¾é”ï¼Œé¿å…ä¸€ç›´ç­‰å¾…ã€‚</li>
</ul>
</li>
<li><strong>æ”¯æŒå…¬å¹³é”</strong><ul>
<li><code>synchronized</code> åªæ”¯æŒéå…¬å¹³é”ã€‚</li>
<li><code>ReentrantLock</code> æ”¯æŒéå…¬å¹³é”å’Œå…¬å¹³é”ã€‚</li>
</ul>
</li>
<li><strong>æ˜¯å¦æ”¯æŒå…±äº«</strong><ul>
<li>è¢« <code>synchronized</code> ä¿®é¥°çš„æ–¹æ³•æˆ–ä»£ç å—ï¼Œåªèƒ½è¢«ä¸€ä¸ªçº¿ç¨‹è®¿é—®ï¼ˆç‹¬äº«ï¼‰ã€‚å¦‚æœè¿™ä¸ªçº¿ç¨‹è¢«é˜»å¡ï¼Œå…¶ä»–çº¿ç¨‹ä¹Ÿåªèƒ½ç­‰å¾…</li>
<li><code>ReentrantLock</code> å¯ä»¥åŸºäº <code>Condition</code> çµæ´»çš„æ§åˆ¶åŒæ­¥æ¡ä»¶ã€‚</li>
</ul>
</li>
<li><strong>æ˜¯å¦æ”¯æŒè¯»å†™åˆ†ç¦»</strong><ul>
<li><code>synchronized</code> ä¸æ”¯æŒè¯»å†™é”åˆ†ç¦»ï¼›</li>
<li><code>ReentrantReadWriteLock</code> æ”¯æŒè¯»å†™é”ï¼Œä»è€Œä½¿é˜»å¡è¯»å†™çš„æ“ä½œåˆ†å¼€ï¼Œæœ‰æ•ˆæé«˜å¹¶å‘æ€§ã€‚</li>
</ul>
</li>
</ul>
<h2 id="Lock-å’Œ-Condition"><a href="#Lock-å’Œ-Condition" class="headerlink" title="Lock å’Œ Condition"></a>Lock å’Œ Condition</h2><h3 id="ä¸ºä½•å¼•å…¥-Lock-å’Œ-Condition"><a href="#ä¸ºä½•å¼•å…¥-Lock-å’Œ-Condition" class="headerlink" title="ä¸ºä½•å¼•å…¥ Lock å’Œ Condition"></a>ä¸ºä½•å¼•å…¥ Lock å’Œ Condition</h3><p>å¹¶å‘ç¼–ç¨‹é¢†åŸŸï¼Œæœ‰ä¸¤å¤§æ ¸å¿ƒé—®é¢˜ï¼šä¸€ä¸ªæ˜¯<strong>äº’æ–¥</strong>ï¼Œå³åŒä¸€æ—¶åˆ»åªå…è®¸ä¸€ä¸ªçº¿ç¨‹è®¿é—®å…±äº«èµ„æºï¼›å¦ä¸€ä¸ªæ˜¯<strong>åŒæ­¥</strong>ï¼Œå³çº¿ç¨‹ä¹‹é—´å¦‚ä½•é€šä¿¡ã€åä½œã€‚è¿™ä¸¤å¤§é—®é¢˜ï¼Œç®¡ç¨‹éƒ½æ˜¯èƒ½å¤Ÿè§£å†³çš„ã€‚<strong>Java SDK å¹¶å‘åŒ…é€šè¿‡ Lock å’Œ Condition ä¸¤ä¸ªæ¥å£æ¥å®ç°ç®¡ç¨‹ï¼Œå…¶ä¸­ Lock ç”¨äºè§£å†³äº’æ–¥é—®é¢˜ï¼ŒCondition ç”¨äºè§£å†³åŒæ­¥é—®é¢˜</strong>ã€‚</p>
<p>synchronized æ˜¯ç®¡ç¨‹çš„ä¸€ç§å®ç°ï¼Œæ—¢ç„¶å¦‚æ­¤ï¼Œä½•å¿…å†æä¾› Lock å’Œ Conditionã€‚</p>
<p>JDK 1.6 ä»¥å‰ï¼Œsynchronized è¿˜æ²¡æœ‰åšä¼˜åŒ–ï¼Œæ€§èƒ½è¿œä½äº Lockã€‚ä½†æ˜¯ï¼Œæ€§èƒ½ä¸æ˜¯å¼•å…¥ Lock çš„æœ€é‡è¦å› ç´ ã€‚çœŸæ­£å…³é”®åœ¨äºï¼šsynchronized ä½¿ç”¨ä¸å½“ï¼Œå¯èƒ½ä¼šå‡ºç°æ­»é”ã€‚synchronized æ— æ³•é€šè¿‡<strong>ç ´åä¸å¯æŠ¢å æ¡ä»¶</strong>æ¥é¿å…æ­»é”ã€‚åŸå› æ˜¯ synchronized ç”³è¯·èµ„æºçš„æ—¶å€™ï¼Œå¦‚æœç”³è¯·ä¸åˆ°ï¼Œçº¿ç¨‹ç›´æ¥è¿›å…¥é˜»å¡çŠ¶æ€äº†ï¼Œè€Œçº¿ç¨‹è¿›å…¥é˜»å¡çŠ¶æ€ï¼Œå•¥éƒ½å¹²ä¸äº†ï¼Œä¹Ÿé‡Šæ”¾ä¸äº†çº¿ç¨‹å·²ç»å æœ‰çš„èµ„æºã€‚</p>
<p>ä¸å†…ç½®é” <code>synchronized</code> ä¸åŒçš„æ˜¯ï¼Œ**<code>Lock</code> æä¾›äº†ä¸€ç»„æ— æ¡ä»¶çš„ã€å¯è½®è¯¢çš„ã€å®šæ—¶çš„ä»¥åŠå¯ä¸­æ–­çš„é”æ“ä½œ**ï¼Œæ‰€æœ‰è·å–é”ã€é‡Šæ”¾é”çš„æ“ä½œéƒ½æ˜¯æ˜¾å¼çš„æ“ä½œã€‚</p>
<ul>
<li><strong>èƒ½å¤Ÿå“åº”ä¸­æ–­</strong>ã€‚synchronized çš„é—®é¢˜æ˜¯ï¼ŒæŒæœ‰é” A åï¼Œå¦‚æœå°è¯•è·å–é” B å¤±è´¥ï¼Œé‚£ä¹ˆçº¿ç¨‹å°±è¿›å…¥é˜»å¡çŠ¶æ€ï¼Œä¸€æ—¦å‘ç”Ÿæ­»é”ï¼Œå°±æ²¡æœ‰ä»»ä½•æœºä¼šæ¥å”¤é†’é˜»å¡çš„çº¿ç¨‹ã€‚ä½†å¦‚æœé˜»å¡çŠ¶æ€çš„çº¿ç¨‹èƒ½å¤Ÿå“åº”ä¸­æ–­ä¿¡å·ï¼Œä¹Ÿå°±æ˜¯è¯´å½“æˆ‘ä»¬ç»™é˜»å¡çš„çº¿ç¨‹å‘é€ä¸­æ–­ä¿¡å·çš„æ—¶å€™ï¼Œèƒ½å¤Ÿå”¤é†’å®ƒï¼Œé‚£å®ƒå°±æœ‰æœºä¼šé‡Šæ”¾æ›¾ç»æŒæœ‰çš„é” Aã€‚è¿™æ ·å°±ç ´åäº†ä¸å¯æŠ¢å æ¡ä»¶äº†ã€‚</li>
<li><strong>æ”¯æŒè¶…æ—¶</strong>ã€‚å¦‚æœçº¿ç¨‹åœ¨ä¸€æ®µæ—¶é—´ä¹‹å†…æ²¡æœ‰è·å–åˆ°é”ï¼Œä¸æ˜¯è¿›å…¥é˜»å¡çŠ¶æ€ï¼Œè€Œæ˜¯è¿”å›ä¸€ä¸ªé”™è¯¯ï¼Œé‚£è¿™ä¸ªçº¿ç¨‹ä¹Ÿæœ‰æœºä¼šé‡Šæ”¾æ›¾ç»æŒæœ‰çš„é”ã€‚è¿™æ ·ä¹Ÿèƒ½ç ´åä¸å¯æŠ¢å æ¡ä»¶ã€‚</li>
<li><strong>éé˜»å¡åœ°è·å–é”</strong>ã€‚å¦‚æœå°è¯•è·å–é”å¤±è´¥ï¼Œå¹¶ä¸è¿›å…¥é˜»å¡çŠ¶æ€ï¼Œè€Œæ˜¯ç›´æ¥è¿”å›ï¼Œé‚£è¿™ä¸ªçº¿ç¨‹ä¹Ÿæœ‰æœºä¼šé‡Šæ”¾æ›¾ç»æŒæœ‰çš„é”ã€‚è¿™æ ·ä¹Ÿèƒ½ç ´åä¸å¯æŠ¢å æ¡ä»¶ã€‚</li>
</ul>
<h3 id="Lock-æ¥å£"><a href="#Lock-æ¥å£" class="headerlink" title="Lock æ¥å£"></a>Lock æ¥å£</h3><p><code>Lock</code> çš„æ¥å£å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Lock</span> &#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">lock</span><span class="params">()</span>;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">lockInterruptibly</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException;</span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">tryLock</span><span class="params">()</span>;</span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">tryLock</span><span class="params">(<span class="type">long</span> time, TimeUnit unit)</span> <span class="keyword">throws</span> InterruptedException;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">()</span>;</span><br><span class="line">    Condition <span class="title function_">newCondition</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>lock()</code> - è·å–é”ã€‚</li>
<li><code>unlock()</code> - é‡Šæ”¾é”ã€‚</li>
<li><code>tryLock()</code> - å°è¯•è·å–é”ï¼Œä»…åœ¨è°ƒç”¨æ—¶é”æœªè¢«å¦ä¸€ä¸ªçº¿ç¨‹æŒæœ‰çš„æƒ…å†µä¸‹ï¼Œæ‰è·å–è¯¥é”ã€‚</li>
<li><code>tryLock(long time, TimeUnit unit)</code> - å’Œ <code>tryLock()</code> ç±»ä¼¼ï¼ŒåŒºåˆ«ä»…åœ¨äºé™å®šæ—¶é—´ï¼Œå¦‚æœé™å®šæ—¶é—´å†…æœªè·å–åˆ°é”ï¼Œè§†ä¸ºå¤±è´¥ã€‚</li>
<li><code>lockInterruptibly()</code> - é”æœªè¢«å¦ä¸€ä¸ªçº¿ç¨‹æŒæœ‰ï¼Œä¸”çº¿ç¨‹æ²¡æœ‰è¢«ä¸­æ–­çš„æƒ…å†µä¸‹ï¼Œæ‰èƒ½è·å–é”ã€‚</li>
<li><code>newCondition()</code> - è¿”å›ä¸€ä¸ªç»‘å®šåˆ° <code>Lock</code> å¯¹è±¡ä¸Šçš„ <code>Condition</code> å®ä¾‹ã€‚</li>
</ul>
<h3 id="Condition"><a href="#Condition" class="headerlink" title="Condition"></a>Condition</h3><p><strong>Condition å®ç°äº†ç®¡ç¨‹æ¨¡å‹é‡Œé¢çš„æ¡ä»¶å˜é‡</strong>ã€‚</p>
<p>å‰æ–‡ä¸­æè¿‡ <code>Lock</code> æ¥å£ä¸­ æœ‰ä¸€ä¸ª <code>newCondition()</code> æ–¹æ³•ç”¨äºè¿”å›ä¸€ä¸ªç»‘å®šåˆ° <code>Lock</code> å¯¹è±¡ä¸Šçš„ <code>Condition</code> å®ä¾‹ã€‚<code>Condition</code> æ˜¯ä»€ä¹ˆï¼Ÿæœ‰ä»€ä¹ˆä½œç”¨ï¼Ÿæœ¬èŠ‚å°†ä¸€ä¸€è®²è§£ã€‚</p>
<p>åœ¨å•çº¿ç¨‹ä¸­ï¼Œä¸€æ®µä»£ç çš„æ‰§è¡Œå¯èƒ½ä¾èµ–äºæŸä¸ªçŠ¶æ€ï¼Œå¦‚æœä¸æ»¡è¶³çŠ¶æ€æ¡ä»¶ï¼Œä»£ç å°±ä¸ä¼šè¢«æ‰§è¡Œï¼ˆå…¸å‹çš„åœºæ™¯ï¼Œå¦‚ï¼š<code>if ... else ...</code>ï¼‰ã€‚åœ¨å¹¶å‘ç¯å¢ƒä¸­ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹åˆ¤æ–­æŸä¸ªçŠ¶æ€æ¡ä»¶æ—¶ï¼Œå…¶çŠ¶æ€å¯èƒ½æ˜¯ç”±äºå…¶ä»–çº¿ç¨‹çš„æ“ä½œè€Œæ”¹å˜ï¼Œè¿™æ—¶å°±éœ€è¦æœ‰ä¸€å®šçš„åè°ƒæœºåˆ¶æ¥ç¡®ä¿åœ¨åŒä¸€æ—¶åˆ»ï¼Œæ•°æ®åªèƒ½è¢«ä¸€ä¸ªçº¿ç¨‹é”ä¿®æ”¹ï¼Œä¸”ä¿®æ”¹çš„æ•°æ®çŠ¶æ€è¢«æ‰€æœ‰çº¿ç¨‹æ‰€æ„ŸçŸ¥ã€‚</p>
<p>Java 1.5 ä¹‹å‰ï¼Œä¸»è¦æ˜¯åˆ©ç”¨ <code>Object</code> ç±»ä¸­çš„ <code>wait</code>ã€<code>notify</code>ã€<code>notifyAll</code> é…åˆ <code>synchronized</code> æ¥è¿›è¡Œçº¿ç¨‹é—´é€šä¿¡ã€‚<code>wait</code>ã€<code>notify</code>ã€<code>notifyAll</code> éœ€è¦é…åˆ <code>synchronized</code> ä½¿ç”¨ï¼Œä¸é€‚ç”¨äº <code>Lock</code>ã€‚è€Œä½¿ç”¨ <code>Lock</code> çš„çº¿ç¨‹ï¼Œå½¼æ­¤é—´é€šä¿¡åº”è¯¥ä½¿ç”¨ <code>Condition</code> ã€‚è¿™å¯ä»¥ç†è§£ä¸ºï¼Œä»€ä¹ˆæ ·çš„é”é…ä»€ä¹ˆæ ·çš„é’¥åŒ™ã€‚<strong>å†…ç½®é”ï¼ˆ<code>synchronized</code>ï¼‰é…åˆå†…ç½®æ¡ä»¶é˜Ÿåˆ—ï¼ˆ<code>wait</code>ã€<code>notify</code>ã€<code>notifyAll</code> ï¼‰ï¼Œæ˜¾å¼é”ï¼ˆ<code>Lock</code>ï¼‰é…åˆæ˜¾å¼æ¡ä»¶é˜Ÿåˆ—ï¼ˆ<code>Condition</code> ï¼‰</strong>ã€‚</p>
<h4 id="Condition-çš„ç‰¹æ€§"><a href="#Condition-çš„ç‰¹æ€§" class="headerlink" title="Condition çš„ç‰¹æ€§"></a>Condition çš„ç‰¹æ€§</h4><p><code>Condition</code> æ¥å£å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Condition</span> &#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">await</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">awaitUninterruptibly</span><span class="params">()</span>;</span><br><span class="line">    <span class="type">long</span> <span class="title function_">awaitNanos</span><span class="params">(<span class="type">long</span> nanosTimeout)</span> <span class="keyword">throws</span> InterruptedException;</span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">await</span><span class="params">(<span class="type">long</span> time, TimeUnit unit)</span> <span class="keyword">throws</span> InterruptedException;</span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">awaitUntil</span><span class="params">(Date deadline)</span> <span class="keyword">throws</span> InterruptedException;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">signal</span><span class="params">()</span>;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">signalAll</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­ï¼Œ<code>await</code>ã€<code>signal</code>ã€<code>signalAll</code> ä¸ <code>wait</code>ã€<code>notify</code>ã€<code>notifyAll</code> ç›¸å¯¹åº”ï¼ŒåŠŸèƒ½ä¹Ÿç›¸ä¼¼ã€‚é™¤æ­¤ä»¥å¤–ï¼Œ<code>Condition</code> ç›¸æ¯”å†…ç½®æ¡ä»¶é˜Ÿåˆ—ï¼ˆ <code>wait</code>ã€<code>notify</code>ã€<code>notifyAll</code> ï¼‰ï¼Œæä¾›äº†æ›´ä¸ºä¸°å¯Œçš„åŠŸèƒ½ï¼š</p>
<ul>
<li>æ¯ä¸ªé”ï¼ˆ<code>Lock</code>ï¼‰ä¸Šå¯ä»¥å­˜åœ¨å¤šä¸ª <code>Condition</code>ï¼Œè¿™æ„å‘³ç€é”çš„çŠ¶æ€æ¡ä»¶å¯ä»¥æœ‰å¤šä¸ªã€‚</li>
<li>æ”¯æŒå…¬å¹³çš„æˆ–éå…¬å¹³çš„é˜Ÿåˆ—æ“ä½œã€‚</li>
<li>æ”¯æŒå¯ä¸­æ–­çš„æ¡ä»¶ç­‰å¾…ï¼Œç›¸å…³æ–¹æ³•ï¼š<code>awaitUninterruptibly()</code> ã€‚</li>
<li>æ”¯æŒå¯å®šæ—¶çš„ç­‰å¾…ï¼Œç›¸å…³æ–¹æ³•ï¼š<code>awaitNanos(long)</code> ã€<code>await(long, TimeUnit)</code>ã€<code>awaitUntil(Date)</code>ã€‚</li>
</ul>
<h4 id="Condition-çš„ç”¨æ³•"><a href="#Condition-çš„ç”¨æ³•" class="headerlink" title="Condition çš„ç”¨æ³•"></a>Condition çš„ç”¨æ³•</h4><p>è¿™é‡Œä»¥ <code>Condition</code> æ¥å®ç°ä¸€ä¸ªæ¶ˆè´¹è€…ã€ç”Ÿäº§è€…æ¨¡å¼ã€‚</p>
<blockquote>
<p>:bell: æ³¨æ„ï¼šäº‹å®ä¸Šï¼Œè§£å†³æ­¤ç±»é—®é¢˜ä½¿ç”¨ <code>CountDownLatch</code>ã€<code>Semaphore</code> ç­‰å·¥å…·æ›´ä¸ºä¾¿æ·ã€å®‰å…¨ã€‚æƒ³äº†è§£è¯¦æƒ…ï¼Œå¯ä»¥å‚è€ƒ <a href="https://dunwu.github.io/javacore/#/concurrent/java-concurrent-tools">Java å¹¶å‘å·¥å…·ç±»</a> ã€‚</p>
</blockquote>
<p>äº§å“ç±»</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Message</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Lock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Condition</span> <span class="variable">producedMsg</span> <span class="operator">=</span> lock.newCondition();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Condition</span> <span class="variable">consumedMsg</span> <span class="operator">=</span> lock.newCondition();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String message;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> state;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> end;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">consume</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//lock</span></span><br><span class="line">        lock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// no new message wait for new message</span></span><br><span class="line">            <span class="keyword">while</span> (!state) &#123; producedMsg.await(); &#125;</span><br><span class="line"></span><br><span class="line">            System.out.println(<span class="string">&quot;consume message : &quot;</span> + message);</span><br><span class="line">            state = <span class="literal">false</span>;</span><br><span class="line">            <span class="comment">// message consumed, notify waiting thread</span></span><br><span class="line">            consumedMsg.signal();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException ie) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Thread interrupted - viewMessage&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">produce</span><span class="params">(String message)</span> &#123;</span><br><span class="line">        lock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// last message not consumed, wait for it be consumed</span></span><br><span class="line">            <span class="keyword">while</span> (state) &#123; consumedMsg.await(); &#125;</span><br><span class="line"></span><br><span class="line">            System.out.println(<span class="string">&quot;produce msg: &quot;</span> + message);</span><br><span class="line">            <span class="built_in">this</span>.message = message;</span><br><span class="line">            state = <span class="literal">true</span>;</span><br><span class="line">            <span class="comment">// new message added, notify waiting thread</span></span><br><span class="line">            producedMsg.signal();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException ie) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Thread interrupted - publishMessage&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isEnd</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> end;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setEnd</span><span class="params">(<span class="type">boolean</span> end)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.end = end;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ¶ˆè´¹è€…</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MessageConsumer</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Message message;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MessageConsumer</span><span class="params">(Message msg)</span> &#123;</span><br><span class="line">        message = msg;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> (!message.isEnd()) &#123; message.consume(); &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç”Ÿäº§è€…</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MessageProducer</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Message message;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MessageProducer</span><span class="params">(Message msg)</span> &#123;</span><br><span class="line">        message = msg;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        produce();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">produce</span><span class="params">()</span> &#123;</span><br><span class="line">        List&lt;String&gt; msgs = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        msgs.add(<span class="string">&quot;Begin&quot;</span>);</span><br><span class="line">        msgs.add(<span class="string">&quot;Msg1&quot;</span>);</span><br><span class="line">        msgs.add(<span class="string">&quot;Msg2&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (String msg : msgs) &#123;</span><br><span class="line">            message.produce(msg);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">100</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        message.produce(<span class="string">&quot;End&quot;</span>);</span><br><span class="line">        message.setEnd(<span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æµ‹è¯•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LockConditionDemo</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Message</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Message</span>();</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">producer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">MessageProducer</span>(msg));</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">consumer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">MessageConsumer</span>(msg));</span><br><span class="line">        producer.start();</span><br><span class="line">        consumer.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="ReentrantLock"><a href="#ReentrantLock" class="headerlink" title="ReentrantLock"></a>ReentrantLock</h2><p><code>ReentrantLock</code> ç±»æ˜¯ <code>Lock</code> æ¥å£çš„å…·ä½“å®ç°ï¼Œä¸å†…ç½®é” <code>synchronized</code> ç›¸åŒçš„æ˜¯ï¼Œå®ƒæ˜¯ä¸€ä¸ª<strong>å¯é‡å…¥é”</strong>ã€‚</p>
<p><code>ReentrantLock</code> çš„ç‰¹æ€§å¦‚ä¸‹ï¼š</p>
<ul>
<li><strong><code>ReentrantLock</code> æä¾›äº†ä¸ <code>synchronized</code> ç›¸åŒçš„äº’æ–¥æ€§ã€å†…å­˜å¯è§æ€§å’Œå¯é‡å…¥æ€§</strong>ã€‚</li>
<li><code>ReentrantLock</code> <strong>æ”¯æŒå…¬å¹³é”å’Œéå…¬å¹³é”</strong>ï¼ˆé»˜è®¤ï¼‰ä¸¤ç§æ¨¡å¼ã€‚</li>
<li><code>ReentrantLock</code> å®ç°äº† <code>Lock</code> æ¥å£ï¼Œæ”¯æŒäº† <code>synchronized</code> æ‰€ä¸å…·å¤‡çš„<strong>çµæ´»æ€§</strong>ï¼Œå¢åŠ äº†è½®è¯¢ã€è¶…æ—¶ã€ä¸­æ–­ç­‰åŠŸèƒ½ã€‚<ul>
<li><code>synchronized</code> æ— æ³•ä¸­æ–­ä¸€ä¸ªæ­£åœ¨ç­‰å¾…è·å–é”çš„çº¿ç¨‹</li>
<li><code>synchronized</code> æ— æ³•åœ¨è¯·æ±‚è·å–ä¸€ä¸ªé”æ—¶æ— ä¼‘æ­¢åœ°ç­‰å¾…</li>
</ul>
</li>
</ul>
<h3 id="ReentrantLock-çš„ç”¨æ³•"><a href="#ReentrantLock-çš„ç”¨æ³•" class="headerlink" title="ReentrantLock çš„ç”¨æ³•"></a>ReentrantLock çš„ç”¨æ³•</h3><p>å‰æ–‡äº†è§£äº† <code>ReentrantLock</code> çš„ç‰¹æ€§ï¼Œæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬è¦è®²è¿°å…¶å…·ä½“ç”¨æ³•ã€‚</p>
<h4 id="ReentrantLock-çš„æ„é€ æ–¹æ³•"><a href="#ReentrantLock-çš„æ„é€ æ–¹æ³•" class="headerlink" title="ReentrantLock çš„æ„é€ æ–¹æ³•"></a>ReentrantLock çš„æ„é€ æ–¹æ³•</h4><p><code>ReentrantLock</code> æœ‰ä¸¤ä¸ªæ„é€ æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ReentrantLock</span><span class="params">()</span> &#123;&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="title function_">ReentrantLock</span><span class="params">(<span class="type">boolean</span> fair)</span> &#123;&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>ReentrantLock()</code> - é»˜è®¤æ„é€ æ–¹æ³•ä¼šåˆå§‹åŒ–ä¸€ä¸ª<strong>éå…¬å¹³é”ï¼ˆNonfairSyncï¼‰</strong>ï¼›</li>
<li><code>ReentrantLock(boolean)</code> - <code>new ReentrantLock(true)</code> ä¼šåˆå§‹åŒ–ä¸€ä¸ª<strong>å…¬å¹³é”ï¼ˆFairSyncï¼‰</strong>ã€‚</li>
</ul>
<h4 id="lock-å’Œ-unlock-æ–¹æ³•"><a href="#lock-å’Œ-unlock-æ–¹æ³•" class="headerlink" title="lock å’Œ unlock æ–¹æ³•"></a>lock å’Œ unlock æ–¹æ³•</h4><ul>
<li><code>lock()</code> - <strong>æ— æ¡ä»¶è·å–é”</strong>ã€‚å¦‚æœå½“å‰çº¿ç¨‹æ— æ³•è·å–é”ï¼Œåˆ™å½“å‰çº¿ç¨‹è¿›å…¥ä¼‘çœ çŠ¶æ€ä¸å¯ç”¨ï¼Œç›´è‡³å½“å‰çº¿ç¨‹è·å–åˆ°é”ã€‚å¦‚æœè¯¥é”æ²¡æœ‰è¢«å¦ä¸€ä¸ªçº¿ç¨‹æŒæœ‰ï¼Œåˆ™è·å–è¯¥é”å¹¶ç«‹å³è¿”å›ï¼Œå°†é”çš„æŒæœ‰è®¡æ•°è®¾ç½®ä¸º 1ã€‚</li>
<li><code>unlock()</code> - ç”¨äº<strong>é‡Šæ”¾é”</strong>ã€‚</li>
</ul>
<blockquote>
<p>:bell: æ³¨æ„ï¼šè¯·åŠ¡å¿…ç‰¢è®°ï¼Œè·å–é”æ“ä½œ <strong><code>lock()</code> å¿…é¡»åœ¨ <code>try catch</code> å—ä¸­è¿›è¡Œï¼Œå¹¶ä¸”å°†é‡Šæ”¾é”æ“ä½œ <code>unlock()</code> æ”¾åœ¨ <code>finally</code> å—ä¸­è¿›è¡Œï¼Œä»¥ä¿è¯é”ä¸€å®šè¢«è¢«é‡Šæ”¾ï¼Œé˜²æ­¢æ­»é”çš„å‘ç”Ÿ</strong>ã€‚</p>
</blockquote>
<p>ç¤ºä¾‹ï¼š<code>ReentrantLock</code> çš„åŸºæœ¬æ“ä½œ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReentrantLockDemo</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Task</span> <span class="variable">task</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Task</span>();</span><br><span class="line">        <span class="type">MyThread</span> <span class="variable">tA</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyThread</span>(<span class="string">&quot;Thread-A&quot;</span>, task);</span><br><span class="line">        <span class="type">MyThread</span> <span class="variable">tB</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyThread</span>(<span class="string">&quot;Thread-B&quot;</span>, task);</span><br><span class="line">        <span class="type">MyThread</span> <span class="variable">tC</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyThread</span>(<span class="string">&quot;Thread-C&quot;</span>, task);</span><br><span class="line">        tA.start();</span><br><span class="line">        tB.start();</span><br><span class="line">        tC.start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MyThread</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> Task task;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">MyThread</span><span class="params">(String name, Task task)</span> &#123;</span><br><span class="line">            <span class="built_in">super</span>(name);</span><br><span class="line">            <span class="built_in">this</span>.task = task;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            task.execute();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Task</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="type">ReentrantLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">()</span> &#123;</span><br><span class="line">            lock.lock();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">                    System.out.println(lock.toString());</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// æŸ¥è¯¢å½“å‰çº¿ç¨‹ hold ä½æ­¤é”çš„æ¬¡æ•°</span></span><br><span class="line">                    System.out.println(<span class="string">&quot;\t holdCount: &quot;</span> + lock.getHoldCount());</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// æŸ¥è¯¢æ­£ç­‰å¾…è·å–æ­¤é”çš„çº¿ç¨‹æ•°</span></span><br><span class="line">                    System.out.println(<span class="string">&quot;\t queuedLength: &quot;</span> + lock.getQueueLength());</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// æ˜¯å¦ä¸ºå…¬å¹³é”</span></span><br><span class="line">                    System.out.println(<span class="string">&quot;\t isFair: &quot;</span> + lock.isFair());</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// æ˜¯å¦è¢«é”ä½</span></span><br><span class="line">                    System.out.println(<span class="string">&quot;\t isLocked: &quot;</span> + lock.isLocked());</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// æ˜¯å¦è¢«å½“å‰çº¿ç¨‹æŒæœ‰é”</span></span><br><span class="line">                    System.out.println(<span class="string">&quot;\t isHeldByCurrentThread: &quot;</span> + lock.isHeldByCurrentThread());</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        Thread.sleep(<span class="number">500</span>);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                lock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¾“å‡ºç»“æœï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">java.util.concurrent.locks.ReentrantLock@64fcd88a[Locked by thread Thread-A]</span><br><span class="line">	 holdCount: <span class="number">1</span></span><br><span class="line">	 queuedLength: <span class="number">2</span></span><br><span class="line">	 isFair: <span class="literal">false</span></span><br><span class="line">	 isLocked: <span class="literal">true</span></span><br><span class="line">	 isHeldByCurrentThread: <span class="literal">true</span></span><br><span class="line">java.util.concurrent.locks.ReentrantLock@64fcd88a[Locked by thread Thread-C]</span><br><span class="line">	 holdCount: <span class="number">1</span></span><br><span class="line">	 queuedLength: <span class="number">1</span></span><br><span class="line">	 isFair: <span class="literal">false</span></span><br><span class="line">	 isLocked: <span class="literal">true</span></span><br><span class="line">	 isHeldByCurrentThread: <span class="literal">true</span></span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure>

<h4 id="tryLock-æ–¹æ³•"><a href="#tryLock-æ–¹æ³•" class="headerlink" title="tryLock æ–¹æ³•"></a>tryLock æ–¹æ³•</h4><p>ä¸æ— æ¡ä»¶è·å–é”ç›¸æ¯”ï¼ŒtryLock æœ‰æ›´å®Œå–„çš„å®¹é”™æœºåˆ¶ã€‚</p>
<ul>
<li><code>tryLock()</code> - <strong>å¯è½®è¯¢è·å–é”</strong>ã€‚å¦‚æœæˆåŠŸï¼Œåˆ™è¿”å› trueï¼›å¦‚æœå¤±è´¥ï¼Œåˆ™è¿”å› falseã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™ä¸ªæ–¹æ³•<strong>æ— è®ºæˆè´¥éƒ½ä¼šç«‹å³è¿”å›</strong>ï¼Œè·å–ä¸åˆ°é”ï¼ˆé”å·²è¢«å…¶ä»–çº¿ç¨‹è·å–ï¼‰æ—¶ä¸ä¼šä¸€ç›´ç­‰å¾…ã€‚</li>
<li><code>tryLock(long, TimeUnit)</code> - <strong>å¯å®šæ—¶è·å–é”</strong>ã€‚å’Œ <code>tryLock()</code> ç±»ä¼¼ï¼ŒåŒºåˆ«ä»…åœ¨äºè¿™ä¸ªæ–¹æ³•åœ¨<strong>è·å–ä¸åˆ°é”æ—¶ä¼šç­‰å¾…ä¸€å®šçš„æ—¶é—´</strong>ï¼Œåœ¨æ—¶é—´æœŸé™ä¹‹å†…å¦‚æœè¿˜è·å–ä¸åˆ°é”ï¼Œå°±è¿”å› falseã€‚å¦‚æœå¦‚æœä¸€å¼€å§‹æ‹¿åˆ°é”æˆ–è€…åœ¨ç­‰å¾…æœŸé—´å†…æ‹¿åˆ°äº†é”ï¼Œåˆ™è¿”å› trueã€‚</li>
</ul>
<p>ç¤ºä¾‹ï¼š<code>ReentrantLock</code> çš„ <code>tryLock()</code> æ“ä½œ</p>
<p>ä¿®æ”¹ä¸Šä¸ªç¤ºä¾‹ä¸­çš„ <code>execute()</code> æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (lock.tryLock()) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">               <span class="comment">// ç•¥ã€‚..</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        System.out.println(Thread.currentThread().getName() + <span class="string">&quot; è·å–é”å¤±è´¥&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç¤ºä¾‹ï¼š<code>ReentrantLock</code> çš„ <code>tryLock(long, TimeUnit)</code> æ“ä½œ</p>
<p>ä¿®æ”¹ä¸Šä¸ªç¤ºä¾‹ä¸­çš„ <code>execute()</code> æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (lock.tryLock(<span class="number">2</span>, TimeUnit.SECONDS)) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">                    <span class="comment">// ç•¥ã€‚..</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                lock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">&quot; è·å–é”å¤±è´¥&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        System.out.println(Thread.currentThread().getName() + <span class="string">&quot; è·å–é”è¶…æ—¶&quot;</span>);</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="lockInterruptibly-æ–¹æ³•"><a href="#lockInterruptibly-æ–¹æ³•" class="headerlink" title="lockInterruptibly æ–¹æ³•"></a>lockInterruptibly æ–¹æ³•</h4><ul>
<li><code>lockInterruptibly()</code> - <strong>å¯ä¸­æ–­è·å–é”</strong>ã€‚å¯ä¸­æ–­è·å–é”å¯ä»¥åœ¨è·å¾—é”çš„åŒæ—¶ä¿æŒå¯¹ä¸­æ–­çš„å“åº”ã€‚å¯ä¸­æ–­è·å–é”æ¯”å…¶å®ƒè·å–é”çš„æ–¹å¼ç¨å¾®å¤æ‚ä¸€äº›ï¼Œéœ€è¦ä¸¤ä¸ª <code>try-catch</code> å—ï¼ˆå¦‚æœåœ¨è·å–é”çš„æ“ä½œä¸­æŠ›å‡ºäº† <code>InterruptedException</code> ï¼Œé‚£ä¹ˆå¯ä»¥ä½¿ç”¨æ ‡å‡†çš„ <code>try-finally</code> åŠ é”æ¨¡å¼ï¼‰ã€‚<ul>
<li>ä¸¾ä¾‹æ¥è¯´ï¼šå‡è®¾æœ‰ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶é€šè¿‡ <code>lock.lockInterruptibly()</code> è·å–æŸä¸ªé”æ—¶ï¼Œè‹¥çº¿ç¨‹ A è·å–åˆ°äº†é”ï¼Œåˆ™çº¿ç¨‹ B åªèƒ½ç­‰å¾…ã€‚è‹¥æ­¤æ—¶å¯¹çº¿ç¨‹ B è°ƒç”¨ <code>threadB.interrupt()</code> æ–¹æ³•èƒ½å¤Ÿä¸­æ–­çº¿ç¨‹ B çš„ç­‰å¾…è¿‡ç¨‹ã€‚ç”±äº <code>lockInterruptibly()</code> çš„å£°æ˜ä¸­æŠ›å‡ºäº†å¼‚å¸¸ï¼Œæ‰€ä»¥ <code>lock.lockInterruptibly()</code> å¿…é¡»æ”¾åœ¨ <code>try</code> å—ä¸­æˆ–è€…åœ¨è°ƒç”¨ <code>lockInterruptibly()</code> çš„æ–¹æ³•å¤–å£°æ˜æŠ›å‡º <code>InterruptedException</code>ã€‚</li>
</ul>
</li>
</ul>
<blockquote>
<p>:bell: æ³¨æ„ï¼šå½“ä¸€ä¸ªçº¿ç¨‹è·å–äº†é”ä¹‹åï¼Œæ˜¯ä¸ä¼šè¢« <code>interrupt()</code> æ–¹æ³•ä¸­æ–­çš„ã€‚å•ç‹¬è°ƒç”¨ <code>interrupt()</code> æ–¹æ³•ä¸èƒ½ä¸­æ–­æ­£åœ¨è¿è¡ŒçŠ¶æ€ä¸­çš„çº¿ç¨‹ï¼Œåªèƒ½ä¸­æ–­é˜»å¡çŠ¶æ€ä¸­çš„çº¿ç¨‹ã€‚å› æ­¤å½“é€šè¿‡ <code>lockInterruptibly()</code> æ–¹æ³•è·å–æŸä¸ªé”æ—¶ï¼Œå¦‚æœæœªè·å–åˆ°é”ï¼Œåªæœ‰åœ¨ç­‰å¾…çš„çŠ¶æ€ä¸‹ï¼Œæ‰å¯ä»¥å“åº”ä¸­æ–­ã€‚</p>
</blockquote>
<p>ç¤ºä¾‹ï¼š<code>ReentrantLock</code> çš„ <code>lockInterruptibly()</code> æ“ä½œ</p>
<p>ä¿®æ”¹ä¸Šä¸ªç¤ºä¾‹ä¸­çš„ <code>execute()</code> æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        lock.lockInterruptibly();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">            <span class="comment">// ç•¥ã€‚..</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        System.out.println(Thread.currentThread().getName() + <span class="string">&quot;è¢«ä¸­æ–­&quot;</span>);</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="newCondition-æ–¹æ³•"><a href="#newCondition-æ–¹æ³•" class="headerlink" title="newCondition æ–¹æ³•"></a>newCondition æ–¹æ³•</h4><p><code>newCondition()</code> - è¿”å›ä¸€ä¸ªç»‘å®šåˆ° <code>Lock</code> å¯¹è±¡ä¸Šçš„ <code>Condition</code> å®ä¾‹ã€‚<code>Condition</code> çš„ç‰¹æ€§å’Œå…·ä½“æ–¹æ³•è¯·é˜…è¯»ä¸‹æ–‡ [<code>Condition</code>](#äº” condition)ã€‚</p>
<h3 id="ReentrantLock-çš„åŸç†"><a href="#ReentrantLock-çš„åŸç†" class="headerlink" title="ReentrantLock çš„åŸç†"></a>ReentrantLock çš„åŸç†</h3><h4 id="ReentrantLock-çš„å¯è§æ€§"><a href="#ReentrantLock-çš„å¯è§æ€§" class="headerlink" title="ReentrantLock çš„å¯è§æ€§"></a>ReentrantLock çš„å¯è§æ€§</h4><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title">X</span> &#123;</span><br><span class="line">  <span class="keyword">private</span> final Lock rtl =</span><br><span class="line">  <span class="keyword">new</span> ReentrantLock();</span><br><span class="line">  <span class="built_in">int</span> <span class="keyword">value</span>;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addOne</span>()</span> &#123;</span><br><span class="line">    <span class="comment">// è·å–é”</span></span><br><span class="line">    rtl.<span class="keyword">lock</span>();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">value</span>+=<span class="number">1</span>;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="comment">// ä¿è¯é”èƒ½é‡Šæ”¾</span></span><br><span class="line">      rtl.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ReentrantLockï¼Œå†…éƒ¨æŒæœ‰ä¸€ä¸ª volatile çš„æˆå‘˜å˜é‡ stateï¼Œè·å–é”çš„æ—¶å€™ï¼Œä¼šè¯»å†™ state çš„å€¼ï¼›è§£é”çš„æ—¶å€™ï¼Œä¹Ÿä¼šè¯»å†™ state çš„å€¼ï¼ˆç®€åŒ–åçš„ä»£ç å¦‚ä¸‹é¢æ‰€ç¤ºï¼‰ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨æ‰§è¡Œ value+&#x3D;1 ä¹‹å‰ï¼Œç¨‹åºå…ˆè¯»å†™äº†ä¸€æ¬¡ volatile å˜é‡ stateï¼Œåœ¨æ‰§è¡Œ value+&#x3D;1 ä¹‹åï¼Œåˆè¯»å†™äº†ä¸€æ¬¡ volatile å˜é‡ stateã€‚æ ¹æ®ç›¸å…³çš„ Happens-Before è§„åˆ™ï¼š</p>
<ol>
<li><strong>é¡ºåºæ€§è§„åˆ™</strong>ï¼šå¯¹äºçº¿ç¨‹ T1ï¼Œvalue+&#x3D;1 Happens-Before é‡Šæ”¾é”çš„æ“ä½œ unlock()ï¼›</li>
<li><strong>volatile å˜é‡è§„åˆ™</strong>ï¼šç”±äº state &#x3D; 1 ä¼šå…ˆè¯»å– stateï¼Œæ‰€ä»¥çº¿ç¨‹ T1 çš„ unlock() æ“ä½œ Happens-Before çº¿ç¨‹ T2 çš„ lock() æ“ä½œï¼›</li>
<li><strong>ä¼ é€’æ€§è§„åˆ™</strong>ï¼šçº¿ç¨‹ T1 çš„ value+&#x3D;1 Happens-Before çº¿ç¨‹ T2 çš„ lock() æ“ä½œã€‚</li>
</ol>
<h4 id="ReentrantLock-çš„æ•°æ®ç»“æ„"><a href="#ReentrantLock-çš„æ•°æ®ç»“æ„" class="headerlink" title="ReentrantLock çš„æ•°æ®ç»“æ„"></a>ReentrantLock çš„æ•°æ®ç»“æ„</h4><p>é˜…è¯» <code>ReentrantLock</code> çš„æºç ï¼Œå¯ä»¥å‘ç°å®ƒæœ‰ä¸€ä¸ªæ ¸å¿ƒå­—æ®µï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Sync sync;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>sync</code> - å†…éƒ¨æŠ½è±¡ç±» <code>ReentrantLock.Sync</code> å¯¹è±¡ï¼Œ<code>Sync</code> ç»§æ‰¿è‡ª AQSã€‚å®ƒæœ‰ä¸¤ä¸ªå­ç±»ï¼š</li>
<li><code>ReentrantLock.FairSync</code> - å…¬å¹³é”ã€‚</li>
<li><code>ReentrantLock.NonfairSync</code> - éå…¬å¹³é”ã€‚</li>
</ul>
<p>æŸ¥çœ‹æºç å¯ä»¥å‘ç°ï¼Œ<code>ReentrantLock</code> å®ç° <code>Lock</code> æ¥å£å…¶å®æ˜¯è°ƒç”¨ <code>ReentrantLock.FairSync</code> æˆ– <code>ReentrantLock.NonfairSync</code> ä¸­å„è‡ªçš„å®ç°ï¼Œè¿™é‡Œä¸ä¸€ä¸€åˆ—ä¸¾ã€‚</p>
<h4 id="ReentrantLock-çš„è·å–é”å’Œé‡Šæ”¾é”"><a href="#ReentrantLock-çš„è·å–é”å’Œé‡Šæ”¾é”" class="headerlink" title="ReentrantLock çš„è·å–é”å’Œé‡Šæ”¾é”"></a>ReentrantLock çš„è·å–é”å’Œé‡Šæ”¾é”</h4><p>ReentrantLock è·å–é”å’Œé‡Šæ”¾é”çš„æ¥å£ï¼Œä»è¡¨è±¡çœ‹ï¼Œæ˜¯è°ƒç”¨ <code>ReentrantLock.FairSync</code> æˆ– <code>ReentrantLock.NonfairSync</code> ä¸­å„è‡ªçš„å®ç°ï¼›ä»æœ¬è´¨ä¸Šçœ‹ï¼Œæ˜¯åŸºäº AQS çš„å®ç°ã€‚</p>
<p>ä»”ç»†é˜…è¯»æºç å¾ˆå®¹æ˜“å‘ç°ï¼š</p>
<ul>
<li><p><code>void lock()</code> è°ƒç”¨ Sync çš„ lock() æ–¹æ³•ã€‚</p>
</li>
<li><p><code>void lockInterruptibly()</code> ç›´æ¥è°ƒç”¨ AQS çš„ [è·å–å¯ä¸­æ–­çš„ç‹¬å é”](#è·å–å¯ä¸­æ–­çš„ç‹¬å é”ï¼‰ æ–¹æ³• <code>lockInterruptibly()</code>ã€‚</p>
</li>
<li><p><code>boolean tryLock()</code> è°ƒç”¨ Sync çš„ <code>nonfairTryAcquire()</code> ã€‚</p>
</li>
<li><p><code>boolean tryLock(long time, TimeUnit unit)</code> ç›´æ¥è°ƒç”¨ AQS çš„ [è·å–è¶…æ—¶ç­‰å¾…å¼çš„ç‹¬å é”](#è·å–è¶…æ—¶ç­‰å¾…å¼çš„ç‹¬å é”ï¼‰ æ–¹æ³• <code>tryAcquireNanos(int arg, long nanosTimeout)</code>ã€‚</p>
</li>
<li><p><code>void unlock()</code> ç›´æ¥è°ƒç”¨ AQS çš„ [é‡Šæ”¾ç‹¬å é”](#é‡Šæ”¾ç‹¬å é”ï¼‰ æ–¹æ³• <code>release(int arg)</code> ã€‚</p>
</li>
</ul>
<p>ç›´æ¥è°ƒç”¨ AQS æ¥å£çš„æ–¹æ³•å°±ä¸å†èµ˜è¿°äº†ï¼Œå…¶åŸç†åœ¨ [AQS çš„åŸç†](#AQS çš„åŸç†) ä¸­å·²ç»ç”¨å¾ˆå¤§ç¯‡å¹…è¿›è¡Œè¿‡è®²è§£ã€‚</p>
<p><code>nonfairTryAcquire</code> æ–¹æ³•æºç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å…¬å¹³é”å’Œéå…¬å¹³é”éƒ½ä¼šç”¨è¿™ä¸ªæ–¹æ³•åŒºå°è¯•è·å–é”</span></span><br><span class="line"><span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">nonfairTryAcquire</span><span class="params">(<span class="type">int</span> acquires)</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">Thread</span> <span class="variable">current</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">    <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> getState();</span><br><span class="line">    <span class="keyword">if</span> (c == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (compareAndSetState(<span class="number">0</span>, acquires)) &#123;</span><br><span class="line">         <span class="comment">// å¦‚æœåŒæ­¥çŠ¶æ€ä¸º 0ï¼Œå°†å…¶è®¾ä¸º acquiresï¼Œå¹¶è®¾ç½®å½“å‰çº¿ç¨‹ä¸ºæ’å®ƒçº¿ç¨‹</span></span><br><span class="line">            setExclusiveOwnerThread(current);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (current == getExclusiveOwnerThread()) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">nextc</span> <span class="operator">=</span> c + acquires;</span><br><span class="line">        <span class="keyword">if</span> (nextc &lt; <span class="number">0</span>) <span class="comment">// overflow</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;Maximum lock count exceeded&quot;</span>);</span><br><span class="line">        setState(nextc);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¤„ç†æµç¨‹å¾ˆç®€å•ï¼š</p>
<ul>
<li>å¦‚æœåŒæ­¥çŠ¶æ€ä¸º 0ï¼Œè®¾ç½®åŒæ­¥çŠ¶æ€è®¾ä¸º acquiresï¼Œå¹¶è®¾ç½®å½“å‰çº¿ç¨‹ä¸ºæ’å®ƒçº¿ç¨‹ï¼Œç„¶åè¿”å› trueï¼Œè·å–é”æˆåŠŸã€‚</li>
<li>å¦‚æœåŒæ­¥çŠ¶æ€ä¸ä¸º 0 ä¸”å½“å‰çº¿ç¨‹ä¸ºæ’å®ƒçº¿ç¨‹ï¼Œè®¾ç½®åŒæ­¥çŠ¶æ€ä¸ºå½“å‰çŠ¶æ€å€¼+acquires å€¼ï¼Œç„¶åè¿”å› trueï¼Œè·å–é”æˆåŠŸã€‚</li>
<li>å¦åˆ™ï¼Œè¿”å› falseï¼Œè·å–é”å¤±è´¥ã€‚</li>
</ul>
<h4 id="å…¬å¹³é”å’Œéå…¬å¹³é”"><a href="#å…¬å¹³é”å’Œéå…¬å¹³é”" class="headerlink" title="å…¬å¹³é”å’Œéå…¬å¹³é”"></a>å…¬å¹³é”å’Œéå…¬å¹³é”</h4><p>ReentrantLock è¿™ä¸ªç±»æœ‰ä¸¤ä¸ªæ„é€ å‡½æ•°ï¼Œä¸€ä¸ªæ˜¯æ— å‚æ„é€ å‡½æ•°ï¼Œä¸€ä¸ªæ˜¯ä¼ å…¥ fair å‚æ•°çš„æ„é€ å‡½æ•°ã€‚fair å‚æ•°ä»£è¡¨çš„æ˜¯é”çš„å…¬å¹³ç­–ç•¥ï¼Œå¦‚æœä¼ å…¥ true å°±è¡¨ç¤ºéœ€è¦æ„é€ ä¸€ä¸ªå…¬å¹³é”ï¼Œåä¹‹åˆ™è¡¨ç¤ºè¦æ„é€ ä¸€ä¸ªéå…¬å¹³é”ã€‚</p>
<p>é”éƒ½å¯¹åº”ç€ä¸€ä¸ªç­‰å¾…é˜Ÿåˆ—ï¼Œå¦‚æœä¸€ä¸ªçº¿ç¨‹æ²¡æœ‰è·å¾—é”ï¼Œå°±ä¼šè¿›å…¥ç­‰å¾…é˜Ÿåˆ—ï¼Œå½“æœ‰çº¿ç¨‹é‡Šæ”¾é”çš„æ—¶å€™ï¼Œå°±éœ€è¦ä»ç­‰å¾…é˜Ÿåˆ—ä¸­å”¤é†’ä¸€ä¸ªç­‰å¾…çš„çº¿ç¨‹ã€‚å¦‚æœæ˜¯å…¬å¹³é”ï¼Œå”¤é†’çš„ç­–ç•¥å°±æ˜¯è°ç­‰å¾…çš„æ—¶é—´é•¿ï¼Œå°±å”¤é†’è°ï¼Œå¾ˆå…¬å¹³ï¼›å¦‚æœæ˜¯éå…¬å¹³é”ï¼Œåˆ™ä¸æä¾›è¿™ä¸ªå…¬å¹³ä¿è¯ï¼Œæœ‰å¯èƒ½ç­‰å¾…æ—¶é—´çŸ­çš„çº¿ç¨‹åè€Œå…ˆè¢«å”¤é†’ã€‚</p>
<p>lock æ–¹æ³•åœ¨å…¬å¹³é”å’Œéå…¬å¹³é”ä¸­çš„å®ç°ï¼š</p>
<p>äºŒè€…çš„åŒºåˆ«ä»…åœ¨äºç”³è¯·éå…¬å¹³é”æ—¶ï¼Œå¦‚æœåŒæ­¥çŠ¶æ€ä¸º 0ï¼Œå°è¯•å°†å…¶è®¾ä¸º 1ï¼Œå¦‚æœæˆåŠŸï¼Œç›´æ¥å°†å½“å‰çº¿ç¨‹ç½®ä¸ºæ’å®ƒçº¿ç¨‹ï¼›å¦åˆ™å’Œå…¬å¹³é”ä¸€æ ·ï¼Œè°ƒç”¨ AQS è·å–ç‹¬å é”æ–¹æ³• <code>acquire</code>ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// éå…¬å¹³é”å®ç°</span></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">lock</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (compareAndSetState(<span class="number">0</span>, <span class="number">1</span>))</span><br><span class="line">    <span class="comment">// å¦‚æœåŒæ­¥çŠ¶æ€ä¸º 0ï¼Œå°†å…¶è®¾ä¸º 1ï¼Œå¹¶è®¾ç½®å½“å‰çº¿ç¨‹ä¸ºæ’å®ƒçº¿ç¨‹</span></span><br><span class="line">        setExclusiveOwnerThread(Thread.currentThread());</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    <span class="comment">// è°ƒç”¨ AQS è·å–ç‹¬å é”æ–¹æ³• acquire</span></span><br><span class="line">        acquire(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å…¬å¹³é”å®ç°</span></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">lock</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// è°ƒç”¨ AQS è·å–ç‹¬å é”æ–¹æ³• acquire</span></span><br><span class="line">    acquire(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="ReentrantReadWriteLock"><a href="#ReentrantReadWriteLock" class="headerlink" title="ReentrantReadWriteLock"></a>ReentrantReadWriteLock</h2><p><code>ReadWriteLock</code> é€‚ç”¨äº<strong>è¯»å¤šå†™å°‘çš„åœºæ™¯</strong>ã€‚</p>
<p><code>ReentrantReadWriteLock</code> ç±»æ˜¯ <code>ReadWriteLock</code> æ¥å£çš„å…·ä½“å®ç°ï¼Œå®ƒæ˜¯ä¸€ä¸ªå¯é‡å…¥çš„è¯»å†™é”ã€‚<code>ReentrantReadWriteLock</code> ç»´æŠ¤äº†ä¸€å¯¹è¯»å†™é”ï¼Œå°†è¯»å†™é”åˆ†å¼€ï¼Œæœ‰åˆ©äºæé«˜å¹¶å‘æ•ˆç‡ã€‚</p>
<p>è¯»å†™é”ï¼Œå¹¶ä¸æ˜¯ Java è¯­è¨€ç‰¹æœ‰çš„ï¼Œè€Œæ˜¯ä¸€ä¸ªå¹¿ä¸ºä½¿ç”¨çš„é€šç”¨æŠ€æœ¯ï¼Œæ‰€æœ‰çš„è¯»å†™é”éƒ½éµå®ˆä»¥ä¸‹ä¸‰æ¡åŸºæœ¬åŸåˆ™ï¼š</p>
<ul>
<li>å…è®¸å¤šä¸ªçº¿ç¨‹åŒæ—¶è¯»å…±äº«å˜é‡ï¼›</li>
<li>åªå…è®¸ä¸€ä¸ªçº¿ç¨‹å†™å…±äº«å˜é‡ï¼›</li>
<li>å¦‚æœä¸€ä¸ªå†™çº¿ç¨‹æ­£åœ¨æ‰§è¡Œå†™æ“ä½œï¼Œæ­¤æ—¶ç¦æ­¢è¯»çº¿ç¨‹è¯»å…±äº«å˜é‡ã€‚</li>
</ul>
<p>è¯»å†™é”ä¸äº’æ–¥é”çš„ä¸€ä¸ªé‡è¦åŒºåˆ«å°±æ˜¯<strong>è¯»å†™é”å…è®¸å¤šä¸ªçº¿ç¨‹åŒæ—¶è¯»å…±äº«å˜é‡</strong>ï¼Œè€Œäº’æ–¥é”æ˜¯ä¸å…è®¸çš„ï¼Œè¿™æ˜¯è¯»å†™é”åœ¨è¯»å¤šå†™å°‘åœºæ™¯ä¸‹æ€§èƒ½ä¼˜äºäº’æ–¥é”çš„å…³é”®ã€‚ä½†<strong>è¯»å†™é”çš„å†™æ“ä½œæ˜¯äº’æ–¥çš„</strong>ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹åœ¨å†™å…±äº«å˜é‡çš„æ—¶å€™ï¼Œæ˜¯ä¸å…è®¸å…¶ä»–çº¿ç¨‹æ‰§è¡Œå†™æ“ä½œå’Œè¯»æ“ä½œã€‚</p>
<h3 id="ReentrantReadWriteLock-çš„ç‰¹æ€§"><a href="#ReentrantReadWriteLock-çš„ç‰¹æ€§" class="headerlink" title="ReentrantReadWriteLock çš„ç‰¹æ€§"></a>ReentrantReadWriteLock çš„ç‰¹æ€§</h3><p>ReentrantReadWriteLock çš„ç‰¹æ€§å¦‚ä¸‹ï¼š</p>
<ul>
<li><strong><code>ReentrantReadWriteLock</code> é€‚ç”¨äºè¯»å¤šå†™å°‘çš„åœºæ™¯</strong>ã€‚å¦‚æœæ˜¯å†™å¤šè¯»å°‘çš„åœºæ™¯ï¼Œç”±äº <code>ReentrantReadWriteLock</code> å…¶å†…éƒ¨å®ç°æ¯” <code>ReentrantLock</code> å¤æ‚ï¼Œæ€§èƒ½å¯èƒ½åè€Œè¦å·®ä¸€äº›ã€‚å¦‚æœå­˜åœ¨è¿™æ ·çš„é—®é¢˜ï¼Œéœ€è¦å…·ä½“é—®é¢˜å…·ä½“åˆ†æã€‚ç”±äº <code>ReentrantReadWriteLock</code> çš„è¯»å†™é”ï¼ˆ<code>ReadLock</code>ã€<code>WriteLock</code>ï¼‰éƒ½å®ç°äº† <code>Lock</code> æ¥å£ï¼Œæ‰€ä»¥è¦æ›¿æ¢ä¸º <code>ReentrantLock</code> ä¹Ÿè¾ƒä¸ºå®¹æ˜“ã€‚</li>
<li><code>ReentrantReadWriteLock</code> å®ç°äº† <code>ReadWriteLock</code> æ¥å£ï¼Œæ”¯æŒäº† <code>ReentrantLock</code> æ‰€ä¸å…·å¤‡çš„è¯»å†™é”åˆ†ç¦»ã€‚<code>ReentrantReadWriteLock</code> ç»´æŠ¤äº†ä¸€å¯¹è¯»å†™é”ï¼ˆ<code>ReadLock</code>ã€<code>WriteLock</code>ï¼‰ã€‚å°†è¯»å†™é”åˆ†å¼€ï¼Œæœ‰åˆ©äºæé«˜å¹¶å‘æ•ˆç‡ã€‚<code>ReentrantReadWriteLock</code> çš„åŠ é”ç­–ç•¥æ˜¯ï¼š<strong>å…è®¸å¤šä¸ªè¯»æ“ä½œå¹¶å‘æ‰§è¡Œï¼Œä½†æ¯æ¬¡åªå…è®¸ä¸€ä¸ªå†™æ“ä½œ</strong>ã€‚</li>
<li><code>ReentrantReadWriteLock</code> ä¸ºè¯»å†™é”éƒ½æä¾›äº†å¯é‡å…¥çš„åŠ é”è¯­ä¹‰ã€‚</li>
<li><code>ReentrantReadWriteLock</code> æ”¯æŒå…¬å¹³é”å’Œéå…¬å¹³é”ï¼ˆé»˜è®¤ï¼‰ä¸¤ç§æ¨¡å¼ã€‚</li>
</ul>
<p><code>ReadWriteLock</code> æ¥å£å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ReadWriteLock</span> &#123;</span><br><span class="line">    Lock <span class="title function_">readLock</span><span class="params">()</span>;</span><br><span class="line">    Lock <span class="title function_">writeLock</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>readLock</code> - è¿”å›ç”¨äºè¯»æ“ä½œçš„é”ï¼ˆ<code>ReadLock</code>ï¼‰ã€‚</li>
<li><code>writeLock</code> - è¿”å›ç”¨äºå†™æ“ä½œçš„é”ï¼ˆ<code>WriteLock</code>ï¼‰ã€‚</li>
</ul>
<p>åœ¨è¯»å†™é”å’Œå†™å…¥é”ä¹‹é—´çš„äº¤äº’å¯ä»¥é‡‡ç”¨å¤šç§å®ç°æ–¹å¼ï¼Œ<code>ReadWriteLock</code> çš„ä¸€äº›å¯é€‰å®ç°åŒ…æ‹¬ï¼š</p>
<ul>
<li><strong>é‡Šæ”¾ä¼˜å…ˆ</strong> - å½“ä¸€ä¸ªå†™å…¥æ“ä½œé‡Šæ”¾å†™é”ï¼Œå¹¶ä¸”é˜Ÿåˆ—ä¸­åŒæ—¶å­˜åœ¨è¯»çº¿ç¨‹å’Œå†™çº¿ç¨‹ï¼Œé‚£ä¹ˆåº”è¯¥ä¼˜å…ˆé€‰æ‹©è¯»çº¿ç¨‹ã€å†™çº¿ç¨‹ï¼Œè¿˜æ˜¯æœ€å…ˆå‘å‡ºè¯·æ±‚çš„çº¿ç¨‹ï¼Ÿ</li>
<li><strong>è¯»çº¿ç¨‹æ’é˜Ÿ</strong> - å¦‚æœé”æ˜¯ç”±è¯»çº¿ç¨‹æŒæœ‰ï¼Œä½†æœ‰å†™çº¿ç¨‹æ­£åœ¨ç­‰å¾…ï¼Œé‚£ä¹ˆæ–°åˆ°è¾¾çš„è¯»çº¿ç¨‹èƒ½å¦ç«‹å³è·å¾—è®¿é—®æƒï¼Œè¿˜æ˜¯åº”è¯¥åœ¨å†™çº¿ç¨‹åé¢ç­‰å¾…ï¼Ÿå¦‚æœå…è®¸è¯»çº¿ç¨‹æ’é˜Ÿåˆ°å†™çº¿ç¨‹ä¹‹å‰ï¼Œé‚£ä¹ˆå°†æé«˜å¹¶å‘æ€§ï¼Œä½†å¯èƒ½é€ æˆçº¿ç¨‹é¥¥é¥¿é—®é¢˜ã€‚</li>
<li><strong>é‡å…¥æ€§</strong> - è¯»é”å’Œå†™é”æ˜¯å¦æ˜¯å¯é‡å…¥çš„ï¼Ÿ</li>
<li><strong>é™çº§</strong> - å¦‚æœä¸€ä¸ªçº¿ç¨‹æŒæœ‰å†™å…¥é”ï¼Œé‚£ä¹ˆå®ƒèƒ½å¦åœ¨ä¸é‡Šæ”¾è¯¥é”çš„æƒ…å†µä¸‹è·å¾—è¯»é”ï¼Ÿè¿™å¯èƒ½ä¼šä½¿å¾—å†™é”è¢«é™çº§ä¸ºè¯»é”ï¼ŒåŒæ—¶ä¸å…è®¸å…¶ä»–å†™çº¿ç¨‹ä¿®æ”¹è¢«ä¿æŠ¤çš„èµ„æºã€‚</li>
<li><strong>å‡çº§</strong> - è¯»é”èƒ½å¦ä¼˜å…ˆäºå…¶ä»–æ­£åœ¨ç­‰å¾…çš„è¯»çº¿ç¨‹å’Œå†™çº¿ç¨‹è€Œå‡çº§ä¸ºä¸€ä¸ªå†™é”ï¼Ÿåœ¨å¤§å¤šæ•°çš„è¯»å†™é”å®ç°ä¸­å¹¶ä¸æ”¯æŒå‡çº§ï¼Œå› ä¸ºå¦‚æœæ²¡æœ‰æ˜¾å¼çš„å‡çº§æ“ä½œï¼Œé‚£ä¹ˆå¾ˆå®¹æ˜“é€ æˆæ­»é”ã€‚</li>
</ul>
<h3 id="ReentrantReadWriteLock-çš„ç”¨æ³•"><a href="#ReentrantReadWriteLock-çš„ç”¨æ³•" class="headerlink" title="ReentrantReadWriteLock çš„ç”¨æ³•"></a>ReentrantReadWriteLock çš„ç”¨æ³•</h3><p>å‰æ–‡äº†è§£äº† <code>ReentrantReadWriteLock</code> çš„ç‰¹æ€§ï¼Œæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬è¦è®²è¿°å…¶å…·ä½“ç”¨æ³•ã€‚</p>
<h4 id="ReentrantReadWriteLock-çš„æ„é€ æ–¹æ³•"><a href="#ReentrantReadWriteLock-çš„æ„é€ æ–¹æ³•" class="headerlink" title="ReentrantReadWriteLock çš„æ„é€ æ–¹æ³•"></a>ReentrantReadWriteLock çš„æ„é€ æ–¹æ³•</h4><p><code>ReentrantReadWriteLock</code> å’Œ <code>ReentrantLock</code> ä¸€æ ·ï¼Œä¹Ÿæœ‰ä¸¤ä¸ªæ„é€ æ–¹æ³•ï¼Œä¸”ç”¨æ³•ç›¸ä¼¼ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ReentrantReadWriteLock</span><span class="params">()</span> &#123;&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="title function_">ReentrantReadWriteLock</span><span class="params">(<span class="type">boolean</span> fair)</span> &#123;&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>ReentrantReadWriteLock()</code> - é»˜è®¤æ„é€ æ–¹æ³•ä¼šåˆå§‹åŒ–ä¸€ä¸ª<strong>éå…¬å¹³é”ï¼ˆNonfairSyncï¼‰</strong>ã€‚åœ¨éå…¬å¹³çš„é”ä¸­ï¼Œçº¿ç¨‹è·å¾—é”çš„é¡ºåºæ˜¯ä¸ç¡®å®šçš„ã€‚å†™çº¿ç¨‹é™çº§ä¸ºè¯»çº¿ç¨‹æ˜¯å¯ä»¥çš„ï¼Œä½†è¯»çº¿ç¨‹å‡çº§ä¸ºå†™çº¿ç¨‹æ˜¯ä¸å¯ä»¥çš„ï¼ˆè¿™æ ·ä¼šå¯¼è‡´æ­»é”ï¼‰ã€‚</li>
<li><code>ReentrantReadWriteLock(boolean)</code> - <code>new ReentrantLock(true)</code> ä¼šåˆå§‹åŒ–ä¸€ä¸ª<strong>å…¬å¹³é”ï¼ˆFairSyncï¼‰</strong>ã€‚å¯¹äºå…¬å¹³é”ï¼Œç­‰å¾…æ—¶é—´æœ€é•¿çš„çº¿ç¨‹å°†ä¼˜å…ˆè·å¾—é”ã€‚å¦‚æœè¿™ä¸ªé”æ˜¯è¯»çº¿ç¨‹æŒæœ‰ï¼Œåˆ™å¦ä¸€ä¸ªçº¿ç¨‹è¯·æ±‚å†™é”ï¼Œé‚£ä¹ˆå…¶ä»–è¯»çº¿ç¨‹éƒ½ä¸èƒ½è·å¾—è¯»é”ï¼Œç›´åˆ°å†™çº¿ç¨‹é‡Šæ”¾å†™é”ã€‚</li>
</ul>
<h4 id="ReentrantReadWriteLock-çš„ä½¿ç”¨å®ä¾‹"><a href="#ReentrantReadWriteLock-çš„ä½¿ç”¨å®ä¾‹" class="headerlink" title="ReentrantReadWriteLock çš„ä½¿ç”¨å®ä¾‹"></a>ReentrantReadWriteLock çš„ä½¿ç”¨å®ä¾‹</h4><p>åœ¨ [<code>ReentrantReadWriteLock</code> çš„ç‰¹æ€§](#reentrantreadwritelock-çš„ç‰¹æ€§ï¼‰ ä¸­å·²ç»ä»‹ç»è¿‡ï¼Œ<code>ReentrantReadWriteLock</code> çš„è¯»å†™é”ï¼ˆ<code>ReadLock</code>ã€<code>WriteLock</code>) éƒ½å®ç°äº† <code>Lock</code> æ¥å£ï¼Œæ‰€ä»¥å…¶å„è‡ªç‹¬ç«‹çš„ä½¿ç”¨æ–¹å¼ä¸ <code>ReentrantLock</code> ä¸€æ ·ï¼Œè¿™é‡Œä¸å†èµ˜è¿°ã€‚</p>
<p><code>ReentrantReadWriteLock</code> ä¸ <code>ReentrantLock</code> ç”¨æ³•ä¸Šçš„å·®å¼‚ï¼Œä¸»è¦åœ¨äºè¯»å†™é”çš„é…åˆä½¿ç”¨ã€‚æœ¬æ–‡ä»¥ä¸€ä¸ªå…¸å‹ä½¿ç”¨åœºæ™¯æ¥è¿›è¡Œè®²è§£ã€‚</p>
<p>ã€ç¤ºä¾‹ã€‘åŸºäº <code>ReadWriteLock</code> å®ç°ä¸€ä¸ªç®€å•çš„æ³›å‹æ— ç•Œç¼“å­˜</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ç®€å•çš„æ— ç•Œç¼“å­˜å®ç°</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * ä½¿ç”¨ WeakHashMap å­˜å‚¨é”®å€¼å¯¹ã€‚WeakHashMap ä¸­å­˜å‚¨çš„å¯¹è±¡æ˜¯å¼±å¼•ç”¨ï¼ŒJVM GC æ—¶ä¼šè‡ªåŠ¨æ¸…é™¤æ²¡æœ‰è¢«å¼•ç”¨çš„å¼±å¼•ç”¨å¯¹è±¡ã€‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">UnboundedCache</span>&lt;K, V&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;K, V&gt; cacheMap = <span class="keyword">new</span> <span class="title class_">WeakHashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">ReadWriteLock</span> <span class="variable">cacheLock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantReadWriteLock</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> V <span class="title function_">get</span><span class="params">(K key)</span> &#123;</span><br><span class="line">        cacheLock.readLock().lock();</span><br><span class="line">        V value;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            value = cacheMap.get(key);</span><br><span class="line">            <span class="type">String</span> <span class="variable">log</span> <span class="operator">=</span> String.format(<span class="string">&quot;%s è¯»æ•°æ® %s:%s&quot;</span>, Thread.currentThread().getName(), key, value);</span><br><span class="line">            System.out.println(log);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            cacheLock.readLock().unlock();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> V <span class="title function_">put</span><span class="params">(K key, V value)</span> &#123;</span><br><span class="line">        cacheLock.writeLock().lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            cacheMap.put(key, value);</span><br><span class="line">            <span class="type">String</span> <span class="variable">log</span> <span class="operator">=</span> String.format(<span class="string">&quot;%s å†™å…¥æ•°æ® %s:%s&quot;</span>, Thread.currentThread().getName(), key, value);</span><br><span class="line">            System.out.println(log);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            cacheLock.writeLock().unlock();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> V <span class="title function_">remove</span><span class="params">(K key)</span> &#123;</span><br><span class="line">        cacheLock.writeLock().lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> cacheMap.remove(key);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            cacheLock.writeLock().unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">clear</span><span class="params">()</span> &#123;</span><br><span class="line">        cacheLock.writeLock().lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.cacheMap.clear();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            cacheLock.writeLock().unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¯´æ˜ï¼š</p>
<ul>
<li>ä½¿ç”¨ <code>WeakHashMap</code> è€Œä¸æ˜¯ <code>HashMap</code> æ¥å­˜å‚¨é”®å€¼å¯¹ã€‚<code>WeakHashMap</code> ä¸­å­˜å‚¨çš„å¯¹è±¡æ˜¯å¼±å¼•ç”¨ï¼ŒJVM GC æ—¶ä¼šè‡ªåŠ¨æ¸…é™¤æ²¡æœ‰è¢«å¼•ç”¨çš„å¼±å¼•ç”¨å¯¹è±¡ã€‚</li>
<li>å‘ <code>Map</code> å†™æ•°æ®å‰åŠ å†™é”ï¼Œå†™å®Œåï¼Œé‡Šæ”¾å†™é”ã€‚</li>
<li>å‘ <code>Map</code> è¯»æ•°æ®å‰åŠ è¯»é”ï¼Œè¯»å®Œåï¼Œé‡Šæ”¾è¯»é”ã€‚</li>
</ul>
<p>æµ‹è¯•å…¶çº¿ç¨‹å®‰å…¨æ€§ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> &lt;a href=&quot;mailto:forbreak@163.com&quot;&gt;Zhang Peng&lt;/a&gt;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2020-01-01</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReentrantReadWriteLockDemo</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> UnboundedCache&lt;Integer, Integer&gt; cache = <span class="keyword">new</span> <span class="title class_">UnboundedCache</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">ExecutorService</span> <span class="variable">executorService</span> <span class="operator">=</span> Executors.newCachedThreadPool();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">20</span>; i++) &#123;</span><br><span class="line">            executorService.execute(<span class="keyword">new</span> <span class="title class_">MyThread</span>());</span><br><span class="line">            cache.get(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        executorService.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** çº¿ç¨‹ä»»åŠ¡æ¯æ¬¡å‘ç¼“å­˜ä¸­å†™å…¥ 3 ä¸ªéšæœºå€¼ï¼Œkey å›ºå®š */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MyThread</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="type">Random</span> <span class="variable">random</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>();</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">                cache.put(i, random.nextInt(<span class="number">100</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¯´æ˜ï¼šç¤ºä¾‹ä¸­ï¼Œé€šè¿‡çº¿ç¨‹æ± å¯åŠ¨ 20 ä¸ªå¹¶å‘ä»»åŠ¡ã€‚ä»»åŠ¡æ¯æ¬¡å‘ç¼“å­˜ä¸­å†™å…¥ 3 ä¸ªéšæœºå€¼ï¼Œkey å›ºå®šï¼›ç„¶åä¸»çº¿ç¨‹æ¯æ¬¡å›ºå®šè¯»å–ç¼“å­˜ä¸­ç¬¬ä¸€ä¸ª key çš„å€¼ã€‚</p>
<p>è¾“å‡ºç»“æœï¼š</p>
<figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">main è¯»æ•°æ® 0:null</span><br><span class="line">pool<span class="string">-1</span>-thread<span class="string">-1</span> å†™å…¥æ•°æ® 0:16</span><br><span class="line">pool<span class="string">-1</span>-thread<span class="string">-1</span> å†™å…¥æ•°æ® 1:58</span><br><span class="line">pool<span class="string">-1</span>-thread<span class="string">-1</span> å†™å…¥æ•°æ® 2:50</span><br><span class="line">main è¯»æ•°æ® 0:16</span><br><span class="line">pool<span class="string">-1</span>-thread<span class="string">-1</span> å†™å…¥æ•°æ® 0:85</span><br><span class="line">pool<span class="string">-1</span>-thread<span class="string">-1</span> å†™å…¥æ•°æ® 1:76</span><br><span class="line">pool<span class="string">-1</span>-thread<span class="string">-1</span> å†™å…¥æ•°æ® 2:46</span><br><span class="line">pool<span class="string">-1</span>-thread<span class="string">-2</span> å†™å…¥æ•°æ® 0:21</span><br><span class="line">pool<span class="string">-1</span>-thread<span class="string">-2</span> å†™å…¥æ•°æ® 1:41</span><br><span class="line">pool<span class="string">-1</span>-thread<span class="string">-2</span> å†™å…¥æ•°æ® 2:63</span><br><span class="line">main è¯»æ•°æ® 0:21</span><br><span class="line">// ...</span><br></pre></td></tr></table></figure>

<h3 id="ReentrantReadWriteLock-çš„åŸç†"><a href="#ReentrantReadWriteLock-çš„åŸç†" class="headerlink" title="ReentrantReadWriteLock çš„åŸç†"></a>ReentrantReadWriteLock çš„åŸç†</h3><p>å‰é¢äº†è§£äº† <code>ReentrantLock</code> çš„åŸç†ï¼Œç†è§£ <code>ReentrantReadWriteLock</code> å°±å®¹æ˜“å¤šäº†ã€‚</p>
<h4 id="ReentrantReadWriteLock-çš„æ•°æ®ç»“æ„"><a href="#ReentrantReadWriteLock-çš„æ•°æ®ç»“æ„" class="headerlink" title="ReentrantReadWriteLock çš„æ•°æ®ç»“æ„"></a>ReentrantReadWriteLock çš„æ•°æ®ç»“æ„</h4><p>é˜…è¯» ReentrantReadWriteLock çš„æºç ï¼Œå¯ä»¥å‘ç°å®ƒæœ‰ä¸‰ä¸ªæ ¸å¿ƒå­—æ®µï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** Inner class providing readlock */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ReentrantReadWriteLock.ReadLock readerLock;</span><br><span class="line"><span class="comment">/** Inner class providing writelock */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ReentrantReadWriteLock.WriteLock writerLock;</span><br><span class="line"><span class="comment">/** Performs all synchronization mechanics */</span></span><br><span class="line"><span class="keyword">final</span> Sync sync;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> ReentrantReadWriteLock.WriteLock <span class="title function_">writeLock</span><span class="params">()</span> &#123; <span class="keyword">return</span> writerLock; &#125;</span><br><span class="line"><span class="keyword">public</span> ReentrantReadWriteLock.ReadLock  <span class="title function_">readLock</span><span class="params">()</span>  &#123; <span class="keyword">return</span> readerLock; &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>sync</code> - å†…éƒ¨ç±» <code>ReentrantReadWriteLock.Sync</code> å¯¹è±¡ã€‚ä¸ <code>ReentrantLock</code> ç±»ä¼¼ï¼Œå®ƒæœ‰ä¸¤ä¸ªå­ç±»ï¼š<code>ReentrantReadWriteLock.FairSync</code> å’Œ <code>ReentrantReadWriteLock.NonfairSync</code> ï¼Œåˆ†åˆ«è¡¨ç¤ºå…¬å¹³é”å’Œéå…¬å¹³é”çš„å®ç°ã€‚</li>
<li><code>readerLock</code> - å†…éƒ¨ç±» <code>ReentrantReadWriteLock.ReadLock</code> å¯¹è±¡ï¼Œè¿™æ˜¯ä¸€æŠŠè¯»é”ã€‚</li>
<li><code>writerLock</code> - å†…éƒ¨ç±» <code>ReentrantReadWriteLock.WriteLock</code> å¯¹è±¡ï¼Œè¿™æ˜¯ä¸€æŠŠå†™é”ã€‚</li>
</ul>
<h4 id="ReentrantReadWriteLock-çš„è·å–é”å’Œé‡Šæ”¾é”"><a href="#ReentrantReadWriteLock-çš„è·å–é”å’Œé‡Šæ”¾é”" class="headerlink" title="ReentrantReadWriteLock çš„è·å–é”å’Œé‡Šæ”¾é”"></a>ReentrantReadWriteLock çš„è·å–é”å’Œé‡Šæ”¾é”</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">ReadLock</span> <span class="keyword">implements</span> <span class="title class_">Lock</span>, java.io.Serializable &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è°ƒç”¨ AQS è·å–å…±äº«é”æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">lock</span><span class="params">()</span> &#123;</span><br><span class="line">        sync.acquireShared(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è°ƒç”¨ AQS é‡Šæ”¾å…±äº«é”æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">()</span> &#123;</span><br><span class="line">        sync.releaseShared(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">WriteLock</span> <span class="keyword">implements</span> <span class="title class_">Lock</span>, java.io.Serializable &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è°ƒç”¨ AQS è·å–ç‹¬å é”æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">lock</span><span class="params">()</span> &#123;</span><br><span class="line">        sync.acquire(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è°ƒç”¨ AQS é‡Šæ”¾ç‹¬å é”æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">()</span> &#123;</span><br><span class="line">        sync.release(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="StampedLock"><a href="#StampedLock" class="headerlink" title="StampedLock"></a>StampedLock</h2><p>ReadWriteLock æ”¯æŒä¸¤ç§æ¨¡å¼ï¼šä¸€ç§æ˜¯è¯»é”ï¼Œä¸€ç§æ˜¯å†™é”ã€‚è€Œ StampedLock æ”¯æŒä¸‰ç§æ¨¡å¼ï¼Œåˆ†åˆ«æ˜¯ï¼š<strong>å†™é”</strong>ã€<strong>æ‚²è§‚è¯»é”</strong>å’Œ<strong>ä¹è§‚è¯»</strong>ã€‚å…¶ä¸­ï¼Œå†™é”ã€æ‚²è§‚è¯»é”çš„è¯­ä¹‰å’Œ ReadWriteLock çš„å†™é”ã€è¯»é”çš„è¯­ä¹‰éå¸¸ç±»ä¼¼ï¼Œå…è®¸å¤šä¸ªçº¿ç¨‹åŒæ—¶è·å–æ‚²è§‚è¯»é”ï¼Œä½†æ˜¯åªå…è®¸ä¸€ä¸ªçº¿ç¨‹è·å–å†™é”ï¼Œå†™é”å’Œæ‚²è§‚è¯»é”æ˜¯äº’æ–¥çš„ã€‚ä¸åŒçš„æ˜¯ï¼šStampedLock é‡Œçš„å†™é”å’Œæ‚²è§‚è¯»é”åŠ é”æˆåŠŸä¹‹åï¼Œéƒ½ä¼šè¿”å›ä¸€ä¸ª stampï¼›ç„¶åè§£é”çš„æ—¶å€™ï¼Œéœ€è¦ä¼ å…¥è¿™ä¸ª stampã€‚</p>
<blockquote>
<p>æ³¨æ„è¿™é‡Œï¼Œç”¨çš„æ˜¯â€œä¹è§‚è¯»â€è¿™ä¸ªè¯ï¼Œè€Œä¸æ˜¯â€œä¹è§‚è¯»é”â€ï¼Œæ˜¯è¦æé†’ä½ ï¼Œ<strong>ä¹è§‚è¯»è¿™ä¸ªæ“ä½œæ˜¯æ— é”çš„</strong>ï¼Œæ‰€ä»¥ç›¸æ¯”è¾ƒ ReadWriteLock çš„è¯»é”ï¼Œä¹è§‚è¯»çš„æ€§èƒ½æ›´å¥½ä¸€äº›ã€‚</p>
</blockquote>
<p>StampedLock çš„æ€§èƒ½ä¹‹æ‰€ä»¥æ¯” ReadWriteLock è¿˜è¦å¥½ï¼Œå…¶å…³é”®æ˜¯ <strong>StampedLock æ”¯æŒä¹è§‚è¯»</strong>çš„æ–¹å¼ã€‚</p>
<ul>
<li>ReadWriteLock æ”¯æŒå¤šä¸ªçº¿ç¨‹åŒæ—¶è¯»ï¼Œä½†æ˜¯å½“å¤šä¸ªçº¿ç¨‹åŒæ—¶è¯»çš„æ—¶å€™ï¼Œæ‰€æœ‰çš„å†™æ“ä½œä¼šè¢«é˜»å¡ï¼›</li>
<li>è€Œ StampedLock æä¾›çš„ä¹è§‚è¯»ï¼Œæ˜¯å…è®¸ä¸€ä¸ªçº¿ç¨‹è·å–å†™é”çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸æ˜¯æ‰€æœ‰çš„å†™æ“ä½œéƒ½è¢«é˜»å¡ã€‚</li>
</ul>
<p>å¯¹äºè¯»å¤šå†™å°‘çš„åœºæ™¯ StampedLock æ€§èƒ½å¾ˆå¥½ï¼Œç®€å•çš„åº”ç”¨åœºæ™¯åŸºæœ¬ä¸Šå¯ä»¥æ›¿ä»£ ReadWriteLockï¼Œä½†æ˜¯ï¼Œ<strong>StampedLock çš„åŠŸèƒ½ä»…ä»…æ˜¯ ReadWriteLock çš„å­é›†</strong>ï¼Œåœ¨ä½¿ç”¨çš„æ—¶å€™ï¼Œè¿˜æ˜¯æœ‰å‡ ä¸ªåœ°æ–¹éœ€è¦æ³¨æ„ä¸€ä¸‹ã€‚</p>
<ul>
<li><strong>StampedLock ä¸æ”¯æŒé‡å…¥</strong></li>
<li>StampedLock çš„æ‚²è§‚è¯»é”ã€å†™é”éƒ½ä¸æ”¯æŒæ¡ä»¶å˜é‡ã€‚</li>
<li>å¦‚æœçº¿ç¨‹é˜»å¡åœ¨ StampedLock çš„ readLock() æˆ–è€… writeLock() ä¸Šæ—¶ï¼Œæ­¤æ—¶è°ƒç”¨è¯¥é˜»å¡çº¿ç¨‹çš„ interrupt() æ–¹æ³•ï¼Œä¼šå¯¼è‡´ CPU é£™å‡ã€‚**ä½¿ç”¨ StampedLock ä¸€å®šä¸è¦è°ƒç”¨ä¸­æ–­æ“ä½œï¼Œå¦‚æœéœ€è¦æ”¯æŒä¸­æ–­åŠŸèƒ½ï¼Œä¸€å®šä½¿ç”¨å¯ä¸­æ–­çš„æ‚²è§‚è¯»é” readLockInterruptibly() å’Œå†™é” writeLockInterruptibly()**ã€‚</li>
</ul>
<p>ã€ç¤ºä¾‹ã€‘StampedLock é˜»å¡æ—¶ï¼Œè°ƒç”¨ interrupt() å¯¼è‡´ CPU é£™å‡</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">StampedLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StampedLock</span>();</span><br><span class="line"><span class="type">Thread</span> <span class="variable">T1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">    <span class="comment">// è·å–å†™é”</span></span><br><span class="line">    lock.writeLock();</span><br><span class="line">    <span class="comment">// æ°¸è¿œé˜»å¡åœ¨æ­¤å¤„ï¼Œä¸é‡Šæ”¾å†™é”</span></span><br><span class="line">    LockSupport.park();</span><br><span class="line">&#125;);</span><br><span class="line">T1.start();</span><br><span class="line"><span class="comment">// ä¿è¯ T1 è·å–å†™é”</span></span><br><span class="line">Thread.sleep(<span class="number">100</span>);</span><br><span class="line"><span class="type">Thread</span> <span class="variable">T2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt;</span><br><span class="line">    <span class="comment">// é˜»å¡åœ¨æ‚²è§‚è¯»é”</span></span><br><span class="line">    lock.readLock()</span><br><span class="line">);</span><br><span class="line">T2.start();</span><br><span class="line"><span class="comment">// ä¿è¯ T2 é˜»å¡åœ¨è¯»é”</span></span><br><span class="line">Thread.sleep(<span class="number">100</span>);</span><br><span class="line"><span class="comment">// ä¸­æ–­çº¿ç¨‹ T2</span></span><br><span class="line"><span class="comment">// ä¼šå¯¼è‡´çº¿ç¨‹ T2 æ‰€åœ¨ CPU é£™å‡</span></span><br><span class="line">T2.interrupt();</span><br><span class="line">T2.join();</span><br></pre></td></tr></table></figure>

<p>ã€ç¤ºä¾‹ã€‘StampedLock è¯»æ¨¡æ¿ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">StampedLock</span> <span class="variable">sl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StampedLock</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¹è§‚è¯»</span></span><br><span class="line"><span class="type">long</span> <span class="variable">stamp</span> <span class="operator">=</span> sl.tryOptimisticRead();</span><br><span class="line"><span class="comment">// è¯»å…¥æ–¹æ³•å±€éƒ¨å˜é‡</span></span><br><span class="line"><span class="comment">// ......</span></span><br><span class="line"><span class="comment">// æ ¡éªŒ stamp</span></span><br><span class="line"><span class="keyword">if</span> (!sl.validate(stamp)) &#123;</span><br><span class="line">    <span class="comment">// å‡çº§ä¸ºæ‚²è§‚è¯»é”</span></span><br><span class="line">    stamp = sl.readLock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// è¯»å…¥æ–¹æ³•å±€éƒ¨å˜é‡</span></span><br><span class="line">        <span class="comment">// .....</span></span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// é‡Šæ”¾æ‚²è§‚è¯»é”</span></span><br><span class="line">        sl.unlockRead(stamp);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ä½¿ç”¨æ–¹æ³•å±€éƒ¨å˜é‡æ‰§è¡Œä¸šåŠ¡æ“ä½œ</span></span><br><span class="line"><span class="comment">// ......</span></span><br></pre></td></tr></table></figure>

<p>ã€ç¤ºä¾‹ã€‘StampedLock å†™æ¨¡æ¿ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">long</span> <span class="variable">stamp</span> <span class="operator">=</span> sl.writeLock();</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  <span class="comment">// å†™å…±äº«å˜é‡</span></span><br><span class="line">  ......</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">  sl.unlockWrite(stamp);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ul>
<li><a target="_blank" rel="noopener" href="https://book.douban.com/subject/10484692/">ã€ŠJava å¹¶å‘ç¼–ç¨‹å®æˆ˜ã€‹</a></li>
<li><a target="_blank" rel="noopener" href="https://book.douban.com/subject/26591326/">ã€ŠJava å¹¶å‘ç¼–ç¨‹çš„è‰ºæœ¯ã€‹</a></li>
<li><a target="_blank" rel="noopener" href="https://time.geekbang.org/column/intro/100023901">æå®¢æ—¶é—´æ•™ç¨‹ - Java å¹¶å‘ç¼–ç¨‹å®æˆ˜</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/dolphin0520/p/3923167.html">Java å¹¶å‘ç¼–ç¨‹ï¼šLock</a></li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/27134110">æ·±å…¥å­¦ä¹  java åŒæ­¥å™¨ AQS</a></li>
<li><a target="_blank" rel="noopener" href="https://t.hao0.me/java/2016/04/01/aqs.html">AbstractQueuedSynchronizer æ¡†æ¶</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/qifengshi/p/6831055.html">Java ä¸­çš„é”åˆ†ç±»</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://dunwu.github.io/blog/pages/f9872f67/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/uploads/avatar.gif">
      <meta itemprop="name" content="é’æ‚Ÿ â—¾ Dunwu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dunwu Blog">
      <meta itemprop="description" content="é’æ‚Ÿçš„ä¸ªäººåšå®¢">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Dunwu Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/pages/f9872f67/" class="post-title-link" itemprop="url">Java å¹¶å‘ä¹‹æ— é”</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2019-12-25 22:19:09" itemprop="dateCreated datePublished" datetime="2019-12-25T22:19:09+08:00">2019-12-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">æ›´æ–°äº</span>
      <time title="ä¿®æ”¹æ—¶é—´ï¼š2025-09-13 17:56:53" itemprop="dateModified" datetime="2025-09-13T17:56:53+08:00">2025-09-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
        </span>
          ï¼Œ
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/JavaCore/" itemprop="url" rel="index"><span itemprop="name">JavaCore</span></a>
        </span>
          ï¼Œ
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/JavaCore/%E5%B9%B6%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">å¹¶å‘</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
      <span>26k</span>
    </span>
    <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
      <span>24 åˆ†é’Ÿ</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Java-å¹¶å‘ä¹‹æ— é”"><a href="#Java-å¹¶å‘ä¹‹æ— é”" class="headerlink" title="Java å¹¶å‘ä¹‹æ— é”"></a>Java å¹¶å‘ä¹‹æ— é”</h1><p>å¹¶å‘å®‰å…¨éœ€è¦ä¿è¯å‡ ä¸ªåŸºæœ¬ç‰¹æ€§ï¼š</p>
<ul>
<li><strong>å¯è§æ€§</strong> - æ˜¯ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹äº†æŸä¸ªå…±äº«å˜é‡ï¼Œå…¶çŠ¶æ€èƒ½å¤Ÿç«‹å³è¢«å…¶ä»–çº¿ç¨‹çŸ¥æ™“ï¼Œé€šå¸¸è¢«è§£é‡Šä¸ºå°†çº¿ç¨‹æœ¬åœ°çŠ¶æ€åæ˜ åˆ°ä¸»å†…å­˜ä¸Šï¼Œ<code>volatile</code> å°±æ˜¯è´Ÿè´£ä¿è¯å¯è§æ€§çš„ã€‚</li>
<li><strong>æœ‰åºæ€§</strong> - æ˜¯ä¿è¯çº¿ç¨‹å†…ä¸²è¡Œè¯­ä¹‰ï¼Œé¿å…æŒ‡ä»¤é‡æ’ç­‰ã€‚</li>
<li><strong>åŸå­æ€§</strong> - ç®€å•è¯´å°±æ˜¯ç›¸å…³æ“ä½œä¸ä¼šä¸­é€”è¢«å…¶ä»–çº¿ç¨‹å¹²æ‰°ï¼Œä¸€èˆ¬é€šè¿‡äº’æ–¥æœºåˆ¶ï¼ˆåŠ é”ï¼š<code>sychronized</code>ã€<code>Lock</code>ï¼‰å®ç°ã€‚</li>
</ul>
<p>äº’æ–¥åŒæ­¥æ˜¯æœ€å¸¸è§çš„åŸå­æ€§ä¿éšœæ‰‹æ®µã€‚<strong>äº’æ–¥åŒæ­¥æœ€ä¸»è¦çš„é—®é¢˜æ˜¯çº¿ç¨‹é˜»å¡å’Œå”¤é†’æ‰€å¸¦æ¥çš„æ€§èƒ½é—®é¢˜</strong>ã€‚å› æ­¤ï¼Œäº’æ–¥åŒæ­¥ä¹Ÿè¢«ç§°ä¸ºé˜»å¡åŒæ­¥ã€‚äº’æ–¥åŒæ­¥å±äºä¸€ç§æ‚²è§‚çš„å¹¶å‘ç­–ç•¥ï¼Œæ€»æ˜¯è®¤ä¸ºåªè¦ä¸å»åšæ­£ç¡®çš„åŒæ­¥æªæ–½ï¼Œé‚£å°±è‚¯å®šä¼šå‡ºç°é—®é¢˜ã€‚æ— è®ºå…±äº«æ•°æ®æ˜¯å¦çœŸçš„ä¼šå‡ºç°ç«äº‰ï¼Œå®ƒéƒ½è¦è¿›è¡ŒåŠ é”ï¼ˆè¿™é‡Œè®¨è®ºçš„æ˜¯æ¦‚å¿µæ¨¡å‹ï¼Œå®é™…ä¸Šè™šæ‹Ÿæœºä¼šä¼˜åŒ–æ‰å¾ˆå¤§ä¸€éƒ¨åˆ†ä¸å¿…è¦çš„åŠ é”ï¼‰ã€ç”¨æˆ·æ€æ ¸å¿ƒæ€è½¬æ¢ã€ç»´æŠ¤é”è®¡æ•°å™¨å’Œæ£€æŸ¥æ˜¯å¦æœ‰è¢«é˜»å¡çš„çº¿ç¨‹éœ€è¦å”¤é†’ç­‰æ“ä½œã€‚</p>
<p>è§£å†³å¹¶å‘å®‰å…¨é—®é¢˜ï¼Œè¿˜å¯ä»¥é‡‡ç”¨æ— é”æ–¹æ¡ˆã€‚æ— é”æ–¹æ¡ˆç›¸å¯¹äº’æ–¥é”æ–¹æ¡ˆï¼Œæœ€å¤§çš„å¥½å¤„å°±æ˜¯æ€§èƒ½ã€‚äº’æ–¥é”æ–¹æ¡ˆä¸ºäº†ä¿è¯äº’æ–¥æ€§ï¼Œéœ€è¦æ‰§è¡ŒåŠ é”ã€è§£é”æ“ä½œï¼Œè€ŒåŠ é”ã€è§£é”æ“ä½œæœ¬èº«å°±æ¶ˆè€—æ€§èƒ½ï¼›åŒæ—¶æ‹¿ä¸åˆ°é”çš„çº¿ç¨‹è¿˜ä¼šè¿›å…¥é˜»å¡çŠ¶æ€ï¼Œè¿›è€Œè§¦å‘çº¿ç¨‹åˆ‡æ¢ï¼Œçº¿ç¨‹åˆ‡æ¢å¯¹æ€§èƒ½çš„æ¶ˆè€—ä¹Ÿå¾ˆå¤§ã€‚ ç›¸æ¯”ä¹‹ä¸‹ï¼Œæ— é”æ–¹æ¡ˆåˆ™å®Œå…¨æ²¡æœ‰åŠ é”ã€è§£é”çš„æ€§èƒ½æ¶ˆè€—ï¼ŒåŒæ—¶è¿˜èƒ½ä¿è¯äº’æ–¥æ€§ã€‚</p>
<p>Java ä¸­çš„æ— é”æŠ€æœ¯æœ‰ï¼š</p>
<ul>
<li>CAS</li>
<li>åŸå­ç±»</li>
<li>ThreadLocal</li>
<li>Copy-on-Write</li>
<li>ä¸å˜æ¨¡å¼</li>
</ul>
<h2 id="CAS"><a href="#CAS" class="headerlink" title="CAS"></a>CAS</h2><h3 id="CAS-çš„è¦ç‚¹"><a href="#CAS-çš„è¦ç‚¹" class="headerlink" title="CAS çš„è¦ç‚¹"></a>CAS çš„è¦ç‚¹</h3><p><strong>CASï¼ˆCompare and Swapï¼‰ï¼Œå­—é¢æ„æ€ä¸ºæ¯”è¾ƒå¹¶äº¤æ¢ã€‚</strong></p>
<p>CAS æ¶‰åŠä¸‰ä¸ªæ“ä½œæ•°ï¼š</p>
<ul>
<li>Vï¼šéœ€è¦è¯»å†™çš„å†…å­˜ä½ç½®</li>
<li>Aï¼šè¿›è¡Œæ¯”è¾ƒçš„å€¼</li>
<li>Bï¼šæ‹Ÿå†™å…¥çš„æ–°å€¼</li>
</ul>
<p><strong>å½“ä¸”ä»…å½“ V çš„å€¼ç­‰äº A æ—¶ï¼Œæ‰ä¼šé€šè¿‡åŸå­æ–¹å¼ç”¨æ–°å€¼ B æ¥æ›´æ–° A çš„å€¼ï¼Œå¦åˆ™ä»€ä¹ˆéƒ½ä¸åš</strong>ã€‚</p>
<p>CAS å®é™…æ˜¯ä¹è§‚é”çš„ä¸€ç§å®ç°æ–¹å¼ï¼Œå› æ­¤ï¼Œ<strong>CAS åªé€‚ç”¨äºçº¿ç¨‹å†²çªè¾ƒå°‘çš„æƒ…å†µ</strong>ã€‚</p>
<h3 id="CAS-çš„åº”ç”¨"><a href="#CAS-çš„åº”ç”¨" class="headerlink" title="CAS çš„åº”ç”¨"></a>CAS çš„åº”ç”¨</h3><p>CAS çš„å…¸å‹åº”ç”¨åœºæ™¯æ˜¯ï¼š</p>
<ul>
<li>åŸå­ç±»</li>
<li>è‡ªæ—‹é”</li>
</ul>
<h4 id="åŸå­ç±»"><a href="#åŸå­ç±»" class="headerlink" title="åŸå­ç±»"></a>åŸå­ç±»</h4><blockquote>
<p>åŸå­ç±»æ˜¯ CAS åœ¨ Java ä¸­æœ€å…¸å‹çš„åº”ç”¨ã€‚</p>
</blockquote>
<p>æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸ªå¸¸è§çš„ä»£ç ç‰‡æ®µã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(a==b) &#123;</span><br><span class="line">    a++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¦‚æœ <code>a++</code> æ‰§è¡Œå‰ï¼Œ a çš„å€¼è¢«ä¿®æ”¹äº†æ€ä¹ˆåŠï¼Ÿè¿˜èƒ½å¾—åˆ°é¢„æœŸå€¼å—ï¼Ÿå‡ºç°è¯¥é—®é¢˜çš„åŸå› æ˜¯åœ¨å¹¶å‘ç¯å¢ƒä¸‹ï¼Œä»¥ä¸Šä»£ç ç‰‡æ®µä¸æ˜¯åŸå­æ“ä½œï¼Œéšæ—¶å¯èƒ½è¢«å…¶ä»–çº¿ç¨‹æ‰€ç¯¡æ”¹ã€‚</p>
<p>è§£å†³è¿™ç§é—®é¢˜çš„æœ€ç»å…¸æ–¹å¼æ˜¯åº”ç”¨åŸå­ç±»çš„ <code>incrementAndGet</code> æ–¹æ³•ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AtomicIntegerDemo</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">ExecutorService</span> <span class="variable">executorService</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">3</span>);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">AtomicInteger</span> <span class="variable">count</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">            executorService.execute(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                    count.incrementAndGet();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        executorService.shutdown();</span><br><span class="line">        executorService.awaitTermination(<span class="number">3</span>, TimeUnit.SECONDS);</span><br><span class="line">        System.out.println(<span class="string">&quot;Final Count is : &quot;</span> + count.get());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>J.U.C åŒ…ä¸­æä¾›äº† <code>AtomicBoolean</code>ã€<code>AtomicInteger</code>ã€<code>AtomicLong</code> åˆ†åˆ«é’ˆå¯¹ <code>Boolean</code>ã€<code>Integer</code>ã€<code>Long</code> æ‰§è¡ŒåŸå­æ“ä½œï¼Œæ“ä½œå’Œä¸Šé¢çš„ç¤ºä¾‹å¤§ä½“ç›¸ä¼¼ï¼Œä¸åšèµ˜è¿°ã€‚</p>
<h4 id="è‡ªæ—‹é”"><a href="#è‡ªæ—‹é”" class="headerlink" title="è‡ªæ—‹é”"></a>è‡ªæ—‹é”</h4><p>åˆ©ç”¨åŸå­ç±»ï¼ˆæœ¬è´¨ä¸Šæ˜¯ CASï¼‰ï¼Œå¯ä»¥å®ç°è‡ªæ—‹é”ã€‚</p>
<p>æ‰€è°“è‡ªæ—‹é”ï¼Œæ˜¯æŒ‡çº¿ç¨‹åå¤æ£€æŸ¥é”å˜é‡æ˜¯å¦å¯ç”¨ï¼Œç›´åˆ°æˆåŠŸä¸ºæ­¢ã€‚ç”±äºçº¿ç¨‹åœ¨è¿™ä¸€è¿‡ç¨‹ä¸­ä¿æŒæ‰§è¡Œï¼Œå› æ­¤æ˜¯ä¸€ç§å¿™ç­‰å¾…ã€‚ä¸€æ—¦è·å–äº†è‡ªæ—‹é”ï¼Œçº¿ç¨‹ä¼šä¸€ç›´ä¿æŒè¯¥é”ï¼Œç›´è‡³æ˜¾å¼é‡Šæ”¾è‡ªæ—‹é”ã€‚</p>
<p>ç¤ºä¾‹ï¼šéçº¿ç¨‹å®‰å…¨ç¤ºä¾‹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AtomicReferenceDemo</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">ticket</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">ExecutorService</span> <span class="variable">executorService</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">3</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">            executorService.execute(<span class="keyword">new</span> <span class="title class_">MyThread</span>());</span><br><span class="line">        &#125;</span><br><span class="line">        executorService.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MyThread</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (ticket &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                System.out.println(Thread.currentThread().getName() + <span class="string">&quot; å–å‡ºäº†ç¬¬ &quot;</span> + ticket + <span class="string">&quot; å¼ ç¥¨&quot;</span>);</span><br><span class="line">                ticket--;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¾“å‡ºç»“æœï¼š</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">pool</span>-<span class="number">1</span>-thread-<span class="number">2</span> å–å‡ºäº†ç¬¬ <span class="number">10</span> å¼ ç¥¨</span><br><span class="line"><span class="attribute">pool</span>-<span class="number">1</span>-thread-<span class="number">1</span> å–å‡ºäº†ç¬¬ <span class="number">10</span> å¼ ç¥¨</span><br><span class="line"><span class="attribute">pool</span>-<span class="number">1</span>-thread-<span class="number">3</span> å–å‡ºäº†ç¬¬ <span class="number">10</span> å¼ ç¥¨</span><br><span class="line"><span class="attribute">pool</span>-<span class="number">1</span>-thread-<span class="number">1</span> å–å‡ºäº†ç¬¬ <span class="number">8</span> å¼ ç¥¨</span><br><span class="line"><span class="attribute">pool</span>-<span class="number">1</span>-thread-<span class="number">2</span> å–å‡ºäº†ç¬¬ <span class="number">9</span> å¼ ç¥¨</span><br><span class="line"><span class="attribute">pool</span>-<span class="number">1</span>-thread-<span class="number">1</span> å–å‡ºäº†ç¬¬ <span class="number">6</span> å¼ ç¥¨</span><br><span class="line"><span class="attribute">pool</span>-<span class="number">1</span>-thread-<span class="number">3</span> å–å‡ºäº†ç¬¬ <span class="number">7</span> å¼ ç¥¨</span><br><span class="line"><span class="attribute">pool</span>-<span class="number">1</span>-thread-<span class="number">1</span> å–å‡ºäº†ç¬¬ <span class="number">4</span> å¼ ç¥¨</span><br><span class="line"><span class="attribute">pool</span>-<span class="number">1</span>-thread-<span class="number">2</span> å–å‡ºäº†ç¬¬ <span class="number">5</span> å¼ ç¥¨</span><br><span class="line"><span class="attribute">pool</span>-<span class="number">1</span>-thread-<span class="number">1</span> å–å‡ºäº†ç¬¬ <span class="number">2</span> å¼ ç¥¨</span><br><span class="line"><span class="attribute">pool</span>-<span class="number">1</span>-thread-<span class="number">3</span> å–å‡ºäº†ç¬¬ <span class="number">3</span> å¼ ç¥¨</span><br><span class="line"><span class="attribute">pool</span>-<span class="number">1</span>-thread-<span class="number">2</span> å–å‡ºäº†ç¬¬ <span class="number">1</span> å¼ ç¥¨</span><br></pre></td></tr></table></figure>

<p>å¾ˆæ˜æ˜¾ï¼Œå‡ºç°äº†é‡å¤å”®ç¥¨çš„æƒ…å†µã€‚</p>
<p>ã€ç¤ºä¾‹ã€‘ä½¿ç”¨è‡ªæ—‹é”æ¥ä¿è¯çº¿ç¨‹å®‰å…¨</p>
<p>å¯ä»¥é€šè¿‡è‡ªæ—‹é”è¿™ç§éé˜»å¡åŒæ­¥æ¥ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œä¸‹é¢ä½¿ç”¨ <code>AtomicReference</code> æ¥å®ç°ä¸€ä¸ªè‡ªæ—‹é”ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AtomicReferenceDemo2</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">ticket</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        threadSafeDemo();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">threadSafeDemo</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">SpinLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SpinLock</span>();</span><br><span class="line">        <span class="type">ExecutorService</span> <span class="variable">executorService</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">3</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">            executorService.execute(<span class="keyword">new</span> <span class="title class_">MyThread</span>(lock));</span><br><span class="line">        &#125;</span><br><span class="line">        executorService.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">SpinLock</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> AtomicReference&lt;Thread&gt; atomicReference = <span class="keyword">new</span> <span class="title class_">AtomicReference</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">lock</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="type">Thread</span> <span class="variable">current</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">            <span class="keyword">while</span> (!atomicReference.compareAndSet(<span class="literal">null</span>, current)) &#123;&#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="type">Thread</span> <span class="variable">current</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">            atomicReference.compareAndSet(current, <span class="literal">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MyThread</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> SpinLock lock;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">MyThread</span><span class="params">(SpinLock lock)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.lock = lock;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (ticket &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                lock.lock();</span><br><span class="line">                <span class="keyword">if</span> (ticket &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    System.out.println(Thread.currentThread().getName() + <span class="string">&quot; å–å‡ºäº†ç¬¬ &quot;</span> + ticket + <span class="string">&quot; å¼ ç¥¨&quot;</span>);</span><br><span class="line">                    ticket--;</span><br><span class="line">                &#125;</span><br><span class="line">                lock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¾“å‡ºç»“æœï¼š</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">pool</span>-<span class="number">1</span>-thread-<span class="number">2</span> å–å‡ºäº†ç¬¬ <span class="number">10</span> å¼ ç¥¨</span><br><span class="line"><span class="attribute">pool</span>-<span class="number">1</span>-thread-<span class="number">1</span> å–å‡ºäº†ç¬¬ <span class="number">9</span> å¼ ç¥¨</span><br><span class="line"><span class="attribute">pool</span>-<span class="number">1</span>-thread-<span class="number">3</span> å–å‡ºäº†ç¬¬ <span class="number">8</span> å¼ ç¥¨</span><br><span class="line"><span class="attribute">pool</span>-<span class="number">1</span>-thread-<span class="number">2</span> å–å‡ºäº†ç¬¬ <span class="number">7</span> å¼ ç¥¨</span><br><span class="line"><span class="attribute">pool</span>-<span class="number">1</span>-thread-<span class="number">3</span> å–å‡ºäº†ç¬¬ <span class="number">6</span> å¼ ç¥¨</span><br><span class="line"><span class="attribute">pool</span>-<span class="number">1</span>-thread-<span class="number">1</span> å–å‡ºäº†ç¬¬ <span class="number">5</span> å¼ ç¥¨</span><br><span class="line"><span class="attribute">pool</span>-<span class="number">1</span>-thread-<span class="number">2</span> å–å‡ºäº†ç¬¬ <span class="number">4</span> å¼ ç¥¨</span><br><span class="line"><span class="attribute">pool</span>-<span class="number">1</span>-thread-<span class="number">1</span> å–å‡ºäº†ç¬¬ <span class="number">3</span> å¼ ç¥¨</span><br><span class="line"><span class="attribute">pool</span>-<span class="number">1</span>-thread-<span class="number">3</span> å–å‡ºäº†ç¬¬ <span class="number">2</span> å¼ ç¥¨</span><br><span class="line"><span class="attribute">pool</span>-<span class="number">1</span>-thread-<span class="number">1</span> å–å‡ºäº†ç¬¬ <span class="number">1</span> å¼ ç¥¨</span><br></pre></td></tr></table></figure>

<h3 id="CAS-çš„åŸç†"><a href="#CAS-çš„åŸç†" class="headerlink" title="CAS çš„åŸç†"></a>CAS çš„åŸç†</h3><p><strong>åœ¨ Java ä¸­ï¼Œä¸»è¦åˆ©ç”¨ <code>Unsafe</code> è¿™ä¸ªç±»å®ç° CAS</strong>ã€‚</p>
<p><code>Unsafe</code> ç±»ä½äº <code>sun.misc</code> åŒ…ä¸‹ï¼Œæ˜¯ä¸€ä¸ªæä¾›ä½çº§åˆ«ã€ä¸å®‰å…¨æ“ä½œçš„ç±»ã€‚ç”±äºå…¶å¼ºå¤§çš„åŠŸèƒ½å’Œæ½œåœ¨çš„å±é™©æ€§ï¼Œå®ƒé€šå¸¸ç”¨äº JVM å†…éƒ¨æˆ–ä¸€äº›éœ€è¦æé«˜æ€§èƒ½å’Œåº•å±‚è®¿é—®çš„åº“ä¸­ï¼Œè€Œä¸æ¨èæ™®é€šå¼€å‘è€…åœ¨åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨ã€‚</p>
<p><code>Unsafe</code> ç±»æä¾›äº† <code>compareAndSwapObject</code>ã€<code>compareAndSwapInt</code>ã€<code>compareAndSwapLong</code>æ–¹æ³•æ¥å®ç°çš„å¯¹ <code>Object</code>ã€<code>int</code>ã€<code>long </code> ç±»å‹çš„ CAS æ“ä½œï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ä»¥åŸå­æ–¹å¼æ›´æ–°å¯¹è±¡å­—æ®µçš„å€¼ã€‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">boolean</span> <span class="title function_">compareAndSwapObject</span><span class="params">(Object o, <span class="type">long</span> offset, Object expected, Object x)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ä»¥åŸå­æ–¹å¼æ›´æ–° int ç±»å‹çš„å¯¹è±¡å­—æ®µçš„å€¼ã€‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">boolean</span> <span class="title function_">compareAndSwapInt</span><span class="params">(Object o, <span class="type">long</span> offset, <span class="type">int</span> expected, <span class="type">int</span> x)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ä»¥åŸå­æ–¹å¼æ›´æ–° long ç±»å‹çš„å¯¹è±¡å­—æ®µçš„å€¼ã€‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">boolean</span> <span class="title function_">compareAndSwapLong</span><span class="params">(Object o, <span class="type">long</span> offset, <span class="type">long</span> expected, <span class="type">long</span> x)</span>;</span><br></pre></td></tr></table></figure>

<p><code>Unsafe</code> ç±»ä¸­çš„ CAS æ–¹æ³•æ˜¯ <code>native</code> æ–¹æ³•ã€‚<code>native </code>å…³é”®å­—è¡¨æ˜è¿™äº›æ–¹æ³•æ˜¯ç”¨æœ¬åœ°ä»£ç ï¼ˆé€šå¸¸æ˜¯ C æˆ– C++ï¼‰å®ç°çš„ï¼Œè€Œä¸æ˜¯ç”¨ Java å®ç°çš„ã€‚è¿™äº›æ–¹æ³•ç›´æ¥è°ƒç”¨åº•å±‚çš„ã€å…·æœ‰åŸå­æ€§çš„ CPU æŒ‡ä»¤æ¥å®ç°ã€‚</p>
<p>ç”±äº CAS æ“ä½œå¯èƒ½ä¼šå› ä¸ºå¹¶å‘å†²çªè€Œå¤±è´¥ï¼Œå› æ­¤é€šå¸¸ä¼šä¼´éšç€è‡ªæ—‹ï¼Œè€Œæ‰€è°“è‡ªæ—‹ï¼Œå…¶å®å°±æ˜¯å¾ªç¯å°è¯•ã€‚</p>
<p><code>Unsafe#getAndAddInt</code> æºç ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åŸå­åœ°è·å–å¹¶å¢åŠ æ•´æ•°å€¼</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">getAndAddInt</span><span class="params">(Object o, <span class="type">long</span> offset, <span class="type">int</span> delta)</span> &#123;</span><br><span class="line">    <span class="type">int</span> v;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="comment">// ä»¥ volatile æ–¹å¼è·å–å¯¹è±¡ o åœ¨å†…å­˜åç§»é‡ offset å¤„çš„æ•´æ•°å€¼</span></span><br><span class="line">        v = getIntVolatile(o, offset);</span><br><span class="line">    &#125; <span class="keyword">while</span> (!compareAndSwapInt(o, offset, v, v + delta));</span><br><span class="line">    <span class="comment">// è¿”å›æ—§å€¼</span></span><br><span class="line">    <span class="keyword">return</span> v;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="CAS-çš„é—®é¢˜"><a href="#CAS-çš„é—®é¢˜" class="headerlink" title="CAS çš„é—®é¢˜"></a>CAS çš„é—®é¢˜</h3><p>ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œ<strong>CAS æ¯”é”æ€§èƒ½æ›´é«˜</strong>ã€‚å› ä¸º CAS æ˜¯ä¸€ç§éé˜»å¡ç®—æ³•ï¼Œæ‰€ä»¥å…¶é¿å…äº†çº¿ç¨‹é˜»å¡å’Œå”¤é†’çš„ç­‰å¾…æ—¶é—´ã€‚ä½†æ˜¯ï¼Œäº‹ç‰©æ€»ä¼šæœ‰åˆ©æœ‰å¼Šï¼ŒCAS ä¹Ÿå­˜åœ¨ä¸‰å¤§é—®é¢˜ï¼š</p>
<ul>
<li><strong>ABA é—®é¢˜</strong></li>
<li><strong>å¾ªç¯æ—¶é—´é•¿å¼€é”€å¤§</strong></li>
<li><strong>åªèƒ½ä¿è¯ä¸€ä¸ªå…±äº«å˜é‡çš„åŸå­æ€§</strong></li>
</ul>
<h4 id="ABA-é—®é¢˜"><a href="#ABA-é—®é¢˜" class="headerlink" title="ABA é—®é¢˜"></a>ABA é—®é¢˜</h4><p>å¦‚æœä¸€ä¸ªå˜é‡åˆæ¬¡è¯»å–çš„æ—¶å€™æ˜¯ A å€¼ï¼Œå®ƒçš„å€¼è¢«æ”¹æˆäº† Bï¼Œåæ¥åˆè¢«æ”¹å›ä¸º Aï¼Œé‚£ CAS æ“ä½œå°±ä¼šè¯¯è®¤ä¸ºå®ƒä»æ¥æ²¡æœ‰è¢«æ”¹å˜è¿‡ï¼Œè¿™å°±æ˜¯ <strong>ABA é—®é¢˜</strong>ã€‚</p>
<p>ABA é—®é¢˜çš„è§£å†³æ€è·¯æ˜¯åœ¨å˜é‡å‰é¢è¿½åŠ ä¸Š<strong>ç‰ˆæœ¬å·æˆ–è€…æ—¶é—´æˆ³</strong>ã€‚J.U.C åŒ…æä¾›äº†ä¸€ä¸ªå¸¦æœ‰æ ‡è®°çš„<strong>åŸå­å¼•ç”¨ç±» <code>AtomicStampedReference</code> æ¥è§£å†³è¿™ä¸ªé—®é¢˜</strong>ï¼Œå®ƒå¯ä»¥é€šè¿‡æ§åˆ¶å˜é‡å€¼çš„ç‰ˆæœ¬æ¥ä¿è¯ CAS çš„æ­£ç¡®æ€§ã€‚å¤§éƒ¨åˆ†æƒ…å†µä¸‹ ABA é—®é¢˜ä¸ä¼šå½±å“ç¨‹åºå¹¶å‘çš„æ­£ç¡®æ€§ï¼Œå¦‚æœéœ€è¦è§£å†³ ABA é—®é¢˜ï¼Œæ”¹ç”¨<strong>ä¼ ç»Ÿçš„äº’æ–¥åŒæ­¥å¯èƒ½ä¼šæ¯”åŸå­ç±»æ›´é«˜æ•ˆ</strong>ã€‚</p>
<h4 id="å¾ªç¯æ—¶é—´é•¿å¼€é”€å¤§"><a href="#å¾ªç¯æ—¶é—´é•¿å¼€é”€å¤§" class="headerlink" title="å¾ªç¯æ—¶é—´é•¿å¼€é”€å¤§"></a>å¾ªç¯æ—¶é—´é•¿å¼€é”€å¤§</h4><p><strong>è‡ªæ—‹ CAS ï¼ˆä¸æ–­å°è¯•ï¼Œç›´åˆ°æˆåŠŸä¸ºæ­¢ï¼‰å¦‚æœé•¿æ—¶é—´ä¸æˆåŠŸï¼Œä¼šç»™ CPU å¸¦æ¥éå¸¸å¤§çš„æ‰§è¡Œå¼€é”€</strong>ã€‚</p>
<p>å¦‚æœ JVM èƒ½æ”¯æŒå¤„ç†å™¨æä¾›çš„ <code>pause</code> æŒ‡ä»¤é‚£ä¹ˆæ•ˆç‡ä¼šæœ‰ä¸€å®šçš„æå‡ï¼Œ<code>pause</code> æŒ‡ä»¤æœ‰ä¸¤ä¸ªä½œç”¨ï¼š</p>
<ul>
<li>å®ƒå¯ä»¥å»¶è¿Ÿæµæ°´çº¿æ‰§è¡ŒæŒ‡ä»¤ï¼ˆde-pipelineï¼‰, ä½¿ CPU ä¸ä¼šæ¶ˆè€—è¿‡å¤šçš„æ‰§è¡Œèµ„æºï¼Œå»¶è¿Ÿçš„æ—¶é—´å–å†³äºå…·ä½“å®ç°çš„ç‰ˆæœ¬ï¼Œåœ¨ä¸€äº›å¤„ç†å™¨ä¸Šå»¶è¿Ÿæ—¶é—´æ˜¯é›¶ã€‚</li>
<li>å®ƒå¯ä»¥é¿å…åœ¨é€€å‡ºå¾ªç¯çš„æ—¶å€™å› å†…å­˜é¡ºåºå†²çªï¼ˆmemory order violationï¼‰è€Œå¼•èµ· CPU æµæ°´çº¿è¢«æ¸…ç©ºï¼ˆCPU pipeline flushï¼‰ï¼Œä»è€Œæé«˜ CPU çš„æ‰§è¡Œæ•ˆç‡ã€‚</li>
</ul>
<p>æ¯”è¾ƒèŠ±è´¹ CPU èµ„æºï¼Œå³ä½¿æ²¡æœ‰ä»»ä½•ç”¨ä¹Ÿä¼šåšä¸€äº›æ— ç”¨åŠŸã€‚</p>
<h4 id="åªèƒ½ä¿è¯ä¸€ä¸ªå…±äº«å˜é‡çš„åŸå­æ€§"><a href="#åªèƒ½ä¿è¯ä¸€ä¸ªå…±äº«å˜é‡çš„åŸå­æ€§" class="headerlink" title="åªèƒ½ä¿è¯ä¸€ä¸ªå…±äº«å˜é‡çš„åŸå­æ€§"></a>åªèƒ½ä¿è¯ä¸€ä¸ªå…±äº«å˜é‡çš„åŸå­æ€§</h4><p>å½“å¯¹ä¸€ä¸ªå…±äº«å˜é‡æ‰§è¡Œæ“ä½œæ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¾ªç¯ CAS çš„æ–¹å¼æ¥ä¿è¯åŸå­æ“ä½œï¼Œä½†æ˜¯å¯¹å¤šä¸ªå…±äº«å˜é‡æ“ä½œæ—¶ï¼Œå¾ªç¯ CAS å°±æ— æ³•ä¿è¯æ“ä½œçš„åŸå­æ€§ï¼Œè¿™ä¸ªæ—¶å€™å°±å¯ä»¥ç”¨é”ã€‚</p>
<p>æˆ–è€…æœ‰ä¸€ä¸ªå–å·§çš„åŠæ³•ï¼Œå°±æ˜¯æŠŠå¤šä¸ªå…±äº«å˜é‡åˆå¹¶æˆä¸€ä¸ªå…±äº«å˜é‡æ¥æ“ä½œã€‚æ¯”å¦‚æœ‰ä¸¤ä¸ªå…±äº«å˜é‡ <code>i ï¼ 2, j = a</code>ï¼Œåˆå¹¶ä¸€ä¸‹ <code>ij=2a</code>ï¼Œç„¶åç”¨ CAS æ¥æ“ä½œ <code>ij</code>ã€‚ä» Java 1.5 å¼€å§‹ JDK æä¾›äº† <code>AtomicReference</code> ç±»æ¥ä¿è¯å¼•ç”¨å¯¹è±¡ä¹‹é—´çš„åŸå­æ€§ï¼Œä½ å¯ä»¥æŠŠå¤šä¸ªå˜é‡æ”¾åœ¨ä¸€ä¸ªå¯¹è±¡é‡Œæ¥è¿›è¡Œ CAS æ“ä½œã€‚</p>
<h2 id="åŸå­ç±»-1"><a href="#åŸå­ç±»-1" class="headerlink" title="åŸå­ç±»"></a>åŸå­ç±»</h2><h3 id="åŸå­ç±»ç®€ä»‹"><a href="#åŸå­ç±»ç®€ä»‹" class="headerlink" title="åŸå­ç±»ç®€ä»‹"></a>åŸå­ç±»ç®€ä»‹</h3><p>åŸå­æ€§æ˜¯ç¡®ä¿å¹¶å‘å®‰å…¨ä¸‰å¤§ç‰¹æ€§ä¹‹ä¸€ã€‚ä¸ºäº†å…¼é¡¾åŸå­æ€§ä»¥åŠé”å¸¦æ¥çš„æ€§èƒ½é—®é¢˜ï¼ŒJava å¼•å…¥äº† CAS ï¼ˆä¸»è¦ä½“ç°åœ¨ <code>Unsafe</code> ç±»ï¼‰æ¥å®ç°éé˜»å¡åŒæ­¥ï¼ˆä¹Ÿå«ä¹è§‚é”ï¼‰ï¼ŒCAS åº•å±‚åŸºäº CPU æŒ‡ä»¤ï¼ˆç¡¬ä»¶æ”¯æŒï¼‰æ”¯æŒï¼Œå…·æœ‰åŸå­æ€§ã€‚å¹¶åŸºäº CAS ï¼Œæä¾›äº†ä¸€å¥—åŸå­å·¥å…·ç±»ã€‚</p>
<p>åŸå­ç±»<strong>æ¯”é”çš„ç²’åº¦æ›´ç»†ï¼Œæ›´è½»é‡çº§</strong>ï¼Œå¹¶ä¸”å¯¹äºåœ¨å¤šå¤„ç†å™¨ç³»ç»Ÿä¸Šå®ç°é«˜æ€§èƒ½çš„å¹¶å‘ä»£ç æ¥è¯´æ˜¯éå¸¸å…³é”®çš„ã€‚åŸå­å˜é‡å°†å‘ç”Ÿç«äº‰çš„èŒƒå›´ç¼©å°åˆ°å•ä¸ªå˜é‡ä¸Šã€‚</p>
<p>åŸå­ç±»ç›¸å½“äºä¸€ç§æ³›åŒ–çš„ <code>volatile</code> å˜é‡ï¼Œèƒ½å¤Ÿ<strong>æ”¯æŒåŸå­çš„ã€æœ‰æ¡ä»¶çš„è¯»&#x2F;æ”¹&#x2F;å†™æ“</strong>ä½œã€‚</p>
<p>åŸå­ç±»å¯ä»¥åˆ†ä¸º 5 ä¸ªç±»åˆ«ï¼Œè¿™ 5 ä¸ªç±»åˆ«æä¾›çš„æ–¹æ³•åŸºæœ¬ä¸Šæ˜¯ç›¸ä¼¼çš„ï¼š</p>
<ul>
<li><strong>åŸºæœ¬æ•°æ®ç±»å‹</strong><ul>
<li><code>AtomicBoolean</code> - å¸ƒå°”ç±»å‹åŸå­ç±»</li>
<li><code>AtomicInteger</code> - æ•´å‹åŸå­ç±»</li>
<li><code>AtomicLong</code> - é•¿æ•´å‹åŸå­ç±»</li>
</ul>
</li>
<li><strong>å¼•ç”¨æ•°æ®ç±»å‹</strong><ul>
<li><code>AtomicReference</code> - å¼•ç”¨ç±»å‹åŸå­ç±»</li>
<li><code>AtomicMarkableReference</code> - å¸¦æœ‰æ ‡è®°ä½çš„å¼•ç”¨ç±»å‹åŸå­ç±»</li>
<li><code>AtomicStampedReference</code> - å¸¦æœ‰ç‰ˆæœ¬å·çš„å¼•ç”¨ç±»å‹åŸå­ç±»</li>
</ul>
</li>
<li><strong>æ•°ç»„æ•°æ®ç±»å‹</strong><ul>
<li><code>AtomicIntegerArray</code> - æ•´å½¢æ•°ç»„åŸå­ç±»</li>
<li><code>AtomicLongArray</code> - é•¿æ•´å‹æ•°ç»„åŸå­ç±»</li>
<li><code>AtomicReferenceArray</code> - å¼•ç”¨ç±»å‹æ•°ç»„åŸå­ç±»</li>
</ul>
</li>
<li><strong>å±æ€§æ›´æ–°å™¨ç±»å‹</strong><ul>
<li><code>AtomicIntegerFieldUpdater</code> - æ•´å‹å­—æ®µçš„åŸå­æ›´æ–°å™¨</li>
<li><code>AtomicLongFieldUpdater</code> - é•¿æ•´å‹å­—æ®µçš„åŸå­æ›´æ–°å™¨</li>
<li><code>AtomicReferenceFieldUpdater</code> - åŸå­æ›´æ–°å¼•ç”¨ç±»å‹é‡Œçš„å­—æ®µ</li>
</ul>
</li>
<li>ç´¯åŠ å™¨<ul>
<li><code>DoubleAdder</code> - æµ®ç‚¹å‹åŸå­ç´¯åŠ å™¨</li>
<li><code>LongAdder</code> - é•¿æ•´å‹åŸå­ç´¯åŠ å™¨</li>
<li><code>DoubleAccumulator</code> - æ›´å¤æ‚çš„æµ®ç‚¹å‹åŸå­ç´¯åŠ å™¨</li>
<li><code>LongAccumulator</code> - æ›´å¤æ‚çš„é•¿æ•´å‹åŸå­ç´¯åŠ å™¨</li>
</ul>
</li>
</ul>
<h3 id="åŸå­ç±»ä¹‹åŸºæœ¬æ•°æ®ç±»å‹"><a href="#åŸå­ç±»ä¹‹åŸºæœ¬æ•°æ®ç±»å‹" class="headerlink" title="åŸå­ç±»ä¹‹åŸºæœ¬æ•°æ®ç±»å‹"></a>åŸå­ç±»ä¹‹åŸºæœ¬æ•°æ®ç±»å‹</h3><p><strong>åŸºæœ¬æ•°æ®ç±»å‹åŸå­ç±»é’ˆå¯¹ Java åŸºæœ¬ç±»å‹æä¾›åŸå­æ“ä½œ</strong>ã€‚</p>
<ul>
<li><code>AtomicBoolean</code> - å¸ƒå°”ç±»å‹åŸå­ç±»</li>
<li><code>AtomicInteger</code> - æ•´å‹åŸå­ç±»</li>
<li><code>AtomicLong</code> - é•¿æ•´å‹åŸå­ç±»</li>
</ul>
<p>ä»¥ä¸Šç±»éƒ½æ”¯æŒ CASï¼ˆ<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Compare-and-swap">compare-and-swap</a>ï¼‰æŠ€æœ¯ï¼Œæ­¤å¤–ï¼Œ<code>AtomicInteger</code>ã€<code>AtomicLong</code> è¿˜æ”¯æŒç®—æœ¯è¿ç®—ã€‚</p>
<blockquote>
<p>:bulb: æç¤ºï¼š</p>
<p>è™½ç„¶ Java åªæä¾›äº† <code>AtomicBoolean</code> ã€<code>AtomicInteger</code>ã€<code>AtomicLong</code>ï¼Œä½†æ˜¯å¯ä»¥æ¨¡æ‹Ÿå…¶ä»–åŸºæœ¬ç±»å‹çš„åŸå­å˜é‡ã€‚è¦æƒ³æ¨¡æ‹Ÿå…¶ä»–åŸºæœ¬ç±»å‹çš„åŸå­å˜é‡ï¼Œå¯ä»¥å°† <code>short</code> æˆ– <code>byte</code> ç­‰ç±»å‹ä¸ <code>int</code> ç±»å‹è¿›è¡Œè½¬æ¢ï¼Œä»¥åŠä½¿ç”¨ <code>Float.floatToIntBits</code> ã€<code>Double.doubleToLongBits</code> æ¥è½¬æ¢æµ®ç‚¹æ•°ã€‚</p>
<p>ç”±äº <code>AtomicBoolean</code>ã€<code>AtomicInteger</code>ã€<code>AtomicLong</code> å®ç°æ–¹å¼ã€ä½¿ç”¨æ–¹å¼éƒ½ç›¸è¿‘ï¼Œæ‰€ä»¥æœ¬æ–‡ä»…é’ˆå¯¹ <code>AtomicInteger</code> è¿›è¡Œä»‹ç»ã€‚</p>
</blockquote>
<h4 id="AtomicInteger-ç”¨æ³•"><a href="#AtomicInteger-ç”¨æ³•" class="headerlink" title="AtomicInteger ç”¨æ³•"></a><strong><code>AtomicInteger</code> ç”¨æ³•</strong></h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">get</span><span class="params">()</span> <span class="comment">// è·å–å½“å‰å€¼</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">getAndSet</span><span class="params">(<span class="type">int</span> newValue)</span> <span class="comment">// è·å–å½“å‰å€¼ï¼Œå¹¶è®¾ç½®æ–°å€¼</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">getAndIncrement</span><span class="params">()</span><span class="comment">// è·å–å½“å‰å€¼ï¼Œå¹¶è‡ªå¢</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">getAndDecrement</span><span class="params">()</span> <span class="comment">// è·å–å½“å‰å€¼ï¼Œå¹¶è‡ªå‡</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">getAndAdd</span><span class="params">(<span class="type">int</span> delta)</span> <span class="comment">// è·å–å½“å‰å€¼ï¼Œå¹¶åŠ ä¸Šé¢„æœŸå€¼</span></span><br><span class="line"><span class="type">boolean</span> <span class="title function_">compareAndSet</span><span class="params">(<span class="type">int</span> expect, <span class="type">int</span> update)</span> <span class="comment">// å¦‚æœè¾“å…¥å€¼ï¼ˆupdateï¼‰ç­‰äºé¢„æœŸå€¼ï¼Œå°†è¯¥å€¼è®¾ç½®ä¸ºè¾“å…¥å€¼</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">lazySet</span><span class="params">(<span class="type">int</span> newValue)</span> <span class="comment">// æœ€ç»ˆè®¾ç½®ä¸º newValueï¼Œä½¿ç”¨ lazySet è®¾ç½®ä¹‹åå¯èƒ½å¯¼è‡´å…¶ä»–çº¿ç¨‹åœ¨ä¹‹åçš„ä¸€å°æ®µæ—¶é—´å†…è¿˜æ˜¯å¯ä»¥è¯»åˆ°æ—§çš„å€¼ã€‚</span></span><br></pre></td></tr></table></figure>

<p><code>AtomicInteger</code> ä½¿ç”¨ç¤ºä¾‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AtomicIntegerDemo</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">ExecutorService</span> <span class="variable">executorService</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">5</span>);</span><br><span class="line">        <span class="type">AtomicInteger</span> <span class="variable">count</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123;</span><br><span class="line">            executorService.submit((Runnable) () -&gt; &#123;</span><br><span class="line">                System.out.println(Thread.currentThread().getName() + <span class="string">&quot; count=&quot;</span> + count.get());</span><br><span class="line">                count.incrementAndGet();</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        executorService.shutdown();</span><br><span class="line">        executorService.awaitTermination(<span class="number">30</span>, TimeUnit.SECONDS);</span><br><span class="line">        System.out.println(<span class="string">&quot;Final Count is : &quot;</span> + count.get());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="AtomicInteger-å®ç°"><a href="#AtomicInteger-å®ç°" class="headerlink" title="AtomicInteger å®ç°"></a><strong><code>AtomicInteger</code> å®ç°</strong></h4><p>é˜…è¯» <code>AtomicInteger</code> æºç ï¼Œå¯ä»¥çœ‹åˆ°å¦‚ä¸‹å®šä¹‰ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Unsafe</span> <span class="variable">unsafe</span> <span class="operator">=</span> Unsafe.getUnsafe();</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> valueOffset;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		valueOffset = unsafe.objectFieldOffset</span><br><span class="line">			(AtomicInteger.class.getDeclaredField(<span class="string">&quot;value&quot;</span>));</span><br><span class="line">	&#125; <span class="keyword">catch</span> (Exception ex) &#123; <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(ex); &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">int</span> value;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>è¯´æ˜ï¼š</p>
<ul>
<li><code>value</code> - value å±æ€§ä½¿ç”¨ <code>volatile</code> ä¿®é¥°ï¼Œä½¿å¾—å¯¹ value çš„ä¿®æ”¹åœ¨å¹¶å‘ç¯å¢ƒä¸‹å¯¹æ‰€æœ‰çº¿ç¨‹å¯è§ã€‚</li>
<li><code>valueOffset</code> - value å±æ€§çš„åç§»é‡ï¼Œé€šè¿‡è¿™ä¸ªåç§»é‡å¯ä»¥å¿«é€Ÿå®šä½åˆ° value å­—æ®µï¼Œè¿™ä¸ªæ˜¯å®ç° AtomicInteger çš„å…³é”®ã€‚</li>
<li><code>unsafe</code> - Unsafe ç±»å‹çš„å±æ€§ï¼Œå®ƒä¸º <code>AtomicInteger</code> æä¾›äº† CAS æ“ä½œã€‚</li>
</ul>
</blockquote>
<h3 id="åŸå­ç±»ä¹‹å¼•ç”¨æ•°æ®ç±»å‹"><a href="#åŸå­ç±»ä¹‹å¼•ç”¨æ•°æ®ç±»å‹" class="headerlink" title="åŸå­ç±»ä¹‹å¼•ç”¨æ•°æ®ç±»å‹"></a>åŸå­ç±»ä¹‹å¼•ç”¨æ•°æ®ç±»å‹</h3><p>Java æ•°æ®ç±»å‹åˆ†ä¸º <strong>åŸºæœ¬æ•°æ®ç±»å‹</strong> å’Œ <strong>å¼•ç”¨æ•°æ®ç±»å‹</strong> ä¸¤å¤§ç±»ï¼ˆä¸äº†è§£ Java æ•°æ®ç±»å‹åˆ’åˆ†å¯ä»¥å‚è€ƒï¼š <a href="https://dunwu.github.io/waterdrop/pages/17bf2e10/">Java åŸºæœ¬æ•°æ®ç±»å‹</a> ï¼‰ã€‚</p>
<p>ä¸Šä¸€èŠ‚ä¸­æåˆ°äº†é’ˆå¯¹åŸºæœ¬æ•°æ®ç±»å‹çš„åŸå­ç±»ï¼Œé‚£ä¹ˆå¦‚æœæƒ³é’ˆå¯¹å¼•ç”¨ç±»å‹åšåŸå­æ“ä½œæ€ä¹ˆåŠï¼ŸJava ä¹Ÿæä¾›äº†ç›¸å…³çš„åŸå­ç±»ï¼š</p>
<ul>
<li><code>AtomicReference</code> - å¼•ç”¨ç±»å‹åŸå­ç±»</li>
<li><code>AtomicMarkableReference</code> - å¸¦æœ‰æ ‡è®°ä½çš„å¼•ç”¨ç±»å‹åŸå­ç±»</li>
<li><code>AtomicStampedReference</code> - å¸¦æœ‰ç‰ˆæœ¬å·çš„å¼•ç”¨ç±»å‹åŸå­ç±»</li>
</ul>
<blockquote>
<p><code>AtomicStampedReference</code> ç±»åœ¨å¼•ç”¨ç±»å‹åŸå­ç±»ä¸­ï¼Œå½»åº•åœ°è§£å†³äº† ABA é—®é¢˜ï¼Œå…¶å®ƒçš„ CAS èƒ½åŠ›ä¸å¦å¤–ä¸¤ä¸ªç±»ç›¸è¿‘ï¼Œæ‰€ä»¥æœ€å…·ä»£è¡¨æ€§ã€‚å› æ­¤ï¼Œæœ¬èŠ‚åªé’ˆå¯¹ <code>AtomicStampedReference</code> è¿›è¡Œè¯´æ˜ã€‚</p>
</blockquote>
<p>::: tabs#åŸå­ç±»ä¹‹å¼•ç”¨ç±»å‹ç¤ºä¾‹</p>
<p>@tab <code>AtomicReference</code> ä½¿ç”¨ç¤ºä¾‹</p>
<p>ã€ç¤ºä¾‹ã€‘åŸºäº <code>AtomicReference</code> å®ç°ä¸€ä¸ªç®€å•çš„è‡ªæ—‹é”</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AtomicReferenceDemo2</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">ticket</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        threadSafeDemo();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">threadSafeDemo</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">SpinLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SpinLock</span>();</span><br><span class="line">        <span class="type">ExecutorService</span> <span class="variable">executorService</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">3</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">            executorService.execute(<span class="keyword">new</span> <span class="title class_">MyThread</span>(lock));</span><br><span class="line">        &#125;</span><br><span class="line">        executorService.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åŸºäº &#123;<span class="doctag">@link</span> AtomicReference&#125; å®ç°çš„ç®€å•è‡ªæ—‹é”</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">SpinLock</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> AtomicReference&lt;Thread&gt; atomicReference = <span class="keyword">new</span> <span class="title class_">AtomicReference</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">lock</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="type">Thread</span> <span class="variable">current</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">            <span class="keyword">while</span> (!atomicReference.compareAndSet(<span class="literal">null</span>, current)) &#123;&#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="type">Thread</span> <span class="variable">current</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">            atomicReference.compareAndSet(current, <span class="literal">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åˆ©ç”¨è‡ªæ—‹é” &#123;<span class="doctag">@link</span> SpinLock&#125; å¹¶å‘å¤„ç†æ•°æ®</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MyThread</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> SpinLock lock;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">MyThread</span><span class="params">(SpinLock lock)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.lock = lock;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (ticket &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                lock.lock();</span><br><span class="line">                <span class="keyword">if</span> (ticket &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    System.out.println(Thread.currentThread().getName() + <span class="string">&quot; å–å‡ºäº†ç¬¬ &quot;</span> + ticket + <span class="string">&quot; å¼ ç¥¨&quot;</span>);</span><br><span class="line">                    ticket--;</span><br><span class="line">                &#125;</span><br><span class="line">                lock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>@tab <code>AtomicMarkableReference</code> ä½¿ç”¨ç¤ºä¾‹</p>
<p>ã€ç¤ºä¾‹ã€‘<code>AtomicMarkableReference</code> ä½¿ç”¨ç¤ºä¾‹ï¼ˆè§£å†³ ABA é—®é¢˜ï¼‰</p>
<p>åŸå­ç±»çš„å®ç°åŸºäº CAS æœºåˆ¶ï¼Œè€Œ CAS å­˜åœ¨ ABA é—®é¢˜ï¼ˆä¸äº†è§£ ABA é—®é¢˜ï¼Œå¯ä»¥å‚è€ƒï¼š<a href="https://dunwu.github.io/waterdrop/pages/e98ae9d2">Java å¹¶å‘ä¹‹å†…å­˜æ¨¡å‹</a>ï¼‰ã€‚æ­£æ˜¯ä¸ºäº†è§£å†³ ABA é—®é¢˜ï¼Œæ‰æœ‰äº† <code>AtomicMarkableReference</code> å’Œ <code>AtomicStampedReference</code>ã€‚</p>
<p><code>AtomicMarkableReference</code> ä½¿ç”¨ä¸€ä¸ªå¸ƒå°”å€¼ä½œä¸ºæ ‡è®°ï¼Œä¿®æ”¹æ—¶åœ¨ true &#x2F; false ä¹‹é—´åˆ‡æ¢ã€‚è¿™ç§ç­–ç•¥ä¸èƒ½æ ¹æœ¬ä¸Šè§£å†³ ABA é—®é¢˜ï¼Œä½†æ˜¯å¯ä»¥é™ä½ ABA å‘ç”Ÿçš„å‡ ç‡ã€‚å¸¸ç”¨äºç¼“å­˜æˆ–è€…çŠ¶æ€æè¿°è¿™æ ·çš„åœºæ™¯ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AtomicMarkableReferenceDemo</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">INIT_TEXT</span> <span class="operator">=</span> <span class="string">&quot;abc&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> AtomicMarkableReference&lt;String&gt; amr = <span class="keyword">new</span> <span class="title class_">AtomicMarkableReference</span>&lt;&gt;(INIT_TEXT, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">ExecutorService</span> <span class="variable">executorService</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">3</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">            executorService.submit(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        Thread.sleep(Math.abs((<span class="type">int</span>) (Math.random() * <span class="number">100</span>)));</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> Thread.currentThread().getName();</span><br><span class="line">                    <span class="keyword">if</span> (amr.compareAndSet(INIT_TEXT, name, amr.isMarked(), !amr.isMarked())) &#123;</span><br><span class="line">                        System.out.println(Thread.currentThread().getName() + <span class="string">&quot; ä¿®æ”¹äº†å¯¹è±¡ï¼&quot;</span>);</span><br><span class="line">                        System.out.println(<span class="string">&quot;æ–°çš„å¯¹è±¡ä¸ºï¼š&quot;</span> + amr.getReference());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        executorService.shutdown();</span><br><span class="line">        executorService.awaitTermination(<span class="number">3</span>, TimeUnit.SECONDS);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>@tab <code>AtomicStampedReference</code> ä½¿ç”¨ç¤ºä¾‹</p>
<p>ã€ç¤ºä¾‹ã€‘<code>AtomicStampedReference</code> ä½¿ç”¨ç¤ºä¾‹</p>
<p><strong><code>AtomicStampedReference</code> ä½¿ç”¨ä¸€ä¸ªæ•´å‹å€¼åšä¸ºç‰ˆæœ¬å·ï¼Œæ¯æ¬¡æ›´æ–°å‰å…ˆæ¯”è¾ƒç‰ˆæœ¬å·ï¼Œå¦‚æœä¸€è‡´ï¼Œæ‰è¿›è¡Œä¿®æ”¹</strong>ã€‚é€šè¿‡è¿™ç§ç­–ç•¥ï¼Œå¯ä»¥æ ¹æœ¬ä¸Šè§£å†³ ABA é—®é¢˜ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AtomicStampedReferenceDemo</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">INIT_REF</span> <span class="operator">=</span> <span class="string">&quot;pool-1-thread-3&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> AtomicStampedReference&lt;String&gt; asr = <span class="keyword">new</span> <span class="title class_">AtomicStampedReference</span>&lt;&gt;(INIT_REF, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;åˆå§‹å¯¹è±¡ä¸ºï¼š&quot;</span> + asr.getReference());</span><br><span class="line"></span><br><span class="line">        <span class="type">ExecutorService</span> <span class="variable">executorService</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">3</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">            executorService.execute(<span class="keyword">new</span> <span class="title class_">MyThread</span>());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        executorService.shutdown();</span><br><span class="line">        executorService.awaitTermination(<span class="number">3</span>, TimeUnit.SECONDS);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MyThread</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(Math.abs((<span class="type">int</span>) (Math.random() * <span class="number">100</span>)));</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> <span class="type">int</span> <span class="variable">stamp</span> <span class="operator">=</span> asr.getStamp();</span><br><span class="line">            <span class="keyword">if</span> (asr.compareAndSet(INIT_REF, Thread.currentThread().getName(), stamp, stamp + <span class="number">1</span>)) &#123;</span><br><span class="line">                System.out.println(Thread.currentThread().getName() + <span class="string">&quot; ä¿®æ”¹äº†å¯¹è±¡ï¼&quot;</span>);</span><br><span class="line">                System.out.println(<span class="string">&quot;æ–°çš„å¯¹è±¡ä¸ºï¼š&quot;</span> + asr.getReference());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>:::</p>
<h3 id="åŸå­ç±»ä¹‹æ•°ç»„æ•°æ®ç±»å‹"><a href="#åŸå­ç±»ä¹‹æ•°ç»„æ•°æ®ç±»å‹" class="headerlink" title="åŸå­ç±»ä¹‹æ•°ç»„æ•°æ®ç±»å‹"></a>åŸå­ç±»ä¹‹æ•°ç»„æ•°æ®ç±»å‹</h3><p>Java æä¾›äº†ä»¥ä¸‹é’ˆå¯¹æ•°ç»„çš„åŸå­ç±»ï¼š</p>
<ul>
<li><code>AtomicIntegerArray</code> - æ•´å½¢æ•°ç»„åŸå­ç±»</li>
<li><code>AtomicLongArray</code> - é•¿æ•´å‹æ•°ç»„åŸå­ç±»</li>
<li><code>AtomicReferenceArray</code> - å¼•ç”¨ç±»å‹æ•°ç»„åŸå­ç±»</li>
</ul>
<p>å·²ç»æœ‰äº†é’ˆå¯¹åŸºæœ¬ç±»å‹å’Œå¼•ç”¨ç±»å‹çš„åŸå­ç±»ï¼Œä¸ºä»€ä¹ˆè¿˜è¦æä¾›é’ˆå¯¹æ•°ç»„çš„åŸå­ç±»å‘¢ï¼Ÿ</p>
<p><strong>æ•°ç»„ç±»å‹çš„åŸå­ç±»ä¸ºæ•°ç»„å…ƒç´ æä¾›äº† <code>volatile</code> ç±»å‹çš„è®¿é—®è¯­ä¹‰</strong>ï¼Œè¿™æ˜¯æ™®é€šæ•°ç»„æ‰€ä¸å…·å¤‡çš„ç‰¹æ€§â€”â€”**<code>volatile</code> ç±»å‹çš„æ•°ç»„ä»…åœ¨æ•°ç»„å¼•ç”¨ä¸Šå…·æœ‰ <code>volatile</code> è¯­ä¹‰**ã€‚</p>
<p>ã€ç¤ºä¾‹ã€‘<code>AtomicIntegerArray</code> ä½¿ç”¨ç¤ºä¾‹ï¼ˆ<code>AtomicLongArray</code> ã€<code>AtomicReferenceArray</code> ä½¿ç”¨æ–¹å¼ä¹Ÿç±»ä¼¼ï¼‰</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AtomicIntegerArrayDemo</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">AtomicIntegerArray</span> <span class="variable">atomicIntegerArray</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicIntegerArray</span>(<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(<span class="keyword">final</span> String[] arguments)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;Init Values: &quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; atomicIntegerArray.length(); i++) &#123;</span><br><span class="line">            atomicIntegerArray.set(i, i);</span><br><span class="line">            System.out.print(atomicIntegerArray.get(i) + <span class="string">&quot; &quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println();</span><br><span class="line"></span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">Increment</span>());</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">Compare</span>());</span><br><span class="line">        t1.start();</span><br><span class="line">        t2.start();</span><br><span class="line"></span><br><span class="line">        t1.join();</span><br><span class="line">        t2.join();</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;Final Values: &quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; atomicIntegerArray.length(); i++) &#123;</span><br><span class="line">            System.out.print(atomicIntegerArray.get(i) + <span class="string">&quot; &quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Increment</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; atomicIntegerArray.length(); i++) &#123;</span><br><span class="line">                <span class="type">int</span> <span class="variable">value</span> <span class="operator">=</span> atomicIntegerArray.incrementAndGet(i);</span><br><span class="line">                System.out.println(Thread.currentThread().getName() + <span class="string">&quot;, index = &quot;</span> + i + <span class="string">&quot;, value = &quot;</span> + value);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Compare</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; atomicIntegerArray.length(); i++) &#123;</span><br><span class="line">                <span class="type">boolean</span> <span class="variable">swapped</span> <span class="operator">=</span> atomicIntegerArray.compareAndSet(i, <span class="number">2</span>, <span class="number">3</span>);</span><br><span class="line">                <span class="keyword">if</span> (swapped) &#123;</span><br><span class="line">                    System.out.println(Thread.currentThread().getName() + <span class="string">&quot; swapped, index = &quot;</span> + i + <span class="string">&quot;, value = 3&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="åŸå­ç±»ä¹‹å±æ€§æ›´æ–°å™¨"><a href="#åŸå­ç±»ä¹‹å±æ€§æ›´æ–°å™¨" class="headerlink" title="åŸå­ç±»ä¹‹å±æ€§æ›´æ–°å™¨"></a>åŸå­ç±»ä¹‹å±æ€§æ›´æ–°å™¨</h3><p><strong>å±æ€§æ›´æ–°å™¨æ”¯æŒåŸºäºåå°„æœºåˆ¶çš„æ›´æ–°å­—æ®µå€¼çš„åŸå­æ“ä½œ</strong>ã€‚</p>
<ul>
<li><code>AtomicIntegerFieldUpdater</code> - æ•´å‹å­—æ®µçš„åŸå­æ›´æ–°å™¨ã€‚</li>
<li><code>AtomicLongFieldUpdater</code> - é•¿æ•´å‹å­—æ®µçš„åŸå­æ›´æ–°å™¨ã€‚</li>
<li><code>AtomicReferenceFieldUpdater</code> - åŸå­æ›´æ–°å¼•ç”¨ç±»å‹é‡Œçš„å­—æ®µã€‚</li>
</ul>
<p>è¿™äº›ç±»çš„ä½¿ç”¨æœ‰ä¸€å®šé™åˆ¶ï¼š</p>
<ul>
<li>å› ä¸ºå¯¹è±¡çš„å±æ€§ä¿®æ”¹ç±»å‹åŸå­ç±»éƒ½æ˜¯æŠ½è±¡ç±»ï¼Œæ‰€ä»¥æ¯æ¬¡ä½¿ç”¨éƒ½å¿…é¡»ä½¿ç”¨é™æ€æ–¹æ³• <code>newUpdater()</code> åˆ›å»ºä¸€ä¸ªæ›´æ–°å™¨ï¼Œå¹¶ä¸”éœ€è¦è®¾ç½®æƒ³è¦æ›´æ–°çš„ç±»å’Œå±æ€§ã€‚</li>
<li>å­—æ®µå¿…é¡»æ˜¯ <code>volatile</code> ç±»å‹çš„ï¼›</li>
<li>ä¸èƒ½ä½œç”¨äºé™æ€å˜é‡ï¼ˆ<code>static</code>ï¼‰ï¼›</li>
<li>ä¸èƒ½ä½œç”¨äºå¸¸é‡ï¼ˆ<code>final</code>ï¼‰ï¼›</li>
</ul>
<p>ã€ç¤ºä¾‹ã€‘<code>AtomicReferenceFieldUpdater</code> ä½¿ç”¨ç¤ºä¾‹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AtomicReferenceFieldUpdaterDemo</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">&quot;begin&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> AtomicReferenceFieldUpdater&lt;User, String&gt; updater =</span><br><span class="line">        AtomicReferenceFieldUpdater.newUpdater(User.class, String.class, <span class="string">&quot;name&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">ExecutorService</span> <span class="variable">executorService</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">3</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">            executorService.execute(<span class="keyword">new</span> <span class="title class_">MyThread</span>());</span><br><span class="line">        &#125;</span><br><span class="line">        executorService.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MyThread</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (updater.compareAndSet(user, <span class="string">&quot;begin&quot;</span>, <span class="string">&quot;end&quot;</span>)) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">                System.out.println(Thread.currentThread().getName() + <span class="string">&quot; å·²ä¿®æ”¹ name = &quot;</span> + user.getName());</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                System.out.println(Thread.currentThread().getName() + <span class="string">&quot; å·²è¢«å…¶ä»–çº¿ç¨‹ä¿®æ”¹&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">volatile</span> String name;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">User</span><span class="params">(String name)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.name = name;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> name;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> User <span class="title function_">setName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.name = name;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="åŸå­ç±»ä¹‹ç´¯åŠ å™¨"><a href="#åŸå­ç±»ä¹‹ç´¯åŠ å™¨" class="headerlink" title="åŸå­ç±»ä¹‹ç´¯åŠ å™¨"></a>åŸå­ç±»ä¹‹ç´¯åŠ å™¨</h3><p><code>DoubleAccumulator</code>ã€<code>DoubleAdder</code>ã€<code>LongAccumulator</code> å’Œ <code>LongAdder</code>ï¼Œè¿™å››ä¸ªç±»ä»…ä»…ç”¨æ¥æ‰§è¡Œç´¯åŠ æ“ä½œï¼Œç›¸æ¯”åŸå­åŒ–çš„åŸºæœ¬æ•°æ®ç±»å‹ï¼Œé€Ÿåº¦æ›´å¿«ï¼Œä½†æ˜¯ä¸æ”¯æŒ <code>compareAndSet()</code> æ–¹æ³•ã€‚å¦‚æœä½ ä»…ä»…éœ€è¦ç´¯åŠ æ“ä½œï¼Œä½¿ç”¨åŸå­åŒ–çš„ç´¯åŠ å™¨æ€§èƒ½ä¼šæ›´å¥½ï¼Œä»£ä»·å°±æ˜¯ä¼šæ¶ˆè€—æ›´å¤šçš„å†…å­˜ç©ºé—´ã€‚</p>
<p><code>LongAdder</code> å†…éƒ¨ç”±ä¸€ä¸ª <code>base</code> å˜é‡å’Œä¸€ä¸ª <code>cell[]</code> æ•°ç»„ç»„æˆã€‚</p>
<ul>
<li>å½“åªæœ‰ä¸€ä¸ªå†™çº¿ç¨‹ï¼Œæ²¡æœ‰ç«äº‰çš„æƒ…å†µä¸‹ï¼Œ<code>LongAdder</code> ä¼šç›´æ¥ä½¿ç”¨ <code>base</code> å˜é‡ä½œä¸ºåŸå­æ“ä½œå˜é‡ï¼Œé€šè¿‡ CAS æ“ä½œä¿®æ”¹å˜é‡ï¼›</li>
<li>å½“æœ‰å¤šä¸ªå†™çº¿ç¨‹ç«äº‰çš„æƒ…å†µä¸‹ï¼Œé™¤äº†å ç”¨ <code>base</code> å˜é‡çš„ä¸€ä¸ªå†™çº¿ç¨‹ä¹‹å¤–ï¼Œå…¶å®ƒå„ä¸ªçº¿ç¨‹ä¼šå°†ä¿®æ”¹çš„å˜é‡å†™å…¥åˆ°è‡ªå·±çš„æ§½ <code>cell[]</code> æ•°ç»„ä¸­ã€‚</li>
</ul>
<p>æˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œ<code>LongAdder</code> åœ¨æ“ä½œåçš„è¿”å›å€¼åªæ˜¯ä¸€ä¸ªè¿‘ä¼¼å‡†ç¡®çš„æ•°å€¼ï¼Œä½†æ˜¯ <code>LongAdder</code> æœ€ç»ˆè¿”å›çš„æ˜¯ä¸€ä¸ªå‡†ç¡®çš„æ•°å€¼ï¼Œ æ‰€ä»¥åœ¨ä¸€äº›å¯¹å®æ—¶æ€§è¦æ±‚æ¯”è¾ƒé«˜çš„åœºæ™¯ä¸‹ï¼Œ<code>LongAdder</code> å¹¶ä¸èƒ½å–ä»£ <code>AtomicInteger</code> æˆ– <code>AtomicLong</code>ã€‚</p>
<h2 id="ThreadLocal"><a href="#ThreadLocal" class="headerlink" title="ThreadLocal"></a>ThreadLocal</h2><p>åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œå…±äº«å˜é‡å­˜åœ¨å¹¶å‘å®‰å…¨é—®é¢˜ã€‚æ¢ä¸ªæ€è·¯ï¼Œå¦‚æœå˜é‡éå…±äº«ï¼Œè€Œæ˜¯å„ä¸ªçº¿ç¨‹ç‹¬äº«ï¼Œå°±ä¸ä¼šæœ‰å¹¶å‘å®‰å…¨é—®é¢˜ã€‚è¿™ç§æ€æƒ³æœ‰ä¸ªæœ¯è¯­å«<strong>çº¿ç¨‹å°é—­</strong>ï¼Œå…¶æœ¬è´¨ä¸Šå°±æ˜¯é¿å…å…±äº«ã€‚æ²¡æœ‰å…±äº«ï¼Œè‡ªç„¶ä¹Ÿå°±æ²¡æœ‰å¹¶å‘å®‰å…¨é—®é¢˜ã€‚åœ¨ Java ä¸­ï¼Œ<code>ThreadLocal</code> æ­£æ˜¯æ ¹æ®è¿™ä¸ªæ€è·¯è€Œè®¾è®¡çš„ã€‚</p>
<p><strong><code>ThreadLocal</code> ä¸ºæ¯ä¸ªçº¿ç¨‹éƒ½åˆ›å»ºäº†ä¸€ä¸ªæœ¬åœ°å‰¯æœ¬</strong>ï¼Œè¿™ä¸ªå‰¯æœ¬åªèƒ½è¢«å½“å‰çº¿ç¨‹è®¿é—®ï¼Œå…¶ä»–çº¿ç¨‹æ— æ³•è®¿é—®ï¼Œé‚£ä¹ˆè‡ªç„¶æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚</p>
<h3 id="ThreadLocal-çš„åº”ç”¨"><a href="#ThreadLocal-çš„åº”ç”¨" class="headerlink" title="ThreadLocal çš„åº”ç”¨"></a>ThreadLocal çš„åº”ç”¨</h3><p><code>ThreadLocal</code> çš„æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadLocal</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">public</span> T <span class="title function_">get</span><span class="params">()</span> &#123;&#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">set</span><span class="params">(T value)</span> &#123;&#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">remove</span><span class="params">()</span> &#123;&#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;S&gt; ThreadLocal&lt;S&gt; <span class="title function_">withInitial</span><span class="params">(Supplier&lt;? extends S&gt; supplier)</span> &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>è¯´æ˜ï¼š</p>
<ul>
<li><code>get</code> - ç”¨äºè·å– <code>ThreadLocal</code> åœ¨å½“å‰çº¿ç¨‹ä¸­ä¿å­˜çš„å˜é‡å‰¯æœ¬ã€‚</li>
<li><code>set</code> - ç”¨äºè®¾ç½®å½“å‰çº¿ç¨‹ä¸­å˜é‡çš„å‰¯æœ¬ã€‚</li>
<li><code>remove</code> - ç”¨äºåˆ é™¤å½“å‰çº¿ç¨‹ä¸­å˜é‡çš„å‰¯æœ¬ã€‚å¦‚æœæ­¤çº¿ç¨‹å±€éƒ¨å˜é‡éšåè¢«å½“å‰çº¿ç¨‹è¯»å–ï¼Œåˆ™å…¶å€¼å°†é€šè¿‡è°ƒç”¨å…¶ <code>initialValue</code> æ–¹æ³•é‡æ–°åˆå§‹åŒ–ï¼Œé™¤éå…¶å€¼ç”±ä¸­é—´çº¿ç¨‹ä¸­çš„å½“å‰çº¿ç¨‹è®¾ç½®ã€‚ è¿™å¯èƒ½ä¼šå¯¼è‡´å½“å‰çº¿ç¨‹ä¸­å¤šæ¬¡è°ƒç”¨ <code>initialValue</code> æ–¹æ³•ã€‚</li>
<li><code>initialValue</code> - ä¸º ThreadLocal è®¾ç½®é»˜è®¤çš„ <code>get</code> åˆå§‹å€¼ï¼Œéœ€è¦é‡å†™ <code>initialValue</code> æ–¹æ³• ã€‚</li>
</ul>
</blockquote>
<p><code>ThreadLocal</code> å¸¸ç”¨äºé˜²æ­¢å¯¹å¯å˜çš„å•ä¾‹ï¼ˆSingletonï¼‰å˜é‡æˆ–å…¨å±€å˜é‡è¿›è¡Œå…±äº«ã€‚å…¸å‹åº”ç”¨åœºæ™¯æœ‰ï¼šç®¡ç†æ•°æ®åº“è¿æ¥ã€Session ç®¡ç†ç­‰ã€‚</p>
<p>::: tabs#ThreadLocal åº”ç”¨ç¤ºä¾‹</p>
<p>@tab æ•°æ®åº“è¿æ¥</p>
<p>ã€ç¤ºä¾‹ã€‘æ•°æ®åº“è¿æ¥</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> ThreadLocal&lt;Connection&gt; connectionHolder = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;Connection&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Connection <span class="title function_">initialValue</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> DriverManager.getConnection(DB_URL);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Connection <span class="title function_">getConnection</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> connectionHolder.get();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>@tab Session ç®¡ç†</p>
<p>ã€ç¤ºä¾‹ã€‘Session ç®¡ç†</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;Session&gt; sessionHolder = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Session <span class="title function_">getSession</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">Session</span> <span class="variable">session</span> <span class="operator">=</span> (Session) sessionHolder.get();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (session == <span class="literal">null</span>) &#123;</span><br><span class="line">            session = createSession();</span><br><span class="line">            sessionHolder.set(session);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> session;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>@tab çº¿ç¨‹å®‰å…¨çš„ <code>SimpleDateFormat</code></p>
<p>ã€ç¤ºä¾‹ã€‘çº¿ç¨‹å®‰å…¨çš„ <code>SimpleDateFormat</code></p>
<p>SimpleDateFormat ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå¦‚æœè¦ä¿è¯å¹¶å‘å®‰å…¨ï¼Œå¯ä»¥ä½¿ç”¨ ThreadLocal æ¥è§£å†³ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SafeDateFormat</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å®šä¹‰ ThreadLocal å˜é‡</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;DateFormat&gt;</span><br><span class="line">        tl = ThreadLocal.withInitial(() -&gt; <span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(<span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> DateFormat <span class="title function_">get</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> tl.get();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">//ä¸åŒçº¿ç¨‹æ‰§è¡Œä¸‹é¢ä»£ç </span></span><br><span class="line">        <span class="comment">//è¿”å›çš„ df æ˜¯ä¸åŒçš„</span></span><br><span class="line">        <span class="type">DateFormat</span> <span class="variable">df</span> <span class="operator">=</span> SafeDateFormat.get();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>@tab å®Œæ•´ä½¿ç”¨ <code>ThreadLocal</code> ç¤ºä¾‹</p>
<p>ã€ç¤ºä¾‹ã€‘å®Œæ•´ä½¿ç”¨ <code>ThreadLocal</code> ç¤ºä¾‹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadLocalDemo</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ThreadLocal&lt;Integer&gt; threadLocal = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;Integer&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">protected</span> Integer <span class="title function_">initialValue</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">ExecutorService</span> <span class="variable">executorService</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">10</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">            executorService.execute(<span class="keyword">new</span> <span class="title class_">MyThread</span>());</span><br><span class="line">        &#125;</span><br><span class="line">        executorService.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MyThread</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> threadLocal.get();</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    count++;</span><br><span class="line">                    Thread.sleep(<span class="number">100</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            threadLocal.set(count);</span><br><span class="line">            threadLocal.remove();</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">&quot; : &quot;</span> + count);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>:::</p>
<h3 id="ThreadLocal-çš„åŸç†"><a href="#ThreadLocal-çš„åŸç†" class="headerlink" title="ThreadLocal çš„åŸç†"></a>ThreadLocal çš„åŸç†</h3><h4 id="å­˜å‚¨ç»“æ„"><a href="#å­˜å‚¨ç»“æ„" class="headerlink" title="å­˜å‚¨ç»“æ„"></a>å­˜å‚¨ç»“æ„</h4><p><strong><code>Thread</code> ç±»ä¸­ç»´æŠ¤ç€ 2 ä¸ª <code>ThreadLocal.ThreadLocalMap</code> ç±»å‹çš„æˆå‘˜</strong> <code>threadLocals</code> å’Œ inheritableThreadLocals ã€‚è¿™ 2 ä¸ªæˆå‘˜å°±æ˜¯ç”¨æ¥å­˜å‚¨å½“å‰çº¿ç¨‹ç‹¬å çš„å˜é‡å‰¯æœ¬ã€‚</p>
<p><code>ThreadLocalMap</code> æ˜¯ <code>ThreadLocal</code> çš„å†…éƒ¨ç±»ï¼Œå®ƒç»´æŠ¤ç€ä¸€ä¸ª <code>Entry</code> æ•°ç»„ï¼Œ**<code>Entry</code> ç»§æ‰¿äº† <code>WeakReference</code>** ï¼Œæ‰€ä»¥æ˜¯å¼±å¼•ç”¨ã€‚ <code>Entry</code> ç”¨äºä¿å­˜é”®å€¼å¯¹ï¼Œå…¶ä¸­ï¼š</p>
<ul>
<li><code>key</code> æ˜¯ <code>ThreadLocal</code> å¯¹è±¡</li>
<li><code>value</code> æ˜¯ä¼ é€’è¿›æ¥çš„å¯¹è±¡ï¼ˆå˜é‡å‰¯æœ¬ï¼‰</li>
</ul>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/202409110720703.png"></p>
<p><code>ThreadLocal</code> å…³é”®æºç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Thread</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    ThreadLocal.<span class="type">ThreadLocalMap</span> <span class="variable">threadLocals</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    ThreadLocal.<span class="type">ThreadLocalMap</span> <span class="variable">inheritableThreadLocals</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">ThreadLocalMap</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Entry</span> <span class="keyword">extends</span> <span class="title class_">WeakReference</span>&lt;ThreadLocal&lt;?&gt;&gt; &#123;</span><br><span class="line">        <span class="comment">/** The value associated with this ThreadLocal. */</span></span><br><span class="line">        Object value;</span><br><span class="line"></span><br><span class="line">        Entry(ThreadLocal&lt;?&gt; k, Object v) &#123;</span><br><span class="line">            <span class="built_in">super</span>(k);</span><br><span class="line">            value = v;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="å¦‚ä½•è§£å†³-Hash-å†²çª"><a href="#å¦‚ä½•è§£å†³-Hash-å†²çª" class="headerlink" title="å¦‚ä½•è§£å†³ Hash å†²çª"></a>å¦‚ä½•è§£å†³ Hash å†²çª</h4><p><code>ThreadLocalMap</code> è™½ç„¶æ˜¯ç±»ä¼¼ <code>Map</code> ç»“æ„çš„æ•°æ®ç»“æ„ï¼Œä½†å®ƒå¹¶æ²¡æœ‰å®ç° <code>Map</code> æ¥å£ã€‚å®ƒä¸æ”¯æŒ <code>Map</code> æ¥å£ä¸­çš„ <code>next</code> æ–¹æ³•ï¼Œè¿™æ„å‘³ç€ <code>ThreadLocalMap</code> ä¸­è§£å†³ Hash å†²çªçš„æ–¹å¼å¹¶é <strong>æ‹‰é“¾è¡¨</strong> æ–¹å¼ã€‚</p>
<p>å®é™…ä¸Šï¼Œ**<code>ThreadLocalMap</code> é‡‡ç”¨çº¿æ€§æ¢æµ‹çš„æ–¹å¼æ¥è§£å†³ Hash å†²çª**ã€‚æ‰€è°“çº¿æ€§æ¢æµ‹ï¼Œå°±æ˜¯æ ¹æ®åˆå§‹ key çš„ hashcode å€¼ç¡®å®šå…ƒç´ åœ¨ table æ•°ç»„ä¸­çš„ä½ç½®ï¼Œå¦‚æœå‘ç°è¿™ä¸ªä½ç½®ä¸Šå·²ç»è¢«å…¶ä»–çš„ key å€¼å ç”¨ï¼Œåˆ™åˆ©ç”¨å›ºå®šçš„ç®—æ³•å¯»æ‰¾ä¸€å®šæ­¥é•¿çš„ä¸‹ä¸ªä½ç½®ï¼Œä¾æ¬¡åˆ¤æ–­ï¼Œç›´è‡³æ‰¾åˆ°èƒ½å¤Ÿå­˜æ”¾çš„ä½ç½®ã€‚</p>
<h4 id="å†…å­˜æ³„æ¼é—®é¢˜"><a href="#å†…å­˜æ³„æ¼é—®é¢˜" class="headerlink" title="å†…å­˜æ³„æ¼é—®é¢˜"></a>å†…å­˜æ³„æ¼é—®é¢˜</h4><p><code>ThreadLocal</code> ä»…ä»…æ˜¯ä¸€ä¸ªä»£ç†å·¥å…·ç±»ï¼Œå†…éƒ¨å¹¶ä¸æŒæœ‰ä»»ä½•ä¸çº¿ç¨‹ç›¸å…³çš„æ•°æ®ï¼Œæ‰€æœ‰å’Œçº¿ç¨‹ç›¸å…³çš„æ•°æ®éƒ½å­˜å‚¨åœ¨ <code>Thread</code> é‡Œé¢ï¼Œè¿™æ ·çš„è®¾è®¡å®¹æ˜“ç†è§£ã€‚</p>
<p>å½“ç„¶è¿˜æœ‰ä¸€ä¸ªæ›´åŠ æ·±å±‚æ¬¡çš„åŸå› ï¼Œé‚£å°±æ˜¯<strong>ä¸å®¹æ˜“äº§ç”Ÿå†…å­˜æ³„éœ²</strong>ã€‚å¦‚æœ <code>ThreadLocal</code> å’Œå®é™…å®ç°åå…¶é“è€Œè¡Œä¹‹ï¼šå°† <code>Thread</code> çš„å¼•ç”¨ç»´æŠ¤åœ¨ä¸€ä¸ª <code>Map</code> ä¸­ï¼Œå°±ä¼šå‡ºç°è¿™ç§æƒ…å†µâ€”â€”åªè¦ <code>ThreadLocal</code> å¯¹è±¡å­˜åœ¨ï¼Œé‚£ä¹ˆ Map ä¸­çš„ Thread å¯¹è±¡å°±æ°¸è¿œä¸ä¼šè¢«å›æ”¶ã€‚è€Œ <code>ThreadLocal</code> çš„ç”Ÿå‘½å‘¨æœŸå¾€å¾€éƒ½æ¯”çº¿ç¨‹è¦é•¿ï¼Œæ‰€ä»¥è¿™ç§è®¾è®¡æ–¹æ¡ˆå¾ˆå®¹æ˜“å¯¼è‡´å†…å­˜æ³„éœ²ã€‚è€Œ Java çš„å®ç°ä¸­ <code>Thread</code> æŒæœ‰ <code>ThreadLocalMap</code>ï¼Œè€Œä¸” <code>ThreadLocalMap</code> é‡Œå¯¹ <code>ThreadLocal</code> çš„å¼•ç”¨è¿˜æ˜¯å¼±å¼•ç”¨ï¼ˆ<code>WeakReference</code>ï¼‰ï¼Œæ‰€ä»¥åªè¦ <code>Thread</code> å¯¹è±¡å¯ä»¥è¢«å›æ”¶ï¼Œé‚£ä¹ˆ <code>ThreadLocalMap</code> å°±èƒ½è¢«å›æ”¶ã€‚Java çš„è¿™ç§å®ç°æ–¹æ¡ˆè™½ç„¶çœ‹ä¸Šå»å¤æ‚ä¸€äº›ï¼Œä½†æ˜¯æ›´åŠ å®‰å…¨ã€‚</p>
<p><code>ThreadLocalMap</code> çš„ <code>Entry</code> ç»§æ‰¿äº† <code>WeakReference</code>ï¼Œæ‰€ä»¥å®ƒçš„ <strong>key ï¼ˆ<code>ThreadLocal</code> å¯¹è±¡ï¼‰æ˜¯å¼±å¼•ç”¨ï¼Œè€Œ value ï¼ˆå˜é‡å‰¯æœ¬ï¼‰æ˜¯å¼ºå¼•ç”¨</strong>ã€‚å¦‚æœ <code>ThreadLocal</code> å¯¹è±¡æ²¡æœ‰å¤–éƒ¨å¼ºå¼•ç”¨æ¥å¼•ç”¨å®ƒï¼Œé‚£ä¹ˆ <code>ThreadLocal</code> å¯¹è±¡ä¼šåœ¨ä¸‹æ¬¡ GC æ—¶è¢«å›æ”¶ã€‚æ­¤æ—¶ï¼Œ<code>Entry</code> ä¸­çš„ key å·²ç»è¢«å›æ”¶ï¼Œä½†æ˜¯ value ç”±äºæ˜¯å¼ºå¼•ç”¨ä¸ä¼šè¢«åƒåœ¾æ”¶é›†å™¨å›æ”¶ã€‚å¦‚æœåˆ›å»º <code>ThreadLocal</code> çš„çº¿ç¨‹ä¸€ç›´æŒç»­è¿è¡Œï¼Œé‚£ä¹ˆ value å°±ä¼šä¸€ç›´å¾—ä¸åˆ°å›æ”¶ï¼Œä»è€Œå¯¼è‡´<strong>å†…å­˜æ³„éœ²</strong>ã€‚</p>
<p>é‚£ä¹ˆå¦‚ä½•é¿å…å†…å­˜æ³„æ¼å‘¢ï¼Ÿæ–¹æ³•å°±æ˜¯ï¼š<strong>ä½¿ç”¨ <code>ThreadLocal</code> çš„ <code>set</code> æ–¹æ³•åï¼Œåœ¨ <code>try &#123;&#125; finally &#123;&#125; </code> ä¸­æ˜¾ç¤ºçš„è°ƒç”¨ <code>remove</code> æ–¹æ³•</strong> ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">ExecutorService es;</span><br><span class="line">ThreadLocal tl;</span><br><span class="line">es.execute(() -&gt; &#123;</span><br><span class="line">    <span class="comment">//ThreadLocal å¢åŠ å˜é‡</span></span><br><span class="line">    tl.set(obj);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// çœç•¥ä¸šåŠ¡é€»è¾‘ä»£ç </span></span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">//æ‰‹åŠ¨æ¸…ç† ThreadLocal</span></span><br><span class="line">        tl.remove();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="ThreadLocal-çš„è¯¯åŒº"><a href="#ThreadLocal-çš„è¯¯åŒº" class="headerlink" title="ThreadLocal çš„è¯¯åŒº"></a>ThreadLocal çš„è¯¯åŒº</h3><blockquote>
<p>ç¤ºä¾‹æ‘˜è‡ªï¼š<a target="_blank" rel="noopener" href="https://time.geekbang.org/column/intro/100047701">æå®¢æ—¶é—´æ•™ç¨‹ - Java ä¸šåŠ¡å¼€å‘å¸¸è§é”™è¯¯ 100 ä¾‹</a></p>
</blockquote>
<p>ThreadLocal é€‚ç”¨äºå˜é‡åœ¨çº¿ç¨‹é—´éš”ç¦»ï¼Œè€Œåœ¨æ–¹æ³•æˆ–ç±»é—´å…±äº«çš„åœºæ™¯ã€‚</p>
<p>å‰æ–‡æåˆ°ï¼ŒThreadLocal æ˜¯çº¿ç¨‹éš”ç¦»çš„ï¼Œé‚£ä¹ˆæ˜¯ä¸æ˜¯ä½¿ç”¨ ThreadLocal å°±ä¸€å®šé«˜æ•æ— å¿§å‘¢ï¼Ÿ</p>
<h4 id="ThreadLocal-é”™è¯¯æ¡ˆä¾‹"><a href="#ThreadLocal-é”™è¯¯æ¡ˆä¾‹" class="headerlink" title="ThreadLocal é”™è¯¯æ¡ˆä¾‹"></a>ThreadLocal é”™è¯¯æ¡ˆä¾‹</h4><p>ä½¿ç”¨ Spring Boot åˆ›å»ºä¸€ä¸ª Web åº”ç”¨ç¨‹åºï¼Œä½¿ç”¨ ThreadLocal å­˜æ”¾ä¸€ä¸ª Integer çš„å€¼ï¼Œæ¥æš‚ä¸”ä»£è¡¨éœ€è¦åœ¨çº¿ç¨‹ä¸­ä¿å­˜çš„ç”¨æˆ·ä¿¡æ¯ï¼Œè¿™ä¸ªå€¼åˆå§‹æ˜¯ nullã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> ThreadLocal&lt;Integer&gt; currentUser = ThreadLocal.withInitial(() -&gt; <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">@GetMapping(&quot;wrong&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Map&lt;String, String&gt; <span class="title function_">wrong</span><span class="params">(<span class="meta">@RequestParam(&quot;id&quot;)</span> Integer userId)</span> &#123;</span><br><span class="line">    <span class="comment">//è®¾ç½®ç”¨æˆ·ä¿¡æ¯ä¹‹å‰å…ˆæŸ¥è¯¢ä¸€æ¬¡ ThreadLocal ä¸­çš„ç”¨æˆ·ä¿¡æ¯</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">before</span> <span class="operator">=</span> Thread.currentThread().getName() + <span class="string">&quot;:&quot;</span> + currentUser.get();</span><br><span class="line">    <span class="comment">//è®¾ç½®ç”¨æˆ·ä¿¡æ¯åˆ° ThreadLocal</span></span><br><span class="line">    currentUser.set(userId);</span><br><span class="line">    <span class="comment">//è®¾ç½®ç”¨æˆ·ä¿¡æ¯ä¹‹åå†æŸ¥è¯¢ä¸€æ¬¡ ThreadLocal ä¸­çš„ç”¨æˆ·ä¿¡æ¯</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">after</span> <span class="operator">=</span> Thread.currentThread().getName() + <span class="string">&quot;:&quot;</span> + currentUser.get();</span><br><span class="line">    <span class="comment">//æ±‡æ€»è¾“å‡ºä¸¤æ¬¡æŸ¥è¯¢ç»“æœ</span></span><br><span class="line">    Map&lt;String, String&gt; result = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    result.put(<span class="string">&quot;before&quot;</span>, before);</span><br><span class="line">    result.put(<span class="string">&quot;after&quot;</span>, after);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ã€é¢„æœŸã€‘ä»ä»£ç é€»è¾‘æ¥çœ‹ï¼Œæˆ‘ä»¬é¢„æœŸç¬¬ä¸€æ¬¡è·å–çš„å€¼å§‹ç»ˆåº”è¯¥æ˜¯ nullã€‚</p>
<p>ã€å®é™…ã€‘</p>
<p>ä¸ºäº†æ–¹ä¾¿å¤ç°ï¼Œå°† Tomcat å·¥ä½œçº¿ç¨‹è®¾ä¸º 1ï¼š</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server.tomcat.max-threads</span>=<span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>å½“è®¿é—® id &#x3D; 1 æ—¶ï¼Œç¬¦åˆé¢„æœŸ</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/20200731111854.png" alt="img"></p>
<p>å½“è®¿é—® id &#x3D; 2 æ—¶ï¼Œbefore çš„åº”ç­”ä¸æ˜¯ nullï¼Œè€Œæ˜¯ 1ï¼Œä¸ç¬¦åˆé¢„æœŸã€‚</p>
<p>ã€åˆ†æã€‘å®é™…æƒ…å†µå’Œé¢„æœŸå­˜åœ¨åå·®ã€‚Spring Boot ç¨‹åºè¿è¡Œåœ¨ Tomcat ä¸­ï¼Œæ‰§è¡Œç¨‹åºçš„çº¿ç¨‹æ˜¯ Tomcat çš„å·¥ä½œçº¿ç¨‹ï¼Œè€Œ Tomcat çš„å·¥ä½œçº¿ç¨‹æ˜¯åŸºäºçº¿ç¨‹æ± çš„ã€‚<strong>çº¿ç¨‹æ± ä¼šé‡ç”¨å›ºå®šçš„å‡ ä¸ªçº¿ç¨‹ï¼Œä¸€æ—¦çº¿ç¨‹é‡ç”¨ï¼Œé‚£ä¹ˆå¾ˆå¯èƒ½é¦–æ¬¡ä»</strong><br><strong>ThreadLocal è·å–çš„å€¼æ˜¯ä¹‹å‰å…¶ä»–ç”¨æˆ·çš„è¯·æ±‚é—ç•™çš„å€¼ã€‚è¿™æ—¶ï¼ŒThreadLocal ä¸­çš„ç”¨æˆ·ä¿¡æ¯å°±æ˜¯å…¶ä»–ç”¨æˆ·çš„ä¿¡æ¯</strong>ã€‚</p>
<p><strong>å¹¶ä¸èƒ½è®¤ä¸ºæ²¡æœ‰æ˜¾å¼å¼€å¯å¤šçº¿ç¨‹å°±ä¸ä¼šæœ‰çº¿ç¨‹å®‰å…¨é—®é¢˜</strong>ã€‚ä½¿ç”¨ç±»ä¼¼ ThreadLocal å·¥å…·æ¥å­˜æ”¾ä¸€äº›æ•°æ®æ—¶ï¼Œéœ€è¦ç‰¹åˆ«æ³¨æ„åœ¨ä»£ç è¿è¡Œå®Œåï¼Œæ˜¾å¼åœ°å»æ¸…ç©ºè®¾ç½®çš„æ•°æ®ã€‚</p>
<h4 id="ThreadLocal-é”™è¯¯æ¡ˆä¾‹ä¿®æ­£"><a href="#ThreadLocal-é”™è¯¯æ¡ˆä¾‹ä¿®æ­£" class="headerlink" title="ThreadLocal é”™è¯¯æ¡ˆä¾‹ä¿®æ­£"></a>ThreadLocal é”™è¯¯æ¡ˆä¾‹ä¿®æ­£</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;right&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Map&lt;String, String&gt; <span class="title function_">right</span><span class="params">(<span class="meta">@RequestParam(&quot;id&quot;)</span> Integer userId)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">before</span> <span class="operator">=</span> Thread.currentThread().getName() + <span class="string">&quot;:&quot;</span> + currentUser.get();</span><br><span class="line">    currentUser.set(userId);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">after</span> <span class="operator">=</span> Thread.currentThread().getName() + <span class="string">&quot;:&quot;</span> + currentUser.get();</span><br><span class="line">        Map&lt;String, String&gt; result = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        result.put(<span class="string">&quot;before&quot;</span>, before);</span><br><span class="line">        result.put(<span class="string">&quot;after&quot;</span>, after);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">//åœ¨ finally ä»£ç å—ä¸­åˆ é™¤ ThreadLocal ä¸­çš„æ•°æ®ï¼Œç¡®ä¿æ•°æ®ä¸ä¸²</span></span><br><span class="line">        currentUser.remove();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="InheritableThreadLocal"><a href="#InheritableThreadLocal" class="headerlink" title="InheritableThreadLocal"></a>InheritableThreadLocal</h3><p>é€šè¿‡ <code>ThreadLocal</code> åˆ›å»ºçš„çº¿ç¨‹å˜é‡ï¼Œå…¶å­çº¿ç¨‹æ˜¯æ— æ³•ç»§æ‰¿çš„ã€‚ä¹Ÿå°±æ˜¯è¯´ä½ åœ¨çº¿ç¨‹ä¸­é€šè¿‡ <code>ThreadLocal</code> åˆ›å»ºäº†çº¿ç¨‹å˜é‡ Vï¼Œè€Œåè¯¥çº¿ç¨‹åˆ›å»ºäº†å­çº¿ç¨‹ï¼Œä½ åœ¨å­çº¿ç¨‹ä¸­æ˜¯æ— æ³•é€šè¿‡ <code>ThreadLocal</code> æ¥è®¿é—®çˆ¶çº¿ç¨‹çš„çº¿ç¨‹å˜é‡ V çš„ã€‚</p>
<p>å¦‚æœä½ éœ€è¦å­çº¿ç¨‹ç»§æ‰¿çˆ¶çº¿ç¨‹çš„çº¿ç¨‹å˜é‡ï¼Œé‚£è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿå…¶å®å¾ˆç®€å•ï¼ŒJava æä¾›äº† <code>InheritableThreadLocal</code> æ¥æ”¯æŒè¿™ç§ç‰¹æ€§ï¼Œ<code>InheritableThreadLocal</code> æ˜¯ <code>ThreadLocal</code> å­ç±»ï¼Œæ‰€ä»¥ç”¨æ³•å’Œ <code>ThreadLocal</code> ç›¸åŒã€‚ä¸ <code>ThreadLocal</code> ä¸åŒçš„æ˜¯ï¼Œ<code>InheritableThreadLocal</code> å…è®¸ä¸€ä¸ªçº¿ç¨‹ä»¥åŠè¯¥çº¿ç¨‹åˆ›å»ºçš„æ‰€æœ‰å­çº¿ç¨‹éƒ½å¯ä»¥è®¿é—®å®ƒä¿å­˜çš„æ•°æ®ã€‚</p>
<p>ä¸è¿‡ï¼Œå®Œå…¨ä¸å»ºè®®ä½ åœ¨çº¿ç¨‹æ± ä¸­ä½¿ç”¨ <code>InheritableThreadLocal</code>ï¼Œä¸ä»…ä»…æ˜¯å› ä¸ºå®ƒå…·æœ‰ <code>ThreadLocal</code> ç›¸åŒçš„ç¼ºç‚¹â€”â€”å¯èƒ½å¯¼è‡´å†…å­˜æ³„éœ²ï¼Œæ›´é‡è¦çš„åŸå› æ˜¯ï¼šçº¿ç¨‹æ± ä¸­çº¿ç¨‹çš„åˆ›å»ºæ˜¯åŠ¨æ€çš„ï¼Œå¾ˆå®¹æ˜“å¯¼è‡´ç»§æ‰¿å…³ç³»é”™ä¹±ï¼Œå¦‚æœä½ çš„ä¸šåŠ¡é€»è¾‘ä¾èµ– <code>InheritableThreadLocal</code>ï¼Œé‚£ä¹ˆå¾ˆå¯èƒ½å¯¼è‡´ä¸šåŠ¡é€»è¾‘è®¡ç®—é”™è¯¯ï¼Œè€Œè¿™ä¸ªé”™è¯¯å¾€å¾€æ¯”å†…å­˜æ³„éœ²æ›´è¦å‘½ã€‚</p>
<blockquote>
<p>åŸç†å‚è€ƒï¼š<a target="_blank" rel="noopener" href="https://blog.csdn.net/ni357103403/article/details/51970748">Java å¤šçº¿ç¨‹ï¼šInheritableThreadLocal å®ç°åŸç†</a></p>
</blockquote>
<h2 id="Immutability-æ¨¡å¼"><a href="#Immutability-æ¨¡å¼" class="headerlink" title="Immutability æ¨¡å¼"></a>Immutability æ¨¡å¼</h2><p>è§£å†³å¹¶å‘é—®é¢˜ï¼Œå…¶å®æœ€ç®€å•çš„åŠæ³•å°±æ˜¯è®©å…±äº«å˜é‡åªæœ‰è¯»æ“ä½œï¼Œè€Œæ²¡æœ‰å†™æ“ä½œã€‚è¿™ä¸ªåŠæ³•å¦‚æ­¤é‡è¦ï¼Œä»¥è‡³äºè¢«ä¸Šå‡åˆ°äº†ä¸€ç§è§£å†³å¹¶å‘é—®é¢˜çš„è®¾è®¡æ¨¡å¼ï¼š<strong>ä¸å˜æ€§ï¼ˆImmutabilityï¼‰æ¨¡å¼</strong>ã€‚æ‰€è°“<strong>ä¸å˜æ€§ï¼Œæ˜¯æŒ‡ï¼šä¸€æ—¦åˆ›å»ºï¼ŒçŠ¶æ€ä¸å†å˜åŒ–</strong>ã€‚æ¢å¥è¯è¯´ï¼Œå°±æ˜¯å˜é‡ä¸€æ—¦è¢«èµ‹å€¼ï¼Œå°±ä¸å…è®¸ä¿®æ”¹äº†ï¼ˆæ²¡æœ‰å†™æ“ä½œï¼‰ï¼›æ²¡æœ‰ä¿®æ”¹æ“ä½œï¼Œä¹Ÿå°±æ˜¯ä¿æŒäº†ä¸å˜æ€§ã€‚</p>
<h3 id="å¿«é€Ÿå®ç°å…·å¤‡ä¸å¯å˜æ€§çš„ç±»"><a href="#å¿«é€Ÿå®ç°å…·å¤‡ä¸å¯å˜æ€§çš„ç±»" class="headerlink" title="å¿«é€Ÿå®ç°å…·å¤‡ä¸å¯å˜æ€§çš„ç±»"></a>å¿«é€Ÿå®ç°å…·å¤‡ä¸å¯å˜æ€§çš„ç±»</h3><p><strong>å°†ä¸€ä¸ªç±»æ‰€æœ‰çš„å±æ€§éƒ½è®¾ç½®æˆ final çš„ï¼Œå¹¶ä¸”åªå…è®¸å­˜åœ¨åªè¯»æ–¹æ³•ï¼Œé‚£ä¹ˆè¿™ä¸ªç±»åŸºæœ¬ä¸Šå°±å…·å¤‡ä¸å¯å˜æ€§äº†</strong>ã€‚æ›´ä¸¥æ ¼çš„åšæ³•æ˜¯<strong>è¿™ä¸ªç±»æœ¬èº«ä¹Ÿæ˜¯ final çš„</strong>ï¼Œä¹Ÿå°±æ˜¯ä¸å…è®¸ç»§æ‰¿ã€‚å› ä¸ºå­ç±»å¯ä»¥è¦†ç›–çˆ¶ç±»çš„æ–¹æ³•ï¼Œæœ‰å¯èƒ½æ”¹å˜ä¸å¯å˜æ€§ï¼Œæ‰€ä»¥æ¨èä½ åœ¨å®é™…å·¥ä½œä¸­ï¼Œä½¿ç”¨è¿™ç§æ›´ä¸¥æ ¼çš„åšæ³•ã€‚</p>
<p>åœ¨ Java ä¸­ï¼Œç»å¸¸ç”¨åˆ°çš„ <code>String</code> å’Œ <code>Long</code>ã€<code>Integer</code>ã€<code>Double</code> ç­‰åŸºç¡€ç±»å‹çš„åŒ…è£…ç±»éƒ½å…·å¤‡ä¸å¯å˜æ€§ï¼Œè¿™äº›å¯¹è±¡çš„çº¿ç¨‹å®‰å…¨æ€§éƒ½æ˜¯é ä¸å¯å˜æ€§æ¥ä¿è¯çš„ã€‚å¦‚æœä½ ä»”ç»†ç¿»çœ‹è¿™äº›ç±»çš„å£°æ˜ã€å±æ€§å’Œæ–¹æ³•ï¼Œä½ ä¼šå‘ç°å®ƒä»¬éƒ½ä¸¥æ ¼éµå®ˆä¸å¯å˜ç±»çš„ä¸‰ç‚¹è¦æ±‚ï¼š<strong>ç±»å’Œå±æ€§éƒ½æ˜¯ final çš„ï¼Œæ‰€æœ‰æ–¹æ³•å‡æ˜¯åªè¯»çš„</strong>ã€‚</p>
<p><code>String</code> è¿™ä¸ªç±»è™½ç„¶æœ‰æ›¿æ¢æ“ä½œï¼Œä½†å®é™…ä»æ˜¯åªè¯»çš„ã€‚é˜…è¯» <code>String</code> æºç å¯ä»¥å‘ç°ï¼š<code>String</code> è¿™ä¸ªç±»ä»¥åŠå®ƒçš„å±æ€§ <code>value[]</code> éƒ½æ˜¯ <code>final</code> çš„ï¼›è€Œ <code>replace()</code> æ–¹æ³•çš„å®ç°ï¼Œå°±çš„ç¡®æ²¡æœ‰ä¿®æ”¹ <code>value[]</code>ï¼Œè€Œæ˜¯å°†æ›¿æ¢åçš„å­—ç¬¦ä¸²ä½œä¸ºè¿”å›å€¼è¿”å›äº†ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">String</span> &#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">char</span> value[];</span><br><span class="line">  <span class="comment">// å­—ç¬¦æ›¿æ¢</span></span><br><span class="line">  String <span class="title function_">replace</span><span class="params">(<span class="type">char</span> oldChar,</span></span><br><span class="line"><span class="params">      <span class="type">char</span> newChar)</span> &#123;</span><br><span class="line">    <span class="comment">//æ— éœ€æ›¿æ¢ï¼Œç›´æ¥è¿”å› this</span></span><br><span class="line">    <span class="keyword">if</span> (oldChar == newChar)&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> value.length;</span><br><span class="line">    <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">    <span class="comment">/* avoid getfield opcode */</span></span><br><span class="line">    <span class="type">char</span>[] val = value;</span><br><span class="line">    <span class="comment">//å®šä½åˆ°éœ€è¦æ›¿æ¢çš„å­—ç¬¦ä½ç½®</span></span><br><span class="line">    <span class="keyword">while</span> (++i &lt; len) &#123;</span><br><span class="line">      <span class="keyword">if</span> (val[i] == oldChar) &#123;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//æœªæ‰¾åˆ° oldCharï¼Œæ— éœ€æ›¿æ¢</span></span><br><span class="line">    <span class="keyword">if</span> (i &gt;= len) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//åˆ›å»ºä¸€ä¸ª buf[]ï¼Œè¿™æ˜¯å…³é”®</span></span><br><span class="line">    <span class="comment">//ç”¨æ¥ä¿å­˜æ›¿æ¢åçš„å­—ç¬¦ä¸²</span></span><br><span class="line">    <span class="type">char</span> buf[] = <span class="keyword">new</span> <span class="title class_">char</span>[len];</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; i; j++) &#123;</span><br><span class="line">      buf[j] = val[j];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> (i &lt; len) &#123;</span><br><span class="line">      <span class="type">char</span> <span class="variable">c</span> <span class="operator">=</span> val[i];</span><br><span class="line">      buf[i] = (c == oldChar) ?</span><br><span class="line">        newChar : c;</span><br><span class="line">      i++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//åˆ›å»ºä¸€ä¸ªæ–°çš„å­—ç¬¦ä¸²è¿”å›</span></span><br><span class="line">    <span class="comment">//åŸå­—ç¬¦ä¸²ä¸ä¼šå‘ç”Ÿä»»ä½•å˜åŒ–</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">String</span>(buf, <span class="literal">true</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡åˆ†æ <code>String</code> çš„å®ç°ï¼Œä½ å¯èƒ½å·²ç»å‘ç°äº†ï¼Œå¦‚æœå…·å¤‡ä¸å¯å˜æ€§çš„ç±»ï¼Œéœ€è¦æä¾›ç±»ä¼¼ä¿®æ”¹çš„åŠŸèƒ½ï¼Œå…·ä½“è¯¥æ€ä¹ˆæ“ä½œå‘¢ï¼Ÿåšæ³•å¾ˆç®€å•ï¼Œé‚£å°±æ˜¯<strong>åˆ›å»ºä¸€ä¸ªæ–°çš„ä¸å¯å˜å¯¹è±¡</strong>ï¼Œè¿™æ˜¯ä¸å¯å˜å¯¹è±¡çš„ä¸€ä¸ªé‡è¦åŒºåˆ«ï¼Œå¯å˜å¯¹è±¡å¾€å¾€æ˜¯ä¿®æ”¹è‡ªå·±çš„å±æ€§ã€‚</p>
<h3 id="ä½¿ç”¨-Immutability-æ¨¡å¼çš„æ³¨æ„äº‹é¡¹"><a href="#ä½¿ç”¨-Immutability-æ¨¡å¼çš„æ³¨æ„äº‹é¡¹" class="headerlink" title="ä½¿ç”¨ Immutability æ¨¡å¼çš„æ³¨æ„äº‹é¡¹"></a>ä½¿ç”¨ Immutability æ¨¡å¼çš„æ³¨æ„äº‹é¡¹</h3><p>åœ¨ä½¿ç”¨ Immutability æ¨¡å¼çš„æ—¶å€™ï¼Œéœ€è¦æ³¨æ„ä»¥ä¸‹ä¸¤ç‚¹ï¼š</p>
<ol>
<li>å¯¹è±¡çš„æ‰€æœ‰å±æ€§éƒ½æ˜¯ final çš„ï¼Œå¹¶ä¸èƒ½ä¿è¯ä¸å¯å˜æ€§ï¼›</li>
<li>ä¸å¯å˜å¯¹è±¡ä¹Ÿéœ€è¦æ­£ç¡®å‘å¸ƒã€‚</li>
</ol>
<p>åœ¨ Java è¯­è¨€ä¸­ï¼Œfinal ä¿®é¥°çš„å±æ€§ä¸€æ—¦è¢«èµ‹å€¼ï¼Œå°±ä¸å¯ä»¥å†ä¿®æ”¹ï¼Œä½†æ˜¯å¦‚æœå±æ€§çš„ç±»å‹æ˜¯æ™®é€šå¯¹è±¡ï¼Œé‚£ä¹ˆè¿™ä¸ªæ™®é€šå¯¹è±¡çš„å±æ€§æ˜¯å¯ä»¥è¢«ä¿®æ”¹çš„ã€‚ä¾‹å¦‚ä¸‹é¢çš„ä»£ç ä¸­ï¼ŒBar çš„å±æ€§ foo è™½ç„¶æ˜¯ final çš„ï¼Œä¾ç„¶å¯ä»¥é€šè¿‡ setAge() æ–¹æ³•æ¥è®¾ç½® foo çš„å±æ€§ ageã€‚æ‰€ä»¥ï¼Œ<strong>åœ¨ä½¿ç”¨ Immutability æ¨¡å¼çš„æ—¶å€™ä¸€å®šè¦ç¡®è®¤ä¿æŒä¸å˜æ€§çš„è¾¹ç•Œåœ¨å“ªé‡Œï¼Œæ˜¯å¦è¦æ±‚å±æ€§å¯¹è±¡ä¹Ÿå…·å¤‡ä¸å¯å˜æ€§</strong>ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Foo</span>&#123;</span><br><span class="line">  <span class="type">int</span> age=<span class="number">0</span>;</span><br><span class="line">  <span class="type">int</span> name=<span class="string">&quot;abc&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Bar</span> &#123;</span><br><span class="line">  <span class="keyword">final</span> Foo foo;</span><br><span class="line">  <span class="keyword">void</span> <span class="title function_">setAge</span><span class="params">(<span class="type">int</span> a)</span>&#123;</span><br><span class="line">    foo.age=a;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸å¯å˜å¯¹è±¡è™½ç„¶æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œä½†æ˜¯å¹¶ä¸æ„å‘³ç€å¼•ç”¨è¿™äº›ä¸å¯å˜å¯¹è±¡çš„å¯¹è±¡å°±æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚ä¾‹å¦‚åœ¨ä¸‹é¢çš„ä»£ç ä¸­ï¼ŒFoo å…·å¤‡ä¸å¯å˜æ€§ï¼Œçº¿ç¨‹å®‰å…¨ï¼Œä½†æ˜¯ç±» Bar å¹¶ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œç±» Bar ä¸­æŒæœ‰å¯¹ Foo çš„å¼•ç”¨ fooï¼Œå¯¹ foo è¿™ä¸ªå¼•ç”¨çš„ä¿®æ”¹åœ¨å¤šçº¿ç¨‹ä¸­å¹¶ä¸èƒ½ä¿è¯å¯è§æ€§å’ŒåŸå­æ€§ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Foo çº¿ç¨‹å®‰å…¨</span></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Foo</span>&#123;</span><br><span class="line">  <span class="keyword">final</span> <span class="type">int</span> age=<span class="number">0</span>;</span><br><span class="line">  <span class="keyword">final</span> <span class="type">int</span> name=<span class="string">&quot;abc&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//Bar çº¿ç¨‹ä¸å®‰å…¨</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Bar</span> &#123;</span><br><span class="line">  Foo foo;</span><br><span class="line">  <span class="keyword">void</span> <span class="title function_">setFoo</span><span class="params">(Foo f)</span>&#123;</span><br><span class="line">    <span class="built_in">this</span>.foo=f;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¦‚æœä½ çš„ç¨‹åºä»…ä»…éœ€è¦ foo ä¿æŒå¯è§æ€§ï¼Œæ— éœ€ä¿è¯åŸå­æ€§ï¼Œé‚£ä¹ˆå¯ä»¥å°† foo å£°æ˜ä¸º volatile å˜é‡ï¼Œè¿™æ ·å°±èƒ½ä¿è¯å¯è§æ€§ã€‚å¦‚æœä½ çš„ç¨‹åºéœ€è¦ä¿è¯åŸå­æ€§ï¼Œé‚£ä¹ˆå¯ä»¥é€šè¿‡åŸå­ç±»æ¥å®ç°ã€‚ä¸‹é¢çš„ç¤ºä¾‹ä»£ç æ˜¯åˆç†åº“å­˜çš„åŸå­åŒ–å®ç°ï¼Œä½ åº”è¯¥å¾ˆç†Ÿæ‚‰äº†ï¼Œå…¶ä¸­å°±æ˜¯ç”¨åŸå­ç±»è§£å†³äº†ä¸å¯å˜å¯¹è±¡å¼•ç”¨çš„åŸå­æ€§é—®é¢˜ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SafeWM</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">WMRange</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> upper;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> lower;</span><br><span class="line">        WMRange(<span class="type">int</span> upper, <span class="type">int</span> lower) &#123;</span><br><span class="line">            <span class="comment">//çœç•¥æ„é€ å‡½æ•°å®ç°</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> AtomicReference&lt;WMRange&gt; rf = <span class="keyword">new</span> <span class="title class_">AtomicReference</span>&lt;&gt;(<span class="keyword">new</span> <span class="title class_">WMRange</span>(<span class="number">0</span>, <span class="number">0</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¾ç½®åº“å­˜ä¸Šé™</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">setUpper</span><span class="params">(<span class="type">int</span> v)</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="type">WMRange</span> <span class="variable">or</span> <span class="operator">=</span> rf.get();</span><br><span class="line">            <span class="comment">// æ£€æŸ¥å‚æ•°åˆæ³•æ€§</span></span><br><span class="line">            <span class="keyword">if</span> (v &lt; or.lower) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">WMRange</span> <span class="variable">nr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">WMRange</span>(v, or.lower);</span><br><span class="line">            <span class="keyword">if</span> (rf.compareAndSet(or, nr)) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Copy-on-Write-æ¨¡å¼"><a href="#Copy-on-Write-æ¨¡å¼" class="headerlink" title="Copy-on-Write æ¨¡å¼"></a>Copy-on-Write æ¨¡å¼</h2><p>æ‰€è°“ Copy-on-Writeï¼Œç»å¸¸è¢«ç¼©å†™ä¸º CoWï¼Œé¡¾åæ€ä¹‰å°±æ˜¯<strong>å†™æ—¶å¤åˆ¶</strong>ã€‚</p>
<p>Java æ”¯æŒ <code>CopyOnWriteArrayList</code> å’Œ <code>CopyOnWriteArraySet</code> ä¸¤ç§å¹¶å‘å®¹å™¨ï¼Œå…¶è®¾è®¡æ€æƒ³å°±æ˜¯ CoWï¼›é€šè¿‡ Copy-on-Write è¿™ä¸¤ä¸ªå®¹å™¨å®ç°çš„è¯»æ“ä½œæ˜¯æ— é”çš„ï¼Œç”±äºæ— é”ï¼Œæ‰€ä»¥å°†è¯»æ“ä½œçš„æ€§èƒ½å‘æŒ¥åˆ°äº†æè‡´ã€‚</p>
<p>CoW æ˜¯ä¸€é¡¹éå¸¸é€šç”¨çš„æŠ€æœ¯æ–¹æ¡ˆï¼Œåœ¨å¾ˆå¤šé¢†åŸŸéƒ½æœ‰ç€å¹¿æ³›çš„åº”ç”¨ã€‚ä¸è¿‡ï¼Œå®ƒä¹Ÿæœ‰ç¼ºç‚¹çš„ï¼Œé‚£å°±æ˜¯æ¶ˆè€—å†…å­˜ï¼Œæ¯æ¬¡ä¿®æ”¹éƒ½éœ€è¦å¤åˆ¶ä¸€ä¸ªæ–°çš„å‰¯æœ¬å‡ºæ¥ã€‚</p>
<h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ul>
<li><a target="_blank" rel="noopener" href="https://book.douban.com/subject/10484692/">ã€ŠJava å¹¶å‘ç¼–ç¨‹å®æˆ˜ã€‹</a></li>
<li><a target="_blank" rel="noopener" href="https://book.douban.com/subject/26591326/">ã€ŠJava å¹¶å‘ç¼–ç¨‹çš„è‰ºæœ¯ã€‹</a></li>
<li><a target="_blank" rel="noopener" href="https://book.douban.com/subject/34907497/">ã€Šæ·±å…¥ç†è§£ Java è™šæ‹Ÿæœºã€‹</a></li>
<li><a target="_blank" rel="noopener" href="https://time.geekbang.org/column/intro/100047701">æå®¢æ—¶é—´æ•™ç¨‹ - Java ä¸šåŠ¡å¼€å‘å¸¸è§é”™è¯¯ 100 ä¾‹</a></li>
<li><a target="_blank" rel="noopener" href="http://tutorials.jenkov.com/java-concurrency/non-blocking-algorithms.html">Non-blocking Algorithms</a></li>
<li><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/473e14d5ab2d">Java CAS å®Œå…¨è§£è¯»</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/ls5718/article/details/52563959">Java ä¸­ CAS è¯¦è§£</a></li>
<li><a target="_blank" rel="noopener" href="http://www.itsoku.com/article/182">JUC ä¸­çš„åŸå­ç±»</a></li>
<li><a target="_blank" rel="noopener" href="https://juejin.im/post/5a64a581f265da3e3b7aa02d">ThreadLocal ç»ˆæç¯‡</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://dunwu.github.io/blog/pages/eca43004/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/uploads/avatar.gif">
      <meta itemprop="name" content="é’æ‚Ÿ â—¾ Dunwu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dunwu Blog">
      <meta itemprop="description" content="é’æ‚Ÿçš„ä¸ªäººåšå®¢">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Dunwu Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/pages/eca43004/" class="post-title-link" itemprop="url">Java å¹¶å‘ä¹‹åŒæ­¥å·¥å…·</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2019-12-24 23:52:25" itemprop="dateCreated datePublished" datetime="2019-12-24T23:52:25+08:00">2019-12-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">æ›´æ–°äº</span>
      <time title="ä¿®æ”¹æ—¶é—´ï¼š2025-09-13 17:56:53" itemprop="dateModified" datetime="2025-09-13T17:56:53+08:00">2025-09-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
        </span>
          ï¼Œ
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/JavaCore/" itemprop="url" rel="index"><span itemprop="name">JavaCore</span></a>
        </span>
          ï¼Œ
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Java/JavaCore/%E5%B9%B6%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">å¹¶å‘</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
      <span>8.5k</span>
    </span>
    <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
      <span>8 åˆ†é’Ÿ</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Java-å¹¶å‘ä¹‹åŒæ­¥å·¥å…·"><a href="#Java-å¹¶å‘ä¹‹åŒæ­¥å·¥å…·" class="headerlink" title="Java å¹¶å‘ä¹‹åŒæ­¥å·¥å…·"></a>Java å¹¶å‘ä¹‹åŒæ­¥å·¥å…·</h1><h2 id="Semaphore"><a href="#Semaphore" class="headerlink" title="Semaphore"></a>Semaphore</h2><p><strong><code>Semaphore</code> è¯‘ä¸ºä¿¡å·é‡ï¼Œæ˜¯ä¸€ç§åŒæ­¥æœºåˆ¶ï¼Œç”¨äºæ§åˆ¶å¤šçº¿ç¨‹å¯¹å…±äº«èµ„æºçš„è®¿é—®</strong>ã€‚ä¿¡å·é‡æ˜¯ç”±è®¡ç®—æœºç§‘å­¦å®¶ Edsger Dijkstra äº 1965 å¹´æå‡ºçš„ï¼Œç”¨äºè§£å†³æ‰€è°“çš„â€œä¸´ç•ŒåŒºâ€é—®é¢˜ï¼Œå³å¤šä¸ªè¿›ç¨‹æˆ–çº¿ç¨‹è¯•å›¾åŒæ—¶è®¿é—®å…±äº«èµ„æºï¼ˆå¦‚æ‰“å°æœºã€å†…å­˜ç¼“å†²åŒºç­‰ï¼‰æ—¶å¯èƒ½å‡ºç°çš„é—®é¢˜ã€‚</p>
<h3 id="ä¿¡å·é‡æ¨¡å‹"><a href="#ä¿¡å·é‡æ¨¡å‹" class="headerlink" title="ä¿¡å·é‡æ¨¡å‹"></a>ä¿¡å·é‡æ¨¡å‹</h3><p>ä¿¡å·é‡æ¨¡å‹è¿˜æ˜¯å¾ˆç®€å•çš„ï¼Œå¯ä»¥ç®€å•æ¦‚æ‹¬ä¸ºï¼š<strong>ä¸€ä¸ªè®¡æ•°å™¨ï¼Œä¸€ä¸ªç­‰å¾…é˜Ÿåˆ—ï¼Œä¸‰ä¸ªæ–¹æ³•</strong>ã€‚åœ¨ä¿¡å·é‡æ¨¡å‹é‡Œï¼Œè®¡æ•°å™¨å’Œç­‰å¾…é˜Ÿåˆ—å¯¹å¤–æ˜¯é€æ˜çš„ï¼Œæ‰€ä»¥åªèƒ½é€šè¿‡ä¿¡å·é‡æ¨¡å‹æä¾›çš„ä¸‰ä¸ªæ–¹æ³•æ¥è®¿é—®å®ƒä»¬ï¼Œè¿™ä¸‰ä¸ªæ–¹æ³•åˆ†åˆ«æ˜¯ï¼šinit()ã€down() å’Œ up()ã€‚</p>
<p><img src="https://learn.lianglianglee.com/%e4%b8%93%e6%a0%8f/Java%e5%b9%b6%e5%8f%91%e7%bc%96%e7%a8%8b%e5%ae%9e%e6%88%98/assets/6dfeeb9180ff3e038478f2a7dccc9b5c.png"></p>
<ul>
<li><p>è¿™ä¸‰ä¸ªæ–¹æ³•è¯¦ç»†çš„è¯­ä¹‰å…·ä½“å¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<ul>
<li>init()ï¼šè®¾ç½®è®¡æ•°å™¨çš„åˆå§‹å€¼ã€‚</li>
<li>down()ï¼šè®¡æ•°å™¨çš„å€¼å‡ 1ï¼›å¦‚æœæ­¤æ—¶è®¡æ•°å™¨çš„å€¼å°äº 0ï¼Œåˆ™å½“å‰çº¿ç¨‹å°†è¢«é˜»å¡ï¼Œå¦åˆ™å½“å‰çº¿ç¨‹å¯ä»¥ç»§ç»­æ‰§è¡Œã€‚</li>
<li>up()ï¼šè®¡æ•°å™¨çš„å€¼åŠ  1ï¼›å¦‚æœæ­¤æ—¶è®¡æ•°å™¨çš„å€¼å°äºæˆ–è€…ç­‰äº 0ï¼Œåˆ™å”¤é†’ç­‰å¾…é˜Ÿåˆ—ä¸­çš„ä¸€ä¸ªçº¿ç¨‹ï¼Œå¹¶å°†å…¶ä»ç­‰å¾…é˜Ÿåˆ—ä¸­ç§»é™¤ã€‚</li>
</ul>
<p>è¿™é‡Œæåˆ°çš„ init()ã€down() å’Œ up() ä¸‰ä¸ªæ–¹æ³•éƒ½æ˜¯åŸå­æ€§çš„ï¼Œå¹¶ä¸”è¿™ä¸ªåŸå­æ€§æ˜¯ç”±ä¿¡å·é‡æ¨¡å‹çš„å®ç°æ–¹ä¿è¯çš„ã€‚åœ¨ Java ä¸­ï¼Œä¿¡å·é‡æ¨¡å‹æ˜¯ç”± java.util.concurrent.Semaphore å®ç°çš„ï¼ŒSemaphore è¿™ä¸ªç±»èƒ½å¤Ÿä¿è¯è¿™ä¸‰ä¸ªæ–¹æ³•éƒ½æ˜¯åŸå­æ“ä½œã€‚</p>
<p>ä¿¡å·é‡æ¨¡å‹é‡Œé¢ï¼Œdown()ã€up() è¿™ä¸¤ä¸ªæ“ä½œå†å²ä¸Šæœ€æ—©ç§°ä¸º P æ“ä½œå’Œ V æ“ä½œï¼Œæ‰€ä»¥ä¿¡å·é‡æ¨¡å‹ä¹Ÿè¢«ç§°ä¸º PV åŸè¯­ã€‚</p>
</li>
</ul>
<h3 id="Semaphore-ä½¿ç”¨"><a href="#Semaphore-ä½¿ç”¨" class="headerlink" title="Semaphore ä½¿ç”¨"></a>Semaphore ä½¿ç”¨</h3><p><code>Semaphore</code> æä¾›äº† 2 ä¸ªæ„é€ æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å‚æ•° permits è¡¨ç¤ºè®¸å¯æ•°ç›®ï¼Œå³åŒæ—¶å¯ä»¥å…è®¸å¤šå°‘çº¿ç¨‹è¿›è¡Œè®¿é—®</span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">Semaphore</span><span class="params">(<span class="type">int</span> <span class="keyword">permits</span>)</span> &#123;&#125;</span><br><span class="line"><span class="comment">// å‚æ•° fair è¡¨ç¤ºæ˜¯å¦æ˜¯å…¬å¹³çš„ï¼Œå³ç­‰å¾…æ—¶é—´è¶Šä¹…çš„è¶Šå…ˆè·å–è®¸å¯</span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">Semaphore</span><span class="params">(<span class="type">int</span> <span class="keyword">permits</span>, <span class="type">boolean</span> fair)</span> &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>è¯´æ˜ï¼š</p>
<ul>
<li><code>permits</code> - åˆå§‹åŒ–å›ºå®šæ•°é‡çš„ permitã€‚</li>
<li><code>fair</code> - è®¾ç½®æ˜¯å¦ä¸ºå…¬å¹³æ¨¡å¼ã€‚æ‰€è°“å…¬å¹³ï¼Œæ˜¯æŒ‡ç­‰å¾…ä¹…çš„ä¼˜å…ˆè·å– permitã€‚</li>
</ul>
<p><code>Semaphore</code> çš„é‡è¦æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è·å– 1 ä¸ªè®¸å¯</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">acquire</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;&#125;</span><br><span class="line"><span class="comment">//è·å– permits ä¸ªè®¸å¯</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">acquire</span><span class="params">(<span class="type">int</span> <span class="keyword">permits</span>)</span> <span class="keyword">throws</span> InterruptedException &#123;&#125;</span><br><span class="line"><span class="comment">// é‡Šæ”¾ 1 ä¸ªè®¸å¯</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">release</span><span class="params">()</span> &#123;&#125;</span><br><span class="line"><span class="comment">//é‡Šæ”¾ permits ä¸ªè®¸å¯</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">release</span><span class="params">(<span class="type">int</span> <span class="keyword">permits</span>)</span> &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>è¯´æ˜ï¼š</p>
<ul>
<li><code>acquire()</code> - è·å– 1 ä¸ª permitã€‚</li>
<li><code>acquire(int permits)</code> - è·å– permits æ•°é‡çš„ permitã€‚</li>
<li><code>release()</code> - é‡Šæ”¾ 1 ä¸ª permitã€‚</li>
<li><code>release(int permits)</code> - é‡Šæ”¾ permits æ•°é‡çš„ permitã€‚</li>
</ul>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/cs/java/javacore/concurrent/Semaphore.png" alt="img"></p>
<p>ã€ç¤ºä¾‹ã€‘Semaphore ä½¿ç”¨ç¤ºä¾‹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SemaphoreDemo</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">THREAD_COUNT</span> <span class="operator">=</span> <span class="number">30</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">ExecutorService</span> <span class="variable">threadPool</span> <span class="operator">=</span> Executors.newFixedThreadPool(THREAD_COUNT);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">Semaphore</span> <span class="variable">semaphore</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Semaphore</span>(<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; THREAD_COUNT; i++) &#123;</span><br><span class="line">            threadPool.execute(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        semaphore.acquire();</span><br><span class="line">                        System.out.println(<span class="string">&quot;save data&quot;</span>);</span><br><span class="line">                        semaphore.release();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        threadPool.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Semaphore-åŸç†"><a href="#Semaphore-åŸç†" class="headerlink" title="Semaphore åŸç†"></a>Semaphore åŸç†</h3><p><code>Semaphore</code> æ˜¯å…±äº«é”çš„ä¸€ç§å®ç°ï¼Œå®ƒé»˜è®¤æ„é€  AQS çš„ <code>state</code> å€¼ä¸º <code>permits</code>ï¼Œä½ å¯ä»¥å°† <code>permits</code> çš„å€¼ç†è§£ä¸ºè®¸å¯è¯çš„æ•°é‡ï¼Œåªæœ‰æ‹¿åˆ°è®¸å¯è¯çš„çº¿ç¨‹æ‰èƒ½æ‰§è¡Œã€‚</p>
<p>è°ƒç”¨<code>semaphore.acquire()</code> ï¼Œçº¿ç¨‹å°è¯•è·å–è®¸å¯è¯ï¼Œå¦‚æœ <code>state &gt;= 0</code> çš„è¯ï¼Œåˆ™è¡¨ç¤ºå¯ä»¥è·å–æˆåŠŸã€‚å¦‚æœè·å–æˆåŠŸçš„è¯ï¼Œä½¿ç”¨ CAS æ“ä½œå»ä¿®æ”¹ <code>state</code> çš„å€¼ <code>state=state-1</code>ã€‚å¦‚æœ <code>state&lt;0</code> çš„è¯ï¼Œåˆ™è¡¨ç¤ºè®¸å¯è¯æ•°é‡ä¸è¶³ã€‚æ­¤æ—¶ä¼šåˆ›å»ºä¸€ä¸ª Node èŠ‚ç‚¹åŠ å…¥é˜»å¡é˜Ÿåˆ—ï¼ŒæŒ‚èµ·å½“å‰çº¿ç¨‹ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *  è·å– 1 ä¸ªè®¸å¯è¯</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">acquire</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    sync.acquireSharedInterruptibly(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å…±äº«æ¨¡å¼ä¸‹è·å–è®¸å¯è¯ï¼Œè·å–æˆåŠŸåˆ™è¿”å›ï¼Œå¤±è´¥åˆ™åŠ å…¥é˜»å¡é˜Ÿåˆ—ï¼ŒæŒ‚èµ·çº¿ç¨‹</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">acquireSharedInterruptibly</span><span class="params">(<span class="type">int</span> arg)</span></span><br><span class="line">    <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="keyword">if</span> (Thread.interrupted())</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InterruptedException</span>();</span><br><span class="line">        <span class="comment">// å°è¯•è·å–è®¸å¯è¯ï¼Œarg ä¸ºè·å–è®¸å¯è¯ä¸ªæ•°ï¼Œå½“å¯ç”¨è®¸å¯è¯æ•°å‡å½“å‰è·å–çš„è®¸å¯è¯æ•°ç»“æœå°äº 0, åˆ™åˆ›å»ºä¸€ä¸ªèŠ‚ç‚¹åŠ å…¥é˜»å¡é˜Ÿåˆ—ï¼ŒæŒ‚èµ·å½“å‰çº¿ç¨‹ã€‚</span></span><br><span class="line">    <span class="keyword">if</span> (tryAcquireShared(arg) &lt; <span class="number">0</span>)</span><br><span class="line">      doAcquireSharedInterruptibly(arg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è°ƒç”¨<code>semaphore.release();</code> ï¼Œçº¿ç¨‹å°è¯•é‡Šæ”¾è®¸å¯è¯ï¼Œå¹¶ä½¿ç”¨ CAS æ“ä½œå»ä¿®æ”¹ <code>state</code> çš„å€¼ <code>state=state+1</code>ã€‚é‡Šæ”¾è®¸å¯è¯æˆåŠŸä¹‹åï¼ŒåŒæ—¶ä¼šå”¤é†’åŒæ­¥é˜Ÿåˆ—ä¸­çš„ä¸€ä¸ªçº¿ç¨‹ã€‚è¢«å”¤é†’çš„çº¿ç¨‹ä¼šé‡æ–°å°è¯•å»ä¿®æ”¹ <code>state</code> çš„å€¼ <code>state=state-1</code> ï¼Œå¦‚æœ <code>state&gt;=0</code> åˆ™è·å–ä»¤ç‰ŒæˆåŠŸï¼Œå¦åˆ™é‡æ–°è¿›å…¥é˜»å¡é˜Ÿåˆ—ï¼ŒæŒ‚èµ·çº¿ç¨‹ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é‡Šæ”¾ä¸€ä¸ªè®¸å¯è¯</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">release</span><span class="params">()</span> &#123;</span><br><span class="line">    sync.releaseShared(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// é‡Šæ”¾å…±äº«é”ï¼ŒåŒæ—¶ä¼šå”¤é†’åŒæ­¥é˜Ÿåˆ—ä¸­çš„ä¸€ä¸ªçº¿ç¨‹ã€‚</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">releaseShared</span><span class="params">(<span class="type">int</span> arg)</span> &#123;</span><br><span class="line">    <span class="comment">//é‡Šæ”¾å…±äº«é”</span></span><br><span class="line">    <span class="keyword">if</span> (tryReleaseShared(arg)) &#123;</span><br><span class="line">      <span class="comment">//å”¤é†’åŒæ­¥é˜Ÿåˆ—ä¸­çš„ä¸€ä¸ªçº¿ç¨‹</span></span><br><span class="line">      doReleaseShared();</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="å®ç°ä¸€ä¸ªé™æµå™¨"><a href="#å®ç°ä¸€ä¸ªé™æµå™¨" class="headerlink" title="å®ç°ä¸€ä¸ªé™æµå™¨"></a>å®ç°ä¸€ä¸ªé™æµå™¨</h3><p>Semaphore æœ€é‡è¦çš„ç‰¹æ€§æ˜¯ï¼š<strong>Semaphore å¯ä»¥å…è®¸å¤šä¸ªçº¿ç¨‹è®¿é—®ä¸€ä¸ªä¸´ç•ŒåŒº</strong>ã€‚</p>
<p>Semaphore åœ¨ç°å®ä¸­æœ‰å¾ˆå¤šåº”ç”¨åœºæ™¯ï¼š</p>
<ul>
<li>å„ç§æ± åŒ–èµ„æºï¼Œä¾‹å¦‚è¿æ¥æ± ã€å¯¹è±¡æ± ã€çº¿ç¨‹æ± ç­‰ï¼›</li>
<li>ä¿¡å·é‡é™æµï¼ˆä¾‹å¦‚ Hystrix å°±æ”¯æŒä¿¡å·é‡é™æµæ¨¡å¼ï¼‰ï¼›</li>
</ul>
<p>ã€ç¤ºä¾‹ã€‘ä¸€ä¸ªåŸºäºä¿¡å·é‡å®ç°çš„ç®€å•å¯¹è±¡é™æµå™¨</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SemaphoreRateLimit</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// åˆ›å»ºå¯¹è±¡æ± ï¼Œå¤§å°ä¸º 10</span></span><br><span class="line">        ObjectPool&lt;Long, String&gt; pool = <span class="keyword">new</span> <span class="title class_">ObjectPool</span>&lt;&gt;(<span class="number">10</span>, <span class="number">2L</span>);</span><br><span class="line">        <span class="comment">// é€šè¿‡å¯¹è±¡æ± è·å– tï¼Œä¹‹åæ‰§è¡Œ</span></span><br><span class="line">        pool.exec(t -&gt; &#123;</span><br><span class="line">            System.out.println(t);</span><br><span class="line">            <span class="keyword">return</span> t.toString();</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">ObjectPool</span>&lt;T, R&gt; &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> List&lt;T&gt; pool;</span><br><span class="line">        <span class="comment">// ç”¨ä¿¡å·é‡å®ç°é™æµå™¨</span></span><br><span class="line">        <span class="keyword">final</span> Semaphore sem;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ„é€ å‡½æ•°</span></span><br><span class="line">        ObjectPool(<span class="type">int</span> size, T t) &#123;</span><br><span class="line">            pool = <span class="keyword">new</span> <span class="title class_">Vector</span>&lt;T&gt;() &#123; &#125;;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; size; i++) &#123;</span><br><span class="line">                pool.add(t);</span><br><span class="line">            &#125;</span><br><span class="line">            sem = <span class="keyword">new</span> <span class="title class_">Semaphore</span>(size);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åˆ©ç”¨å¯¹è±¡æ± çš„å¯¹è±¡ï¼Œè°ƒç”¨ func</span></span><br><span class="line">        R <span class="title function_">exec</span><span class="params">(Function&lt;T, R&gt; func)</span> &#123;</span><br><span class="line">            <span class="type">T</span> <span class="variable">t</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                sem.acquire();</span><br><span class="line">                t = pool.remove(<span class="number">0</span>);</span><br><span class="line">                <span class="keyword">return</span> func.apply(t);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                pool.add(t);</span><br><span class="line">                sem.release();</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨è¿™ä¸ªæ–¹æ³•é‡Œé¢ï¼Œæˆ‘ä»¬é¦–å…ˆè°ƒç”¨ acquire() æ–¹æ³•ï¼ˆä¸ä¹‹åŒ¹é…çš„æ˜¯åœ¨ finally é‡Œé¢è°ƒç”¨ release() æ–¹æ³•ï¼‰ï¼Œå‡è®¾å¯¹è±¡æ± çš„å¤§å°æ˜¯ 10ï¼Œä¿¡å·é‡çš„è®¡æ•°å™¨åˆå§‹åŒ–ä¸º 10ï¼Œé‚£ä¹ˆå‰ 10 ä¸ªçº¿ç¨‹è°ƒç”¨ acquire() æ–¹æ³•ï¼Œéƒ½èƒ½ç»§ç»­æ‰§è¡Œï¼Œç›¸å½“äºé€šè¿‡äº†ä¿¡å·é‡ï¼Œè€Œå…¶ä»–çº¿ç¨‹åˆ™ä¼šé˜»å¡åœ¨ acquire() æ–¹æ³•ä¸Šã€‚å¯¹äºé€šè¿‡ä¿¡å·é‡çš„çº¿ç¨‹ï¼Œæˆ‘ä»¬ä¸ºæ¯ä¸ªçº¿ç¨‹åˆ†é…äº†ä¸€ä¸ªå¯¹è±¡ tï¼ˆè¿™ä¸ªåˆ†é…å·¥ä½œæ˜¯é€šè¿‡ pool.remove(0) å®ç°çš„ï¼‰ï¼Œåˆ†é…å®Œä¹‹åä¼šæ‰§è¡Œä¸€ä¸ªå›è°ƒå‡½æ•° funcï¼Œè€Œå‡½æ•°çš„å‚æ•°æ­£æ˜¯å‰é¢åˆ†é…çš„å¯¹è±¡ t ï¼›æ‰§è¡Œå®Œå›è°ƒå‡½æ•°ä¹‹åï¼Œå®ƒä»¬å°±ä¼šé‡Šæ”¾å¯¹è±¡ï¼ˆè¿™ä¸ªé‡Šæ”¾å·¥ä½œæ˜¯é€šè¿‡ pool.add(t) å®ç°çš„ï¼‰ï¼ŒåŒæ—¶è°ƒç”¨ release() æ–¹æ³•æ¥æ›´æ–°ä¿¡å·é‡çš„è®¡æ•°å™¨ã€‚å¦‚æœæ­¤æ—¶ä¿¡å·é‡é‡Œè®¡æ•°å™¨çš„å€¼å°äºç­‰äº 0ï¼Œé‚£ä¹ˆè¯´æ˜æœ‰çº¿ç¨‹åœ¨ç­‰å¾…ï¼Œæ­¤æ—¶ä¼šè‡ªåŠ¨å”¤é†’ç­‰å¾…çš„çº¿ç¨‹ã€‚</p>
<h2 id="CountDownLatch"><a href="#CountDownLatch" class="headerlink" title="CountDownLatch"></a>CountDownLatch</h2><p><strong><code>CountDownLatch</code></strong> å­—é¢æ„æ€ä¸ºé€’å‡è®¡æ•°é”ã€‚ç”¨äº<strong>æ§åˆ¶ä¸€ä¸ªçº¿ç¨‹ç­‰å¾…å¤šä¸ªçº¿ç¨‹</strong>ã€‚</p>
<p><code>CountDownLatch</code> å†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ªè®¡æ•°å™¨ï¼Œè¡¨ç¤ºéœ€è¦ç­‰å¾…çš„äº‹ä»¶æ•°é‡ã€‚<code>countDown</code> æ–¹æ³•é€’å‡è®¡æ•°å™¨ï¼Œè¡¨ç¤ºæœ‰ä¸€ä¸ªäº‹ä»¶å·²ç»å‘ç”Ÿã€‚è°ƒç”¨ <code>await</code> æ–¹æ³•çš„çº¿ç¨‹ä¼šä¸€ç›´é˜»å¡ç›´åˆ°è®¡æ•°å™¨ä¸ºé›¶ï¼Œæˆ–è€…ç­‰å¾…ä¸­çš„çº¿ç¨‹ä¸­æ–­ï¼Œæˆ–è€…ç­‰å¾…è¶…æ—¶ã€‚<code>CountDownLatch</code> æ˜¯ä¸€æ¬¡æ€§çš„ï¼Œè®¡æ•°å™¨çš„å€¼åªèƒ½åœ¨æ„é€ æ–¹æ³•ä¸­åˆå§‹åŒ–ä¸€æ¬¡ï¼Œä¹‹åæ²¡æœ‰ä»»ä½•æœºåˆ¶å†æ¬¡å¯¹å…¶è®¾ç½®å€¼ï¼Œå½“ <code>CountDownLatch</code> ä½¿ç”¨å®Œæ¯•åï¼Œå®ƒä¸èƒ½å†æ¬¡è¢«ä½¿ç”¨ã€‚</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/cs/java/javacore/concurrent/CountDownLatch.png" alt="img"></p>
<p><code>CountDownLatch</code> æ˜¯å…±äº«é”çš„ä¸€ç§å®ç°ï¼Œå®ƒé»˜è®¤æ„é€  AQS çš„ <code>state</code> å€¼ä¸º <code>count</code>ã€‚å½“çº¿ç¨‹ä½¿ç”¨ <code>countDown()</code> æ–¹æ³•æ—¶ï¼Œå…¶å®ä½¿ç”¨äº†<code>tryReleaseShared</code>æ–¹æ³•ä»¥ CAS çš„æ“ä½œæ¥å‡å°‘ <code>state</code>ï¼Œç›´è‡³ <code>state</code> ä¸º 0 ã€‚å½“è°ƒç”¨ <code>await()</code> æ–¹æ³•çš„æ—¶å€™ï¼Œå¦‚æœ <code>state</code> ä¸ä¸º 0ï¼Œé‚£å°±è¯æ˜ä»»åŠ¡è¿˜æ²¡æœ‰æ‰§è¡Œå®Œæ¯•ï¼Œ<code>await()</code> æ–¹æ³•å°±ä¼šä¸€ç›´é˜»å¡ï¼Œä¹Ÿå°±æ˜¯è¯´ <code>await()</code> æ–¹æ³•ä¹‹åçš„è¯­å¥ä¸ä¼šè¢«æ‰§è¡Œã€‚ç›´åˆ°<code>count</code> ä¸ªçº¿ç¨‹è°ƒç”¨äº†<code>countDown()</code>ä½¿ state å€¼è¢«å‡ä¸º 0ï¼Œæˆ–è€…è°ƒç”¨<code>await()</code>çš„çº¿ç¨‹è¢«ä¸­æ–­ï¼Œè¯¥çº¿ç¨‹æ‰ä¼šä»é˜»å¡ä¸­è¢«å”¤é†’ï¼Œ<code>await()</code> æ–¹æ³•ä¹‹åçš„è¯­å¥å¾—åˆ°æ‰§è¡Œã€‚</p>
<p><code>CountDownLatch</code> å”¯ä¸€çš„æ„é€ æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆå§‹åŒ–è®¡æ•°å™¨</span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">CountDownLatch</span><span class="params">(<span class="type">int</span> count)</span> &#123;&#125;;</span><br></pre></td></tr></table></figure>

<p><code>CountDownLatch</code> çš„é‡è¦æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">await</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123; &#125;;</span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">await</span><span class="params">(<span class="type">long</span> timeout, TimeUnit unit)</span> <span class="keyword">throws</span> InterruptedException &#123; &#125;;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">countDown</span><span class="params">()</span> &#123; &#125;;</span><br></pre></td></tr></table></figure>

<p>è¯´æ˜ï¼š</p>
<ul>
<li><code>await()</code> - è°ƒç”¨ <code>await()</code> æ–¹æ³•çš„çº¿ç¨‹ä¼šè¢«æŒ‚èµ·ï¼Œå®ƒä¼šç­‰å¾…ç›´åˆ° count å€¼ä¸º 0 æ‰ç»§ç»­æ‰§è¡Œã€‚</li>
<li><code>await(long timeout, TimeUnit unit)</code> - å’Œ <code>await()</code> ç±»ä¼¼ï¼Œåªä¸è¿‡ç­‰å¾…ä¸€å®šçš„æ—¶é—´å count å€¼è¿˜æ²¡å˜ä¸º 0 çš„è¯å°±ä¼šç»§ç»­æ‰§è¡Œ</li>
<li><code>countDown()</code> - å°†ç»Ÿè®¡å€¼ count å‡ 1</li>
</ul>
<p>ã€ç¤ºä¾‹ã€‘CountDownLatch ä½¿ç”¨ç¤ºä¾‹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CountDownLatchDemo</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">CountDownLatch</span> <span class="variable">latch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">MyThread</span>(latch)).start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;ç­‰å¾… 2 ä¸ªå­çº¿ç¨‹æ‰§è¡Œå®Œæ¯•ã€‚..&quot;</span>);</span><br><span class="line">            latch.await();</span><br><span class="line">            System.out.println(<span class="string">&quot;2 ä¸ªå­çº¿ç¨‹å·²ç»æ‰§è¡Œå®Œæ¯•&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;ç»§ç»­æ‰§è¡Œä¸»çº¿ç¨‹&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MyThread</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> CountDownLatch latch;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">MyThread</span><span class="params">(CountDownLatch latch)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.latch = latch;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;å­çº¿ç¨‹&quot;</span> + Thread.currentThread().getName() + <span class="string">&quot;æ­£åœ¨æ‰§è¡Œ&quot;</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">&quot;å­çº¿ç¨‹&quot;</span> + Thread.currentThread().getName() + <span class="string">&quot;æ‰§è¡Œå®Œæ¯•&quot;</span>);</span><br><span class="line">            latch.countDown();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="CyclicBarrier"><a href="#CyclicBarrier" class="headerlink" title="CyclicBarrier"></a>CyclicBarrier</h2><p><code>CyclicBarrier</code> å­—é¢æ„æ€æ˜¯å¾ªç¯æ …æ ã€‚**<code>CyclicBarrier</code> å¯ä»¥è®©ä¸€ç»„çº¿ç¨‹ç­‰å¾…è‡³æŸä¸ªçŠ¶æ€ï¼ˆéµå¾ªå­—é¢æ„æ€ï¼Œä¸å¦¨ç§°è¿™ä¸ªçŠ¶æ€ä¸ºæ …æ ï¼‰ä¹‹åå†å…¨éƒ¨åŒæ—¶æ‰§è¡Œ<strong>ã€‚ä¹‹æ‰€ä»¥å«å¾ªç¯æ …æ æ˜¯å› ä¸ºï¼š</strong>å½“æ‰€æœ‰ç­‰å¾…çº¿ç¨‹éƒ½è¢«é‡Šæ”¾ä»¥åï¼Œ<code>CyclicBarrier</code> å¯ä»¥è¢«é‡ç”¨**ã€‚</p>
<p><code>CyclicBarrier</code> æ˜¯åŸºäº <code>ReentrantLock</code> ï¼ˆ<code>ReentrantLock</code> åº•å±‚ä¹Ÿæ˜¯åŸºäº AQS å®ç°çš„ï¼‰å’Œ <code>Condition</code> å®ç°çš„ã€‚<code>CyclicBarrier</code> å†…éƒ¨ç»´æŠ¤ä¸€ä¸ªè®¡æ•°å™¨ï¼Œæ¯æ¬¡æ‰§è¡Œ <code>await</code> æ–¹æ³•ä¹‹åï¼Œè®¡æ•°å™¨åŠ  1ï¼Œç›´åˆ°è®¡æ•°å™¨çš„å€¼å’Œè®¾ç½®çš„å€¼ç›¸ç­‰ï¼Œç­‰å¾…çš„æ‰€æœ‰çº¿ç¨‹æ‰ä¼šç»§ç»­æ‰§è¡Œã€‚</p>
<p><code>CyclicBarrier</code> åœ¨å¹¶è¡Œè¿­ä»£ç®—æ³•ä¸­éå¸¸æœ‰ç”¨ã€‚</p>
<p><img src="https://raw.githubusercontent.com/dunwu/images/master/cs/java/javacore/concurrent/CyclicBarrier.png" alt="img"></p>
<p><code>CyclicBarrier</code> æä¾›äº† 2 ä¸ªæ„é€ æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">CyclicBarrier</span><span class="params">(<span class="type">int</span> parties)</span> &#123;&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="title function_">CyclicBarrier</span><span class="params">(<span class="type">int</span> parties, Runnable barrierAction)</span> &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>è¯´æ˜ï¼š</p>
<ul>
<li><code>parties</code> - <code>parties</code> æ•°ç›¸å½“äºä¸€ä¸ªé˜ˆå€¼ï¼Œå½“æœ‰ <code>parties</code> æ•°é‡çš„çº¿ç¨‹åœ¨ç­‰å¾…æ—¶ï¼Œ <code>CyclicBarrier</code> å¤„äºæ …æ çŠ¶æ€ã€‚</li>
<li><code>barrierAction</code> - å½“ <code>CyclicBarrier</code> å¤„äºæ …æ çŠ¶æ€æ—¶æ‰§è¡Œçš„åŠ¨ä½œã€‚</li>
</ul>
<p><code>CyclicBarrier</code> çš„é‡è¦æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">await</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException, BrokenBarrierException &#123;&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">await</span><span class="params">(<span class="type">long</span> timeout, TimeUnit unit)</span></span><br><span class="line">        <span class="keyword">throws</span> InterruptedException,</span><br><span class="line">               BrokenBarrierException,</span><br><span class="line">               TimeoutException &#123;&#125;</span><br><span class="line"><span class="comment">// å°†å±éšœé‡ç½®ä¸ºåˆå§‹çŠ¶æ€</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">reset</span><span class="params">()</span> &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>è¯´æ˜ï¼š</p>
<ul>
<li><code>await()</code> - ç­‰å¾…è°ƒç”¨ <code>await()</code> çš„çº¿ç¨‹æ•°è¾¾åˆ°å±éšœæ•°ã€‚å¦‚æœå½“å‰çº¿ç¨‹æ˜¯æœ€åä¸€ä¸ªåˆ°è¾¾çš„çº¿ç¨‹ï¼Œå¹¶ä¸”åœ¨æ„é€ å‡½æ•°ä¸­æä¾›äº†éç©ºå±éšœæ“ä½œï¼Œåˆ™å½“å‰çº¿ç¨‹åœ¨å…è®¸å…¶ä»–çº¿ç¨‹ç»§ç»­ä¹‹å‰è¿è¡Œè¯¥æ“ä½œã€‚å¦‚æœåœ¨å±éšœåŠ¨ä½œæœŸé—´å‘ç”Ÿå¼‚å¸¸ï¼Œé‚£ä¹ˆè¯¥å¼‚å¸¸å°†åœ¨å½“å‰çº¿ç¨‹ä¸­ä¼ æ’­å¹¶ä¸”å±éšœè¢«ç½®äºæ–­å¼€çŠ¶æ€ã€‚</li>
<li><code>await(long timeout, TimeUnit unit)</code> - ç›¸æ¯”äº <code>await()</code> æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•è®©è¿™äº›çº¿ç¨‹ç­‰å¾…è‡³ä¸€å®šçš„æ—¶é—´ï¼Œå¦‚æœè¿˜æœ‰çº¿ç¨‹æ²¡æœ‰åˆ°è¾¾æ …æ çŠ¶æ€å°±ç›´æ¥è®©åˆ°è¾¾æ …æ çŠ¶æ€çš„çº¿ç¨‹æ‰§è¡Œåç»­ä»»åŠ¡ã€‚</li>
<li><code>reset()</code> - å°†å±éšœé‡ç½®ä¸ºåˆå§‹çŠ¶æ€ã€‚</li>
</ul>
<p>ã€ç¤ºä¾‹ã€‘CyclicBarrier ä½¿ç”¨ç¤ºä¾‹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CyclicBarrierDemo</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">N</span> <span class="operator">=</span> <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">CyclicBarrier</span> <span class="variable">barrier</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CyclicBarrier</span>(N,</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;å½“å‰çº¿ç¨‹&quot;</span> + Thread.currentThread().getName());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">            <span class="type">MyThread</span> <span class="variable">myThread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyThread</span>(barrier);</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Thread</span>(myThread).start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MyThread</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> CyclicBarrier cyclicBarrier;</span><br><span class="line"></span><br><span class="line">        MyThread(CyclicBarrier cyclicBarrier) &#123;</span><br><span class="line">            <span class="built_in">this</span>.cyclicBarrier = cyclicBarrier;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;çº¿ç¨‹&quot;</span> + Thread.currentThread().getName() + <span class="string">&quot;æ­£åœ¨å†™å…¥æ•°æ®ã€‚..&quot;</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">3000</span>); <span class="comment">// ä»¥ç¡çœ æ¥æ¨¡æ‹Ÿå†™å…¥æ•°æ®æ“ä½œ</span></span><br><span class="line">                System.out.println(<span class="string">&quot;çº¿ç¨‹&quot;</span> + Thread.currentThread().getName() + <span class="string">&quot;å†™å…¥æ•°æ®å®Œæ¯•ï¼Œç­‰å¾…å…¶ä»–çº¿ç¨‹å†™å…¥å®Œæ¯•&quot;</span>);</span><br><span class="line">                cyclicBarrier.await();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException | BrokenBarrierException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h2><ul>
<li><code>CountDownLatch</code> å’Œ <code>CyclicBarrier</code> éƒ½èƒ½å¤Ÿå®ç°çº¿ç¨‹ä¹‹é—´çš„ç­‰å¾…ï¼Œåªä¸è¿‡å®ƒä»¬ä¾§é‡ç‚¹ä¸åŒï¼š<ul>
<li><code>CountDownLatch</code> ä¸€èˆ¬ç”¨äºæŸä¸ªçº¿ç¨‹ A ç­‰å¾…è‹¥å¹²ä¸ªå…¶ä»–çº¿ç¨‹æ‰§è¡Œå®Œä»»åŠ¡ä¹‹åï¼Œå®ƒæ‰æ‰§è¡Œï¼›</li>
<li><code>CyclicBarrier</code> ä¸€èˆ¬ç”¨äºä¸€ç»„çº¿ç¨‹äº’ç›¸ç­‰å¾…è‡³æŸä¸ªçŠ¶æ€ï¼Œç„¶åè¿™ä¸€ç»„çº¿ç¨‹å†åŒæ—¶æ‰§è¡Œï¼›</li>
<li>å¦å¤–ï¼Œ<code>CountDownLatch</code> æ˜¯ä¸å¯ä»¥é‡ç”¨çš„ï¼Œè€Œ <code>CyclicBarrier</code> æ˜¯å¯ä»¥é‡ç”¨çš„ã€‚</li>
</ul>
</li>
<li><code>Semaphore</code> å…¶å®å’Œé”æœ‰ç‚¹ç±»ä¼¼ï¼Œå®ƒä¸€èˆ¬ç”¨äºæ§åˆ¶å¯¹æŸç»„èµ„æºçš„è®¿é—®æƒé™ã€‚</li>
</ul>
<h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ul>
<li><a target="_blank" rel="noopener" href="https://book.douban.com/subject/10484692/">ã€ŠJava å¹¶å‘ç¼–ç¨‹å®æˆ˜ã€‹</a></li>
<li><a target="_blank" rel="noopener" href="https://book.douban.com/subject/26591326/">ã€ŠJava å¹¶å‘ç¼–ç¨‹çš„è‰ºæœ¯ã€‹</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/dolphin0520/p/3920397.html">Java å¹¶å‘ç¼–ç¨‹ï¼šCountDownLatchã€CyclicBarrier å’Œ Semaphore</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="ä¸Šä¸€é¡µ" aria-label="ä¸Šä¸€é¡µ" href="/blog/page/35/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/blog/">1</a><span class="space">&hellip;</span><a class="page-number" href="/blog/page/35/">35</a><span class="page-number current">36</span><a class="page-number" href="/blog/page/37/">37</a><span class="space">&hellip;</span><a class="page-number" href="/blog/page/51/">51</a><a class="extend next" rel="next" title="ä¸‹ä¸€é¡µ" aria-label="ä¸‹ä¸€é¡µ" href="/blog/page/37/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 2015 â€“ 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">é’æ‚Ÿ â—¾ Dunwu</span>
  </div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
      <span>ç«™ç‚¹æ€»å­—æ•°ï¼š</span>
    <span title="ç«™ç‚¹æ€»å­—æ•°">4.5m</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span>ç«™ç‚¹é˜…è¯»æ—¶é•¿ &asymp;</span>
    <span title="ç«™ç‚¹é˜…è¯»æ—¶é•¿">68:08</span>
  </span>
</div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="reading-progress-bar"></div>

  <a href="https://github.com/dunwu/blog" class="github-corner" title="åœ¨ GitHub ä¸Šå…³æ³¨æˆ‘" aria-label="åœ¨ GitHub ä¸Šå…³æ³¨æˆ‘" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>
<script src="https://cdn.jsdelivr.net/npm/darkmode-js@1.5.7/lib/darkmode-js.min.js"></script>

<script>
var options = {
  bottom: '64px',
  right: 'unset',
  left: '32px',
  time: '0.5s',
  mixColor: 'transparent',
  backgroundColor: 'transparent',
  buttonColorDark: '#100f2c',
  buttonColorLight: '#fff',
  saveInCookies: true,
  label: 'ğŸŒ“',
  autoMatchOsTheme: true
}
const darkmode = new Darkmode(options);
window.darkmode = darkmode;
darkmode.showWidget();
</script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1.8.0/dist/gitalk.css" integrity="sha256-AJnUHL7dBv6PGaeyPQJcgQPDjt/Hn/PvYZde1iqfp8U=" crossorigin="anonymous">

<script class="next-config" data-name="gitalk" type="application/json">{"enable":true,"github_id":"dunwu","repo":"blog","client_id":"c45bc13ca1d3d3aa4836","client_secret":"1907a9f0c22087badad3938e1d7dcba9078f88ac","admin_user":"dunwu","distraction_free_mode":true,"proxy":"https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token","language":"zh-CN","js":{"url":"https://cdn.jsdelivr.net/npm/gitalk@1.8.0/dist/gitalk.min.js","integrity":"sha256-MVK9MGD/XJaGyIghSVrONSnoXoGh3IFxLw0zfvzpxR4="},"path_md5":"a0ff04100e3ce251f16df6f2f1ae05a1"}</script>
<script src="/blog/js/third-party/comments/gitalk.js" defer></script>

</body>
</html>

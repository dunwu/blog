---
title: æ·±å…¥å‰–æå…±è¯†æ€§ç®—æ³• Raft
date: 2020-02-01 22:07:00
order: 12
categories:
  - åˆ†å¸ƒå¼
  - åˆ†å¸ƒå¼ç†è®º
tags:
  - åˆ†å¸ƒå¼
  - ç†è®º
  - ç®—æ³•
  - å…±è¯†æ€§
  - Raft
permalink: /pages/4907dc/
---

# æ·±å…¥å‰–æå…±è¯†æ€§ç®—æ³• Raft

![img](https://raw.githubusercontent.com/dunwu/images/master/snap/20200201221202.png)

## Raft ç®€ä»‹

**[Raft](https://ramcloud.atlassian.net/wiki/download/attachments/6586375/raft.pdf) æ˜¯ä¸€ç§ä¸ºäº†ç®¡ç†æ—¥å¿—å¤åˆ¶çš„åˆ†å¸ƒå¼å…±è¯†æ€§ç®—æ³•**ã€‚ä»æœ¬è´¨ä¸Šè¯´ï¼Œ**Raft ç®—æ³•æ˜¯é€šè¿‡ä¸€åˆ‡ä»¥é¢†å¯¼è€…ä¸ºå‡†çš„æ–¹å¼ï¼Œå®ç°ä¸€ç³»åˆ—å€¼çš„å…±è¯†å’Œå„èŠ‚ç‚¹æ—¥å¿—çš„ä¸€è‡´**ã€‚

[Raft](https://ramcloud.atlassian.net/wiki/download/attachments/6586375/raft.pdf) å‡ºç°ä¹‹å‰ï¼ŒPaxos ä¸€ç›´æ˜¯åˆ†å¸ƒå¼å…±è¯†æ€§ç®—æ³•çš„æ ‡å‡†ã€‚Paxos **éš¾ä»¥ç†è§£ï¼Œæ›´éš¾ä»¥å®ç°**ã€‚Raft çš„è®¾è®¡ç›®æ ‡æ˜¯ç®€åŒ– Paxosï¼Œä½¿å¾—ç®—æ³•**æ—¢å®¹æ˜“ç†è§£ï¼Œä¹Ÿå®¹æ˜“å®ç°**ã€‚

Paxos å’Œ Raft éƒ½æ˜¯åˆ†å¸ƒå¼å…±è¯†æ€§ç®—æ³•ï¼Œè¿™ä¸ªè¿‡ç¨‹å¦‚åŒæŠ•ç¥¨é€‰ä¸¾é¢†è¢–ï¼ˆLeaderï¼‰ï¼Œå‚é€‰è€…ï¼ˆCandidateï¼‰éœ€è¦è¯´æœå¤§å¤šæ•°æŠ•ç¥¨è€…ï¼ˆFollowerï¼‰æŠ•ç¥¨ç»™ä»–ï¼Œä¸€æ—¦é€‰ä¸¾å‡ºé¢†è¢–ï¼Œå°±ç”±é¢†è¢–å‘å·æ–½ä»¤ã€‚Paxos å’Œ Raft çš„åŒºåˆ«åœ¨äºé€‰ä¸¾çš„å…·ä½“è¿‡ç¨‹ä¸åŒã€‚

**Raft å¯ä»¥è§£å†³åˆ†å¸ƒå¼ CAP ç†è®ºä¸­çš„ CP**ï¼Œå³ _ä¸€è‡´æ€§ï¼ˆCï¼šConsistencyï¼‰_ å’Œ _åˆ†åŒºå®¹å¿æ€§ï¼ˆPï¼šPartition Toleranceï¼‰_ï¼Œå¹¶ä¸èƒ½è§£å†³ _å¯ç”¨æ€§ï¼ˆAï¼šAvailabilityï¼‰_ çš„é—®é¢˜ã€‚

### åˆ†å¸ƒå¼å…±è¯†æ€§

åˆ†å¸ƒå¼å…±è¯†æ€§ (distributed consensus) æ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿä¸­æœ€åŸºæœ¬çš„é—®é¢˜ï¼Œç”¨æ¥ä¿è¯ä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿçš„å¯é æ€§ä»¥åŠå®¹é”™èƒ½åŠ›ã€‚ç®€å•æ¥è¯´ï¼Œ**_åˆ†å¸ƒå¼å…±è¯†æ€§æ˜¯æŒ‡å¤šä¸ªæœåŠ¡å™¨çš„ä¿æŒçŠ¶æ€ä¸€è‡´_**ã€‚

åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œå¯èƒ½å‡ºç°å„ç§æ„å¤–ï¼ˆæ–­ç”µã€ç½‘ç»œæ‹¥å¡ã€CPU/å†…å­˜è€—å°½ç­‰ç­‰ï¼‰ï¼Œä½¿å¾—æœåŠ¡å™¨å®•æœºæˆ–æ— æ³•è®¿é—®ï¼Œæœ€ç»ˆå¯¼è‡´æ— æ³•å’Œå…¶ä»–æœåŠ¡å™¨ä¿æŒçŠ¶æ€ä¸€è‡´ã€‚ä¸ºäº†åº”å¯¹è¿™ç§æƒ…å†µï¼Œå°±éœ€è¦æœ‰ä¸€ç§ä¸€è‡´æ€§åè®®æ¥è¿›è¡Œå®¹é”™ï¼Œä½¿å¾—åˆ†å¸ƒå¼ç³»ç»Ÿä¸­å³ä½¿æœ‰éƒ¨åˆ†æœåŠ¡å™¨å®•æœºæˆ–æ— æ³•è®¿é—®ï¼Œæ•´ä½“ä¾ç„¶å¯ä»¥å¯¹å¤–æä¾›æœåŠ¡ã€‚

ä»¥å®¹é”™æ–¹å¼è¾¾æˆä¸€è‡´ï¼Œè‡ªç„¶ä¸èƒ½è¦æ±‚æ‰€æœ‰æœåŠ¡å™¨éƒ½è¾¾æˆä¸€è‡´çŠ¶æ€ï¼Œåªè¦**è¶…è¿‡åŠæ•°ä»¥ä¸Š**çš„æœåŠ¡å™¨è¾¾æˆä¸€è‡´å°±å¯ä»¥äº†ã€‚å‡è®¾æœ‰ N å°æœåŠ¡å™¨ï¼Œ å¤§äºç­‰äº `N/2 + 1` å°æœåŠ¡å™¨å°±ç®—æ˜¯åŠæ•°ä»¥ä¸Šäº† ã€‚

### å¤åˆ¶çŠ¶æ€æœº

**`å¤åˆ¶çŠ¶æ€æœºï¼ˆReplicated State Machinesï¼‰`** æ˜¯æŒ‡ä¸€ç»„æœåŠ¡å™¨ä¸Šçš„çŠ¶æ€æœºäº§ç”Ÿç›¸åŒçŠ¶æ€çš„å‰¯æœ¬ï¼Œå¹¶ä¸”åœ¨ä¸€äº›æœºå™¨å®•æ‰çš„æƒ…å†µä¸‹ä¹Ÿå¯ä»¥ç»§ç»­è¿è¡Œã€‚ä¸€è‡´æ€§ç®—æ³•ç®¡ç†ç€æ¥è‡ªå®¢æˆ·ç«¯æŒ‡ä»¤çš„å¤åˆ¶æ—¥å¿—ã€‚çŠ¶æ€æœºä»æ—¥å¿—ä¸­å¤„ç†ç›¸åŒé¡ºåºçš„ç›¸åŒæŒ‡ä»¤ï¼Œæ‰€ä»¥äº§ç”Ÿçš„ç»“æœä¹Ÿæ˜¯ç›¸åŒçš„ã€‚

![img](https://raw.githubusercontent.com/dunwu/images/master/snap/20200131233906.png)

å¤åˆ¶çŠ¶æ€æœºé€šå¸¸éƒ½æ˜¯åŸºäºå¤åˆ¶æ—¥å¿—å®ç°çš„ï¼Œå¦‚ä¸Šå›¾ã€‚æ¯ä¸€ä¸ªæœåŠ¡å™¨å­˜å‚¨ä¸€ä¸ªåŒ…å«ä¸€ç³»åˆ—æŒ‡ä»¤çš„æ—¥å¿—ï¼Œå¹¶ä¸”æŒ‰ç…§æ—¥å¿—çš„é¡ºåºè¿›è¡Œæ‰§è¡Œã€‚æ¯ä¸€ä¸ªæ—¥å¿—éƒ½æŒ‰ç…§ç›¸åŒçš„é¡ºåºåŒ…å«ç›¸åŒçš„æŒ‡ä»¤ï¼Œæ‰€ä»¥æ¯ä¸€ä¸ªæœåŠ¡å™¨éƒ½æ‰§è¡Œç›¸åŒçš„æŒ‡ä»¤åºåˆ—ã€‚å› ä¸ºæ¯ä¸ªçŠ¶æ€æœºéƒ½æ˜¯ç¡®å®šçš„ï¼Œæ¯ä¸€æ¬¡æ‰§è¡Œæ“ä½œéƒ½äº§ç”Ÿç›¸åŒçš„çŠ¶æ€å’ŒåŒæ ·çš„åºåˆ—ã€‚

ä¿è¯å¤åˆ¶æ—¥å¿—ç›¸åŒå°±æ˜¯ä¸€è‡´æ€§ç®—æ³•çš„å·¥ä½œäº†ã€‚åœ¨ä¸€å°æœåŠ¡å™¨ä¸Šï¼Œä¸€è‡´æ€§æ¨¡å—æ¥æ”¶å®¢æˆ·ç«¯å‘é€æ¥çš„æŒ‡ä»¤ç„¶åå¢åŠ åˆ°è‡ªå·±çš„æ—¥å¿—ä¸­å»ã€‚å®ƒå’Œå…¶ä»–æœåŠ¡å™¨ä¸Šçš„ä¸€è‡´æ€§æ¨¡å—è¿›è¡Œé€šä¿¡æ¥ä¿è¯æ¯ä¸€ä¸ªæœåŠ¡å™¨ä¸Šçš„æ—¥å¿—æœ€ç»ˆéƒ½ä»¥ç›¸åŒçš„é¡ºåºåŒ…å«ç›¸åŒçš„è¯·æ±‚ï¼Œå°½ç®¡æœ‰äº›æœåŠ¡å™¨ä¼šå®•æœºã€‚ä¸€æ—¦æŒ‡ä»¤è¢«æ­£ç¡®çš„å¤åˆ¶ï¼Œæ¯ä¸€ä¸ªæœåŠ¡å™¨çš„çŠ¶æ€æœºæŒ‰ç…§æ—¥å¿—é¡ºåºå¤„ç†ä»–ä»¬ï¼Œç„¶åè¾“å‡ºç»“æœè¢«è¿”å›ç»™å®¢æˆ·ç«¯ã€‚å› æ­¤ï¼ŒæœåŠ¡å™¨é›†ç¾¤çœ‹èµ·æ¥å½¢æˆä¸€ä¸ªé«˜å¯é çš„çŠ¶æ€æœºã€‚

å®é™…ç³»ç»Ÿä¸­ä½¿ç”¨çš„ä¸€è‡´æ€§ç®—æ³•é€šå¸¸å«æœ‰ä»¥ä¸‹ç‰¹æ€§ï¼š

- **å®‰å…¨æ€§ä¿è¯**ï¼ˆç»å¯¹ä¸ä¼šè¿”å›ä¸€ä¸ªé”™è¯¯çš„ç»“æœï¼‰ï¼šåœ¨éæ‹œå åº­é”™è¯¯æƒ…å†µä¸‹ï¼ŒåŒ…æ‹¬ç½‘ç»œå»¶è¿Ÿã€åˆ†åŒºã€ä¸¢åŒ…ã€å†—ä½™å’Œä¹±åºç­‰é”™è¯¯éƒ½å¯ä»¥ä¿è¯æ­£ç¡®ã€‚
- **å¯ç”¨æ€§**ï¼šé›†ç¾¤ä¸­åªè¦æœ‰å¤§å¤šæ•°çš„æœºå™¨å¯è¿è¡Œå¹¶ä¸”èƒ½å¤Ÿç›¸äº’é€šä¿¡ã€å’Œå®¢æˆ·ç«¯é€šä¿¡ï¼Œå°±å¯ä»¥ä¿è¯å¯ç”¨ã€‚å› æ­¤ï¼Œä¸€ä¸ªå…¸å‹çš„åŒ…å« 5 ä¸ªèŠ‚ç‚¹çš„é›†ç¾¤å¯ä»¥å®¹å¿ä¸¤ä¸ªèŠ‚ç‚¹çš„å¤±è´¥ã€‚æœåŠ¡å™¨è¢«åœæ­¢å°±è®¤ä¸ºæ˜¯å¤±è´¥ã€‚ä»–ä»¬å½“æœ‰ç¨³å®šçš„å­˜å‚¨çš„æ—¶å€™å¯ä»¥ä»çŠ¶æ€ä¸­æ¢å¤å›æ¥å¹¶é‡æ–°åŠ å…¥é›†ç¾¤ã€‚
- **ä¸ä¾èµ–æ—¶åºæ¥ä¿è¯ä¸€è‡´æ€§**ï¼šç‰©ç†æ—¶é’Ÿé”™è¯¯æˆ–è€…æç«¯çš„æ¶ˆæ¯å»¶è¿Ÿåªæœ‰åœ¨æœ€åæƒ…å†µä¸‹æ‰ä¼šå¯¼è‡´å¯ç”¨æ€§é—®é¢˜ã€‚
- é€šå¸¸æƒ…å†µä¸‹ï¼Œä¸€æ¡æŒ‡ä»¤å¯ä»¥å°½å¯èƒ½å¿«çš„åœ¨é›†ç¾¤ä¸­å¤§å¤šæ•°èŠ‚ç‚¹å“åº”ä¸€è½®è¿œç¨‹è¿‡ç¨‹è°ƒç”¨æ—¶å®Œæˆã€‚å°éƒ¨åˆ†æ¯”è¾ƒæ…¢çš„èŠ‚ç‚¹ä¸ä¼šå½±å“ç³»ç»Ÿæ•´ä½“çš„æ€§èƒ½ã€‚

### RAFT åº”ç”¨

RAFT å¯ä»¥åšä»€ä¹ˆï¼Ÿ

é€šè¿‡ RAFT æä¾›çš„å¤åˆ¶çŠ¶æ€æœºï¼Œå¯ä»¥è§£å†³åˆ†å¸ƒå¼ç³»ç»Ÿçš„å¤åˆ¶ã€ä¿®å¤ã€èŠ‚ç‚¹ç®¡ç†ç­‰é—®é¢˜ã€‚Raft æå¤§çš„ç®€åŒ–å½“å‰åˆ†å¸ƒå¼ç³»ç»Ÿçš„è®¾è®¡ä¸å®ç°ï¼Œè®©å¼€å‘è€…åªå…³æ³¨äºä¸šåŠ¡é€»è¾‘ï¼Œå°†å…¶æŠ½è±¡å®ç°æˆå¯¹åº”çš„çŠ¶æ€æœºå³å¯ã€‚åŸºäºè¿™å¥—æ¡†æ¶ï¼Œå¯ä»¥æ„å»ºå¾ˆå¤šåˆ†å¸ƒå¼åº”ç”¨ï¼š

- åˆ†å¸ƒå¼å­˜å‚¨ç³»ç»Ÿï¼šæ¯”å¦‚åˆ†å¸ƒå¼æ¶ˆæ¯é˜Ÿåˆ—ã€åˆ†å¸ƒå¼å—ç³»ç»Ÿã€åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿã€åˆ†å¸ƒå¼è¡¨æ ¼ç³»ç»Ÿç­‰ã€‚ä»£è¡¨æœ‰ï¼šRedisã€Etcdã€Consul
- é«˜å¯é å…ƒä¿¡æ¯ç®¡ç†ï¼šæ¯”å¦‚å„ç±» Master æ¨¡å—çš„ HA

## Raft åŸºç¡€

Raft å°†ä¸€è‡´æ€§é—®é¢˜åˆ†è§£æˆäº†ä¸‰ä¸ªå­é—®é¢˜ï¼š

- **é€‰ä¸¾ Leader**
- **æ—¥å¿—å¤åˆ¶**
- **å®‰å…¨æ€§**

åœ¨åç»­ç« èŠ‚ï¼Œä¼šè¯¦ç»†è®²è§£è¿™ä¸ªå­é—®é¢˜ã€‚ç°åœ¨ï¼Œå…ˆäº†è§£ä¸€ä¸‹ Raft çš„ä¸€äº›æ ¸å¿ƒæ¦‚å¿µã€‚

### æœåŠ¡å™¨è§’è‰²

åœ¨ Raft ä¸­ï¼Œä»»ä½•æ—¶åˆ»ï¼Œæ¯ä¸ªæœåŠ¡å™¨éƒ½å¤„äºè¿™ä¸‰ä¸ªè§’è‰²ä¹‹ä¸€ ï¼š

- **`Leader`** - é¢†å¯¼è€…ï¼Œé€šå¸¸ä¸€ä¸ªç³»ç»Ÿä¸­æ˜¯**ä¸€ä¸»ï¼ˆLeaderï¼‰å¤šä»ï¼ˆFollowerï¼‰**ã€‚Leader **è´Ÿè´£å¤„ç†æ‰€æœ‰çš„å®¢æˆ·ç«¯è¯·æ±‚**ã€‚
- **`Follower`** - è·Ÿéšè€…ï¼Œ**ä¸ä¼šå‘é€ä»»ä½•è¯·æ±‚**ï¼Œåªæ˜¯ç®€å•çš„ **å“åº”æ¥è‡ª Leader æˆ–è€… Candidate çš„è¯·æ±‚**ã€‚
- **`Candidate`** - å‚é€‰è€…ï¼Œé€‰ä¸¾æ–° Leader æ—¶çš„ä¸´æ—¶è§’è‰²ã€‚

![img](https://raw.githubusercontent.com/dunwu/images/master/snap/20200131215742.png)

> :bulb: å›¾ç¤ºè¯´æ˜ï¼š
>
> - Follower åªå“åº”æ¥è‡ªå…¶ä»–æœåŠ¡å™¨çš„è¯·æ±‚ã€‚åœ¨ä¸€å®šæ—¶é™å†…ï¼Œå¦‚æœ Follower æ¥æ”¶ä¸åˆ°æ¶ˆæ¯ï¼Œå°±ä¼šè½¬å˜æˆ Candidateï¼Œå¹¶å‘èµ·é€‰ä¸¾ã€‚
> - Candidate å‘ Follower å‘èµ·æŠ•ç¥¨è¯·æ±‚ï¼Œå¦‚æœè·å¾—é›†ç¾¤ä¸­åŠæ•°ä»¥ä¸Šçš„é€‰ç¥¨ï¼Œå°±ä¼šè½¬å˜ä¸º Leaderã€‚
> - åœ¨ä¸€ä¸ª Term å†…ï¼ŒLeader å§‹ç»ˆä¿æŒä¸å˜ï¼Œç›´åˆ°ä¸‹çº¿äº†ã€‚Leader éœ€è¦å‘¨æœŸæ€§å‘æ‰€æœ‰ Follower å‘é€å¿ƒè·³æ¶ˆæ¯ï¼Œä»¥é˜»æ­¢ Follower è½¬å˜ä¸º Candidateã€‚

### ä»»æœŸ

![img](https://raw.githubusercontent.com/dunwu/images/master/snap/20200131220742.png)

Raft æŠŠæ—¶é—´åˆ†å‰²æˆä»»æ„é•¿åº¦çš„ **_`ä»»æœŸï¼ˆTermï¼‰`_**ï¼Œä»»æœŸç”¨è¿ç»­çš„æ•´æ•°æ ‡è®°ã€‚æ¯ä¸€æ®µä»»æœŸä»ä¸€æ¬¡**é€‰ä¸¾**å¼€å§‹ã€‚**Raft ä¿è¯äº†åœ¨ä¸€ä¸ªç»™å®šçš„ä»»æœŸå†…ï¼Œæœ€å¤šåªæœ‰ä¸€ä¸ªé¢†å¯¼è€…**ã€‚

- å¦‚æœé€‰ä¸¾æˆåŠŸï¼ŒLeader ä¼šç®¡ç†æ•´ä¸ªé›†ç¾¤ç›´åˆ°ä»»æœŸç»“æŸã€‚
- å¦‚æœé€‰ä¸¾å¤±è´¥ï¼Œé‚£ä¹ˆè¿™ä¸ªä»»æœŸå°±ä¼šå› ä¸ºæ²¡æœ‰ Leader è€Œç»“æŸã€‚

**ä¸åŒæœåŠ¡å™¨èŠ‚ç‚¹è§‚å¯Ÿåˆ°çš„ä»»æœŸè½¬æ¢çŠ¶æ€å¯èƒ½ä¸ä¸€æ ·**ï¼š

- æœåŠ¡å™¨èŠ‚ç‚¹å¯èƒ½è§‚å¯Ÿåˆ°å¤šæ¬¡çš„ä»»æœŸè½¬æ¢ã€‚
- æœåŠ¡å™¨èŠ‚ç‚¹ä¹Ÿå¯èƒ½è§‚å¯Ÿä¸åˆ°ä»»ä½•ä¸€æ¬¡ä»»æœŸè½¬æ¢ã€‚

**ä»»æœŸåœ¨ Raft ç®—æ³•ä¸­å……å½“é€»è¾‘æ—¶é’Ÿçš„ä½œç”¨ï¼Œä½¿å¾—æœåŠ¡å™¨èŠ‚ç‚¹å¯ä»¥æŸ¥æ˜ä¸€äº›è¿‡æœŸçš„ä¿¡æ¯ï¼ˆæ¯”å¦‚è¿‡æœŸçš„ Leaderï¼‰ã€‚æ¯ä¸ªæœåŠ¡å™¨èŠ‚ç‚¹éƒ½ä¼šå­˜å‚¨ä¸€ä¸ªå½“å‰ä»»æœŸå·ï¼Œè¿™ä¸€ç¼–å·åœ¨æ•´ä¸ªæ—¶æœŸå†…å•è°ƒçš„å¢é•¿ã€‚å½“æœåŠ¡å™¨ä¹‹é—´é€šä¿¡çš„æ—¶å€™ä¼šäº¤æ¢å½“å‰ä»»æœŸå·ã€‚**

- å¦‚æœä¸€ä¸ªæœåŠ¡å™¨çš„å½“å‰ä»»æœŸå·æ¯”å…¶ä»–äººå°ï¼Œé‚£ä¹ˆä»–ä¼šæ›´æ–°è‡ªå·±çš„ç¼–å·åˆ°è¾ƒå¤§çš„ç¼–å·å€¼ã€‚
- å¦‚æœä¸€ä¸ª Candidate æˆ–è€… Leader å‘ç°è‡ªå·±çš„ä»»æœŸå·è¿‡æœŸäº†ï¼Œé‚£ä¹ˆä»–ä¼šç«‹å³æ¢å¤æˆè·Ÿéšè€…çŠ¶æ€ã€‚
- å¦‚æœä¸€ä¸ªèŠ‚ç‚¹æ¥æ”¶åˆ°ä¸€ä¸ªåŒ…å«è¿‡æœŸçš„ä»»æœŸå·çš„è¯·æ±‚ï¼Œé‚£ä¹ˆä»–ä¼šç›´æ¥æ‹’ç»è¿™ä¸ªè¯·æ±‚ã€‚

### RPC

Raft ç®—æ³•ä¸­æœåŠ¡å™¨èŠ‚ç‚¹ä¹‹é—´çš„é€šä¿¡ä½¿ç”¨ **_`è¿œç¨‹è¿‡ç¨‹è°ƒç”¨ï¼ˆRPCï¼‰`_**ã€‚

åŸºæœ¬çš„ä¸€è‡´æ€§ç®—æ³•åªéœ€è¦ä¸¤ç§ RPCï¼š

- **`RequestVote RPC`** - è¯·æ±‚æŠ•ç¥¨ RPCï¼Œç”± Candidate åœ¨é€‰ä¸¾æœŸé—´å‘èµ·ã€‚
- **`AppendEntries RPC`** - é™„åŠ æ¡ç›® RPCï¼Œç”± Leader å‘èµ·ï¼Œç”¨æ¥å¤åˆ¶æ—¥å¿—å’Œæä¾›ä¸€ç§å¿ƒè·³æœºåˆ¶ã€‚

## é€‰ä¸¾ Leader

### é€‰ä¸¾è§„åˆ™

**é¢†å¯¼è€…å¿ƒè·³æ¶ˆæ¯**ï¼šRaft ä½¿ç”¨ä¸€ç§å¿ƒè·³æœºåˆ¶æ¥è§¦å‘ Leader é€‰ä¸¾ã€‚**Leader éœ€è¦å‘¨æœŸæ€§çš„å‘æ‰€æœ‰ Follower å‘é€å¿ƒè·³æ¶ˆæ¯**ï¼Œä»¥æ­¤ç»´æŒ Leader èº«ä»½ã€‚

**éšæœºçš„ç«é€‰è¶…æ—¶æ—¶é—´**ï¼šæ¯ä¸ª Follower éƒ½è®¾ç½®äº†ä¸€ä¸ª**éšæœºçš„ç«é€‰è¶…æ—¶æ—¶é—´**ï¼Œä¸€èˆ¬ä¸º `150ms ~ 300ms`ï¼Œå¦‚æœåœ¨ç«é€‰è¶…æ—¶æ—¶é—´å†…æ²¡æœ‰æ”¶åˆ° Leader çš„å¿ƒè·³æ¶ˆæ¯ï¼Œå°±ä¼šè®¤ä¸ºå½“å‰ Term æ²¡æœ‰å¯ç”¨çš„ Leaderï¼Œå¹¶å‘èµ·é€‰ä¸¾æ¥é€‰å‡ºæ–°çš„ Leaderã€‚å¼€å§‹ä¸€æ¬¡é€‰ä¸¾è¿‡ç¨‹ï¼ŒFollower å…ˆè¦å¢åŠ è‡ªå·±çš„å½“å‰ Term å·ï¼Œå¹¶**è½¬æ¢ä¸º Candidate**ã€‚

Candidate ä¼šå¹¶è¡Œçš„**å‘é›†ç¾¤ä¸­çš„æ‰€æœ‰æœåŠ¡å™¨èŠ‚ç‚¹å‘é€æŠ•ç¥¨è¯·æ±‚ï¼ˆ`RequestVote RPC`ï¼‰**ï¼Œå®ƒä¼šä¿æŒå½“å‰çŠ¶æ€ç›´åˆ°ä»¥ä¸‹ä¸‰ä»¶äº‹æƒ…ä¹‹ä¸€å‘ç”Ÿï¼š

- **è‡ªå·±æˆä¸º Leader**
- **å…¶ä»–çš„æœåŠ¡å™¨æˆä¸º Leader**
- **æ²¡æœ‰ä»»ä½•æœåŠ¡å™¨æˆä¸º Leader**

#### è‡ªå·±æˆä¸º Leader

- å½“ä¸€ä¸ª Candidate ä»æ•´ä¸ªé›†ç¾¤**åŠæ•°ä»¥ä¸Š**çš„æœåŠ¡å™¨èŠ‚ç‚¹è·å¾—äº†é’ˆå¯¹åŒä¸€ä¸ª Term çš„é€‰ç¥¨ï¼Œé‚£ä¹ˆå®ƒå°±èµ¢å¾—äº†è¿™æ¬¡é€‰ä¸¾å¹¶æˆä¸º Leaderã€‚æ¯ä¸ªæœåŠ¡å™¨æœ€å¤šä¼šå¯¹ä¸€ä¸ª Term æŠ•å‡ºä¸€å¼ é€‰ç¥¨ï¼ŒæŒ‰ç…§**å…ˆæ¥å…ˆæœåŠ¡ï¼ˆFIFOï¼‰çš„åŸåˆ™**ã€‚_è¦æ±‚åŠæ•°ä»¥ä¸Šé€‰ç¥¨çš„è§„åˆ™ç¡®ä¿äº†æœ€å¤šåªä¼šæœ‰ä¸€ä¸ª Candidate èµ¢å¾—æ­¤æ¬¡é€‰ä¸¾_ã€‚
- ä¸€æ—¦ Candidate èµ¢å¾—é€‰ä¸¾ï¼Œå°±ç«‹å³æˆä¸º Leaderã€‚ç„¶åå®ƒä¼šå‘å…¶ä»–çš„æœåŠ¡å™¨å‘é€å¿ƒè·³æ¶ˆæ¯æ¥å»ºç«‹è‡ªå·±çš„æƒå¨å¹¶ä¸”é˜»æ­¢æ–°çš„é¢†å¯¼äººçš„äº§ç”Ÿã€‚

#### å…¶ä»–çš„æœåŠ¡å™¨æˆä¸º Leader

ç­‰å¾…æŠ•ç¥¨æœŸé—´ï¼ŒCandidate å¯èƒ½ä¼šä»å…¶ä»–çš„æœåŠ¡å™¨æ¥æ”¶åˆ°å£°æ˜å®ƒæ˜¯ Leader çš„ `AppendEntries RPC`ã€‚

- å¦‚æœè¿™ä¸ª Leader çš„ Term å·ï¼ˆåŒ…å«åœ¨æ­¤æ¬¡çš„ RPC ä¸­ï¼‰ä¸å°äº Candidate å½“å‰çš„ Termï¼Œé‚£ä¹ˆ Candidate ä¼šæ‰¿è®¤ Leader åˆæ³•å¹¶å›åˆ° Follower çŠ¶æ€ã€‚
- å¦‚æœæ­¤æ¬¡ RPC ä¸­çš„ Term å·æ¯”è‡ªå·±å°ï¼Œé‚£ä¹ˆ Candidate å°±ä¼šæ‹’ç»è¿™ä¸ªæ¶ˆæ¯å¹¶ç»§ç»­ä¿æŒ Candidate çŠ¶æ€ã€‚

#### æ²¡æœ‰ä»»ä½•æœåŠ¡å™¨æˆä¸º Leader

å¦‚æœæœ‰å¤šä¸ª Follower åŒæ—¶æˆä¸º Candidateï¼Œé‚£ä¹ˆé€‰ç¥¨å¯èƒ½ä¼šè¢«ç“œåˆ†ä»¥è‡³äºæ²¡æœ‰ Candidate å¯ä»¥èµ¢å¾—åŠæ•°ä»¥ä¸Šçš„æŠ•ç¥¨ã€‚å½“è¿™ç§æƒ…å†µå‘ç”Ÿçš„æ—¶å€™ï¼Œæ¯ä¸€ä¸ª Candidate éƒ½ä¼šç«é€‰è¶…æ—¶ï¼Œç„¶åé€šè¿‡å¢åŠ å½“å‰ Term å·æ¥å¼€å§‹ä¸€è½®æ–°çš„é€‰ä¸¾ã€‚ç„¶è€Œï¼Œæ²¡æœ‰å…¶ä»–æœºåˆ¶çš„è¯ï¼Œé€‰ç¥¨å¯èƒ½ä¼šè¢«æ— é™çš„é‡å¤ç“œåˆ†ã€‚

Raft ç®—æ³•ä½¿ç”¨éšæœºé€‰ä¸¾è¶…æ—¶æ—¶é—´çš„æ–¹æ³•æ¥ç¡®ä¿å¾ˆå°‘ä¼šå‘ç”Ÿé€‰ç¥¨ç“œåˆ†çš„æƒ…å†µï¼Œå°±ç®—å‘ç”Ÿä¹Ÿèƒ½å¾ˆå¿«çš„è§£å†³ã€‚ä¸ºäº†é˜»æ­¢é€‰ç¥¨èµ·åˆå°±è¢«ç“œåˆ†ï¼Œç«é€‰è¶…æ—¶æ—¶é—´æ˜¯ä¸€ä¸ª**éšæœºçš„æ—¶é—´**ï¼Œåœ¨ä¸€ä¸ªå›ºå®šçš„åŒºé—´ï¼ˆä¾‹å¦‚ 150-300 æ¯«ç§’ï¼‰éšæœºé€‰æ‹©ï¼Œè¿™æ ·å¯ä»¥æŠŠé€‰ä¸¾éƒ½åˆ†æ•£å¼€ã€‚

- ä»¥è‡³äºåœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œåªæœ‰ä¸€ä¸ªæœåŠ¡å™¨ä¼šè¶…æ—¶ï¼Œç„¶åå®ƒèµ¢å¾—é€‰ä¸¾ï¼Œæˆä¸º Leaderï¼Œå¹¶åœ¨å…¶ä»–æœåŠ¡å™¨è¶…æ—¶ä¹‹å‰å‘é€å¿ƒè·³åŒ…ã€‚
- åŒæ ·çš„æœºåˆ¶ä¹Ÿè¢«ç”¨åœ¨é€‰ç¥¨ç“œåˆ†çš„æƒ…å†µä¸‹ï¼šæ¯ä¸€ä¸ª Candidate åœ¨å¼€å§‹ä¸€æ¬¡é€‰ä¸¾çš„æ—¶å€™ä¼šé‡ç½®ä¸€ä¸ªéšæœºçš„é€‰ä¸¾è¶…æ—¶æ—¶é—´ï¼Œç„¶ååœ¨è¶…æ—¶æ—¶é—´å†…ç­‰å¾…æŠ•ç¥¨çš„ç»“æœï¼›è¿™æ ·å‡å°‘äº†åœ¨æ–°çš„é€‰ä¸¾ä¸­å¦å¤–çš„é€‰ç¥¨ç“œåˆ†çš„å¯èƒ½æ€§ã€‚

---

ç†è§£äº†ä¸Šé¢çš„é€‰ä¸¾è§„åˆ™åï¼Œæˆ‘ä»¬é€šè¿‡åŠ¨å›¾æ¥åŠ æ·±è®¤è¯†ã€‚

### å• Candidate é€‰ä¸¾

ï¼ˆ1ï¼‰ä¸‹å›¾è¡¨ç¤ºä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿçš„æœ€åˆé˜¶æ®µï¼Œæ­¤æ—¶åªæœ‰ Followerï¼Œæ²¡æœ‰ Leaderã€‚Follower A ç­‰å¾…ä¸€ä¸ªéšæœºçš„é€‰ä¸¾è¶…æ—¶æ—¶é—´ä¹‹åï¼Œæ²¡æ”¶åˆ° Leader å‘æ¥çš„å¿ƒè·³æ¶ˆæ¯ã€‚å› æ­¤ï¼Œå°† Term ç”± 0 å¢åŠ ä¸º 1ï¼Œè½¬æ¢ä¸º Candidateï¼Œè¿›å…¥é€‰ä¸¾çŠ¶æ€ã€‚

![img](https://raw.githubusercontent.com/dunwu/images/master/cs/design/architecture/raft-candidate-01.gif)

ï¼ˆ2ï¼‰æ­¤æ—¶ï¼ŒA å‘æ‰€æœ‰å…¶ä»–èŠ‚ç‚¹å‘é€æŠ•ç¥¨è¯·æ±‚ã€‚

![img](https://raw.githubusercontent.com/dunwu/images/master/cs/design/architecture/raft-candidate-02.gif)

ï¼ˆ3ï¼‰å…¶å®ƒèŠ‚ç‚¹ä¼šå¯¹æŠ•ç¥¨è¯·æ±‚è¿›è¡Œå›å¤ï¼Œå¦‚æœè¶…è¿‡åŠæ•°ä»¥ä¸Šçš„èŠ‚ç‚¹æŠ•ç¥¨äº†ï¼Œé‚£ä¹ˆè¯¥ Candidate å°±ä¼šç«‹å³å˜æˆ Term ä¸º 1 çš„ Leaderã€‚

![img](https://raw.githubusercontent.com/dunwu/images/master/cs/design/architecture/raft-candidate-03.gif)

ï¼ˆ4ï¼‰Leader ä¼šå‘¨æœŸæ€§åœ°å‘é€å¿ƒè·³æ¶ˆæ¯ç»™æ‰€æœ‰ Followerï¼ŒFollower æ¥æ”¶åˆ°å¿ƒè·³åŒ…ï¼Œä¼šé‡æ–°å¼€å§‹è®¡æ—¶ã€‚

![img](https://raw.githubusercontent.com/dunwu/images/master/cs/design/architecture/raft-candidate-04.gif)

### å¤š Candidate é€‰ä¸¾

ï¼ˆ1ï¼‰å¦‚æœæœ‰å¤šä¸ª Follower æˆä¸º Candidateï¼Œå¹¶ä¸”æ‰€è·å¾—ç¥¨æ•°ç›¸åŒï¼Œé‚£ä¹ˆå°±éœ€è¦é‡æ–°å¼€å§‹æŠ•ç¥¨ã€‚ä¾‹å¦‚ä¸‹å›¾ä¸­ Candidate B å’Œ Candidate D éƒ½å‘èµ· Term ä¸º 4 çš„é€‰ä¸¾ï¼Œä¸”éƒ½è·å¾—ä¸¤ç¥¨ï¼Œå› æ­¤éœ€è¦é‡æ–°å¼€å§‹æŠ•ç¥¨ã€‚

![img](https://raw.githubusercontent.com/dunwu/images/master/cs/design/architecture/raft-multi-candidate-01.gif)

ï¼ˆ2ï¼‰å½“é‡æ–°å¼€å§‹æŠ•ç¥¨æ—¶ï¼Œç”±äºæ¯ä¸ªèŠ‚ç‚¹è®¾ç½®çš„éšæœºç«é€‰è¶…æ—¶æ—¶é—´ä¸åŒï¼Œå› æ­¤èƒ½ä¸‹ä¸€æ¬¡å†æ¬¡å‡ºç°å¤šä¸ª Candidate å¹¶è·å¾—åŒæ ·ç¥¨æ•°çš„æ¦‚ç‡å¾ˆä½ã€‚

![img](https://raw.githubusercontent.com/dunwu/images/master/cs/design/architecture/raft-multi-candidate-02.gif)

### å°ç»“

Raft ç®—æ³•é€šè¿‡ï¼šé¢†å¯¼è€…å¿ƒè·³æ¶ˆæ¯ã€éšæœºé€‰ä¸¾è¶…æ—¶æ—¶é—´ã€å¾—åˆ°å¤§å¤šæ•°é€‰ç¥¨æ‰é€šè¿‡åŸåˆ™ã€ä»»æœŸæœ€æ–°è€…ä¼˜å…ˆã€å…ˆæ¥å…ˆæœåŠ¡çš„æŠ•ç¥¨åŸåˆ™ã€ç­‰ï¼Œä¿è¯äº†ä¸€ä¸ªä»»æœŸåªæœ‰ä¸€ä½é¢†å¯¼ï¼Œä¹Ÿæå¤§åœ°å‡å°‘äº†é€‰ä¸¾å¤±è´¥çš„æƒ…å†µã€‚

## æ—¥å¿—å¤åˆ¶

### æ—¥å¿—æ ¼å¼

**æ—¥å¿—ç”±å«æ—¥å¿—ç´¢å¼•ï¼ˆlog indexï¼‰çš„æ—¥å¿—æ¡ç›®ï¼ˆlog entryï¼‰ç»„æˆ**ã€‚æ¯ä¸ªæ—¥å¿—æ¡ç›®åŒ…å«å®ƒè¢«åˆ›å»ºæ—¶çš„ Term å·ï¼ˆä¸‹å›¾ä¸­æ–¹æ¡†ä¸­çš„æ•°å­—ï¼‰ï¼Œå’Œä¸€ä¸ªå¤åˆ¶çŠ¶æ€æœºéœ€è¦æ‰§è¡Œçš„æŒ‡ä»¤ã€‚å¦‚æœä¸€ä¸ªæ—¥å¿—æ¡ç›®è¢«å¤åˆ¶åˆ°åŠæ•°ä»¥ä¸Šçš„æœåŠ¡å™¨ä¸Šï¼Œå°±è¢«è®¤ä¸ºå¯ä»¥æäº¤ï¼ˆCommitï¼‰äº†ã€‚

- æ—¥å¿—æ¡ç›®ä¸­çš„ Term å·è¢«ç”¨æ¥æ£€æŸ¥æ˜¯å¦å‡ºç°ä¸ä¸€è‡´çš„æƒ…å†µï¼Œå®ƒå®é™…ä¸Šæ˜¯åˆ›å»ºè¿™æ¡æ—¥å¿—çš„é¢†å¯¼è€…çš„ä»»æœŸç¼–å·ã€‚
- æ—¥å¿—æ¡ç›®ä¸­çš„æ—¥å¿—ç´¢å¼•ç”¨æ¥è¡¨æ˜å®ƒåœ¨æ—¥å¿—ä¸­çš„ä½ç½®ï¼Œå®ƒæ˜¯ä¸€ä¸ªå•è°ƒé€’å¢çš„æ•´æ•°ã€‚

![img](https://pic3.zhimg.com/80/v2-ee29a89e4eb63468e142bb6103dbe4de_hd.jpg)

Raft æ—¥å¿—åŒæ­¥ä¿è¯å¦‚ä¸‹ä¸¤ç‚¹ï¼š

- å¦‚æœä¸åŒæ—¥å¿—ä¸­çš„ä¸¤ä¸ªæ—¥å¿—æ¡ç›®æœ‰ç€ç›¸åŒçš„æ—¥å¿—ç´¢å¼•å’Œ Termï¼Œåˆ™**å®ƒä»¬æ‰€å­˜å‚¨çš„å‘½ä»¤æ˜¯ç›¸åŒçš„**ã€‚
  - è¿™ä¸ªç‰¹æ€§åŸºäºè¿™æ¡åŸåˆ™ï¼šLeader æœ€å¤šåœ¨ä¸€ä¸ª Term å†…ã€åœ¨æŒ‡å®šçš„ä¸€ä¸ªæ—¥å¿—ç´¢å¼•ä¸Šåˆ›å»ºä¸€æ¡æ—¥å¿—æ¡ç›®ï¼ŒåŒæ—¶æ—¥å¿—æ¡ç›®åœ¨æ—¥å¿—ä¸­çš„ä½ç½®ä¹Ÿä»æ¥ä¸ä¼šæ”¹å˜ã€‚
- å¦‚æœä¸åŒæ—¥å¿—ä¸­çš„ä¸¤ä¸ªæ—¥å¿—æ¡ç›®æœ‰ç€ç›¸åŒçš„æ—¥å¿—ç´¢å¼•å’Œ Termï¼Œåˆ™**å®ƒä»¬ä¹‹å‰çš„æ‰€æœ‰æ¡ç›®éƒ½æ˜¯å®Œå…¨ä¸€æ ·çš„**ã€‚
  - è¿™ä¸ªç‰¹æ€§ç”± `AppendEntries RPC` çš„ä¸€ä¸ªç®€å•çš„ä¸€è‡´æ€§æ£€æŸ¥æ‰€ä¿è¯ã€‚åœ¨å‘é€ `AppendEntries RPC` æ—¶ï¼ŒLeader ä¼šæŠŠæ–°æ—¥å¿—æ¡ç›®ä¹‹å‰çš„æ—¥å¿—æ¡ç›®çš„æ—¥å¿—ç´¢å¼•å’Œ Term å·ä¸€èµ·å‘é€ã€‚å¦‚æœ Follower åœ¨å®ƒçš„æ—¥å¿—ä¸­æ‰¾ä¸åˆ°åŒ…å«ç›¸åŒæ—¥å¿—ç´¢å¼•å’Œ Term å·çš„æ—¥å¿—æ¡ç›®ï¼Œå®ƒå°±ä¼šæ‹’ç»æ¥æ”¶æ–°çš„æ—¥å¿—æ¡ç›®ã€‚

### æ—¥å¿—å¤åˆ¶æµç¨‹

![img](https://raw.githubusercontent.com/dunwu/images/master/snap/20200201115848.png)

1. Leader è´Ÿè´£å¤„ç†æ‰€æœ‰å®¢æˆ·ç«¯çš„è¯·æ±‚ã€‚
2. Leader æŠŠè¯·æ±‚ä½œä¸ºæ—¥å¿—æ¡ç›®åŠ å…¥åˆ°å®ƒçš„æ—¥å¿—ä¸­ï¼Œç„¶åå¹¶è¡Œçš„å‘å…¶ä»–æœåŠ¡å™¨å‘é€ `AppendEntries RPC` è¯·æ±‚ï¼Œè¦æ±‚ Follower å¤åˆ¶æ—¥å¿—æ¡ç›®ã€‚
3. Follower å¤åˆ¶æˆåŠŸåï¼Œè¿”å›ç¡®è®¤æ¶ˆæ¯ã€‚
4. å½“è¿™ä¸ªæ—¥å¿—æ¡ç›®è¢«åŠæ•°ä»¥ä¸Šçš„æœåŠ¡å™¨å¤åˆ¶åï¼ŒLeader æäº¤è¿™ä¸ªæ—¥å¿—æ¡ç›®åˆ°å®ƒçš„å¤åˆ¶çŠ¶æ€æœºï¼Œå¹¶å‘å®¢æˆ·ç«¯è¿”å›æ‰§è¡Œç»“æœã€‚

> æ³¨æ„ï¼šå¦‚æœ Follower å´©æºƒæˆ–è€…è¿è¡Œç¼“æ…¢ï¼Œå†æˆ–è€…ç½‘ç»œä¸¢åŒ…ï¼ŒLeader ä¼šä¸æ–­çš„é‡å¤å°è¯•å‘é€ `AppendEntries RPC` è¯·æ±‚ ï¼ˆå°½ç®¡å·²ç»å›å¤äº†å®¢æˆ·ç«¯ï¼‰ï¼Œç›´åˆ°æ‰€æœ‰çš„è·Ÿéšè€…éƒ½æœ€ç»ˆå¤åˆ¶äº†æ‰€æœ‰çš„æ—¥å¿—æ¡ç›®ã€‚

ä¸‹é¢ï¼Œé€šè¿‡ä¸€ç»„åŠ¨å›¾æ¥åŠ æ·±è®¤è¯†ï¼š

ï¼ˆ1ï¼‰æ¥è‡ªå®¢æˆ·ç«¯çš„ä¿®æ”¹éƒ½ä¼šè¢«ä¼ å…¥ Leaderã€‚æ³¨æ„è¯¥ä¿®æ”¹è¿˜æœªè¢«æäº¤ï¼Œåªæ˜¯å†™å…¥æ—¥å¿—ä¸­ã€‚

![img](https://raw.githubusercontent.com/dunwu/images/master/cs/design/architecture/raft-sync-log-01.gif)

ï¼ˆ2ï¼‰Leader ä¼šæŠŠä¿®æ”¹å¤åˆ¶åˆ°æ‰€æœ‰ Followerã€‚

![img](https://raw.githubusercontent.com/dunwu/images/master/cs/design/architecture/raft-sync-log-02.gif)

ï¼ˆ3ï¼‰Leader ä¼šç­‰å¾…å¤§å¤šæ•°çš„ Follower ä¹Ÿè¿›è¡Œäº†ä¿®æ”¹ï¼Œç„¶åæ‰å°†ä¿®æ”¹æäº¤ã€‚

![img](https://raw.githubusercontent.com/dunwu/images/master/cs/design/architecture/raft-sync-log-03.gif)

ï¼ˆ4ï¼‰æ­¤æ—¶ Leader ä¼šé€šçŸ¥çš„æ‰€æœ‰ Follower è®©å®ƒä»¬ä¹Ÿæäº¤ä¿®æ”¹ï¼Œæ­¤æ—¶æ‰€æœ‰èŠ‚ç‚¹çš„å€¼è¾¾æˆä¸€è‡´ã€‚

![img](https://raw.githubusercontent.com/dunwu/images/master/cs/design/architecture/raft-sync-log-04.gif)

### æ—¥å¿—ä¸€è‡´æ€§

ä¸€èˆ¬æƒ…å†µä¸‹ï¼ŒLeader å’Œ Followers çš„æ—¥å¿—ä¿æŒä¸€è‡´ï¼Œå› æ­¤æ—¥å¿—æ¡ç›®ä¸€è‡´æ€§æ£€æŸ¥é€šå¸¸ä¸ä¼šå¤±è´¥ã€‚ç„¶è€Œï¼ŒLeader å´©æºƒå¯èƒ½ä¼šå¯¼è‡´æ—¥å¿—ä¸ä¸€è‡´ï¼šæ—§çš„ Leader å¯èƒ½æ²¡æœ‰å®Œå…¨å¤åˆ¶å®Œæ—¥å¿—ä¸­çš„æ‰€æœ‰æ¡ç›®ã€‚

#### Leader å’Œ Follower æ—¥å¿—ä¸ä¸€è‡´çš„å¯èƒ½

Leader å’Œ Follower å¯èƒ½å­˜åœ¨å¤šç§æ—¥å¿—ä¸ä¸€è‡´çš„å¯èƒ½ã€‚

![img](https://pic4.zhimg.com/80/v2-d36c587901391cae50788061f568d24f_hd.jpg)

> :bulb: å›¾ç¤ºè¯´æ˜ï¼š
>
> ä¸Šå›¾é˜è¿°äº† Leader å’Œ Follower å¯èƒ½å­˜åœ¨å¤šç§æ—¥å¿—ä¸ä¸€è‡´çš„å¯èƒ½ï¼Œæ¯ä¸€ä¸ªæ–¹æ¡†è¡¨ç¤ºä¸€ä¸ªæ—¥å¿—æ¡ç›®ï¼Œé‡Œé¢çš„æ•°å­—è¡¨ç¤ºä»»æœŸå· ã€‚
>
> å½“ä¸€ä¸ª Leader æˆåŠŸå½“é€‰æ—¶ï¼ŒFollower å¯èƒ½å‡ºç°ä»¥ä¸‹æƒ…å†µï¼ˆa-fï¼‰ï¼š
>
> - **å­˜åœ¨æœªæ›´æ–°æ—¥å¿—æ¡ç›®**ï¼Œå¦‚ï¼ˆaã€bï¼‰ã€‚
> - **å­˜åœ¨æœªæäº¤æ—¥å¿—æ¡ç›®**ï¼Œå¦‚ï¼ˆcã€dï¼‰ã€‚
> - æˆ–**ä¸¤ç§æƒ…å†µéƒ½å­˜åœ¨**ï¼Œå¦‚ï¼ˆeã€fï¼‰ã€‚
>
> _ä¾‹å¦‚ï¼Œåœºæ™¯ f å¯èƒ½ä¼šè¿™æ ·å‘ç”Ÿï¼ŒæŸæœåŠ¡å™¨åœ¨ Term2 çš„æ—¶å€™æ˜¯ Leaderï¼Œå·²é™„åŠ äº†ä¸€äº›æ—¥å¿—æ¡ç›®åˆ°è‡ªå·±çš„æ—¥å¿—ä¸­ï¼Œä½†åœ¨æäº¤ä¹‹å‰å°±å´©æºƒäº†ï¼›å¾ˆå¿«è¿™ä¸ªæœºå™¨å°±è¢«é‡å¯äº†ï¼Œåœ¨ Term3 é‡æ–°è¢«é€‰ä¸º Leaderï¼Œå¹¶ä¸”åˆå¢åŠ äº†ä¸€äº›æ—¥å¿—æ¡ç›®åˆ°è‡ªå·±çš„æ—¥å¿—ä¸­ï¼›åœ¨ Term 2 å’Œ Term 3 çš„æ—¥å¿—è¢«æäº¤ä¹‹å‰ï¼Œè¿™ä¸ªæœåŠ¡å™¨åˆå®•æœºäº†ï¼Œå¹¶ä¸”åœ¨æ¥ä¸‹æ¥çš„å‡ ä¸ªä»»æœŸé‡Œä¸€ç›´å¤„äºå®•æœºçŠ¶æ€_ã€‚

#### Leader å’Œ Follower æ—¥å¿—ä¸€è‡´çš„ä¿è¯

Leader é€šè¿‡å¼ºåˆ¶ Followers å¤åˆ¶å®ƒçš„æ—¥å¿—æ¥å¤„ç†æ—¥å¿—çš„ä¸ä¸€è‡´ï¼Œ**Followers ä¸Šçš„ä¸ä¸€è‡´çš„æ—¥å¿—ä¼šè¢« Leader çš„æ—¥å¿—è¦†ç›–**ã€‚

- Leader ä¸ºäº†ä½¿ Followers çš„æ—¥å¿—åŒè‡ªå·±çš„ä¸€è‡´ï¼ŒLeader éœ€è¦æ‰¾åˆ° Followers åŒå®ƒçš„æ—¥å¿—ä¸€è‡´çš„åœ°æ–¹ï¼Œç„¶åè¦†ç›– Followers åœ¨è¯¥ä½ç½®ä¹‹åçš„æ¡ç›®ã€‚
- Leader ä¼šä»åå¾€å‰è¯•ï¼Œæ¯æ¬¡æ—¥å¿—æ¡ç›®å¤±è´¥åå°è¯•å‰ä¸€ä¸ªæ—¥å¿—æ¡ç›®ï¼Œç›´åˆ°æˆåŠŸæ‰¾åˆ°æ¯ä¸ª Follower çš„æ—¥å¿—ä¸€è‡´ä½ç‚¹ï¼Œç„¶åå‘åé€æ¡è¦†ç›– Followers åœ¨è¯¥ä½ç½®ä¹‹åçš„æ¡ç›®ã€‚

## å®‰å…¨æ€§

å‰é¢æè¿°äº† Raft ç®—æ³•æ˜¯å¦‚ä½•é€‰ä¸¾ Leader å’Œå¤åˆ¶æ—¥å¿—çš„ã€‚

Raft è¿˜å¢åŠ äº†ä¸€äº›é™åˆ¶æ¥å®Œå–„ Raft ç®—æ³•ï¼Œä»¥ä¿è¯å®‰å…¨æ€§ï¼šä¿è¯äº†ä»»æ„ Leader å¯¹äºç»™å®šçš„ Termï¼Œéƒ½æ‹¥æœ‰äº†ä¹‹å‰ Term çš„æ‰€æœ‰è¢«æäº¤çš„æ—¥å¿—æ¡ç›®ã€‚

### é€‰ä¸¾é™åˆ¶

æ‹¥æœ‰æœ€æ–°çš„å·²æäº¤çš„æ—¥å¿—æ¡ç›®çš„ Follower æ‰æœ‰èµ„æ ¼æˆä¸º Leaderã€‚

Raft ä½¿ç”¨æŠ•ç¥¨çš„æ–¹å¼æ¥é˜»æ­¢ä¸€ä¸ª Candidate èµ¢å¾—é€‰ä¸¾é™¤éè¿™ä¸ª Candidate åŒ…å«äº†æ‰€æœ‰å·²ç»æäº¤çš„æ—¥å¿—æ¡ç›®ã€‚ Candidate ä¸ºäº†èµ¢å¾—é€‰ä¸¾å¿…é¡»è”ç³»é›†ç¾¤ä¸­çš„å¤§éƒ¨åˆ†èŠ‚ç‚¹ï¼Œè¿™æ„å‘³ç€æ¯ä¸€ä¸ªå·²ç»æäº¤çš„æ—¥å¿—æ¡ç›®åœ¨è¿™äº›æœåŠ¡å™¨èŠ‚ç‚¹ä¸­è‚¯å®šå­˜åœ¨äºè‡³å°‘ä¸€ä¸ªèŠ‚ç‚¹ä¸Šã€‚å¦‚æœ Candidate çš„æ—¥å¿—è‡³å°‘å’Œå¤§å¤šæ•°çš„æœåŠ¡å™¨èŠ‚ç‚¹ä¸€æ ·æ–°ï¼ˆè¿™ä¸ªæ–°çš„å®šä¹‰ä¼šåœ¨ä¸‹é¢è®¨è®ºï¼‰ï¼Œé‚£ä¹ˆä»–ä¸€å®šæŒæœ‰äº†æ‰€æœ‰å·²ç»æäº¤çš„æ—¥å¿—æ¡ç›®ã€‚

`RequestVote RPC` å®ç°äº†è¿™æ ·çš„é™åˆ¶ï¼š**RequestVote RPC ä¸­åŒ…å«äº† Candidate çš„æ—¥å¿—ä¿¡æ¯ï¼Œ Follower ä¼šæ‹’ç»æ‰é‚£äº›æ—¥å¿—æ²¡æœ‰è‡ªå·±æ–°çš„æŠ•ç¥¨è¯·æ±‚**ã€‚

å¦‚ä½•åˆ¤æ–­å“ªä¸ªæ—¥å¿—æ¡ç›®æ¯”è¾ƒæ–°ï¼Ÿ

Raft é€šè¿‡æ¯”è¾ƒä¸¤ä»½æ—¥å¿—ä¸­æœ€åä¸€æ¡æ—¥å¿—æ¡ç›®çš„æ—¥å¿—ç´¢å¼•å’Œ Term æ¥åˆ¤æ–­å“ªä¸ªæ—¥å¿—æ¯”è¾ƒæ–°ã€‚

- å…ˆåˆ¤æ–­ Termï¼Œå“ªä¸ªæ•°å€¼å¤§å³ä»£è¡¨å“ªä¸ªæ—¥å¿—æ¯”è¾ƒæ–°ã€‚
- å¦‚æœ Term ç›¸åŒï¼Œå†æ¯”è¾ƒ æ—¥å¿—ç´¢å¼•ï¼Œå“ªä¸ªæ•°å€¼å¤§å³ä»£è¡¨å“ªä¸ªæ—¥å¿—æ¯”è¾ƒæ–°ã€‚

### æäº¤æ—§ä»»æœŸçš„æ—¥å¿—æ¡ç›®

ä¸€ä¸ªå½“å‰ Term çš„æ—¥å¿—æ¡ç›®è¢«å¤åˆ¶åˆ°äº†åŠæ•°ä»¥ä¸Šçš„æœåŠ¡å™¨ä¸Šï¼ŒLeader å°±è®¤ä¸ºå®ƒæ˜¯å¯ä»¥è¢«æäº¤çš„ã€‚å¦‚æœè¿™ä¸ª Leader åœ¨æäº¤æ—¥å¿—æ¡ç›®å‰å°±ä¸‹çº¿äº†ï¼Œåç»­çš„ Leader å¯èƒ½ä¼šè¦†ç›–æ‰è¿™ä¸ªæ—¥å¿—æ¡ç›®ã€‚

![img](https://pic4.zhimg.com/80/v2-12a5ebab63781f9ec49e14e331775537_hd.jpg)

> ğŸ’¡ å›¾ç¤ºè¯´æ˜ï¼š
>
> ä¸Šå›¾è§£é‡Šäº†ä¸ºä»€ä¹ˆ Leader æ— æ³•å¯¹æ—§ Term çš„æ—¥å¿—æ¡ç›®è¿›è¡Œæäº¤ã€‚
>
> - é˜¶æ®µ (a) ï¼ŒS1 æ˜¯ Leaderï¼Œä¸” S1 å†™å…¥æ—¥å¿—æ¡ç›®ä¸º (Term 2ï¼Œæ—¥å¿—ç´¢å¼• 2ï¼‰ï¼Œåªæœ‰ S2 å¤åˆ¶äº†è¿™ä¸ªæ—¥å¿—æ¡ç›®ã€‚
> - é˜¶æ®µ (b)ï¼ŒS1 ä¸‹çº¿ï¼ŒS5 è¢«é€‰ä¸¾ä¸º Term3 çš„ Leaderã€‚S5 å†™å…¥æ—¥å¿—æ¡ç›®ä¸º (Term 3ï¼Œæ—¥å¿—ç´¢å¼• 2ï¼‰ã€‚
> - é˜¶æ®µ (c)ï¼ŒS5 ä¸‹çº¿ï¼ŒS1 é‡æ–°ä¸Šçº¿ï¼Œå¹¶è¢«é€‰ä¸¾ä¸º Term4 çš„ Leaderã€‚æ­¤æ—¶ï¼ŒTerm 2 çš„é‚£æ¡æ—¥å¿—æ¡ç›®å·²ç»è¢«å¤åˆ¶åˆ°äº†é›†ç¾¤ä¸­çš„å¤§å¤šæ•°èŠ‚ç‚¹ä¸Šï¼Œä½†æ˜¯è¿˜æ²¡æœ‰è¢«æäº¤ã€‚
> - é˜¶æ®µ (d)ï¼ŒS1 å†æ¬¡ä¸‹çº¿ï¼ŒS5 é‡æ–°ä¸Šçº¿ï¼Œå¹¶è¢«é‡æ–°é€‰ä¸¾ä¸º Term3 çš„ Leaderã€‚ç„¶å S5 è¦†ç›–äº†æ—¥å¿—ç´¢å¼• 2 å¤„çš„æ—¥å¿—ã€‚
> - é˜¶æ®µ (e)ï¼Œå¦‚æœé˜¶æ®µ (d) è¿˜æœªå‘ç”Ÿï¼Œå³ S1 å†æ¬¡ä¸‹çº¿ä¹‹å‰ï¼ŒS1 æŠŠè‡ªå·±ä¸»å¯¼çš„æ—¥å¿—æ¡ç›®å¤åˆ¶åˆ°äº†å¤§å¤šæ•°èŠ‚ç‚¹ä¸Šï¼Œé‚£ä¹ˆåœ¨åç»­ Term é‡Œé¢è¿™äº›æ–°æ—¥å¿—æ¡ç›®å°±ä¼šè¢«æäº¤ã€‚è¿™æ ·åœ¨åŒä¸€æ—¶åˆ»å°±åŒæ—¶ä¿è¯äº†ï¼Œä¹‹å‰çš„æ‰€æœ‰æ—§æ—¥å¿—æ¡ç›®å°±ä¼šè¢«æäº¤ã€‚

**Raft æ°¸è¿œä¸ä¼šé€šè¿‡è®¡ç®—å‰¯æœ¬æ•°ç›®çš„æ–¹å¼å»æäº¤ä¸€ä¸ªä¹‹å‰ Term å†…çš„æ—¥å¿—æ¡ç›®**ã€‚åªæœ‰ Leader å½“å‰ Term é‡Œçš„æ—¥å¿—æ¡ç›®é€šè¿‡è®¡ç®—å‰¯æœ¬æ•°ç›®å¯ä»¥è¢«æäº¤ï¼›ä¸€æ—¦å½“å‰ Term çš„æ—¥å¿—æ¡ç›®ä»¥è¿™ç§æ–¹å¼è¢«æäº¤ï¼Œé‚£ä¹ˆç”±äºæ—¥å¿—åŒ¹é…ç‰¹æ€§ï¼Œä¹‹å‰çš„æ—¥å¿—æ¡ç›®ä¹Ÿéƒ½ä¼šè¢«é—´æ¥çš„æäº¤ã€‚

å½“ Leader å¤åˆ¶ä¹‹å‰ä»»æœŸé‡Œçš„æ—¥å¿—æ—¶ï¼ŒRaft ä¼šä¸ºæ‰€æœ‰æ—¥å¿—ä¿ç•™åŸå§‹çš„ Termï¼Œè¿™åœ¨æäº¤è§„åˆ™ä¸Šäº§ç”Ÿäº†é¢å¤–çš„å¤æ‚æ€§ã€‚åœ¨å…¶ä»–çš„ä¸€è‡´æ€§ç®—æ³•ä¸­ï¼Œå¦‚æœä¸€ä¸ªæ–°çš„é¢†å¯¼äººè¦é‡æ–°å¤åˆ¶ä¹‹å‰çš„ä»»æœŸé‡Œçš„æ—¥å¿—æ—¶ï¼Œå®ƒå¿…é¡»ä½¿ç”¨å½“å‰æ–°çš„ä»»æœŸå·ã€‚Raft ä½¿ç”¨çš„æ–¹æ³•æ›´åŠ å®¹æ˜“è¾¨åˆ«å‡ºæ—¥å¿—ï¼Œå› ä¸ºå®ƒå¯ä»¥éšç€æ—¶é—´å’Œæ—¥å¿—çš„å˜åŒ–å¯¹æ—¥å¿—ç»´æŠ¤ç€åŒä¸€ä¸ªä»»æœŸç¼–å·ã€‚å¦å¤–ï¼Œå’Œå…¶ä»–çš„ç®—æ³•ç›¸æ¯”ï¼ŒRaft ä¸­çš„æ–°é¢†å¯¼äººåªéœ€è¦å‘é€æ›´å°‘æ—¥å¿—æ¡ç›®ï¼ˆå…¶ä»–ç®—æ³•ä¸­å¿…é¡»åœ¨ä»–ä»¬è¢«æäº¤ä¹‹å‰å‘é€æ›´å¤šçš„å†—ä½™æ—¥å¿—æ¡ç›®æ¥ä¸ºä»–ä»¬é‡æ–°ç¼–å·ï¼‰ã€‚

## æ—¥å¿—å‹ç¼©

åœ¨å®é™…çš„ç³»ç»Ÿä¸­ï¼Œä¸èƒ½è®©æ—¥å¿—æ— é™è†¨èƒ€ï¼Œå¦åˆ™ç³»ç»Ÿé‡å¯æ—¶éœ€è¦èŠ±å¾ˆé•¿çš„æ—¶é—´è¿›è¡Œæ¢å¤ï¼Œä»è€Œå½±å“å¯ç”¨æ€§ã€‚Raft é‡‡ç”¨å¯¹æ•´ä¸ªç³»ç»Ÿè¿›è¡Œå¿«ç…§æ¥è§£å†³ï¼Œå¿«ç…§ä¹‹å‰çš„æ—¥å¿—éƒ½å¯ä»¥ä¸¢å¼ƒã€‚

æ¯ä¸ªå‰¯æœ¬ç‹¬ç«‹çš„å¯¹è‡ªå·±çš„ç³»ç»ŸçŠ¶æ€ç”Ÿæˆå¿«ç…§ï¼Œå¹¶ä¸”åªèƒ½å¯¹å·²ç»æäº¤çš„æ—¥å¿—æ¡ç›®ç”Ÿæˆå¿«ç…§ã€‚

å¿«ç…§åŒ…å«ä»¥ä¸‹å†…å®¹ï¼š

- æ—¥å¿—å…ƒæ•°æ®ã€‚æœ€åä¸€æ¡å·²æäº¤çš„æ—¥å¿—æ¡ç›®çš„æ—¥å¿—ç´¢å¼•å’Œ Termã€‚è¿™ä¸¤ä¸ªå€¼åœ¨å¿«ç…§ä¹‹åçš„ç¬¬ä¸€æ¡æ—¥å¿—æ¡ç›®çš„ `AppendEntries RPC` çš„å®Œæ•´æ€§æ£€æŸ¥çš„æ—¶å€™ä¼šè¢«ç”¨ä¸Šã€‚
- ç³»ç»Ÿå½“å‰çŠ¶æ€ã€‚

å½“ Leader è¦å‘é€æŸä¸ªæ—¥å¿—æ¡ç›®ï¼Œè½åå¤ªå¤šçš„ Follower çš„æ—¥å¿—æ¡ç›®ä¼šè¢«ä¸¢å¼ƒï¼ŒLeader ä¼šå°†å¿«ç…§å‘ç»™ Followerã€‚æˆ–è€…æ–°ä¸Šçº¿ä¸€å°æœºå™¨æ—¶ï¼Œä¹Ÿä¼šå‘é€å¿«ç…§ç»™å®ƒã€‚

![img](https://raw.githubusercontent.com/dunwu/images/master/snap/20200201220628.png)

**ç”Ÿæˆå¿«ç…§çš„é¢‘ç‡è¦é€‚ä¸­**ï¼Œé¢‘ç‡è¿‡é«˜ä¼šæ¶ˆè€—å¤§é‡ I/O å¸¦å®½ï¼›é¢‘ç‡è¿‡ä½ï¼Œä¸€æ—¦éœ€è¦æ‰§è¡Œæ¢å¤æ“ä½œï¼Œä¼šä¸¢å¤±å¤§é‡æ•°æ®ï¼Œå½±å“å¯ç”¨æ€§ã€‚æ¨èå½“æ—¥å¿—è¾¾åˆ°æŸä¸ªå›ºå®šçš„å¤§å°æ—¶ç”Ÿæˆå¿«ç…§ã€‚

ç”Ÿæˆä¸€æ¬¡å¿«ç…§å¯èƒ½è€—æ—¶è¿‡é•¿ï¼Œå½±å“æ­£å¸¸æ—¥å¿—åŒæ­¥ã€‚å¯ä»¥é€šè¿‡ä½¿ç”¨ copy-on-write æŠ€æœ¯é¿å…å¿«ç…§è¿‡ç¨‹å½±å“æ­£å¸¸æ—¥å¿—åŒæ­¥ã€‚

> è¯´æ˜ï¼šæœ¬æ–‡ä»…é˜è¿° Raft ç®—æ³•çš„æ ¸å¿ƒå†…å®¹ï¼Œä¸åŒ…æ‹¬ç®—æ³•è®ºè¯ã€è¯„ä¼°ç­‰

## å‚è€ƒèµ„æ–™

- [Raft ç®—æ³•è®ºæ–‡](https://ramcloud.atlassian.net/wiki/download/attachments/6586375/raft.pdf)
- [Raft ç®—æ³•è®ºæ–‡è¯‘æ–‡](https://github.com/maemual/raft-zh_cn/blob/master/raft-zh_cn.md)
- [Raft ä½œè€…è®²è§£è§†é¢‘](https://www.youtube.com/watch?v=YbZ3zDzDnrw&feature=youtu.be)
- [Raft ä½œè€…è®²è§£è§†é¢‘å¯¹åº”çš„ PPT](http://www2.cs.uh.edu/~paris/6360/PowerPoint/Raft.ppt)
- [åˆ†å¸ƒå¼ç³»ç»Ÿçš„ Raft ç®—æ³•](https://www.jdon.com/artichect/raft.html)
- [Raft ç®—æ³•è¯¦è§£](https://zhuanlan.zhihu.com/p/32052223)
- [Raft: Understandable Distributed Consensus](http://thesecretlivesofdata.com/raft) - ä¸€ä¸ªåŠ¨ç”»æ•™ç¨‹
- [The Raft Consensus Algorithm](https://raft.github.io/) - ä¸€ä¸ªäº¤äº’å¼åŠ¨ç”»æ•™ç¨‹
- [sofa-jraft](https://github.com/sofastack/sofa-jraft) - èš‚èšé‡‘æœçš„ Raft ç®—æ³•å®ç°åº“ï¼ˆJava ç‰ˆï¼‰
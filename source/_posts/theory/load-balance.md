---
title: æ·±å…¥æµ…å‡ºè´Ÿè½½å‡è¡¡
categories: ['åˆ†å¸ƒå¼']
tags: ['åˆ†å¸ƒå¼', 'è´Ÿè½½å‡è¡¡']
date: 2018-07-05 15:50
---

# æ·±å…¥æµ…å‡ºè´Ÿè½½å‡è¡¡

> ğŸ“¦ æœ¬æ–‡å·²å½’æ¡£åˆ°ï¼šã€Œ[blog](https://github.com/dunwu/blog)ã€

![img](https://raw.githubusercontent.com/dunwu/images/dev/snap/20200528155252.png)

<!-- TOC depthFrom:2 depthTo:3 -->

- [1. è´Ÿè½½å‡è¡¡ç®€ä»‹](#1-è´Ÿè½½å‡è¡¡ç®€ä»‹)
  - [1.1. å¤§å‹ç½‘ç«™é¢ä¸´çš„æŒ‘æˆ˜](#11-å¤§å‹ç½‘ç«™é¢ä¸´çš„æŒ‘æˆ˜)
  - [1.2. ä»€ä¹ˆæ˜¯è´Ÿè½½å‡è¡¡](#12-ä»€ä¹ˆæ˜¯è´Ÿè½½å‡è¡¡)
- [2. è´Ÿè½½å‡è¡¡çš„åˆ†ç±»](#2-è´Ÿè½½å‡è¡¡çš„åˆ†ç±»)
  - [2.1. è½½ä½“ç»´åº¦åˆ†ç±»](#21-è½½ä½“ç»´åº¦åˆ†ç±»)
  - [2.2. ç½‘ç»œé€šä¿¡åˆ†ç±»](#22-ç½‘ç»œé€šä¿¡åˆ†ç±»)
- [3. è´Ÿè½½å‡è¡¡ç®—æ³•](#3-è´Ÿè½½å‡è¡¡ç®—æ³•)
  - [3.1. éšæœº](#31-éšæœº)
  - [3.2. è½®è¯¢](#32-è½®è¯¢)
  - [3.3. æœ€å°æ´»è·ƒæ•°](#33-æœ€å°æ´»è·ƒæ•°)
  - [3.4. æºåœ°å€å“ˆå¸Œ](#34-æºåœ°å€å“ˆå¸Œ)
  - [3.5. ä¸€è‡´æ€§å“ˆå¸Œ](#35-ä¸€è‡´æ€§å“ˆå¸Œ)
- [4. å‚è€ƒèµ„æ–™](#4-å‚è€ƒèµ„æ–™)

<!-- /TOC -->

## 1. è´Ÿè½½å‡è¡¡ç®€ä»‹

### 1.1. å¤§å‹ç½‘ç«™é¢ä¸´çš„æŒ‘æˆ˜

å¤§å‹ç½‘ç«™éƒ½è¦é¢å¯¹åºå¤§çš„ç”¨æˆ·é‡ï¼Œé«˜å¹¶å‘ï¼Œæµ·é‡æ•°æ®ç­‰æŒ‘æˆ˜ã€‚

ä¸ºäº†æå‡ç³»ç»Ÿæ•´ä½“çš„æ€§èƒ½ï¼Œå¯ä»¥é‡‡ç”¨å‚ç›´æ‰©å±•å’Œæ°´å¹³æ‰©å±•ä¸¤ç§æ–¹å¼ã€‚

- **å‚ç›´æ‰©å±•**ï¼šåœ¨ç½‘ç«™å‘å±•æ—©æœŸï¼Œå¯ä»¥ä»å•æœºçš„è§’åº¦é€šè¿‡**å¢åŠ ç¡¬ä»¶å¤„ç†èƒ½åŠ›**ï¼Œæ¯”å¦‚ CPU å¤„ç†èƒ½åŠ›ï¼Œå†…å­˜å®¹é‡ï¼Œç£ç›˜ç­‰æ–¹é¢ï¼Œå®ç°æœåŠ¡å™¨å¤„ç†èƒ½åŠ›çš„æå‡ã€‚ä½†æ˜¯ï¼Œå•æœºæ˜¯æœ‰æ€§èƒ½ç“¶é¢ˆçš„ï¼Œä¸€æ—¦è§¦åŠç“¶é¢ˆï¼Œå†æƒ³æå‡ï¼Œä»˜å‡ºçš„æˆæœ¬å’Œä»£ä»·ä¼šæé«˜ã€‚è¿™æ˜¾ç„¶ä¸èƒ½æ»¡è¶³å¤§å‹åˆ†å¸ƒå¼ç³»ç»Ÿï¼ˆç½‘ç«™ï¼‰æ‰€æœ‰åº”å¯¹çš„å¤§æµé‡ï¼Œé«˜å¹¶å‘ï¼Œæµ·é‡æ•°æ®ç­‰æŒ‘æˆ˜ã€‚
- **æ°´å¹³æ‰©å±•**ï¼šé€šè¿‡é›†ç¾¤æ¥åˆ†æ‹…å¤§å‹ç½‘ç«™çš„æµé‡ã€‚é›†ç¾¤ä¸­çš„åº”ç”¨æœåŠ¡å™¨ï¼ˆèŠ‚ç‚¹ï¼‰é€šå¸¸è¢«è®¾è®¡æˆæ— çŠ¶æ€ï¼Œç”¨æˆ·å¯ä»¥è¯·æ±‚ä»»ä½•ä¸€ä¸ªèŠ‚ç‚¹ï¼Œè¿™äº›èŠ‚ç‚¹å…±åŒåˆ†æ‹…è®¿é—®å‹åŠ›ã€‚æ°´å¹³æ‰©å±•æœ‰ä¸¤ä¸ªè¦ç‚¹ï¼š
  - **åº”ç”¨é›†ç¾¤**ï¼šå°†åŒä¸€åº”ç”¨éƒ¨ç½²åˆ°å¤šå°æœºå™¨ä¸Šï¼Œç»„æˆå¤„ç†é›†ç¾¤ï¼Œæ¥æ”¶è´Ÿè½½å‡è¡¡è®¾å¤‡åˆ†å‘çš„è¯·æ±‚ï¼Œè¿›è¡Œå¤„ç†ï¼Œå¹¶è¿”å›ç›¸åº”æ•°æ®ã€‚
  - **è´Ÿè½½å‡è¡¡**ï¼šå°†ç”¨æˆ·è®¿é—®è¯·æ±‚ï¼Œé€šè¿‡æŸç§ç®—æ³•ï¼Œåˆ†å‘åˆ°é›†ç¾¤ä¸­çš„èŠ‚ç‚¹ã€‚

### 1.2. ä»€ä¹ˆæ˜¯è´Ÿè½½å‡è¡¡

è´Ÿè½½å‡è¡¡ï¼ˆLoad Balanceï¼Œç®€ç§° LBï¼‰æ˜¯é«˜å¹¶å‘ã€é«˜å¯ç”¨ç³»ç»Ÿå¿…ä¸å¯å°‘çš„å…³é”®ç»„ä»¶ï¼Œç›®æ ‡æ˜¯ **å°½åŠ›å°†ç½‘ç»œæµé‡å¹³å‡åˆ†å‘åˆ°å¤šä¸ªæœåŠ¡å™¨ä¸Šï¼Œä»¥æé«˜ç³»ç»Ÿæ•´ä½“çš„å“åº”é€Ÿåº¦å’Œå¯ç”¨æ€§**ã€‚

è´Ÿè½½å‡è¡¡çš„ä¸»è¦ä½œç”¨å¦‚ä¸‹ï¼š

- **é«˜å¹¶å‘**ï¼šè´Ÿè½½å‡è¡¡é€šè¿‡ç®—æ³•è°ƒæ•´è´Ÿè½½ï¼Œå°½åŠ›å‡åŒ€çš„åˆ†é…åº”ç”¨é›†ç¾¤ä¸­å„èŠ‚ç‚¹çš„å·¥ä½œé‡ï¼Œä»¥æ­¤æé«˜åº”ç”¨é›†ç¾¤çš„å¹¶å‘å¤„ç†èƒ½åŠ›ï¼ˆååé‡ï¼‰ã€‚
- **ä¼¸ç¼©æ€§**ï¼šæ·»åŠ æˆ–å‡å°‘æœåŠ¡å™¨æ•°é‡ï¼Œç„¶åç”±è´Ÿè½½å‡è¡¡è¿›è¡Œåˆ†å‘æ§åˆ¶ã€‚è¿™ä½¿å¾—åº”ç”¨é›†ç¾¤å…·å¤‡ä¼¸ç¼©æ€§ã€‚
- **é«˜å¯ç”¨**ï¼šè´Ÿè½½å‡è¡¡å™¨å¯ä»¥ç›‘æ§å€™é€‰æœåŠ¡å™¨ï¼Œå½“æœåŠ¡å™¨ä¸å¯ç”¨æ—¶ï¼Œè‡ªåŠ¨è·³è¿‡ï¼Œå°†è¯·æ±‚åˆ†å‘ç»™å¯ç”¨çš„æœåŠ¡å™¨ã€‚è¿™ä½¿å¾—åº”ç”¨é›†ç¾¤å…·å¤‡é«˜å¯ç”¨çš„ç‰¹æ€§ã€‚
- **å®‰å…¨é˜²æŠ¤**ï¼šæœ‰äº›è´Ÿè½½å‡è¡¡è½¯ä»¶æˆ–ç¡¬ä»¶æä¾›äº†å®‰å…¨æ€§åŠŸèƒ½ï¼Œå¦‚ï¼šé»‘ç™½åå•å¤„ç†ã€é˜²ç«å¢™ï¼Œé˜² DDos æ”»å‡»ç­‰ã€‚

## 2. è´Ÿè½½å‡è¡¡çš„åˆ†ç±»

æ”¯æŒè´Ÿè½½å‡è¡¡çš„æŠ€æœ¯å¾ˆå¤šï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸åŒç»´åº¦å»è¿›è¡Œåˆ†ç±»ã€‚

### 2.1. è½½ä½“ç»´åº¦åˆ†ç±»

ä»æ”¯æŒè´Ÿè½½å‡è¡¡çš„è½½ä½“æ¥çœ‹ï¼Œå¯ä»¥å°†è´Ÿè½½å‡è¡¡åˆ†ä¸ºä¸¤ç±»ï¼š

- ç¡¬ä»¶è´Ÿè½½å‡è¡¡
- è½¯ä»¶è´Ÿè½½å‡è¡¡

#### ç¡¬ä»¶è´Ÿè½½å‡è¡¡

ç¡¬ä»¶è´Ÿè½½å‡è¡¡ï¼Œä¸€èˆ¬æ˜¯åœ¨å®šåˆ¶å¤„ç†å™¨ä¸Šè¿è¡Œçš„ç‹¬ç«‹è´Ÿè½½å‡è¡¡æœåŠ¡å™¨ï¼Œ**ä»·æ ¼æ˜‚è´µï¼ŒåœŸè±ªä¸“å±**ã€‚

ç¡¬ä»¶è´Ÿè½½å‡è¡¡çš„ **ä¸»æµäº§å“** æœ‰ï¼š[F5](https://f5.com/zh) å’Œ [A10](https://www.a10networks.com.cn/)ã€‚

ç¡¬ä»¶è´Ÿè½½å‡è¡¡çš„ **ä¼˜ç‚¹**ï¼š

- **åŠŸèƒ½å¼ºå¤§**ï¼šæ”¯æŒå…¨å±€è´Ÿè½½å‡è¡¡å¹¶æä¾›è¾ƒå…¨é¢çš„ã€å¤æ‚çš„è´Ÿè½½å‡è¡¡ç®—æ³•ã€‚
- **æ€§èƒ½å¼ºæ‚**ï¼šç¡¬ä»¶è´Ÿè½½å‡è¡¡ç”±äºæ˜¯åœ¨ä¸“ç”¨å¤„ç†å™¨ä¸Šè¿è¡Œï¼Œå› æ­¤ååé‡å¤§ï¼Œå¯æ”¯æŒå•æœºç™¾ä¸‡ä»¥ä¸Šçš„å¹¶å‘ã€‚
- **å®‰å…¨æ€§é«˜**ï¼šå¾€å¾€å…·å¤‡é˜²ç«å¢™ï¼Œé˜² DDos æ”»å‡»ç­‰å®‰å…¨åŠŸèƒ½ã€‚

ç¡¬ä»¶è´Ÿè½½å‡è¡¡çš„ **ç¼ºç‚¹**ï¼š

- **æˆæœ¬æ˜‚è´µ**ï¼šè´­ä¹°å’Œç»´æŠ¤ç¡¬ä»¶è´Ÿè½½å‡è¡¡çš„æˆæœ¬éƒ½å¾ˆé«˜ã€‚
- **æ‰©å±•æ€§å·®**ï¼šå½“è®¿é—®é‡çªå¢æ—¶ï¼Œè¶…è¿‡é™åº¦ä¸èƒ½åŠ¨æ€æ‰©å®¹ã€‚

#### è½¯ä»¶è´Ÿè½½å‡è¡¡

è½¯ä»¶è´Ÿè½½å‡è¡¡ï¼Œ**åº”ç”¨æœ€å¹¿æ³›**ï¼Œæ— è®ºå¤§å…¬å¸è¿˜æ˜¯å°å…¬å¸éƒ½ä¼šä½¿ç”¨ã€‚

è½¯ä»¶è´Ÿè½½å‡è¡¡ä»è½¯ä»¶å±‚é¢å®ç°è´Ÿè½½å‡è¡¡ï¼Œä¸€èˆ¬å¯ä»¥åœ¨ä»»ä½•æ ‡å‡†ç‰©ç†è®¾å¤‡ä¸Šè¿è¡Œã€‚

è½¯ä»¶è´Ÿè½½å‡è¡¡çš„ **ä¸»æµäº§å“** æœ‰ï¼š[Nginx](https://www.nginx.com/)ã€[HAProxy](http://www.haproxy.org/)ã€[LVS](https://github.com/alibaba/LVS)ã€‚

- [LVS](https://github.com/alibaba/LVS) å¯ä»¥ä½œä¸ºå››å±‚è´Ÿè½½å‡è¡¡å™¨ã€‚å…¶è´Ÿè½½å‡è¡¡çš„æ€§èƒ½è¦ä¼˜äº Nginxã€‚
- [HAProxy](http://www.haproxy.org/) å¯ä»¥ä½œä¸º HTTP å’Œ TCP è´Ÿè½½å‡è¡¡å™¨ã€‚
- [Nginx](https://www.nginx.com/)ã€[HAProxy](http://www.haproxy.org/) å¯ä»¥ä½œä¸ºå››å±‚æˆ–ä¸ƒå±‚è´Ÿè½½å‡è¡¡å™¨ã€‚

è½¯ä»¶è´Ÿè½½å‡è¡¡çš„ **ä¼˜ç‚¹**ï¼š

- **æ‰©å±•æ€§å¥½**ï¼šé€‚åº”åŠ¨æ€å˜åŒ–ï¼Œå¯ä»¥é€šè¿‡æ·»åŠ è½¯ä»¶è´Ÿè½½å‡è¡¡å®ä¾‹ï¼ŒåŠ¨æ€æ‰©å±•åˆ°è¶…å‡ºåˆå§‹å®¹é‡çš„èƒ½åŠ›ã€‚
- **æˆæœ¬ä½å»‰**ï¼šè½¯ä»¶è´Ÿè½½å‡è¡¡å¯ä»¥åœ¨ä»»ä½•æ ‡å‡†ç‰©ç†è®¾å¤‡ä¸Šè¿è¡Œï¼Œé™ä½äº†è´­ä¹°å’Œè¿ç»´çš„æˆæœ¬ã€‚

è½¯ä»¶è´Ÿè½½å‡è¡¡çš„ **ç¼ºç‚¹**ï¼š

- **æ€§èƒ½ç•¥å·®**ï¼šç›¸æ¯”äºç¡¬ä»¶è´Ÿè½½å‡è¡¡ï¼Œè½¯ä»¶è´Ÿè½½å‡è¡¡çš„æ€§èƒ½è¦ç•¥ä½ä¸€äº›ã€‚

### 2.2. ç½‘ç»œé€šä¿¡åˆ†ç±»

è½¯ä»¶è´Ÿè½½å‡è¡¡ä»é€šä¿¡å±‚é¢æ¥çœ‹ï¼Œåˆå¯ä»¥åˆ†ä¸ºå››å±‚å’Œä¸ƒå±‚è´Ÿè½½å‡è¡¡ã€‚

- ä¸ƒå±‚è´Ÿè½½å‡è¡¡ï¼šå°±æ˜¯å¯ä»¥æ ¹æ®è®¿é—®ç”¨æˆ·çš„ HTTP è¯·æ±‚å¤´ã€URL ä¿¡æ¯å°†è¯·æ±‚è½¬å‘åˆ°ç‰¹å®šçš„ä¸»æœºã€‚
  - DNS é‡å®šå‘
  - HTTP é‡å®šå‘
  - åå‘ä»£ç†
- å››å±‚è´Ÿè½½å‡è¡¡ï¼šåŸºäº IP åœ°å€å’Œç«¯å£è¿›è¡Œè¯·æ±‚çš„è½¬å‘ã€‚
  - ä¿®æ”¹ IP åœ°å€
  - ä¿®æ”¹ MAC åœ°å€

#### DNS è´Ÿè½½å‡è¡¡

DNS è´Ÿè½½å‡è¡¡ä¸€èˆ¬ç”¨äºäº’è”ç½‘å…¬å¸ï¼Œå¤æ‚çš„ä¸šåŠ¡ç³»ç»Ÿä¸é€‚åˆä½¿ç”¨ã€‚å¤§å‹ç½‘ç«™ä¸€èˆ¬ä½¿ç”¨ DNS è´Ÿè½½å‡è¡¡ä½œä¸º **ç¬¬ä¸€çº§è´Ÿè½½å‡è¡¡æ‰‹æ®µ**ï¼Œç„¶ååœ¨å†…éƒ¨ä½¿ç”¨å…¶å®ƒæ–¹å¼åšç¬¬äºŒçº§è´Ÿè½½å‡è¡¡ã€‚DNS è´Ÿè½½å‡è¡¡å±äºä¸ƒå±‚è´Ÿè½½å‡è¡¡ã€‚

DNS å³ **åŸŸåè§£ææœåŠ¡**ï¼Œæ˜¯ OSI ç¬¬ä¸ƒå±‚ç½‘ç»œåè®®ã€‚DNS è¢«è®¾è®¡ä¸ºä¸€ä¸ªæ ‘å½¢ç»“æ„çš„åˆ†å¸ƒå¼åº”ç”¨ï¼Œè‡ªä¸Šè€Œä¸‹ä¾æ¬¡ä¸ºï¼šæ ¹åŸŸåæœåŠ¡å™¨ï¼Œä¸€çº§åŸŸåæœåŠ¡å™¨ï¼ŒäºŒçº§åŸŸåæœåŠ¡å™¨ï¼Œ... ï¼Œæœ¬åœ°åŸŸåæœåŠ¡å™¨ã€‚æ˜¾ç„¶ï¼Œå¦‚æœæ‰€æœ‰æ•°æ®éƒ½å­˜å‚¨åœ¨æ ¹åŸŸåæœåŠ¡å™¨ï¼Œé‚£ä¹ˆ DNS æŸ¥è¯¢çš„è´Ÿè½½å’Œå¼€é”€ä¼šéå¸¸åºå¤§ã€‚

å› æ­¤ï¼ŒDNS æŸ¥è¯¢ç›¸å¯¹äº DNS å±‚çº§ç»“æ„ï¼Œæ˜¯ä¸€ä¸ªé€†å‘çš„é€’å½’æµç¨‹ï¼ŒDNS å®¢æˆ·ç«¯ä¾æ¬¡è¯·æ±‚æœ¬åœ° DNS æœåŠ¡å™¨ï¼Œä¸Šä¸€çº§ DNS æœåŠ¡å™¨ï¼Œä¸Šä¸Šä¸€çº§ DNS æœåŠ¡å™¨ï¼Œ... ï¼Œæ ¹ DNS æœåŠ¡å™¨ï¼ˆåˆå«æƒå¨ DNS æœåŠ¡å™¨ï¼‰ï¼Œä¸€æ—¦å‘½ä¸­ï¼Œç«‹å³è¿”å›ã€‚ä¸ºäº†å‡å°‘æŸ¥è¯¢æ¬¡æ•°ï¼Œæ¯ä¸€çº§ DNS æœåŠ¡å™¨éƒ½ä¼šè®¾ç½® DNS æŸ¥è¯¢ç¼“å­˜ã€‚

DNS è´Ÿè½½å‡è¡¡çš„å·¥ä½œåŸç†å°±æ˜¯ï¼š**åŸºäº DNS æŸ¥è¯¢ç¼“å­˜ï¼ŒæŒ‰ç…§è´Ÿè½½æƒ…å†µè¿”å›ä¸åŒæœåŠ¡å™¨çš„ IP åœ°å€**ã€‚

![img](https://raw.githubusercontent.com/dunwu/images/dev/snap/20210117220007.png)

DNS é‡å®šå‘çš„ **ä¼˜ç‚¹**ï¼š

- **ä½¿ç”¨ç®€å•**ï¼šè´Ÿè½½å‡è¡¡å·¥ä½œï¼Œäº¤ç»™ DNS æœåŠ¡å™¨å¤„ç†ï¼Œçœæ‰äº†è´Ÿè½½å‡è¡¡æœåŠ¡å™¨ç»´æŠ¤çš„éº»çƒ¦
- **æé«˜æ€§èƒ½**ï¼šå¯ä»¥æ”¯æŒåŸºäºåœ°å€çš„åŸŸåè§£æï¼Œè§£ææˆè·ç¦»ç”¨æˆ·æœ€è¿‘çš„æœåŠ¡å™¨åœ°å€ï¼ˆç±»ä¼¼ CDN çš„åŸç†ï¼‰ï¼Œå¯ä»¥åŠ å¿«è®¿é—®é€Ÿåº¦ï¼Œæ”¹å–„æ€§èƒ½ï¼›

DNS é‡å®šå‘çš„ **ç¼ºç‚¹**ï¼š

- **å¯ç”¨æ€§å·®**ï¼šDNS è§£ææ˜¯å¤šçº§è§£æï¼Œæ–°å¢/ä¿®æ”¹ DNS åï¼Œè§£ææ—¶é—´è¾ƒé•¿ï¼›è§£æè¿‡ç¨‹ä¸­ï¼Œç”¨æˆ·è®¿é—®ç½‘ç«™å°†å¤±è´¥ï¼›
- **æ‰©å±•æ€§ä½**ï¼šDNS è´Ÿè½½å‡è¡¡çš„æ§åˆ¶æƒåœ¨åŸŸåå•†é‚£é‡Œï¼Œæ— æ³•å¯¹å…¶åšæ›´å¤šçš„æ”¹å–„å’Œæ‰©å±•ï¼›
- **ç»´æŠ¤æ€§å·®**ï¼šä¹Ÿä¸èƒ½åæ˜ æœåŠ¡å™¨çš„å½“å‰è¿è¡ŒçŠ¶æ€ï¼›æ”¯æŒçš„ç®—æ³•å°‘ï¼›ä¸èƒ½åŒºåˆ†æœåŠ¡å™¨çš„å·®å¼‚ï¼ˆä¸èƒ½æ ¹æ®ç³»ç»Ÿä¸æœåŠ¡çš„çŠ¶æ€æ¥åˆ¤æ–­è´Ÿè½½ï¼‰

#### HTTP è´Ÿè½½å‡è¡¡

**HTTP è´Ÿè½½å‡è¡¡æ˜¯åŸºäº HTTP é‡å®šå‘å®ç°çš„**ã€‚HTTP è´Ÿè½½å‡è¡¡å±äºä¸ƒå±‚è´Ÿè½½å‡è¡¡ã€‚

HTTP é‡å®šå‘åŸç†æ˜¯ï¼š**æ ¹æ®ç”¨æˆ·çš„ HTTP è¯·æ±‚è®¡ç®—å‡ºä¸€ä¸ªçœŸå®çš„æœåŠ¡å™¨åœ°å€ï¼Œå°†è¯¥æœåŠ¡å™¨åœ°å€å†™å…¥ HTTP é‡å®šå‘å“åº”ä¸­ï¼Œè¿”å›ç»™æµè§ˆå™¨ï¼Œç”±æµè§ˆå™¨é‡æ–°è¿›è¡Œè®¿é—®**ã€‚

![img](https://raw.githubusercontent.com/dunwu/images/dev/snap/20210117220310.png)

HTTP é‡å®šå‘çš„ **ä¼˜ç‚¹**ï¼š**æ–¹æ¡ˆç®€å•**ã€‚

HTTP é‡å®šå‘çš„ **ç¼ºç‚¹**ï¼š

- **æ€§èƒ½è¾ƒå·®**ï¼šæ¯æ¬¡è®¿é—®éœ€è¦ä¸¤æ¬¡è¯·æ±‚æœåŠ¡å™¨ï¼Œå¢åŠ äº†è®¿é—®çš„å»¶è¿Ÿã€‚
- **é™ä½æœç´¢æ’å**ï¼šä½¿ç”¨é‡å®šå‘åï¼Œæœç´¢å¼•æ“ä¼šè§†ä¸º SEO ä½œå¼Šã€‚
- å¦‚æœè´Ÿè½½å‡è¡¡å™¨å®•æœºï¼Œå°±æ— æ³•è®¿é—®è¯¥ç«™ç‚¹ã€‚

ç”±äºå…¶ç¼ºç‚¹æ¯”è¾ƒæ˜æ˜¾ï¼Œæ‰€ä»¥è¿™ç§è´Ÿè½½å‡è¡¡ç­–ç•¥å®é™…åº”ç”¨è¾ƒå°‘ã€‚

#### åå‘ä»£ç†è´Ÿè½½å‡è¡¡

åå‘ä»£ç†ï¼ˆReverse Proxyï¼‰æ–¹å¼æ˜¯æŒ‡ä»¥ **ä»£ç†æœåŠ¡å™¨** æ¥æ¥å—ç½‘ç»œè¯·æ±‚ï¼Œç„¶å **å°†è¯·æ±‚è½¬å‘ç»™å†…ç½‘ä¸­çš„æœåŠ¡å™¨**ï¼Œå¹¶å°†ä»å†…ç½‘ä¸­çš„æœåŠ¡å™¨ä¸Šå¾—åˆ°çš„ç»“æœè¿”å›ç»™ç½‘ç»œè¯·æ±‚çš„å®¢æˆ·ç«¯ã€‚åå‘ä»£ç†è´Ÿè½½å‡è¡¡å±äºä¸ƒå±‚è´Ÿè½½å‡è¡¡ã€‚

åå‘ä»£ç†æœåŠ¡çš„ä¸»æµäº§å“ï¼š**Nginx**ã€**Apache**ã€‚

æ­£å‘ä»£ç†ä¸åå‘ä»£ç†æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

- æ­£å‘ä»£ç†ï¼šå‘ç”Ÿåœ¨ **å®¢æˆ·ç«¯**ï¼Œæ˜¯ç”±ç”¨æˆ·ä¸»åŠ¨å‘èµ·çš„ã€‚ç¿»å¢™è½¯ä»¶å°±æ˜¯å…¸å‹çš„æ­£å‘ä»£ç†ï¼Œå®¢æˆ·ç«¯é€šè¿‡ä¸»åŠ¨è®¿é—®ä»£ç†æœåŠ¡å™¨ï¼Œè®©ä»£ç†æœåŠ¡å™¨è·å¾—éœ€è¦çš„å¤–ç½‘æ•°æ®ï¼Œç„¶åè½¬å‘å›å®¢æˆ·ç«¯ã€‚
- åå‘ä»£ç†ï¼šå‘ç”Ÿåœ¨ **æœåŠ¡ç«¯**ï¼Œç”¨æˆ·ä¸çŸ¥é“ä»£ç†çš„å­˜åœ¨ã€‚

![img](https://raw.githubusercontent.com/dunwu/images/dev/snap/20210117222209.png)

åå‘ä»£ç†æ˜¯å¦‚ä½•å®ç°è´Ÿè½½å‡è¡¡çš„å‘¢ï¼Ÿä»¥ Nginx ä¸ºä¾‹ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

![img](https://raw.githubusercontent.com/dunwu/images/dev/cs/web/nginx/nginx-load-balance.png)

é¦–å…ˆï¼Œåœ¨ä»£ç†æœåŠ¡å™¨ä¸Šè®¾å®šå¥½è´Ÿè½½å‡è¡¡è§„åˆ™ã€‚ç„¶åï¼Œå½“æ”¶åˆ°å®¢æˆ·ç«¯è¯·æ±‚ï¼Œåå‘ä»£ç†æœåŠ¡å™¨æ‹¦æˆªæŒ‡å®šçš„åŸŸåæˆ– IP è¯·æ±‚ï¼Œæ ¹æ®è´Ÿè½½å‡è¡¡ç®—æ³•ï¼Œå°†è¯·æ±‚åˆ†å‘åˆ°å€™é€‰æœåŠ¡å™¨ä¸Šã€‚å…¶æ¬¡ï¼Œå¦‚æœæŸå°å€™é€‰æœåŠ¡å™¨å®•æœºï¼Œåå‘ä»£ç†æœåŠ¡å™¨ä¼šæœ‰å®¹é”™å¤„ç†ï¼Œæ¯”å¦‚åˆ†å‘è¯·æ±‚å¤±è´¥ 3 æ¬¡ä»¥ä¸Šï¼Œå°†è¯·æ±‚åˆ†å‘åˆ°å…¶ä»–å€™é€‰æœåŠ¡å™¨ä¸Šã€‚

åå‘ä»£ç†çš„ **ä¼˜ç‚¹**ï¼š

- **å¤šç§è´Ÿè½½å‡è¡¡ç®—æ³•**ï¼šæ”¯æŒå¤šç§è´Ÿè½½å‡è¡¡ç®—æ³•ï¼Œä»¥åº”å¯¹ä¸åŒçš„åœºæ™¯éœ€æ±‚ã€‚
- **å¯ä»¥ç›‘æ§æœåŠ¡å™¨**ï¼šåŸºäº HTTP åè®®ï¼Œå¯ä»¥ç›‘æ§è½¬å‘æœåŠ¡å™¨çš„çŠ¶æ€ï¼Œå¦‚ï¼šç³»ç»Ÿè´Ÿè½½ã€å“åº”æ—¶é—´ã€æ˜¯å¦å¯ç”¨ã€è¿æ¥æ•°ã€æµé‡ç­‰ï¼Œä»è€Œæ ¹æ®è¿™äº›æ•°æ®è°ƒæ•´è´Ÿè½½å‡è¡¡çš„ç­–ç•¥ã€‚

åå‘ä»£ç†çš„ **ç¼ºç‚¹**ï¼š

- **é¢å¤–çš„è½¬å‘å¼€é”€**ï¼šåå‘ä»£ç†çš„è½¬å‘æ“ä½œæœ¬èº«æ˜¯æœ‰æ€§èƒ½å¼€é”€çš„ï¼Œå¯èƒ½ä¼šåŒ…æ‹¬åˆ›å»ºè¿æ¥ï¼Œç­‰å¾…è¿æ¥å“åº”ï¼Œåˆ†æå“åº”ç»“æœç­‰æ“ä½œã€‚

- **å¢åŠ ç³»ç»Ÿå¤æ‚åº¦**ï¼šåå‘ä»£ç†å¸¸ç”¨äºåšåˆ†å¸ƒå¼åº”ç”¨çš„æ°´å¹³æ‰©å±•ï¼Œä½†åå‘ä»£ç†æœåŠ¡å­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼Œä¸ºäº†è§£å†³ä»¥ä¸‹é—®é¢˜ä¼šç»™ç³»ç»Ÿæ•´ä½“å¢åŠ é¢å¤–çš„å¤æ‚åº¦å’Œè¿ç»´æˆæœ¬ï¼š

  - åå‘ä»£ç†æœåŠ¡å¦‚æœè‡ªèº«å®•æœºï¼Œå°±æ— æ³•è®¿é—®ç«™ç‚¹ï¼Œæ‰€ä»¥éœ€è¦æœ‰ **é«˜å¯ç”¨** æ–¹æ¡ˆï¼Œå¸¸è§çš„æ–¹æ¡ˆæœ‰ï¼šä¸»å¤‡æ¨¡å¼ï¼ˆä¸€ä¸»ä¸€å¤‡ï¼‰ã€åŒä¸»æ¨¡å¼ï¼ˆäº’ä¸ºä¸»å¤‡ï¼‰ã€‚
  - åå‘ä»£ç†æœåŠ¡è‡ªèº«ä¹Ÿå­˜åœ¨æ€§èƒ½ç“¶é¢ˆï¼Œéšç€éœ€è¦è½¬å‘çš„è¯·æ±‚é‡ä¸æ–­æ”€å‡ï¼Œéœ€è¦æœ‰ **å¯æ‰©å±•** æ–¹æ¡ˆã€‚

#### IP è´Ÿè½½å‡è¡¡

IP è´Ÿè½½å‡è¡¡æ˜¯åœ¨ç½‘ç»œå±‚é€šè¿‡ä¿®æ”¹è¯·æ±‚ç›®çš„åœ°å€è¿›è¡Œè´Ÿè½½å‡è¡¡ã€‚

![img](https://raw.githubusercontent.com/dunwu/images/dev/snap/20210119000529.png)

å¦‚ä¸Šå›¾æ‰€ç¤ºï¼ŒIP å‡è¡¡å¤„ç†æµç¨‹å¤§è‡´ä¸ºï¼š

1. å®¢æˆ·ç«¯è¯·æ±‚ 192.168.137.10ï¼Œç”±è´Ÿè½½å‡è¡¡æœåŠ¡å™¨æ¥æ”¶åˆ°æŠ¥æ–‡ã€‚
2. è´Ÿè½½å‡è¡¡æœåŠ¡å™¨æ ¹æ®ç®—æ³•é€‰å‡ºä¸€ä¸ªæœåŠ¡èŠ‚ç‚¹ 192.168.0.1ï¼Œç„¶åå°†æŠ¥æ–‡è¯·æ±‚åœ°å€æ”¹ä¸ºè¯¥èŠ‚ç‚¹çš„ IPã€‚
3. çœŸå®æœåŠ¡èŠ‚ç‚¹æ”¶åˆ°è¯·æ±‚æŠ¥æ–‡ï¼Œå¤„ç†åï¼Œè¿”å›å“åº”æ•°æ®åˆ°è´Ÿè½½å‡è¡¡æœåŠ¡å™¨ã€‚
4. è´Ÿè½½å‡è¡¡æœåŠ¡å™¨å°†å“åº”æ•°æ®çš„æºåœ°å€æ”¹è´Ÿè½½å‡è¡¡æœåŠ¡å™¨åœ°å€ï¼Œè¿”å›ç»™å®¢æˆ·ç«¯ã€‚

IP è´Ÿè½½å‡è¡¡åœ¨å†…æ ¸è¿›ç¨‹å®Œæˆæ•°æ®åˆ†å‘ï¼Œè¾ƒåå‘ä»£ç†è´Ÿè½½å‡è¡¡æœ‰æ›´å¥½çš„ä»å¤„ç†æ€§èƒ½ã€‚ä½†æ˜¯ï¼Œç”±äºæ‰€æœ‰è¯·æ±‚å“åº”éƒ½è¦ç»è¿‡è´Ÿè½½å‡è¡¡æœåŠ¡å™¨ï¼Œé›†ç¾¤çš„ååé‡å—åˆ¶äºè´Ÿè½½å‡è¡¡æœåŠ¡å™¨çš„å¸¦å®½ã€‚

#### æ•°æ®é“¾è·¯å±‚è´Ÿè½½å‡è¡¡

æ•°æ®é“¾è·¯å±‚è´Ÿè½½å‡è¡¡æ˜¯æŒ‡åœ¨é€šä¿¡åè®®çš„æ•°æ®é“¾è·¯å±‚ä¿®æ”¹ mac åœ°å€è¿›è¡Œè´Ÿè½½å‡è¡¡ã€‚

![img](https://raw.githubusercontent.com/dunwu/images/dev/snap/20210117222127.png)

åœ¨ Linux å¹³å°ä¸Šæœ€å¥½çš„é“¾è·¯å±‚è´Ÿè½½å‡è¡¡å¼€æºäº§å“æ˜¯ LVS (Linux Virtual Server)ã€‚

LVS æ˜¯åŸºäº Linux å†…æ ¸ä¸­ netfilter æ¡†æ¶å®ç°çš„è´Ÿè½½å‡è¡¡ç³»ç»Ÿã€‚netfilter æ˜¯å†…æ ¸æ€çš„ Linux é˜²ç«å¢™æœºåˆ¶ï¼Œå¯ä»¥åœ¨æ•°æ®åŒ…æµç»è¿‡ç¨‹ä¸­ï¼Œæ ¹æ®è§„åˆ™è®¾ç½®è‹¥å¹²ä¸ªå…³å¡ï¼ˆhook å‡½æ•°ï¼‰æ¥æ‰§è¡Œç›¸å…³çš„æ“ä½œã€‚

LVS çš„å·¥ä½œæµç¨‹å¤§è‡´å¦‚ä¸‹ï¼š

- å½“ç”¨æˆ·è®¿é—® www.sina.com.cn æ—¶ï¼Œç”¨æˆ·æ•°æ®é€šè¿‡å±‚å±‚ç½‘ç»œï¼Œæœ€åé€šè¿‡äº¤æ¢æœºè¿›å…¥ LVS æœåŠ¡å™¨ç½‘å¡ï¼Œå¹¶è¿›å…¥å†…æ ¸ç½‘ç»œå±‚ã€‚
- è¿›å…¥ PREROUTING åç»è¿‡è·¯ç”±æŸ¥æ‰¾ï¼Œç¡®å®šè®¿é—®çš„ç›®çš„ VIP æ˜¯æœ¬æœº IP åœ°å€ï¼Œæ‰€ä»¥æ•°æ®åŒ…è¿›å…¥åˆ° INPUT é“¾ä¸Š
- IPVS æ˜¯å·¥ä½œåœ¨ INPUT é“¾ä¸Šï¼Œä¼šæ ¹æ®è®¿é—®çš„ `vip+port` åˆ¤æ–­è¯·æ±‚æ˜¯å¦ IPVS æœåŠ¡ï¼Œå¦‚æœæ˜¯åˆ™è°ƒç”¨æ³¨å†Œçš„ IPVS HOOK å‡½æ•°ï¼Œè¿›è¡Œ IPVS ç›¸å…³ä¸»æµç¨‹ï¼Œå¼ºè¡Œä¿®æ”¹æ•°æ®åŒ…çš„ç›¸å…³æ•°æ®ï¼Œå¹¶å°†æ•°æ®åŒ…å‘å¾€ POSTROUTING é“¾ä¸Šã€‚
- POSTROUTING ä¸Šæ”¶åˆ°æ•°æ®åŒ…åï¼Œæ ¹æ®ç›®æ ‡ IP åœ°å€ï¼ˆåç«¯æœåŠ¡å™¨ï¼‰ï¼Œé€šè¿‡è·¯ç”±é€‰è·¯ï¼Œå°†æ•°æ®åŒ…æœ€ç»ˆå‘å¾€åç«¯çš„æœåŠ¡å™¨ä¸Šã€‚

å¼€æº LVS ç‰ˆæœ¬æœ‰ 3 ç§å·¥ä½œæ¨¡å¼ï¼Œæ¯ç§æ¨¡å¼å·¥ä½œåŸç†æˆªç„¶ä¸åŒï¼Œè¯´å„ç§æ¨¡å¼éƒ½æœ‰è‡ªå·±çš„ä¼˜ç¼ºç‚¹ï¼Œåˆ†åˆ«é€‚åˆä¸åŒçš„åº”ç”¨åœºæ™¯ï¼Œä¸è¿‡æœ€ç»ˆæœ¬è´¨çš„åŠŸèƒ½éƒ½æ˜¯èƒ½å®ç°å‡è¡¡çš„æµé‡è°ƒåº¦å’Œè‰¯å¥½çš„æ‰©å±•æ€§ã€‚ä¸»è¦åŒ…æ‹¬ä¸‰ç§æ¨¡å¼ï¼šDR æ¨¡å¼ã€NAT æ¨¡å¼ã€Tunnel æ¨¡å¼ã€‚

## 3. è´Ÿè½½å‡è¡¡ç®—æ³•

è´Ÿè½½å‡è¡¡å™¨çš„å®ç°å¯ä»¥åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼š

- æ ¹æ®è´Ÿè½½å‡è¡¡ç®—æ³•åœ¨å€™é€‰æœåŠ¡å™¨åˆ—è¡¨é€‰å‡ºä¸€ä¸ªæœåŠ¡å™¨ï¼›
- å°†è¯·æ±‚æ•°æ®å‘é€åˆ°è¯¥æœåŠ¡å™¨ä¸Šã€‚

è´Ÿè½½å‡è¡¡ç®—æ³•æ˜¯è´Ÿè½½å‡è¡¡æœåŠ¡æ ¸å¿ƒä¸­çš„æ ¸å¿ƒã€‚è´Ÿè½½å‡è¡¡äº§å“å¤šç§å¤šæ ·ï¼Œä½†æ˜¯å„ç§è´Ÿè½½å‡è¡¡ç®—æ³•åŸç†æ˜¯å…±æ€§çš„ã€‚

è´Ÿè½½å‡è¡¡ç®—æ³•æœ‰å¾ˆå¤šç§ï¼Œåˆ†åˆ«é€‚ç”¨äºä¸åŒçš„åº”ç”¨åœºæ™¯ï¼Œæœ¬æ–‡ä»…ä»‹ç»æœ€ä¸ºå¸¸è§çš„è´Ÿè½½å‡è¡¡ç®—æ³•çš„ç‰¹æ€§åŠåŸç†ï¼šè½®è¯¢ã€éšæœºã€æœ€å°æ´»è·ƒæ•°ã€æºåœ°å€å“ˆå¸Œã€ä¸€è‡´æ€§å“ˆå¸Œã€‚

> æ³¨ï¼šè´Ÿè½½å‡è¡¡ç®—æ³•çš„å®ç°ï¼Œæ¨èé˜…è¯» [Dubbo å®˜æ–¹è´Ÿè½½å‡è¡¡ç®—æ³•è¯´æ˜](https://dubbo.apache.org/zh/docs/v2.7/dev/source/loadbalance/) ï¼Œæºç è®²è§£éå¸¸è¯¦ç»†ï¼Œéå¸¸å€¼å¾—å€Ÿé‰´ã€‚
>
> ä¸‹æ–‡ä¸­çš„å„ç§ç®—æ³•çš„å¯æ‰§è¡Œç¤ºä¾‹å·²å½’æ¡£åœ¨ Github ä»“åº“ï¼šhttps://github.com/dunwu/java-tutorial/tree/master/codes/java-distributed/java-load-balanceï¼Œå¯ä»¥é€šè¿‡æ‰§è¡Œ io.github.dunwu.javatech.LoadBalanceDemo æŸ¥çœ‹å„ç®—æ³•æ‰§è¡Œæ•ˆæœã€‚

### 3.1. éšæœº

#### éšæœºç®—æ³•

**`éšæœºï¼ˆRandomï¼‰`** ç®—æ³• **å°†è¯·æ±‚éšæœºåˆ†å‘åˆ°å€™é€‰æœåŠ¡å™¨**ã€‚

éšæœºç®—æ³• **é€‚åˆæœåŠ¡å™¨ç¡¬ä»¶ç›¸åŒçš„åœºæ™¯**ã€‚å­¦ä¹ è¿‡æ¦‚ç‡è®ºçš„éƒ½çŸ¥é“ï¼Œè°ƒç”¨é‡è¾ƒå°çš„æ—¶å€™ï¼Œå¯èƒ½è´Ÿè½½å¹¶ä¸å‡åŒ€ï¼Œ**è°ƒç”¨é‡è¶Šå¤§ï¼Œè´Ÿè½½è¶Šå‡è¡¡**ã€‚

![](https://raw.githubusercontent.com/dunwu/images/dev/snap/20210415165323.png)

ã€ç¤ºä¾‹ã€‘éšæœºç®—æ³•å®ç°ç¤ºä¾‹

è´Ÿè½½å‡è¡¡æ¥å£

```java
public interface LoadBalance<N extends Node> {

    N select(List<N> nodes, String ip);

}
```

è´Ÿè½½å‡è¡¡æŠ½è±¡ç±»

```java
public abstract class BaseLoadBalance<N extends Node> implements LoadBalance<N> {

    @Override
    public N select(List<N> nodes, String ip) {
        if (CollectionUtil.isEmpty(nodes)) {
            return null;
        }

        // å¦‚æœ nodes åˆ—è¡¨ä¸­ä»…æœ‰ä¸€ä¸ª nodeï¼Œç›´æ¥è¿”å›å³å¯ï¼Œæ— éœ€è¿›è¡Œè´Ÿè½½å‡è¡¡
        if (nodes.size() == 1) {
            return nodes.get(0);
        }

        return doSelect(nodes, ip);
    }

    protected abstract N doSelect(List<N> nodes, String ip);

}
```

æœåŠ¡å™¨èŠ‚ç‚¹ç±»

```java
public class Node implements Comparable<Node> {

    protected String url;

    protected Integer weight;

    protected Integer active;

    // ...
}
```

éšæœºç®—æ³•å®ç°

```java
public class RandomLoadBalance<N extends Node> extends BaseLoadBalance<N> implements LoadBalance<N> {

    private final Random random = new Random();

    @Override
    protected N doSelect(List<N> nodes, String ip) {
        // åœ¨åˆ—è¡¨ä¸­éšæœºé€‰å–ä¸€ä¸ªèŠ‚ç‚¹
        int index = random.nextInt(nodes.size());
        return nodes.get(index);
    }

}
```

#### åŠ æƒéšæœºç®—æ³•

**`åŠ æƒéšæœºï¼ˆWeighted Randomï¼‰`** ç®—æ³•åœ¨éšæœºç®—æ³•çš„åŸºç¡€ä¸Šï¼ŒæŒ‰ç…§æ¦‚ç‡è°ƒæ•´æƒé‡ï¼Œè¿›è¡Œè´Ÿè½½åˆ†é…ã€‚

ã€ç¤ºä¾‹ã€‘åŠ æƒéšæœºç®—æ³•å®ç°ç¤ºä¾‹

```java
public class WeightRandomLoadBalance<N extends Node> extends BaseLoadBalance<N> implements LoadBalance<N> {

    private final Random random = ThreadLocalRandom.current();

    @Override
    protected N doSelect(List<N> nodes, String ip) {

        int length = nodes.size();
        AtomicInteger totalWeight = new AtomicInteger(0);
        for (N node : nodes) {
            Integer weight = node.getWeight();
            totalWeight.getAndAdd(weight);
        }

        if (totalWeight.get() > 0) {
            int offset = random.nextInt(totalWeight.get());
            for (N node : nodes) {
                // è®©éšæœºå€¼ offset å‡å»æƒé‡å€¼
                offset -= node.getWeight();
                if (offset < 0) {
                    // è¿”å›ç›¸åº”çš„ Node
                    return node;
                }
            }
        }

        // ç›´æ¥éšæœºè¿”å›ä¸€ä¸ª
        return nodes.get(random.nextInt(length));
    }

}
```

### 3.2. è½®è¯¢

#### è½®è¯¢ç®—æ³•

**`è½®è¯¢ï¼ˆRound Robinï¼‰`** ç®—æ³•çš„ç­–ç•¥æ˜¯ï¼š**å°†è¯·æ±‚ä¾æ¬¡åˆ†å‘åˆ°å€™é€‰æœåŠ¡å™¨**ã€‚

å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œè´Ÿè½½å‡è¡¡å™¨æ”¶åˆ°æ¥è‡ªå®¢æˆ·ç«¯çš„ 6 ä¸ªè¯·æ±‚ï¼Œ(1, 3, 5) çš„è¯·æ±‚ä¼šè¢«å‘é€åˆ°æœåŠ¡å™¨ 1ï¼Œ(2, 4, 6) çš„è¯·æ±‚ä¼šè¢«å‘é€åˆ°æœåŠ¡å™¨ 2ã€‚

![](https://raw.githubusercontent.com/dunwu/images/dev/snap/20210415164758.png)

è¯¥ç®—æ³•é€‚åˆåœºæ™¯ï¼šå„æœåŠ¡å™¨å¤„ç†èƒ½åŠ›ç›¸è¿‘ï¼Œä¸”æ¯ä¸ªäº‹åŠ¡å·¥ä½œé‡å·®å¼‚ä¸å¤§ã€‚å¦‚æœå­˜åœ¨è¾ƒå¤§å·®å¼‚ï¼Œé‚£ä¹ˆå¤„ç†è¾ƒæ…¢çš„æœåŠ¡å™¨å°±å¯èƒ½ä¼šç§¯å‹è¯·æ±‚ï¼Œæœ€ç»ˆæ— æ³•æ‰¿æ‹…è¿‡å¤§çš„è´Ÿè½½ã€‚

![](https://raw.githubusercontent.com/dunwu/images/dev/snap/20210415165041.png)

ã€ç¤ºä¾‹ã€‘è½®è¯¢ç®—æ³•ç¤ºä¾‹

è½®è¯¢è´Ÿè½½å‡è¡¡ç®—æ³•å®ç°

```java
public class RoundRobinLoadBalance<N extends Node> extends BaseLoadBalance<N> implements LoadBalance<N> {

    private final AtomicInteger position = new AtomicInteger(0);

    @Override
    protected N doSelect(List<N> nodes, String ip) {
        int length = nodes.size();
        // å¦‚æœä½ç½®å€¼å·²ç»ç­‰äºèŠ‚ç‚¹æ•°ï¼Œé‡ç½®ä¸º 0
        position.compareAndSet(length, 0);
        N node = nodes.get(position.get());
        position.getAndIncrement();
        return node;
    }

}
```

#### åŠ æƒè½®è¯¢ç®—æ³•

**`åŠ æƒè½®è¯¢ï¼ˆWeighted Round Robbinï¼‰`** ç®—æ³•åœ¨è½®è¯¢ç®—æ³•çš„åŸºç¡€ä¸Šï¼Œå¢åŠ äº†æƒé‡å±æ€§æ¥è°ƒèŠ‚è½¬å‘æœåŠ¡å™¨çš„è¯·æ±‚æ•°ç›®ã€‚æ€§èƒ½é«˜ã€å¤„ç†é€Ÿåº¦å¿«çš„èŠ‚ç‚¹åº”è¯¥è®¾ç½®æ›´é«˜çš„æƒé‡ï¼Œä½¿å¾—åˆ†å‘æ—¶ä¼˜å…ˆå°†è¯·æ±‚åˆ†å‘åˆ°æƒé‡è¾ƒé«˜çš„èŠ‚ç‚¹ä¸Šã€‚

å¦‚ä¸‹å›¾æ‰€ç¤ºï¼ŒæœåŠ¡å™¨ A è®¾ç½®æƒé‡ä¸º 5ï¼ŒæœåŠ¡å™¨ B è®¾ç½®æƒé‡ä¸º 1ï¼Œè´Ÿè½½å‡è¡¡å™¨æ”¶åˆ°æ¥è‡ªå®¢æˆ·ç«¯çš„ 6 ä¸ªè¯·æ±‚ï¼Œé‚£ä¹ˆ (1, 2, 3, 4, 5) è¯·æ±‚ä¼šè¢«å‘é€åˆ°æœåŠ¡å™¨ Aï¼Œ(6) è¯·æ±‚ä¼šè¢«å‘é€åˆ°æœåŠ¡å™¨ Bã€‚

![](https://raw.githubusercontent.com/dunwu/images/dev/snap/20210415165140.png)

ã€ç¤ºä¾‹ã€‘åŠ æƒè½®è¯¢ç®—æ³•å®ç°ç¤ºä¾‹

ä»¥ä¸‹å®ç°åŸºäº Dubbo åŠ æƒè½®è¯¢ç®—æ³•åšäº†ä¸€äº›ç®€åŒ–ã€‚

```java
public class WeightRoundRobinLoadBalance<N extends Node> extends BaseLoadBalance<N> implements LoadBalance<N> {

    /**
     * 60ç§’
     */
    private static final int RECYCLE_PERIOD = 60000;

    /**
     * Node hashcode åˆ° WeightedRoundRobin çš„æ˜ å°„å…³ç³»
     */
    private ConcurrentMap<Integer, WeightedRoundRobin> weightMap = new ConcurrentHashMap<>();

    /**
     * åŸå­æ›´æ–°é”
     */
    private AtomicBoolean updateLock = new AtomicBoolean();

    @Override
    protected N doSelect(List<N> nodes, String ip) {

        int totalWeight = 0;
        long maxCurrent = Long.MIN_VALUE;

        // è·å–å½“å‰æ—¶é—´
        long now = System.currentTimeMillis();
        N selectedNode = null;
        WeightedRoundRobin selectedWRR = null;

        // ä¸‹é¢è¿™ä¸ªå¾ªç¯ä¸»è¦åšäº†è¿™æ ·å‡ ä»¶äº‹æƒ…ï¼š
        //   1. éå† Node åˆ—è¡¨ï¼Œæ£€æµ‹å½“å‰ Node æ˜¯å¦æœ‰ç›¸åº”çš„ WeightedRoundRobinï¼Œæ²¡æœ‰åˆ™åˆ›å»º
        //   2. æ£€æµ‹ Node æƒé‡æ˜¯å¦å‘ç”Ÿäº†å˜åŒ–ï¼Œè‹¥å˜åŒ–äº†ï¼Œåˆ™æ›´æ–° WeightedRoundRobin çš„ weight å­—æ®µ
        //   3. è®© current å­—æ®µåŠ ä¸Šè‡ªèº«æƒé‡ï¼Œç­‰ä»·äº current += weight
        //   4. è®¾ç½® lastUpdate å­—æ®µï¼Œå³ lastUpdate = now
        //   5. å¯»æ‰¾å…·æœ‰æœ€å¤§ current çš„ Nodeï¼Œä»¥åŠ Node å¯¹åº”çš„ WeightedRoundRobinï¼Œ
        //      æš‚å­˜èµ·æ¥ï¼Œç•™ä½œåç”¨
        //   6. è®¡ç®—æƒé‡æ€»å’Œ
        for (N node : nodes) {
            int hashCode = node.hashCode();
            WeightedRoundRobin weightedRoundRobin = weightMap.get(hashCode);
            int weight = node.getWeight();
            if (weight < 0) {
                weight = 0;
            }

            // æ£€æµ‹å½“å‰ Node æ˜¯å¦æœ‰å¯¹åº”çš„ WeightedRoundRobinï¼Œæ²¡æœ‰åˆ™åˆ›å»º
            if (weightedRoundRobin == null) {
                weightedRoundRobin = new WeightedRoundRobin();
                // è®¾ç½® Node æƒé‡
                weightedRoundRobin.setWeight(weight);
                // å­˜å‚¨ url å”¯ä¸€æ ‡è¯† identifyString åˆ° weightedRoundRobin çš„æ˜ å°„å…³ç³»
                weightMap.putIfAbsent(hashCode, weightedRoundRobin);
                weightedRoundRobin = weightMap.get(hashCode);
            }
            // Node æƒé‡ä¸ç­‰äº WeightedRoundRobin ä¸­ä¿å­˜çš„æƒé‡ï¼Œè¯´æ˜æƒé‡å˜åŒ–äº†ï¼Œæ­¤æ—¶è¿›è¡Œæ›´æ–°
            if (weight != weightedRoundRobin.getWeight()) {
                weightedRoundRobin.setWeight(weight);
            }

            // è®© current åŠ ä¸Šè‡ªèº«æƒé‡ï¼Œç­‰ä»·äº current += weight
            long current = weightedRoundRobin.increaseCurrent();
            // è®¾ç½® lastUpdateï¼Œè¡¨ç¤ºè¿‘æœŸæ›´æ–°è¿‡
            weightedRoundRobin.setLastUpdate(now);
            // æ‰¾å‡ºæœ€å¤§çš„ current
            if (current > maxCurrent) {
                maxCurrent = current;
                // å°†å…·æœ‰æœ€å¤§ current æƒé‡çš„ Node èµ‹å€¼ç»™ selectedNode
                selectedNode = node;
                // å°† Node å¯¹åº”çš„ weightedRoundRobin èµ‹å€¼ç»™ selectedWRRï¼Œç•™ä½œåç”¨
                selectedWRR = weightedRoundRobin;
            }

            // è®¡ç®—æƒé‡æ€»å’Œ
            totalWeight += weight;
        }

        // å¯¹ weightMap è¿›è¡Œæ£€æŸ¥ï¼Œè¿‡æ»¤æ‰é•¿æ—¶é—´æœªè¢«æ›´æ–°çš„èŠ‚ç‚¹ã€‚
        // è¯¥èŠ‚ç‚¹å¯èƒ½æŒ‚äº†ï¼Œnodes ä¸­ä¸åŒ…å«è¯¥èŠ‚ç‚¹ï¼Œæ‰€ä»¥è¯¥èŠ‚ç‚¹çš„ lastUpdate é•¿æ—¶é—´æ— æ³•è¢«æ›´æ–°ã€‚
        // è‹¥æœªæ›´æ–°æ—¶é•¿è¶…è¿‡é˜ˆå€¼åï¼Œå°±ä¼šè¢«ç§»é™¤æ‰ï¼Œé»˜è®¤é˜ˆå€¼ä¸º60ç§’ã€‚
        if (!updateLock.get() && nodes.size() != weightMap.size()) {
            if (updateLock.compareAndSet(false, true)) {
                try {
                    // éå†ä¿®æ”¹ï¼Œå³ç§»é™¤è¿‡æœŸè®°å½•
                    weightMap.entrySet().removeIf(item -> now - item.getValue().getLastUpdate() > RECYCLE_PERIOD);
                } finally {
                    updateLock.set(false);
                }
            }
        }

        if (selectedNode != null) {
            // è®© current å‡å»æƒé‡æ€»å’Œï¼Œç­‰ä»·äº current -= totalWeight
            selectedWRR.decreaseCurrent(totalWeight);
            // è¿”å›å…·æœ‰æœ€å¤§ current çš„ Node
            return selectedNode;
        }

        // should not happen here
        return nodes.get(0);
    }

    protected static class WeightedRoundRobin {

        // æœåŠ¡æä¾›è€…æƒé‡
        private int weight;
        // å½“å‰æƒé‡
        private AtomicLong current = new AtomicLong(0);
        // æœ€åä¸€æ¬¡æ›´æ–°æ—¶é—´
        private long lastUpdate;

        public long increaseCurrent() {
            // current = current + weightï¼›
            return current.addAndGet(weight);
        }

        public long decreaseCurrent(int total) {
            // current = current - total;
            return current.addAndGet(-1 * total);
        }

        public int getWeight() {
            return weight;
        }

        public void setWeight(int weight) {
            this.weight = weight;
            // åˆå§‹æƒ…å†µä¸‹ï¼Œcurrent = 0
            current.set(0);
        }

        public AtomicLong getCurrent() {
            return current;
        }

        public void setCurrent(AtomicLong current) {
            this.current = current;
        }

        public long getLastUpdate() {
            return lastUpdate;
        }

        public void setLastUpdate(long lastUpdate) {
            this.lastUpdate = lastUpdate;
        }

    }

}
```

### 3.3. æœ€å°æ´»è·ƒæ•°

**`æœ€å°æ´»è·ƒæ•°ï¼ˆLeast Activeï¼‰`** ç®—æ³• **å°†è¯·æ±‚åˆ†å‘åˆ°è¿æ¥æ•°/è¯·æ±‚æ•°æœ€å°‘çš„å€™é€‰æœåŠ¡å™¨**ï¼ˆç›®å‰å¤„ç†è¯·æ±‚æœ€å°‘çš„æœåŠ¡å™¨ï¼‰ã€‚

- ç‰¹ç‚¹ï¼šæ ¹æ®å€™é€‰æœåŠ¡å™¨å½“å‰çš„è¯·æ±‚è¿æ¥æ•°ï¼ŒåŠ¨æ€åˆ†é…ã€‚
- åœºæ™¯ï¼š**é€‚ç”¨äºå¯¹ç³»ç»Ÿè´Ÿè½½è¾ƒä¸ºæ•æ„Ÿæˆ–è¯·æ±‚è¿æ¥æ—¶é•¿ç›¸å·®è¾ƒå¤§çš„åœºæ™¯**ã€‚

ç”±äºæ¯ä¸ªè¯·æ±‚çš„è¿æ¥æ—¶é•¿ä¸ä¸€æ ·ï¼Œå¦‚æœé‡‡ç”¨ç®€å•çš„è½®å¾ªæˆ–éšæœºç®—æ³•ï¼Œéƒ½å¯èƒ½å‡ºç°**æŸäº›æœåŠ¡å™¨å½“å‰è¿æ¥æ•°è¿‡å¤§ï¼Œè€Œå¦ä¸€äº›æœåŠ¡å™¨çš„è¿æ¥è¿‡å°**çš„æƒ…å†µï¼Œè¿™å°±é€ æˆäº†è´Ÿè½½å¹¶éçœŸæ­£å‡è¡¡ã€‚è™½ç„¶ï¼Œè½®è¯¢æˆ–ç®—æ³•éƒ½å¯ä»¥é€šè¿‡åŠ æƒé‡å±æ€§çš„æ–¹å¼è¿›è¡Œè´Ÿè½½è°ƒæ•´ï¼Œä½†åŠ æƒæ–¹å¼éš¾ä»¥åº”å¯¹åŠ¨æ€å˜åŒ–ã€‚

![](https://raw.githubusercontent.com/dunwu/images/dev/snap/20210415171432.png)

æœ€å°æ´»è·ƒæ•°ç®—æ³•ä¼šè®°å½•å½“å‰æ—¶åˆ»ï¼Œæ¯ä¸ªå€™é€‰èŠ‚ç‚¹æ­£åœ¨å¤„ç†çš„è¿æ¥æ•°ï¼Œç„¶åé€‰æ‹©è¿æ¥æ•°æœ€å°çš„èŠ‚ç‚¹ã€‚è¯¥ç­–ç•¥èƒ½å¤ŸåŠ¨æ€ã€å®æ—¶åœ°ååº”æœåŠ¡å™¨çš„å½“å‰çŠ¶å†µï¼Œè¾ƒä¸ºåˆç†åœ°å°†è´Ÿè´£åˆ†é…å‡åŒ€ï¼Œé€‚ç”¨äºå¯¹å½“å‰ç³»ç»Ÿè´Ÿè½½è¾ƒä¸ºæ•æ„Ÿçš„åœºæ™¯ã€‚

ä¾‹å¦‚ä¸‹å›¾ä¸­ï¼ŒæœåŠ¡å™¨ 1 å½“å‰è¿æ¥æ•°æœ€å°ï¼Œé‚£ä¹ˆæ–°åˆ°æ¥çš„è¯·æ±‚ 6 å°±ä¼šè¢«å‘é€åˆ°æœåŠ¡å™¨ 1 ä¸Šã€‚

![](https://raw.githubusercontent.com/dunwu/images/dev/snap/20210415165935.png)

**åŠ æƒæœ€å°æ´»è·ƒæ•°ï¼ˆWeighted Least Connectionï¼‰**åœ¨æœ€å°æ´»è·ƒæ•°çš„åŸºç¡€ä¸Šï¼Œæ ¹æ®æœåŠ¡å™¨çš„æ€§èƒ½ä¸ºæ¯å°æœåŠ¡å™¨åˆ†é…æƒé‡ï¼Œå†æ ¹æ®æƒé‡è®¡ç®—å‡ºæ¯å°æœåŠ¡å™¨èƒ½å¤„ç†çš„è¿æ¥æ•°ã€‚

æœ€å°æ´»è·ƒæ•°ç®—æ³•å®ç°è¦ç‚¹ï¼šæ´»è·ƒè°ƒç”¨æ•°è¶Šå°ï¼Œè¡¨æ˜è¯¥æœåŠ¡èŠ‚ç‚¹å¤„ç†èƒ½åŠ›è¶Šé«˜ï¼Œå•ä½æ—¶é—´å†…å¯å¤„ç†æ›´å¤šçš„è¯·æ±‚ï¼Œåº”ä¼˜å…ˆå°†è¯·æ±‚åˆ†å‘ç»™è¯¥æœåŠ¡ã€‚åœ¨å…·ä½“å®ç°ä¸­ï¼Œæ¯ä¸ªæœåŠ¡èŠ‚ç‚¹å¯¹åº”ä¸€ä¸ªæ´»è·ƒæ•° activeã€‚åˆå§‹æƒ…å†µä¸‹ï¼Œæ‰€æœ‰æœåŠ¡æä¾›è€…æ´»è·ƒæ•°å‡ä¸º 0ã€‚æ¯æ”¶åˆ°ä¸€ä¸ªè¯·æ±‚ï¼Œæ´»è·ƒæ•°åŠ  1ï¼Œå®Œæˆè¯·æ±‚ååˆ™å°†æ´»è·ƒæ•°å‡ 1ã€‚åœ¨æœåŠ¡è¿è¡Œä¸€æ®µæ—¶é—´åï¼Œæ€§èƒ½å¥½çš„æœåŠ¡æä¾›è€…å¤„ç†è¯·æ±‚çš„é€Ÿåº¦æ›´å¿«ï¼Œå› æ­¤æ´»è·ƒæ•°ä¸‹é™çš„ä¹Ÿè¶Šå¿«ï¼Œæ­¤æ—¶è¿™æ ·çš„æœåŠ¡æä¾›è€…èƒ½å¤Ÿä¼˜å…ˆè·å–åˆ°æ–°çš„æœåŠ¡è¯·æ±‚ã€è¿™å°±æ˜¯æœ€å°æ´»è·ƒæ•°è´Ÿè½½å‡è¡¡ç®—æ³•çš„åŸºæœ¬æ€æƒ³ã€‚

ã€ç¤ºä¾‹ã€‘æœ€å°æ´»è·ƒæ•°ç®—æ³•å®ç°

ä»¥ä¸‹å®ç°åŸºäº Dubbo æœ€å°æ´»è·ƒæ•°è´Ÿè½½å‡è¡¡ç®—æ³•åšäº†äº›è®¸æ”¹åŠ¨ã€‚

```java
public class LeastActiveLoadBalance<N extends Node> extends BaseLoadBalance<N> implements LoadBalance<N> {

    private final Random random = new Random();

    @Override
    protected N doSelect(List<N> nodes, String ip) {
        int length = nodes.size();
        // æœ€å°çš„æ´»è·ƒæ•°
        int leastActive = -1;
        // å…·æœ‰ç›¸åŒâ€œæœ€å°æ´»è·ƒæ•°â€çš„æœåŠ¡è€…æä¾›è€…ï¼ˆä»¥ä¸‹ç”¨ Node ä»£ç§°ï¼‰æ•°é‡
        int leastCount = 0;
        // leastIndexs ç”¨äºè®°å½•å…·æœ‰ç›¸åŒâ€œæœ€å°æ´»è·ƒæ•°â€çš„ Node åœ¨ nodes åˆ—è¡¨ä¸­çš„ä¸‹æ ‡ä¿¡æ¯
        int[] leastIndexs = new int[length];
        int totalWeight = 0;
        // ç¬¬ä¸€ä¸ªæœ€å°æ´»è·ƒæ•°çš„ Node æƒé‡å€¼ï¼Œç”¨äºä¸å…¶ä»–å…·æœ‰ç›¸åŒæœ€å°æ´»è·ƒæ•°çš„ Node çš„æƒé‡è¿›è¡Œå¯¹æ¯”ï¼Œ
        // ä»¥æ£€æµ‹æ˜¯å¦â€œæ‰€æœ‰å…·æœ‰ç›¸åŒæœ€å°æ´»è·ƒæ•°çš„ Node çš„æƒé‡â€å‡ç›¸ç­‰
        int firstWeight = 0;
        boolean sameWeight = true;

        // éå† nodes åˆ—è¡¨
        for (int i = 0; i < length; i++) {
            N node = nodes.get(i);
            // å‘ç°æ›´å°çš„æ´»è·ƒæ•°ï¼Œé‡æ–°å¼€å§‹
            if (leastActive == -1 || node.getActive() < leastActive) {
                // ä½¿ç”¨å½“å‰æ´»è·ƒæ•°æ›´æ–°æœ€å°æ´»è·ƒæ•° leastActive
                leastActive = node.getActive();
                // æ›´æ–° leastCount ä¸º 1
                leastCount = 1;
                // è®°å½•å½“å‰ä¸‹æ ‡å€¼åˆ° leastIndexs ä¸­
                leastIndexs[0] = i;
                totalWeight = node.getWeight();
                firstWeight = node.getWeight();
                sameWeight = true;

                // å½“å‰ Node çš„æ´»è·ƒæ•° node.getActive() ä¸æœ€å°æ´»è·ƒæ•° leastActive ç›¸åŒ
            } else if (node.getActive() == leastActive) {
                // åœ¨ leastIndexs ä¸­è®°å½•ä¸‹å½“å‰ Node åœ¨ nodes é›†åˆä¸­çš„ä¸‹æ ‡
                leastIndexs[leastCount++] = i;
                // ç´¯åŠ æƒé‡
                totalWeight += node.getWeight();
                // æ£€æµ‹å½“å‰ Node çš„æƒé‡ä¸ firstWeight æ˜¯å¦ç›¸ç­‰ï¼Œ
                // ä¸ç›¸ç­‰åˆ™å°† sameWeight ç½®ä¸º false
                if (sameWeight && i > 0
                    && node.getWeight() != firstWeight) {
                    sameWeight = false;
                }
            }
        }

        // å½“åªæœ‰ä¸€ä¸ª Node å…·æœ‰æœ€å°æ´»è·ƒæ•°ï¼Œæ­¤æ—¶ç›´æ¥è¿”å›è¯¥ Node å³å¯
        if (leastCount == 1) {
            return nodes.get(leastIndexs[0]);
        }

        // æœ‰å¤šä¸ª Node å…·æœ‰ç›¸åŒçš„æœ€å°æ´»è·ƒæ•°ï¼Œä½†å®ƒä»¬ä¹‹é—´çš„æƒé‡ä¸åŒ
        if (!sameWeight && totalWeight > 0) {
            // éšæœºç”Ÿæˆä¸€ä¸ª [0, totalWeight) ä¹‹é—´çš„æ•°å­—
            int offsetWeight = random.nextInt(totalWeight);
            // å¾ªç¯è®©éšæœºæ•°å‡å»å…·æœ‰æœ€å°æ´»è·ƒæ•°çš„ Node çš„æƒé‡å€¼ï¼Œ
            // å½“ offset å°äºç­‰äº0æ—¶ï¼Œè¿”å›ç›¸åº”çš„ Node
            for (int i = 0; i < leastCount; i++) {
                int leastIndex = leastIndexs[i];
                // è·å–æƒé‡å€¼ï¼Œå¹¶è®©éšæœºæ•°å‡å»æƒé‡å€¼
                offsetWeight -= nodes.get(leastIndex).getWeight();
                if (offsetWeight <= 0) {
                    return nodes.get(leastIndex);
                }
            }
        }
        // å¦‚æœæƒé‡ç›¸åŒæˆ–æƒé‡ä¸º0æ—¶ï¼Œéšæœºè¿”å›ä¸€ä¸ª Node
        return nodes.get(leastIndexs[random.nextInt(leastCount)]);
    }

}
```

### 3.4. å“ˆå¸Œ

**`å“ˆå¸Œï¼ˆIP Hashï¼‰`**ç®—æ³• **æ ¹æ®ä¸€ä¸ª key ï¼ˆå¯ä»¥æ˜¯å”¯ä¸€IDã€IP ç­‰ï¼‰ï¼Œé€šè¿‡å“ˆå¸Œè®¡ç®—å¾—åˆ°ä¸€ä¸ªæ•°å€¼ï¼Œç”¨è¯¥æ•°å€¼åœ¨å€™é€‰æœåŠ¡å™¨åˆ—è¡¨çš„è¿›è¡Œå–æ¨¡è¿ç®—ï¼Œå¾—åˆ°çš„ç»“æœä¾¿æ˜¯é€‰ä¸­çš„æœåŠ¡å™¨**ã€‚

![](https://raw.githubusercontent.com/dunwu/images/dev/snap/20210415172716.png)

å¯ä»¥ä¿è¯åŒä¸€ IP çš„å®¢æˆ·ç«¯çš„è¯·æ±‚ä¼šè½¬å‘åˆ°åŒä¸€å°æœåŠ¡å™¨ä¸Šï¼Œç”¨æ¥å®ç°ä¼šè¯ç²˜æ»ï¼ˆSticky Sessionï¼‰ã€‚

- ç‰¹ç‚¹ï¼šä¿è¯ç‰¹å®šç”¨æˆ·æ€»æ˜¯è¯·æ±‚åˆ°ç›¸åŒçš„æœåŠ¡å™¨ï¼Œè‹¥æœåŠ¡å™¨å®•æœºï¼Œä¼šè¯ä¼šä¸¢å¤±ã€‚

ã€ç¤ºä¾‹ã€‘æºåœ°å€å“ˆå¸Œç®—æ³•å®ç°ç¤ºä¾‹

```java
public class IpHashLoadBalance<N extends Node> extends BaseLoadBalance<N> implements LoadBalance<N> {

    @Override
    protected N doSelect(List<N> nodes, String ip) {
        if (StrUtil.isBlank(ip)) {
            ip = "127.0.0.1";
        }

        int length = nodes.size();
        int index = hash(ip) % length;
        return nodes.get(index);
    }

    public int hash(String text) {
        return HashUtil.fnvHash(text);
    }

}
```

### 3.5. ä¸€è‡´æ€§å“ˆå¸Œ

ä¸€è‡´æ€§å“ˆå¸Œï¼ˆConsistent Hashï¼‰ç®—æ³•çš„ç›®æ ‡æ˜¯ï¼š**ç›¸åŒçš„è¯·æ±‚å°½å¯èƒ½è½åˆ°åŒä¸€ä¸ªæœåŠ¡å™¨ä¸Š**ã€‚

**ä¸€è‡´æ€§å“ˆå¸Œ** å¯ä»¥å¾ˆå¥½çš„è§£å†³ **ç¨³å®šæ€§é—®é¢˜**ï¼Œå¯ä»¥å°†æ‰€æœ‰çš„ **å­˜å‚¨èŠ‚ç‚¹** æ’åˆ—åœ¨ **é¦–å°¾ç›¸æ¥** çš„ `Hash` ç¯ä¸Šï¼Œæ¯ä¸ª `key` åœ¨è®¡ç®— `Hash` åä¼š **é¡ºæ—¶é’ˆ** æ‰¾åˆ° **ä¸´æ¥** çš„ **å­˜å‚¨èŠ‚ç‚¹** å­˜æ”¾ã€‚è€Œå½“æœ‰èŠ‚ç‚¹ **åŠ å…¥** æˆ– **é€€å‡º** æ—¶ï¼Œä»…å½±å“è¯¥èŠ‚ç‚¹åœ¨ `Hash` ç¯ä¸Š **é¡ºæ—¶é’ˆç›¸é‚»** çš„ **åç»­èŠ‚ç‚¹**ã€‚

![img](https://raw.githubusercontent.com/dunwu/images/dev/cs/design/architecture/partition-consistent-hash.png)

- ç›¸åŒçš„è¯·æ±‚æ˜¯æŒ‡ï¼šä¸€èˆ¬åœ¨ä½¿ç”¨ä¸€è‡´æ€§å“ˆå¸Œæ—¶ï¼Œéœ€è¦æŒ‡å®šä¸€ä¸ª key ç”¨äº hash è®¡ç®—ï¼Œå¯èƒ½æ˜¯ï¼š
  - ç”¨æˆ· ID
  - è¯·æ±‚æ–¹ IP
  - è¯·æ±‚æœåŠ¡åç§°ï¼Œå‚æ•°åˆ—è¡¨æ„æˆçš„ä¸²
- å°½å¯èƒ½æ˜¯æŒ‡ï¼šæœåŠ¡å™¨å¯èƒ½å‘ç”Ÿä¸Šä¸‹çº¿ï¼Œå°‘æ•°æœåŠ¡å™¨çš„å˜åŒ–ä¸åº”è¯¥å½±å“å¤§å¤šæ•°çš„è¯·æ±‚ã€‚

å½“æŸå°å€™é€‰æœåŠ¡å™¨å®•æœºæ—¶ï¼ŒåŸæœ¬å‘å¾€è¯¥æœåŠ¡å™¨çš„è¯·æ±‚ï¼Œä¼šåŸºäºè™šæ‹ŸèŠ‚ç‚¹ï¼Œå¹³æ‘Šåˆ°å…¶å®ƒå€™é€‰æœåŠ¡å™¨ï¼Œä¸ä¼šå¼•èµ·å‰§çƒˆå˜åŠ¨ã€‚

- **ä¼˜ç‚¹**

**åŠ å…¥** å’Œ **åˆ é™¤** èŠ‚ç‚¹åªå½±å“ **å“ˆå¸Œç¯** ä¸­ **é¡ºæ—¶é’ˆæ–¹å‘** çš„ **ç›¸é‚»çš„èŠ‚ç‚¹**ï¼Œå¯¹å…¶ä»–èŠ‚ç‚¹æ— å½±å“ã€‚

- **ç¼ºç‚¹**

**åŠ å‡èŠ‚ç‚¹** ä¼šé€ æˆ **å“ˆå¸Œç¯** ä¸­éƒ¨åˆ†æ•°æ® **æ— æ³•å‘½ä¸­**ã€‚å½“ä½¿ç”¨ **å°‘é‡èŠ‚ç‚¹** æ—¶ï¼Œ**èŠ‚ç‚¹å˜åŒ–** å°†å¤§èŒƒå›´å½±å“ **å“ˆå¸Œç¯** ä¸­ **æ•°æ®æ˜ å°„**ï¼Œä¸é€‚åˆ **å°‘é‡æ•°æ®èŠ‚ç‚¹** çš„åˆ†å¸ƒå¼æ–¹æ¡ˆã€‚**æ™®é€š** çš„ **ä¸€è‡´æ€§å“ˆå¸Œåˆ†åŒº** åœ¨å¢å‡èŠ‚ç‚¹æ—¶éœ€è¦ **å¢åŠ ä¸€å€** æˆ– **å‡å»ä¸€åŠ** èŠ‚ç‚¹æ‰èƒ½ä¿è¯ **æ•°æ®** å’Œ **è´Ÿè½½çš„å‡è¡¡**ã€‚

> **æ³¨æ„**ï¼šå› ä¸º **ä¸€è‡´æ€§å“ˆå¸Œåˆ†åŒº** çš„è¿™äº›ç¼ºç‚¹ï¼Œä¸€äº›åˆ†å¸ƒå¼ç³»ç»Ÿé‡‡ç”¨ **è™šæ‹Ÿæ§½** å¯¹ **ä¸€è‡´æ€§å“ˆå¸Œ** è¿›è¡Œæ”¹è¿›ï¼Œæ¯”å¦‚ `Dynamo` ç³»ç»Ÿã€‚

ã€ç¤ºä¾‹ã€‘ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•ç¤ºä¾‹

ä»¥ä¸‹ç¤ºä¾‹åŸºäº Dubbo çš„ä¸€è‡´æ€§å“ˆå¸Œè´Ÿè½½å‡è¡¡ç®—æ³•åšäº†ä¸€äº›ç®€åŒ–ã€‚

```java
public class ConsistentHashLoadBalance<N extends Node> extends BaseLoadBalance<N> implements LoadBalance<N> {

    private final ConcurrentMap<String, ConsistentHashSelector<?>> selectors = new ConcurrentHashMap<>();

    @SuppressWarnings("unchecked")
    @Override
    protected N doSelect(List<N> nodes, String ip) {
        // åˆ†ç‰‡æ•°ï¼Œè¿™é‡Œè®¾ä¸ºèŠ‚ç‚¹æ•°çš„ 4 å€
        Integer replicaNum = nodes.size() * 4;
        // è·å– nodes åŸå§‹çš„ hashcode
        int identityHashCode = System.identityHashCode(nodes);

        // å¦‚æœ nodes æ˜¯ä¸€ä¸ªæ–°çš„ List å¯¹è±¡ï¼Œæ„å‘³ç€èŠ‚ç‚¹æ•°é‡å‘ç”Ÿäº†å˜åŒ–
        // æ­¤æ—¶ selector.identityHashCode != identityHashCode æ¡ä»¶æˆç«‹
        ConsistentHashSelector<N> selector = (ConsistentHashSelector<N>) selectors.get(ip);
        if (selector == null || selector.identityHashCode != identityHashCode) {
            // åˆ›å»ºæ–°çš„ ConsistentHashSelector
            selectors.put(ip, new ConsistentHashSelector<>(nodes, identityHashCode, replicaNum));
            selector = (ConsistentHashSelector<N>) selectors.get(ip);
        }
        // è°ƒç”¨ ConsistentHashSelector çš„ select æ–¹æ³•é€‰æ‹© Node
        return selector.select(ip);
    }

    /**
     * ä¸€è‡´æ€§å“ˆå¸Œé€‰æ‹©å™¨
     */
    private static final class ConsistentHashSelector<N extends Node> {

        /**
         * å­˜å‚¨è™šæ‹ŸèŠ‚ç‚¹
         */
        private final TreeMap<Long, N> virtualNodes;

        private final int identityHashCode;

        /**
         * æ„é€ å™¨
         *
         * @param nodes            èŠ‚ç‚¹åˆ—è¡¨
         * @param identityHashCode hashcode
         * @param replicaNum       åˆ†ç‰‡æ•°
         */
        ConsistentHashSelector(List<N> nodes, int identityHashCode, Integer replicaNum) {
            this.virtualNodes = new TreeMap<>();
            this.identityHashCode = identityHashCode;
            // è·å–è™šæ‹ŸèŠ‚ç‚¹æ•°ï¼Œé»˜è®¤ä¸º 100
            if (replicaNum == null) {
                replicaNum = 100;
            }
            for (N node : nodes) {
                for (int i = 0; i < replicaNum / 4; i++) {
                    // å¯¹ url è¿›è¡Œ md5 è¿ç®—ï¼Œå¾—åˆ°ä¸€ä¸ªé•¿åº¦ä¸º16çš„å­—èŠ‚æ•°ç»„
                    byte[] digest = md5(node.getUrl());
                    // å¯¹ digest éƒ¨åˆ†å­—èŠ‚è¿›è¡Œ 4 æ¬¡ hash è¿ç®—ï¼Œå¾—åˆ°å››ä¸ªä¸åŒçš„ long å‹æ­£æ•´æ•°
                    for (int j = 0; j < 4; j++) {
                        // h = 0 æ—¶ï¼Œå– digest ä¸­ä¸‹æ ‡ä¸º 0 ~ 3 çš„4ä¸ªå­—èŠ‚è¿›è¡Œä½è¿ç®—
                        // h = 1 æ—¶ï¼Œå– digest ä¸­ä¸‹æ ‡ä¸º 4 ~ 7 çš„4ä¸ªå­—èŠ‚è¿›è¡Œä½è¿ç®—
                        // h = 2, h = 3 æ—¶è¿‡ç¨‹åŒä¸Š
                        long m = hash(digest, j);
                        // å°† hash åˆ° node çš„æ˜ å°„å…³ç³»å­˜å‚¨åˆ° virtualNodes ä¸­ï¼Œ
                        // virtualNodes éœ€è¦æä¾›é«˜æ•ˆçš„æŸ¥è¯¢æ“ä½œï¼Œå› æ­¤é€‰ç”¨ TreeMap ä½œä¸ºå­˜å‚¨ç»“æ„
                        virtualNodes.put(m, node);
                    }
                }
            }
        }

        public N select(String key) {
            // å¯¹å‚æ•° key è¿›è¡Œ md5 è¿ç®—
            byte[] digest = md5(key);
            // å– digest æ•°ç»„çš„å‰å››ä¸ªå­—èŠ‚è¿›è¡Œ hash è¿ç®—ï¼Œå†å°† hash å€¼ä¼ ç»™ selectForKey æ–¹æ³•ï¼Œ
            // å¯»æ‰¾åˆé€‚çš„ Node
            return selectForKey(hash(digest, 0));
        }

        private N selectForKey(long hash) {
            // æŸ¥æ‰¾ç¬¬ä¸€ä¸ªå¤§äºæˆ–ç­‰äºå½“å‰ hash çš„èŠ‚ç‚¹
            Map.Entry<Long, N> entry = virtualNodes.ceilingEntry(hash);
            // å¦‚æœ hash å¤§äº Node åœ¨å“ˆå¸Œç¯ä¸Šæœ€å¤§çš„ä½ç½®ï¼Œæ­¤æ—¶ entry = nullï¼Œ
            // éœ€è¦å°† TreeMap çš„å¤´èŠ‚ç‚¹èµ‹å€¼ç»™ entry
            if (entry == null) {
                entry = virtualNodes.firstEntry();
            }
            // è¿”å› Node
            return entry.getValue();
        }

    }

    /**
     * è®¡ç®— hash å€¼
     */
    public static long hash(byte[] digest, int number) {
        return (((long) (digest[3 + number * 4] & 0xFF) << 24)
            | ((long) (digest[2 + number * 4] & 0xFF) << 16)
            | ((long) (digest[1 + number * 4] & 0xFF) << 8)
            | (digest[number * 4] & 0xFF))
            & 0xFFFFFFFFL;
    }

    /**
     * è®¡ç®— MD5 å€¼
     */
    public static byte[] md5(String value) {
        MessageDigest md5;
        try {
            md5 = MessageDigest.getInstance("MD5");
        } catch (NoSuchAlgorithmException e) {
            throw new IllegalStateException(e.getMessage(), e);
        }
        md5.reset();
        byte[] bytes = value.getBytes(StandardCharsets.UTF_8);
        md5.update(bytes);
        return md5.digest();
    }

}
```

## 4. å‚è€ƒèµ„æ–™

- [Comparing Load Balancing Algorithms](https://www.youtube.com/watch?reload=9&app=desktop&v=iqOTT7_7qXY)
- [ã€Šå¤§å‹ç½‘ç«™æŠ€æœ¯æ¶æ„ï¼šæ ¸å¿ƒåŸç†ä¸æ¡ˆä¾‹åˆ†æã€‹](https://item.jd.com/11322972.html)
- [å¤§å‹ç½‘ç«™æ¶æ„ç³»åˆ—ï¼šè´Ÿè½½å‡è¡¡è¯¦è§£ï¼ˆ1ï¼‰](https://www.cnblogs.com/itfly8/p/5043435.html)
- [ä»€ä¹ˆæ˜¯è´Ÿè½½å‡è¡¡](https://zhuanlan.zhihu.com/p/32841479)
- [What Is Load Balancing](https://avinetworks.com/what-is-load-balancing/)
- [Dubbo å®˜æ–¹è´Ÿè½½å‡è¡¡ç®—æ³•è¯´æ˜](https://dubbo.apache.org/zh/docs/v2.7/dev/source/loadbalance/)
- [è´Ÿè½½å‡è¡¡ç®—æ³•åŠæ‰‹æ®µ](https://segmentfault.com/a/1190000004492447)
- [åˆ©ç”¨ dns è§£ææ¥å®ç°ç½‘ç«™çš„è´Ÿè½½å‡è¡¡](https://segmentfault.com/a/1190000002578457)

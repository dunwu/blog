---
title: ç‰ˆæœ¬ç®¡ç†ä¸­é—´ä»¶ Flyway
date: 2019-08-22 09:02:39
order: 02
categories:
  - æ•°æ®åº“
  - æ•°æ®åº“ä¸­é—´ä»¶
tags:
  - æ•°æ®åº“
  - ä¸­é—´ä»¶
  - ç‰ˆæœ¬ç®¡ç†
permalink: /pages/e2648c/
---

# ç‰ˆæœ¬ç®¡ç†ä¸­é—´ä»¶ Flyway

> Flyway æ˜¯ä¸€ä¸ªæ•°æ®è¿ç§»å·¥å…·ã€‚

## ç®€ä»‹

### ä»€ä¹ˆæ˜¯ Flyway

**Flyway æ˜¯ä¸€ä¸ªå¼€æºçš„æ•°æ®åº“è¿ç§»å·¥å…·ã€‚**

### ä¸ºä»€ä¹ˆè¦ä½¿ç”¨æ•°æ®è¿ç§»

ä¸ºäº†è¯´æ˜æ•°æ®è¿ç§»çš„ä½œç”¨ï¼Œæˆ‘ä»¬æ¥ä¸¾ä¸€ä¸ªç¤ºä¾‹ï¼š

ï¼ˆ1ï¼‰å‡è®¾ï¼Œæœ‰ä¸€ä¸ªå«åš Shiny çš„é¡¹ç›®ï¼Œå®ƒçš„æ¶æ„æ˜¯ä¸€ä¸ªå«åš Shiny Soft çš„ App è¿æ¥å«åš Shiny DB çš„æ•°æ®åº“ã€‚

ï¼ˆ2ï¼‰å¯¹äºå¤§å¤šæ•°é¡¹ç›®è€Œè¨€ï¼Œæœ€ç®€å•çš„æŒç»­é›†æˆåœºæ™¯å¦‚ä¸‹æ‰€ç¤ºï¼š

![img](https://flywaydb.org/assets/balsamiq/Environments.png)

è¿™æ„å‘³ç€ï¼Œæˆ‘ä»¬ä¸ä»…ä»…è¦å¤„ç†ä¸€ä»½ç¯å¢ƒä¸­çš„ä¿®æ”¹ï¼Œç”±æ­¤ä¼šå¼•å…¥ä¸€äº›ç‰ˆæœ¬å†²çªé—®é¢˜ï¼š

åœ¨ä»£ç ä¾§ï¼ˆå³åº”ç”¨è½¯ä»¶ï¼‰çš„ç‰ˆæœ¬é—®é¢˜æ¯”è¾ƒå®¹æ˜“è§£å†³ï¼š

- æœ‰æ–¹ä¾¿çš„ç‰ˆæœ¬æ§åˆ¶å·¥å…·
- æœ‰å¯å¤ç”¨çš„æ„å»ºå’ŒæŒç»­é›†æˆ
- è§„èŒƒçš„å‘å¸ƒå’Œéƒ¨ç½²è¿‡ç¨‹

é‚£ä¹ˆï¼Œæ•°æ®åº“å±‚é¢çš„ç‰ˆæœ¬é—®é¢˜å¦‚ä½•è§£å†³å‘¢ï¼Ÿ

ç›®å‰ä»ç„¶æ²¡æœ‰æ–¹ä¾¿çš„æ•°æ®åº“ç‰ˆæœ¬å·¥å…·ã€‚è®¸å¤šé¡¹ç›®ä»ä½¿ç”¨ sql è„šæœ¬æ¥è§£å†³ç‰ˆæœ¬å†²çªï¼Œç”šè‡³æ˜¯é‡åˆ°å†²çªé—®é¢˜æ—¶æ‰æƒ³èµ·ç”¨ sql è¯­å¥å»è§£å†³ã€‚

ç”±æ­¤ï¼Œå¼•å‘ä¸€äº›é—®é¢˜ï¼š

- æœºå™¨ä¸Šçš„æ•°æ®åº“æ˜¯ä»€ä¹ˆçŠ¶æ€ï¼Ÿ
- è„šæœ¬åˆ°åº•ç”Ÿæ•ˆæ²¡æœ‰ï¼Ÿ
- ç”Ÿäº§ç¯å¢ƒä¿®å¤çš„é—®é¢˜æ˜¯å¦ä¹Ÿåœ¨æµ‹è¯•ç¯å¢ƒä¿®å¤äº†ï¼Ÿ
- å¦‚ä½•å»ºç«‹ä¸€ä¸ªæ–°çš„æ•°æ®åº“å®ä¾‹ï¼Ÿ

æ•°æ®è¿ç§»å°±æ˜¯ç”¨æ¥æå®šè¿™äº›æ··ä¹±çš„é—®é¢˜ï¼š

- é€šè¿‡è‰ç¨¿é‡å»ºä¸€ä¸ªæ•°æ®åº“ã€‚
- åœ¨ä»»ä½•æ—¶å€™éƒ½å¯ä»¥æ¸…æ¥šçš„äº†è§£æ•°æ®åº“çš„çŠ¶æ€ã€‚
- ä»¥ä¸€ç§æ˜ç¡®çš„æ–¹å¼å°†æ•°æ®åº“ä»å½“å‰ç‰ˆæœ¬è¿ç§»åˆ°ä¸€ä¸ªæ–°ç‰ˆæœ¬ã€‚

### Flyway å¦‚ä½•å·¥ä½œï¼Ÿ

æœ€ç®€å•çš„åœºæ™¯æ˜¯æŒ‡å®š Flyway è¿ç§»åˆ°ä¸€ä¸ªç©ºçš„æ•°æ®åº“ã€‚

![img](http://upload-images.jianshu.io/upload_images/3101171-bb6e9f39e56ebbda.png)

Flyway ä¼šå°è¯•æŸ¥æ‰¾å®ƒçš„ schema å†å²è¡¨ï¼Œå¦‚æœæ•°æ®åº“æ˜¯ç©ºçš„ï¼ŒFlyway å°±ä¸å†æŸ¥æ‰¾ï¼Œè€Œæ˜¯ç›´æ¥åˆ›å»ºæ•°æ®åº“ã€‚

ç°å†ä½ å°±æœ‰äº†ä¸€ä¸ªä»…åŒ…å«ä¸€å¼ ç©ºè¡¨çš„æ•°æ®åº“ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œè¿™å¼ è¡¨å« **flyway_schema_history**ã€‚

![img](http://upload-images.jianshu.io/upload_images/3101171-410eb31c6313b389.png)

è¿™å¼ è¡¨å°†è¢«ç”¨äºè¿½è¸ªæ•°æ®åº“çš„çŠ¶æ€ã€‚

ç„¶åï¼ŒFlyway å°†å¼€å§‹æ‰«ææ–‡ä»¶ç³»ç»Ÿæˆ–åº”ç”¨ classpath ä¸­çš„ **migrations**ã€‚è¿™äº› **migrations** å¯ä»¥æ˜¯ sql æˆ– javaã€‚

è¿™äº› **migrations** å°†æ ¹æ®ä»–ä»¬çš„ç‰ˆæœ¬å·è¿›è¡Œæ’åºã€‚

![img](http://upload-images.jianshu.io/upload_images/3101171-d36ee07ada4efbcd.png)

ä»»æ„ migration åº”ç”¨åï¼Œschema å†å²è¡¨å°†æ›´æ–°ã€‚å½“å…ƒæ•°æ®å’Œåˆå§‹çŠ¶æ€æ›¿æ¢åï¼Œå¯ä»¥ç§°ä¹‹ä¸ºï¼šè¿ç§»åˆ°æ–°ç‰ˆæœ¬ã€‚

Flyway ä¸€æ—¦æ‰«æäº†æ–‡ä»¶ç³»ç»Ÿæˆ–åº”ç”¨ classpath ä¸‹çš„ migrationsï¼Œè¿™äº› migrations ä¼šæ£€æŸ¥ schema å†å²è¡¨ã€‚å¦‚æœå®ƒä»¬çš„ç‰ˆæœ¬å·ä½äºæˆ–ç­‰äºå½“å‰çš„ç‰ˆæœ¬ï¼Œå°†è¢«å¿½ç•¥ã€‚ä¿ç•™ä¸‹æ¥çš„ migrations æ˜¯ç­‰å¾…çš„ migrationsï¼Œæœ‰æ•ˆä½†æ²¡æœ‰åº”ç”¨ã€‚

![img](http://upload-images.jianshu.io/upload_images/3101171-99a88fea7a31a070.png)

migrations å°†æ ¹æ®ç‰ˆæœ¬å·æ’åºå¹¶æŒ‰åºæ‰§è¡Œã€‚

![img](http://upload-images.jianshu.io/upload_images/3101171-b444fef6e5c13b71.png)

## å¿«é€Ÿä¸Šæ‰‹

Flyway æœ‰ 4 ç§ä½¿ç”¨æ–¹å¼ï¼š

- å‘½ä»¤è¡Œ
- JAVA API
- Maven
- Gradle

### å‘½ä»¤è¡Œ

é€‚ç”¨äºé Java ç”¨æˆ·ï¼Œæ— éœ€æ„å»ºã€‚

```shell
> flyway migrate -url=... -user=... -password=...
```

ï¼ˆ1ï¼‰**ä¸‹è½½è§£å‹**

è¿›å…¥[å®˜æ–¹ä¸‹è½½é¡µé¢](https://flywaydb.org/download/)ï¼Œé€‰æ‹©åˆé€‚ç‰ˆæœ¬ï¼Œä¸‹è½½å¹¶è§£å‹åˆ°æœ¬åœ°ã€‚

ï¼ˆ2ï¼‰**é…ç½® flyway**

ç¼–è¾‘ `/conf/flyway.conf`ï¼š

```properties
flyway.url=jdbc:h2:file:./foobardb
flyway.user=SA
flyway.password=
```

ï¼ˆ3ï¼‰**åˆ›å»ºç¬¬ä¸€ä¸ª migration**

åœ¨ `/sql` ç›®å½•ä¸‹åˆ›å»º `V1__Create_person_table.sql` æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š

```sql
create table PERSON (
    ID int not null,
    NAME varchar(100) not null
);
```

ï¼ˆ4ï¼‰**è¿ç§»æ•°æ®åº“**

è¿è¡Œ Flyway æ¥è¿ç§»æ•°æ®åº“ï¼š

```shell
flyway-5.1.4> flyway migrate
```

è¿è¡Œæ­£å¸¸çš„æƒ…å†µä¸‹ï¼Œåº”è¯¥å¯ä»¥çœ‹åˆ°å¦‚ä¸‹ç»“æœï¼š

```
Database: jdbc:h2:file:./foobardb (H2 1.4)
Successfully validated 1 migration (execution time 00:00.008s)
Creating Schema History table: "PUBLIC"."flyway_schema_history"
Current version of schema "PUBLIC": << Empty Schema >>
Migrating schema "PUBLIC" to version 1 - Create person table
Successfully applied 1 migration to schema "PUBLIC" (execution time 00:00.033s)
```

ï¼ˆ5ï¼‰**æ·»åŠ ç¬¬äºŒä¸ª migration**

åœ¨ `/sql` ç›®å½•ä¸‹åˆ›å»º `V2__Add_people.sql` æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š

```sql
insert into PERSON (ID, NAME) values (1, 'Axel');
insert into PERSON (ID, NAME) values (2, 'Mr. Foo');
insert into PERSON (ID, NAME) values (3, 'Ms. Bar');
```

è¿è¡Œ Flyway

```shell
flyway-5.1.4> flyway migrate
```

è¿è¡Œæ­£å¸¸çš„æƒ…å†µä¸‹ï¼Œåº”è¯¥å¯ä»¥çœ‹åˆ°å¦‚ä¸‹ç»“æœï¼š

```
Database: jdbc:h2:file:./foobardb (H2 1.4)
Successfully validated 2 migrations (execution time 00:00.018s)
Current version of schema "PUBLIC": 1
Migrating schema "PUBLIC" to version 2 - Add people
Successfully applied 1 migration to schema "PUBLIC" (execution time 00:00.016s)
```

### JAVA API

ï¼ˆ1ï¼‰**å‡†å¤‡**

- Java8+
- Maven 3.x

ï¼ˆ2ï¼‰**æ·»åŠ ä¾èµ–**

åœ¨ `pom.xml` ä¸­æ·»åŠ ä¾èµ–ï¼š

```xml
<project ...>
    ...
    <dependencies>
        <dependency>
            <groupId>org.flywaydb</groupId>
            <artifactId>flyway-core</artifactId>
            <version>5.1.4</version>
        </dependency>
        <dependency>
            <groupId>com.h2database</groupId>
            <artifactId>h2</artifactId>
            <version>1.3.170</version>
        </dependency>
        ...
    </dependencies>
    ...
</project>
```

ï¼ˆ3ï¼‰**é›†æˆ Flyway**

æ·»åŠ  `App.java` æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š

```java
import org.flywaydb.core.Flyway;

public class App {
    public static void main(String[] args) {
        // Create the Flyway instance
        Flyway flyway = new Flyway();

        // Point it to the database
        flyway.setDataSource("jdbc:h2:file:./target/foobar", "sa", null);

        // Start the migration
        flyway.migrate();
    }
}
```

ï¼ˆ4ï¼‰**åˆ›å»ºç¬¬ä¸€ä¸ª migration**

æ·»åŠ  `src/main/resources/db/migration/V1__Create_person_table.sql` æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š

```sql
create table PERSON (
    ID int not null,
    NAME varchar(100) not null
);
```

ï¼ˆ5ï¼‰**æ‰§è¡Œç¨‹åº**

æ‰§è¡Œ `App#main`ï¼š

è¿è¡Œæ­£å¸¸çš„æƒ…å†µä¸‹ï¼Œåº”è¯¥å¯ä»¥çœ‹åˆ°å¦‚ä¸‹ç»“æœï¼š

```
INFO: Creating schema history table: "PUBLIC"."flyway_schema_history"
INFO: Current version of schema "PUBLIC": << Empty Schema >>
INFO: Migrating schema "PUBLIC" to version 1 - Create person table
INFO: Successfully applied 1 migration to schema "PUBLIC" (execution time 00:00.062s).
```

ï¼ˆ6ï¼‰**æ·»åŠ ç¬¬äºŒä¸ª migration**

æ·»åŠ  src/main/resources/db/migration/V2\_\_Add_people.sql æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š

```sql
insert into PERSON (ID, NAME) values (1, 'Axel');
insert into PERSON (ID, NAME) values (2, 'Mr. Foo');
insert into PERSON (ID, NAME) values (3, 'Ms. Bar');
```

è¿è¡Œæ­£å¸¸çš„æƒ…å†µä¸‹ï¼Œåº”è¯¥å¯ä»¥çœ‹åˆ°å¦‚ä¸‹ç»“æœï¼š

```
INFO: Current version of schema "PUBLIC": 1
INFO: Migrating schema "PUBLIC" to version 2 - Add people
INFO: Successfully applied 1 migration to schema "PUBLIC" (execution time 00:00.090s).
```

### Maven

ä¸ Java API æ–¹å¼å¤§ä½“ç›¸åŒï¼ŒåŒºåˆ«åœ¨ **é›†æˆ Flyway** æ­¥éª¤ï¼š

Maven æ–¹å¼ä½¿ç”¨æ’ä»¶æ¥é›†æˆ Flywayï¼š

```xml
<project xmlns="...">
    ...
    <build>
        <plugins>
            <plugin>
                <groupId>org.flywaydb</groupId>
                <artifactId>flyway-maven-plugin</artifactId>
                <version>5.1.4</version>
                <configuration>
                    <url>jdbc:h2:file:./target/foobar</url>
                    <user>sa</user>
                </configuration>
                <dependencies>
                    <dependency>
                        <groupId>com.h2database</groupId>
                        <artifactId>h2</artifactId>
                        <version>1.4.191</version>
                    </dependency>
                </dependencies>
            </plugin>
        </plugins>
    </build>
</project>
```

å› ä¸ºç”¨çš„æ˜¯æ’ä»¶ï¼Œæ‰€ä»¥æ‰§è¡Œæ–¹å¼ä¸å†æ˜¯è¿è¡Œ Java ç±»ï¼Œè€Œæ˜¯æ‰§è¡Œ maven æ’ä»¶ï¼š

```shell
> mvn flyway:migrate
```

> :point_right: å‚è€ƒï¼š[ç¤ºä¾‹æºç ](https://github.com/dunwu/Database/tree/master/codes/middleware/flyway)

### Gradle

æœ¬äººä¸ç”¨ Gradleï¼Œç•¥ã€‚

## å…¥é—¨ç¯‡

### æ¦‚å¿µ

#### Migrations

åœ¨ Flyway ä¸­ï¼Œå¯¹äºæ•°æ®åº“çš„ä»»ä½•æ”¹å˜éƒ½ç§°ä¹‹ä¸º **Migrations**ã€‚

Migrations å¯ä»¥åˆ†ä¸º Versioned migrations å’Œ Repeatable migrationsã€‚

Versioned migrations æœ‰ 2 ç§å½¢å¼ï¼šregular å’Œ undoã€‚

Versioned migrations å’Œ Repeatable migrations éƒ½å¯ä»¥ä½¿ç”¨ SQL æˆ– JAVA æ¥ç¼–å†™ã€‚

##### Versioned migrations

ç”±ä¸€ä¸ªç‰ˆæœ¬å·ï¼ˆversionï¼‰ã€ä¸€æ®µæè¿°ï¼ˆdescriptionï¼‰ã€ä¸€ä¸ªæ ¡éªŒï¼ˆchecksumï¼‰ç»„æˆã€‚ç‰ˆæœ¬å·å¿…é¡»æ˜¯æƒŸä¸€çš„ã€‚Versioned migrations åªèƒ½æŒ‰é¡ºåºæ‰§è¡Œä¸€æ¬¡ã€‚

ä¸€èˆ¬ç”¨äºï¼š

- å¢åˆ æ”¹ tables/indexes/foreign keys/enums/UDTsã€‚
- å¼•ç”¨æ•°æ®æ›´æ–°
- ç”¨æˆ·æ•°æ®æ ¡æ­£

Regular ç¤ºä¾‹ï¼š

```sql
CREATE TABLE car (
    id INT NOT NULL PRIMARY KEY,
    license_plate VARCHAR NOT NULL,
    color VARCHAR NOT NULL
);

ALTER TABLE owner ADD driver_license_id VARCHAR;

INSERT INTO brand (name) VALUES ('DeLorean');
```

##### Undo migrations

> æ³¨ï¼šä»…ä¸“ä¸šç‰ˆæ”¯æŒ

Undo Versioned Migrations è´Ÿè´£æ’¤é”€ Regular Versioned migrations çš„å½±å“ã€‚

Undo ç¤ºä¾‹ï¼š

```sql
DELETE FROM brand WHERE name='DeLorean';

ALTER TABLE owner DROP driver_license_id;

DROP TABLE car;
```

##### Repeatable migrations

ç”±ä¸€æ®µæè¿°ï¼ˆdescriptionï¼‰ã€ä¸€ä¸ªæ ¡éªŒï¼ˆchecksumï¼‰ç»„æˆã€‚Versioned migrations æ¯æ¬¡æ‰§è¡Œåï¼Œæ ¡éªŒï¼ˆchecksumï¼‰ä¼šæ›´æ–°ã€‚

Repeatable migrations ç”¨äºç®¡ç†å¯ä»¥é€šè¿‡ä¸€ä¸ªæ–‡ä»¶æ¥ç»´æŠ¤ç‰ˆæœ¬æ§åˆ¶çš„æ•°æ®åº“å¯¹è±¡ã€‚

ä¸€èˆ¬ç”¨äºï¼š

- åˆ›å»ºï¼ˆé‡å»ºï¼‰views/procedures/functions/packages ç­‰ã€‚
- å¤§é‡å¼•ç”¨æ•°æ®é‡æ–°æ’å…¥

ç¤ºä¾‹ï¼š

```sql
CREATE OR REPLACE VIEW blue_cars AS
    SELECT id, license_plate FROM cars WHERE color='blue';
```

##### åŸºäº SQL çš„ migrations

migrations æœ€å¸¸ç”¨çš„ç¼–å†™å½¢å¼å°±æ˜¯ SQLã€‚

åŸºäº SQL çš„ migrations ä¸€èˆ¬ç”¨äºï¼š

- DDL å˜æ›´ï¼ˆé’ˆå¯¹ TABLES,VIEWS,TRIGGERS,SEQUENCES ç­‰çš„ CREATE/ALTER/DROP æ“ä½œï¼‰
- ç®€å•çš„å¼•ç”¨æ•°æ®å˜æ›´ï¼ˆå¼•ç”¨æ•°æ®è¡¨ä¸­çš„ CRUDï¼‰
- ç®€å•çš„å¤§é‡æ•°æ®å˜æ›´ï¼ˆå¸¸è§„æ•°æ®è¡¨ä¸­çš„ CRUDï¼‰

**å‘½åè§„åˆ™**

ä¸ºäº†è¢« Flyway è‡ªåŠ¨è¯†åˆ«ï¼ŒSQL migrations çš„æ–‡ä»¶å‘½åå¿…é¡»éµå¾ªè§„å®šçš„æ¨¡å¼ï¼š

![img](https://raw.githubusercontent.com/dunwu/images/master/cs/database/flyway/sql-migrations.png)

- **Prefix** - `V` ä»£è¡¨ versioned migrations (å¯é…ç½®), `U` ä»£è¡¨ undo migrations (å¯é…ç½®)ã€ `R` ä»£è¡¨ repeatable migrations (å¯é…ç½®)
- **Version** - ç‰ˆæœ¬å·é€šè¿‡`.`(ç‚¹)æˆ–`_`(ä¸‹åˆ’çº¿)åˆ†éš” (repeatable migrations ä¸éœ€è¦)
- **Separator** - `__` (ä¸¤ä¸ªä¸‹åˆ’çº¿) (å¯é…ç½®)
- **Description** - ä¸‹åˆ’çº¿æˆ–ç©ºæ ¼åˆ†éš”çš„å•è¯
- **Suffix** - `.sql` (å¯é…ç½®)

##### åŸºäº JAVA çš„ migrations

åŸºäº JAVA çš„ migrations é€‚ç”¨äºä½¿ç”¨ SQL ä¸å®¹æ˜“è¡¨è¾¾çš„åœºæ™¯ï¼š

- BLOB å’Œ CLOB å˜æ›´
- å¤§é‡æ•°æ®çš„é«˜çº§å˜æ›´ï¼ˆé‡æ–°è®¡ç®—ã€é«˜çº§æ ¼å¼å˜æ›´ï¼‰

**å‘½åè§„åˆ™**

ä¸ºäº†è¢« Flyway è‡ªåŠ¨è¯†åˆ«ï¼ŒJAVA migrations çš„æ–‡ä»¶å‘½åå¿…é¡»éµå¾ªè§„å®šçš„æ¨¡å¼ï¼š

![img](https://raw.githubusercontent.com/dunwu/images/master/cs/database/flyway/java-migrations.png)

- **Prefix** - `V` ä»£è¡¨ versioned migrations (å¯é…ç½®), `U` ä»£è¡¨ undo migrations (å¯é…ç½®)ã€ `R` ä»£è¡¨ repeatable migrations (å¯é…ç½®)
- **Version** - ç‰ˆæœ¬å·é€šè¿‡`.`(ç‚¹)æˆ–`_`(ä¸‹åˆ’çº¿)åˆ†éš” (repeatable migrations ä¸éœ€è¦)
- **Separator** - `__` (ä¸¤ä¸ªä¸‹åˆ’çº¿) (å¯é…ç½®)
- **Description** - ä¸‹åˆ’çº¿æˆ–ç©ºæ ¼åˆ†éš”çš„å•è¯

> :point_right: æ›´å¤šç»†èŠ‚è¯·å‚è€ƒï¼šhttps://flywaydb.org/documentation/migrations

#### Callbacks

> æ³¨ï¼šéƒ¨åˆ† events ä»…ä¸“ä¸šç‰ˆæ”¯æŒã€‚

å°½ç®¡ Migrations å¯èƒ½å·²ç»æ»¡è¶³ç»å¤§éƒ¨åˆ†åœºæ™¯çš„éœ€è¦ï¼Œä½†æ˜¯æŸäº›æƒ…å†µä¸‹éœ€è¦ä½ ä¸€éåˆä¸€éçš„æ‰§è¡Œç›¸åŒçš„è¡Œä¸ºã€‚è¿™å¯èƒ½ä¼šé‡æ–°ç¼–è¯‘å­˜å‚¨è¿‡ç¨‹ï¼Œæ›´æ–°è§†å›¾ä»¥åŠè®¸å¤šå…¶ä»–ç±»å‹çš„å¼€é”€ã€‚

å› ä¸ºä»¥ä¸ŠåŸå› ï¼ŒFlyway æä¾›äº† Callbacksï¼Œç”¨äºåœ¨ Migrations ç”Ÿå‘½å‘¨æœŸä¸­æ·»åŠ é’©å­ã€‚

Callbacks å¯ä»¥ç”¨ SQL æˆ– JAVA æ¥å®ç°ã€‚

##### SQL Callbacks

SQL Callbacks çš„å‘½åè§„åˆ™ä¸ºï¼ševent å + SQL migrationã€‚

å¦‚ï¼š `beforeMigrate.sql`, `beforeEachMigrate.sql`, `afterEachMigrate.sql` ç­‰ã€‚

SQL Callbacks ä¹Ÿå¯ä»¥åŒ…å«æè¿°ï¼ˆdescriptionï¼‰ã€‚è¿™ç§æƒ…å†µä¸‹ï¼ŒSQL Callbacks æ–‡ä»¶å = event å + åˆ†éš”ç¬¦ + æè¿° + åç¼€ã€‚ä¾‹ï¼š`beforeRepair__vacuum.sql`

å½“åŒä¸€ä¸ª event æœ‰å¤šä¸ª SQL callbacksï¼Œå°†æŒ‰ç…§å®ƒä»¬æè¿°ï¼ˆdescriptionï¼‰çš„é¡ºåºæ‰§è¡Œã€‚

> **æ³¨ï¼š** Flyway ä¹Ÿæ”¯æŒä½ é…ç½®çš„ `sqlMigrationSuffixes`ã€‚

##### JAVA Callbacks

> å½“ SQL Callbacks ä¸å¤Ÿæ–¹ä¾¿æ—¶ï¼Œæ‰åº”è€ƒè™‘ JAVA Callbacksã€‚

JAVA Callbacks æœ‰ 3 ç§å½¢å¼ï¼š

1. **åŸºäº Java çš„ Migrations** - å®ç° JdbcMigrationã€SpringJdbcMigrationã€MigrationInfoProviderã€MigrationChecksumProviderã€ConfigurationAwareã€FlywayConfiguration
2. **åŸºäº Java çš„ Callbacks** - å®ç° org.flywaydb.core.api.callback æ¥å£ã€‚
3. **è‡ªå®šä¹‰ Migration resolvers å’Œ executors** - å®ç° MigrationResolverã€MigrationExecutorã€ConfigurationAwareã€FlywayConfiguration æ¥å£ã€‚

> :point_right: æ›´å¤šç»†èŠ‚è¯·å‚è€ƒï¼šhttps://flywaydb.org/documentation/callbacks

#### Error Handlers

> æ³¨ï¼šä»…ä¸“ä¸šç‰ˆæ”¯æŒã€‚

ï¼ˆç•¥ï¼‰

#### Dry Runs

> æ³¨ï¼šä»…ä¸“ä¸šç‰ˆæ”¯æŒã€‚

ï¼ˆç•¥ï¼‰

### å‘½ä»¤

Flyway çš„åŠŸèƒ½ä¸»è¦å›´ç»•ç€ 7 ä¸ªåŸºæœ¬å‘½ä»¤ï¼š[Migrate](https://flywaydb.org/documentation/command/migrate)ã€[Clean](https://flywaydb.org/documentation/command/clean)ã€[Info](https://flywaydb.org/documentation/command/info)ã€[Validate](https://flywaydb.org/documentation/command/validate)ã€[Undo](https://flywaydb.org/documentation/command/undo)ã€[Baseline](https://flywaydb.org/documentation/command/baseline) å’Œ [Repair](https://flywaydb.org/documentation/command/repair)ã€‚

æ³¨ï¼šå„å‘½ä»¤çš„ä½¿ç”¨æ–¹æ³•ç»†èŠ‚è¯·æŸ¥é˜…å®˜æ–¹æ–‡æ¡£ã€‚

### æ”¯æŒçš„æ•°æ®åº“

- [Oracle](https://flywaydb.org/documentation/database/oracle)
- [SQL Server](https://flywaydb.org/documentation/database/sqlserver)
- [DB2](https://flywaydb.org/documentation/database/db2)
- [MySQL](https://flywaydb.org/documentation/database/mysql)
- [MariaDB](https://flywaydb.org/documentation/database/mariadb)
- [PostgreSQL](https://flywaydb.org/documentation/database/postgresql)
- [Redshift](https://flywaydb.org/documentation/database/redshift)
- [CockroachDB](https://flywaydb.org/documentation/database/cockroachdb)
- [SAP HANA](https://flywaydb.org/documentation/database/saphana)
- [Sybase ASE](https://flywaydb.org/documentation/database/sybasease)
- [Informix](https://flywaydb.org/documentation/database/informix)
- [H2](https://flywaydb.org/documentation/database/h2)
- [HSQLDB](https://flywaydb.org/documentation/database/hsqldb)
- [Derby](https://flywaydb.org/documentation/database/derby)
- [SQLite](https://flywaydb.org/documentation/database/sqlite)

## èµ„æ–™

| [Github](https://github.com/flyway/flyway) | [å®˜æ–¹æ–‡æ¡£](https://flywaydb.org/) |

## ğŸšª ä¼ é€

â—¾ ğŸ’§ [é’æ‚Ÿçš„ IT çŸ¥è¯†å›¾è°±](https://dunwu.github.io/waterdrop/) â—¾